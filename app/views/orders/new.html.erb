<% content_for :script do %> <script type="text/javascript" src="/javascripts/desktop/src/order.js"></script>
<script type="text/javascript">
$(document).ready($(function() {
var msg=$("#error_explanation").html();
if(msg) {
Genesis.showErrMsg(msg,null,true);
}
}));

</script>
<% end %>

<% if flash[:errors] %>
<div style="display:none;" id="error_explanation">
	<h5>Please fix the <%= pluralize(flash[:errors].length, "error") %> below:</h5>
	<br/>
	<ul>
		<% flash[:errors].each do |msg| %>
		<li>
			<%= msg.join %>
		</li>
		<% end %>
	</ul>
</div>
<% end %> <!-- Example row of columns -->
<div class="row">
	<div class="span24">
		<%= form_for @order, :url => complete_order_path do |f| %>
		<div class="row">
			<div class="span24">
				<h2>Your Purchase Choices</h2>
				<div class="purchase panelBodyHighlights" style="padding-right:20px;">
					<table style="margin-bottom:0px;">
						<thead>
							<tr>
								<th class="span1 invisible"></th>
								<th class="green span11">Description</th>
								<th class="span1 invisible">&#160;</th>
								<th class="green span2">Quantity</th>
								<th class="span1 invisible">&#160;</th>
								<th class="green span2">Price</th>
								<th class="span1 invisible">&#160;</th>
								<th class="green span4" style="text-align:right;">Total</th>
							</tr>
						</thead>
						<% @deal.subdeals.each_with_index do |sdeal, i| %>
						<tr>
							<td class="span1"> <%= f.radio_button(:subdeal_id, sdeal.id, :id_value => i+1, :checked => ((@deal.subdeals.length == 1 && i == 0) || (@order.subdeal_id == sdeal.id)) ? true : false) %> </td>
							<td class="span11" colspan="1"><%= sdeal.title %></td>
							<td class="span1 invisible">&#160;</td>
							<td class="span2">
							<input id="order_quantity<%= i+1 %>" type="text" name="order_quantity<%= i+1 %>" value="<%= @order.subdeal_id == sdeal.id ? @order.quantity : nil %>">
							</td>
							<td class="span1">x</td>
							<td id="order_discount_price<%= i+1 %>" class="span2" value="<%= sdeal.discount_price %>">C$<%= sdeal.discount_price.to_i %></td>
							<td class="span1">=</td>
							<td id="order_total<%= i+1 %>" class="span4" style="text-align:right;">C$<%= @order.subdeal_id == sdeal.id ? "%0.2f" % @order.total_payment : '0.00' %></td>
						</tr>
						<% end %>
						<tr>
							<td colspan="2"><img style="vertical-align:middle;" src="http://photos.justformyfriends.com/gift-icon.png"/><a style="vertical-align:middle;margin-left:5px;" id="enable_gift">Buying this as a Gift?</a></td>
							<td colspan="4" style="text-align:right;"><h4>My Total:</h4></td>
							<td >&#160;</td>
							<td style="text-align:right;"><h4 id="order_grand_total">C$<%= @order.subdeal_id ? "%0.2f" % @order.total_payment : '0.00' %></h4></td>
						</tr>
					</table>
					<%= f.hidden_field(:quantity, :value => @order.quantity ? @order.quantity : 0) %>
				</div>
			</div>
		</div>
		<div id="gift" class="row" style="<%= flash[:give_gift] ? 'display:block;' : 'display:none' %>">
			<div class="span24">
				<h2>Gift Option</h2>
				<div class="gift panelBodyHighlights form-stacked">
					<table>
						<%= f.fields_for :gift_option_attributes, do |g| %>
						<tr>
							<td> <%= g.label :from %>
							<%= g.text_field :from, :value => flash[:give_gift] ? @order.gift_option_attributes[:from] : current_user.name %> </td>
							<td> <%= g.label :to %>
							<%= g.text_field :to, :value => flash[:give_gift] ? @order.gift_option_attributes[:to] : "" %> </td>
						</tr>
						<td colspan="2"> <%= g.label :message, "Message <span>- (optional)</span>".html_safe %>
						<%= g.text_area :message, :rows => 5, :value => flash[:give_gift] ? @order.gift_option_attributes[:message] : "" %> </td>
						</tr>
						<tr>
							<td><a id="disable_gift">Nevermind</a> <%= f.hidden_field(:give_gift, :value => flash[:give_gift] ? true : false) %> </td>
					</table>
					<% end %>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="span24">
				<h2>Select Your Payment Method</h2>
				<div class="payment panelBodyHighlights" style="padding-right:20px;">
					<table>
						<thead>
							<tr>
								<th class="span1 invisible"></th>
								<th class="green span14">Method</th>
								<th class="span8 green">&#160;</th>
							</tr>
						</thead>
						<tr>
							<td class="span1">
							<input type="radio" name="payMethod" value="PayPal" checked="1"/>
							</td>
							<td class="span14">PayPal or Credit Card</td>
							<td class="span8 invisible" >&#160;</td>
						</tr>
						<tr>
							<td class="span1">&#160;</td><!-- PayPal Logo -->
							<td class="noPadding noMargin" colspan="2"><!-- PayPal Logo -->
							<table class="noPadding noMargin" border="0" cellpadding="0" cellspacing="0" align="center">
								<tr>
									<td align="center" class="noPadding noMargin"><a href="#" onclick="javascript:window.open('https://www.paypal.com/ca/cgi-bin/webscr?cmd=xpt/Marketing/popup/OLCWhatIsPayPal-outside','olcwhatispaypal','toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=400, height=350');"><img  src="https://www.paypal.com/en_US/i/bnr/horizontal_solution_PPeCheck.gif" border="0" alt="Solution Graphics"></a></td>
								</tr>
							</table><!-- PayPal Logo --></td>
						</tr>
						<tr>
							<td class="span1"><% if flash[:agree_to_terms].nil?  %>
							<input type="checkbox" name="agree_to_terms" >
							<% else %>
							<input type="checkbox" name="agree_to_terms" checked="checked" >
							<% end %></td>
							<td colspan="2" class="noMargin noPadding"><span>I agree to the <a href="/terms">Terms Of Use</a> and <a href="/privacy">Privacy Agreement</a></span></td>
						</tr>
						<tr>
							<td colspan="3"> <%= f.submit "Complete Order", :class => "btn primary large noWrap", :disable_with => "Working..." %> </td>
						</tr>
					</table>
				</div>
			</div>
		</div>
		<% end %>
	</div>
	<div id="faq" class="span8">
		<h2>Payment FAQ</h2>
		<div class="panelBodyHighlights">
			<dl>
				<dt>
					What happens after I buy this deal?
				</dt>
				<dd>
					You will receive an email confirmation receipt from us along with instructions on what to do next. Redeem the deal by printing out your ticket or displaying it on your smartphone.
				</dd>
				<dt>
					Is JustForMyFriends safe?
				</dt>
				<dd>
					Our transactions are handled by PayPal, which is in turn protected by SSL so it is 100% safe.
				</dd>
			</dl>
		</div>
	</div>
</div>