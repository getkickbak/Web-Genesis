<% content_for :script do %> <script type="text/javascript" src="/javascripts/desktop/src/site.js"></script>
<script type="text/javascript">
	$(document).ready($(function() {
		var msg = $("#notice").html();
		if(msg) {
			Genesis.showWarningMsg(msg,null,true);
		}
	}));

</script>
<% end %>
<% if @merchant.nil? %> <!-- Main hero unit for a primary marketing message or
call to action
-->
<% if notice %>
<div style="display:none;" id="notice">
	<p><%= notice %></p>
</div>
<% end %>
<div class="row">
   <div class="span24">
      <% if @referral.nil? && !@show_reward %>
      <div class="row fade hide" id="referralsBrowserDialog">
         <div class="span24">
            <h2>Who Recommended You To <%=@deal.merchant.name %>?</h2>
            <div class="referralsBrowserBody">
               <div class="referralsBrowserHeader">
                  <div class="filterBox hide">
                     <label for="friendSearchInput">Friend Search</label>
                     <div class="input"><input class="xlarge" id="friendSearchInput" name="friendSearchInput" size="30" type="text"/></div>
                  </div>
                  <strong style="font-size:120%">You need to be referred by a friend to be eligible for this deal.<br/>Which one of the following friends did you get your referral from?</strong>
               </div>
               <div id="referralsBrowserWrapper" class="listView">
                  <div class="scroller">
                     <ul></ul>
                  </div>
               </div>
               <div class="referralsBrowserFooter"></div>
            </div>
         </div>
      </div>
      <div class="row fade hide" id="secretCodeDialog">
         <div class="span24">
            <h2>No referrals were found from your Facebook Friends</h2>
            <div class="referralsBrowserBody form-stacked">
               <div class="referralsBrowserHeader">
                  <div class="filterBox">
                     <label for="friendSearchInput">Enter Secret Code:</label>
                     <div class="input"><input class="xlarge" id="secretCodeInput" name="secretCodeInput" size="30" type="text"/></div>
                     <button type="button" id="verifySecretCode" class="large primary btn">Submit</button>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <% else %>
      <div class="row span0abs span24 height0" id="referralsList">
         <div class="hero-unit hero-referrals">
               <p class="referralsHeader">Recommendation from others :</p>
               <div id="referralsWrapper">
                  <div class="scroller">
                     <ul></ul>
                  </div>
               </div>
               <div class="referralsFooter">
                  <p>
                     <a onclick="Site.backtoMain();" class="btn large">Back to Main &raquo;</a>
                  </p>
               </div>
         </div>
      </div>
      <div id="mainMsg" class="row">
         <a name="mainMsg"></a>
         <div class="slides_container">
         	<% if @referral.nil? %>
            <div class="span24">
               <div class="hero-unit hero-mainMsg">
                  <img class="right" style="margin-left:10px;" src="http://photos.justformyfriends.com/gift.png"/>
                  <h3>Refer friends and get a C$2 Tim Hortons Gift Card plus the option to purchase the great deal below!</h3>
                  <small>
                     Get a C$2 Tim Hortons Gift Card when you spread the deal to your Facebook Friends.
                  </small>
                  <p class="mainMsgFooter">
                  	 <% if signed_in? %>
                     <a class="btn fbtag large">Refer your Friends! &raquo;</a>
                     <% else %>
                     <a class="btn fbtag large" onclick="Genesis.loginPopup();">Refer your Friends! &raquo;</a>
                     <% end %>
                  </p>
               </div>
            </div>
            <% end %>
            <% if signed_in? %>
            <div class="span24">
               <table class="hero-unit hero-referral">
                  <tr>
                     <td colspan="2" style="margin:0px;padding:0px 0px 0px 10px;" >
                     <p style="margin:0px;padding:0px;">
                        <a href="<%= "http://www.facebook.com/profile.php?id=#{current_user.facebook_id}" %>" target="_blank"><%= current_user.name.split(' ')[0] %></a>, write a recommendation to your friends get rewarded!
                     </p></td>
                  </tr>
                  <tr>
                     <td>
                     <img width="100" src="<%= "http://graph.facebook.com/#{current_user.facebook_id}/picture?type=normal&" %>"/>
                     </td>
                     <td>
                     <form>
                        <% @deal.referral_subjects.each do |subject| %>
                        <label class="alignLeft" style="width:548px;">
                           <%= subject.content %>
                        </label>
                        <textarea style="width:538px;"></textarea>
                        <% end %>
                        <label class="noWrap" style="float:right;width:auto;">
                           <button type="button" id ="reward" class="btn rewardtag large"></button>
                     </form></td>
                  </tr>
               </table>
            </div>
            <% end %>
            <% if @referral %>
            <div id="recommendation" class="span24">
               <table class="hero-unit hero-referral">
                  <tr>
                     <td colspan="2" style="margin:0px;padding:0px 0px 0px 10px;" >
                     <p style="margin:0px;padding:0px;">
                        Recommendation from <% if signed_in? && @referral.creator.id == current_user.id %> you<% else %> your friend<% end %>, <a href="<%= "http://www.facebook.com/profile.php?id=#{@referral.creator.facebook_id}" %>" target="_blank"><%= @referral.creator.name %></a>:
                     </p></td>
                  </tr>
                  <tr>
                     <td width="100">
                     <img width="100" src="<%= "http://graph.facebook.com/#{@referral.creator.facebook_id}/picture?type=normal&" %>"/>
                     </td>
                     <td>
                     <div class="hero-start">
                        <p><%= @referral.comment %></p>
                     </div>
                     <div class="hero-end">
                        &#160;
                     </div>
                     </td>
                  </tr>
                  <tr>
                     <td colspan="2" style="padding-top:0;">
                     <% referrers = get_referrers(@deal.id, @referral.creator.id, 10) %>    
                     <% if referrers[:total] > 0 %>           		
                     <div style="float:left;">
                        <a onclick="Site.getReferrals();" style="cursor:pointer;"><%= referrers[:total] %> other <% if referrers[:total] == 1 %>person<% else %>people<% end %> also recommend <%= @deal.merchant.name %></a>
                        <table style="border:0;padding:0;margin:0;">
                           <tr>
                           <% referrers[:items].each do |referrer| %>
                           <td style="padding:0 1px 0 0;border:0;margin:0;width:36px;">
                              <img  style="cursor:pointer;" onclick="Site.getReferrals();" width="36" src="<%= "http://graph.facebook.com/#{referrer.facebook_id}/picture?type=square&" %>">
                           </td>                           
                           <% end %>
                           <% (1..10-referrers[:items].to_a.length).each do |i| %>
                           <td style="padding:0 1px 0 0;border:0;margin:0;width:36px;">
                           </td>
                           <% end %>
                           </tr>
                        </table>
                     </div>
                     <% end %>
                     <div style="float:right;">
                        <!--<a  id="referralsBtn" class="btn large">Check out all our Referrals! &raquo;</a>-->
                        <a  id="discussBtn" href="#comments" class="btn large">Discuss with <%= @referral.creator.name.split(' ')[0] %>! &raquo;</a>
                     </div>
                     </td>
                  </tr>
               </table>
            </div>
            <% end %>
         </div>
      </div>
      <% end %>
      <!-- Example row of columns -->
      <div id="mainDeal" class="row">
         <div class="span24">
            <h2><%=raw @deal.title %></h2>
            <div id="container">
               <div id="slides">
                  <div class="slides_container">
                     <% @deal.photo_urls.split(/\r/).each do |photo_url| %>
                     <div class="slide">
                        <img width="710" src="<%= photo_url %>">
                     </div>
                     <% end %>
                  </div>
               </div>
            </div>
            <table id="deal_countdown" class="description_footer noMargin">
            <tr>
            <td class="noPadding" style="vertical-align:middle;border:0;">
            <div class="heading">Time Left to Buy</div>
            <h3>
            <script type="text/javascript" >
               TargetDate = "<%= @deal.end_date %>";
               BackColor = "";
               //ForeColor = "#676767";
               ForeColor = "black";
               CountActive = true;
               CountStepper = -1;
               LeadingZero = true;
               DisplayFormat = "%%D%% Days %%H%% Hrs %%M%% Mins %%S%% secs";
               FinishMessage = "The deal is over. Better luck next time!";
            </script>
            <script type="text/javascript" src="/javascripts/desktop/lib/countdown.js"></script>
            </h3>
            </td>
            <td class="noPadding alignRight" width="100" style="vertical-align:middle;border:0;">
               <% subdeal = @deal.subdeals.first %>
               <h3>C$<%= (subdeal.regular_price - subdeal.discount_price).to_i %> OFF</h3>
            <td class="noPadding alignRight" style="vertical-align:middle;width:130px;border:0;">
            <div>
            <% if @deal.end_date >= Time.now && @deal.limit_count < @deal.max_limit %> 	
            	<% if signed_in? %>	
            		<% if @referral %>
            		<a href="/deals/<%= @deal.deal_id %>/confirmation?referral_id=<%= @referral.referral_id %>" class="btn pricetag large alignCenter">Buy Now! &raquo;</a>
            		<% elsif @show_reward %>
            		<div id="referralWarning" class="modal fade hide">
               			<div class="modal-header">
                  			<a class="close">×</a>
                  			<h3>Friend Referral Required</h3>
               			</div>
               			<div class="modal-body" style="text-align:center;">
                  			You must send a friend referral before you can purchase this deal!
               			</div>
               			<div class="modal-footer">
                  			<a class="btn fbtag">Refer a Friend!</a>
                  			<a onclick="$('#referralWarning').modal('hide');" class="btn primary">OK</a>
               			</div>
            		</div>
            		<a data-controls-modal="referralWarning" data-backdrop="true" data-keyboard="true" class="btn pricetag large alignCenter">Buy Now! &raquo;</a>
            		<% else %>
            		<a class="btn pricetag large alignCenter disabled">Buy Now! &raquo;</a>
            		<% end %>
            	<% else %>
            	<a class="btn pricetag large alignCenter" onclick="Genesis.loginPopup();">Buy Now! &raquo;</a>
            	<% end %>
            <% else %>
            	<a class="btn large alignCenter">No Longer<br>Available</a>	
            <% end %>
            </div>
            </td>
            </tr>
         </table>
         </div>
      </div>
      <div class="row">
         <div id="highlightsCtn" class="span0abs span12">
            <ul id="highlights" class="tabs" data-tabs="tabs" style="display:none;">
               <li>
                  <a class="active" href="#highlights-1"></a>
               </li>
               <li>
                  <a href="#highlights-2"></a>
               </li>
            </ul>
            <div class="tab-content">
               <div id="highlights-1" class="span12 active" style="margin:0;">
                  <h2><a id="detailsBtn" style="float:right;margin-left:10px;margin-top:5px;" class="btn primary">Company Details &raquo;</a>
                  <div>
                     HIGHLIGHTS
                  </div></h2>
                  <div class="panelBodyHighlights">
                     <ul>
                        <% @deal.highlights.split(/\r/).each do |highlight| %>
                        <li>
                           <%= highlight %>
                        </li>
                        <% end %>
                     </ul>
                  </div>
               </div>
               <div id="highlights-2" class="span24" style="margin:0;">
                  <h2><a id="highlightsBtn" style="float:right;margin-left:10px;margin-top:5px;" class="btn primary">Back to Highlights &raquo;</a>
                  <div>
                     ABOUT THIS PLACE ...
                  </div></h2>
                  <div class="panelBodyHighlights" style=padding:20px;>
                     <div>
                        <%=raw @deal.description %>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <div id ="offerDetails" class="span12rel span12">
            <h2>OFFER DETAILS</h2>
            <div id="offerDetails-1" class="panelBodyHighlights">
               <ul>
                  <% @deal.details.split(/\r/).each do |detail| %>
                  <li>
                     <%= detail %>
                  </li>
                  <% end %>
               </ul>
            </div>
         </div>
      </div>
      <div class="row">
         <div class="span24">
            <h2>LOCATION</h2>
            <div style="display:none">
               <div id="merchant_address1"><%= @deal.merchant.address1 %></div>
               <% if @deal.merchant.address2 && !@deal.merchant.address2.empty? %>
               <div id="merchant_address2"><%= @deal.merchant.address2 %></div>
               <% end %>
               <div id="merchant_city_state_zipcode"><%= @deal.merchant.city %>, <%= @deal.merchant.state %><br/> <%= @deal.merchant.zipcode %><br/><br/></div>
            </div>
            <div class="panelBodyHighlights left">
               <div class="span12">
               	<img width="200" class="alignCenter" style="display:block;margin-bottom:10px;" src="<%= @deal.merchant.photo_url %>"/>
                  <div id="address" class="alignCenter" style="width:200px;">
                     <!--
                    <p id="merchant_name"><%= @deal.merchant.name %></p>
                    -->
                    <p id="merchant_address"></p>
                    <p id="merchant_phone"><%= @deal.merchant.phone %></p>
                  </div>
               </div>
               <div id="gmap" class="right" style="height:235px;width:320px;margin-left:10px;"></div>
            </div>
         </div>
      </div>
      <% if @referral %> 
      <div id="comments" class="hero-unit" style="margin:0;padding:10px 30px 30px;">
      <h4 id="discuss">Ask <%= @referral.creator.name.split(' ')[0] %> any questions about <%= @deal.merchant.name %> ...</h4>
      <fb:comments href="/deals/<%= @deal.deal_id %>?referral_id=<%= @referral.referral_id %>" num_posts="1" width="640"></fb:comments>
      </div>
      <% end %>
   </div>
   <div class="span8">
      <% if @referral %> 
      <div class="row">
      <div class="span8">
         <h2>SHARE</h2>
           <div class="panelBodyHighlights alignCenter" style="min-height:0px;">
            <div class="fb-like" data-send="true" data-layout="button_count" data-width="100" data-show-faces="true" data-font="verdana" data-href="<%= deal_url(@deal.deal_id) %>?referral_id=<%= @referral.referral_id %>"></div>
         </div>
         </div>
      </div>
      <% end %>
      <div id="faq" class="row">
      <div class="span8">
         <h2>FAQ</h2>
         <div class="panelBodyHighlights">
         <dl>
            <dt>
What is  JustForMyFriends?
            </dt>
            <dd>
JustForMyFriends is an awesome way for you find out the great local businesses that are recommended by your trusted friends. On top of that, you get to try them out for a special discount.
            </dd>		
            <dt>
I want this deal. What to do?
            </dt>
            <dd>
Just click on the “Buy Now” button before the offer ends and you will be asked for your billing information.  Once the order goes through, you’ll receive a JustForMyFriends voucher in your email inbox (be sure to check your junk mail folder too) and your credit card/paypal account will be charged.
            </dd>
            <dt>
Does it cost me anything to join JustForMyFriends?
            </dt>
            <dd>
Absolutely not!  You will only be charged if you decide to purchase our recommended deals.
            </dd>
            <dt>
How do I create an account on JustForMyFriends?
            </dt>
            <dd>
Click on “Log In” in the top right corner, and you can create one using your Facebook credentials.
            </dd>
            <dt>
What happens when my JustForMyFriends vouchers expires?
            </dt>
            <dd>
Not everyting is lost!  If the promotional value of the voucher expires, you can still redeem it for the paid amount.
            </dd>
            <dt>
I just bought the deal, how do I use it?
            </dt>
            <dd>
Once you received your confirmation email, just print the attached voucher(s) and follow the redemption instructions.             	
			</dd>
            <dt>
Can I buy this deal as a gift for someone else?
            </dt>
            <dd>
Of course! We do our best to allow gifting buys and will state clearly if for some reason a particular buy does not permit it.
			</dd>
            <dt>
If I don't use the full value of the voucher in one visit, can I use the remainder another time?            	
            </dt>
			<dd>
No. You won't receive credit or cash back unless otherwise stated.
            </dd>
            <dt>
Is JustForMyFriends safe?
            </dt>
            <dd>
Our transactions are handled by PayPal, which is in turn protected by SSL so it is 100% safe.
            </dd>
            <dt>
What methods of payment do you accept?
            </dt>
            <dd>
We currently accept Visa, MasterCard, American Express and PayPal.
            </dd>
            <dt>
What happens if the business for the deal I bought closes down?
            </dt>
            <dd>
You will get a prompt refund guaranteed. 
            </dd>
         </dl>
         </div>
         </div>
      </div>
   </div>
</div>
<% else %>
<p id="notice">
   <%= notice %>
</p>
<p>
   <b>Title:</b>
   <%= @deal.title %>
</p>
<p>
   <b>Location:</b>
   <%= @deal.location %>
</p>
<p>
   <b>Photo Urls</b>
   <%= @deal.photo_urls %>
</p>
<p>
   <b>Description:</b>
   <%= @deal.description %>
</p>
<p>
   <b>Hightlights:</b>
   <%= @deal.highlights %>
</p>
<p>
   <b>Details:</b>
   <%= @deal.details %>
</p>
<p>
   <b>Start Date:</b>
   <%= @deal.start_date %>
</p>
<p>
   <b>End Date:</b>
   <%= @deal.end_date %>
</p>
<p>
   <b>Expiry Date:</b>
   <%= @deal.expiry_date %>
</p>
<p>
   <b>Max Per Person:</b>
   <%= @deal.max_per_person %>
</p>
<p>
   <b>Max Limit:</b>
   <%= @deal.max_limit %>
</p>
<p>
	<b>Reward Secret Code:</b>
	<%= @deal.reward_secret_code %>
</p>
<% @deal.subdeals.each do |subdeal| %>
<p>
   <b>Subdeal Title:</b>
   <%= subdeal.title %>
</p>
<p>
   <b>Subdeal Coupon Title:</b>
   <%= subdeal.coupon_title %>
</p>
<p>
   <b>Regular Price:</b>
   <%= subdeal.regular_price %>
</p>
<p>
   <b>Discount Price:</b>
   <%= subdeal.discount_price %>
</p>
<% end %>
<% @deal.referral_subjects.each do |subject| %>
<p>
   <b>Referral Seq#:</b>
   <%= subject.seq_num %>
</p>
<p>
   <b>Referral Subject:</b>
   <%= subject.content %>
</p>
<% end %>
<% if @merchant %>
<%= link_to 'Edit', edit_merchant_deal_path(@merchant,@deal) %> |
<%= link_to 'Back', merchant_deals_path %>
<% end %>
<% end %> 