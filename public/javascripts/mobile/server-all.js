Ext.define("Genesis.profile.Iphone",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.is.iPhone;}});Ext.define("Genesis.device.notification.PhoneGap",{override:"Ext.device.notification.PhoneGap",beep:function(a){navigator.notification.beep(a);},vibrate:function(a){navigator.notification.vibrate(a||2000);}});Ext.define("Genesis.profile.Android",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.is.Android;}});Ext.define("Genesis.device.notification.PhoneGap",{override:"Ext.device.notification.PhoneGap",beep:function(a){navigator.notification.beep(a);},vibrate:function(a){navigator.notification.vibrate(a||2000);}});Ext.define("Genesis.profile.Desktop",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.deviceType=="Desktop";}});Ext.define("Genesis.device.notification.Simulator",{override:"Ext.device.notification.Simulator",beep:function(a){console.log("Beep "+a+" times.");}});Ext.define("Genesis.device.notification.Desktop",{override:"Ext.device.notification.Desktop",beep:function(a){console.log("Beep "+a+" times.");}});Ext.define("Genesis.fx.animation.Scroll",{extend:"Ext.fx.animation.Abstract",alternateClassName:"Ext.fx.animation.ScrollIn",alias:["animation.scroll","animation.scrollIn"],config:{direction:"left",out:false,offset:0,easing:"auto",containerBox:"auto",elementBox:"auto",isElementBoxFit:true},reverseDirectionMap:{up:"down",down:"up",left:"right",right:"left"},applyEasing:function(a){if(a==="auto"){return"ease-"+((this.getOut())?"in":"out");}return a;},getData:function(){var e=this.getElement();var m=this.getFrom(),n=this.getTo(),d=this.getOut(),c=this.getOffset(),l=this.getDirection(),f=this.getReverse(),b=0,a=0,k,h,j,g;if(f){l=this.reverseDirectionMap[l];}switch(l){case this.DIRECTION_UP:case this.DIRECTION_DOWN:a=e.getHeight();break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:b=e.getWidth();break;}k=(d)?0:b;h=(d)?0:a;m.set("overflow","hidden");switch(l){case this.DIRECTION_UP:case this.DIRECTION_DOWN:m.set("height",h+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:m.set("width",k+"px");break;}j=(d)?b:0;g=(d)?a:0;n.set("overflow","hidden");switch(l){case this.DIRECTION_UP:case this.DIRECTION_DOWN:n.set("height",g+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:n.set("width",j+"px");break;}return this.callParent(arguments);}});Ext.define("Genesis.view.widgets.ListField",{extend:"Ext.field.Text",alternateClassName:"Genesis.field.List",xtype:"listfield",config:{ui:"list",component:{useMask:false},clearIcon:true,iconCls:"",readOnly:false},initialize:function(){var b=this,a=b.getComponent();b.callParent();if(b.getIconCls()){Ext.fly(b.element.query("."+Ext.baseCSSPrefix.trim()+"component-outer")[0]).addCls(b.getIconCls());}a.setReadOnly(true);},doClearIconTap:Ext.emptyFn});Ext.define("Genesis.view.widgets.ComponentListItem",{extend:"Ext.dataview.element.List",config:{maxItemCache:20},initialize:function(){this.callParent();this.doInitialize();this.itemCache=[];},getItemElementConfig:function(e,h){var f=this,c=f.dataview,g=c.getItemCls(),b=f.itemClsShortCache,d,a;if(g){b+=" "+g;}d={cls:b,children:[{cls:f.labelClsShortCache,}]};if(c.getIcon()){a=h.iconSrc;d.children.push({cls:f.iconClsShortCache,style:"background-image: "+a?'url("'+newSrc+'")':""});}return d;},moveItemsToCache:function(k,l){var j=this,d=j.dataview,b=d.getMaxItemCache(),h=j.getViewItems(),g=j.itemCache,f=g.length,n=d.getPressedCls(),e=d.getSelectedCls(),c=l-k,o;for(;c>=0;c--){o=Ext.get(h[k+c]);var m=o.down(j.labelClsCache,true);var a=Ext.getCmp(m.childNodes[0].id);if(f!==b){o.removeCls([n,e]);g.push(a);f++;}else{Ext.Array.remove(j.itemCache,a);a.destroy();}o.dom.parentNode.removeChild(o.dom);}if(j.getViewItems().length==0){this.dataview.showEmptyText();}},moveItemsFromCache:function(b){var l=this,e=l.dataview,m=e.getStore(),k=b.length;var a=e.getDefaultType(),h=e.getItemConfig();var g=l.itemCache,f=g.length,j=[],c,n,d;if(k){e.hideEmptyText();}for(c=0;c<k;c++){b[c]._tmpIndex=m.indexOf(b[c]);}Ext.Array.sort(b,function(p,o){return p._tmpIndex>o._tmpIndex?1:-1;});for(c=0;c<k;c++){d=b[c];if(f){f--;n=g.pop();l.updateListItem(d,n);}l.addListItem(d._tmpIndex,d,n);delete d._tmpIndex;}return j;},addListItem:function(f,d,n){var k=this,e=k.dataview,b=e.prepareData(d.getData(true),e.getStore().indexOf(d),d);var c=k.element,m=c.dom.childNodes,j=m.length,h;h=Ext.Element.create(this.getItemElementConfig(f,b));var a=e.getDefaultType(),g=e.getItemConfig();if(!j||f==j){h.appendTo(c);}else{h.insertBefore(m[f]);}var l=h.down(k.labelClsCache,true);if(!n){n=new Ext.widget(a,{xtype:a,record:d,dataview:e,itemCls:e.getItemCls(),defaults:g,renderTo:l});}else{n.element.appendTo(l);}},updateListItem:function(b,c){if(c.isComponent&&c.updateRecord){c.updateRecord(b);}else{var d=Ext.fly(c).down(this.labelClsCache,true);var a=Ext.getCmp(d.childNodes[0].id);a.updateRecord(b);}},destroy:function(){var d=this.getViewItems(),c=d.length,b=0,a=this.itemCache.length;for(;b<a;b++){this.itemCache[b].destroy();this.itemCache[b]=null;}delete this.itemCache;for(b=0;b<c;b++){Ext.removeNode(d[b]);}this.callParent();}});Ext.define("Genesis.view.widgets.ComponentList",{alternateClassName:"Genesis.ComponentList",extend:"Ext.dataview.List",xtype:"componentlist",requires:["Genesis.view.widgets.ComponentListItem"],initialize:function(){var b=this,a;b.on(b.getTriggerCtEvent(),b.onContainerTrigger,b);a=b.container=this.add(new Genesis.view.widgets.ComponentListItem({baseCls:this.getBaseCls()}));a.dataview=b;b.on(b.getTriggerEvent(),b.onItemTrigger,b);a.element.on({delegate:"."+this.getBaseCls()+"-disclosure",tap:"handleItemDisclosure",scope:b});a.on({itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd",itemtap:"onItemTap",itemtaphold:"onItemTapHold",itemtouchmove:"onItemTouchMove",itemsingletap:"onItemSingleTap",itemdoubletap:"onItemDoubleTap",itemswipe:"onItemSwipe",scope:b});if(this.getStore()){this.refresh();}}});Ext.define("Genesis.navigation.Bar",{extend:"Ext.navigation.Bar",requires:["Ext.fx.layout.card.Style"],config:{ui:"dark",defaultBackButtonText:"Back",altBackButtonText:"Close",mode:"slide",callbackFn:Ext.emptyFn,listeners:{activeitemchange:"onActiveItemChange"}},onViewAdd:function(b,g,c){var f=this;var h=b.getLayout().getAnimation();var a=f.titleComponent;f.endAnimation();f.backButtonStack.push(g.config.title||f.getDefaultBackButtonText());f.refreshNavigationBarProxy();var d=f.getNavigationBarProxyProperties();if(d.title.left){}if(d.title.width){a.setWidth(d.title.width);}var e=f.getBackButton();if(b.stack.length>0){e.setText(f.getBackButtonText());e.show();}else{e.hide();}f.setMode(b.getFadeMode()?"fade":"slide");f.titleComponent.setTitle(f.getTitleText());if(h&&h.isAnimation&&b.isPainted()&&f.elementGhost){if(b.getInnerItems().length>1){f.pushTbAnimated(g,f.getBackButtonText());}else{if(f.elementGhost){f.elementGhost.destroy();delete f.elementGhost;}}}else{if(b.getInnerItems().length>1){f.pushTb(g,f.getBackButtonText());}else{}}f.getCallbackFn()();},onViewRemove:function(b,f,c){var e=this;var g=b.getLayout().getAnimation();var a=e.titleComponent;e.endAnimation();e.backButtonStack.pop();e.refreshNavigationBarProxy();var d=e.getNavigationBarProxyProperties();if(d.title.left){}if(d.title.width){a.setWidth(d.title.width);}e.setMode(b.getFadeMode()?"fade":"slide");if(g&&g.isAnimation&&b.isPainted()&&e.elementGhost){e.popTbAnimated(f,e.getBackButtonText());}else{e.popTb(f,e.getBackButtonText());}e.titleComponent.setTitle(e.getTitleText());e.getCallbackFn()();},getTbAnimationProperties:function(a){var d=this,b=d.renderElement,e,c=d.getLayout();if(d.slideAnimation){d.slideAnimation.destroy();}if(d.fadeAnimation){d.fadeAnimation.destroy();}switch(d.getMode()){case"slide":d.slideAnimation=e=new Ext.fx.layout.card.Slide({direction:"left",listeners:{animationend:function(){if(d.elementGhost){d.elementGhost.destroy();delete d.elementGhost;d.getCallbackFn()();}}}});break;case"fade":d.fadeAnimation=e=new Ext.fx.layout.card.Fade({listeners:{animationend:function(){if(d.elementGhost){d.elementGhost.destroy();delete d.elementGhost;d.getCallbackFn()();}}}});break;default:console.debug("Unkown Special Effect - ["+d.getMode()+"]");e=d.getLayout().getAnimation();break;}e.setReverse(false);e.setLayout(c);c.setAnimation(e);return e;},getTbAnimationReverseProperties:function(a){var b=this.getTbAnimationProperties(a);b.setReverse(true);return b;},pushTb:function(a,f){var e=this;var b=e.getNavigationBarProxyProperties();var d=e.getBackButton();var c=b.backButton;if(c.left){d.setLeft(c.left);}if(c.width){d.setWidth(c.width);}e[(Ext.isEmpty(a.getHideNavBar)||!a.getHideNavBar())?"show":"hide"]();},pushTbAnimated:function(g,h){var f=this;var c=0;var j=f.getBackButton(),a=j.getText();var d=f.getTbAnimationProperties(g);var e=f.getNavigationBarProxyProperties();var b=e.backButton;if(b.left){j.setLeft(b.left);}if(b.width){j.setWidth(b.width);}f.fireEvent("activeitemchange",g,f,{renderElement:f.elementGhost,isPainted:f.isPainted});},popTb:function(a,f){var e=this,d=e.getBackButton();var b=this.getNavigationBarProxyProperties();if(f&&e.backButtonStack.length){d.setText(this.getBackButtonText());d.show();}else{d.hide();}var c=b.backButton;if(c.left){d.setLeft(c.left);}if(c.width){d.setWidth(c.width);}e[(Ext.isEmpty(a.getHideNavBar)||!a.getHideNavBar())?"show":"hide"]();},popTbAnimated:function(h,j){var g=this;var d=g.element,c=g.renderElement,k=g.getBackButton();var a=k.getText();var f=g.getTbAnimationReverseProperties(h);var e=this.getNavigationBarProxyProperties();if(j&&g.backButtonStack.length){k.setText(this.getBackButtonText());k.show();}else{k.hide();}var b=e.backButton;if(b.width){k.setWidth(b.width);}g.fireEvent("activeitemchange",h,g,{renderElement:g.elementGhost,isPainted:g.isPainted});},createNavigationBarProxy:function(){var a=this.proxy;if(a){return;}this.proxy=a=Ext.create("Ext.TitleBar",{title:this.backButtonStack[0]});a.add(Ext.applyIf({hidden:false,text:""},this.config.backButton));a.add(this.config.rightButton);a.backButton=a.down("button[ui=back]");Ext.getBody().appendChild(a.renderElement);a.renderElement.setStyle("position","absolute");a.element.setStyle("visibility","hidden");a.renderElement.setX(0);a.renderElement.setY(-1000);},refreshNavigationBarProxy:function(){var c=this.proxy,b=this.renderElement,a=this.backButtonStack,e=a[a.length-1],d=this.getBackButtonText();if(!c){this.createNavigationBarProxy();c=this.proxy;}c.renderElement.setWidth(b.getWidth());c.renderElement.setHeight(b.getHeight());c.setTitle(e);if(d){c.backButton.setText(d);c.backButton.show();}else{}c.refreshTitlePosition();},getNavigationBarProxyProperties:function(){return({title:{left:this.proxy.titleComponent.renderElement.getLeft(),width:this.proxy.titleComponent.renderElement.getWidth()},leftBox:{left:this.proxy.leftBox.renderElement.getLeft(),width:this.proxy.leftBox.renderElement.getWidth()},rightBox:{left:this.proxy.rightBox.renderElement.getLeft(),width:this.proxy.rightBox.renderElement.getWidth()},backButton:{left:this.proxy.backButton.renderElement.getLeft(),width:this.proxy.backButton.renderElement.getWidth()}});},createProxy:function(c,d,b,a){var f=this;var e=(a)?d.element.getParent():d.element,g=Ext.get(e.id+"-proxy");if(!g){g=e.dom.cloneNode(true);g.id=e.id+"-proxy";g.children[0].id=e.dom.children[0].id+"-proxy";e.getParent().dom.appendChild(g);g=Ext.get(g);g.setStyle("position","absolute");g.setY(e.getY());g.setX(e.getX());g.setWidth(e.getWidth());g.dom.style.setProperty("z-index",1,"important");}f[!Ext.isEmpty(b.getHideNavBar)?(b.getHideNavBar()?"hide":"show"):"show"]();return g;},reset:function(){this.backButtonStack=[];this.lastAnimationProperties={};},onActiveItemChange:function(j,f,l,m,d){var h=this,b,e=h.getLayout();var a=e.getAnimation().getInAnimation(),k=e.getAnimation().getOutAnimation(),g,c;if(f&&l&&l.isPainted()){g=f.renderElement;c=l.renderElement;a.setOut(!Ext.isEmpty(j.getHideNavBar)&&j.getHideNavBar());a.setElement(g);k.setElement(c);k.setOnBeforeEnd(function(n,o){if(o||Ext.Animator.hasRunningAnimations(n)){d.firingArguments[1]=null;d.firingArguments[2]=null;}});k.setOnEnd(function(){d.resume();});g.dom.style.setProperty("visibility","hidden","!important");if(Ext.isEmpty(j.getHideNavBar)||!j.getHideNavBar()){f.show();}h.activeAnimations=[k,a];Ext.Animator.run(h.activeAnimations);d.pause();}return b;}});Ext.define("Genesis.model.frontend.MainPage",{extend:"Ext.data.Model",id:"MainPage",config:{fields:["name","photo_url","desc","pageCntlr","subFeature","hide"],proxy:{reader:{type:"json",messageProperty:"message",rootProperty:"data"},type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/"+((!merchantMode)?"mainClientPage.json":"mainServerPage.json")}}});Ext.define("Genesis.model.UserProfile",{extend:"Ext.data.Model",alternateClassName:"UserProfile",id:"UserProfile",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"}],fields:["gender","birthday","zipcode","created_ts","update_ts","user_id"]},getUser:function(){}});Ext.define("Genesis.model.User",{extend:"Ext.data.Model",requires:["Genesis.model.UserProfile"],alternateClassName:"User",id:"User",config:{hasOne:[{model:"Genesis.model.UserProfile",associationKey:"profile"}],proxy:{type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/users.json",reader:{type:"json"}},fields:["user_id","name","email","facebook_id","photo_url","created_ts","update_ts","profile_id"],idProperty:"user_id"}});Ext.define("Genesis.model.Merchant",{extend:"Ext.data.Model",alternateClassName:"Merchant",id:"Merchant",config:{fields:["id","name","email","photo","alt_photo","account_first_name","account_last_name","phone","auth_code","qr_code","payment_account_id","created_ts","update_ts","type"],idProperty:"id"}});Ext.define("Genesis.model.Challenge",{extend:"Ext.data.Model",id:"Challenge",alternateClassName:"Challenge",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],fields:["id","type","name","description","require_verif","data","points","created_ts","update_ts","photo","merchant_id","venue_id"],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetChallengesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/challenges":Ext.Loader.getPath("Genesis")+"/store/challenges.json");},setCompleteChallengeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/"+a+"/complete");},}});Ext.define("Genesis.model.Checkin",{extend:"Ext.data.Model",alternateClassName:"Checkin",id:"Checkin",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"},{model:"Genesis.model.Venue",getterName:"getVenue",setterName:"setVenue"}],fields:["id","time"]}});Ext.define("Genesis.model.PurchaseReward",{extend:"Ext.data.Model",id:"PurchaseReward",alternateClassName:"PurchaseReward",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["id","title","points","type","photo","created_ts","update_ts","qty"]},getMerchant:function(){},statics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/purchase_rewards":Ext.Loader.getPath("Genesis")+"/store/rewards.json");}}});Ext.define("Genesis.model.CustomerReward",{extend:"Ext.data.Model",id:"CustomerReward",alternateClassName:"CustomerReward",config:{fields:["id","title","points","type","photo"],idProperty:"id",belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetRedemptionsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/customer_rewards":Ext.Loader.getPath("Genesis")+"/store/redemptions.json");},setRedeemPointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customer_rewards/"+a+"/redeem");}}});Ext.define("Genesis.model.EarnPrize",{extend:"Ext.data.Model",id:"EarnPrize",alternateClassName:"EarnPrize",config:{fields:["id",{name:"expiry_date",type:"date",convert:function(a,b){var a=Date.parse(a,"yyyy-MM-dd");return(!a)?"N/A":Genesis.constants.convertDateNoTimeNoWeek.apply(this,arguments);}}],idProperty:"id",belongsTo:[{model:"Genesis.model.CustomerReward",associationKey:"reward",getterName:"getCustomerReward",setterName:"setCustomerReward"},{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"},{model:"Genesis.model.User",associationKey:"user",getterName:"getUser",setterName:"setUser"}],proxy:{type:"ajax",disableCaching:false,actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getUser:function(){},statics:{setEarnPrizeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/purchase_rewards/earn");},setRedeemPrizeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/earn_prizes/"+a+"/redeem");}}});Ext.define("Genesis.model.Venue",{extend:"Ext.data.Model",requires:["Genesis.model.Challenge","Genesis.model.PurchaseReward","Genesis.model.CustomerReward"],alternateClassName:"Venue",id:"Venue",config:{fields:["id","name","address","distance","city","state","country","zipcode","phone","website","latitude","longitude","created_ts","update_ts","type","merchant_id","sort_id"],belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"}],hasMany:[{model:"Genesis.model.Challenge",name:"challenges"},{model:"Genesis.model.PurchaseReward",name:"purchaseReward"},{model:"Genesis.model.CustomerReward",name:"customerReward"}],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}},idProperty:"id",},statics:{setFindNearestURL:function(){this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_nearest":Ext.Loader.getPath("Genesis")+"/store/checkinRecords.json");},setGetClosestVenueURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_closest":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setSharePhotoURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/share_photo":Ext.Loader.getPath("Genesis")+"/store/sharePhoto.json");}}});Ext.define("Genesis.model.EligibleReward",{extend:"Ext.data.Model",id:"EligibleReward",alternateClassName:"EligibleReward",config:{idProperty:"id",fields:["id","reward_id","reward_title","reward_text","reward_type","photo"]}});Ext.define("Genesis.model.Customer",{extend:"Ext.data.Model",requires:["Genesis.model.Checkin"],alternateClassName:"Customer",id:"Customer",config:{belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"},{model:"Genesis.model.User",associationKey:"user",getterName:"getUser",setterName:"setUser"}],hasOne:{model:"Genesis.model.Checkin",associationKey:"last_check_in",getterName:"getLastCheckin",setterName:"setLastCheckin"},proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["points","visits","id"],idProperty:"id"},getUser:function(){},statics:{setFbLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens/create_from_facebook":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setUpdateFbLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/account/update_facebook_info");},setLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setLogoutUrl:function(b){var a=window.localStorage;this.getProxy().setActionMethods({read:"DELETE"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/tokens/"+b);},setCreateAccountUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/sign_up":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setVenueScanCheckinUrl:function(){this.setVenueCheckinUrl();},setVenueCheckinUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/check_ins":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setVenueExploreUrl:function(a){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/"+a+"/explore":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");}}});Ext.define("Genesis.model.frontend.Account",{extend:"Ext.data.Model",alternateClassName:"Account",id:"Account",config:{fields:["name","username","password"],validations:[{type:"format",field:"name",matcher:/^([a-zA-Z'-]+\s+){1,4}[a-zA-z'-]+$/},{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.model.frontend.Signin",{extend:"Ext.data.Model",alternateClassName:"Signin",id:"Sigin",config:{fields:["username","password"],validations:[{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.view.ViewBase",{extend:"Ext.Container",xtype:"viewbase",config:{},beforeActivate:function(h,b){if(b){var a=Ext.ComponentQuery.query("viewportview")[0];var c=b.getXTypes();for(var f=0;f<a.stack.length;f++){if(a.stack[f].getXTypes().match("merchantaccountview")){var g=a.getNavigationBar();var d=g.getBackButton();var e=g.proxy.backButton;e.setUi("normal");d.setUi("normal");g.setDefaultBackButtonText(g.getAltBackButtonText());e.setText(g.getAltBackButtonText());break;}}if(c.match("merchantaccountview")){a.setAnimationDir("up");}}},beforeDeactivate:function(g,b){var a=Ext.ComponentQuery.query("viewportview")[0];var f=a.getNavigationBar();var c=f.getBackButton();var d=f.proxy.backButton;d.setUi("back");c.setUi("back");f.setDefaultBackButtonText(f.config.defaultBackButtonText);d.setText(f.config.defaultBackButtonText);if(b){var e=g.getXTypes();if(e.match("merchantaccountview")){a.setAnimationDir("up");}}},afterActivate:function(b,a){},afterDeactivate:function(b,a){}});Ext.define("Genesis.view.Viewport",{extend:"Ext.navigation.View",requires:["Ext.MessageBox","Ext.ActionSheet","Ext.fx.layout.Card","Ext.SegmentedButton","Genesis.navigation.Bar"],xtype:"viewportview",config:{fadeMode:false,enableAnim:true,autoDestroy:false,cls:"viewport",fullscreen:true,useTitleForBackButtonText:false,defaultBackButtonText:"Back",altBackButtonText:"Close",navigationBar:{defaults:{iconMask:true},docked:"top",cls:"navigationBarTop",layout:{pack:"justify",align:"center"},items:[{align:"left",iconCls:"maps",tag:"mapBtn",hidden:true},{align:"right",iconCls:"share",tag:"shareBtn",hidden:true,handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{hideOnMaskTap:false,defaults:{defaultUnit:"em",margin:"0 0 0.5 0",xtype:"button",iconCls:"dummy",iconAlign:"left",iconMask:true},items:[{text:"Email",iconCls:"mail",tag:"mail",handler:Ext.emptyFn},{text:"SMS Message",tag:"sms",iconCls:"compose",handler:Ext.emptyFn},{text:"Facebook",tag:"fbShareBtn",ui:"blue",iconCls:"facebook",handler:Ext.emptyFn},{margin:"0.5 0 0 0",text:"Cancel",iconMaskCls:"dummymask",ui:"confirm",scope:this,handler:function(){this.actions.hide();}}]});Ext.Viewport.add(this.actions);}this.actions.show();}},{align:"right",tag:"info",iconCls:"info",destroy:function(){this.actions.destroy();this.callParent(arguments);},handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{defaultUnit:"em",padding:"1em",hideOnMaskTap:false,defaults:{xtype:"button",defaultUnit:"em"},items:[{margin:"0 0 0.5 0",text:"Logout",tag:"logout"},{margin:"0.5 0 0 0",text:"Cancel",scope:this,handler:function(){this.actions.hide();}}]});Ext.Viewport.add(this.actions);}this.actions.show();}},{align:"right",tag:"checkin",iconCls:"check_black1",hidden:true},{align:"right",tag:"done",text:"Done",hidden:true},{align:"right",tag:"redeem",text:"Redeem",hidden:true},{align:"right",tag:"post",text:"Post",hidden:true}]},items:[]},initialize:function(){this.stack=[];this.fadeAnimation={type:"fade",listeners:{scope:this,animationend:"resetFadeAnimation"}};this.callParent(arguments);var b=this.getLayout(),a=b.getAnimation();a.on("animationend","resetAnimation",this);if(!merchantMode){Genesis.constants.initFb();}this.getNavigationBar()["hide"]();},applyNavigationBar:function(a){if(!a){a={hidden:true,docked:"top"};}if(a.title){delete a.title;Ext.Logger.warn("Ext.navigation.View: The 'navigationBar' configuration does not accept a 'title' property. You set the title of the navigationBar by giving this navigation view's children a 'title' property.");}a.view=this;return Ext.factory(a,Genesis.navigation.Bar,this.getNavigationBar());},resetAnimation:function(){var b=this.getActiveItem().getXTypes();var a=this.getLayout().getAnimation(0);a.getInAnimation().setDirection(this.defaultInAnimationDir);a.getOutAnimation().setDirection(this.defaultOutAnimationDir);this.setFadeMode(false);},setAnimationDir:function(b){var c=this.getLayout(),a;if(c.isCard){a=c.getAnimation();if(a){this.defaultInAnimationDir=a.getInAnimation().getDirection();this.defaultOutAnimationDir=a.getOutAnimation().getDirection();a.getInAnimation().setDirection(b);a.getOutAnimation().setDirection(b);this.setFadeMode(b=="up");}}},resetFadeAnimation:function(){var a=this.getLayout();a.setAnimation(this.defaultAnimation);this.setFadeMode(false);},setFadeAnimation:function(){var a=this.getLayout();this.defaultAnimation=a.getAnimation();a.setAnimation(this.fadeAnimation);this.setFadeMode(true);},doPop:function(b){var d=this;d.stack.pop();var f=d.getLayout().getAnimation();var a=d.stack[d.stack.length-1];var e=d.getActiveItem().getXTypes();if(f&&f.isAnimation&&d.getEnableAnim()){f.setReverse(true);var c=d.getNavigationBar();c.elementGhost=c.createProxy(d,c,a);}d.setActiveItem(a);d.getNavigationBar().onViewRemove(d,a,null);return a;},getPreviousItem:function(){var a=this;return a.stack[a.stack.length-1];},push:function(a){var c=this;var d=c.getLayout().getAnimation();var b=c.getNavigationBar();if((c.stack.length==0)&&(!b.titleComponent.getTitle())){b.titleComponent.setTitle(a.config.title||b.getDefaultBackButtonText());}if(d&&d.isAnimation&&c.getEnableAnim()){d.setReverse(false);b.elementGhost=b.createProxy(c,b,a);}if(c.getInnerItems().indexOf(a)<0){a=c.add(a);}else{c.setActiveItem(a);c.getNavigationBar().onViewAdd(c,a,null);}c.stack.push(a);return a;},doSetActiveItem:function(d,a){if(!d){return;}var c=this;if(d.getInitialConfig().changeTitle===true){var b=_application.getController("Viewport").getVenue();if(b){d.getInitialConfig().title=b.get("name");}}if(a){a.beforeDeactivate(d,a);}d.beforeActivate(d,a);c.callParent(arguments);if(a){a.afterDeactivate(d,a);}d.afterActivate(d,a);},beforePop:function(d){var c=this;var b=c.stack.length;if(!Ext.isNumber(d)||d<1){d=1;}d=Math.min(d,b);if(d){if(d==b){var a=c.getNavigationBar();a.reset();c.stack=[];a.getBackButton().hide();a.getBackButton().setText(null);}else{c.getNavigationBar().beforePop(d);for(i=0;i<d-1;i++){this.stack.pop();}return true;}}return false;},pop:function(c){var b=this;var a=b.getNavigationBar();b.callParent(arguments);},reset:function(){var b=this;var a=b.stack.length;this.pop(a);},silentPop:function(c){var a;var b=this.getNavigationBar();for(a=0;a<c;a++){this.stack.pop();b.backButtonStack.pop();}}});Ext.define("Genesis.view.MainPage",{extend:"Ext.Carousel",requires:["Ext.dataview.DataView","Ext.XTemplate"],alias:"widget.mainpageview",config:{title:"KickBak",changeTitle:false,direction:"horizontal",items:(!merchantMode)?[{docked:"bottom",cls:"checkInNow",tag:"checkInNow",xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"button",ui:"checkInNow",tag:"checkInNow",text:"Check In Now!"}]}]:null},beforeActivate:function(){var g=this;var a=_application.getController("Viewport");var c=Ext.ComponentQuery.query("viewportview")[0];var b=a.getCheckinInfo().venue!=null;var d=Ext.StoreMgr.get("MainPageStore").getRange();var f=Ext.Array.clone(d);g.removeAll(true);if(!b){Ext.Array.forEach(f,function(k,h,j){switch(k.get("hide")){case"true":Ext.Array.remove(d,k);break;}});}for(var e=0;e<Math.ceil(d.length/6);e++){g.add({xtype:"dataview",cls:"mainMenuSelections",scrollable:false,deferInitialRefresh:false,store:{model:"Genesis.model.frontend.MainPage",data:Ext.Array.pluck(d.slice(e*6,((e+1)*6)),"data")},itemTpl:Ext.create("Ext.XTemplate",'<div class="mainPageItemWrapper">','<div class="photo"><img src="{[this.getPhoto(values.photo_url)]}" /></div>','<div class="photoName">{name}</div>',"</div>",{getPhoto:function(h){return Ext.isEmpty(h)?Ext.BLANK_IMAGE_URL:h;}}),autoScroll:true});}if(g.getInnerItems().length>0){g.setActiveItem(0);}},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.server.SettingsPage",{extend:"Ext.form.Panel",requires:["Ext.dataview.List","Ext.XTemplate","Genesis.view.widgets.ListField"],alias:"widget.serversettingspageview",config:{title:"Settings",changeTitle:false,scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"fieldset",title:"About Kickbak",items:[{xtype:"textfield",value:"Version 1.0",readOnly:true},{xtype:"listfield",name:"terms",value:"Terms & Conditions"},{xtype:"listfield",name:"privacy",value:"Privacy"},{xtype:"listfield",name:"aboutus",value:"About Us"}]}]},beforeActivate:function(){},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.server.Rewards",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar"],alias:"widget.serverrewardsview",config:{title:"Kickbak Rewards",changeTitle:false,layout:"vbox",items:[{xtype:"container",tag:"rewards",cls:"rewardsServerMain",flex:1,layout:{type:"card",animation:{duration:600,easing:"ease-in-out",type:"slide",direction:"down"}},activeItem:0,defaults:{layout:"fit"},items:[{xtype:"container",tag:"rewardsMainCalculator",cls:"rewardsMainCalculator",items:[{docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Amount Spent"},{xtype:"spacer",align:"right"}]},{docked:"top",xtype:"textfield",name:"price",clearIcon:false,placeHolder:"Enter the price",readOnly:true,required:true,cls:"rewardsCalculator"},{xtype:"container",layout:"vbox",tag:"dialpad",cls:"dialpad",defaults:{xtype:"container",layout:"hbox",flex:1,defaults:{xtype:"button",flex:1}},items:[{items:[{text:"1"},{text:"2"},{text:"3"}]},{items:[{text:"4"},{text:"5"},{text:"6"}]},{items:[{text:"7"},{text:"8"},{text:"9"}]},{items:[{text:"AC"},{text:"0"},{text:"."}]}]},{docked:"bottom",xtype:"button",cls:"separator",tag:"showQrCode",text:"Show QRCode",ui:"orange-large"}]},{xtype:"container",tag:"qrcodeContainer",cls:"qrcodeContainer",items:[{xtype:"component",tag:"qrcode",cls:"qrcode"},{docked:"bottom",xtype:"button",cls:"separator done",tag:"done",text:"Done",ui:"large"}]}]}]},statics:{getPhoto:function(a){var b=null;switch(a.value){case"custom":break;default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.view.server.Redemptions",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar"],alias:"widget.serverredemptionsview",config:{title:"Redemptions",changeTitle:false,scrollable:"vertical",cls:"redemptionsMain",layout:"vbox",items:[]},statics:{getPhoto:function(a){var b=null;switch(a.value){case"custom":break;default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.controller.ControllerBase",{extend:"Ext.app.Controller",requires:["Ext.data.Store","Ext.util.Geolocation"],statics:{},loadingScannerMsg:"Loading Scanner ...",loadingMsg:"Loading ...",noCodeScannedMsg:"No QR Code Scanned!",geoLocationErrorMsg:"Cannot locate your current location. Try again or enable permission to do so!",geoLocationTimeoutErrorMsg:"Cannot locate your current location. Try again or enable permission to do so!",geoLocationPermissionErrorMsg:"No permission to location current location. Please enable permission to do so!",missingVenueInfoMsg:"Error loading Venue information.",showToServerMsg:"Show this to your server before proceeding.",showScreenTimeoutExpireMsg:function(a){return a+" are up! Press OK to confirm.";},showScreenTimeoutMsg:function(a){return"You have "+a+" to show this screen to a employee before it disappears!";},uploadFbMsg:"Uploading to Facebook ...",uploadServerMsg:"Uploading to server ...",init:function(){this.callParent(arguments);},getViewPortCntlr:function(){return this.getApplication().getController("Viewport");},getViewport:function(){return this.getViewPortCntlr().getView();},getPrivKey:function(){return"000102030405060708090a0b0c0d0e0f";},pushView:function(d){var b=this.getViewport();var e=this.getApplication();var a=b.stack;var c=(a.length>1)?a[a.length-2]:null;if(c&&c==d){this.popView();}else{b.push(d);}},popView:function(c,g,d,f){var a=this.getViewport();var h=this.getApplication();a.pop();},getMainPage:Ext.emptyFn,openMainPage:Ext.emptyFn,openPage:Ext.emptyFn,goToMain:function(){console.log("LoggedIn, Going to Main Page ...");var b=this;var a=b.getViewPortCntlr();a.setLoggedIn(true);b.getViewport().reset();a.onFeatureTap("MainPage","main");},isOpenAllowed:function(){return"Cannot Open Folder";},getGeoLocation:function(c,a){var b=this;a=a||0;console.debug("Getting GeoLocation ...");if(!Genesis.constants.isNative()){c({coords:{getLatitude:function(){return"-50.000000";},getLongitude:function(){return"50.000000";}}});}else{console.debug("Connection type: ["+Ext.device.Connection.getType()+"]");if(!b.geoLocation){b.geoLocation=Ext.create("Ext.util.Geolocation",{autoUpdate:false,frequency:1,maximumAge:30000,timeout:50000,allowHighAccuracy:true,listeners:{locationupdate:function(f,e){if(!f){console.log("No GeoLocation found!");return;}var d={coords:f};console.debug("\nLatitude: "+f.getLatitude()+"\nLongitude: "+f.getLongitude()+"\nAltitude: "+f.getAltitude()+"\nAccuracy: "+f.getAccuracy()+"\nAltitude Accuracy: "+f.getAltitudeAccuracy()+"\nHeading: "+f.getHeading()+"\nSpeed: "+f.getSpeed()+"\nTimestamp: "+new Date(f.getTimestamp())+"\n");c(d);},locationerror:function(h,d,e,g,f){console.debug("GeoLocation Error["+f+"]");if(e){console.debug("PERMISSION_DENIED");Ext.device.Notification.show({title:"Permission Error",message:b.geoLocationPermissionErrorMsg});}else{if(g){console.debug("POSITION_UNAVAILABLE");if(++a<=5){Ext.Function.defer(b.getGeoLocation,1*1000,b,[c,a]);console.debug("Retry getting current location("+a+") ...");}else{Ext.device.Notification.show({title:"Error",message:b.geoLocationErrorMsg});}}else{if(d){console.debug("TIMEOUT");Ext.device.Notification.show({title:"Timeout Error",message:b.geoLocationTimeoutErrorMsg});}}}}}});}b.geoLocation.updateLocation();}},scanQRCode:function(b){var c=this;var a=function(f){Ext.Viewport.setMasked(false);b.callback();console.debug("Failed because: "+f);};var e=function(f){Ext.Viewport.setMasked(false);var g=(f.response=="undefined")?"":(f.response||"");if(Genesis.constants.isNative()){switch(window.plugins.qrCodeReader.scanType){case"RL":console.debug("QR Code RL  = "+g);break;case"Nigma":if(!g){console.debug("QR Code Nigma = Empty");}else{console.debug("QR Code Nigma = "+((g.responseCode)?g.responseCode:"NONE")+" Sent = "+g.bytesSent+" bytes");}if(g&&g.responseCode){g=g.responseCode;}break;}}else{console.debug("QR Code = "+g);}b.callback(g);};console.debug("Scanning QR Code ...");if(!Genesis.constants.isNative()){var d=0;if(!merchantMode){d=(c.getCheckinMerchant&&c.getCheckinMerchant().venue)?c.getCheckinMerchant().venue.getId():Ext.StoreMgr.get("CheckinExploreStore").first().getId();}e({response:d});}else{Ext.Viewport.setMasked({xtype:"loadmask",message:c.loadingScannerMsg});Ext.defer(function(){window.plugins.qrCodeReader.getCode(e,a);},500);}},genQRCode:function(p){var b=3;var m=0;var e="rgb(0,0,0)";var h="rgb(255,255,255)";var n=6;var d=document.createElement("canvas");var q=d.getContext("2d");try{var l=new QRCode(n,QRErrorCorrectLevel.L);l.addData(p);l.make();}catch(g){console.log("Error Code : "+g);Ext.device.Notification.show({title:"Code Generation Error",message:g});return null;}var k=l.getModuleCount();var o=(k*b)+m;d.setAttribute("height",o);d.setAttribute("width",o);console.log("QR Code Size = ["+o+"x"+o+"]");var f=m/2;if(d.getContext){for(var a=0;a<k;a++){for(var j=0;j<k;j++){if(l.isDark(a,j)){q.fillStyle=e;}else{q.fillStyle=h;}q.fillRect((j*b)+f,(a*b)+f,b,b);}}}return d.toDataURL("image/png");}});var _application;Ext.define("Genesis.controller.Viewport",{extend:"Genesis.controller.ControllerBase",statics:{},config:{loggedIn:false,customer:null,venue:null,metaData:null,checkinInfo:{venue:null,customer:null,metaData:null},refs:{view:"viewportview",shareBtn:"viewportview button[tag=shareBtn]",fbShareBtn:"actionsheet button[tag=fbShareBtn]",checkInNowBtn:"button[tag=checkInNow]"},control:{view:{push:"onPush"},fbShareBtn:{tap:"onShareMerchantTap"},"viewportview button[tag=close]":{tap:"popView"},checkInNowBtn:{tap:"onCheckinScanTap"},"tabbar[cls=navigationBarBottom] button[tag=info]":{tap:"onInfoTap"},"tabbar[cls=navigationBarBottom] button[tag=home]":{tap:"onHomeButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=prizes]":{tap:"onPrizesButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=accounts]":{tap:"onAccountsButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=challenges]":{tap:"onChallengesButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=rewards]":{tap:"onRewardsButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=redemption]":{tap:"onRedemptionsButtonTap"},tabbar:{tabchange:"onTabBarTabChange"}}},retrieveChallengesMsg:"Retrieving Challenges ...",onFeatureTap:function(c,a){var d=this.getApplication();var b=d.getController(c);d.dispatch({action:(!a)?"openMainPage":"openPage",args:(!a)?[]:[a],controller:b,scope:b});},onShareMerchantTap:function(a,g,c,f){var d=window.localStorage;Genesis.constants.facebook_onLogin(function(e){var b=this.getVenue().getMerchant();FB.ui({method:"stream.publish",name:b.get("name"),link:Genesis.constants.site,caption:Genesis.constants.site,description:b.get("desc"),piture:b.get("photo")["thumbnail_ios_medium"].url,message:"Comment"},function(h){if(h&&h.post_id){console.log("Posted to your Facebook Newsfeed. Post ID("+h.post_id+")");}else{console.log("Post was not published to Facebook.");}});});},onInfoTap:function(a,f,c,d){},onCheckinScanTap:function(a,h,d,k){var f=this;var j=f.getApplication();var c=j.getController("Checkins");var g=Ext.StoreMgr.get("CheckinExploreStore");f.getGeoLocation(function(b){Venue.setFindNearestURL();g.load({params:{latitude:b.coords.getLatitude(),longitude:b.coords.getLongitude()},callback:function(l,e){if(e.wasSuccessful()){c.setPosition(b);j.dispatch({action:"onCheckinScanTap",controller:c,args:[a,h,d,k],scope:c});}else{Ext.device.Notification.show({title:"Error",message:f.missingVenueInfoMsg});}},scope:f});});},onAccountsButtonTap:function(a,f,c,d){this.onFeatureTap("Accounts");console.log("Going to Accounts Page ...");},onChallengesButtonTap:function(a,g,c,f){var d=this;var h=d.getVenue();Ext.Viewport.setMasked({xtype:"loadmask",message:d.retrieveChallengesMsg});Challenge.setGetChallengesURL();Challenge.load(h.getId(),{params:{merchant_id:h.getMerchant().getId(),venue_id:h.getId()},callback:function(b,e){Ext.Viewport.setMasked(false);if(e.wasSuccessful()){h.challenges().add(e.getRecords());d.onFeatureTap("Challenges");console.log("Going to Challenges Page ...");}}});},onRewardsButtonTap:function(a,f,c,d){this.onFeatureTap("client.Rewards","rewards");console.log("Going to Client Rewards Page ...");},onRedemptionsButtonTap:function(a,f,c,d){this.onFeatureTap("client.Redemptions","redemptions");console.log("Going to Client Redemptions Page ...");},onPrizesButtonTap:function(a,f,c,d){this.onFeatureTap("Prizes");console.log("Going to Prizes Page ...");},onHomeButtonTap:function(a,f,c,d){this.getViewport().reset();this.onFeatureTap("MainPage");console.log("Going back to HomePage ...");},onTabBarTabChange:function(b,d,c,a){Ext.defer(function(){if(d){d.setActive(false);}if(c){c.setActive(false);}},500);return true;},onPush:function(a,b){},init:function(a){this.callParent(arguments);console.log("Viewport Init");_application=a;},openMainPage:function(){var c=window.localStorage;var a=(c.getItem("auth_code"))?true:false;if(!merchantMode){if(a){var d=this.getApplication();var b=d.getController("MainPage");this.setLoggedIn(a);if(c.getItem("currFbId")>0){d.dispatch({action:"onFacebookTap",args:[],controller:b,scope:b});}else{d.dispatch({action:"onSignIn",args:[],controller:b,scope:b});}}else{this.onFeatureTap("MainPage","login");}}}});Ext.define("Genesis.controller.Settings",{extend:"Genesis.controller.ControllerBase",statics:{settings_path:"/settings",},xtype:"settingsCntlr",config:{refs:{clientSettingsPage:{selector:"clientsettingspageview",autoCreate:true,xtype:"clientsettingspageview"},serverSettingsPage:{selector:"serversettingspageview",autoCreate:true,xtype:"serversettingspageview"}},control:{}},init:function(){this.callParent(arguments);this.initClientControl();this.initServerControl();console.log("Settings Init");},initClientControl:function(){this.control({"clientsettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"clientsettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"clientsettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"},"clientsettingspageview listfield[name=facebook]":{clearicontap:"onFacebookTap"}});},initServerControl:function(){this.control({"serversettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"serversettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"serversettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"}});},getMainPage:function(){return this.getSettingsPage();},openMainPage:function(){var a=this.getMainPage();this.pushView(a);console.log("SettingsPage Opened");},onTermsTap:function(a,c){Ext.device.Notification.show({title:"Button Tapped",message:"Disclose List Item"});},onFacebookTap:function(a,c){Genesis.constants.facebook_onLogin(function(b){Customer.setUpdateFbLoginUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:{user:Ext.encode(b)}});},false);},onTermsTap:function(a,c){Ext.device.Notification.show({title:"Terms Tapped",message:"Disclose List Item"});},onPrivacyTap:function(a,c){Ext.device.Notification.show({title:"Privacy Tapped",message:"Disclose List Item"});},onAboutUsTap:function(a,c){Ext.device.Notification.show({title:"About Us Tapped",message:"Disclose List Item"});},openPage:function(a){var b;switch(a){case"client":b=this.getClientSettingsPage();break;case"server":b=this.getServerSettingsPage();break;}this.pushView(b);},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.MainPage",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store","Genesis.model.EarnPrize"],statics:{mainPage_path:"/mainPage",loginPage_path:"/loginPage",sign_in_path:"/sign_in",sign_out_path:"/sign_out",},xtype:"mainPageCntlr",config:{models:["frontend.MainPage","frontend.Signin","frontend.Account","EligibleReward","Customer","User","Merchant","EarnPrize","CustomerReward"],refs:{login:{selector:"loginpageview",autoCreate:true,xtype:"loginpageview"},signin:{selector:"signinpageview",autoCreate:true,xtype:"signinpageview"},createAccount:{selector:"createaccountpageview",autoCreate:true,xtype:"createaccountpageview"},main:{selector:"mainpageview",autoCreate:true,xtype:"mainpageview"},mainCarousel:"mainpageview",infoBtn:"viewportview button[tag=info]"},control:{login:{activate:"onLoginActivate",deactivate:"onLoginDeactivate"},"actionsheet button[tag=facebook]":{tap:"onFacebookTap"},"actionsheet button[tag=createAccount]":{tap:"onCreateAccountTap"},"actionsheet button[tag=signIn]":{tap:"onSignInTap"},"signinpageview button[tag=login]":{tap:"onSignInSubmit"},"actionsheet button[tag=logout]":{tap:"onLogoutTap"},main:{activate:"onActivate",deactivate:"onDeactivate"},"mainpageview dataview":{select:"onItemSelect",itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd"},createAccount:{activate:"onCreateActivate",deactivate:"onCreateDeactivate"},"createaccountpageview button[tag=createAccount]":{tap:"onCreateAccountSubmit"}}},signInFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please Try Again";},init:function(b){this.callParent(arguments);var a=this;Ext.regStore("MainPageStore",{model:"Genesis.model.frontend.MainPage",autoLoad:true,listeners:{scope:a,load:function(e,d,g,c,f){if(merchantMode){a.goToMain();}}}});if(!merchantMode){Ext.regStore("UserStore",{model:"Genesis.model.User",autoLoad:false});a.initMerchantPrizeStore();Ext.regStore("EligibleRewardsStore",{model:"Genesis.model.EligibleReward",autoLoad:false});a.initCustomerStore();}console.log("MainPage Init");},initCustomerStore:function(){var b=this;var a=window.localStorage;Ext.regStore("CustomerStore",{model:"Genesis.model.Customer",autoLoad:false,pageSize:1000,listeners:{scope:b,load:function(e,d,g,c,f){if(g&&a.getItem("auth_code")){b.goToMain();}},metachange:function(q,m,l){var d=m.getReader().metaData;var j=d.prizes;if(j){console.debug("Total Prizes - "+j.length);for(var h=0;h<j.length;h++){j[h].reward={data:j[h].reward};}Ext.StoreMgr.get("MerchantPrizeStore").setData(j);}var p=d.auth_token;if(p){console.debug("Login Auth Code - "+p);a.setItem("auth_code",p);}var c=d.eligible_rewards;if(c){console.debug("Total Eligible Rewards - "+c.length);var o=Ext.StoreMgr.get("EligibleRewardsStore");o.setData(c);}var e=d.rewards;if(e){console.debug("Total Redemption Rewards - "+e.length);var n=Ext.StoreMgr.get("RedemptionsStore");for(var h=0;h<e.length;h++){e[h]["venue_id"]=d.venue_id;}n.setData(e);}var g=d.winners_count;if(g>=0){console.debug("Prizes won by customers of at this venue this month - ["+g+"]");var f=b.getApplication();var k=f.getController("Merchants");f.dispatch({action:"onUpdateWinnersCount",args:[d],controller:k,scope:k});}}},grouper:{groupFn:function(c){return c.getMerchant().get("name");}},sorters:[{sorterFn:function(e,c){var f=e.getMerchant().get("name"),d=c.getMerchant().get("name");if(f<d){return -1;}if(f>d){return 1;}return 0;}}]});},initMerchantPrizeStore:function(){var a=this;Ext.regStore("MerchantPrizeStore",{model:"Genesis.model.EarnPrize",autoLoad:false,clearOnPageLoad:false,sorters:[{sorterFn:function(c,b){return c.getMerchant().getId()-b.getMerchant().getId();}},{sorterFn:function(c,b){return Date.parse(b.get("expiry_date"))-Date.parse(c.get("expiry_date"));}},{sorterFn:function(c,b){return b.getId()-c.getId();}}],listeners:{scope:this,load:function(d,c,f,b,e){d.loadCallback=[c,b];},metachange:function(c,e,d){var f=a.getApplication();var b=f.getController("client.Rewards");f.dispatch({action:"onMetaChange",args:[c,e.getReader().metaData],controller:b,scope:b});}}});},onItemSelect:function(f,b,c){f.deselect([b],false);console.log("Controller=["+b.data.pageCntlr+"]");var a=this.getApplication().getController(b.get("pageCntlr"));var e=a.isOpenAllowed();if(e===true){if(b.get("subFeature")){a.openPage(b.get("subFeature"));}else{a.openMainPage();}}else{Ext.device.Notification.show({title:"Error",message:e});}return false;},onItemTouchStart:function(g,a,f,c,b){},onItemTouchEnd:function(g,a,f,c,b){},onActivate:function(b,a){this.getInfoBtn()[(merchantMode)?"hide":"show"]();},onDeactivate:function(b,a){this.getInfoBtn().hide();},onLoginActivate:function(b,a){this.getInfoBtn().hide();},onLoginDeactivate:function(b,a){},onLogoutTap:function(k,d,f,l){var g=this.getViewport();var n=this.getViewPortCntlr();var j=window.localStorage;var a=window.localStorage;var h=0;var m=function(){console.log("Resetting Session information ...");g.setFadeAnimation();n.setLoggedIn(false);j.removeItem("auth_code");if(a.getItem("currFbId")>0){Genesis.constants.facebook_onLogout(null,true);}n.onFeatureTap("MainPage","login");};var c=function(){if(j.getItem("auth_code")){console.log("Logging out ...");Customer.setLogoutUrl(j.getItem("auth_code"));Ext.StoreMgr.get("CustomerStore").load({jsonData:{},callback:function(e,b){if(b.wasSuccessful()){console.log("Logout Successful!");}else{console.log("Logout Failed!");}}});}m();};k.parent.onAfter({hiddenchange:function(){if((h|=1)==17){c();}},single:true});k.parent.hide();if(a.getItem("currFbId")>0){console.log("Logging out of Facebook ...");Genesis.constants.facebook_onLogout(function(){if((h|=16)==17){c();}});}else{console.log("No Login info found from Facebook ...");if((h|=16)==17){c();}}},onFacebookTap:function(a,f,c,d){Genesis.constants.facebook_onLogin(function(b){console.log("Logging into Kickbak using Facebook account ...");Customer.setFbLoginUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:b});},true);},onCreateAccountTap:function(a,f,c,d){this.pushView(this.getCreateAccount());},onSignInTap:function(a,f,c,d){this.pushView(this.getSignin());},onCreateAccountSubmit:function(l,j,k,o){var h=this.getCreateAccount();var q=h.getValues();var g=Ext.create("Genesis.model.frontend.Account",q);var a=g.validate();var c=window.localStorage;var f=c.getItem("fbResponse")||null;if(!a.isValid()){var n=a.first();var m=Ext.ComponentQuery.query("field[name="+n.getField()+"]")[0].getLabel();var r=m+" "+n.getMessage()+Genesis.constants.addCRLF()+"Please Try Again";console.log(r);Ext.device.Notification.show({title:"Oops",message:r});}else{console.debug("Creating Account ...");var d={name:q.name,email:q.username,password:q.password};if(f){f=Ext.decode(f);var p=f.birthday.split("/");p=p[2]+"-"+p[0]+"-"+p[1];d=Ext.apply(d,{facebook_email:f.email,facebook_id:f.id,facebook_uid:f.username,gender:(f.gender=="male")?"m":"f",birthday:p,photoURL:"http://graph.facebook.com/"+f.id+"/picture?type=square"});}Customer.setCreateAccountUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:{user:Ext.encode(d)}});}},onSignIn:function(c,a){var b={};if(c){b={email:c,password:a};}Customer.setLoginUrl();Ext.StoreMgr.get("CustomerStore").load({params:b,jsonData:{}});},onSignInSubmit:function(g,d,f,k){var l=this.getSignin();var m=l.getValues();var c=Ext.create("Genesis.model.frontend.Signin",m);var a=c.validate();if(!a.isValid()){var j=a.first();var h=Ext.ComponentQuery.query("field[name="+j.getField()+"]")[0].getLabel();Ext.device.Notification.show({title:"Oops",message:signInFailMsg(h+" "+j.getMessage())});}else{this.onSignIn(m.username,m.password);}},onCreateActivate:function(f,b){var e=window.localStorage;var a=e.getItem("fbResponse")||null;if(a){a=Ext.decode(a);var d=this.getCreateAccount();d.setValues({name:a.name,username:a.email});}},onCreateDeactivate:function(b,a){},openPage:function(a){switch(a){case"main":this.pushView(this.getMainPage());break;case"merchant":var c=this.getApplication();var b=c.getController("Merchants");c.dispatch({action:"onGotoCheckedInAccountTap",args:[null,null,null,null,true],controller:b,scope:b});break;case"login":this.pushView(this.getLogin());break;}},getMainPage:function(){return this.getMain();},openMainPage:function(){var a=this.getViewPortCntlr();this.pushView(this.getMainPage());console.log("MainPage Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.Rewards",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{serverRewards_path:"/serverRewards"},xtype:"serverRewardsCntlr",models:["PurchaseReward","CustomerReward"],config:{refs:{backButton:"viewportview button[text=Close]",rewards:{selector:"serverrewardsview",autoCreate:true,xtype:"serverrewardsview"},rewardsContainer:"serverrewardsview container[tag=rewards]",price:"serverrewardsview textfield",qrcode:"serverrewardsview component[tag=qrcode]",infoBtn:"viewportview button[tag=info]"},control:{rewards:{activate:"onActivate",deactivate:"onDeactivate"},rewardsContainer:{activeitemchange:"onContainerActivate"},"serverrewardsview container[tag=dialpad] button":{tap:"onCalcBtnTap"},"serverrewardsview container[tag=rewardsMainCalculator] button[tag=showQrCode]":{tap:"onShowQrCodeTap"},"serverrewardsview container[tag=qrcodeContainer] button[tag=done]":{tap:"onDoneTap"}}},invalidPriceMsg:"Please enter a valid price",init:function(){console.log("Server Rewards Init");},getPricePrecision:function(b){var a=b.split(".");return((a.length>1)?a[1].length:0);},onActivate:function(h,f,b,d){var a=this.getRewardsContainer();if(a){var g=a.getActiveItem();var e=a.getLayout().getAnimation();e.disable();switch(g.config.tag){case"qrcodeContainer":this.onToggleBtnTap(null,null,null,null);break;default:break;}e.enable();}},onDeactivate:function(e,d,a,b){},onToggleBtnTap:function(a,g,d,f){var c=this.getRewardsContainer();var h=c.getActiveItem();switch(h.config.tag){case"rewardsMainCalculator":c.setActiveItem(1);break;case"qrcodeContainer":c.setActiveItem(0);break;}return true;},onContainerActivate:function(h,g,b,d){var e=this;var a=e.getRewardsContainer();var f=a.getLayout().getAnimation();switch(g.config.tag){case"rewardsMainCalculator":f.setReverse(true);break;case"qrcodeContainer":f.setReverse(false);break;}},onShowQrCodeTap:function(n,k,l,o){var m=this;var a=m.getRewardsContainer();var g=m.getPrice().getValue();var f=this.getPricePrecision(g);if(f<2){Ext.device.Notification.show({title:"Validation Error",message:m.invalidPriceMsg});return;}var j=CryptoJS.enc.Hex.parse(m.getPrivKey());var d=CryptoJS.enc.Hex.parse(Math.random().toFixed(20).toString().split(".")[1]);var c=new Date().addDays(1).format("Y-M-d");var h=d+"$"+CryptoJS.AES.encrypt(Ext.encode({":expirydate":c,":amount":g}),j,{iv:d});console.log("Encripted Code :\n"+h);console.log("Encripted Code Length: "+h.length);var p=m.genQRCode(h);m.getQrcode().setStyle({"background-image":"url("+p+")"});a.setActiveItem(1);},onCalcBtnTap:function(h,f,g,j){Ext.get("clickSound").dom.cloneNode(true).play();var l=h.getText();var k=this.getPrice();var d=Number(k.getValue()||0);var c=this.getPricePrecision(k.getValue());switch(l){case".":this.enablePrecision=true;if(c==0){var a=d.toString().split(".");d=a[0]+".";}break;case"AC":this.enablePrecision=false;d=null;break;default:if(this.enablePrecision){if(c<2){d+=(Number(l)/Math.pow(10,c+1));d=d.toFixed(c+1);}}else{d=(10*d)+Number(l);}break;}k.setValue(d);},onDoneTap:function(a,j,f,h){var g=this;var d=g.getPrice();var c=g.getRewardsContainer();d.setValue(null);g.enablePrecision=false;c.setActiveItem(0);},getMainPage:function(){return this.getRewards();},openPage:function(c){var e;var d=this;var b=d.getViewPortCntlr();var a=function(){d.pushView(e);};switch(c){case"rewards":e=d.getRewards();a();break;}},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.Redemptions",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{serverRedemption_path:"/serverRedemptions"},xtype:"serverRedemptionsCntlr",models:["PurchaseReward","CustomerReward"],config:{refs:{backButton:"viewportview button[text=Close]",redemptions:{selector:"serverredemptionsview",autoCreate:true,xtype:"serverredemptionsview"}},control:{redemptions:{activate:"onActivate",deactivate:"onDeactivate"}}},init:function(){console.log("Server Redemptions Init");},onActivate:function(){},onDeactivate:function(){},onRedeemVerification:function(){var b=this;var a=function(){Ext.device.Notification.show({title:"Error!",message:"Authorization Code is Invalid"});};var c=function(){b.scanQRCode({callback:function(k){var f=CryptoJS.enc.Hex.parse(b.getPrivKey());if(!k){if(Ext.isDefined(k)){var h=CryptoJS.enc.Hex.parse(Math.random().toFixed(20).toString().split(".")[1]);k=h+"$"+CryptoJS.AES.encrypt(Ext.encode({":expirydate":new Date().addDays(1).format("Y-M-d")}),f,{iv:h});}else{return;}}try{console.log("Encrypted Code Length: "+k.length);var j=k.split("$");var g=Ext.decode(CryptoJS.enc.Utf8.stringify((CryptoJS.AES.decrypt(j[1],f,{iv:h}))));var d=g[":expirydate"];if((Date.parse(d)-Date.parse(new Date().format("Y-M-d")))>0){Ext.device.Notification.show({title:"Success!",message:"Authorization Code is Valid"});}else{a();}}catch(l){console.log("Exception reading QR Code - ["+l.message+"]");a();}}});};Ext.device.Notification.show({title:"Redemption Verification",message:"Proceed to scan your customer's Authorization Code",buttons:["OK","Cancel"],callback:function(d){if(d.toLowerCase()=="ok"){console.log("Verifying Authorization Code ...");c();}}});},getMainPage:function(){return this.getRedemptios();},openPage:function(a){switch(a){case"redemptions":this.onRedeemVerification();break;}},isOpenAllowed:function(){return true;}});