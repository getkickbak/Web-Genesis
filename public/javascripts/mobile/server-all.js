Ext.define("Genesis.profile.Iphone",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.is.iPhone;}});Ext.define("Genesis.device.notification.PhoneGap",{override:"Ext.device.notification.PhoneGap",beep:function(b){var a=_application.getController("Viewport");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.beepSound);console.log("Beep "+b+" times.");},vibrate:function(a){navigator.notification.vibrate(a||2000);}});Ext.define("Genesis.profile.Android",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.is.Android;}});Ext.define("Genesis.device.notification.PhoneGap",{override:"Ext.device.notification.PhoneGap",beep:function(b){var a=_application.getController("Viewport");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.beepSound);},vibrate:function(a){navigator.notification.vibrate(a||2000);}});Ext.define("Genesis.profile.Desktop",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.deviceType=="Desktop";}});Ext.define("Genesis.device.notification.Simulator",{override:"Ext.device.notification.Simulator",beep:function(b){var a=_application.getController("Viewport");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.beepSound);console.log("Beep "+b+" times.");}});Ext.define("Genesis.device.notification.Desktop",{override:"Ext.device.notification.Desktop",beep:function(b){var a=_application.getController("Viewport");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.beepSound);console.log("Beep "+b+" times.");}});Ext.define("Genesis.fx.animation.Scroll",{extend:"Ext.fx.animation.Abstract",alternateClassName:"Ext.fx.animation.ScrollIn",alias:["animation.scroll","animation.scrollIn"],config:{direction:"left",out:false,offset:0,easing:"auto",containerBox:"auto",elementBox:"auto",isElementBoxFit:true},reverseDirectionMap:{up:"down",down:"up",left:"right",right:"left"},applyEasing:function(a){if(a==="auto"){return"ease-"+((this.getOut())?"in":"out");}return a;},getData:function(){var e=this.getElement();var l=this.getFrom(),m=this.getTo(),d=this.getOut(),c=this.getOffset(),k=this.getDirection(),f=this.getReverse(),b=0,a=0,j,h,i,g;if(f){k=this.reverseDirectionMap[k];}switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:a=e.getHeight();break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:b=e.getWidth();break;}j=(d)?0:b;h=(d)?0:a;l.set("overflow","hidden");switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:l.set("height",h+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:l.set("width",j+"px");break;}i=(d)?b:0;g=(d)?a:0;m.set("overflow","hidden");switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:m.set("height",g+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:m.set("width",i+"px");break;}return this.callParent(arguments);}});Ext.define("Genesis.view.widgets.ListField",{extend:"Ext.field.Text",alternateClassName:"Genesis.field.List",xtype:"listfield",config:{ui:"list",component:{useMask:false},clearIcon:true,iconCls:"",readOnly:false},initialize:function(){var b=this,a=b.getComponent();b.callParent();if(b.getIconCls()){Ext.fly(b.element.query("."+Ext.baseCSSPrefix.trim()+"component-outer")[0]).addCls(b.getIconCls());}a.setReadOnly(true);},doClearIconTap:Ext.emptyFn});Ext.define("Genesis.view.widgets.ComponentListItem",{extend:"Ext.dataview.element.List",config:{maxItemCache:20},initialize:function(){this.callParent();this.doInitialize();this.itemCache=[];},getItemElementConfig:function(e,h){var f=this,c=f.dataview,g=c.getItemCls(),b=f.itemClsShortCache,d,a;if(g){b+=" "+g;}d={cls:b,children:[{cls:f.labelClsShortCache,}]};if(c.getIcon()){a=h.iconSrc;d.children.push({cls:f.iconClsShortCache,style:"background-image: "+a?'url("'+newSrc+'")':""});}return d;},moveItemsToCache:function(k,l){var j=this,d=j.dataview,b=d.getMaxItemCache(),h=j.getViewItems(),g=j.itemCache,f=g.length,n=d.getPressedCls(),e=d.getSelectedCls(),c=l-k,o;for(;c>=0;c--){o=Ext.get(h[k+c]);var m=o.down(j.labelClsCache,true);var a=Ext.getCmp(m.childNodes[0].id);if(f!==b){o.removeCls([n,e]);g.push(a);f++;}else{Ext.Array.remove(j.itemCache,a);a.destroy();}o.dom.parentNode.removeChild(o.dom);}if(j.getViewItems().length==0){this.dataview.showEmptyText();}},moveItemsFromCache:function(b){var l=this,e=l.dataview,m=e.getStore(),k=b.length;var a=e.getDefaultType(),h=e.getItemConfig();var g=l.itemCache,f=g.length,j=[],c,n,d;if(k){e.hideEmptyText();}for(c=0;c<k;c++){b[c]._tmpIndex=m.indexOf(b[c]);}Ext.Array.sort(b,function(o,i){return o._tmpIndex>i._tmpIndex?1:-1;});for(c=0;c<k;c++){d=b[c];if(f){f--;n=g.pop();l.updateListItem(d,n);}l.addListItem(d._tmpIndex,d,n);delete d._tmpIndex;}return j;},addListItem:function(f,d,m){var j=this,e=j.dataview,b=e.prepareData(d.getData(true),e.getStore().indexOf(d),d);var c=j.element,l=c.dom.childNodes,i=l.length,h;h=Ext.Element.create(this.getItemElementConfig(f,b));var a=e.getDefaultType(),g=e.getItemConfig();if(!i||f==i){h.appendTo(c);}else{h.insertBefore(l[f]);}var k=h.down(j.labelClsCache,true);if(!m){m=new Ext.widget(a,{xtype:a,record:d,dataview:e,itemCls:e.getItemCls(),defaults:g,renderTo:k});}else{m.element.appendTo(k);}},updateListItem:function(b,c){if(c.isComponent&&c.updateRecord){c.updateRecord(b);}else{var d=Ext.fly(c).down(this.labelClsCache,true);var a=Ext.getCmp(d.childNodes[0].id);a.updateRecord(b);}},destroy:function(){var d=this.getViewItems(),c=d.length,b=0,a=this.itemCache.length;for(;b<a;b++){this.itemCache[b].destroy();this.itemCache[b]=null;}delete this.itemCache;for(b=0;b<c;b++){Ext.removeNode(d[b]);}this.callParent();}});Ext.define("Genesis.view.widgets.ComponentList",{alternateClassName:"Genesis.ComponentList",extend:"Ext.dataview.List",xtype:"componentlist",requires:["Genesis.view.widgets.ComponentListItem"],initialize:function(){var b=this,a;b.on(b.getTriggerCtEvent(),b.onContainerTrigger,b);a=b.container=this.add(new Genesis.view.widgets.ComponentListItem({baseCls:this.getBaseCls()}));a.dataview=b;b.on(b.getTriggerEvent(),b.onItemTrigger,b);a.element.on({delegate:"."+this.getBaseCls()+"-disclosure",tap:"handleItemDisclosure",scope:b});a.on({itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd",itemtap:"onItemTap",itemtaphold:"onItemTapHold",itemtouchmove:"onItemTouchMove",itemsingletap:"onItemSingleTap",itemdoubletap:"onItemDoubleTap",itemswipe:"onItemSwipe",scope:b});if(this.getStore()){this.refresh();}}});Ext.define("Genesis.view.widgets.RewardItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.Button","Ext.XTemplate"],xtype:"rewarditem",alias:"widget.rewarditem",config:{background:{cls:"rewardItem",tag:"rewardItem",layout:{type:"vbox",pack:"center",align:"stretch"},items:[{docked:"top",xtype:"component",tag:"title",cls:"title",margin:"0 0 0.8 0",defaultUnit:"em",tpl:Ext.create("Ext.XTemplate","{[this.getDescription(values)]}",{getDescription:function(a){return a.title;}})},{xtype:"component",height:210,flex:1,tag:"itemPhoto",cls:"itemPhoto",tpl:Ext.create("Ext.XTemplate",'<div class="itemPoints">{[this.getPoints(values)]}</div>',{getPoints:function(a){return((a.points>0)?a.points+"  Pts":"");}})},{docked:"bottom",xtype:"component",tag:"info",cls:"info",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="infoWrapper"><div class="name">{[this.getName(values)]}</div><div class="disclaimer">{[this.getDisclaimer(values)]}</div><div class="date">{[this.getExpiryDate(values)]}</div></div>',{getExpiryDate:function(a){var b=a.expiry_date;return((!b)?"":"Offer Expires "+b);},getDisclaimer:function(a){return a.Merchant.prize_terms||"Not valid with any other offer. No cash value. One coupon per customer per visit. Void where prohibited. Good at participating stores only.";},getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_small"].url;},getName:function(a){return a.Merchant.name;}})}]},dataMap:{getBackground:{setData:"background"}},listeners:{painted:function(d,b){var a=Ext.ComponentQuery.query("viewportview")[0].getActiveItem().renderElement.getHeight();}}},applyBackground:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBackground());},updateBackground:function(a,b){if(a){this.add(a);}if(b){this.remove(b);}},setDataBackground:function(c){var e=c.CustomerReward;var a=Genesis.view.Prizes.getPhoto(e.type)||e.photo["thumbnail_ios_medium"];var d=this.query("component[tag=info]")[0];var b=this.query("component[tag=itemPhoto]")[0];if(c.Merchant){d.setData(c);d.show();}else{d.hide();}this.query("component[tag=title]")[0].setData(e);b.element.setStyle((Ext.isString(a))?{"background-image":"url("+a+")","background-size":""}:{"background-image":"url("+a.url+")","background-size":(a.width)?Genesis.fn.addUnit(a.width)+" "+Genesis.fn.addUnit(a.height):""});b.setData((!c.expiry_date||(c.expiry_date=="N/A"))?e:{points:null});},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),k=e.first(),i=h.getDataMap(),f,j,g,a;if(!k){return;}for(f in i){g=i[f];j=h[f]();if(j){for(a in g){if(j[a]){switch(g[a]){case"background":h.setDataBackground(b);break;default:j[a](b[g[a]]);break;}}}}}k.updateData(b);}});Ext.define("Genesis.model.frontend.MainPage",{extend:"Ext.data.Model",id:"MainPage",config:{fields:["name","photo_url","desc","pageCntlr","subFeature","hide"],proxy:{reader:{type:"json",messageProperty:"message",rootProperty:"data"},type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/"+((!merchantMode)?"mainClientPage.json":"mainServerPage.json")}}});Ext.define("Genesis.model.UserProfile",{extend:"Ext.data.Model",alternateClassName:"UserProfile",id:"UserProfile",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"}],fields:["gender","birthday","zipcode","created_ts","update_ts","user_id"]},getUser:function(){}});Ext.define("Genesis.model.User",{extend:"Ext.data.Model",requires:["Genesis.model.UserProfile"],alternateClassName:"User",id:"User",config:{hasOne:[{model:"Genesis.model.UserProfile",associationKey:"profile"}],proxy:{type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/users.json",reader:{type:"json"}},fields:["user_id","name","email","facebook_id","photo_url","created_ts","update_ts","profile_id"],idProperty:"user_id"}});Ext.define("Genesis.model.Merchant",{extend:"Ext.data.Model",alternateClassName:"Merchant",id:"Merchant",config:{fields:["id","name","email","photo","alt_photo","account_first_name","account_last_name","phone","auth_code","qr_code","payment_account_id","created_ts","update_ts","type"],idProperty:"id"}});Ext.define("Genesis.model.Challenge",{extend:"Ext.data.Model",id:"Challenge",alternateClassName:"Challenge",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],fields:["id","type","name","description","require_verif","data","points","created_ts","update_ts","photo","merchant_id","venue_id"],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetChallengesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/challenges":Ext.Loader.getPath("Genesis")+"/store/challenges.json");},setCompleteChallengeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/"+a+"/complete");},setCompleteReferralChallengeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/complete_referral");},setSendReferralsUrl:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/"+a+"/start");}}});Ext.define("Genesis.model.Checkin",{extend:"Ext.data.Model",alternateClassName:"Checkin",id:"Checkin",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"},{model:"Genesis.model.Venue",getterName:"getVenue",setterName:"setVenue"}],fields:["id","time"]}});Ext.define("Genesis.model.PurchaseReward",{extend:"Ext.data.Model",id:"PurchaseReward",alternateClassName:"PurchaseReward",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["id","title","points","type","photo","created_ts","update_ts","qty"]},getMerchant:function(){},statics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/purchase_rewards":Ext.Loader.getPath("Genesis")+"/store/rewards.json");}}});Ext.define("Genesis.model.CustomerReward",{extend:"Ext.data.Model",id:"CustomerReward",alternateClassName:"CustomerReward",config:{fields:["id","title","points","type","photo"],idProperty:"id",belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetRedemptionsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/customer_rewards":Ext.Loader.getPath("Genesis")+"/store/redemptions.json");},setRedeemPointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customer_rewards/"+a+"/redeem");}}});Ext.define("Genesis.model.EarnPrize",{extend:"Ext.data.Model",id:"EarnPrize",alternateClassName:"EarnPrize",config:{fields:["id",{name:"expiry_date",type:"date",convert:function(a,b){var a=Date.parse(a,"yyyy-MM-dd");return(!a)?"N/A":Genesis.fn.convertDateNoTimeNoWeek.apply(this,arguments);}}],idProperty:"id",belongsTo:[{model:"Genesis.model.CustomerReward",associationKey:"reward",getterName:"getCustomerReward",setterName:"setCustomerReward"},{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"},{model:"Genesis.model.User",associationKey:"user",getterName:"getUser",setterName:"setUser"}],proxy:{type:"ajax",disableCaching:false,actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getUser:function(){},statics:{setEarnPrizeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/purchase_rewards/earn");},setRedeemPrizeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/earn_prizes/"+a+"/redeem");}}});Ext.define("Genesis.model.Venue",{extend:"Ext.data.Model",requires:["Genesis.model.Challenge","Genesis.model.PurchaseReward","Genesis.model.CustomerReward"],alternateClassName:"Venue",id:"Venue",config:{fields:["id","name","address","description","distance","city","state","country","zipcode","phone","website","latitude","longitude","created_ts","update_ts","type","merchant_id","sort_id","winners_count"],belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"}],hasMany:[{model:"Genesis.model.Challenge",name:"challenges"},{model:"Genesis.model.PurchaseReward",name:"purchaseReward"},{model:"Genesis.model.CustomerReward",name:"customerReward"}],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}},idProperty:"id",},statics:{setFindNearestURL:function(){this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_nearest":Ext.Loader.getPath("Genesis")+"/store/checkinRecords.json");},setGetClosestVenueURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_closest":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setSharePhotoURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/share_photo":Ext.Loader.getPath("Genesis")+"/store/sharePhoto.json");}}});Ext.define("Genesis.model.EligibleReward",{extend:"Ext.data.Model",id:"EligibleReward",alternateClassName:"EligibleReward",config:{idProperty:"id",fields:["id","reward_id","reward_title","reward_text","reward_type","photo"]}});Ext.define("Genesis.model.Customer",{extend:"Ext.data.Model",requires:["Genesis.model.Checkin"],alternateClassName:"Customer",id:"Customer",config:{belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"},{model:"Genesis.model.User",associationKey:"user",getterName:"getUser",setterName:"setUser"}],hasOne:{model:"Genesis.model.Checkin",associationKey:"last_check_in",getterName:"getLastCheckin",setterName:"setLastCheckin"},proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["points","visits","id"],idProperty:"id"},getUser:function(){},statics:{isValidCustomer:function(a){return a!=0;},updateCustomer:function(f,a){var c;for(var b=0;b<f.fields.length;b++){c=f.fields.items[b].getName();f.set(c,a.get(c));}try{f.setLastCheckin(a.getLastCheckin());}catch(d){f.setLastCheckin(Ext.create("Genesis.model.Checkin"));}},setFbLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens/create_from_facebook":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setUpdateFbLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/account/update_facebook_info");},setLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setLogoutUrl:function(a){this.getProxy().setActionMethods({read:"DELETE"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/tokens/"+a);},setCreateAccountUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/sign_up":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setVenueScanCheckinUrl:function(){this.setVenueCheckinUrl();},setVenueCheckinUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/check_ins":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setVenueExploreUrl:function(a){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/"+a+"/explore":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setSendPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customers/transfer_points");},setRecvPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customers/receive_points");}}});Ext.define("Genesis.model.frontend.Account",{extend:"Ext.data.Model",alternateClassName:"Account",id:"Account",config:{fields:["name","username","password"],validations:[{type:"format",field:"name",matcher:/^([a-zA-Z'-]+\s+){1,4}[a-zA-z'-]+$/},{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.model.frontend.Signin",{extend:"Ext.data.Model",alternateClassName:"Signin",id:"Sigin",config:{fields:["username","password"],validations:[{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.view.ViewBase",{extend:"Ext.Container",xtype:"viewbase",config:{preRender:null},initialize:function(){this.callParent(arguments);this.setPreRender([]);},createView:function(){return(this.getPreRender().length==0);},showView:function(){this.add(this.getPreRender());}});Ext.define("Genesis.view.Viewport",{extend:"Ext.Container",requires:["Ext.fx.layout.Card"],xtype:"viewportview",config:{autoDestroy:false,cls:"viewport",layout:{type:"card",animation:{type:"slide",reverse:false,direction:"left"}},fullscreen:true},initialize:function(){this.callParent(arguments);},animateActiveItem:function(f,e){var c=this.getLayout(),b;var a=this.getActiveItem();if(this.activeItemAnimation){this.activeItemAnimation.destroy();}this.activeItemAnimation=e=new Ext.fx.layout.Card(e);if(e&&c.isCard){e.setLayout(c);b=c.getAnimation();if(b){b.disable();e.on("animationend",function(){b.enable();e.destroy();if(a){Ext.defer(function(){a.destroy();console.debug("Destroyed View ["+a._itemId+"]");},0.1*1000,this);}f.showView();},this);}}var d=this.setActiveItem(f);if(!c.isCard){Ext.defer(f.showView,1,f);}return d;},});Ext.define("Genesis.view.MainPage",{extend:"Ext.Carousel",requires:["Ext.dataview.DataView","Ext.XTemplate"],alias:"widget.mainpageview",config:{preRender:null,direction:"horizontal",items:(function(){var a=[{xtype:"titlebar",docked:"top",cls:"navigationBarTop kbTitle",title:" ",defaults:{iconMask:true},items:[{align:"right",tag:"info",iconCls:"info",destroy:function(){this.actions.destroy();this.callParent(arguments);},handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{defaultUnit:"em",padding:"1em",hideOnMaskTap:false,defaults:{xtype:"button",defaultUnit:"em"},items:[{margin:"0 0 0.5 0",text:"Logout",tag:"logout"},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",scope:this,handler:function(){this.actions.hide();}}]});Ext.Viewport.add(this.actions);}this.actions.show();}}]}];if(!merchantMode){a.push({docked:"bottom",cls:"checkInNow",tag:"checkInNow",xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"button",tag:"checkInNow",text:"CheckIn Now!"}]});}return a;}())},initialize:function(){this.setPreRender([]);this.callParent(arguments);},createView:function(){if(!Genesis.view.ViewBase.prototype.createView.apply(this,arguments)){return;}var k=this;var b=_application;var g=b.getController("Viewport");var l=g.getViewport();var j=g.getCheckinInfo().venue!=null;var h=Ext.StoreMgr.get("MainPageStore").getRange();var f=Ext.Array.clone(h);if(!k._listitems){k._listitems=[];}if(!j){Ext.Array.forEach(f,function(n,i,m){switch(n.get("hide")){case"true":Ext.Array.remove(h,n);break;}});}if((Ext.Array.difference(h,k._listitems).length>0)||(h.length!=k._listitems.length)){k._listitems=h;k.removeAll(true);for(var d=0;d<Math.ceil(h.length/6);d++){this.getPreRender().push(Ext.create("Ext.dataview.DataView",{xtype:"dataview",cls:"mainMenuSelections",scrollable:false,deferInitialRefresh:false,store:{model:"Genesis.model.frontend.MainPage",data:Ext.Array.pluck(h.slice(d*6,((d+1)*6)),"data")},itemTpl:Ext.create("Ext.XTemplate",'<div class="mainPageItemWrapper x-hasbadge">',"{[this.getPrizeCount(values)]}",'<div class="photo"><img src="{[this.getPhoto(values.photo_url)]}" /></div>','<div class="photoName">{name}</div>',"</div>",{getType:function(){return values.pageCntlr;},getPrizeCount:function(m){var o=0;var n=m.pageCntlr;var i=Ext.StoreMgr.get("MerchantPrizeStore");if(i){o=i.getCount();}return((n=="Prizes")?'<span class="x-badge round" data="'+n+'" class="'+((o>0)?"":"x-item-hidden")+'">'+o+"</span>":"");},getPhoto:function(i){return Ext.isEmpty(i)?Ext.BLANK_IMAGE_URL:i;}}),autoScroll:true}));}console.log("MainPage Icons Refreshed.");}else{var a=Ext.StoreMgr.get("MerchantPrizeStore");if(a){var e=a.getCount();var c=Ext.DomQuery.select("span[data=Prizes]",k.query("dataview")[0].element.dom)[0];if(e>0){c.innerHTML=e;Ext.fly(c).removeCls("x-item-hidden");}else{if(!c.className.match(/x-item-hidden/)){Ext.fly(c).addCls("x-item-hidden");}}}if(k.getInnerItems().length>0){k.setActiveItem(0);}console.log("MainPage Icons Not changed.");}delete k._listitems;},showView:function(){this.add(this.getPreRender());}});Ext.define("Genesis.view.server.SettingsPage",{extend:"Ext.form.Panel",requires:["Ext.dataview.List","Ext.XTemplate","Genesis.view.widgets.ListField"],alias:"widget.serversettingspageview",config:{scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"titlebar",docked:"top",cls:"navigationBarTop",title:"Settings",defaults:{iconMask:true},items:[{align:"left",tag:"back",ui:"back",text:"Back"}]},{xtype:"fieldset",title:"About Kickbak",items:[{xtype:"textfield",value:"Version 1.0",readOnly:true},{xtype:"listfield",name:"terms",value:"Terms & Conditions"},{xtype:"listfield",name:"privacy",value:"Privacy"},{xtype:"listfield",name:"aboutus",value:"About Us"}]}]},showView:Ext.emptyFn});Ext.define("Genesis.view.server.Rewards",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar","Ext.field.Text"],alias:"widget.serverrewardsview",config:{layout:"fit",items:[{xtype:"titlebar",docked:"top",cls:"navigationBarTop kbTitle",title:" ",defaults:{iconMask:true},items:[{align:"left",tag:"back",ui:"back",text:"Back"}]}]},createView:function(){if(!this.callParent(arguments)){return;}this.getPreRender().push(Ext.create("Ext.Container",{xtype:"container",tag:"rewards",cls:"rewardsServerMain",layout:{type:"card",animation:{duration:600,easing:"ease-in-out",type:"slide",direction:"down"}},activeItem:0,items:[{xtype:"container",tag:"rewardsMainCalculator",cls:"rewardsMainCalculator",layout:"fit",items:[{docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Amount Spent"},{xtype:"spacer",align:"right"}]},{docked:"top",xtype:"textfield",name:"price",clearIcon:false,placeHolder:"0",readOnly:true,required:true,cls:"rewardsCalculator"},{xtype:"container",layout:"vbox",tag:"dialpad",cls:"dialpad",defaults:{xtype:"container",layout:"hbox",flex:1,defaults:{xtype:"button",flex:1}},items:[{items:[{text:"1"},{text:"2"},{text:"3"}]},{items:[{text:"4"},{text:"5"},{text:"6"}]},{items:[{text:"7"},{text:"8"},{text:"9"}]},{items:[{text:"AC"},{text:"0"},{text:"."}]}]},{docked:"bottom",xtype:"button",cls:"separator",tag:"showQrCode",text:"Show QRCode",ui:"orange-large"}]},{xtype:"container",tag:"qrcodeContainer",cls:"qrcodeContainer",layout:"fit",items:[{docked:"top",xtype:"component",tag:"title",width:"100%",cls:"title",defaultUnit:"em",tpl:Ext.create("Ext.XTemplate","{[this.getPrice(values)]}",{getPrice:function(a){return a.price;}})},{xtype:"component",tag:"qrcode",cls:"qrcode"},{docked:"bottom",xtype:"button",cls:"separator done",tag:"done",text:"Done",ui:"orange-large"}]}]}));},statics:{getPhoto:function(a){var b=null;switch(a.value){case"vip":b=Genesis.constants.getIconPath("miscicons",a.value);break;default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.view.server.Redemptions",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar"],alias:"widget.serverredemptionsview",config:{scrollable:"vertical",cls:"redemptionsMain",layout:"vbox"},statics:{getPhoto:function(a){var b=null;switch(a.value){default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.view.Prizes",{extend:"Genesis.view.ViewBase",requires:["Ext.XTemplate","Ext.Carousel","Genesis.view.widgets.RewardItem"],alias:"widget.prizesview",config:{scrollable:undefined,fullscreen:true,cls:"prizesMain",layout:"card",items:[{xtype:"titlebar",docked:"top",cls:"navigationBarTop",title:"Prizes",defaults:{iconMask:true},items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{align:"left",tag:"back",ui:"back",text:"Back"},{align:"right",tag:"redeem",text:"Redeem"}]}]},showView:function(){switch(this.config.tag){case"userPrizes":this.onUserShowView();break;case"merchantPrizes":this.onMerchantShowView();break;}},onUserShowView:function(){var c=this;var a=Ext.StoreMgr.get("MerchantPrizeStore").getRange();if(a.length==0){c.removeAll();c.add({tag:"rewardPanel",cls:"noprizes",xtype:"component",scrollable:false,defaultUnit:"em",margin:"0 0 0.8 0"});console.log("UserPrize View - No Prizes found.");}else{var b=c.getInnerItems()[0];if(b&&b.isXType("carousel",true)){console.log("UserPrize View - do not need to be updated.");}else{c.removeAll();var d=[];b=c.getInnerItems()[0];if(!b){this.add({xtype:"carousel",scrollable:undefined,masked:{xtype:"loadmask",message:"Loading ..."}});b=c.getInnerItems()[0];}for(var e=0;e<a.length;e++){d.push({tag:"rewardPanel",xtype:"dataview",store:{model:"Genesis.model.EarnPrize",autoLoad:false,data:a[e]},useComponents:true,scrollable:false,defaultType:"rewarditem",defaultUnit:"em",margin:"0 0 0.8 0"});}b.add(d);b.setMasked(false);console.log("UserPrize View - Found "+a.length+" Prizes needed to update.");}}},onMerchantShowView:function(){var e=this;var c=_application.getController("Viewport");var h=(c.getVenue())?c.getVenue().getMerchant().getId():0;var d;var b=[];var a=Ext.StoreMgr.get("MerchantPrizeStore").getRange();if(a.length>0){for(var g=0;g<a.length;g++){if(a[g].getMerchant().getId()!=h){continue;}b.push(a[g]);}}if(b.length==0){e.removeAll();e.add({tag:"rewardPanel",cls:"noprizes",xtype:"component",scrollable:false,defaultUnit:"em",margin:"0 0 0.8 0"});console.log("MerchantPrize View - No Prizes found.");}else{var d=e.getInnerItems()[0];if(!d){this.add({xtype:"carousel",scrollable:undefined,masked:{xtype:"loadmask",message:"Loading ..."}});d=e.getInnerItems()[0];}if((d&&d.isXType("carousel",true)&&d.query("dataview")[0]&&d.query("dataview")[0].getStore().first().getMerchant().getId()==h)){console.log("MerchantPrize View - do not need to be updated.");}else{d=e.getInnerItems()[0];var f=[];for(var g=0;g<b.length;g++){f.push({tag:"rewardPanel",xtype:"dataview",store:{model:"Genesis.model.EarnPrize",autoLoad:false,data:b[g]},useComponents:true,scrollable:false,defaultType:"rewarditem",defaultUnit:"em",margin:"0 0 0.8 0"});}d.add(f);d.setMasked(false);console.log("MerchantPrize View - Found "+b.length+" Prizes needed to update.");}}},statics:{getPhoto:function(a){var b=null;switch(a.value){case"earn_points":break;default:b=Genesis.constants.getIconPath("prizewon",a.value);break;}return b;}}});Ext.define("Genesis.view.ShowPrize",{extend:"Genesis.view.ViewBase",requires:["Ext.XTemplate","Ext.Carousel","Genesis.view.widgets.RewardItem"],alias:"widget.showprizeview",config:{scrollable:false,fullscreen:true,cls:"prizesMain",layout:"fit",items:[{xtype:"titlebar",docked:"top",cls:"navigationBarTop",title:"Prizes",defaults:{iconMask:true},items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{align:"left",tag:"back",ui:"back",text:"Back"},{align:"right",tag:"redeem",text:"Redeem"}]},{docked:"bottom",xtype:"button",margin:"0.8 0.7",defaultUnit:"em",tag:"refresh",text:"Refresh",ui:"orange-large"},{docked:"bottom",margin:"0.8 0.7",defaultUnit:"em",xtype:"button",cls:"separator",tag:"verify",text:"Verified!",ui:"orange-large"}]},createView:function(){this.getPreRender().push(Ext.create("Ext.dataview.DataView",{tag:"rewardPanel",xtype:"dataview",store:{model:"Genesis.model.EarnPrize",autoLoad:false,data:this.showPrize},useComponents:true,scrollable:false,defaultType:"rewarditem",defaultUnit:"em",margin:"0 0 0.8 0"}));delete this.showPrize;}});Ext.define("Genesis.controller.ControllerBase",{extend:"Ext.app.Controller",requires:["Ext.data.Store","Ext.util.Geolocation"],config:{animationMode:null},checkinMsg:"Checking in ...",loadingScannerMsg:"Loading Scanner ...",loadingMsg:"Loading ...",genQRCodeMsg:"Generating QRCode ...",retrieveAuthModeMsg:"Retrieving Authorization Code from Server ...",noCodeScannedMsg:"No Authorization Code was Scanned!",geoLocationErrorMsg:"Cannot locate your current location. Try again or enable permission to do so!",geoLocationTimeoutErrorMsg:"Cannot locate your current location. Try again or enable permission to do so!",geoLocationPermissionErrorMsg:"No permission to location current location. Please enable permission to do so!",missingVenueInfoMsg:"Error loading Venue information.",showToServerMsg:"Show this to your server before proceeding.",errProcQRCodeMsg:"Error Processing Authentication Code",cameraAccessMsg:"Accessing your Camera Phone ...",updatingServerMsg:"Updating Server ...",referredByFriendsMsg:function(a){return"Have you been referred "+Genesis.constants.addCRLF()+"by a friend to visit"+Genesis.constants.addCRLF()+a+"?";},recvReferralb4VisitMsg:function(a){return"Claim your reward points by becoming a customer at "+Genesis.constants.addCRLF()+a+"!";},showScreenTimeoutExpireMsg:function(a){return a+" are up! Press OK to confirm.";},showScreenTimeoutMsg:function(a){return"You have "+a+" to show this screen to a employee before it disappears!";},uploadFbMsg:"Uploading to Facebook ...",uploadServerMsg:"Uploading to server ...",statics:{animationMode:{slide:{type:"slide",direction:"left"},slideUp:{type:"slide",direction:"up"},flip:{type:"flip"},fade:{type:"fade"}},playSoundFile:function(b,a,c){if(Genesis.constants.isNative()){switch(b.type){case"FX":case"Audio":LowLatencyAudio.play(b.name,a||Ext.emptyFn,c||Ext.emptyFn);break;case"Media":b.successCallback=a||Ext.emptyFn;b.name.play();break;}}else{b.successCallback=a||Ext.emptyFn;Ext.get(b.name).dom.play();}},stopSoundFile:function(a){if(Genesis.constants.isNative()){LowLatencyAudio.stop(a.name);}else{var b=Ext.get(a.name).dom;b.pause();b.currentTime=0;}},genQRCodeFromParams:function(i,b){var f=this;var g;var a=function(){return Math.random().toFixed(16);};GibberishAES.size(256);var d=Genesis.constants.getPrivKey();var c;for(key in d){try{c=new Date().addHours(3);g=GibberishAES.enc(Ext.encode(Ext.applyIf({expiry_ts:c.getTime()},i)),d[key]);}catch(h){}break;}console.log("\nEncrypted Code Length: "+g.length+"\nEncrypted Code ["+g+"]\nExpiry Date: ["+c+"]");return(b)?[g,0,0]:f.genQRCode(g);},genQRCode:function(e,c,f){c=c||4;f=f||8;var d=0;var b=QRCode(f,"L");b.addData(e);b.make();var a=b.createBase64(c,d);console.log("QR Code Minimum Size = ["+a[1]+"x"+a[1]+"]");return[a[0],a[1],a[1]];},genQRCodeInlineImg:function(e,c,f){c=c||4;f=f||8;var d=0;var a=QRCode(f,"L");a.addData(e);a.make();var b=a.createTableTag(c,d);return b;}},init:function(){this.callParent(arguments);this.on({scope:this,scannedqrcode:this.onScannedQRcode,locationupdate:this.onLocationUpdate,openpage:this.onOpenPage});this.setAnimationMode(this.self.superclass.self.animationMode.slide);var a=this.getViewPortCntlr();if(a!=this){a.relayEvents(this,["pushview","popview"]);a.on("animationCompleted",this.onAnimationCompleted,this);}},getViewPortCntlr:function(){return this.getApplication().getController("Viewport");},getViewport:function(){return this.getViewPortCntlr().getView();},getMainPage:Ext.emptyFn,openMainPage:Ext.emptyFn,openPage:Ext.emptyFn,goToMain:function(){var b=this;var a=b.getViewPortCntlr();a.setLoggedIn(true);b.resetView();b.fireEvent("openpage","MainPage","main",null);console.log("LoggedIn, Going back to Main Page ...");},isOpenAllowed:function(){return"Cannot Open Folder";},onScannedQRcode:Ext.emptyFn,onLocationUpdate:Ext.emptyFn,onOpenPage:function(e,b,a,d,f){if((appName=="GetKickBak")&&!Ext.device.Connection.isOnline()&&(b!="login")){Ext.device.Notification.show({title:"Network Error",message:"You have lost internet connectivity"});return;}var g=this.getApplication();var c=g.getController(e);g.dispatch({action:(!b)?"openMainPage":"openPage",args:(!b)?[]:[b,a],controller:c,scope:c});},updateRewards:function(b){var i=this;try{var c=b.rewards;if(c){var h=i.getViewPortCntlr();var d=b.venue_id||h.getVenue().getId();console.debug("Total Redemption Rewards - "+c.length);var j=Ext.StoreMgr.get("RedemptionsStore");j.setData(c);}var a=b.eligible_rewards;if(a){console.debug("Total Eligible Rewards - "+a.length);var k=Ext.StoreMgr.get("EligibleRewardsStore");k.setData(a);}var f=b.winners_count;if(f>=0){console.debug("Prizes won by customers at this merchant this month - ["+f+"]");h.getVenue().set("winners_count",f);}var l=b.data;if(l){i.fireEvent("authcoderecv",b);}}catch(g){console.debug("updateRewards Exception - "+g);}},checkReferralPrompt:function(b,c){var d=this;var a=d.getViewPortCntlr();b=b||Ext.emptyFn;c=c||Ext.emptyFn;var e=a.getVenue().getMerchant().getId();if((a.getCheckinInfo().customer.get("visits")==0)&&(!Genesis.db.getReferralDBAttrib("m"+e))){Ext.device.Notification.show({title:"Referral Challenge",message:d.referredByFriendsMsg(a.getVenue().getMerchant().get("name")),buttons:["Yes","No"],callback:function(f){if(f.toLowerCase()=="yes"){d.fireEvent("openpage","client.Challenges","referrals",b);}else{c();}}});}else{c();}},resetView:function(a){this.fireEvent("resetview");},pushView:function(a){this.fireEvent("pushview",a,this.getAnimationMode());},silentPopView:function(a){this.fireEvent("silentpopview",a);},popView:function(){this.fireEvent("popview");},getGeoLocation:function(a){var b=this;a=a||0;console.debug("Getting GeoLocation ...");if(!Genesis.constants.isNative()){b.fireEvent("locationupdate",{coords:{getLatitude:function(){return"-50.000000";},getLongitude:function(){return"50.000000";}}});}else{console.debug("Connection type: ["+Ext.device.Connection.getType()+"]");if(!b.geoLocation){b.geoLocation=Ext.create("Ext.util.Geolocation",{autoUpdate:false,frequency:1,maximumAge:30000,timeout:50000,allowHighAccuracy:true,listeners:{locationupdate:function(e,d){if(!e){console.log("No GeoLocation found!");return;}var c={coords:e};console.debug("\nLatitude: "+e.getLatitude()+"\nLongitude: "+e.getLongitude()+"\nAltitude: "+e.getAltitude()+"\nAccuracy: "+e.getAccuracy()+"\nAltitude Accuracy: "+e.getAltitudeAccuracy()+"\nHeading: "+e.getHeading()+"\nSpeed: "+e.getSpeed()+"\nTimestamp: "+new Date(e.getTimestamp())+"\n");b.fireEvent("locationupdate",c);},locationerror:function(g,c,d,f,e){console.debug("GeoLocation Error["+e+"]");Ext.Viewport.setMasked(false);if(d){console.debug("PERMISSION_DENIED");Ext.device.Notification.show({title:"Permission Error",message:b.geoLocationPermissionErrorMsg});}else{if(f){console.debug("POSITION_UNAVAILABLE");if(++a<=5){Ext.Function.defer(b.getGeoLocation,1*1000,b,[callback,a]);console.debug("Retry getting current location("+a+") ...");}else{Ext.device.Notification.show({title:"Error",message:b.geoLocationErrorMsg});}}else{if(c){console.debug("TIMEOUT");Ext.device.Notification.show({title:"Timeout Error",message:b.geoLocationTimeoutErrorMsg});}}}}}});}b.geoLocation.updateLocation();}},scanQRCode:function(){var b=this;var a=function(f){Ext.Viewport.setMasked(false);config.callback();console.debug("Failed because: "+f);};var e=function(f){var g;Ext.Viewport.setMasked(false);if(Genesis.constants.isNative()){switch(window.plugins.qrCodeReader.scanType){case"RL":g=(f.response=="undefined")?"":(f.response||"");console.debug("QR Code RL  = "+g);break;case"Nigma":g=(f.response=="undefined")?"":(f.response||"");if(!g){console.debug("QR Code Nigma = Empty");}else{console.debug("QR Code Nigma = "+((g.responseCode)?g.responseCode:"NONE")+" Sent = "+g.bytesSent+" bytes");}if(g&&g.responseCode){g=g.responseCode;}break;case"Default":g=f;if(!g||g.format!="QR_CODE"){g=null;console.debug("QR Code Default = Unsupported Code");if(device.platform.match(/simulator/i)){g=Math.random().toFixed(16);}}else{if(g.cancelled){g=Math.random().toFixed(16);}else{g=g.text;}}console.debug("QR Code Default = "+((g)?g:"NONE"));break;}}else{g=f.response;console.debug("QR Code = "+g);}b.fireEvent("scannedqrcode",g);};console.debug("Scanning QR Code ...");if(!Genesis.constants.isNative()){var d=0;if(!merchantMode){var c=Ext.StoreMgr.get("CheckinExploreStore").first()||b.getViewPortCntlr().getVenue()||null;d=c?c.getId():0;}e({response:d});}else{Ext.Viewport.setMasked({xtype:"loadmask",message:b.loadingScannerMsg});window.plugins.qrCodeReader.getCode(e,a);}}});var _application;Ext.define("Genesis.controller.Viewport",{extend:"Genesis.controller.ControllerBase",requires:["Ext.util.DelayedTask"],statics:{},config:{sound_files:null,loggedIn:false,customer:null,venue:null,metaData:null,checkinInfo:{venue:null,customer:null,metaData:null},refs:{view:"viewportview",backButton:"button[tag=back]",closeButton:"button[tag=close]",shareBtn:"button[tag=shareBtn]",emailShareBtn:"actionsheet button[tag=emailShareBtn]",fbShareBtn:"actionsheet button[tag=fbShareBtn]",checkInNowBtn:"button[tag=checkInNow]"},control:{fbShareBtn:{tap:"onShareMerchantTap"},emailShareBtn:{tap:"onShareEmailTap"},backButton:{tap:"onBackButtonTap"},closeButton:{tap:"onBackButtonTap"},checkInNowBtn:{tap:"onCheckinScanTap"},"tabbar[cls=navigationBarBottom] button[tag=info]":{tap:"onInfoTap"},"tabbar[cls=navigationBarBottom] button[tag=home]":{tap:"onHomeButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=prizes]":{tap:"onPrizesButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=accounts]":{tap:"onAccountsButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=challenges]":{tap:"onChallengesButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=rewards]":{tap:"onRewardsButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=redemption]":{tap:"onRedemptionsButtonTap"},"viewportview button":{tap:"onButtonTap"},"actionsheet button":{tap:"onButtonTap"}},listeners:{viewanimend:"onViewAnimEnd",baranimend:{buffer:0.5*1000,fn:"onBarAnimEnd"},pushview:"pushView",silentpopview:"silentPopView",popview:"popView",resetview:"resetView"}},viewStack:[],animationFlag:0,gatherCheckinInfoMsg:"Gathering Checkin information ...",retrieveChallengesMsg:"Retrieving Challenges ...",fbShareSuccessMsg:"Posted on your Timeline!",shareReqMsg:function(){return"Would you like to do our"+Genesis.constants.addCRLF()+"Referral Challenge?";},onLocationUpdate:function(a){var c=this;var e=c.getApplication();var b=e.getController("Checkins");var d=Ext.StoreMgr.get("CheckinExploreStore");Venue.setFindNearestURL();d.load({params:{latitude:a.coords.getLatitude(),longitude:a.coords.getLongitude()},callback:function(g,f){if(f.wasSuccessful()){b.setPosition(a);e.dispatch({action:"onCheckinScanTap",controller:b,args:[],scope:b});}else{Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:c.missingVenueInfoMsg});}},scope:c});},onButtonTap:function(a,d,c){Genesis.controller.ControllerBase.playSoundFile(this.sound_files.clickSound);},onBackButtonTap:function(a,d,c){this.popView();},onShareEmailTap:function(a,g,c,f){var d=this;Ext.device.Notification.show({title:"Referral Challenge",message:d.shareReqMsg(),buttons:["Yes","No"],callback:function(b){if(b.toLowerCase()=="yes"){var e=d.getApplication();d.onChallengesButtonTap(null,null,null,null,function(){var n=d.getViewPortCntlr().getVenue();var m=n.getId();var j=n.challenges().getRange();var h=e.getController("client.Challenges");var l=h.getReferralsPage().query("list")[0];for(var k=0;k<j.length;k++){if(j[k].get("type").value=="referral"){h.selectedItem=j[k];break;}}e.dispatch({action:"onReferralsSelect",args:[l,l.getStore().getRange()[1]],controller:h,scope:h});});}}});},onShareMerchantTap:function(a,h,d,g){var f=this;var c=Genesis.constants.site;Genesis.fb.facebook_onLogin(function(i){var e=f.getVenue();var b=e.getMerchant();console.log("Posting to Facebook ...");FB.api("/me/feed","post",{name:e.get("name"),link:e.get("website")||c,caption:e.get("website")||c,description:e.get("description"),picture:b.get("photo")["thumbnail_ios_medium"].url,message:"Check out this place!"},function(j){Ext.Viewport.setMasked(false);if(!j||j.error){console.log("Post was not published to Facebook.");}else{console.log(f.fbShareSuccessMsg);Ext.device.Notification.show({title:"Facebook Connect",message:f.fbShareSuccessMsg});}});},true);},onInfoTap:function(a,f,c,d){},onCheckinScanTap:function(a,f,c,g){var d=this;Ext.Viewport.setMasked({xtype:"loadmask",message:d.gatherCheckinInfoMsg});d.getGeoLocation();},onAccountsButtonTap:function(a,f,c,d){this.fireEvent("openpage","Accounts",null,null);console.log("Going to Accounts Page ...");},onChallengesButtonTap:function(a,h,d,g,j){var f=this;var i=f.getVenue();var c=function(){if(j){j();}else{f.fireEvent("openpage","client.Challenges",null,null);console.log("Going to Challenges Page ...");}};if(i.challenges().getData().length==0){Ext.Viewport.setMasked({xtype:"loadmask",message:f.retrieveChallengesMsg});Challenge.setGetChallengesURL();Challenge.load(i.getId(),{params:{merchant_id:i.getMerchant().getId(),venue_id:i.getId()},callback:function(b,e){Ext.Viewport.setMasked(false);if(e.wasSuccessful()){i.challenges().add(e.getRecords());c();}}});}else{c();}},onRewardsButtonTap:function(a,f,c,d){this.fireEvent("openpage","client.Rewards","rewards",null);console.log("Going to Client Rewards Page ...");},onRedemptionsButtonTap:function(a,f,c,d){this.fireEvent("openpage","client.Redemptions","redemptions",null);console.log("Going to Client Redemptions Page ...");},onPrizesButtonTap:function(a,f,c,d){this.fireEvent("openpage","Prizes","merchantPrizes",null);console.log("Going to Merchant Prizes Page ...");},onHomeButtonTap:function(a,g,c,f){var d=this.getViewport();this.resetView();this.fireEvent("openpage","MainPage",null,null);console.log("Going back to HomePage ...");},resetView:function(){var a=this;a.viewStack=[];},pushView:function(b,d){var c=this;d=Ext.apply(d,{reverse:false});var a=(c.viewStack.length>1)?c.viewStack[c.viewStack.length-2]:null;if((c.viewStack.length>0)&&(b==c.viewStack[c.viewStack.length-1]["view"])){}else{if(a&&(a.view==b)){c.popView();}else{c.viewStack.push({view:b,animation:d});c.getViewport().animateActiveItem(b,d);}}},silentPopView:function(b){var c=this;b=Math.min(c.viewStack.length,b);if((c.viewStack.length>0)&&(b>0)){while(b-->0){var a=c.viewStack.pop();c.getViewport().remove(a);}}},popView:function(){var c=this;if(c.viewStack.length>0){var a=c.viewStack.pop();var b=c.viewStack[c.viewStack.length-1];if(b.view.isDestroyed){b.view=Ext.create(b.view.alias[0]);console.debug("Recreated View ["+b.view._itemId+"]");}c.getViewport().animateActiveItem(b.view,Ext.apply(a.animation,{reverse:true}));}},init:function(b){var a=this;console.log("Viewport Init");_application=b;a.callParent(arguments);console.log("Loading License Keys ...");Genesis.constants.getPrivKey();QRCodeReader.prototype.scanType="Default";console.debug("QRCode Scanner Mode["+QRCodeReader.prototype.scanType+"]");if(!merchantMode){Genesis.fb.initFb();a.updateRewardsTask=Ext.create("Ext.util.DelayedTask");}if(Ext.isDefined(window.device)){console.debug("device.platform - "+device.platform);}Ext.defer(function(){this.sound_files={};var c=[["rouletteSpinSound","roulette_spin_sound","Media"],["winPrizeSound","win_prize_sound","Media"],["clickSound","click_sound","FX"],["beepSound","beep.wav","FX"]];for(var d=0;d<c.length;d++){this.loadSoundFile.apply(this,c[d]);}},1,a);},loadSoundFile:function(a,b,d){var f=this;var c="."+(b.split(".")[1]||"mp3");b=b.split(".")[0];if(Genesis.constants.isNative()){switch(d){case"FX":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,function(){console.debug("loaded "+b);},function(g){console.debug("Audio Error: "+g);});break;case"Audio":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,3,function(){console.debug("loaded "+b);},function(g){console.debug("Audio Error: "+g);});break;case"Media":b=new Media("resources/audio/"+b+c,function(){f.sound_files[a].successCallback();},function(g){f.sound_files[a].successCallback();console.log("Audio Error: "+g);});break;}}else{var e=Ext.get(b);if(e){e.dom.addEventListener("ended",function(){f.sound_files[a].successCallback();},false);}}f.sound_files[a]={name:b,type:d};},openMainPage:function(){var c=Genesis.db.getLocalDB();var a=(c.auth_code)?true:false;if(!merchantMode){if(a){var d=this.getApplication();var b=d.getController("MainPage");this.setLoggedIn(a);console.debug("Going to Main Page ...");if(c.currFbId>0){d.dispatch({action:"facebookLogin",args:[c.fbResponse],controller:b,scope:b});}else{d.dispatch({action:"onSignIn",args:[],controller:b,scope:b});}}else{console.debug("Going to Login Page ...");this.fireEvent("openpage","MainPage","login",null);}}}});Ext.define("Genesis.controller.Settings",{extend:"Genesis.controller.ControllerBase",statics:{settings_path:"/settings",},xtype:"settingsCntlr",config:{refs:{clientSettingsPage:{selector:"clientsettingspageview",autoCreate:true,xtype:"clientsettingspageview"},serverSettingsPage:{selector:"serversettingspageview",autoCreate:true,xtype:"serversettingspageview"}},control:{}},fbLoggedInIdentityMsg:function(a){return"You're logged into Facebook as "+Genesis.constants.addCRLF()+a;},init:function(){this.callParent(arguments);this.initClientControl();this.initServerControl();console.log("Settings Init");},initClientControl:function(){this.control({"clientsettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"clientsettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"clientsettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"},"clientsettingspageview listfield[name=facebook]":{clearicontap:"onFacebookTap"}});},initServerControl:function(){this.control({"serversettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"serversettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"serversettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"}});},onTermsTap:function(a,c){Ext.device.Notification.show({title:"Button Tapped",message:"Disclose List Item"});},onFacebookTap:function(a,d){var c=this;Genesis.fb.facebook_onLogin(function(b){Ext.Viewport.setMasked(false);Customer.setUpdateFbLoginUrl();Customer.load(1,{jsonData:{},params:{user:Ext.encode(b)},callback:function(e,f){if(f.wasSuccessful()){Ext.device.Notification.show({title:"Facebook Connect",message:c.fbLoggedInIdentityMsg(b.email)});}}});},true);},onTermsTap:function(a,c){Ext.device.Notification.show({title:"Terms Tapped",message:"Disclose List Item"});},onPrivacyTap:function(a,c){Ext.device.Notification.show({title:"Privacy Tapped",message:"Disclose List Item"});},onAboutUsTap:function(a,c){Ext.device.Notification.show({title:"About Us Tapped",message:"Disclose List Item"});},openPage:function(a){var b=this,c;switch(a){case"client":c=this.getClientSettingsPage();break;case"server":c=this.getServerSettingsPage();break;}b.setAnimationMode(b.self.superclass.self.animationMode.slide);b.pushView(c);},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.MainPage",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store","Genesis.model.EarnPrize"],statics:{mainPage_path:"/mainPage",loginPage_path:"/loginPage",sign_in_path:"/sign_in",sign_out_path:"/sign_out",},xtype:"mainPageCntlr",config:{models:["frontend.MainPage","frontend.Signin","frontend.Account","EligibleReward","Customer","User","Merchant","EarnPrize","CustomerReward"],listeners:{authcoderecv:"onAuthCodeRecv"},refs:{login:{selector:"loginpageview",autoCreate:true,xtype:"loginpageview"},signin:{selector:"signinpageview",autoCreate:true,xtype:"signinpageview"},createAccount:{selector:"createaccountpageview",autoCreate:true,xtype:"createaccountpageview"},main:{selector:"mainpageview",autoCreate:true,xtype:"mainpageview"},mainCarousel:"mainpageview",infoBtn:"button[tag=info]"},control:{login:{activate:"onLoginActivate",deactivate:"onLoginDeactivate"},"actionsheet button[tag=facebook]":{tap:"onFacebookTap"},"actionsheet button[tag=createAccount]":{tap:"onCreateAccountTap"},"actionsheet button[tag=signIn]":{tap:"onSignInTap"},"signinpageview button[tag=login]":{tap:"onSignInSubmit"},"actionsheet button[tag=logout]":{tap:"onLogoutTap"},main:{activate:"onActivate",deactivate:"onDeactivate"},"mainpageview dataview":{select:"onItemSelect",itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd"},createAccount:{activate:"onCreateActivate",deactivate:"onCreateDeactivate"},"createaccountpageview button[tag=createAccount]":{tap:"onCreateAccountSubmit"}}},signInFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please Try Again";},loginWithFbMsg:function(a){return"Logging in ...";},init:function(b){this.callParent(arguments);var a=this;Ext.regStore("MainPageStore",{model:"Genesis.model.frontend.MainPage",autoLoad:true,listeners:{scope:a,load:function(e,d,g,c,f){if(merchantMode){a.goToMain();}}}});if(!merchantMode){Ext.regStore("UserStore",{model:"Genesis.model.User",autoLoad:false});a.initMerchantPrizeStore();Ext.regStore("EligibleRewardsStore",{model:"Genesis.model.EligibleReward",autoLoad:false});a.initCustomerStore();}console.log("MainPage Init");},initCustomerStore:function(){var b=this,a;Ext.regStore("CustomerStore",{model:"Genesis.model.Customer",autoLoad:false,pageSize:1000,listeners:{scope:b,load:function(f,e,h,d,g){var c=f.getProxy().getReader().metaData;if(h&&c&&c.auth_token){a=Genesis.db.getLocalDB();console.debug("auth_code ["+a.auth_code+"]\ncurrFbId ["+a.currFbId+"]");b.goToMain();}},metachange:function(e,j,h){var d=j.getReader().metaData;var c=d.prizes;if(c){console.debug("Total Prizes - "+c.length);for(var g=0;g<c.length;g++){c[g].reward={data:c[g].reward};}Ext.StoreMgr.get("MerchantPrizeStore").setData(c);}var f=d.auth_token;if(f){console.debug("Login Auth Code - "+f);a=Genesis.db.getLocalDB();if(f!=a.auth_code){Genesis.db.setLocalDBAttrib("auth_code",f);}}b.getViewPortCntlr().updateRewardsTask.delay(1*1000,b.updateRewards,b,[d]);}},grouper:{groupFn:function(c){return c.getMerchant().get("name");}},sorters:[{sorterFn:function(e,c){var f=e.getMerchant().get("name"),d=c.getMerchant().get("name");if(f<d){return -1;}if(f>d){return 1;}return 0;}}]});},initMerchantPrizeStore:function(){var a=this;var b=a.getApplication();Ext.regStore("MerchantPrizeStore",{model:"Genesis.model.EarnPrize",autoLoad:false,clearOnPageLoad:false,sorters:[{sorterFn:function(d,c){return d.getMerchant().getId()-c.getMerchant().getId();}},{sorterFn:function(d,c){return Date.parse(c.get("expiry_date"))-Date.parse(d.get("expiry_date"));}},{sorterFn:function(d,c){return c.getId()-d.getId();}}],listeners:{scope:this,metachange:function(d,f,e){var c=b.getController("client.Rewards");b.dispatch({action:"onPrizeStoreMetaChange",args:[d,f.getReader().metaData],controller:c,scope:c});}}});},onAuthCodeRecv:function(b){var c=this;var d=c.getApplication();var a=d.getController("Accounts");d.dispatch({action:"onAuthCodeRecv",args:[b],controller:a,scope:a});},onItemSelect:function(f,b,c){Genesis.controller.ControllerBase.playSoundFile(this.getViewPortCntlr().sound_files.clickSound);f.deselect([b],false);console.log("Controller=["+b.data.pageCntlr+"]");var a=this.getApplication().getController(b.get("pageCntlr"));var e=a.isOpenAllowed();if(e===true){if(b.get("subFeature")){a.openPage(b.get("subFeature"));}else{a.openMainPage();}}else{Ext.device.Notification.show({title:"Error",message:e});}return false;},onItemTouchStart:function(g,a,f,c,b){},onItemTouchEnd:function(g,a,f,c,b){},onActivate:function(d,e,a,b){d.createView();this.getInfoBtn()[(merchantMode)?"hide":"show"]();},onDeactivate:function(a,f,e,b){var d=this;},facebookLogin:function(b){var a=this;Customer.setFbLoginUrl();console.log("setFbLoginUrl - Logging in ...");Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:b,callback:function(d,c){Ext.Viewport.setMasked(false);if(!c.wasSuccessful()){Genesis.db.resetStorage();a.fireEvent("openpage","MainPage","login",null);}}});},onLoginActivate:function(b,a){activeItem.createView();},onLoginDeactivate:function(a,f,e,b){var d=this;},onLogoutTap:function(i,c,d,j){var h=this;var f=h.getViewport();var l=h.getViewPortCntlr();var g=0;var k=function(){console.log("Resetting Session information ...");f.setFadeAnimation();l.setLoggedIn(false);Genesis.db.removeLocalDBAttrib("auth_code");if(Genesis.db.getLocalDB()["currFbId"]>0){Genesis.fb.facebook_onLogout(null,true);}h.fireEvent("openpage","MainPage","login",null);};var a=function(){var b=Genesis.db.getLocalDB()["auth_code"];if(b){console.log("Logging out ...");Customer.setLogoutUrl(b);Ext.StoreMgr.get("CustomerStore").load({jsonData:{},callback:function(m,e){Ext.Viewport.setMasked(false);if(e.wasSuccessful()){console.log("Logout Successful!");}else{console.log("Logout Failed!");}}});}k();};i.parent.onAfter({hiddenchange:function(){if((g|=1)==17){a();}},single:true});i.parent.hide();if(Genesis.db.getLocalDB()["currFbId"]>0){console.log("Logging out of Facebook ...");Genesis.fb.facebook_onLogout(function(){if((g|=16)==17){a();}});}else{console.log("No Login info found from Facebook ...");if((g|=16)==17){a();}}},onFacebookTap:function(a,g,c,f){var d=this;Ext.Viewport.setMasked({xtype:"loadmask",message:d.loginWithFbMsg()});Genesis.db.removeLocalDBAttrib("currFbId");Genesis.fb.facebook_onLogin(function(b){console.log(d.loginWithFbMsg());d.facebookLogin(b);},true);},onCreateAccountTap:function(a,f,c,d){this.setAnimationMode(this.self.superclass.self.animationMode.slide);this.pushView(this.getCreateAccount());},onSignInTap:function(a,f,c,d){this.setAnimationMode(this.self.superclass.self.animationMode.slide);this.pushView(this.getSignin());},onCreateAccountSubmit:function(j,h,i,m){var g=this.getCreateAccount();var n=g.getValues();var f=Ext.create("Genesis.model.frontend.Account",n);var a=f.validate();var d=Genesis.db.getLocalDB()["fbResponse"]||null;if(!a.isValid()){var l=a.first();var k=Ext.ComponentQuery.query("field[name="+l.getField()+"]")[0].getLabel();var o=k+" "+l.getMessage()+Genesis.constants.addCRLF()+"Please Try Again";console.log(o);Ext.device.Notification.show({title:"Oops",message:o});}else{console.debug("Creating Account ...");var c={name:n.name,email:n.username,password:n.password};if(d){c=Ext.apply(c,d);}Customer.setCreateAccountUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:{user:Ext.encode(c)},callback:function(){Ext.Viewport.setMasked(false);}});}},onSignIn:function(d,a){Genesis.fb.facebook_onLogout(null,Genesis.db.getLocalDB()["currFbId"]>0);var b=this;var c={};if(d){c={email:d,password:a};}Customer.setLoginUrl();console.log("setLoginUrl - Logging in ...");Ext.StoreMgr.get("CustomerStore").load({params:c,jsonData:{},callback:function(f,e){Ext.Viewport.setMasked(false);if(!e.wasSuccessful()){Genesis.db.resetStorage();b.fireEvent("openpage","MainPage","login",null);}}});},onSignInSubmit:function(g,d,f,j){var k=this.getSignin();var l=k.getValues();var c=Ext.create("Genesis.model.frontend.Signin",l);var a=c.validate();if(!a.isValid()){var i=a.first();var h=Ext.ComponentQuery.query("field[name="+i.getField()+"]")[0].getLabel();Ext.device.Notification.show({title:"Oops",message:signInFailMsg(h+" "+i.getMessage())});}else{this.onSignIn(l.username,l.password);}},onCreateActivate:function(e,b){var a=Genesis.db.getLocalDB()["fbResponse"]||null;if(a){var d=this.getCreateAccount();d.setValues({name:a.name,username:a.email});}activeItem.createView();},onCreateDeactivate:function(a,f,e,b){var d=this;},openPage:function(a){this.resetView();switch(a){case"main":this.setAnimationMode(this.self.superclass.self.animationMode.flip);this.pushView(this.getMainPage());break;case"merchant":this.setAnimationMode(this.self.superclass.self.animationMode.flip);var c=this.getApplication();var b=c.getController("Merchants");c.dispatch({action:"onGotoCheckedInAccountTap",args:[],controller:b,scope:b});break;case"login":this.setAnimationMode(this.self.superclass.self.animationMode.fade);Ext.Viewport.setMasked(false);this.pushView(this.getLogin());break;}},getMainPage:function(){var a=this.getMain();return a;},openMainPage:function(){var a=this.getViewPortCntlr();this.setAnimationMode(this.self.superclass.self.animationMode.flip);this.pushView(this.getMainPage());console.log("MainPage Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.Challenges",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{serverRedemption_path:"/serverChallenges"},xtype:"serverChallengesCntlr",models:["PurchaseReward","CustomerReward"],config:{refs:{challenges:{selector:"serverchallengesview",autoCreate:true,xtype:"serverchallengesview"},refreshBtn:"showprizeview[tag=showPrize] button[tag=refresh]",},control:{challenges:{activate:"onActivate",deactivate:"onDeactivate"},refreshBtn:{tap:"onRefreshTap"}}},invalidAuthCodeMsg:"Authorization Code is Invalid",genAuthCodeMsg:"Proceed to generate Authorization Code",refreshAuthCodeMsg:"Refresing Authorization Code ...",init:function(){this.callParent(arguments);console.log("Server Challenges Init");},generateQRCode:function(){return Genesis.controller.ControllerBase.genQRCodeFromParams({type:"earn_points"});},onActivate:function(d,e,a,b){d.createView();},onDeactivate:function(a,f,e,b){var d=this;},onRefreshTap:function(a,g,d){var f=this;Ext.Viewport.setMasked({xtype:"loadmask",message:f.refreshAuthCodeMsg});var h=f.getApplication();var c=h.getController("Prizes");Ext.defer(function(){var b=f.generateQRCode();if(b[0]){h.dispatch({action:"onRefreshQRCode",args:[b],controller:c,scope:c});}Ext.Viewport.setMasked(false);},1,f);},onGenerateQRCode:function(){var b=this;var c=b.generateQRCode();if(c[0]){var d=b.getApplication();var a=d.getController("Prizes");d.dispatch({action:"onAuthReward",args:[Ext.create("Genesis.model.EarnPrize",{id:1,expiry_date:null,reward:Ext.create("Genesis.model.CustomerReward",{id:0,title:"Authorization Code",type:{value:"earn_points"},photo:{thumbnail_ios_medium:{url:c[0],height:c[1],width:c[2],}}}),merchant:null})],controller:a,scope:a});}},openMainPage:function(){var a=this;Ext.device.Notification.show({title:"Authorize Challenges",message:a.genAuthCodeMsg,buttons:["OK","Cancel"],callback:function(b){if(b.toLowerCase()=="ok"){console.log(a.genAuthCodeMsg);a.onGenerateQRCode();}}});},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.Rewards",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{serverRewards_path:"/serverRewards"},xtype:"serverRewardsCntlr",models:["PurchaseReward","CustomerReward"],config:{refs:{rewards:{selector:"serverrewardsview",autoCreate:true,xtype:"serverrewardsview"},rewardsContainer:"serverrewardsview container[tag=rewards]",price:"serverrewardsview textfield",qrcode:"serverrewardsview component[tag=qrcode]",title:"serverrewardsview component[tag=title]",infoBtn:"viewportview button[tag=info]"},control:{rewards:{activate:"onActivate",deactivate:"onDeactivate"},rewardsContainer:{activeitemchange:"onContainerActivate"},"serverrewardsview container[tag=dialpad] button":{tap:"onCalcBtnTap"},"serverrewardsview container[tag=rewardsMainCalculator] button[tag=showQrCode]":{tap:"onShowQrCodeTap"},"serverrewardsview container[tag=qrcodeContainer] button[tag=done]":{tap:"onDoneTap"}}},maxValue:1000,invalidPriceMsg:"Please enter a valid price (eg. 5.00), upto $1000",init:function(){this.callParent(arguments);console.log("Server Rewards Init");},getPricePrecision:function(b){var a=b.split(".");return((a.length>1)?a[1].length:0);},onActivate:function(d,e,a,b){d.createView();},onDeactivate:function(a,f,e,b){var d=this;d.enablePrecision=false;},onContainerActivate:function(i,h,b,e){var f=this;var a=f.getRewardsContainer();var g=a.getLayout().getAnimation();switch(h.config.tag){case"rewardsMainCalculator":var d=f.getPrice();d.setValue(null);f.enablePrecision=false;g.setReverse(true);break;case"qrcodeContainer":g.setReverse(false);break;}console.debug("Rewards ContainerActivate Called.");Ext.Viewport.setMasked(false);},onShowQrCodeTap:function(a,j,f,i){var h=this;var d=h.getRewardsContainer();var g=h.getPrice().getValue();var c=this.getPricePrecision(g);if(c<2){Ext.device.Notification.show({title:"Validation Error",message:h.invalidPriceMsg});return;}Ext.Viewport.setMasked({xtype:"loadmask",message:h.genQRCodeMsg});Ext.defer(function(){console.debug("Encrypting QRCode with Price:$"+g);var b=Genesis.controller.ControllerBase.genQRCodeFromParams({amount:g,type:"earn_points"});h.getQrcode().setStyle({"background-image":"url("+b[0]+")","background-size":Genesis.fn.addUnit(b[1])+" "+Genesis.fn.addUnit(b[2])});h.getTitle().setData({price:"$"+g});d.setActiveItem(1);},1,h);},onCalcBtnTap:function(j,f,g,k){var i=this;var h=i.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(h.sound_files.clickSound);var m=j.getText();var l=i.getPrice();var d=Number(l.getValue()||0);var c=i.getPricePrecision(l.getValue());switch(m){case".":i.enablePrecision=true;if(c==0){var a=d.toString().split(".");d=a[0]+".";}break;case"AC":i.enablePrecision=false;d=null;break;default:if(i.enablePrecision){if(c<2){d+=(Number(m)/Math.pow(10,c+1));d=d.toFixed(c+1);}}else{d=(10*d)+Number(m);}break;}if(d<=i.maxValue){l.setValue(d);}},onDoneTap:function(a,h,d,g){var f=this;var c=f.getRewardsContainer();c.setActiveItem(0);},getMainPage:function(){var a=this.getRewards();return a;},openPage:function(b){var d;var c=this;var a=c.getViewPortCntlr();switch(b){case"rewards":d=c.getRewards();c.setAnimationMode(c.self.superclass.self.animationMode.slide);c.pushView(d);break;}},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.Redemptions",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{serverRedemption_path:"/serverRedemptions"},xtype:"serverRedemptionsCntlr",models:["PurchaseReward","CustomerReward"],config:{refs:{redemptions:{selector:"serverredemptionsview",autoCreate:true,xtype:"serverredemptionsview"},verifyBtn:"showprizeview[tag=showPrize] button[tag=verify]",},control:{redemptions:{activate:"onActivate",deactivate:"onDeactivate"},verifyBtn:{tap:"onVerifyTap"}}},invalidAuthCodeMsg:"Authorization Code is Invalid",authCodeNoLongValidMsg:"Authorization Code is no longer valid",init:function(){this.callParent(arguments);console.log("Server Redemptions Init");},verifyQRCode:function(f){console.debug("Encrypted Code Length: "+f.length);console.debug("Decrypted content ["+f+"]");var h=this;var k=Genesis.constants.getPrivKey();GibberishAES.size(256);var d=Genesis.db.getRedeemIndexDB();for(var i in k){try{console.debug("Decrypting message using key["+k[i]+"]");data=GibberishAES.dec(f,k[i]);console.debug("Decrypted Data["+data+"]");var j=Ext.decode(data);console.debug("Decoded Data!");var b=new Date(j.expiry_ts);if(d[f]){console.log(h.authCodeNoLongValidMsg);Ext.device.Notification.show({title:"Error!",message:h.authCodeNoLongValidMsg});return;}else{if((b>=Date.now())&&(b<=new Date().addHours(3*2))){console.log("Found QRCode type["+j.type+"]");switch(j.type){case"redeem_prize":break;case"redeem_reward":break;}Genesis.db.addRedeemSortedDB([f,d[f]]);Genesis.db.addRedeemIndexDB(f,j.expiry_ts);var a=h.getApplication();var c=a.getController("Prizes");a.dispatch({action:"onAuthReward",args:[Ext.create("Genesis.model.EarnPrize",{id:1,expiry_date:null,reward:Ext.create("Genesis.model.CustomerReward",{type:j.reward.type,title:j.reward.title}),merchant:null})],controller:c,scope:c});return;}else{console.log("Decrypted data used an expired key from Vendor["+i+"]");}}}catch(g){console.log("Error decrypted data ["+g+"]");}}Ext.device.Notification.show({title:"Error!",message:h.invalidAuthCodeMsg});},onActivate:function(d,e,a,b){d.createView();},onDeactivate:function(a,f,e,b){var d=this;},onScannedQRcode:function(b){var a=this;if(!b){Ext.device.Notification.show({title:"Error!",message:a.invalidAuthCodeMsg});}a.verifyQRCode(b);},onRedeemVerification:function(){var a=this;Ext.device.Notification.show({title:"Redemption Verification",message:"Proceed to scan your customer's Authorization Code",buttons:["OK","Cancel"],callback:function(b){if(b.toLowerCase()=="ok"){console.log("Verifying Authorization Code ...");a.scanQRCode();}}});},onVerifyTap:function(a,d,c){this.popView();},getMainPage:function(){var a=this.getRedemptions();return a;},openPage:function(a){switch(a){case"redemptions":this.onRedeemVerification();break;}},isOpenAllowed:function(){return true;}});var _dbCleanup=function(){Ext.defer(function(){Genesis.db.redeemDBCleanup();_dbCleanup();},1000*60*60*3);};_dbCleanup();Ext.define("Genesis.controller.Prizes",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store","Ext.util.Sorter"],statics:{prizes_path:"/prizes"},xtype:"prizesCntlr",config:{timeoutPeriod:10,mode:"userPrizes",models:["Venue","Merchant","EarnPrize","CustomerReward"],listeners:{redeemprize:"onRedeemPrize",prizecheck:"onPrizeCheck",showprize:"onShowPrize"},refs:{uCloseBB:"prizesview[tag=userPrizes] button[tag=close]",uBB:"prizesview[tag=userPrizes] button[tag=back]",uDoneBtn:"prizesview[tag=userPrizes] button[tag=done]",uRedeemBtn:"prizesview[tag=userPrizes] button[tag=redeem]",mCloseBB:"prizesview[tag=merchantPrizes] button[tag=close]",mBB:"prizesview[tag=merchantPrizes] button[tag=back]",mDoneBtn:"prizesview[tag=merchantPrizes] button[tag=done]",mRedeemBtn:"prizesview[tag=merchantPrizes] button[tag=redeem]",sCloseBB:"showprizeview[tag=showPrize] button[tag=close]",sBB:"showprizeview[tag=showPrize] button[tag=back]",sDoneBtn:"showprizeview[tag=showPrize] button[tag=done]",sRedeemBtn:"showprizeview[tag=showPrize] button[tag=redeem]",refreshBtn:"showprizeview[tag=showPrize] button[tag=refresh]",verifyBtn:"showprizeview[tag=showPrize] button[tag=verify]",prizeCheckScreen:"clientrewardsview",merchantPrizes:{selector:"prizesview[tag=merchantPrizes]",autoCreate:true,tag:"merchantPrizes",xtype:"prizesview"},userPrizes:{selector:"prizesview[tag=userPrizes]",autoCreate:true,tag:"userPrizes",xtype:"prizesview"},showPrize:{selector:"showprizeview[tag=showPrize]",autoCreate:true,tag:"showPrize",xtype:"showprizeview"},merchantPrizesCarousel:"prizesview[tag=merchantPrizes] carousel",userPrizesCarousel:"prizesview[tag=userPrizes] carousel",},control:{uDoneBtn:{tap:"onDoneTap"},mDoneBtn:{tap:"onDoneTap"},sDoneBtn:{tap:"onDoneTap"},uRedeemBtn:{tap:"onRedeemPrizeTap"},mRedeemBtn:{tap:"onRedeemPrizeTap"},sRedeemBtn:{tap:"onRedeemPrizeTap"},merchantPrizes:{activate:"onMerchantPrizesActivate",deactivate:"onDeactivate"},userPrizes:{activate:"onUserPrizesActivate",deactivate:"onDeactivate"},showPrize:{activate:"onShowPrizeActivate",deactivate:"onDeactivate"}}},evtFlag:0,loadCallback:null,initSound:false,authRewardVerifiedMsg:"Verified",updatePrizeOnFbMsg:"Tell your friends on Facebook about the prize you just won!",retrievingQRCodeMsg:"Retrieving QRCode ...",wonPrizeMsg:function(a){return"You haved won "+((a>1)?"some PRIZES":"a PRIZE")+"!";},lostPrizeMsg:"Oops, Play Again!",showQrCodeMsg:"Show this Authorization Code to your server to redeem!",checkinFirstMsg:"Please Check-in before claiming any prize(s)",redeemPrizeConfirmMsg:"Please confim to redeem this item",init:function(){var a=this;this.callParent(arguments);Ext.defer(a.getMerchantPrizes,1,a);Ext.defer(a.getUserPrizes,1,a);Ext.defer(a.getShowPrize,1,a);console.log("Prizes Init");},stopRouletteTable:function(){var a=this.getPrizeCheckScreen();var b=Ext.get(Ext.DomQuery.select("div.rouletteTable",a.element.dom)[0]);b.removeCls("spinFwd");b.removeCls("spinBack");},stopRouletteBall:function(){var a=this.getPrizeCheckScreen();var b=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);b.removeCls("spinBack");b.addCls("spinFwd");},stopRouletteScreen:function(){this.stopRouletteTable();var a=this.getPrizeCheckScreen();var b=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);b.removeCls("spinBack");b.removeCls("spinFwd");},updatingPrizeOnFacebook:function(d){var i=this;try{var h=i.getViewPortCntlr();var c=h.getVenue();var a=Genesis.constants.site;var k=c.get("website")?c.get("website").split(/http[s]*:\/\//):[null];var b=c.get("name");var j=k[k.length-1]||a;var f=c.get("description").trunc(256);var l="I just won "+d.getCustomerReward().get("title")+" for purchasing at "+c.get("name")+"!";console.log("Posting to Facebook ...\nName: "+b+"\nCaption: "+j+"\nDescription: "+f+"\nMessage : "+l+"\n");FB.api("/me/feed","post",{name:b,link:c.get("website")||a,caption:j,description:f,picture:c.getMerchant().get("photo")["thumbnail_ios_medium"].url,message:l},function(e){Ext.Viewport.setMasked(false);if(!e||e.error){console.log("Post was not published to Facebook.");}else{console.log("Posted to your Facebook Newsfeed.");}});}catch(g){Ext.Viewport.setMasked(false);console.log("Exception ["+g+"]\nPost was not published to Facebook.");}},onRedeemPrize:function(b,e){var d=this;var c=b.getId();var g=b.getMerchant().getId();var f,a;switch(d.getMode()){case"merchantPrizes":d.getMCloseBB().hide();d.getMBB().hide();case"userPrizes":var i=d.getMainCarousel();var h=i.getActiveItem();f=Ext.StoreMgr.get("MerchantPrizeStore");EarnPrize.setRedeemPrizeURL(h.getStore().first().getId());d.getUCloseBB().hide();d.getUBB().hide();break;case"showPrize":var h=e.getInnerItems()[0];f=Ext.StoreMgr.get("MerchantPrizeStore");EarnPrize.setRedeemPrizeURL(h.getStore().first().getId());d.getSCloseBB().hide();d.getSBB().hide();break;case"reward":var h=e.getInnerItems()[0];f=Ext.StoreMgr.get("RedemptionsStore");CustomerReward.setRedeemPointsURL(h.getStore().first().getCustomerReward().getId());d.getSCloseBB().hide();d.getSBB().hide();break;}Ext.Viewport.setMasked({xtype:"loadmask",message:d.retrievingQRCodeMsg});f.load({addRecords:true,scope:d,jsonData:{},params:{venue_id:c},callback:function(k,j){if(!j.wasSuccessful()){Ext.Viewport.setMasked(false);a.show();}}});},onPrizeCheck:function(e,d){var g=this;var a=g.getViewPortCntlr();g.stopRouletteBall();if(e.length==0){console.log("Prize LOST!");Ext.device.Notification.show({title:"Scan And Win!",message:g.lostPrizeMsg,callback:function(){Ext.defer(g.popView,3*1000,g);}});}else{console.log("Prize WON!");var b=0;var c=Ext.StoreMgr.get("CustomerStore");var h=g.getApplication();var f=g.getViewport();Genesis.controller.ControllerBase.playSoundFile(a.sound_files.winPrizeSound,function(){if(b&16){g.silentPopView(1);}if((b|=1)==17){g.fireEvent("showprize",e[0]);}});Ext.device.Notification.vibrate();Ext.device.Notification.show({title:"Scan And Win!",message:g.wonPrizeMsg(e.length),callback:function(){if(b&1){g.silentPopView(1);}if((b|=16)==17){g.fireEvent("showprize",e[0]);}}});}},onShowPrize:function(c){var b=this;var a=Ext.StoreMgr.get("MerchantPrizeStore");b.showPrize=c;a.insert(0,c);b.setMode("showPrize");Ext.defer(function(){b.stopRouletteScreen();b.pushView(b.getMainPage());Genesis.fb.facebook_onLogin(function(d){b.updatingPrizeOnFacebook(b.showPrize);},false,b.updatePrizeOnFbMsg);},3*1000,b);},onMerchantPrizesActivate:function(d,h,l,f){var j=this;var g=j.getViewPortCntlr();var k=(g.getVenue())?g.getVenue().getMerchant().getId():0;var e=[];j.getMCloseBB().show();j.getMBB().hide();var b=Ext.StoreMgr.get("MerchantPrizeStore").getRange();if(b.length>0){for(var a=0;a<b.length;a++){if(b[a].getMerchant().getId()!=k){continue;}e.push(b[a]);}}if(e.length==0){j.getMRedeemBtn().hide();}else{j.getMRedeemBtn().show();}d.createView();},onUserPrizesActivate:function(d,h,l,f){var j=this;var g=[],e=[];var k;j.getUCloseBB().hide();j.getUBB().show();var b=Ext.StoreMgr.get("MerchantPrizeStore").getRange();for(var a=0;a<b.length;a++){e.push(b[a]);}if(e.length==0){j.getURedeemBtn().hide();}else{j.getURedeemBtn().show();}d.createView();},onShowPrizeActivate:function(b,f,i,d){var g=this;var h=g.getMainPage();var e=g.getViewPortCntlr();var j=b.query("titlebar")[0];var a=g.showPrize.getCustomerReward().get("photo");g.getSCloseBB().show();g.getSBB().hide();switch(g.getMode()){case"authReward":g.getSRedeemBtn().hide();j.addCls("kbTitle");j.setTitle(" ");g.getRefreshBtn()[a?"show":"hide"]();g.getVerifyBtn()[a?"hide":"show"]();break;case"reward":j.removeCls("kbTitle");j.setTitle("Rewards");g.getRefreshBtn()["hide"]();g.getVerifyBtn()["hide"]();break;case"showPrize":default:j.removeCls("kbTitle");g.getSRedeemBtn().show();j.setTitle("Prizes");g.getRefreshBtn()["hide"]();g.getVerifyBtn()["hide"]();break;}h.showPrize=g.showPrize;console.log("ShowPrize View - Updated ShowPrize View.");h.createView();delete g.showPrize;},onDeactivate:function(a,e,d,b){},onDoneTap:function(j,g,h,k,f){var i=this;var c=i.getMainPage();var d=f||i.getMode();if(c.isPainted()&&!c.isHidden()){if(d!="reward"){var l=Ext.StoreMgr.get("MerchantPrizeStore");var n=c.query("carousel")[0];var a=n||c;var m=n?n.getActiveItem():a.getInnerItems()[0];l.remove(m.getStore().getData().items[0]);}switch(d){case"merchantPrizes":i.getMDoneBtn().hide();i.getMRedeemBtn().hide();break;case"userPrizes":i.getUDoneBtn().hide();i.getURedeemBtn().hide();break;case"reward":case"showPrize":i.getSDoneBtn().hide();i.getSRedeemBtn().hide();break;}i.popView();}},onRedeemPrizeTap:function(j,d,f,k){var h=this;var i=h.getMainPage();var g=h.getViewPortCntlr();var a=g.getVenue();var c=g.getCheckinInfo().venue;if(!c||!a||(a.getId()!=c.getId())){Ext.device.Notification.show({title:i.query("titlebar")[0].getTitle(),message:h.checkinFirstMsg});return;}Ext.device.Notification.show({title:i.query("titlebar")[0].getTitle(),message:h.redeemPrizeConfirmMsg,buttons:["Confirm","Cancel"],callback:function(b){if(b.toLowerCase()=="confirm"){h.fireEvent("redeemprize",a,i);}}});},onRefreshQRCode:function(b){var e=this;var a=e.getMainPage();var f=a.query("carousel")[0];var d=f?f.getActiveItem():a.getInnerItems()[0];var c=d.query("component[tag=itemPhoto]")[0];c.element.setStyle({"background-image":"url("+b[0]+")","background-size":Genesis.fn.addUnit(b[1])+" "+Genesis.fn.addUnit(b[2])});},showPrizeQRCode:function(c,b){var a=this;console.log("\nEncrypted Code :\n"+b+"\nEncrypted Code Length: "+b.length);b=Genesis.controller.ControllerBase.genQRCode(b);if(b[0]){a.getURedeemBtn().hide();a.getUDoneBtn().show();a.getMRedeemBtn().hide();a.getMDoneBtn().show();a.getSRedeemBtn().hide();a.getSDoneBtn().show();a.onRefreshQRCode(b);Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Redemption Alert",message:a.showQrCodeMsg});Ext.device.Notification.vibrate();}},onRedeemRewards:function(a){this.showPrize=a;this.setMode("reward");this.pushView(this.getMainPage());},onAuthReward:function(a){this.showPrize=a;this.setMode("authReward");this.pushView(this.getMainPage());},openPage:function(a){switch(a){case"merchantPrizes":this.setMode("merchantPrizes");this.pushView(this.getMainPage());break;case"userPrizes":this.setMode("userPrizes");this.pushView(this.getMainPage());break;}},getMainCarousel:function(){var b=null;switch(this.getMode()){case"userPrizes":b=this.getUserPrizesCarousel();if(!b){var a=this.getMainPage();a.removeAll();a.add({xtype:"carousel",scrollable:undefined});b=this.getUserPrizesCarousel();}break;case"merchantPrizes":b=this.getMerchantPrizesCarousel();if(!b){var a=this.getMainPage();a.removeAll();a.add({xtype:"carousel",scrollable:undefined});b=this.getMerchantPrizesCarousel();}break;case"showPrize":case"reward":case"authReward":break;}return b;},getMainPage:function(){var a=this;var b;switch(a.getMode()){case"userPrizes":a.setAnimationMode(a.self.superclass.self.animationMode.slide);b=a.getUserPrizes();break;case"merchantPrizes":a.setAnimationMode(a.self.superclass.self.animationMode.slideUp);b=a.getMerchantPrizes();break;case"showPrize":case"reward":b=a.getShowPrize();case"authReward":b=a.getShowPrize();a.setAnimationMode(a.self.superclass.self.animationMode.slideUp);break;}return b;},openMainPage:function(){this.setMode("userPrizes");this.pushView(this.getMainPage());console.log("Prizes Page Opened");},isOpenAllowed:function(){return true;}});