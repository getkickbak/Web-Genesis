Ext.define("Genesis.fx.animation.Scroll",{extend:"Ext.fx.animation.Abstract",alternateClassName:"Ext.fx.animation.ScrollIn",alias:["animation.scroll","animation.scrollIn"],config:{direction:"left",out:false,offset:0,easing:"auto",containerBox:"auto",elementBox:"auto",isElementBoxFit:true},reverseDirectionMap:{up:"down",down:"up",left:"right",right:"left"},applyEasing:function(a){if(a==="auto"){return"ease-"+((this.getOut())?"in":"out");}return a;},getData:function(){var e=this.getElement();var l=this.getFrom(),m=this.getTo(),d=this.getOut(),c=this.getOffset(),k=this.getDirection(),f=this.getReverse(),b=0,a=0,j,h,i,g;if(f){k=this.reverseDirectionMap[k];}switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:a=e.getHeight();break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:b=e.getWidth();break;}j=(d)?0:b;h=(d)?0:a;l.set("overflow","hidden");switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:l.set("height",h+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:l.set("width",j+"px");break;}i=(d)?b:0;g=(d)?a:0;m.set("overflow","hidden");switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:m.set("height",g+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:m.set("width",i+"px");break;}return this.callParent(arguments);}});Ext.define("Genesis.view.widgets.ListField",{extend:"Ext.field.Text",alternateClassName:"Genesis.field.List",xtype:"listfield",config:{ui:"list",component:{useMask:false},clearIcon:true,iconCls:"",readOnly:false},initialize:function(){var b=this,a=b.getComponent();b.callParent();if(b.getIconCls()){Ext.fly(b.element.query("."+Ext.baseCSSPrefix.trim()+"component-outer")[0]).addCls(b.getIconCls());}a.setReadOnly(true);},doClearIconTap:Ext.emptyFn});Ext.define("Genesis.view.widgets.ComponentListItem",{extend:"Ext.dataview.element.List",config:{maxItemCache:20},initialize:function(){this.callParent();this.doInitialize();this.itemCache=[];},getItemElementConfig:function(e,h){var f=this,c=f.dataview,g=c.getItemCls(),b=f.itemClsShortCache,d,a;if(g){b+=" "+g;}d={cls:b,children:[{cls:f.labelClsShortCache,}]};if(c.getIcon()){a=h.iconSrc;d.children.push({cls:f.iconClsShortCache,style:"background-image: "+a?'url("'+newSrc+'")':""});}return d;},moveItemsToCache:function(k,l){var j=this,d=j.dataview,b=d.getMaxItemCache(),h=j.getViewItems(),g=j.itemCache,f=g.length,n=d.getPressedCls(),e=d.getSelectedCls(),c=l-k,o;for(;c>=0;c--){o=Ext.get(h[k+c]);var m=o.down(j.labelClsCache,true);var a=Ext.getCmp(m.childNodes[0].id);if(f!==b){o.removeCls([n,e]);g.push(a);f++;}else{Ext.Array.remove(j.itemCache,a);a.destroy();}o.dom.parentNode.removeChild(o.dom);}if(j.getViewItems().length==0){this.dataview.showEmptyText();}},moveItemsFromCache:function(b){var l=this,e=l.dataview,m=e.getStore(),k=b.length;var a=e.getDefaultType(),h=e.getItemConfig();var g=l.itemCache,f=g.length,j=[],c,n,d;if(k){e.hideEmptyText();}for(c=0;c<k;c++){b[c]._tmpIndex=m.indexOf(b[c]);}Ext.Array.sort(b,function(o,i){return o._tmpIndex>i._tmpIndex?1:-1;});for(c=0;c<k;c++){d=b[c];if(f){f--;n=g.pop();l.updateListItem(d,n);}l.addListItem(d._tmpIndex,d,n);delete d._tmpIndex;}return j;},addListItem:function(f,d,m){var j=this,e=j.dataview,b=e.prepareData(d.getData(true),e.getStore().indexOf(d),d);var c=j.element,l=c.dom.childNodes,i=l.length,h;h=Ext.Element.create(this.getItemElementConfig(f,b));var a=e.getDefaultType(),g=e.getItemConfig();if(!i||f==i){h.appendTo(c);}else{h.insertBefore(l[f]);}var k=h.down(j.labelClsCache,true);if(!m){m=new Ext.widget(a,{xtype:a,record:d,dataview:e,itemCls:e.getItemCls(),defaults:g,renderTo:k});}else{m.element.appendTo(k);}},updateListItem:function(b,c){if(c.isComponent&&c.updateRecord){c.updateRecord(b);}else{var d=Ext.fly(c).down(this.labelClsCache,true);var a=Ext.getCmp(d.childNodes[0].id);a.updateRecord(b);}},destroy:function(){var d=this.getViewItems(),c=d.length,b=0,a=this.itemCache.length;for(;b<a;b++){this.itemCache[b].destroy();this.itemCache[b]=null;}delete this.itemCache;for(b=0;b<c;b++){Ext.removeNode(d[b]);}this.callParent();}});Ext.define("Genesis.view.widgets.ComponentList",{alternateClassName:"Genesis.ComponentList",extend:"Ext.dataview.List",xtype:"componentlist",requires:["Genesis.view.widgets.ComponentListItem"],initialize:function(){var b=this,a;b.on(b.getTriggerCtEvent(),b.onContainerTrigger,b);a=b.container=this.add(new Genesis.view.widgets.ComponentListItem({baseCls:this.getBaseCls()}));a.dataview=b;b.on(b.getTriggerEvent(),b.onItemTrigger,b);a.element.on({delegate:"."+this.getBaseCls()+"-disclosure",tap:"handleItemDisclosure",scope:b});a.on({itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd",itemtap:"onItemTap",itemtaphold:"onItemTapHold",itemtouchmove:"onItemTouchMove",itemsingletap:"onItemSingleTap",itemdoubletap:"onItemDoubleTap",itemswipe:"onItemSwipe",scope:b});if(this.getStore()){this.refresh();}}});Ext.define("Genesis.view.widgets.RedeemItem",{extend:"Ext.Container",requires:["Ext.Button","Ext.XTemplate"],xtype:"redeemitem",alias:"widget.redeemitem",config:{cls:"redeemItem",tag:"redeemItem",layout:"fit",items:[{docked:"top",xtype:"component",tag:"title",cls:"title",defaultUnit:"em",tpl:Ext.create("Ext.XTemplate","{[this.getDescription(values)]}",{getDescription:function(a){return a.title;}})},{xtype:"component",tag:"itemPhoto",cls:"itemPhoto",tpl:Ext.create("Ext.XTemplate",'<div class="photoVCenterHelper"></div>','<div class="photoVCenterContent"><img {[this.getPhoto(values)]} /></div>','<div class="itemPoints {[this.isVisible(values)]}">{[this.getPoints(values)]}</div>',{getPhoto:function(a){var c=Genesis.constants._thumbnailAttribPrefix+"large";var b=Genesis.view.widgets.RedeemItem.getPhoto(a.type)||a.photo[c];if(Ext.isString(b)){return'src="'+b+'"';}else{return'src="'+b.url+'" '+((b.width)?'style="width:'+Genesis.fn.addUnit(b.width)+";height:"+Genesis.fn.addUnit(b.height)+';"':"");}},isVisible:function(a){return((a.merchant)?"":"x-item-hidden");},getPoints:function(a){return((a.points>0)?a.points+"  Pts":" ");}})},{docked:"bottom",xtype:"component",hidden:true,tag:"itemPoints",cls:"itemPoints",tpl:Ext.create("Ext.XTemplate","{[this.getPoints(values)]}",{getPoints:function(a){return((a.points>0)?a.points+"  Pts":" ");}})},{docked:"bottom",xtype:"component",tag:"info",cls:"info",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="infoWrapper"><div class="name">{[this.getName(values)]}</div><div class="disclaimer">{[this.getDisclaimer(values)]}</div><div class="date">{[this.getExpiryDate(values)]}</div></div>',{getExpiryDate:function(a){var b=a.get("time_limited");return((b)?"Offer Expires: "+a.get("expiry_date"):"");},getDisclaimer:function(a){var c=(a.get("quantity_limited"))?"<b>Quantity : "+a.get("quantity")+"</b><br/>":"Limited Quantities. ";var b=a.getMerchant().get("reward_terms")||"";return(c+b);},getPhoto:function(a){return a.getMerchant().get("photo")["thumbnail_medium_url"];},getName:function(a){return a.getMerchant().get("name");}})}]},initialize:function(){this.callParent(arguments);this.updateItem(this.getData());},updateItem:function(c){var e=c.raw;var d=this.query("component[tag=info]")[0];var b=this.query("component[tag=itemPhoto]")[0];var f=this.query("component[tag=title]")[0];var a=this.query("component[tag=itemPoints]")[0];if(e.merchant){d.setData(c);d.show();a.setData({points:0});}else{d.hide();a.setData(e);a.show();}if(e.title){f.setData(e);f.show();}else{f.hide();}b.setData(e);},statics:{getPhoto:function(a){var b=null;switch(a.value){case"earn_points":case"promotion":break;default:b=Genesis.constants.getIconPath("prizewon",a.value);break;}return b;}}});Ext.define("Genesis.model.frontend.MainPage",{extend:"Ext.data.Model",id:"MainPage",config:{fields:["name","photo_url","desc","pageCntlr","subFeature","route","hide"],proxy:{noCache:false,enablePagingParams:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"},type:"ajax",disableCaching:false}}});Ext.define("Genesis.model.UserProfile",{extend:"Ext.data.Model",alternateClassName:"UserProfile",id:"UserProfile",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"}],fields:["gender","birthday","zipcode","created_ts","update_ts","user_id"]},getUser:function(){}});Ext.define("Genesis.model.User",{extend:"Ext.data.Model",requires:["Genesis.model.UserProfile"],alternateClassName:"User",id:"User",config:{hasOne:[{model:"Genesis.model.UserProfile",associationKey:"profile"}],proxy:{type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/users.json",reader:{type:"json"}},fields:["user_id","name","email","facebook_id","photo_url","created_ts","update_ts","profile_id"],idProperty:"user_id"}});Ext.define("Genesis.model.Merchant",{extend:"Ext.data.Model",alternateClassName:"Merchant",id:"Merchant",config:{fields:["id","name","email","photo","alt_photo","account_first_name","account_last_name","phone","auth_code","qr_code","payment_account_id","created_ts","update_ts","type","reward_terms"],idProperty:"id"}});Ext.define("Genesis.model.Challenge",{extend:"Ext.data.Model",id:"Challenge",alternateClassName:"Challenge",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],fields:["id","type","name","description","require_verif","data","points","created_ts","update_ts","photo","merchant_id","venue_id"],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetChallengesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/challenges":Ext.Loader.getPath("Genesis")+"/store/challenges.json");},setCompleteChallengeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/"+a+"/complete");},setCompleteReferralChallengeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/complete_referral");},setSendReferralsUrl:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/"+a+"/start");}}});Ext.define("Genesis.model.Checkin",{extend:"Ext.data.Model",alternateClassName:"Checkin",id:"Checkin",config:{identifier:"uuid",belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"},{model:"Genesis.model.Venue",getterName:"getVenue",setterName:"setVenue"}],fields:["id","time"]}});Ext.define("Genesis.model.PurchaseReward",{extend:"Ext.data.Model",id:"PurchaseReward",alternateClassName:"PurchaseReward",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"},listeners:{metachange:function(d,b,c){var a=_application.getController("client.Rewards");a.fireEvent("updatemetadata",b);}}},fields:["id","title","points","type","photo","created_ts","update_ts"]},getMerchant:function(){},statics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/purchase_rewards":Ext.Loader.getPath("Genesis")+"/store/rewards.json");},setEarnPointsURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/purchase_rewards/earn");},}});Ext.define("Genesis.model.CustomerReward",{extend:"Ext.data.Model",id:"CustomerReward",alternateClassName:"CustomerReward",config:{fields:["id","title","points","type","photo","quantity_limited","quantity","time_limited",{name:"expiry_date",type:"date",convert:function(a,b){a=Date.parse(a,"yyyy-MM-dd");return(a)?Genesis.fn.convertDateNoTimeNoWeek(a):null;}}],idProperty:"id",belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/customer_rewards?mode=reward":Ext.Loader.getPath("Genesis")+"/store/redemptions.json");},setRedeemPointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customer_rewards/"+a+"/redeem?mode=reward");},setGetPrizesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/customer_rewards?mode=prize":Ext.Loader.getPath("Genesis")+"/store/redemptions.json");},setRedeemPrizePointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customer_rewards/"+a+"/redeem?mode=prize");}}});Ext.define("Genesis.model.Venue",{extend:"Ext.data.Model",requires:["Genesis.model.Challenge","Genesis.model.PurchaseReward","Genesis.model.CustomerReward"],alternateClassName:"Venue",id:"Venue",config:{fields:["id","name","address","description","distance","city","state","country","zipcode","phone","website","latitude","longitude","created_ts","update_ts","type","merchant_id","prize_jackpots"],belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"}],hasMany:[{model:"Genesis.model.Challenge",name:"challenges"},{model:"Genesis.model.PurchaseReward",name:"purchaseReward"},{model:"Genesis.model.CustomerReward",name:"customerReward"}],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}},idProperty:"id",},statics:{setFindNearestURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_nearest":Ext.Loader.getPath("Genesis")+"/store/checkinRecords.json");},setGetClosestVenueURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_closest":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setSharePhotoURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/share_photo":Ext.Loader.getPath("Genesis")+"/store/sharePhoto.json");},setGetLicenseKeyURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/venues/updateLicenseKey");}}});Ext.define("Genesis.model.CustomerJSON",{extend:"Ext.data.Model",alternateClassName:"CustomerJSON",id:"CustomerJSON",config:{proxy:{type:"localstorage",id:"CustomerJSON",writer:{type:"json"},reader:{type:"json"}},identifier:"uuid",fields:["json","id"],idProperty:"id"}});Ext.define("Genesis.model.Customer",{extend:"Ext.data.Model",requires:["Genesis.model.Checkin","Genesis.model.Merchant"],alternateClassName:"Customer",id:"Customer",config:{belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",name:"merchant",setterName:"setMerchant",getterName:"getMerchant",},{model:"Genesis.model.User",associationKey:"user",name:"user",getterName:"getUser",setterName:"setUser"}],hasOne:[{model:"Genesis.model.Checkin",associationKey:"last_check_in",name:"last_check_in",getterName:"getLastCheckin",setterName:"setLastCheckin"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["id","points","prize_points","visits","next_badge_visits","eligible_for_reward","eligible_for_prize","badge_id","next_badge_id"],idProperty:"id"},getUser:function(){},statics:{isValid:function(a){return a!=0;},updateCustomer:function(d,l){var f,k=false;d.beginEdit();for(var g=0;g<d.fields.length;g++){f=d.fields.items[g].getName();if(d.get(f)!=l.get(f)){d.set(f,l.get(f));k=true;}}try{if(d.getLastCheckin()!=l.getLastCheckin()){d.setLastCheckin(l.getLastCheckin());k=true;}}catch(h){d.setLastCheckin(Ext.create("Genesis.model.Checkin"));k=true;}var b=d.getMerchant()||"";var j=l.getMerchant()||"";var a=b.toString();var c=j.toString();if((a!=c)&&(c!="")){d.handleInlineAssociationData({merchant:j.raw});k=true;}d.endEdit();return k;},setFbLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens/create_from_facebook":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setLogoutUrl:function(a){this.getProxy().setActionMethods({read:"DELETE"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/tokens/"+a);},setCreateAccountUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/sign_up":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setVenueScanCheckinUrl:function(){this.setVenueCheckinUrl();},setVenueCheckinUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/check_ins":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setVenueExploreUrl:function(a){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/"+a+"/explore":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setSendPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customers/transfer_points");},setRecvPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customers/receive_points");}}});Ext.define("Genesis.model.frontend.Account",{extend:"Ext.data.Model",alternateClassName:"Account",id:"Account",config:{fields:["name","username","password"],validations:[{type:"format",field:"name",matcher:/^([a-zA-Z'-]+\s+){1,4}[a-zA-z'-]+$/},{type:"email",field:"username"},{type:"length",field:"password",min:6}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"},listeners:{metachange:function(d,b,c){var a=_application.getController("Viewport");a.fireEvent("updatemetadata",b);}}}},statics:{setUpdateFbLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/account/update_facebook_info");},setPasswdResetUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/account/reset_password");},setPasswdChangeUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/account/change_password");},setRefreshCsrfTokenUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/tokens/get_csrf_token");}}});Ext.define("Genesis.model.frontend.Signin",{extend:"Ext.data.Model",alternateClassName:"Signin",id:"Sigin",config:{fields:["username","password"],validations:[{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.model.frontend.ChangePassword",{extend:"Ext.data.Model",alternateClassName:"ChangePassword",id:"ChangePassword",config:{fields:["oldpassword","newpassword"],validations:[{type:"length",field:"oldpassword",min:6},{type:"length",field:"newpassword",min:6}]}});Ext.define("Genesis.view.ViewBase",{extend:"Ext.Container",xtype:"viewbase",statics:{generateTitleBarConfig:function(){return({xtype:"titlebar",docked:"top",tag:"navigationBarTop",cls:"navigationBarTop",masked:{xtype:"mask",transparent:true},defaults:{iconMask:true}});},invisibleMask:{xtype:"mask",transparent:true}},config:{preRender:null},initialize:function(){this.callParent(arguments);this.setPreRender([]);},cleanView:function(){this.fireEvent("cleanView",this);},removeAll:function(a,b){var c=this.callParent(arguments);this.setPreRender([]);return c;},createView:function(){this.fireEvent("createView",this);return(this.getPreRender().length==0);},showView:function(){if(this.getInnerItems().length==0){this.add(this.getPreRender());}Ext.defer(this.fireEvent,0.01*1000,this,["showView",this]);}});Ext.define("Genesis.view.Document",{extend:"Genesis.view.ViewBase",xtype:"documentview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"container",tag:"content",scrollable:"vertical",padding:"0.7 0.8",defaultUnit:"em",html:" "}]},disableAnimation:true,setHtml:function(b){var c=this.query("container[tag=content]")[0];var a=c.getScrollable();c.setHtml(b);if(a){a.getScroller().scrollTo(0,0);}},createView:function(){if(!this.callParent(arguments)){return;}}});Ext.define("Genesis.view.MultipartDocument",{requires:["Ext.tab.Panel"],extend:"Genesis.view.ViewBase",xtype:"multipartdocumentview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"tabpanel",defaults:{xtype:"container",scrollable:"vertical",padding:"0.7 0.8",defaultUnit:"em",html:" "},layout:"card",tabBarPosition:"top",tabBar:{layout:{pack:"justify"}}}]},disableAnimation:true,setHtml:function(b,d){var e=this.query("tabpanel")[0];var c=e.getInnerItems()[b];if(!c){c=e.insert(b,Ext.apply({xtype:"container"},d));}else{var a=c.getScrollable();a.getScroller().scrollTo(0,0);c.setHtml(html);}},createView:function(){if(!this.callParent(arguments)){return;}}});Ext.define("Genesis.view.Viewport",{extend:"Ext.Container",requires:["Ext.fx.layout.Card","Genesis.view.ViewBase"],xtype:"viewportview",config:{autoDestroy:false,cls:"viewport",layout:{type:"card",animation:{type:"cover",reverse:false,direction:"left"}},fullscreen:true},loadingMsg:"Loading ...",initialize:function(){this.callParent(arguments);},animateActiveItem:function(c,b){var e=this.getLayout(),i=(e.getAnimation)?e.getAnimation():null;var j=this.getActiveItem();var h=(c.disableAnimation||((j)?j.disableAnimation:false));var g,f=_application.getController("Viewport");if(this.activeItemAnimation){this.activeItemAnimation.destroy();}this.activeItemAnimation=b=new Ext.fx.layout.Card(b);console.debug("Activate View ["+c._itemId+"]");if(b&&e.isCard&&!h){b.setLayout(e);if(i){var d=_application.getController("Viewport").getEventDispatcher().controller;i.disable();d.pause();c.createView();b.on("animationend",function(){console.debug("Animation Complete");i.enable();b.destroy();delete this.activeItemAnimation;if(j){j.cleanView(c);g=j.query("titlebar")[0];if(g){g.setMasked(Genesis.view.ViewBase.invisibleMask);}}c.showView();g=c.query("titlebar")[0];if(g){g.setMasked(null);}d.resume();f.popViewInProgress=false;},this);}else{}}if(i&&h){i.disable();}var a=this.setActiveItem(c);if(!e.isCard||h){if(i){i.enable();}b.destroy();if(j){j.cleanView(c);var g=j.query("titlebar")[0];if(g){g.setMasked(Genesis.view.ViewBase.invisibleMask);}}c.createView();Ext.defer(function(){c.showView();g=c.query("titlebar")[0];if(g){g.setMasked(null);}f.popViewInProgress=false;},0.1*1000,this);}return a;}});Ext.define("Genesis.view.MainPage",{extend:"Genesis.view.ViewBase",requires:["Ext.data.Store","Ext.Carousel","Ext.dataview.DataView","Ext.XTemplate","Ext.Toolbar"],alias:"widget.mainpageview",config:{layout:"fit",cls:"viewport",listeners:[{element:"element",delegate:"div.itemWrapper",event:"tap",fn:"onItemTap"}],scrollable:undefined,items:(function(){var a=[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{xtype:"titlebar",cls:"navigationBarTop kbTitle",items:[{align:"right",tag:"info",iconCls:"info",destroy:function(){this.actions.destroy();this.callParent(arguments);},handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{defaultUnit:"em",padding:"1em",hideOnMaskTap:false,defaults:{xtype:"button",defaultUnit:"em"},items:[{margin:"0 0 0.5 0",text:"Logout",tag:"logout"},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",scope:this,handler:function(){this.actions.hide();}}]});Ext.Viewport.add(this.actions);}this.actions.show();}}]}),{xtype:"carousel",direction:"horizontal"}];return a;}())},disableAnimation:(!merchantMode)?true:true,initialize:function(){this.setPreRender([]);this.callParent(arguments);},onItemTap:function(f,d,b,a){var c=Ext.create("Genesis.model.frontend.MainPage",Ext.decode(decodeURIComponent(f.delegatedTarget.getAttribute("data"))));_application.getController("MainPage").fireEvent("itemTap",c);},cleanView:function(){var a=this.query("carousel")[0];a.removeAll(true);this.callParent(arguments);},createView:function(){var n=this.query("carousel")[0];var b=_application;var g=b.getController("Viewport");var o=g.getViewport();var l=g.getCheckinInfo().venue!=null;var h=Ext.StoreMgr.get("MainPageStore").getRange();var f=Ext.Array.clone(h);var j=6;if(Ext.os.is("iOS")){if(Ext.os.is.iPhone5||Ext.os.is.iPod5){j=8;}}else{if(Ext.os.is("Android")&&(window.screen.height>480)){if(window.screen.height<=568){j=8;}else{j=10;}}}if(!n._listitems){n._listitems=[];}if(!l){Ext.Array.forEach(f,function(q,i,p){switch(q.get("hide")){case"true":Ext.Array.remove(h,q);break;}});}if((Ext.Array.difference(h,n._listitems).length>0)||(h.length!=n._listitems.length)){n._listitems=h;n.removeAll(true);for(var d=0;d<Math.ceil(h.length/j);d++){n.add({xtype:"component",cls:"mainMenuSelections",tag:"mainMenuSelections",scrollable:undefined,data:Ext.Array.pluck(h.slice(d*j,((d+1)*j)),"data"),tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="itemWrapper x-hasbadge" data="{[this.encodeData(values)]}">',"{[this.isEligible(values)]}",'<div class="photo"><img src="{[this.getPhoto(values.photo_url)]}" /></div>','<div class="photoName">{name}</div>',"</div>","</tpl>",{encodeData:function(i){return encodeURIComponent(Ext.encode(i));},getType:function(){return values.pageCntlr;},isEligible:function(q,t){var u=(q.pageCntlr=="client.Redemptions");var p=(q.pageCntlr=="client.Prizes");var w=false;q.index=t-1;if(u||p){var r=Ext.StoreMgr.get("CustomerStore").getRange();for(var s=0;s<r.length;s++){var v=r[s];if(p){if(v.get("eligible_for_prize")){w=true;break;}}else{if(u){if(v.get("eligible_for_reward")){w=true;break;}}}}}return((u||p)?'<span data="'+q.pageCntlr+'" class="x-badge round '+((w)?"":"x-item-hidden")+'">✔</span>':"");},getPhoto:function(i){return Ext.isEmpty(i)?Ext.BLANK_IMAGE_URL:i;}})});}console.log("MainPage Icons Refreshed.");}else{var m=Ext.StoreMgr.get("CustomerStore").getRange();var a=false;var k=false;for(var d=0;d<m.length;d++){var e=m[d];if(e.get("eligible_for_reward")){a=true;break;}if(e.get("eligible_for_prize")){k=true;break;}}if(n.getInnerItems().length>0){var c=Ext.DomQuery.select("span[data=client.Redemptions]",n.element.dom)[0];if(a){c.innerHTML=count;Ext.fly(c).removeCls("x-item-hidden");}else{if(!c.className.match(/x-item-hidden/)){Ext.fly(c).addCls("x-item-hidden");}}c=Ext.DomQuery.select("span[data=client.Prizes]",n.element.dom)[0];if(k){c.innerHTML=count;Ext.fly(c).removeCls("x-item-hidden");}else{if(!c.className.match(/x-item-hidden/)){Ext.fly(c).addCls("x-item-hidden");}}}console.log("MainPage Icons Not changed.");}delete n._listitems;this.callParent(arguments);},showView:function(){var a=this.query("carousel")[0];if(a.getInnerItems().length>0){a.setActiveItem(0);}this.callParent(arguments);}});Ext.define("Genesis.view.RedeemItemDetail",{extend:"Genesis.view.ViewBase",requires:["Ext.XTemplate","Ext.Carousel","Genesis.view.widgets.RedeemItem"],alias:"widget.redeemitemdetailview",config:{scrollable:undefined,cls:"redeemItemMain viewport",layout:"fit",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Prizes",items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{align:"left",tag:"back",ui:"normal",text:"Back"},{align:"right",tag:"redeem",text:"Redeem"},{align:"right",hidden:true,tag:"done",text:"Done"}]})]},cleanView:function(){this.callParent(arguments);},createView:function(){this.callParent(arguments);},showView:function(){var a=this.query("carousel")[0];if(a){a.setActiveItem(0);}this.getInnerItems()[0].setVisibility(true);this.callParent(arguments);},statics:{getPhoto:function(a){var b=null;switch(a.value){case"earn_points":break;default:b=Genesis.constants.getIconPath("prizewon",a.value);break;}return b;}}});Ext.define("Genesis.view.ShowRedeemItemDetail",{extend:"Genesis.view.ViewBase",requires:["Ext.XTemplate","Genesis.view.widgets.RedeemItem"],alias:"widget.showredeemitemdetailview",config:{scrollable:undefined,cls:"redeemItemMain viewport",layout:{type:"vbox",pack:"center",align:"stretch"},items:[{xtype:"titlebar",docked:"top",tag:"navigationBarTop",cls:"navigationBarTop",title:"Prizes",defaults:{iconMask:true},items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{align:"right",tag:"redeem",text:"Redeem"},{align:"right",hidden:true,tag:"done",text:"Done"}]},{docked:"bottom",xtype:"button",margin:"0.8 0.7",defaultUnit:"em",tag:"refresh",text:"Refresh",ui:"orange-large"},{docked:"bottom",margin:"0.8 0.7",defaultUnit:"em",xtype:"button",cls:"separator",tag:"verify",text:"Verified!",ui:"orange-large"}]},cleanView:function(){this.callParent(arguments);},createView:function(){if(!this.callParent(arguments)&&(this.getInnerItems().length>0)){this.getInnerItems()[0].updateItem(this.redeemItem);delete this.redeemItem;return;}this.setPreRender([{flex:1,xtype:"redeemitem",data:this.redeemItem}]);delete this.redeemItem;}});Ext.define("Genesis.view.PromotionItem",{extend:"Genesis.view.ShowRedeemItemDetail",alias:"widget.promotionalitemview",config:{scrollable:undefined,cls:"redeemItemMain viewport",layout:"fit",items:[{xtype:"titlebar",docked:"top",tag:"navigationBarTop",cls:"navigationBarTop",title:" ",defaults:{iconMask:true},items:[{align:"left",hidden:true,tag:"back",ui:"normal",text:"Back"},{align:"right",tag:"done",text:"Done"}]}]}});Ext.define("Genesis.view.server.SettingsPage",{extend:"Ext.form.Panel",requires:["Ext.dataview.List","Ext.XTemplate","Genesis.view.widgets.ListField"],alias:"widget.serversettingspageview",config:{preRender:null,cls:"viewport",scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Settings",items:[{align:"left",tag:"back",ui:"normal",text:"Back"}]}),{xtype:"fieldset",title:"About Kickbak",items:[{xtype:"textfield",value:"Version "+Genesis.constants.serverVersion,readOnly:true},{xtype:"listfield",name:"license",value:"Refresh License Key"}]},{xtype:"fieldset",title:"Merchant Device",items:[{xtype:"textfield",tag:"merchantDevice",readOnly:true}]}]},initialize:function(){this.callParent(arguments);this.setPreRender([]);},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments);},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments);},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments);},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments);}});Ext.define("Genesis.view.server.Rewards",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar","Ext.field.Text"],alias:"widget.serverrewardsview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{tag:"navigationBarTop",cls:"navigationBarTop kbTitle",title:" ",items:[{align:"left",tag:"back",ui:"normal",text:"Back"}]})]},createView:function(){if(!this.callParent(arguments)){return;}this.getPreRender().push(Ext.create("Ext.Container",{xtype:"container",tag:"rewards",cls:"rewardsServerMain",layout:{type:"card",animation:{duration:600,easing:"ease-in-out",type:"slide",direction:"down"}},activeItem:0,items:[{xtype:"container",tag:"rewardsMainCalculator",cls:"rewardsMainCalculator",layout:"fit",items:[{docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Amount Spent"},{xtype:"spacer",align:"right"}]},{docked:"top",xtype:"textfield",name:"price",clearIcon:false,placeHolder:"0",readOnly:true,required:true,cls:"rewardsCalculator"},{xtype:"container",layout:"vbox",tag:"dialpad",cls:"dialpad",defaults:{xtype:"container",layout:"hbox",flex:1,defaults:{xtype:"button",flex:1}},items:[{items:[{text:"1"},{text:"2"},{text:"3"}]},{items:[{text:"4"},{text:"5"},{text:"6"}]},{items:[{text:"7"},{text:"8"},{text:"9"}]},{items:[{text:"AC"},{flex:2,text:"0"}]}]},{docked:"bottom",xtype:"button",cls:"separator",tag:"showQrCode",text:"Show QRCode",ui:"orange-large"}]},{xtype:"container",tag:"qrcodeContainer",cls:"qrcodeContainer",layout:"fit",items:[{docked:"top",xtype:"component",tag:"title",width:"100%",cls:"title",defaultUnit:"em",tpl:Ext.create("Ext.XTemplate","{[this.getPrice(values)]}",{getPrice:function(a){return a.price;}})},{xtype:"component",tag:"qrcode",cls:"qrcode"},{docked:"bottom",xtype:"button",cls:"separator done",tag:"done",text:"Done",ui:"orange-large"}]}]}));},statics:{getPhoto:function(a){var b=null;switch(a.value){case"vip":b=Genesis.constants.getIconPath("miscicons",a.value);break;default:b=Genesis.constants.getIconPath("prizewon",a.value);break;}return b;}}});Ext.define("Genesis.view.server.Redemptions",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar"],alias:"widget.serverredemptionsview",config:{scrollable:"vertical",cls:"redemptionsMain",layout:"vbox"},statics:{getPhoto:function(a){var b=null;switch(a.value){default:b=Genesis.constants.getIconPath("prizewon",a.value);break;}return b;}}});Ext.define("Genesis.controller.ControllerBase",{extend:"Ext.app.Controller",requires:["Ext.data.Store","Ext.util.Geolocation"],config:{animationMode:null,},checkinMsg:"Checking in ...",loadingScannerMsg:"Loading Scanner ...",loadingMsg:"Loading ...",genQRCodeMsg:"Generating QRCode ...",missingLicenseKeyMsg:'License Key for this Device is missing. Press "Procced" to Scan the License Key into the device.',retrieveAuthModeMsg:"Retrieving Authorization Code from Server ...",noCodeScannedMsg:"No Authorization Code was Scanned!",lostNetworkConnectionMsg:"You have lost network connectivity",backToMerchantPageMsg:function(a){return("Would you like to visit our Main Page?");},geoLocationErrorMsg:function(){var a="Your current location is unavailable. ";if(Ext.os.is("Android")){a+='Enable Location Services under Main Screen of your phone: "Settings App >> Location Services >> GPS satellites"';}else{if(Ext.os.is("iOS")){a+=((Ext.os.version.isLessThan("6.0"))?'Enable Location Services under Main Screen of your phone: "Settings App >> Location Services >> KICKBAK"':'Enable Location Services under Main Screen of your phone: "Settings App >> Privacy >> Location Services >> KICKBAK"');}else{a+='Enable Location Services under Main Screen of your phone: "Settings App >> Location Services"';}}return a;},geoLocationTimeoutErrorMsg:"Cannot locate your current location. Try again or enable permission to do so!",geoLocationPermissionErrorMsg:"No permission to location current location. Please enable permission to do so!",geoLocationUnavailableMsg:"We are not able to locate your GPS coordinates",geoLocationUseLastPositionMsg:"We are not able to locate your current location. Using your last known GPS Coordinates ...",getMerchantInfoMsg:"Retrieving Merchant Information ...",getVenueInfoMsg:"Retrieving Venue Information ...",missingVenueInfoMsg:function(b){var a="";if(Ext.isString(b)){a=Genesis.constants.addCRLF()+b;}else{if(Ext.isObject(b)){a=Genesis.constants.addCRLF()+b.statusText;}}return("Error loading Venue information."+a);},showToServerMsg:"Show this to your merchant before proceeding.",errProcQRCodeMsg:"Error Processing Authentication Code",cameraAccessMsg:"Accessing your Camera Phone ...",updatingServerMsg:"Updating Server ...",referredByFriendsMsg:function(a){return"Have you been referred "+Genesis.constants.addCRLF()+"by a friend to visit"+Genesis.constants.addCRLF()+a+"?";},recvReferralb4VisitMsg:function(a){return"Claim your reward points by becoming a customer at "+Genesis.constants.addCRLF()+a+"!";},showScreenTimeoutExpireMsg:function(a){return a+" are up! Press OK to confirm.";},showScreenTimeoutMsg:function(a){return"You have "+a+" to show this screen to a employee before it disappears!";},uploadFbMsg:"Uploading to Facebook ...",uploadServerMsg:"Uploading to server ...",statics:{animationMode:{cover:{type:"cover",direction:"left",duration:400},coverUp:{type:"cover",direction:"up",duration:400},slide:{type:"slide",direction:"left",duration:400},slideUp:{type:"slide",direction:"up",duration:400},pop:{type:"pop",duration:400},flip:{type:"flip",duration:400},fade:{type:"fade",duration:400}},playSoundFile:function(b,a,c){if(Genesis.constants.isNative()){switch(b.type){case"FX":case"Audio":LowLatencyAudio.play(b.name,a||Ext.emptyFn,c||Ext.emptyFn);break;case"Media":b.successCallback=a||Ext.emptyFn;b.name.play();break;}}else{b.successCallback=a||Ext.emptyFn;Ext.get(b.name).dom.play();}},stopSoundFile:function(a){if(Genesis.constants.isNative()){LowLatencyAudio.stop(a.name);}else{var b=Ext.get(a.name).dom;b.pause();b.currentTime=0;}},genQRCodeFromParams:function(c,d,h){var i=this;var f;GibberishAES.size(256);var j=Genesis.constants.getPrivKey();var b,a;for(key in j){switch(d){case"prize":a=key.split("r")[1];break;case"reward":case"challenge":a=key.split("v")[1];break;default:veuneId=0;break;}if(a>0){try{b=new Date().addHours(3);f=GibberishAES.enc(Ext.encode(Ext.applyIf({expiry_ts:b.getTime()},c)),j[key]);switch(d){case"prize":case"reward":f=a+"$"+f;break;default:break;}}catch(g){}console.debug("Used key["+j[key]+"]");break;}}if(a>0){console.log("\nEncrypted Code Length: "+f.length+"\nEncrypted Code ["+f+"]\nExpiry Date: ["+b+"]");return(h)?[f,0,0]:i.genQRCode(f);}Ext.device.Notification.show({title:"Missing License Key!",message:i.prototype.missingLicenseKeyMsg,buttons:["Proceed","Cancel"],callback:function(e){if(e.toLowerCase()=="proceed"){_application.getController("Settings").fireEvent("upgradeDevice");}}});return(h)?["",0,0]:"";},genQRCode:function(e,c,f){c=c||3;f=f||10;var d=0;var b=QRCode(f,"L");b.addData(e);b.make();var a=b.createBase64(c,d);console.log("QR Code Minimum Size = ["+a[1]+"x"+a[1]+"]");return[a[0],a[1],a[1]];},genQRCodeInlineImg:function(e,c,f){c=c||4;f=f||8;var d=0;var a=QRCode(f,"L");a.addData(e);a.make();var b=a.createTableTag(c,d);return b;}},init:function(){this.callParent(arguments);this.on({scope:this,scannedqrcode:this.onScannedQRcode,locationupdate:this.onLocationUpdate,openpage:this.onOpenPage,updatemetadata:this.updateMetaDataInfo,triggerCallbacksChain:this.triggerCallbacksChain});var a=this.getViewPortCntlr();if(a!=this){a.relayEvents(this,["pushview","popview","silentpopview","resetview"]);a.on("animationCompleted",this.onAnimationCompleted,this);}},getViewPortCntlr:function(){return this.getApplication().getController("Viewport");},getViewport:function(){return this.getViewPortCntlr().getView();},getMainPage:Ext.emptyFn,openMainPage:Ext.emptyFn,openPage:Ext.emptyFn,goToMain:function(){var b=this;var a=b.getViewPortCntlr();a.setLoggedIn(true);b.resetView();b.redirectTo("main");console.log("LoggedIn, Going to Main Page ...");},goToMerchantMain:function(d){var b=this;var a=b.getViewPortCntlr();var c=a.getCheckinInfo();var e=function(){b.resetView();if(c.venue){b.redirectTo("venue/"+c.venue.getId()+"/"+c.customer.getId()+"/1");}else{b.redirectTo("checkin");}};if(c.venue&&!d){Ext.device.Notification.show({title:c.venue.get("name").trunc(16),buttons:["OK","Cancel"],message:b.backToMerchantPageMsg(c.venue),callback:function(f){if(f.toLowerCase()=="ok"){e();}}});}else{e();}},isOpenAllowed:function(){return"Cannot Open Folder";},onScannedQRcode:Ext.emptyFn,onLocationUpdate:Ext.emptyFn,onCompleteRefreshCSRF:Ext.emptyFn,onOpenPage:function(e,c,b,d,f){if((appName=="GetKickBak")&&!Ext.device.Connection.isOnline()&&(e!="MainPage")){var a=me.getViewPortCntlr();if(!offlineDialogShown){Ext.device.Notification.show({title:"Network Error",message:me.lostNetworkConnectionMsg,callback:function(){offlineDialogShown=false;}});offlineDialogShown=true;}console.debug("Network Error - "+e+","+c);me.resetView();me.redirectTo(a.getLoggedIn()?"checkin":"login");return;}var g=this.getApplication();controller=g.getController(e);if(!c){controller.openMainPage();}else{controller.openPage(c,b);}},triggerCallbacksChain:function(){var c=this;var d=c.callBackStack.startIndex;var b=c.callBackStack.callbacks.length;for(var a=d;a<b;a++){c.callBackStack.startIndex++;if(c[c.callBackStack.callbacks[a]].apply(c,c.callBackStack["arguments"])){break;}}if(a>=b){console.debug("Clear Callback Chain["+a+"].");c.callBackStack.startIndex=0;c.callBackStack["arguments"]=[];}},updateBadges:function(a){var c=this;var b=Ext.StoreMgr.get("BadgeStore");if(a){b.setData(a);}},updateAccountInfo:function(a,b){var k=this;var f=false;var h=k.getViewPortCntlr();var o=Ext.StoreMgr.get("BadgeStore");var c=Ext.StoreMgr.get("CustomerStore");var g=h.getCustomer();var n=a.customer_id||((g)?g.getId():0);if(n>0){console.debug("updateAccountInfo - customerId["+n+"]");g=c.getById(n);if(g){g.beginEdit();if(b){if(Ext.isDefined(b.points)){g.set("points",b.points);}if(Ext.isDefined(b.prize_points)){g.set("prize_points",b.prize_points);}if(Ext.isDefined(b.visits)){g.set("visits",b.visits);}if(Ext.isDefined(b.next_badge_visits)){g.set("next_badge_visits",b.next_badge_visits);}var m=[{id:b.badge_id,prefix:"Customer's Current Badge is - [",badgeId:"badge_id"},{id:b.next_badge_id,prefix:"Customer's Next Badge is - [",badgeId:"next_badge_id"}];for(var e=0;e<m.length;e++){if(Ext.isDefined(m[e].id)){var j=o.getById(m[e].id);console.debug(m[e].prefix+j.get("type").display_value+"/"+j.get("visits")+"]");g.set(m[e].badgeId,m[e].id);}}var l=b.eligible_for_reward;if(Ext.isDefined(l)){g.set("eligible_for_reward",l);}var d=b.eligible_for_prize;if(Ext.isDefined(d)){g.set("eligible_for_prize",d);}}g.endEdit();k.persistSyncStores("CustomerStore");}}return g;},updateRewards:function(f){if(f&&(f.length>0)){var d=this;var b=d.getViewPortCntlr();var e=b.getVenue().getMerchant();console.debug("Total Redemption Rewards - "+f.length);for(var c=0;c<f.length;c++){f[c]["merchant"]=e;}var a=Ext.StoreMgr.get("RedeemStore");a.setData(f);}},updatePrizes:function(b){if(b&&(b.length>0)){var e=this;var a=e.getViewPortCntlr();var f=a.getVenue().getMerchant();console.debug("Total Redemption Prizes - "+b.length);for(var d=0;d<b.length;d++){b[d]["merchant"]=f;}var c=Ext.StoreMgr.get("PrizeStore");c.setData(b);}},updateNews:function(b){if(b&&(b.length>0)){console.debug("Total News Items - "+b.length);var a=Ext.StoreMgr.get("NewsStore");a.setData(b);}},updateAuthCode:function(b,e){var c=this,d=false;if(b){var a=Genesis.db.getLocalDB();if((b!=a.auth_code)||(e!=a.csrf_code)){a.auth_code=b;a.csrf_code=e;Genesis.db.setLocalDB(a);}console.debug("\nauth_code ["+b+"]\ncsrf_code ["+e+"]\ncurrFbId ["+a.currFbId+"]");if(!a.last_check_in){c.redirectTo("checkin");}d=true;}return d;},updateMetaDataInfo:function(b){var j=this;var h=null;var i=j.getViewPortCntlr();var f=Ext.StoreMgr.get("CheckinExploreStore");try{if(j.updateAuthCode(b.auth_token,b.csrf_token)){return;}j.updateBadges(b.badges);h=j.updateAccountInfo(b,b.account_info);var c=b.venue_id||((f.first())?f.first().getId():0);venue=f.getById(c)||i.getVenue();if(Ext.isDefined(b.venue)){venue=Ext.create("Genesis.model.Venue",b.venue);var d=j.getApplication().getController("client.Checkins");var a=b.prize_jackpots;if(a>=0){console.debug("Prize Jackpots won by customers at this merchant this month - ["+a+"]");venue.set("prize_jackpots",a);}console.debug("customer_id - "+h.getId()+"\nmerchant_id - "+venue.getMerchant().getId()+"\n");d.fireEvent("setupCheckinInfo","checkin",venue,h,b);}else{var a=b.prize_jackpots;if(a>=0){console.debug("Prize Jackpots won by customers at this merchant this month - ["+a+"]");venue.set("prize_jackpots",a);}}j.updateRewards(b.rewards);j.updatePrizes(b.prizes);j.updateNews(b.newsfeed);}catch(g){console.debug("updateMetaDataInfo Exception - "+g);}return h;},checkReferralPrompt:function(a,d){var g=this;var f=g.getViewPortCntlr();var e=f.getCustomer();var b=f.getVenue().getMerchant();var h=b.getId();var i=a||Ext.emptyFn;var c=d||Ext.emptyFn;if(Customer.isValid(e.getId())&&(e.get("visits")<2)&&(!Genesis.db.getReferralDBAttrib("m"+h))){console.debug("Customer Visit Count["+e.get("visits")+"]");Ext.device.Notification.show({title:"Referral Challenge",message:g.referredByFriendsMsg(b.get("name")),buttons:["Yes","No"],callback:function(j){if(j.toLowerCase()=="yes"){Ext.defer(function(){g.fireEvent("openpage","client.Challenges","referrals",i);},1,g);}else{c();}}});}else{c();}},persistStore:function(b){var a={CustomerStore:[Ext.StoreMgr.get("PersistentCustomerStore"),"CustomerStore","CustomerJSON"]};for(var c in a){if(!a[c][0]){Ext.regStore("Persistent"+a[c][1],{model:"Genesis.model."+a[c][2],autoLoad:false});a[c][0]=Ext.StoreMgr.get("Persistent"+a[c][1]);}}return a[b][0];},persistLoadStores:function(d){var b=[[this.persistStore("CustomerStore"),"CustomerStore",1]];var a=0;d=d||Ext.emptyFn;for(var c=0;c<b.length;c++){b[c][0].load({callback:function(i,g){var f=[];if(g.wasSuccessful()){var h=Ext.StoreMgr.get(b[c][1]);h.removeAll();for(var e=0;e<i.length;e++){f.push(i[e].get("json"));}h.setData(f);console.debug("Restored "+i.length+" records to "+b[c][1]+" ...");}else{console.debug("Error Restoring "+b[c][1]+" ...");}d();}});}},persistSyncStores:function(d,g){var b=[[this.persistStore("CustomerStore"),"CustomerStore",1]];for(var f=0;f<b.length;f++){if(!d||(b[f][1]==d)){b[f][0].removeAll();if(!g){var c=Ext.StoreMgr.get(b[f][1]).getRange();for(var a=0;a<c.length;a++){var e=c[a].getData(true);b[f][0].add({json:e});}}b[f][0].sync();console.debug("Synced "+b[f][1]+" ... ");}}},resetView:function(a){this.fireEvent("resetview");},pushView:function(a){this.fireEvent("pushview",a,this.getAnimationMode());},silentPopView:function(a){this.fireEvent("silentpopview",a);},popView:function(){this.fireEvent("popview");},getGeoLocation:function(c){var f=this;var e=c||0;var b=f.getViewPortCntlr();var d={autoUpdate:false,maximumAge:30000,timeout:10000,allowHighAccuracy:true,enableHighAccuracy:true};console.debug("Getting GeoLocation ...");if(!Genesis.constants.isNative()){f.fireEvent("locationupdate",{coords:{getLatitude:function(){return"-50.000000";},getLongitude:function(){return"50.000000";}}});return;}var a=function(j,i){if(!j){console.log("No GeoLocation found!");return;}var h={coords:j};console.debug("\nLatitude: "+j.getLatitude()+"\nLongitude: "+j.getLongitude()+"\nAltitude: "+j.getAltitude()+"\nAccuracy: "+j.getAccuracy()+"\nAltitude Accuracy: "+j.getAltitudeAccuracy()+"\nHeading: "+j.getHeading()+"\nSpeed: "+j.getSpeed()+"\nTimestamp: "+new Date(j.getTimestamp())+"\n");b.setLastPosition(h);f.fireEvent("locationupdate",h);};var g=function(l,h,i,k,j){console.debug("GeoLocation Error["+j+"]");Ext.Viewport.setMasked(null);if(i){console.debug("PERMISSION_DENIED");Ext.device.Notification.show({title:"Permission Error",message:(b.getLastPosition())?f.geoLocationUseLastPositionMsg:f.geoLocationUnavailableMsg,callback:function(){if(b.getLastPosition()){f.fireEvent("locationupdate",b.getLastPosition());return;}if(Ext.os.is("Android")){navigator.app.exitApp();}}});}else{if(h){console.debug("TIMEOUT");Ext.device.Notification.show({title:"Timeout Error",message:(b.getLastPosition())?f.geoLocationUseLastPositionMsg:f.geoLocationTimeoutErrorMsg,callback:function(){if(b.getLastPosition()){f.fireEvent("locationupdate",b.getLastPosition());}}});}else{if(k){if(e<3){console.debug("Retry #"+e);Ext.defer(f.getGeoLocation,1*1000,f,[++e]);}else{console.debug("POSITION_UNAVAILABLE");Ext.device.Notification.show({title:"Location Services",message:(b.getLastPosition())?f.geoLocationUseLastPositionMsg:f.geoLocationUnavailableMsg,callback:function(){if(b.getLastPosition()){f.fireEvent("locationupdate",b.getLastPosition());return;}if(Ext.os.is("Android")){navigator.app.exitApp();}}});}}else{console.debug("PERMISSION ERROR");Ext.device.Notification.show({title:"Location Services",message:f.geoLocationErrorMsg(),callback:function(){if(Ext.os.is("Android")){navigator.app.exitApp();}}});}}}};if(!f.geoLocation){f.geoLocation=Ext.create("Ext.util.Geolocation",Ext.applyIf({listeners:{locationupdate:a,locationerror:function(l,h,i,k,j){if(h&&(e<4)){e=4;f.getGeoLocation(e);}else{g(l,h,i,k,j);}}}},d));}f.geoLocation.updateLocation(null,null,(e>=4)?Ext.applyIf({allowHighAccuracy:false,enableHighAccuracy:false},d):d);},scanQRCode:function(){var b=this;var e=function(f){var g;Ext.Viewport.setMasked(null);if(Genesis.constants.isNative()){switch(window.plugins.qrCodeReader.scanType){case"RL":g=(f.response==undefined)?"":(f.response||"");console.debug("QR Code RL  = "+g);break;case"Nigma":g=(f.response==undefined)?"":(f.response||"");if(!g){console.debug("QR Code Nigma = Empty");}else{console.debug("QR Code Nigma = "+((g.responseCode)?g.responseCode:"NONE")+" Sent = "+g.bytesSent+" bytes");}if(g&&g.responseCode){g=g.responseCode;}break;case"Default":g=f;if(!g||g.format!="QR_CODE"){g=null;console.debug("QR Code Default = Unsupported Code");if(device.platform.match(/simulator/i)){g=Math.random().toFixed(16);}}else{if(g.cancelled){g=Math.random().toFixed(16);}else{g=g.text;}}console.debug("QR Code Default = "+((g)?g:"NONE"));break;}}else{g=f.response;console.debug("QR Code = "+g);}Ext.device.Notification.beep();b.fireEvent("scannedqrcode",g);};var a=function(f){Ext.Viewport.setMasked(null);console.debug("Failed because: "+f);Ext.device.Notification.beep();b.fireEvent("scannedqrcode",null);};console.debug("Scanning QR Code ...");if(!Genesis.constants.isNative()){var d="0";if(!merchantMode){var c=b.getViewPortCntlr().getVenue()||Ext.StoreMgr.get("CheckinExploreStore").first()||null;d=c?c.getId():"0";}e({response:d});}else{Ext.Viewport.setMasked({xtype:"loadmask",message:b.loadingScannerMsg});window.plugins.qrCodeReader.getCode(e,a);}}});Ext.define("Genesis.controller.Viewport",{extend:"Genesis.controller.ControllerBase",statics:{},config:{sound_files:null,loggedIn:false,customer:null,venue:null,metaData:null,checkinInfo:{venue:null,customer:null,metaData:null},lastPosition:null,refs:{view:"viewportview",backButton:"button[tag=back]",closeButton:"button[tag=close]",shareBtn:"button[tag=shareBtn]",emailShareBtn:"actionsheet button[tag=emailShareBtn]",fbShareBtn:"actionsheet button[tag=fbShareBtn]",checkInNowBtn:"button[tag=checkInNow]"},control:{fbShareBtn:{tap:"onShareMerchantTap"},emailShareBtn:{tap:"onShareEmailTap"},backButton:{tap:"onBackButtonTap"},closeButton:{tap:"onBackButtonTap"},checkInNowBtn:{tap:"onCheckinScanTap"},"tabbar[tag=navigationBarTop] button[tag=info]":{tap:"onInfoTap"},"viewportview button[tag=home]":{tap:"onHomeButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=prizes]":{tap:"onPrizesButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=prizesSC]":{tap:"onRedeemPrizesSCButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=accounts]":{tap:"onAccountsButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=challenges]":{tap:"onChallengesButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=rewards]":{tap:"onRewardsButtonTap"},"viewportview button[tag=rewardsSC]":{tap:"onRewardsSCButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=redemption]":{tap:"onRedemptionsButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=redemptionSC]":{tap:"onRedeemRewardsSCButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=main]":{tap:"onCheckedInAccountTap"},"tabbar[tag=navigationBarBottom] button[tag=checkin]":{tap:"onCheckinTap"},"tabbar[tag=navigationBarBottom] button[tag=browse]":{tap:"onBrowseTap"},view:{activate:"onActivate"},"viewportview dataview[tag=mainMenuSelections]":{select:"onButtonTap"},"viewportview dataview[tag=badgesMenuSelections]":{select:"onButtonTap"},"viewportview dataview[tag=challengeMenuSelections]":{select:"onButtonTap"},"viewportview list[tag=jackpotWinnersList]":{select:"onButtonTap"},"viewportview button":{tap:"onButtonTap"},"actionsheet button":{tap:"onButtonTap"}},listeners:{viewanimend:"onViewAnimEnd",baranimend:{buffer:0.5*1000,fn:"onBarAnimEnd"},completeRefreshCSRF:"onCompleteRefreshCSRF",pushview:"pushView",silentpopview:"silentPopView",popview:"popView",resetview:"resetView"}},mainPageStorePathToken:/\{platform_path\}/mg,popViewInProgress:false,viewStack:[],animationFlag:0,gatherCheckinInfoMsg:"Prepare to scan Authorization Code ...",retrieveChallengesMsg:"Retrieving Challenges ...",fbShareSuccessMsg:"Posted on your Facebook Timeline!",shareReqMsg:function(){return"Would you like to do our"+Genesis.constants.addCRLF()+"Referral Challenge?";},onCompleteRefreshCSRF:Ext.emptyFn,onLocationUpdate:function(a){var d=this;var f=d.getApplication();var b=f.getController("client.Checkins");var e=Ext.StoreMgr.get("CheckinExploreStore");var c=e.getProxy();Venue.setFindNearestURL();e.load({params:{latitude:a.coords.getLatitude(),longitude:a.coords.getLongitude()},callback:function(h,g){if(g.wasSuccessful()){b.setPosition(a);b.fireEvent("checkinScan");}else{c.supressErrorsPopup=true;Ext.device.Notification.show({title:"Error",message:d.missingVenueInfoMsg(g.getError()),callback:function(){c.supressErrorsPopup=false;}});}},scope:d});},onActivate:function(){var c=this;var a=Ext.Loader.getPath("Genesis")+"/store/"+((!merchantMode)?"mainClientPage":"mainServerPage")+".json";var d="";if(Ext.os.is("iOS")){d="";}else{if(Ext.os.is("Android")){d="file:///android_asset/www/";}}a=d+a;console.log("Loading MainPage Store ...");var b=new XMLHttpRequest();b.onreadystatechange=function(){if(b.readyState==4){if(b.status==200||b.status==0){console.log("Loaded MainPage Store ...");var e=Ext.decode(b.responseText.replace(c.mainPageStorePathToken,Genesis.constants._iconPath));Ext.StoreMgr.get("MainPageStore").setData(e.data);}}};b.open("GET",a,true);b.send(null);},onButtonTap:function(a,d,c){Genesis.controller.ControllerBase.playSoundFile(this.sound_files.clickSound);},onBackButtonTap:function(a,d,c){this.popView();},onShareEmailTap:function(a,g,c,f){var d=this;Ext.device.Notification.show({title:"Referral Challenge",message:d.shareReqMsg(),buttons:["Yes","No"],callback:function(b){if(b.toLowerCase()=="yes"){var e=d.getApplication();d.onChallengesButtonTap(null,null,null,null,function(){var m=d.getViewPortCntlr().getVenue();var l=m.getId();var j=m.challenges().getRange();var h=e.getController("client.Challenges");for(var k=0;k<j.length;k++){if(j[k].get("type").value=="referral"){h.selectedItem=j[k];break;}}h.fireEvent("doChallenge");});}}});},onShareMerchantTap:function(a,h,d,g){var f=this;var c=Genesis.constants.site;Genesis.fb.facebook_onLogin(function(i){var e=f.getVenue();var b=e.getMerchant();var j=b.get("photo")["thumbnail_medium_url"];console.log("Posting to Facebook ...");FB.api("/me/feed","post",{name:e.get("name"),link:e.get("website")||c,caption:e.get("website")||c,description:e.get("description"),picture:j,message:"Check out this place!"},function(k){Ext.Viewport.setMasked(null);if(!k||k.error){console.log("Post was not published to Facebook.");}else{console.log(f.fbShareSuccessMsg);Ext.device.Notification.show({title:"Facebook Connect",message:f.fbShareSuccessMsg});}});},true);},onInfoTap:function(a,f,c,d){},onCheckinScanTap:function(a,f,c,g){var d=this;Ext.Viewport.setMasked({xtype:"loadmask",message:d.gatherCheckinInfoMsg});d.getGeoLocation();},onAccountsButtonTap:function(a,f,c,d){this.redirect("accounts");console.log("Going to Accounts Page ...");},onChallengesButtonTap:function(a,h,d,g,j){var f=this;var i=f.getVenue();var c=function(){if(j){j();}else{f.redirectTo("challenges");console.log("Going to Challenges Page ...");}};if(i.challenges().getData().length==0){Ext.Viewport.setMasked({xtype:"loadmask",message:f.retrieveChallengesMsg});Challenge.setGetChallengesURL();Challenge.load(i.getId(),{params:{merchant_id:i.getMerchant().getId(),venue_id:i.getId()},callback:function(b,e){Ext.Viewport.setMasked(null);if(e.wasSuccessful()){i.challenges().add(e.getRecords());c();}}});}else{c();}},onRewardsButtonTap:function(a,f,c,d){this.fireEvent("openpage","client.Rewards","rewards",null);console.log("Going to Client Rewards Page ...");},onRewardsSCButtonTap:function(a,f,c,d){this.fireEvent("openpage","client.Rewards","rewardsSC",null);console.log("Going to Client Rewards Shortcut Page ...");},onRedemptionsButtonTap:function(a,f,c,d){this.redirectTo("redemptions");console.log("Going to Client Redemptions Page ...");},onRedeemRewardsSCButtonTap:function(a,f,c,d){this.redirectTo("redeemRewardsChooseSC");console.log("Going to Client Redeem Rewards Choose Page ...");},onPrizesButtonTap:function(a,f,c,d){this.redirectTo("prizes");console.log("Going to Merchant Prizes Page ...");},onRedeemPrizesSCButtonTap:function(a,f,c,d){this.redirectTo("redeemPrizesChooseSC");console.log("Going to Client Redeem Prizes Choose Page ...");},onHomeButtonTap:function(a,f,c,d){this.resetView();this.redirectTo("main");console.log("Going back to HomePage ...");},onCheckedInAccountTap:function(a,f,c,d){this.goToMerchantMain(true);},onBrowseTap:function(a,f,c,d){this.redirectTo("exploreS");},onCheckinTap:function(a,f,c,d){this.redirectTo("checkin");},resetView:function(){var b=this;var a=b.getViewport();b.viewStack=[];b.getApplication().getHistory().setActions([]);},pushView:function(b,d){var c=this;d=Ext.apply(d,{reverse:false});var a=(c.viewStack.length>1)?c.viewStack[c.viewStack.length-2]:null;if((c.viewStack.length>0)&&(b==c.viewStack[c.viewStack.length-1]["view"])){}else{if(a&&(a.view==b)){c.popView();}else{var e=c.getApplication().getHistory().getActions();c.viewStack.push({view:b,animation:d,url:e[e.length-1].getUrl()});c.getViewport().animateActiveItem(b,d);}}},silentPopView:function(b){var c=this;b=Math.min(c.viewStack.length,b);var d=c.getApplication().getHistory().getActions();if((c.viewStack.length>0)&&(b>0)){while(b-->0){var a=c.viewStack.pop();d.pop();}}},popView:function(){var c=this;var d=c.getApplication().getHistory().getActions();if(c.viewStack.length>1){var a=c.viewStack.pop();var b=c.viewStack[c.viewStack.length-1];if(!c.popViewInProgress){c.popViewInProgress=true;d.pop();if(b.view.isDestroyed){b.view=Ext.create(b.view.alias[0]);}c.getApplication().getHistory().setToken(b.url);window.location.hash=b.url;c.getViewport().animateActiveItem(b.view,Ext.apply(a.animation,{reverse:true}));}}else{c.goToMerchantMain(true);}},init:function(b){var a=this;console.log("Viewport Init");Genesis.constants.init();a.callParent(arguments);if(merchantMode){console.log("Loading License Keys ...");Genesis.constants.getPrivKey();}QRCodeReader.prototype.scanType="Default";console.debug("QRCode Scanner Mode["+QRCodeReader.prototype.scanType+"]");if(!merchantMode){Genesis.fb.initFb();}if(Ext.isDefined(window.device)){console.debug("\ndevice.platform - "+device.platform+"\nBrowser EngineVersion - "+Ext.browser.engineVersion+"");}Ext.defer(function(){this.sound_files={};var c;if(merchantMode){c=[["clickSound","click_sound","FX"],["beepSound","beep.wav","FX"]];}else{c=[["rouletteSpinSound","roulette_spin_sound","Media"],["winPrizeSound","win_prize_sound","Media"],["losePrizeSound","lose_prize_sound","Media"],["promoteSound","promote_sound","FX"],["clickSound","click_sound","FX"],["beepSound","beep.wav","FX"]];}for(var d=0;d<c.length;d++){this.loadSoundFile.apply(this,c[d]);}},1,a);},loadSoundFile:function(a,b,d){var f=this;var c="."+(b.split(".")[1]||"mp3");b=b.split(".")[0];if(Genesis.constants.isNative()){var g=function(){switch(d){case"FX":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,function(){console.debug("loaded "+b);},function(h){console.debug("Audio Error: "+h);});break;case"Audio":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,3,function(){console.debug("loaded "+b);},function(h){console.debug("Audio Error: "+h);});break;}};switch(d){case"Media":b=new Media((Ext.os.is("Android")?"/android_asset/www/":"")+"resources/audio/"+b+c,function(){f.sound_files[a].successCallback();},function(h){f.sound_files[a].successCallback();console.log("Audio Error: "+h);});break;default:LowLatencyAudio.unload(b,g,g);break;}}else{var e=Ext.get(b);if(e){e.dom.addEventListener("ended",function(){f.sound_files[a].successCallback();},false);}}f.sound_files[a]={name:b,type:d};},openMainPage:function(){var c=this;if(!merchantMode){var b=Genesis.db.getLocalDB();var a=(b.auth_code)?true:false;c.resetView();if(a){c.setLoggedIn(a);console.debug("Going to SignIn Page ...");c.redirectTo("signIn");}else{console.debug("Going to Login Page ...");Genesis.db.resetStorage();c.redirectTo("login");}}}});Ext.define("Genesis.controller.Settings",{extend:"Genesis.controller.ControllerBase",statics:{},xtype:"settingsCntlr",config:{termsOfServiceTitle:"Term of Service",privacyTitle:"Privacy",aboutUsTitle:"About Us",licenseTitle:"Refresh License Key",routes:{clientSettings:"clientSettingsPage",serverSettings:"serverSettingsPage",aboutus:"documentPage",privacy:"documentPage",termsOfUse:"multipartDocumentPage"},refs:{clientSettingsPage:{selector:"clientsettingspageview",autoCreate:true,xtype:"clientsettingspageview"},serverSettingsPage:{selector:"serversettingspageview",autoCreate:true,xtype:"serversettingspageview"},documentPage:{selector:"documentview",autoCreate:true,xtype:"documentview"},multipartDocumentPage:{selector:"multipartdocumentview",autoCreate:true,xtype:"multipartdocumentview"},merchantDevice:"serversettingspageview fieldset textfield[tag=merchantDevice]"},control:{},listeners:{upgradeDevice:"onUpgradeDevice",toggleFB:{fn:"onToggleFB",buffer:5000}}},_initializing:true,termsLoaded:false,privacyLoaded:false,aboutUsLoaded:false,fbLoggedInIdentityMsg:function(a){return"You're logged into Facebook as "+Genesis.constants.addCRLF()+a;},proceedToUpdateLicenseMsg:"Please confirm to proceed with License Update",updatingFbLoginMsg:"Updating Facebok Login Credentials",noLicenseKeyScannedMsg:"No License Key was found!",licenseKeySuccessMsg:function(){return"License Key Updated for "+Genesis.constants.addCRLF()+"["+Genesis.constants.privKey.venue+"]";},init:function(){this.callParent(arguments);if(!merchantMode){this.initClientControl();}else{this.initServerControl();}console.log("Settings Init");},initClientControl:function(){this.control({"clientsettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"clientsettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"clientsettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"},"clientsettingspageview togglefield[name=facebook]":{change:"onFacebookChange"},"clientsettingspageview listfield[name=changepassword]":{clearicontap:"onPasswordChangeTap"}});this.getMultipartDocumentPage();this.getDocumentPage();},initServerControl:function(){this.control({"serversettingspageview listfield[name=license]":{clearicontap:"onRefreshLicenseTap"},"serversettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"serversettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"serversettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"},serverSettingsPage:{activate:"onServerActivate"}});},onUpgradeDevice:function(){var a=this;a.scanQRCode();},updateLicenseKey:function(a){Genesis.fn.writeFile("resources/keys.txt",Ext.encode(a),function(b){console.debug("Content Written to Disk");Genesis.constants.privKey=a;Ext.device.Notification.show({title:"License Key Updated!",message:me.licenseKeySuccessMsg()});});},onToggleFB:function(f,d,b,c,a,g){var h=this;var i=Genesis.db.getLocalDB();if(c==1){Genesis.fb.facebook_onLogin(function(k,j){if(!j||j.wasSuccessful()){f.originalValue=c;Ext.device.Notification.show({title:"Facebook Connect",message:h.fbLoggedInIdentityMsg(k.email)});}else{if(h.getClientSettingsPage().isVisible()){f.toggle();}}},true);}else{if(i.enableFB){console.debug("Cancelling Facebook Login ...");var e={facebook_id:0};Account.setUpdateFbLoginUrl();Account.load(0,{jsonData:{},params:{user:Ext.encode(e)},callback:function(j,k){if(k.wasSuccessful()){i=Genesis.db.getLocalDB();i.enableFB=false;i.currFbId=0;delete i.fbAccountId;delete i.fbResponse;Genesis.db.setLocalDB(i);Genesis.fb.facebook_onLogout(null,true);}else{if(h.getClientSettingsPage().isVisible()){f.toggle();}}}});}}},onFacebookChange:function(b,g,c,h,d,e){var f=this;var a=f.getViewPortCntlr();if(f._initializing){return;}Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);f.fireEvent("toggleFB",b,g,c,h,d,e);},onRefreshLicenseTap:function(a,d){var c=this;Ext.device.Notification.show({title:"Confirmation Required",message:c.proceedToUpdateLicenseMsg,buttons:["Proceed","Cancel"],callback:function(b){if(b.toLowerCase()=="proceed"){c.fireEvent("upgradeDevice");}}});},onTermsTap:function(c,j){var g=this,f=0;var a=g.getViewPortCntlr();var i=[];var h=g.getMultipartDocumentPage();h.query("title")[0].setTitle(g.getTermsOfServiceTitle());Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);if(!g.termsLoaded){var d=function(){for(var b=0;b<i.length;b++){h.setHtml(b,i[b].cardConfig);}g.redirectTo("termsOfUse");g.termsLoaded=true;};Ext.Ajax.request({async:true,disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../term_of_service.htm",callback:function(e,k,b){if(k){i[0]=b;b.cardConfig={title:"Terms of Use",html:b.responseText};if((f|=1)==17){d();}}else{console.debug("Error Loading Term of Service Document.");console.debug("Status code "+b.status);}}});Ext.Ajax.request({async:true,disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../program_rules.htm",callback:function(e,k,b){if(k){i[1]=b;b.cardConfig={title:"Program Rules",html:b.responseText};if((f|=16)==17){d();}}else{console.debug("Error Loading Program Rules Document.");console.debug("Status code "+b.status);}}});}else{g.redirectTo("termsOfUse");}},onPrivacyTap:function(c,g){var d=this;var a=d.getViewPortCntlr();var f=d.getDocumentPage();f.query("title")[0].setTitle(d.getPrivacyTitle());Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);if(!d.privacyLoaded){Ext.Ajax.request({disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../privacy.htm",callback:function(e,h,b){if(h){f.setHtml(b.responseText);d.redirectTo("privacy");d.privacyLoaded=true;}else{console.debug("Error Loading Privacy Document.");console.debug("Status code "+b.status);}}});}else{d.redirectTo("privacy");}},onAboutUsTap:function(c,g){var d=this;var a=d.getViewPortCntlr();var f=d.getDocumentPage();f.query("title")[0].setTitle(d.getAboutUsTitle());Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);if(d.aboutUsLoaded){Ext.Ajax.request({disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../about_us.htm",callback:function(e,h,b){if(h){f.setHtml(b.responseText);d.redirectTo("aboutUs");d.aboutUsLoaded=true;}else{console.debug("Error Loading About US Document.");console.debug("Status code "+b.status);}}});}else{d.redirectTo("aboutUs");}},onPasswordChangeTap:function(c,f){var d=this;var a=d.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);d.redirectTo("password_change");},onScannedQRcode:function(c){var b=this;var a=b.getViewport();if(c){console.debug("Programming License Key into Merchant Device ...");Venue.setGetLicenseKeyURL();Venue.load(0,{jsonData:{},params:{update_token:c,deviceId:(Genesis.constants.isNative())?device.uuid:null,},callback:function(e,f){var d=Venue.getProxy().getReader().metaData;Ext.Viewport.setMasked(null);if(f.wasSuccessful()){b.updateLicenseKey(d);}}});}else{console.debug(b.noLicenseKeyScannedMsg);Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:"Error",message:b.noLicenseKeyScannedMsg});}},onServerActivate:function(d,e,a,b){this.getMerchantDevice().setValue(Genesis.constants.getPrivKey()["venue"]);},clientSettingsPage:function(){var d=this;var b=Genesis.db.getLocalDB()["enableFB"];var c=d.getClientSettingsPage();console.log("enableFB - "+b);var a=c.query("togglefield[name=facebook]")[0];d._initializing=true;c.setValues({facebook:(b)?1:0});d._initializing=false;d.openPage("client");},serverSettingsPage:function(){this.openPage("server");},multipartDocumentPage:function(){this.openPage("multipartDocument");},documentPage:function(){this.openPage("document");},openPage:function(a){var b=this,c;switch(a){case"multipartDocument":c=b.getMultipartDocumentPage();b.setAnimationMode(b.self.superclass.self.animationMode.slide);break;case"document":c=b.getDocumentPage();b.setAnimationMode(b.self.superclass.self.animationMode.slide);break;case"client":c=b.getClientSettingsPage();b.setAnimationMode(b.self.superclass.self.animationMode.cover);break;case"server":c=b.getServerSettingsPage();b.setAnimationMode(b.self.superclass.self.animationMode.cover);break;}b.pushView(c);},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.MainPage",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{},xtype:"mainPageCntlr",config:{csrfTokenRecv:false,models:["frontend.MainPage","frontend.Signin","frontend.Account","Customer","User","Merchant","CustomerReward"],after:{mainPage:""},routes:{"":"openPage",main:"mainPage",login:"loginPage",merchant:"merchantPage",signin:"signInPage",password_reset:"signInResetPage",password_change:"signInChangePage",createAccount:"createAccountPage",},refs:{login:{selector:"loginpageview",autoCreate:true,xtype:"loginpageview"},signin:{selector:"signinpageview",autoCreate:true,xtype:"signinpageview"},passwdReset:{selector:"passwdresetpageview",autoCreate:true,xtype:"passwdresetpageview"},passwdChange:{selector:"passwdchangepageview",autoCreate:true,xtype:"passwdchangepageview"},createAccount:{selector:"createaccountpageview",autoCreate:true,xtype:"createaccountpageview"},main:{selector:"mainpageview",autoCreate:true,xtype:"mainpageview"},mainCarousel:"mainpageview",shortcutTabBar:"mainpageview tabbar[tag=navigationBarBottom]",infoBtn:"button[tag=info]",prizesBtn:"mainpageview tabbar[tag=navigationBarBottom] button[tag=prizesSC]"},control:{login:{activate:"onLoginActivate",deactivate:"onLoginDeactivate"},"actionsheet button[tag=facebook]":{tap:"onFacebookTap"},"actionsheet button[tag=createAccount]":{tap:"onCreateAccountTap"},"actionsheet button[tag=signIn]":{tap:"onSignInTap"},"signinpageview button[tag=login]":{tap:"onSignInSubmit"},"signinpageview button[tag=reset]":{tap:"onSignInResetSubmit"},"passwdresetpageview button[tag=submit]":{tap:"onPasswdResetSubmit"},"passwdchangepageview button[tag=submit]":{tap:"onPasswdChangeSubmit"},"actionsheet button[tag=logout]":{tap:"onLogoutTap"},main:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},shortcutTabBar:{tabchange:"onTabBarTabChange"},createAccount:{activate:"onCreateActivate",deactivate:"onCreateDeactivate"},"createaccountpageview button[tag=createAccount]":{tap:"onCreateAccountSubmit"}},listeners:{refreshCSRF:"onRefreshCSRF",itemTap:"onItemTap"}},_loggingOut:false,_logoutflag:0,sessionTimeoutMsg:"Session Timeout",reestablishConnectionMsg:"Connecting to Server ...",passwdResetConfirmMsg:"Please confirm to reset your account password",passwdResetSuccessMsg:function(){return("Password Reset was Successful."+Genesis.constants.addCRLF()+"Please check your email account for instructions.");},passwdChangeSuccessMsg:"Password Change was Successful.",signInFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please Try Again";},passwdResetFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please fix the errors";},passwdChangeFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please retype the passwords";},loginWithFbMsg:function(a){return"Logging in ...";},init:function(b){var a=this;a.callParent(arguments);Genesis.db.removeLocalDBAttrib("csrf_code");var c=function(){if(merchantMode){a.goToMain();var f=Genesis.constants.getPrivKey();var h;for(key in f){try{h=parseInt(key.split("r")[1]||key.split("v")[1]);}catch(g){h=0;}break;}if(h==0){Ext.device.Notification.show({title:"Missing License Key!",message:a.missingLicenseKeyMsg,buttons:["Proceed","Cancel"],callback:function(e){if(e.toLowerCase()=="proceed"){_application.getController("Settings").fireEvent("upgradeDevice");}}});}}else{var d=Genesis.db.getLocalDB();if(d.auth_code){a.fireEvent("refreshCSRF");}else{a.resetView();a.redirectTo("login");}}};Ext.regStore("MainPageStore",{model:"Genesis.model.frontend.MainPage",autoLoad:false,listeners:{scope:a,refresh:c}});if(!merchantMode){Ext.regStore("UserStore",{model:"Genesis.model.User",autoLoad:false});a.initCustomerStore();a.initVenueStore();}console.log("MainPage Init");a.getMain();backBtnCallbackListFn.push(function(f){var e=((f==a.getMain())||((merchantMode)?false:(f==a.getLogin())));if(e){var d=a.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(d.sound_files.clickSound);navigator.app.exitApp();return true;}return false;});},initCustomerStore:function(){var a=this;Ext.regStore("CustomerStore",{model:"Genesis.model.Customer",autoLoad:false,pageSize:1000,listeners:{scope:a,load:function(d,c,f,b,e){},metachange:function(d,f,e){var c=f.getReader().metaData;var g=c.data;if(g){var h=a.getApplication();var b=h.getController("client.Accounts");b.callBackStack["arguments"]=[c];b.fireEvent("triggerCallbacksChain");}}},grouper:{groupFn:function(b){return b.getMerchant().get("name");}},filters:[{filterFn:function(b){return Customer.isValid(b.getId());}}],sorters:[{sorterFn:function(d,b){var e=d.getMerchant().get("name"),c=b.getMerchant().get("name");if(e<c){return -1;}if(e>c){return 1;}return 0;}}]});},initVenueStore:function(){var a=this;Ext.regStore("VenueStore",{model:"Genesis.model.Venue",autoLoad:false,sorters:[{property:"distance",direction:"ASC"}],listeners:{metachange:function(b,d,c){if(b.isLoading()){a.fireEvent("updatemetadata",d.getReader().metaData);}}}});},onLocationUpdate:function(g){var m=this;var l=m.getViewPortCntlr();var j=g.coords.getLatitude();var h=g.coords.getLongitude();var n=Genesis.db.getLocalDB();var c=Ext.create("Genesis.model.Venue",n.last_check_in.venue);var i=c.get("latitude");var f=c.get("longitude");var b=6371000*Math.acos(Math.cos(Math.radians(j))*Math.cos(Math.radians(i))*Math.cos(Math.radians(f)-Math.radians(h))+Math.sin(Math.radians(j))*Math.sin(Math.radians(i)));if(b<=Genesis.constants.minDistance){var d=m.getApplication();var e=d.getController("client.Checkins");var k=Ext.StoreMgr.get("CustomerStore").getById(n.last_check_in.customerId);var a=n.last_check_in.metaData;console.log("Restoring Previous Venue Location ...");e.fireEvent("setupCheckinInfo","explore",c,k,a);e.fireEvent("checkinMerchant","checkin",a,c.getId(),k,null,Ext.emptyFn);}else{console.log("Reset Previous Location back to Home Page ...");Genesis.db.removeLocalDBAttrib("last_check_in");m.redirectTo("checkin");}},onItemTap:function(c){var b=this.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(b.sound_files.clickSound);console.log("Controller=["+c.get("pageCntlr")+"]");var a=this.getApplication().getController(c.get("pageCntlr"));var d=a.isOpenAllowed();if(d===true){if(c.get("route")){this.redirectTo(c.get("route"));}else{if(c.get("subFeature")){a.openPage(c.get("subFeature"));}else{a.openMainPage();}}}else{Ext.device.Notification.show({title:"Error",message:d});}return false;},onShowView:function(c){if(Ext.os.is("Android")){var b=c.query("carousel")[0];var a=b.getInnerItems();console.debug("Refreshing MainPage ...");}},onActivate:function(d,e,a,b){this.getInfoBtn()[(merchantMode)?"hide":"show"]();Ext.Viewport.setMasked(null);},onDeactivate:function(a,e,d,b){},onTabBarTabChange:function(b,d,c,a){switch(d.config.tag){default:case"rewards":Ext.defer(function(){try{if(d){d.setActive(false);}if(c){c.setActive(false);}b._activeTab=null;}catch(f){}},2*1000);break;}return true;},facebookLogin:function(b){var a=this;Customer.setFbLoginUrl();console.log("setFbLoginUrl - Logging in ...");Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:Ext.apply(b,{device_pixel_ratio:window.devicePixelRatio,device:Ext.encode(Genesis.constants.device)}),callback:function(d,c){if(!c.wasSuccessful()){Genesis.db.resetStorage();}else{Genesis.db.setLocalDBAttrib("enableFB",true);a.persistSyncStores("CustomerStore");a.fireEvent("updatemetadata",Customer.getProxy().getReader().metaData);}}});},onLoginActivate:function(e,f,b,d){var a=this.getViewPortCntlr();Genesis.db.resetStorage();a.setLoggedIn(false);},onLoginDeactivate:function(a,f,e,b){var d=this;},onLogoutTap:function(c,j,d,i){var h=this;var g=h.getViewport();var a=h.getViewPortCntlr();if(h._loggingOut){return;}h._logoutflag=0;h._loggingOut=true;var f=function(){var b=Genesis.db.getLocalDB()["auth_code"];if(b){console.log("Logging out ...");Customer.setLogoutUrl(b);Ext.StoreMgr.get("CustomerStore").load({jsonData:{},callback:function(k,e){Ext.Viewport.setMasked(null);h._loggingOut=false;if(e.wasSuccessful()){h.persistSyncStores(null,true);console.log("Logout Successful!");}else{console.log("Logout Failed!");}}});}console.log("Resetting Session information ...");if(Genesis.db.getLocalDB()["currFbId"]>0){Genesis.fb.facebook_onLogout(null,true);}h.resetView();h.redirectTo("login");};c.parent.onAfter({hiddenchange:function(){if((h._logoutflag|=1)==17){f();}},single:true});c.parent.hide();if(Genesis.db.getLocalDB()["currFbId"]>0){console.log("Logging out of Facebook ...");Genesis.fb.facebook_onLogout(function(){if((h._logoutflag|=16)==17){f();}});}else{console.log("No Login info found from Facebook ...");if((h._logoutflag|=16)==17){f();}}},onFacebookTap:function(a,g,c,f){var d=this;if(!Ext.Viewport.getMasked()){Ext.Viewport.setMasked({xtype:"loadmask",message:d.loginWithFbMsg()});Genesis.db.removeLocalDBAttrib("currFbId");Genesis.fb.facebook_onLogin(function(b){console.log(d.loginWithFbMsg());d.facebookLogin(b);},true);}},onCreateAccountTap:function(a,f,c,d){this.redirectTo("createAccount");},onSignInTap:function(a,f,c,d){this.redirectTo("signin");},onRefreshCSRF:function(){var b=this;var a=Account.getProxy();Account.setRefreshCsrfTokenUrl();console.log("setRefreshCsrfTokenUrl - Refreshing CSRF Token ...");Ext.Viewport.setMasked({xtype:"loadmask",message:b.reestablishConnectionMsg});Account.load(0,{jsonData:{},params:{device_pixel_ratio:window.devicePixelRatio,device:Ext.encode(Genesis.constants.device)},callback:function(d,f){if(f.wasSuccessful()){var e=Genesis.db.getLocalDB();var c=b.getViewPortCntlr();b.persistLoadStores(Ext.emptyFn);c.fireEvent("completeRefreshCSRF");if(e.last_check_in){b.getGeoLocation();}}else{b.resetView();b.redirectTo("login");}}});},onCreateAccountSubmit:function(k,h,i,n){var j=this;var g=j.getCreateAccount();var o=g.getValues();var f=Ext.create("Genesis.model.frontend.Account",o);var a=f.validate();var d=Genesis.db.getLocalDB()["fbResponse"]||null;if(!a.isValid()){var m=a.first();var l=Ext.ComponentQuery.query("field[name="+m.getField()+"]")[0].getLabel();var p=l+" "+m.getMessage()+Genesis.constants.addCRLF()+"Please Try Again";console.log(p);Ext.device.Notification.show({title:"Oops",message:p});}else{console.debug("Creating Account ...");var c={name:o.name,email:o.username,password:o.password};if(d){c=Ext.apply(c,d);}Customer.setCreateAccountUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:{device_pixel_ratio:window.devicePixelRatio,user:Ext.encode(c),device:Ext.encode(Genesis.constants.device)},callback:function(e,b){if(!b.wasSuccessful()){}else{j.persistSyncStores();j.fireEvent("updatemetadata",Customer.getProxy().getReader().metaData);}}});}},onSignIn:function(d,a){Genesis.fb.facebook_onLogout(null,Genesis.db.getLocalDB()["currFbId"]>0);var b=this;var c={device_pixel_ratio:window.devicePixelRatio,device:Ext.encode(Genesis.constants.device)};if(d){c=Ext.apply(c,{email:d,password:a});}Customer.setLoginUrl();console.log("setLoginUrl - Logging in ...");Ext.StoreMgr.get("CustomerStore").load({params:c,jsonData:{},callback:function(f,e){if(!e.wasSuccessful()){}else{b.persistSyncStores("CustomerStore");b.fireEvent("updatemetadata",Customer.getProxy().getReader().metaData);}}});},onSignInResetSubmit:function(a,f,c,d){this.redirectTo("password_reset");},onSignInSubmit:function(g,d,f,j){var k=this.getSignin();var l=k.getValues();var c=Ext.create("Genesis.model.frontend.Signin",l);var a=c.validate();if(!a.isValid()){var i=a.first();var h=Ext.ComponentQuery.query("field[name="+i.getField()+"]")[0].getLabel();Ext.device.Notification.show({title:"Oops",message:this.signInFailMsg(h+" "+i.getMessage())});}else{this.onSignIn(l.username,l.password);}},onPasswdReset:function(c){var a=this;var b={device:Ext.encode(Genesis.constants.device)};if(c){b=Ext.apply(b,{email:c});}Account.setPasswdResetUrl();console.log("setPasswdResetUrl - Resetting Password ...");Account.load(0,{params:b,jsonData:{},callback:function(d,e){if(e.wasSuccessful()){Ext.device.Notification.show({title:"Password Reset",message:a.passwdResetSuccessMsg()});a.popView();}Ext.Viewport.setMasked(null);}});},onPasswdResetSubmit:function(a,h,c,g){var f=this;var d=function(){var j=f.getPasswdReset();var e=j.getValues();var b=Ext.create("Genesis.model.frontend.Signin",e);var i=b.validate();var k=true;if(!i.isValid()){i.each(function(o,m,n){if(o.getField()=="username"){var l=j.query("field[name=username]")[0].getLabel();Ext.device.Notification.show({title:"Oops",message:f.passwdResetFailMsg(l+" "+field.getMessage())});k=false;}},f);}if(k){f.onPasswdReset(e.username);}};Ext.device.Notification.show({title:"Password Reset",message:this.passwdResetConfirmMsg,buttons:["Confirm","Cancel"],callback:function(b){if(b.toLowerCase()=="confirm"){Ext.defer(d,1);}}});},onPasswdChange:function(b,c){var a=this;var d={device:Ext.encode(Genesis.constants.device)};if(b&&c){d=Ext.apply(d,{old_password:b,new_password:c});}Account.setPasswdChangeUrl();console.log("setPasswdChangeUrl - Changing Password ...");Account.load(0,{params:d,jsonData:{},callback:function(e,f){if(f.wasSuccessful()){Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:"Password Reset",message:a.passwdChangeSuccessMsg});}}});},onPasswdChangeSubmit:function(h,d,f,k){var g=this.getPasswdChange();var l=g.getValues(true);var c=Ext.create("Genesis.model.frontend.ChangePassword",l);var a=c.validate();if(!a.isValid()){var j=a.first();var i=Ext.ComponentQuery.query("field[name="+j.getField()+"]")[0].getLabel();var m=this.passwdChangeFailMsg(i+" "+j.getMessage());console.log(m);Ext.device.Notification.show({title:"Oops",message:m});}else{this.onPasswdChange(l.oldpassword,l.newpassword);}},onCreateActivate:function(f,g,a,d){var b=Genesis.db.getLocalDB()["fbResponse"]||null;if(b){var e=this.getCreateAccount();e.setValues({name:b.name,username:b.email});}},onCreateDeactivate:function(a,f,e,b){var d=this;},mainPage:function(){this.openPage("main");},loginPage:function(){this.openPage("login");},merchantPage:function(){this.openPage("merchant");},signInPage:function(){this.setAnimationMode(this.self.superclass.self.animationMode.cover);this.pushView(this.getSignin());},signInResetPage:function(){this.setAnimationMode(this.self.superclass.self.animationMode.slide);this.pushView(this.getPasswdReset());},signInChangePage:function(){this.setAnimationMode(this.self.superclass.self.animationMode.slide);this.pushView(this.getPasswdChange());},createAccountPage:function(){this.setAnimationMode(this.self.superclass.self.animationMode.slide);this.pushView(this.getCreateAccount());},openPage:function(a){var c=this;switch(a){case"main":c.setAnimationMode(c.self.superclass.self.animationMode.pop);c.pushView(c.getMainPage());break;case"merchant":c.goToMerchantMain(true);break;case"login":var b=c.getApplication().getController("client.Checkins");b.fireEvent("setupCheckinInfo","checkin",null,null,null);c.setAnimationMode(c.self.superclass.self.animationMode.fade);c.pushView(c.getLogin());break;}},getMainPage:function(){var a=this.getMain();return a;},openMainPage:function(){var a=this.getViewPortCntlr();this.setAnimationMode(this.self.superclass.self.animationMode.pop);this.pushView(this.getMainPage());console.log("MainPage Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.Challenges",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{},xtype:"serverChallengesCntlr",config:{models:["PurchaseReward","CustomerReward"],refs:{challenges:{selector:"serverchallengesview",autoCreate:true,xtype:"serverchallengesview"},refreshBtn:"showredeemitemdetailview[tag=redeemItem] button[tag=refresh]",},control:{challenges:{activate:"onActivate",deactivate:"onDeactivate"},refreshBtn:{tap:"onRefreshTap"}}},invalidAuthCodeMsg:"Authorization Code is Invalid",generatingAuthCodeMsg:"Generating Authorization Code ...",refreshAuthCodeMsg:"Refresing Authorization Code ...",init:function(){this.callParent(arguments);console.log("Server Challenges Init");},generateQRCode:function(){return Genesis.controller.ControllerBase.genQRCodeFromParams({type:"earn_points"},"challenge",false);},onActivate:function(d,e,a,b){},onDeactivate:function(a,f,e,b){var d=this;a.removeAll(true);},onRefreshTap:function(a,g,d){var f=this;Ext.Viewport.setMasked({xtype:"loadmask",message:f.refreshAuthCodeMsg});var h=f.getApplication();var c=h.getController("server.Prizes");Ext.defer(function(){var b=f.generateQRCode();if(b[0]){c.fireEvent("refreshQRCode",b);}Ext.Viewport.setMasked(null);},1,f);},onGenerateQRCode:function(){var a=this;Ext.Viewport.setMasked({xtype:"loadmask",message:a.generatingAuthCodeMsg});Ext.defer(function(){var d=a.generateQRCode();if(d[0]){var b=a.getApplication().getController("server.Prizes");var c=Genesis.constants._thumbnailAttribPrefix+"large";var f={};f[c]={url:d[0],height:d[1]*1.25,width:d[2]*1.25,};var e=Ext.create("Genesis.model.CustomerReward",{id:0,title:"Authorization Code",type:{value:"earn_points"},photo:f});b.fireEvent("authreward",e);}Ext.Viewport.setMasked(null);},1,a);},openMainPage:function(){var a=this;a.onGenerateQRCode();},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.Rewards",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{serverRewards_path:"/serverRewards"},xtype:"serverRewardsCntlr",config:{models:["PurchaseReward","CustomerReward"],routes:{earnPts:"earnPtsPage"},refs:{rewards:{selector:"serverrewardsview",autoCreate:true,xtype:"serverrewardsview"},rewardsContainer:"serverrewardsview container[tag=rewards]",price:"serverrewardsview textfield",qrcode:"serverrewardsview component[tag=qrcode]",title:"serverrewardsview component[tag=title]",infoBtn:"viewportview button[tag=info]"},control:{rewards:{activate:"onActivate",deactivate:"onDeactivate"},rewardsContainer:{activeitemchange:"onContainerActivate"},"serverrewardsview container[tag=dialpad] button":{tap:"onCalcBtnTap"},"serverrewardsview container[tag=rewardsMainCalculator] button[tag=showQrCode]":{tap:"onShowQrCodeTap"},"serverrewardsview container[tag=qrcodeContainer] button[tag=done]":{tap:"onDoneTap"}}},maxValue:1000,clientNames:null,invalidPriceMsg:"Please enter a valid price (eg. 5.00), upto $1000",init:function(){this.callParent(arguments);console.log("Server Rewards Init");this.getRewards();},getPricePrecision:function(b){var a=b.split(".");return((a.length>1)?a[1].length:0);},availablePeerListChanged:function(b){var a,c;this.clientNames=[];for(a in b){c={};c[b[a]]=a;this.clientNames.push(c);}console.log("availablePeerListChanged -\n"+Ext.encode(this.clientNames));},connexionRequested:function(a){console.log("connexionRequested ClientId["+a+"]");window.plugins.bluetooth.acceptConnexion(a);window.plugins.bluetooth.sendDataToAll(Ext.encode({message:"This is a test!"}));Ext.defer(function(){window.plugins.bluetooth.stopSession();},1000);},connectedListChanged:function(){console.log("connectedListChanged - Disconnect");window.plugins.bluetooth.disconnect();},receiveData:function(a){console.log("receiveData -\n"+a);},onActivate:function(f,g,b,d){var e=this;var a=e.getRewardsContainer();if(a){a.setActiveItem(0);}},onDeactivate:function(a,g,f,d){var e=this;var b=e.getPrice();b.setValue(null);},onContainerActivate:function(i,h,b,e){var f=this;var a=f.getRewardsContainer();var g=a.getLayout().getAnimation();switch(h.config.tag){case"rewardsMainCalculator":var d=f.getPrice();d.setValue(null);g.setReverse(true);break;case"qrcodeContainer":g.setReverse(false);break;}console.debug("Rewards ContainerActivate Called.");},onShowQrCodeTap:function(a,j,f,i){var h=this;var d=h.getRewardsContainer();var g=h.getPrice().getValue();var c=this.getPricePrecision(g);if(c<2){Ext.device.Notification.show({title:"Validation Error",message:h.invalidPriceMsg});return;}Ext.Viewport.setMasked({xtype:"loadmask",message:h.genQRCodeMsg});Ext.defer(function(){var b=Genesis.controller.ControllerBase.genQRCodeFromParams({amount:g,type:"earn_points"},"reward",false);h.getQrcode().setStyle({"background-image":"url("+b[0]+")","background-size":Genesis.fn.addUnit(b[1]*1.25)+" "+Genesis.fn.addUnit(b[2]*1.25)});Ext.Viewport.setMasked(null);},1,h);console.debug("Encrypting QRCode with Price:$"+g);h.getTitle().setData({price:"$"+g});d.setActiveItem(1);},onCalcBtnTap:function(h,d,f,i){var g=this;var k=h.getText();var j=g.getPrice();var a=j.getValue().length;var c=Number(j.getValue()||0);switch(k){case"AC":c=null;break;default:if(a<2){if((c==0)&&(a>0)){c+=k;}else{c=(10*c)+Number(k);}}else{if(a==2){c=(c+k)/100;}else{c=(10*c)+(Number(k)/100);}c=c.toFixed(2);}break;}if(c<=g.maxValue){j.setValue(c);}},onDoneTap:function(a,h,d,g){var f=this;var c=f.getRewardsContainer();c.setActiveItem(0);},earnPtsPage:function(){var a=this;var b=a.getRewards();a.setAnimationMode(a.self.superclass.self.animationMode.cover);a.pushView(b);},getMainPage:function(){var a=this.getRewards();return a;},openPage:function(a){var b=this;switch(a){case"rewards":b.redirectTo("earnPts");break;}},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.Redemptions",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{serverRedemption_path:"/serverRedemptions"},xtype:"serverRedemptionsCntlr",config:{models:["PurchaseReward","CustomerReward"],refs:{redemptions:{selector:"serverredemptionsview",autoCreate:true,xtype:"serverredemptionsview"},verifyBtn:"showredeemitemdetailview[tag=redeemItem] button[tag=verify]",},control:{redemptions:{createView:"onCreateView",activate:"onActivate",deactivate:"onDeactivate"},verifyBtn:{tap:"onVerifyTap"}}},invalidAuthCodeMsg:"Authorization Code is Invalid",proceedToScanMsg:"Proceed to scan your customer's Authorization Code",authCodeNotValidMsg:function(){return"Authorization Code"+Genesis.constants.addCRLF()+"is no longer valid";},init:function(){this.callParent(arguments);console.log("Server Redemptions Init");},verifyQRCode:function(g){console.debug("Encrypted Code Length: "+g.length);console.debug("Decrypted content ["+g+"]");var i=this;var n=Genesis.constants.getPrivKey();GibberishAES.size(256);var f=Genesis.db.getRedeemIndexDB();var l=g.split("$")[0];g=g.split("$")[1];var j=null;switch(l){case"p":j="r";break;case"r":j="v";break;}if(j){for(var m in n){if(m.split(j)[1]>0){try{console.debug("Decrypting message using key["+n[m]+"]");var c=GibberishAES.dec(g,n[m]);console.debug("Decrypted Data["+c+"]");var k=Ext.decode(c);console.debug("Decoded Data!");var b=new Date(k.expiry_ts);if(f[g]){console.log(i.authCodeNotValidMsg());Ext.device.Notification.show({title:"Error!",message:i.authCodeNotValidMsg()});return;}else{if((b>=Date.now())&&(b<=new Date().addHours(3*2))){console.log("Found QRCode type["+k.type+"]");switch(k.type){case"redeem_prize":if(l!="p"){throw"DataType mismatch (Not a Prize)";}break;case"redeem_reward":if(l!="r"){throw"DataType mismatch (Not a Reward)";}break;default:throw"DataType mismatch (No type found!)";break;}Genesis.db.addRedeemSortedDB([g,f[g]]);Genesis.db.addRedeemIndexDB(g,k.expiry_ts);var d=i.getApplication().getController("server.Prizes");var a=Ext.create("Genesis.model.CustomerReward",{type:k.reward.type,title:k.reward.title});d.fireEvent("authreward",a);return;}else{console.log("Decrypted data used an expired key from Vendor["+m+"]");}}}catch(h){console.log("Error decrypted data ["+h+"]");}}}}Ext.device.Notification.show({title:"Error!",message:i.invalidAuthCodeMsg});},onCreateView:function(a){},onActivate:function(d,e,a,b){},onDeactivate:function(a,e,d,b){},onScannedQRcode:function(b){var a=this;if(!b){Ext.device.Notification.show({title:"Error!",message:a.invalidAuthCodeMsg});}else{a.verifyQRCode(b);}},onRedeemVerification:function(){var a=this;Ext.device.Notification.show({title:"Redemption Verification",message:a.proceedToScanMsg,buttons:["Proceed","Cancel"],callback:function(b){if(b.toLowerCase()=="proceed"){console.log("Verifying Authorization Code ...");a.scanQRCode();}}});},onVerifyTap:function(a,d,c){this.popView();},getMainPage:function(){var a=this.getRedemptions();return a;},openPage:function(a){switch(a){case"redemptions":this.onRedeemVerification();break;}},isOpenAllowed:function(){return true;}});var _dbCleanup=function(){Ext.defer(function(){Genesis.db.redeemDBCleanup();_dbCleanup();},1000*60*60*3);};_dbCleanup();Ext.define("Genesis.controller.server.Prizes",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store","Ext.util.Sorter"],statics:{},xtype:"serverprizesCntlr",config:{timeoutPeriod:10,mode:"authReward",routes:{authReward:"authRewardPage"},listeners:{authreward:"onAuthReward",refreshQRCode:"onRefreshQRCode"},refs:{sCloseBB:"showredeemitemdetailview[tag=redeemItem] button[tag=close]",sDoneBtn:"showredeemitemdetailview[tag=redeemItem] button[tag=done]",sRedeemBtn:"showredeemitemdetailview[tag=redeemItem] button[tag=redeem]",refreshBtn:"showredeemitemdetailview[tag=redeemItem] button[tag=refresh]",verifyBtn:"showredeemitemdetailview[tag=redeemItem] button[tag=verify]",redeemItem:{selector:"showredeemitemdetailview[tag=redeemItem]",autoCreate:true,tag:"redeemItem",xtype:"showredeemitemdetailview"}},control:{sDoneBtn:{tap:"onDoneTap"},sRedeemBtn:{tap:"onRedeemPrizeTap"},redeemItem:{createView:"onCreateView",activate:"onActivate",deactivate:"onDeactivate"}}},authRewardVerifiedMsg:"Verified",retrievingQRCodeMsg:"Retrieving QRCode ...",init:function(){var a=this;this.callParent(arguments);console.log("Prizes Init");Ext.defer(function(){a.getRedeemItem();},1,a);},onRefreshQRCode:function(b){var f=this;var a=f.getMainPage();var e=a.getInnerItems()[0];var g=e.query("component[tag=info]")[0];g.hide();var d=e.query("component[tag=itemPhoto]")[0];var c=Ext.get(Ext.DomQuery.select("img",d.element.dom)[0]);c.set({src:b[0]});c.setStyle({width:Genesis.fn.addUnit(b[1]*1.25),height:Genesis.fn.addUnit(b[2]*1.25)});},onCreateView:function(c){var b=this;var a=b.getMainPage();a.redeemItem=b.redeemItem;},onActivate:function(h,i,d,f){var g=this;var a=g.getViewPortCntlr();var b=h.query("titlebar")[0];var e=g.redeemItem.get("photo");g.getSCloseBB().show();switch(g.getMode()){case"authReward":b.addCls("kbTitle");b.setTitle(" ");g.getRefreshBtn()[e?"show":"hide"]();g.getVerifyBtn()[e?"hide":"show"]();g.getSRedeemBtn().hide();break;}console.log("ShowPrize View - Updated ShowPrize View.");},onDeactivate:function(a,e,d,b){},onAuthReward:function(a){this.redeemItem=a;this.redirectTo("authReward");},authRewardPage:function(){this.openPage("authReward");},openPage:function(a){this.setMode(a);this.pushView(this.getMainPage());console.log("Prizes Page Opened");},getMainCarousel:function(){var a=null;switch(this.getMode()){case"authReward":break;}return a;},getMainPage:function(){var a=this;var b;switch(a.getMode()){case"authReward":a.setAnimationMode(a.self.superclass.self.animationMode.coverUp);b=a.getRedeemItem();break;}return b;},openMainPage:function(){this.setMode("authReward");this.pushView(this.getMainPage());console.log("Prizes Page Opened");},isOpenAllowed:function(){return true;}});