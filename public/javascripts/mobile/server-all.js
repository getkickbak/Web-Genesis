Ext.define("Genesis.fx.animation.Scroll",{extend:"Ext.fx.animation.Abstract",alternateClassName:"Ext.fx.animation.ScrollIn",alias:["animation.scroll","animation.scrollIn"],config:{direction:"left",out:false,offset:0,easing:"auto",containerBox:"auto",elementBox:"auto",isElementBoxFit:true},reverseDirectionMap:{up:"down",down:"up",left:"right",right:"left"},applyEasing:function(a){if(a==="auto"){return"ease-"+((this.getOut())?"in":"out");}return a;},getData:function(){var e=this.getElement();var l=this.getFrom(),m=this.getTo(),d=this.getOut(),c=this.getOffset(),k=this.getDirection(),f=this.getReverse(),b=0,a=0,j,h,i,g;if(f){k=this.reverseDirectionMap[k];}switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:a=e.getHeight();break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:b=e.getWidth();break;}j=(d)?0:b;h=(d)?0:a;l.set("overflow","hidden");switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:l.set("height",h+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:l.set("width",j+"px");break;}i=(d)?b:0;g=(d)?a:0;m.set("overflow","hidden");switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:m.set("height",g+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:m.set("width",i+"px");break;}return this.callParent(arguments);}});Ext.define("Genesis.view.widgets.ListField",{extend:"Ext.field.Text",alternateClassName:"Genesis.field.List",xtype:"listfield",config:{ui:"list",component:{useMask:false},clearIcon:true,iconCls:"",readOnly:false},initialize:function(){var b=this,a=b.getComponent();b.callParent();if(b.getIconCls()){Ext.fly(b.element.query("."+Ext.baseCSSPrefix.trim()+"component-outer")[0]).addCls(b.getIconCls());}a.setReadOnly(true);},doClearIconTap:Ext.emptyFn});Ext.define("Genesis.view.widgets.ComponentListItem",{extend:"Ext.dataview.element.List",config:{maxItemCache:20},initialize:function(){this.callParent();this.doInitialize();this.itemCache=[];},getItemElementConfig:function(e,h){var f=this,c=f.dataview,g=c.getItemCls(),b=f.itemClsShortCache,d,a;if(g){b+=" "+g;}d={cls:b,children:[{cls:f.labelClsShortCache,}]};if(c.getIcon()){a=h.iconSrc;d.children.push({cls:f.iconClsShortCache,style:"background-image: "+a?'url("'+newSrc+'")':""});}return d;},moveItemsToCache:function(k,l){var j=this,d=j.dataview,b=d.getMaxItemCache(),h=j.getViewItems(),g=j.itemCache,f=g.length,n=d.getPressedCls(),e=d.getSelectedCls(),c=l-k,o;for(;c>=0;c--){o=Ext.get(h[k+c]);var m=o.down(j.labelClsCache,true);var a=Ext.getCmp(m.childNodes[0].id);if(f!==b){o.removeCls([n,e]);g.push(a);f++;}else{Ext.Array.remove(j.itemCache,a);a.destroy();}o.dom.parentNode.removeChild(o.dom);}if(j.getViewItems().length==0){this.dataview.showEmptyText();}},moveItemsFromCache:function(b){var l=this,e=l.dataview,m=e.getStore(),k=b.length;var a=e.getDefaultType(),h=e.getItemConfig();var g=l.itemCache,f=g.length,j=[],c,n,d;if(k){e.hideEmptyText();}for(c=0;c<k;c++){b[c]._tmpIndex=m.indexOf(b[c]);}Ext.Array.sort(b,function(o,i){return o._tmpIndex>i._tmpIndex?1:-1;});for(c=0;c<k;c++){d=b[c];if(f){f--;n=g.pop();l.updateListItem(d,n);}l.addListItem(d._tmpIndex,d,n);delete d._tmpIndex;}return j;},addListItem:function(f,d,m){var j=this,e=j.dataview,b=e.prepareData(d.getData(true),e.getStore().indexOf(d),d);var c=j.element,l=c.dom.childNodes,i=l.length,h;h=Ext.Element.create(this.getItemElementConfig(f,b));var a=e.getDefaultType(),g=e.getItemConfig();if(!i||f==i){h.appendTo(c);}else{h.insertBefore(l[f]);}var k=h.down(j.labelClsCache,true);if(!m){m=new Ext.widget(a,{xtype:a,record:d,dataview:e,itemCls:e.getItemCls(),defaults:g,renderTo:k});}else{m.element.appendTo(k);}},updateListItem:function(b,c){if(c.isComponent&&c.updateRecord){c.updateRecord(b);}else{var d=Ext.fly(c).down(this.labelClsCache,true);var a=Ext.getCmp(d.childNodes[0].id);a.updateRecord(b);}},destroy:function(){var d=this.getViewItems(),c=d.length,b=0,a=this.itemCache.length;for(;b<a;b++){this.itemCache[b].destroy();this.itemCache[b]=null;}delete this.itemCache;for(b=0;b<c;b++){Ext.removeNode(d[b]);}this.callParent();}});Ext.define("Genesis.view.widgets.ComponentList",{alternateClassName:"Genesis.ComponentList",extend:"Ext.dataview.List",xtype:"componentlist",requires:["Genesis.view.widgets.ComponentListItem"],initialize:function(){var b=this,a;b.on(b.getTriggerCtEvent(),b.onContainerTrigger,b);a=b.container=this.add(new Genesis.view.widgets.ComponentListItem({baseCls:this.getBaseCls()}));a.dataview=b;b.on(b.getTriggerEvent(),b.onItemTrigger,b);a.element.on({delegate:"."+this.getBaseCls()+"-disclosure",tap:"handleItemDisclosure",scope:b});a.on({itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd",itemtap:"onItemTap",itemtaphold:"onItemTapHold",itemtouchmove:"onItemTouchMove",itemsingletap:"onItemSingleTap",itemdoubletap:"onItemDoubleTap",itemswipe:"onItemSwipe",scope:b});if(this.getStore()){this.refresh();}}});Ext.define("Genesis.view.ViewBase",{extend:"Ext.Container",xtype:"viewbase",inheritableStatics:{generateTitleBarConfig:function(){return({xtype:"titlebar",docked:"top",tag:"navigationBarTop",cls:"navigationBarTop",masked:{xtype:"mask",transparent:true},defaults:{iconMask:true}});},invisibleMask:{xtype:"mask",transparent:true},phoneField:function(){return({xtype:"textfield",minLength:12,maxLength:12,placeHolder:"800-555-1234",listeners:{keyup:function(g,i,c){var h=i.browserEvent.keyCode,b=String.fromCharCode(h),d=g.getValue();if((h>=48&&h<=90)||(h>=106&&h<=111)||(h>=186&&h<=192)||(h>=219&&h<=222)){if(b.match(/[0-9]/)&&(!i.browserEvent.shiftKey&&!i.browserEvent.ctrlKey&&!i.browserEvent.metaKey)){if((d.length==3)||(d.length==7)){g.setValue(d+"-");}else{if((d.length==4)||(d.length==8)){var a=d.match(/-/);if(!a){g.setValue(d.slice(0,d.length-1)+"-"+d[d.length-1]);}else{switch(a.length){case 1:if(d.length>4){g.setValue(d.slice(0,d.length-1)+"-"+d[d.length-1]);}break;default:break;}}}}}else{g.setValue(d.slice(0,d.length-1));}}}}});}},config:{preRender:null},initialize:function(){this.callParent(arguments);this.setPreRender([]);},cleanView:function(){this.fireEvent("cleanView",this);},removeAll:function(a,b){var c=this.callParent(arguments);this.setPreRender([]);return c;},createView:function(){this.fireEvent("createView",this);return(this.getPreRender().length==0);},showView:function(){if(this.getInnerItems().length==0){this.add(this.getPreRender());}Ext.defer(this.fireEvent,0.01*1000,this,["showView",this]);}});Ext.define("Genesis.view.widgets.Item",{extend:"Ext.Container",requires:["Ext.XTemplate"],xtype:"item",alias:"widget.item",config:{cls:"item",tag:"item",layout:"fit"},constructor:function(c){var d=this;c=c||{};d.config.preItemsConfig=d.config.preItemsConfig||[];d.config.postItemsConfig=d.config.postItemsConfig||[];d.config.photoTemplate=d.config.photoTemplate||null;var a=c.preItemsConfig||[];var e=c.postItemsConfig||[];var b=c.photoTemplate||d.config.photoTemplate;Ext.merge(a,d.config.preItemsConfig);Ext.merge(e,d.config.postItemsConfig);delete c.preItemsConfig;delete c.postItemsConfig;delete c.photoTemplate;Ext.merge(c,{items:[{docked:"top",xtype:"component",tag:"title",cls:"title",defaultUnit:"em",tpl:Ext.create("Ext.XTemplate","{[this.getDescription(values)]}",{getDescription:function(f){return f.title;}})}].concat(a,[{xtype:"component",tag:"itemPhoto",cls:"itemPhoto",tpl:(b)?b:Ext.create("Ext.XTemplate",'<div class="photoVCenterHelper"></div>','<div class="photoVCenterContent"><img {[this.getPhoto(values)]} /></div>',{getPhoto:function(f){var g=f.photo;if(Ext.isString(g)){return'src="'+g+'"';}else{return'src="'+g.url+'" '+((g.width)?'style="width:'+Genesis.fn.addUnit(g.width)+";height:"+Genesis.fn.addUnit(g.height)+';"':"");}}})}],e)});this.callParent(arguments);},initialize:function(){this.callParent(arguments);this.updateItem(this.getData());},updateItem:function(d){var c=this;var b=d.raw;var a=c.query("component[tag=itemPhoto]")[0];var e=c.query("component[tag=title]")[0];if(b.title){e.setData(b);e.show();}else{e.hide();}a.setData(b);c.setData(d);return b;},inheritableStatics:{}});Ext.define("Genesis.view.widgets.RedeemItem",{extend:"Genesis.view.widgets.Item",xtype:"redeemitem",alias:"widget.redeemitem",config:{iconType:"prizewon",hideMerchant:false,cls:"item redeemItem",tag:"redeemItem",layout:"fit",postItemsConfig:[{docked:"bottom",xtype:"component",hidden:true,tag:"itemPoints",cls:"itemPoints",tpl:Ext.create("Ext.XTemplate","{[this.getPoints(values)]}",{getPoints:function(a){return((a.points>0)?a.points+"  Pts":" ");}})},{docked:"bottom",xtype:"component",tag:"info",cls:"info",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="infoWrapper"><div class="name">{[this.getName(values)]}</div><div class="disclaimer">{[this.getDisclaimer(values)]}</div><div class="date">{[this.getExpiryDate(values)]}</div></div>',{getExpiryDate:function(a){var b=a.get("time_limited");return((b)?"Offer Expires: "+a.get("expiry_date"):"");},getDisclaimer:function(a){var c=(a.get("quantity_limited"))?"<b>Quantity : "+a.get("quantity")+"</b><br/>":"Limited Quantities. ";var b=a.getMerchant().get("reward_terms")||"";return(c+b);},getPhoto:function(a){return a.getMerchant().get("photo")["thumbnail_medium_url"];},getName:function(a){return a.getMerchant().get("name");}})}]},constructor:function(a){var b=this;a=Ext.merge({photoTemplate:Ext.create("Ext.XTemplate",'<div class="photoVCenterHelper"></div>','<div class="photoVCenterContent"><img {[this.getPhoto(values)]} /></div>','<div class="itemPoints {[this.isVisible(values)]}">{[this.getPoints(values)]}</div>',{getPhoto:function(c){var e=Genesis.constants._thumbnailAttribPrefix+"large";var d=(c.photo&&c.photo[e])?c.photo[e]:b.self.getPhoto(c.type,b.getIconType());if(Ext.isString(d)){return'src="'+d+'"';}else{return'src="'+d.url+'" '+((d.width)?'style="width:'+Genesis.fn.addUnit(d.width)+";height:"+Genesis.fn.addUnit(d.height)+';"':"");}},isVisible:function(c){return((c.merchant)?"":"x-item-hidden");},getPoints:function(c){return((c.points>0)?c.points+"  Pts":" ");}}),},a);this.callParent(arguments);},updateItem:function(d){var c=this;var b=d.raw;var e=c.query("component[tag=info]")[0];var a=c.query("component[tag=itemPoints]")[0];if(b.merchant&&!c.getHideMerchant()){e.setData(d);e.show();a.setData({points:0});}else{e.hide();a.setData(b);a.show();}c.callParent(arguments);},inheritableStatics:{getPhoto:function(b,a){var c=null;switch(b.value){case"earn_points":case"promotion":break;default:c=Genesis.constants.getIconPath(a,b.value);break;}return c;}}});Ext.define("Genesis.view.widgets.PopupItem",{extend:"Genesis.view.widgets.Item",xtype:"popupitem",alias:"widget.popupitem",config:{iconType:null},constructor:function(a){var b=this;Ext.merge(a,{tag:"popupItem",photoTemplate:Ext.create("Ext.XTemplate",'<div class="photoVCenterHelper"></div>','<div class="photoVCenterContent"><img {[this.getPhoto(values)]} /></div>',{getPhoto:function(c){var d=b.self.getPhoto(c.type,b.getIconType());return'src="'+d+'"';}})});b.callParent(arguments);},inheritableStatics:{getPhoto:function(b,a){var c=Genesis.constants.getIconPath(a,b.value);return c;}}});Ext.define("Genesis.view.widgets.ItemDetail",{extend:"Genesis.view.ViewBase",requires:["Ext.XTemplate"],alias:"widget.itemdetailview",config:{scrollable:undefined,itemXType:"item",cls:"itemDetailMain viewport",layout:{type:"vbox",pack:"center",align:"stretch"}},createView:function(){var b=this;if(!b.callParent(arguments)&&(b.getInnerItems().length>0)){var a=b.getInnerItems()[0];a.setData(b.item);a.updateItem(b.item);}else{b.setPreRender([{flex:1,xtype:b.getItemXType(),data:b.item}]);}delete b.item;}});Ext.define("Genesis.view.widgets.PopupItemDetail",{extend:"Ext.Sheet",alias:"widget.popupitemdetailview",config:{bottom:0,left:0,top:0,right:0,hideOnMaskTap:false,defaultUnit:"em",layout:{type:"vbox",pack:"middle"},defaults:{xtype:"container",defaultUnit:"em"}},constructor:function(b){var d=this;b=b||{};var c=b.buttons||[];delete b.buttons;var a=b.preItemsConfig||[];var e=b.postItemsConfig||[];delete b.preItemsConfig;delete b.postItemsConfig;Ext.merge(b,{items:[{preItemsConfig:a,postItemsConfig:e,iconType:b.iconType,flex:1,xtype:"popupitem",data:Ext.create("Genesis.model.CustomerReward",{title:b.title,type:{value:b.icon}})},{docked:"bottom",defaults:{xtype:"button",defaultUnit:"em"},padding:"0 1.0 1.0 1.0",items:c}]});delete b.iconType;delete b.icon;d.callParent(arguments);}});Ext.define("Genesis.view.widgets.MerchantAccountPtsItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.Button","Ext.XTemplate"],xtype:"merchantaccountptsitem",alias:"widget.merchantaccountptsitem",config:{layout:"vbox",background:{cls:"tbPanel",tag:"background",height:window.innerWidth,items:[{xtype:"container",bottom:0,width:"100%",cls:"container",layout:"hbox",defaults:{flex:1,xtype:"component"},items:[{tag:"prizepoints",tpl:Ext.create("Ext.XTemplate",'<span class="x-badge round {[this.isVisible()]}">✔</span>{prize_points}',{isVisible:function(){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");var b=a.getCustomer();return(b.get("eligible_for_prize")?"":"x-item-hidden");}}),cls:"prizephotodesc x-hasbadge"},{tag:"points",tpl:Ext.create("Ext.XTemplate",'<span class="x-badge round {[this.isVisible()]}">✔</span>{points}',{isVisible:function(){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");var b=a.getCustomer();return(b.get("eligible_for_reward")?"":"x-item-hidden");}}),cls:"pointsphotodesc x-hasbadge"}],}]},winnersCount:{tag:"prizesWonPanel",xtype:"component",cls:"prizesWonPanel x-list",tpl:Ext.create("Ext.XTemplate",'<tpl if="this.isVisible(values)">','<div class="prizeswonphoto">','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">{[this.getDesc(values)]}</div>',"</div>",'<div class="x-list-disclosure"></div>',"</tpl>",{isVisible:function(a){return true;},getTitle:function(a){var b=" Jackpot"+((a.prize_jackpots>1)?"s":"");var c=((a.prize_jackpots>0)?a.prize_jackpots+b+" won this month":"Be our first winner this month!");return c;},getDesc:function(a){return"Check out our winners!";}})},badgeProgress:{tag:"badgeProgressPanel",xtype:"component",cls:"badgeProgressPanel",tpl:Ext.create("Ext.XTemplate",'<tpl if="this.isVisible(values)">','<div class="badgephoto">','<img class="itemPhoto" src="{[this.getPhoto(values)]}"/>','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">','<div class="progressBarContainer">','<div class="progressBar" style="{[this.getProgress(values)]}"></div>','<div class="progressBarValue">{[this.getDesc(values)]}</div>',"</div>","{[this.cleanup(values)]}","</div>","</div>","</tpl>",{isVisible:function(b){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");var d=a.getCustomer();var c=false;if(d){c=Customer.isValid(d.getId());b._customer=(c)?Ext.StoreMgr.get("CustomerStore").getById(d.getId()):null;}return c;},getPhoto:function(a){var b=Ext.StoreMgr.get("BadgeStore");if(b){a._badgeType=b.getById(a._customer.get("badge_id")).get("type");return Genesis.view.client.Badges.getPhoto(a._badgeType,"thumbnail_medium_url");}},getTitle:function(a){var b=('You are our <span class ="badgehighlight">'+a._badgeType.display_value.toUpperCase()+"</span>");return b;},getProgress:function(b){var d=b._customer;var e=b._nextBadge=Ext.StoreMgr.get("BadgeStore").getById(d.get("next_badge_id"));var c=b._nvisit=e.get("visits");var a=d.get("next_badge_visits");return("width:"+(a/c*100)+"%;");},getDesc:function(b){var d=b._customer;var c=b._nvisit;var a=d.get("next_badge_visits");var e=b._nextBadge;return((c-a)+" more visit"+(((c-a)>1)?"s":"")+" to be our "+((e)?e.get("type").display_value.toUpperCase():"None")+"!");},cleanup:function(a){delete a._customer;delete a._nextBadge;delete a._badgeType;delete a._nvisit;}})},dataMap:{getBackground:{setData:"background"},getWinnersCount:{setData:"winnersCount"},getBadgeProgress:{setData:"badgeProgress"}},listeners:[{element:"element",delegate:"div.prizephotodesc",event:"tap",fn:"onPrizesButtonTap"},{element:"element",delegate:"div.pointsphotodesc",event:"tap",fn:"onRedemptionsButtonTap"},{painted:function(b,a){}}]},initialize:function(){var a=this.query("container[tag=background]")[0];a.setHeight(window.innerWidth);},applyBackground:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBackground());},updateBackground:function(a,b){if(a){this.add(a);}if(b){this.remove(b);}},setDataBackground:function(e){var g=_application.getController(((merchantMode)?"server":"client")+".Viewport");var f=g.getCustomer();var b=g.getVenue();var a=b.getMerchant();var c=b.getId();var h=g.getCheckinInfo().venue;var k=f.getId();var l=a.get("features_config");var d=this.query("container[tag=background]")[0];var j=this.query("component[tag=points]")[0];var i=this.query("component[tag=prizepoints]")[0];d.setStyle({"background-image":"url("+e.Merchant.alt_photo["thumbnail_large_url"]+")"});d.getItems().items[0].show();if(Customer.isValid(k)&&Ext.StoreMgr.get("CustomerStore").getById(k)){j.setData(f.getData());i.setData(f.getData());}else{j.setData({points:"---"});i.setData({prize_points:"---"});}i.setVisibility(!l||(l&&l.enable_prizes));},applyWinnersCount:function(a){if(Ext.StoreMgr.get("BadgeStore")){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getWinnersCount());}return new Ext.Container();},updateWinnersCount:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},setDataWinnersCount:function(b){var a=this.query("component[tag=prizesWonPanel]")[0];if(a){a.setData(b);}},applyBadgeProgress:function(a){if(Ext.StoreMgr.get("BadgeStore")){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBadgeProgress());}return new Ext.Container();},updateBadgeProgress:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},setDataBadgeProgress:function(d){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");var b=this.query("component[tag=badgeProgressPanel]")[0];var c=Customer.isValid(a.getCustomer().getId());if(b){if(c){b.setData(d);}b[(c)?"show":"hide"]();}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),k=e.first(),i=h.getDataMap(),f,j,g,a;if(!k){return;}for(f in i){g=i[f];j=h[f]();if(j){for(a in g){if(j[a]){switch(g[a]){case"background":h.setDataBackground(b);break;case"badgeProgress":h.setDataBadgeProgress(b);break;case"winnersCount":h.setDataWinnersCount(b);break;default:j[a](b[g[a]]);break;}}}}}k.updateData(b);},onPrizesButtonTap:function(){var b=this;var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");if(a.onPrizesButtonTap){a.self.playSoundFile(a.sound_files.clickSound);a.onPrizesButtonTap();}},onRedemptionsButtonTap:function(){var b=this;var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");if(a.onRedemptionsButtonTap){a.self.playSoundFile(a.sound_files.clickSound);a.onRedemptionsButtonTap();}}});Ext.define("Genesis.view.widgets.RedeemPtsItemBase",{extend:"Ext.dataview.component.DataItem",requires:["Ext.XTemplate"],xtype:"redeemptsitembase",alias:"widget.redeemptsitembase",config:{},applyPoints:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getPoints());},updatePoints:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),k=e.first(),i=h.getDataMap(),f,j,g,a;if(!k){return;}for(f in i){g=i[f];j=h[f]();if(j){for(a in g){if(j[a]){switch(g[a]){case"points":j[a](b);break;default:j[a](b[g[a]]);break;}}}}}k.updateData(b);}});Ext.define("Genesis.view.widgets.RewardPtsItem",{extend:"Genesis.view.widgets.RedeemPtsItemBase",xtype:"rewardptsitem",alias:"widget.rewardptsitem",config:{layout:{type:"hbox",align:"stretch"},points:{flex:1,tpl:"{points} Pts",cls:"pointsphoto"},dataMap:{getPoints:{setData:"points"}}}});Ext.define("Genesis.view.widgets.PrizePtsItem",{extend:"Genesis.view.widgets.RedeemPtsItemBase",xtype:"prizeptsitem",alias:"widget.prizeptsitem",config:{layout:{type:"hbox",align:"stretch"},points:{flex:1,tpl:"{prize_points} Pts",cls:"prizephoto"},dataMap:{getPoints:{setData:"points"}}}});Ext.define("Genesis.view.widgets.Calculator",{extend:"Ext.Container",requires:["Ext.Toolbar","Ext.field.Text"],alias:"widget.calculator",config:{title:null,bottomButtons:null,placeHolder:"0",hideZero:false,cls:"calculator",layout:"fit",items:[{height:"2.6em",docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:" "},{xtype:"spacer",align:"right"}]},{docked:"top",xtype:"textfield",name:"amount",value:"",clearIcon:false,placeHolder:" ",readOnly:true,required:true},{xtype:"container",layout:"vbox",tag:"dialpad",cls:"dialpad",defaults:{xtype:"container",layout:"hbox",flex:1,defaults:{xtype:"button",flex:1}},items:[{items:[{text:"1"},{text:"2"},{text:"3"}]},{items:[{text:"4"},{text:"5"},{text:"6"}]},{items:[{text:"7"},{text:"8"},{text:"9"}]},{items:[{text:"AC"},{tag:"zero",flex:2.3,text:"0"}]}]},{cls:"bottomButtons",xtype:"container",tag:"bottomButtons",docked:"bottom",layout:"hbox",defaults:{xtype:"button",flex:1}}]},initialize:function(){var d=this;var e=d.query("title")[0];var a=d.query("textfield")[0];var c=d.query("container[tag=bottomButtons]")[0];e.setTitle(d.getTitle());a.setPlaceHolder(d.getPlaceHolder());c.add(d.getBottomButtons());if(d.getHideZero()){var b=d.query("button[tag=zero]")[0];b.getParent().remove(b);}}});Ext.define("Genesis.model.frontend.LicenseKeyJSON",{extend:"Ext.data.Model",alternateClassName:"LicenseKeyJSON",id:"LicenseKeyJSON",config:{proxy:{type:"localstorage",id:"LicenseKeyJSON",writer:{type:"json"},reader:{type:"json"}},identifier:"uuid",fields:["json","id"],idProperty:"id"}});Ext.define("Genesis.model.frontend.LicenseKey",{extend:"Ext.data.Model",alternateClassName:"LicenseKey",id:"LicenseKey",config:{proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["venue_id","venue_name","id"],idProperty:"id"},inheritableStatics:{setGetLicenseKeyURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/devices/get_encryption_key");}}});Ext.define("Genesis.model.frontend.MainPage",{extend:"Ext.data.Model",id:"MainPage",config:{fields:["name","photo_url","desc","pageCntlr","subFeature","route","hide"],proxy:{noCache:false,enablePagingParams:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"},type:"ajax",disableCaching:false}}});Ext.define("Genesis.model.UserProfile",{extend:"Ext.data.Model",alternateClassName:"UserProfile",id:"UserProfile",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"}],fields:["gender","birthday","zipcode","created_ts","update_ts","user_id"]},getUser:function(){}});Ext.define("Genesis.model.User",{extend:"Ext.data.Model",requires:["Genesis.model.UserProfile"],alternateClassName:"User",id:"User",config:{hasOne:[{model:"Genesis.model.UserProfile",associationKey:"profile"}],proxy:{type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/users.json",reader:{type:"json"}},fields:["user_id","name","email","facebook_id","photo_url","created_ts","update_ts","profile_id"],idProperty:"user_id"}});Ext.define("Genesis.model.Merchant",{extend:"Ext.data.Model",alternateClassName:"Merchant",id:"Merchant",config:{fields:["id","name","email","photo","alt_photo","account_first_name","account_last_name","phone","auth_code","qr_code","features_config","payment_account_id","created_ts","update_ts","type","reward_terms"],idProperty:"id"}});Ext.define("Genesis.model.Challenge",{extend:"Ext.data.Model",id:"Challenge",alternateClassName:"Challenge",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],fields:["id","type","name","description","require_verif","data","points","created_ts","update_ts","photo","merchant_id","venue_id"],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},inheritableStatics:{setGetChallengesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/challenges");},setCompleteChallengeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/challenges/"+a+"/complete");},setCompleteMerchantChallengeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/challenges/merchant_complete");},setCompleteReferralChallengeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/challenges/complete_referral");},setSendReferralsUrl:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/challenges/"+a+"/start");}}});Ext.define("Genesis.model.Checkin",{extend:"Ext.data.Model",alternateClassName:"Checkin",id:"Checkin",config:{identifier:"uuid",belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"},{model:"Genesis.model.Venue",getterName:"getVenue",setterName:"setVenue"}],fields:["id","time"]}});Ext.define("Genesis.model.PurchaseReward",{extend:"Ext.data.Model",id:"PurchaseReward",alternateClassName:"PurchaseReward",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"},listeners:{metachange:function(d,b,c){var a=_application.getController(((!merchantMode)?"client":"server")+".Rewards");a.fireEvent("updatemetadata",b);}}},fields:["id","title","points","type","photo","created_ts","update_ts"]},getMerchant:function(){},inheritableStatics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/purchase_rewards");},setEarnPointsURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/purchase_rewards/earn");},setMerchantEarnPointsURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/purchase_rewards/merchant_earn");}}});Ext.define("Genesis.model.CustomerReward",{extend:"Ext.data.Model",id:"CustomerReward",alternateClassName:"CustomerReward",config:{fields:["id","title","points","type","photo","quantity_limited","quantity","time_limited",{name:"expiry_date",type:"date",convert:function(a,b){a=Date.parse(a,"yyyy-MM-dd");return(a)?Genesis.fn.convertDateNoTimeNoWeek(a):null;}}],idProperty:"id",belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},inheritableStatics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/customer_rewards?mode=reward");},setRedeemPointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/customer_rewards/"+a+"/redeem");},setMerchantRedeemPointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/customer_rewards/"+a+"/merchant_redeem");},setGetPrizesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/customer_rewards?mode=prize");},setRedeemPrizePointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/customer_rewards/"+a+"/redeem");}}});Ext.define("Genesis.model.Venue",{extend:"Ext.data.Model",requires:["Genesis.model.Challenge","Genesis.model.PurchaseReward","Genesis.model.CustomerReward"],alternateClassName:"Venue",id:"Venue",config:{fields:["id","name","address","description","distance","city","state","country","zipcode","phone","website","latitude","longitude","created_ts","update_ts","type","merchant_id","prize_jackpots"],belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"}],hasMany:[{model:"Genesis.model.Challenge",name:"challenges"},{model:"Genesis.model.PurchaseReward",name:"purchaseReward"},{model:"Genesis.model.CustomerReward",name:"customerReward"}],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}},idProperty:"id"},inheritableStatics:{setGetMerchantVenueExploreURL:function(a){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/venues/"+a+"/merchant_explore");},setFindNearestURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/venues/find_nearest");},setGetClosestVenueURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/venues/find_closest");},setSharePhotoURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/venues/share_photo");},setGetLicenseKeyURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/venues/updateLicenseKey");},setMerchantReceiptUploadURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/venues/"+a+"/merchant_add_sku_data");}}});Ext.define("Genesis.model.CustomerJSON",{extend:"Ext.data.Model",alternateClassName:"CustomerJSON",id:"CustomerJSON",config:{proxy:{type:"localstorage",id:"CustomerJSON",writer:{type:"json"},reader:{type:"json"}},identifier:"uuid",fields:["json","id"],idProperty:"id"}});Ext.define("Genesis.model.Customer",{extend:"Ext.data.Model",requires:["Genesis.model.Checkin","Genesis.model.Merchant"],alternateClassName:"Customer",id:"Customer",config:{belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",name:"merchant",setterName:"setMerchant",getterName:"getMerchant"},{model:"Genesis.model.User",associationKey:"user",name:"user",getterName:"getUser",setterName:"setUser"}],hasOne:[{model:"Genesis.model.Checkin",associationKey:"last_check_in",name:"last_check_in",getterName:"getLastCheckin",setterName:"setLastCheckin"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"},listeners:{metachange:function(d,b,c){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");a.fireEvent("updatemetadata",b);}}},fields:["id","points","prize_points","visits","next_badge_visits","eligible_for_reward","eligible_for_prize","badge_id","next_badge_id"],idProperty:"id"},getUser:function(){},inheritableStatics:{isValid:function(a){return a!=0;},updateCustomer:function(d,l){var f,k=false;d.beginEdit();for(var g=0;g<d.fields.length;g++){f=d.fields.items[g].getName();if(d.get(f)!=l.get(f)){d.set(f,l.get(f));k=true;}}try{if(d.getLastCheckin()!=l.getLastCheckin()){d.setLastCheckin(l.getLastCheckin());k=true;}}catch(h){d.setLastCheckin(Ext.create("Genesis.model.Checkin"));k=true;}var b=d.getMerchant()||"";var j=l.getMerchant()||"";var a=b.toString();var c=j.toString();if((a!=c)&&(c!="")){d.handleInlineAssociationData({merchant:j.raw});k=true;}d.endEdit();return k;},setFbLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/tokens/create_from_facebook");},setLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/tokens");},setLogoutUrl:function(a){this.getProxy().setActionMethods({read:"DELETE"});this.getProxy().setUrl(serverHost+"/api/v1/tokens/"+a);},setCreateAccountUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/sign_up");},setGetCustomerUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/customers/show_account");},setGetCustomersUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/customers");},setVenueScanCheckinUrl:function(){this.setVenueCheckinUrl();},setVenueCheckinUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/check_ins");},setVenueExploreUrl:function(a){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/venues/"+a+"/explore");},setSendPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/customers/transfer_points");},setRecvPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/customers/receive_points");}}});Ext.define("Genesis.model.frontend.Account",{extend:"Ext.data.Model",alternateClassName:"Account",id:"Account",config:{fields:["name","email","gender",{type:"date",name:"birthday",dateFormat:"time"},"phone","password","username"],validations:[{type:"format",field:"phone",matcher:/^(\d{3})\D*(\d{3})\D*(\d{4})\D*(\d*)$/},{type:"length",field:"password",min:6}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json",messageProperty:"message",rootProperty:"user"},reader:{type:"json",messageProperty:"message",rootProperty:"data"},listeners:{metachange:function(d,b,c){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");a.fireEvent("updatemetadata",b);}}}},inheritableStatics:{phoneRegex:/^(\d{3})\D*(\d{3})\D*(\d{4})\D*(\d*)$/,setUpdateFbLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/account/update_facebook_info");},setPasswdResetUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/account/reset_password");},setPasswdChangeUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/account/change_password");},setRefreshCsrfTokenUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/tokens/get_csrf_token");},setUpdateRegUserDeviceUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/account/register_user_device");},setUpdateAccountUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/account/update");}}});Ext.define("Genesis.model.frontend.Signin",{extend:"Ext.data.Model",alternateClassName:"Signin",id:"Sigin",config:{fields:["username","password"],validations:[{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.model.frontend.ReceiptItem",{extend:"Ext.data.Model",alternateClassName:"ReceiptItem",id:"ReceiptItem",config:{fields:["qty","price","name"]},inheritableStatics:{}});Ext.define("Genesis.model.frontend.Receipt",{extend:"Ext.data.Model",alternateClassName:"Receipt",id:"Receipt",config:{fields:["id","tnxId",{name:"subtotal",type:"float"},"itemsPurchased",{name:"price",type:"float"},"title","table","receipt"],idProperty:"id",hasMany:[{model:"Genesis.model.frontend.ReceiptItem",name:"items"}]},inheritableStatics:{}});Ext.define("Genesis.model.frontend.Table",{extend:"Ext.data.Model",alternateClassName:"Table",id:"Table",config:{fields:["id"],idProperty:"id"},inheritableStatics:{}});Ext.define("Genesis.view.Document",{extend:"Genesis.view.ViewBase",xtype:"documentview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"container",tag:"content",scrollable:"vertical",padding:"0.7 0.8",defaultUnit:"em",html:" "}]},disableAnimation:true,setHtml:function(b){var c=this.query("container[tag=content]")[0];var a=c.getScrollable();c.setHtml(b);if(a){a.getScroller().scrollTo(0,0);}},createView:function(){if(!this.callParent(arguments)){return;}}});Ext.define("Genesis.view.MultipartDocument",{requires:["Ext.tab.Panel"],extend:"Genesis.view.ViewBase",xtype:"multipartdocumentview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"tabpanel",defaults:{xtype:"container",scrollable:"vertical",padding:"0.7 0.8",defaultUnit:"em",html:" "},layout:"card",tabBarPosition:"top",tabBar:{layout:{pack:"justify"}}}]},disableAnimation:true,setHtml:function(b,d){var e=this.query("tabpanel")[0];var c=e.getInnerItems()[b];if(!c){c=e.insert(b,Ext.apply({xtype:"container"},d));}else{var a=c.getScrollable();a.getScroller().scrollTo(0,0);c.setHtml(html);}},createView:function(){if(!this.callParent(arguments)){return;}}});Ext.define("Genesis.view.Viewport",{extend:"Ext.Container",requires:["Ext.fx.layout.Card","Genesis.view.ViewBase"],xtype:"viewportview",config:{autoDestroy:false,cls:"viewport",layout:{type:"card",animation:{type:"cover",reverse:false,direction:"left"}},fullscreen:true},initialize:function(){this.callParent(arguments);if(Ext.os.is("Android")&&merchantMode){handleNfcFromIntentFilter();nfc.isEnabled(function(){Genesis.constants.isNfcEnabled=true;console.log("NFC is enabled on this device");});}},animateActiveItem:function(c,b){var j=this.getActiveItem();var e=this.getLayout(),i=(e.getAnimation)?e.getAnimation():null;var h=(c.disableAnimation||((j)?j.disableAnimation:false));var g,f=_application.getController(((merchantMode)?"server":"client")+".Viewport");if(this.activeItemAnimation){this.activeItemAnimation.destroy();}this.activeItemAnimation=b=new Ext.fx.layout.Card(b);if(b&&e.isCard&&!h){b.setLayout(e);if(i){var d=f.getEventDispatcher().controller;i.disable();d.pause();c.createView();b.on("animationend",function(){console.debug("Animation Complete");i.enable();b.destroy();delete this.activeItemAnimation;if(j){j.cleanView(c);g=j.query("titlebar")[0];if(g){g.setMasked(Genesis.view.ViewBase.invisibleMask);}}c.showView();g=c.query("titlebar")[0];if(g){g.setMasked(null);}d.resume();f.popViewInProgress=false;},this);}else{}}if(i&&h){i.disable();}var a=this.setActiveItem(c);if(!e.isCard||h){if(i){i.enable();}b.destroy();if(j){j.cleanView(c);var g=j.query("titlebar")[0];if(g){g.setMasked(Genesis.view.ViewBase.invisibleMask);}}c.createView();Ext.defer(function(){c.showView();g=c.query("titlebar")[0];if(g){g.setMasked(null);}f.popViewInProgress=false;},0.1*1000,this);}return a;}});Ext.define("Genesis.view.MainPageBase",{extend:"Genesis.view.ViewBase",requires:["Ext.data.Store","Ext.Carousel","Ext.dataview.DataView","Ext.XTemplate","Ext.Toolbar"],alias:"widget.mainpagebaseview",config:{itemPerPage:6,layout:"fit",cls:"viewport",listeners:[{element:"element",delegate:"div.itemWrapper",event:"tap",fn:"onItemTap"}],scrollable:undefined},isEligible:Ext.emptyFn,initialize:function(){this.setPreRender([]);this.callParent(arguments);},onItemTap:function(f,d,b,a){var c=Ext.create("Genesis.model.frontend.MainPage",Ext.decode(decodeURIComponent(f.delegatedTarget.getAttribute("data"))));_application.getController(((merchantMode)?"server":"client")+".MainPage").fireEvent("itemTap",c);},cleanView:function(){var a=this.query("carousel")[0];a.removeAll(true);this.callParent(arguments);},createView:function(){var f=this,h=f.query("carousel")[0],a=_application;var d=a.getController(((merchantMode)?"server":"client")+".Viewport"),j=d.getViewport();var g=(!merchantMode)?d.getCheckinInfo().venue!=null:false;var e=Ext.StoreMgr.get("MainPageStore").getRange(),c=Ext.Array.clone(e);if(!h._listitems){h._listitems=[];}if(!g){Ext.Array.forEach(c,function(l,i,k){switch(l.get("hide")){case"true":Ext.Array.remove(e,l);break;}});}if((Ext.Array.difference(e,h._listitems).length>0)||(e.length!=h._listitems.length)){h._listitems=e;h.removeAll(true);for(var b=0;b<Math.ceil(e.length/f.getItemPerPage());b++){h.add({xtype:"component",cls:"mainMenuSelections",tag:"mainMenuSelections",scrollable:undefined,data:Ext.Array.pluck(e.slice(b*f.getItemPerPage(),((b+1)*f.getItemPerPage())),"data"),tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="itemWrapper x-hasbadge" data="{[this.encodeData(values)]}">',"{[this.isEligible(values)]}",'<div class="photo"><img src="{[this.getPhoto(values.photo_url)]}" /></div>','<div class="photoName">{name}</div>',"</div>","</tpl>",{encodeData:function(i){return encodeURIComponent(Ext.encode(i));},getType:function(){return values.pageCntlr;},isEligible:f.isEligible,getPhoto:function(i){return Ext.isEmpty(i)?Ext.BLANK_IMAGE_URL:i;}})});}console.log("MainPage Icons Refreshed.");}else{console.log("MainPage Icons Not changed.");}delete h._listitems;this.callParent(arguments);},showView:function(){var a=this.query("carousel")[0];if(a.getInnerItems().length>0){a.setActiveItem(0);}this.callParent(arguments);}});Ext.define("Genesis.view.RedeemBase",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar","Genesis.view.widgets.RedeemPtsItemBase"],alias:"widget.redeeembaseview",config:{},disableAnimation:true,cleanView:function(){this.removeAll(true);this.callParent(arguments);},showView:function(){for(var a=0;a<this.getInnerItems().length;a++){this.getInnerItems()[a].setVisibility(true);}this.callParent(arguments);console.debug("RedeemBase : showView");},_createView:function(b,c,a){var d=this,e=1+Genesis.constants.defaultIconSize()+2*Genesis.fn.calcPx(0.65,1);console.debug("itemHeight="+e);d.setPreRender([{xtype:"list",flex:1,refreshHeightOnUpdate:false,variableHeights:false,itemHeight:e,ui:"bottom-round",store:b,cls:d.getListCls()+" separator_pad",tag:d.getListCls(),itemTpl:Ext.create("Ext.XTemplate",'<div class="photo x-hasbadge"><span class="x-badge round">{[this.getPoints(values)]}</span>','<img src="{[this.getPhoto(values)]}"/></div>','<div class="listItemDetailsWrapper">','<div class="itemTitle">{[this.getTitle(values)]}</div>',"</div>",{getPhoto:function(f){if(!f.photo||!f.photo.url){return d.self.getPhoto(f.type);}return f.photo.url;},getTitle:function(f){return f.title;},getDesc:function(f){return"This will cost you "+f.points+" Pts";},getPoints:function(f){return f.points;}}),onItemDisclosure:Ext.emptyFn,items:[{docked:"top",xtype:"toolbar",cls:"ptsEarnPanelHdr",ui:"light",centered:false,items:[{xtype:"title",title:d.getRedeemTitleText()},{xtype:"spacer"}]}]}]);},inheritableStatics:{}});Ext.define("Genesis.view.server.MainPage",{extend:"Genesis.view.MainPageBase",alias:"widget.servermainpageview",config:{items:(function(){var a=[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{xtype:"titlebar",cls:"navigationBarTop kbTitle"}),{xtype:"carousel",direction:"horizontal"}];return a;}())},disableAnimation:true,isEligible:function(a,b){return"";}});Ext.define("Genesis.view.server.MerchantAccount",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar","Ext.tab.Bar","Genesis.view.widgets.MerchantAccountPtsItem"],alias:"widget.servermerchantaccountview",config:{tag:"merchantMain",cls:"merchantMain viewport",scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",tag:"back",ui:"normal",text:"Back"}]})]},disableAnimation:true,loadingText:"Loading ...",cleanView:function(a){if(a.isXType("mainpageview",true)){this.removeAll(true);}this.callParent(arguments);},showView:function(){this.callParent(arguments);for(var a=0;a<this.getInnerItems().length;a++){this.getInnerItems()[a].setVisibility(true);}},createView:function(){var a=this;if(!a.callParent(arguments)){return;}a.setPreRender(a.getPreRender().concat([Ext.create("Ext.dataview.DataView",{tag:"tbPanel",xtype:"dataview",store:"MerchantRenderStore",useComponents:true,scrollable:undefined,minHeight:window.innerWidth,defaultType:"merchantaccountptsitem",defaultUnit:"em",margin:"0 0 0.7 0"}),Ext.create("Ext.form.Panel",{xtype:"formpanel",margin:"0 0.8 0.7 0.8",defaultUnit:"em",scrollable:null,layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"fieldset",title:"Account Profile",defaults:{labelWidth:"50%",readOnly:true,required:false},items:[{xtype:"textfield",name:"tagid",clearIcon:false,label:"Tag ID",value:" ",},{xtype:"textfield",cls:"halfHeight",labelWidth:"100%",name:"user",label:"John Smith<br/><label>johnsmith@example.com</label>",value:" "},{xtype:"datepickerfield",labelWidth:"30%",label:"Birthday",name:"birthday",dateFormat:"M j",picker:{yearFrom:1913,doneButton:{ui:"normal"}},value:0},Ext.applyIf({labelWidth:"30%",placeHolder:"",label:"Phone #",name:"phone",required:false},Genesis.view.ViewBase.phoneField())]}]})]));},inheritableStatics:{getPhoto:function(a){if(!a.value){return Genesis.constants.getIconPath("miscicons","pushnotification");}else{}}}});Ext.define("Genesis.view.server.SettingsPage",{extend:"Ext.form.Panel",requires:["Ext.dataview.List","Ext.XTemplate","Genesis.view.widgets.ListField","Ext.field.Select","Ext.field.Text","Ext.field.Toggle","Ext.form.FieldSet"],alias:"widget.serversettingspageview",config:{preRender:null,cls:"viewport",scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Settings",items:[{align:"left",tag:"back",ui:"normal",text:"Back"}]}),{xtype:"fieldset",title:"About Kickbak",defaults:{labelWidth:"50%"},items:[{xtype:"textfield",clearIcon:false,label:"Version "+Genesis.constants.serverVersion,value:" ",readOnly:true},{xtype:"togglefield",name:"posMode",tag:"posMode",label:"POS Integration",value:(Genesis.db.getLocalDB()["isPosEnabled"]||(Genesis.db.getLocalDB()["isPosEnabled"]==undefined))?1:0},{xtype:"selectfield",label:"Display Mode",tag:"displayMode",name:"displayMode",usePicker:true,options:[{text:"Mobile",value:"Mobile"},{text:"Fixed",value:"Fixed"}],defaultPhonePickerConfig:{height:"12.5em",doneButton:{ui:"normal"}}}]},{xtype:"fieldset",title:"Merchant Device",defaults:{labelWidth:"50%"},items:[{xtype:"textfield",labelWidth:"90%",tag:"merchantDevice",clearIcon:false,readOnly:true},{xtype:"listfield",name:"license",label:"Refresh License",value:" "},{xtype:"listfield",name:"resetdevice",label:"Reset Device",value:" "}]},{xtype:"fieldset",hidden:true,tag:"utilities",title:"Utilities",defaults:{labelWidth:"50%"},items:[{xtype:"listfield",tag:"createTag",label:"Create TAG",value:" "}]}]},initialize:function(){this.callParent(arguments);this.setPreRender([]);},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments);},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments);},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments);},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments);}});Ext.define("Genesis.view.server.TagCreatePage",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar","Ext.field.Text"],alias:"widget.servertagcreatepageview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{tag:"navigationBarTop",cls:"navigationBarTop kbTitle",title:" ",items:[{align:"left",tag:"back",ui:"normal",text:"Back"}]}),{xtype:"calculator",tag:"createTagId",title:"Enter TAG ID",placeHolder:"12345678",bottomButtons:[{tag:"createTagId",text:"Create!",ui:"orange-large"}]}]},createView:function(){var a=this;if(!a.callParent(arguments)){return;}},inheritableStatics:{}});Ext.define("Genesis.view.server.Rewards",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar","Ext.field.Select","Ext.field.Text","Genesis.view.widgets.Calculator","Ext.dataview.List","Ext.XTemplate","Ext.plugin.ListPaging","Ext.plugin.PullRefresh"],alias:"widget.serverrewardsview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{tag:"navigationBarTop",cls:"navigationBarTop kbTitle",title:" ",items:[{align:"left",tag:"back",ui:"normal",text:"Back"},{align:"left",tag:"rptClose",hidden:true,ui:"normal",text:"Close"},{hidden:true,align:"right",ui:"normal",iconCls:"order",tag:"calculator"},{hidden:true,align:"right",ui:"normal",iconCls:"refresh",tag:"refresh",handler:function(){if(wssocket){wssocket.send("get_receipts");}}}]})]},createView:function(){var f=this;if(!f.callParent(arguments)){return;}var g=1+Genesis.constants.defaultIconSize()+2*Genesis.fn.calcPx(0.65,1),d=Ext.StoreMgr.get("ReceiptStore"),c=Genesis.db.getLocalDB();var e=isPosEnabled();var b=((c.rewardModel=="items_purchased")?4:0);console.debug("createView - rewardModel["+c.rewardModel+"]");var a=function(h,i){return({docked:"bottom",cls:"toolbarBottom",tag:h,hidden:i,xtype:"container",layout:{type:"vbox",pack:"center"},showAnimation:{type:"slideIn",duration:500,direction:"up"},hideAnimation:{type:"slideOut",duration:500,direction:"down"},items:[{xtype:"segmentedbutton",allowMultiple:false,defaults:{iconMask:true,ui:"blue",flex:1},items:[{iconCls:"rewards",tag:"rewardsSC",text:"Earn Points"}],listeners:{toggle:function(j,k,l){j.setPressedButtons([]);}}}]});};f.getPreRender().push(Ext.create("Ext.Container",{xtype:"container",tag:"rewards",layout:{type:"card",animation:{duration:600,easing:"ease-in-out",type:"slide",direction:"down"}},defaults:{hidden:true},activeItem:(e)?2:b,items:[{xtype:"calculator",tag:"amount",title:"Amount Spent",placeHolder:"0.00",bottomButtons:[{tag:"earnPts",text:"GO!",ui:"orange-large"}]},{xtype:"calculator",tag:"phoneId",title:"Enter Mobile Number",placeHolder:"8005551234",bottomButtons:[{tag:"earnTagId",text:"Submit",ui:"orange-large"}]},{xtype:"container",tag:"posSelect",layout:"hbox",items:[{docked:"top",hidden:(d.getCount()<=0),xtype:"selectfield",labelWidth:"50%",label:"Sort Receipts By :",tag:"tableFilter",name:"tableFilter",margin:"0 0 0.8em 0",usePicker:true,store:"TableStore",displayField:"id",valueField:"id",showAnimation:{type:"slideIn",duration:500,direction:"down"},hideAnimation:{type:"slideOut",duration:500,direction:"up"},defaultPhonePickerConfig:{height:(12.5*1.5)+"em",doneButton:{ui:"normal"}}},{xtype:"list",flex:1,store:"ReceiptStore",loadingText:null,plugins:[{type:"pullrefresh",refreshFn:function(h){if(wssocket){wssocket.send("get_receipts");}}},{type:"listpaging",autoPaging:true,loadMoreText:"",noMoreRecordsText:""}],mode:"MULTI",preventSelectionOnDisclose:true,scrollToTopOnRefresh:true,refreshHeightOnUpdate:false,variableHeights:false,itemHeight:g,deferEmptyText:false,emptyText:" ",tag:"receiptList",cls:"receiptList",itemTpl:Ext.create("Ext.XTemplate",'<div class="photo">{[this.getPrice(values)]}</div><div class="listItemDetailsWrapper"><div class="itemDistance">{[this.getDate(values)]}</div><div class="itemTitle">{title}</div></div>',{getPrice:function(h){return"$"+Number(h.price).toFixed(2);},getDate:function(h){return Genesis.fn.convertDate(new Date(h.id*1000));}}),onItemDisclosure:Ext.emptyFn},a("tbBottomSelection",(d.getCount()<=0))]},{xtype:"container",tag:"posDetail",layout:"hbox",items:[{flex:1,xtype:"dataview",tag:"receiptDetail",cls:"receiptDetail",store:{fields:["receipt"]},itemTpl:Ext.create("Ext.XTemplate",'<div class="listItemDetailsWrapper"><div class="itemReceipt">{[this.getReceipt(values)]}</div></div>',{getReceipt:function(h){var j="";for(var k=0;k<h.receipt.length;k++){j+="<pre>"+h.receipt[k].replace("\n","").replace("/r","")+"</pre>";}return j;}})},a("tbBottomDetail",false)]},{xtype:"calculator",tag:"itemsPurchased",title:"Stamp Points",placeHolder:"0",hideZero:true,bottomButtons:[{tag:"earnPts",text:"Stamp Me!",ui:"orange-large"}]}]}));},inheritableStatics:{}});Ext.define("Genesis.view.server.Redemptions",{extend:"Genesis.view.RedeemBase",requires:["Genesis.view.widgets.RewardPtsItem"],alias:"widget.serverredemptionsview",config:{defaultItemType:"rewardptsitem",redeemTitleText:"Rewards available to redeem (Select an item below)",listCls:"redemptionsList",scrollable:undefined,cls:"redemptionsMain viewport",layout:"vbox",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Rewards",items:[{align:"left",tag:"back",ui:"normal",text:"Back"}]})]},createView:function(a){if(!this.callParent(arguments)){return;}this._createView("RedeemStore","RedemptionRenderCStore",a);},inheritableStatics:{getPhoto:function(a){var b=null;switch(a.value){default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.view.server.Prizes",{extend:"Genesis.view.RedeemBase",requires:["Genesis.view.widgets.PrizePtsItem"],alias:"widget.serverprizesview",config:{defaultItemType:"prizeptsitem",redeemTitleText:"Prizes available to redeem (Select an item below)",listCls:"prizesList",scrollable:undefined,cls:"prizesMain viewport",layout:"vbox",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Prizes",items:[{align:"left",tag:"back",ui:"normal",text:"Back"}]})]},createView:function(a){if(!this.callParent(arguments)){return;}this._createView("PrizeStore","PrizeRenderCStore",a);},inheritableStatics:{getPhoto:function(a){var b=null;switch(a.value){default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.view.widgets.server.RedeemItemDetail",{extend:"Genesis.view.widgets.ItemDetail",requires:["Ext.XTemplate","Genesis.view.widgets.RedeemItem"],alias:"widget.serverredeemitemdetailview",config:{itemXType:"redeemitem",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Prizes",items:[{hidden:true,align:"left",tag:"back",ui:"normal",text:"Back"},{hidden:true,align:"left",tag:"close",ui:"normal",text:"Close"}]}),{xtype:"container",flex:1,tag:"redeemItemCardContainer",layout:{type:"card",animation:{duration:600,easing:"ease-in-out",type:"slide",direction:"down"}},activeItem:0,items:[{xtype:"container",layout:{type:"vbox",pack:"center",align:"stretch"},tag:"redeemItemContainer",items:[{hidden:true,docked:"bottom",xtype:"component",tag:"authText",margin:"0 0.7 0.8 0.7",style:"text-align:center;",defaultUnit:"em",html:(function(){return"Tap your Mobile Device onto the Terminal"+Genesis.constants.addCRLF();})()},{hidden:true,docked:"bottom",cls:"bottomButtons",xtype:"container",tag:"bottomButtons",layout:"hbox",marginTop:0,defaults:{xtype:"button",flex:1},items:[{tag:"merchantRedeem",text:"GO!",ui:"orange-large"}]}]},{xtype:"calculator",tag:"phoneId",title:"Enter Mobile Number",placeHolder:"8005551234",bottomButtons:[{tag:"redeemTagId",text:"Submit",ui:"orange-large"}]}]}],listeners:[{element:"element",delegate:"div.itemPhoto",event:"tap",fn:"onRedeemItemTap"}]},onRedeemItemTap:function(c,g,d){var f=this,a=_application.getController("server.Viewport");a.self.playSoundFile(a.sound_files.clickSound);f.fireEvent("redeemItemTap",c);},showView:function(){var a=this,b=a.query("container[tag=redeemItemContainer]")[0];if(b){if(b.getInnerItems().length==0){b.add(a.getPreRender());}}Ext.defer(a.fireEvent,0.01*1000,a,["showView",a]);},createView:function(){var b=this,c=b.query("container[tag=redeemItemContainer]")[0];if(!Genesis.view.ViewBase.prototype.createView.call(b,arguments)&&c&&(c.getInnerItems().length>0)){var a=c.getInnerItems()[0];a.setData(b.item);a.updateItem(b.item);}else{b.setPreRender([{flex:1,xtype:b.getItemXType(),hideMerchant:true,data:b.item}]);}delete b.item;}});Ext.define("Genesis.controller.ControllerBase",{extend:"Ext.app.Controller",requires:["Ext.data.Store","Ext.util.Geolocation"],config:{animationMode:null},scanTaskWait:false,scanTask:null,establishConnectionMsg:"Connecting to Server ...",loginMsg:"Logging in ...",checkinMsg:"Checking in ...",loadingScannerMsg:"Loading Scanner ...",loadingMsg:"Loading ...",genQRCodeMsg:"Generating QRCode ...",missingLicenseKeyMsg:'License Key for this Device is missing. Press "Procced" to Scan the License Key into the device.',retrieveAuthModeMsg:"Retrieving Authorization Code from Server ...",noCodeScannedMsg:"No Authorization Code was Scanned!",lostNetworkConnectionMsg:"You have lost network connectivity",networkErrorMsg:"Error Connecting to Sever",noPeerDiscoveredMsg:"No Peers were discovered",notAtVenuePremise:"You must be inside the Merchant's premises to continue.",errorLoadingAccountProfileMsg:"Error Loading Account Profile",lostPosConnectionMsg:"Reestablishing connection to POS ...",invalidTagIdFormatMsg:function(a){return"Invalid "+a+"-digit Tag ID format (eg. 12345678)";},invalidPhoneIdFormatMsg:function(a){return"Invalid "+a+"-digit Telephone format (eg. 8005551234)";},transactionCancelledMsg:"This transaction is cancelled",backToMerchantPageMsg:function(a){return("Would you like to visit our Main Page?");},geoLocationErrorMsg:function(){var a="This feature must require your GeoLocation to proceed.";if(Ext.os.is("Android")){a+='Enable Location Services under Main Screen of your phone: "Settings App >> Location Services >> GPS satellites"';}else{if(Ext.os.is("iOS")){a+=((Ext.os.version.isLessThan("6.0"))?'Enable Location Services under Main Screen of your phone: "Settings App >> Location Services >> KICKBAK"':'Enable Location Services under Main Screen of your phone: "Settings App >> Privacy >> Location Services >> KICKBAK"');}else{a+='Enable Location Services under Main Screen of your phone: "Settings App >> Location Services"';}}return a;},geoLocationTimeoutErrorMsg:"Cannot locate your current location. Try again or enable permission to do so!",geoLocationPermissionErrorMsg:"No permission to locate current location. Please enable permission to do so!",geoLocationUnavailableMsg:"To better serve you, please turn on your Location Services",geoLocationUseLastPositionMsg:"We are not able to locate your current location. Using your last known GPS Coordinates ...",getMerchantInfoMsg:"Retrieving Merchant Information ...",getVenueInfoMsg:"Retrieving Venue Information ...",prepareToSendMerchantDeviceMsg:"Prepare to send data across to Merchant Device ...",mobilePhoneInputMsg:"Enter Mobile Number",lookingForMerchantDeviceMsg:function(){return"Tap your Phone against the "+Genesis.constants.addCRLF()+"Merchant Device";},detectMerchantDeviceMsg:function(){return"Tap your Phone against the "+Genesis.constants.addCRLF()+"Merchant Device";},prepareToSendMobileDeviceMsg:"Prepare to send data across to Mobile Device ...",lookingForMobileDeviceMsg:function(){return"Please Swipe TAG or"+Genesis.constants.addCRLF()+"Tap Mobile Device";},detectMobileDeviceMsg:function(){return"Please Swipe TAG or"+Genesis.constants.addCRLF()+"Tap Mobile Device";},missingVenueInfoMsg:function(b){var a="";if(Ext.isString(b)){a=Genesis.constants.addCRLF()+b;}else{if(Ext.isObject(b)){a=Genesis.constants.addCRLF()+b.statusText;}}return("Error loading Venue information."+a);},showToServerMsg:function(){return("Please confirm to Proceed");},errProcQRCodeMsg:"Error Processing Authentication Code",cameraAccessMsg:"Accessing your Camera Phone ...",updatingServerMsg:"Updating Server ...",referredByFriendsMsg:function(a){return"Have you been referred "+Genesis.constants.addCRLF()+"by a friend to visit"+Genesis.constants.addCRLF()+a+"?";},recvReferralb4VisitMsg:function(a){return"Claim your reward points by becoming a customer at "+Genesis.constants.addCRLF()+a+"!";},showScreenTimeoutExpireMsg:function(a){return a+" are up! Press OK to confirm.";},showScreenTimeoutMsg:function(a){return"You have "+a+" to show this screen to a employee before it disappears!";},uploadFbMsg:"Uploading to Facebook ...",uploadServerMsg:"Uploading to server ...",inheritableStatics:{animationMode:{cover:{type:"cover",direction:"left",duration:400},coverUp:{type:"cover",direction:"up",duration:400},slide:{type:"slide",direction:"left",duration:400},slideUp:{type:"slide",direction:"up",duration:400},pop:{type:"pop",duration:400},flip:{type:"flip",duration:400},fade:{type:"fade",duration:400}},playSoundFile:function(b,a,c){if(Genesis.fn.isNative()){switch(b.type){case"FX":case"Audio":LowLatencyAudio.play(b.name,a||Ext.emptyFn,c||Ext.emptyFn);break;case"Media":b.successCallback=a||Ext.emptyFn;b.name.play();break;}}else{b.successCallback=a||Ext.emptyFn;Ext.get(b.name).dom.play();}},stopSoundFile:function(a){if(Genesis.fn.isNative()){switch(a.type){case"FX":case"Audio":LowLatencyAudio.stop(a.name);break;case"Media":a.name.stop();break;}}else{var b=Ext.get(a.name).dom;b.pause();b.currentTime=0;}},encryptFromParams:function(g,f){GibberishAES.size(256);var b=null,d=Genesis.fn.getPrivKey("venueId"),a=null;if((d>0)||(d<0)){try{switch(f){case"prize":a=Genesis.fn.getPrivKey("p"+d);case"reward":a=Genesis.fn.getPrivKey("r"+d);break;default:a=Genesis.fn.getPrivKey("r"+d);break;}b=(d>0)?d+"$":"";b+=GibberishAES.enc(Ext.encode(g),a);}catch(c){}}return b;},genQRCodeFromParams:function(c,d,h){var i=this;var f;GibberishAES.size(256);var a=Genesis.fn.getPrivKey("venueId");var j="";switch(d){case"prize":j=Genesis.fn.getPrivKey("p"+a);break;case"reward":j=Genesis.fn.getPrivKey("r"+a);break;default:j=Genesis.fn.getPrivKey("r"+a);break;}var b;if(a>0){try{b=new Date().addHours(3);f=GibberishAES.enc(Ext.encode(Ext.applyIf({expiry_ts:b.getTime()},c)),j);f=a+"$"+f;console.debug("Used key["+j+"]");console.log("\nEncrypted Code Length: "+f.length+"\nEncrypted Code ["+f+"]\nExpiry Date: ["+b+"]");}catch(g){}return(h)?[f,0,0]:i.genQRCode(f);}Ext.device.Notification.show({title:"Missing License Key!",message:i.prototype.missingLicenseKeyMsg,buttons:["Proceed","Cancel"],callback:function(e){if(e.toLowerCase()=="proceed"){_application.getController("Settings").fireEvent("upgradeDevice");}}});return(h)?["",0,0]:"";},genQRCode:function(e,c,f){c=c||3;f=f||10;var d=0;var b=QRCode(f,"L");b.addData(e);b.make();var a=b.createBase64(c,d);console.log("QR Code Minimum Size = ["+a[1]+"x"+a[1]+"]");return[a[0],a[1],a[1]];},genQRCodeInlineImg:function(e,c,f){c=c||4;f=f||8;var d=0;var a=QRCode(f,"L");a.addData(e);a.make();var b=a.createTableTag(c,d);return b;}},init:function(){this.callParent(arguments);this.on({scope:this,scannedqrcode:this.onScannedQRcode,locationupdate:this.onLocationUpdate,openpage:this.onOpenPage,updatemetadata:this.updateMetaDataInfo,triggerCallbacksChain:this.triggerCallbacksChain});var a=this.getViewPortCntlr();if(a!=this){a.relayEvents(this,["pushview","popview","silentpopview","resetview"]);a.on("animationCompleted",this.onAnimationCompleted,this);}},getViewPortCntlr:function(){return this.getApplication().getController(((merchantMode)?"server":"client")+".Viewport");},getViewport:function(){return this.getViewPortCntlr().getView();},getMainPage:Ext.emptyFn,openMainPage:Ext.emptyFn,openPage:Ext.emptyFn,goToMain:function(){var b=this;var a=b.getViewPortCntlr();if(a.setLoggedIn){a.setLoggedIn(true);}b.resetView();b.redirectTo("main");console.log("LoggedIn, Going to Main Page ...");},goToMerchantMain:function(d){var b=this;var a=b.getViewPortCntlr();var c=a.getCheckinInfo();var e=function(){b.resetView();if(c.venue){b.redirectTo("venue/"+c.venue.getId()+"/"+c.customer.getId()+"/1");}else{b.redirectTo("checkin");}};if(c.venue&&!d){Ext.device.Notification.show({title:c.venue.get("name").trunc(16),message:b.backToMerchantPageMsg(c.venue),buttons:["OK","Cancel"],callback:function(f){if(f.toLowerCase()=="ok"){e();}}});}else{e();}},isOpenAllowed:function(){return"Cannot Open Folder";},onBeforeNfc:function(g){var f=this,i=null,b=null;console.log("NDEF Message received");try{var j=g.tag,c=j.ndefMessage||[],b=nfc.bytesToHexString(j.id);var a=c[0].payload[0],h=c[0].payload.slice((1+a),c[0].payload.length);console.debug("NFC ndefID["+b+"] ndefMessage["+nfc.bytesToString(h)+"]");i={result:Ext.decode(nfc.bytesToString(h)),id:b};f.printNfcTag(g);}catch(d){console.log("Exception Thrown while processing NFC Tag["+d+"]");}return i;},onNfc:Ext.emptyFn,onScannedQRcode:Ext.emptyFn,onLocationUpdate:Ext.emptyFn,onOpenPage:function(e,c,b,d,f){if((appName=="GetKickBak")&&!Ext.device.Connection.isOnline()&&(e!="MainPage")){var a=me.getViewPortCntlr();if(!offlineDialogShown){Ext.device.Notification.show({title:"Network Error",message:me.lostNetworkConnectionMsg,buttons:["Dismiss"],callback:function(){offlineDialogShown=false;}});offlineDialogShown=true;}console.debug("Network Error - "+e+","+c);me.resetView();me.redirectTo(a.getLoggedIn()?"checkin":"login");return;}var g=this.getApplication();controller=g.getController(e);if(!c){controller.openMainPage();}else{controller.openPage(c,b);}},triggerCallbacksChain:function(){var c=this;var d=c.callBackStack.startIndex;var b=c.callBackStack.callbacks.length;for(var a=d;a<b;a++){c.callBackStack.startIndex++;if(c[c.callBackStack.callbacks[a]].apply(c,c.callBackStack["arguments"])){break;}}if(a>=b){console.debug("Clear Callback Chain["+a+"].");c.callBackStack.startIndex=0;c.callBackStack["arguments"]=[];}},updateMetaDataInfo:function(b){var c=this,a=c.getViewPortCntlr();a.updateMetaDataInfo(b);},checkReferralPrompt:function(a,d){var g=this;var f=g.getViewPortCntlr();var e=f.getCustomer();var b=f.getVenue().getMerchant();var h=b.getId();var i=a||Ext.emptyFn;var c=d||Ext.emptyFn;if(Customer.isValid(e.getId())&&(e.get("visits")<2)&&(!Genesis.db.getReferralDBAttrib("m"+h))){console.debug("Customer Visit Count["+e.get("visits")+"]");Ext.device.Notification.show({title:"Referral Challenge",message:g.referredByFriendsMsg(b.get("name")),buttons:["Yes","No"],callback:function(j){if(j.toLowerCase()=="yes"){Ext.defer(function(){g.fireEvent("openpage","client.Challenges","referrals",i);},1,g);}else{c();}}});}else{c();}},earnRedeemPopup:function(b){var a=this;if(!a.earnRedeemPopup){a.earnRedeemPopup=(Ext.create("Ext.Sheet",{bottom:0,left:0,top:0,right:0,padding:"1.0",hideOnMaskTap:false,defaultUnit:"em",cls:"x-mask transmit-mask",layout:{type:"vbox",pack:"middle"},defaults:{xtype:"container",defaultUnit:"em"},items:[{width:"100%",flex:1,style:"text-align:center;display:inline-table;color:white;font-size:1.1em;",html:a.fbConnectRequestMsg+'<img width="160" style="margin:0.7em 0;" src="resources/themes/images/v1/facebook_icon.png"/>'},{docked:"bottom",defaults:{xtype:"button",defaultUnit:"em",scope:a},padding:"0 1.0 1.0 1.0",items:[{margin:"0 0 0.5 0",text:"Proceed",ui:"action",handler:function(){a.earnRedeemPopup.hide();b();}},{margin:"0.5 0 0 0",text:"Cancel",handler:function(){a.earnRedeemPopup.hide();}}]}]}));Ext.Viewport.add(a.earnRedeemPopup);}a.earnRedeemPopup.show();},gravityThreshold:4,accelerometerHandler:function(a,c){var b=this;navigator.accelerometer.getCurrentAcceleration(function(d){if((d.z>=(9.81-b.gravityThreshold))&&(d.z<=(9.81+b.gravityThreshold))){if(a!=Genesis.constants.s_vol){window.plugins.proximityID.setVolume(Genesis.constants.s_vol);console.debug("Accelerometer new_vol="+Genesis.constants.s_vol);c(Genesis.constants.s_vol);}}else{if(a!=-1){window.plugins.proximityID.setVolume(-1);console.debug("Accelerometer new_vol=-1");c(-1);}}},{frequency:250});},getLocalID:function(g,d,b){var f=this,h=Genesis.constants,a=f.getViewPortCntlr();f.scanTaskWait=false;f.scanTask=null;var e=function(){f.scanTaskWait=false;window.plugins.proximityID.scan(function(i){clearInterval(f.scanTask);f.scanTask=null;window.plugins.proximityID.stop();var c=Genesis.fn.processRecvLocalID(i);if(c.message){f.self.playSoundFile(a.sound_files.nfcEnd);g(c);}},function(c){clearInterval(f.scanTask);f.scanTask=null;window.plugins.proximityID.stop();Ext.device.Notification.show({title:"Local Identity",message:"No ID Found! ErrorCode("+Ext.encode(c)+")",buttons:["Dismiss"]});f.self.playSoundFile(a.sound_files.nfcError);console.log("Error Code["+Ext.encode(c)+"]");d();},h.numSamples,h.conseqMissThreshold,h.magThreshold,h.sigOverlapRatio);};f.scanTask=setInterval(function(){if(!f.scanTaskWait){f.scanTaskWait=true;f.self.playSoundFile(a.sound_files.nfcError);window.plugins.proximityID.stop();Ext.device.Notification.show({title:"Local Identity",message:f.noPeerDiscoveredMsg,buttons:["Try Again","Cancel"],callback:function(c){if(c.toLowerCase()!="try again"){clearInterval(f.scanTask);f.scanTask=null;d();}else{Ext.defer(b,1);}}});}},h.proximityRxTimeout);e();return f.scanTask;},broadcastLocalID:function(f,a){var e=this,g=Genesis.constants,b;e.send_vol=-1;f=f||Ext.emptyFn;a=a||Ext.emptyFn;var d=function(){Ext.Ajax.abort();if(e.send_vol!=-1){window.plugins.proximityID.setVolume(-1);}window.plugins.proximityID.stop();if(b){clearInterval(b);}};window.plugins.proximityID.send(function(c){console.log("ProximityID : Broacasting Local Identity ...");f(Genesis.fn.processSendLocalID(c,d));},function(c){console.log("Error Code["+Ext.encode(c)+"]");d();a();});},persistStore:function(b){var c,a={CustomerStore:[Ext.StoreMgr.get("PersistentCustomerStore"),"CustomerStore","CustomerJSON"],LicenseStore:[Ext.StoreMgr.get("PersistentLicenseStore"),"LicenseStore","frontend.LicenseKeyJSON"]};console.debug("Looking for "+b);for(c in a){if(!a[c][0]){Ext.regStore("Persistent"+a[c][1],{model:"Genesis.model."+a[c][2],syncRemovedRecords:true,autoLoad:false});a[c][0]=Ext.StoreMgr.get("Persistent"+a[c][1]);}else{if(a[c][0].getStoreId()==("Persistent"+b)){return a[c][0];}}}return a[b][0];},persistLoadStores:function(o){var a="CREATE TABLE IF NOT EXISTS Customer (id INTEGER PRIMARY KEY AUTOINCREMENT, json TEXT)";var k="SELECT * FROM Customer";var h=this,m,c,l,b,g=69632,f=h.getViewPortCntlr(),n=[[this.persistStore("CustomerStore"),"CustomerStore",1],[this.persistStore("LicenseStore"),"LicenseStore",256]];o=o||Ext.emptyFn;for(c=0;c<n.length;c++){m=Ext.StoreMgr.get(n[c][1]);if(!m){console.debug("Cannot find Store["+n[c][1]+"] to be restored!");}try{n[c][0].load({callback:function(q,p){g|=n[c][2];var j=[];if(p.wasSuccessful()){m.removeAll();for(l=0;l<q.length;l++){var r=q[l].get("json");j.push(r);}m.setData(j);console.debug("persistLoadStores  --- Restored "+q.length+" records to "+n[c][1]);}else{console.debug("Error Restoring "+n[c][1]+" ...");}if(n[c][1]=="CustomerStore"){var i=openDatabase("KickBak","1.0",n[c][1],5*1024*1024);try{i.transaction(function(e){e.executeSql(a,[],function(){console.debug("Successfully created/retrieved KickBak-Customers Table");},function(t,u){console.debug("Failed to create KickBak-Customers Table : "+u.message);});e.executeSql(k,[],function(u,t){var v=[];var w=t.rows;for(b=0,item=null;b<w.length;b++){item=w.item(b);v.push(Ext.decode(item.json));}Ext.StoreMgr.get("CustomerStore").add(v);if((g|=16)==69905){o();}console.debug("persistLoadStores  --- Restored "+v.length+" records from SQL Database, flag="+g);},function(t,u){console.debug("No Customer Table found in SQL Database : "+u.message);});});}catch(s){}}if(g==69905){o();}}});}catch(d){console.log("Stack Trace - ["+d.stack+"]");Ext.device.Notification.show({title:"Account Profile",message:h.errorLoadingAccountProfileMsg,buttons:["Dismiss"],callback:function(){f.resetView();f.redirectTo("login");}});}}},persistSyncStores:function(g,l){var a="CREATE TABLE IF NOT EXISTS Customer (id INTEGER PRIMARY KEY AUTOINCREMENT, json TEXT)";var h="INSERT INTO Customer (json) VALUES (?)";var o="DROP TABLE Customer";var c,j,f,n,k=[[this.persistStore("CustomerStore"),"CustomerStore","Genesis.model.CustomerJSON"],[this.persistStore("LicenseStore"),"LicenseStore","Genesis.model.frontend.LicenseKeyJSON"]];if(!g||(g==k[0][1])){var m=openDatabase("KickBak","1.0","CustomerStore",5*1024*1024);var b=Ext.StoreMgr.get("CustomerStore");try{m.transaction(function(e){e.executeSql(o,[],function(p,i){console.debug("Successfully drop KickBak-Customers Table");},function(i,p){console.debug("Failed to drop KickBak-Customers Table : "+p.message);});e.executeSql(a,[],function(p,i){console.debug("Successfully created/retrieved KickBak-Customers Table");},function(i,p){console.debug("Failed to create KickBak-Customers Table : "+p.message);});if(!l){f=b.getRange();for(j=0;j<f.length;j++){item=f[j];e.executeSql(h,[Ext.encode(item.getData(true))],function(){},function(i,p){console.debug("Failed to insert Customer("+item.getId()+") to Database : "+p.message);});}console.debug("persistSyncStores  --- Inserted "+f.length+" records in Database ...");}});}catch(d){}k[0][0].removeAll();k[0][0].getProxy().clear();k[0][0].sync();}for(c=1;c<k.length;c++){if(!g||(k[c][1]==g)){k[c][0].removeAll();k[c][0].getProxy().clear();if(!l){f=Ext.StoreMgr.get(k[c][1]).getRange();for(j=0;j<f.length;j++){n=f[j].getData(true);k[c][0].add(Ext.create(k[c][2],{json:n}));}console.debug("persistSyncStores  --- Found "+f.length+" records in ["+k[c][1]+"] ...");}k[c][0].sync();}}},resetView:function(a){this.fireEvent("resetview");},pushView:function(a){this.fireEvent("pushview",a,this.getAnimationMode());},silentPopView:function(a){this.fireEvent("silentpopview",a);},popView:function(){this.fireEvent("popview");},geoRetryAttempts:3,getGeoLocation:function(d){var g=this,f=d||0,c=g.getViewPortCntlr(),b=c.getLastPosition();var e={autoUpdate:false,maximumAge:60*1000,timeout:2*1000,allowHighAccuracy:true,enableHighAccuracy:true};console.debug("Getting GeoLocation ...");if(!Genesis.fn.isNative()){g.fireEvent("locationupdate",{coords:{getLatitude:function(){return"-50.000000";},getLongitude:function(){return"50.000000";}}});return;}var a=function(k,j){if(!k){console.log("No GeoLocation found!");return;}var i={coords:k};console.debug("\nLatitude: "+k.getLatitude()+"\nLongitude: "+k.getLongitude()+"\nAltitude: "+k.getAltitude()+"\nAccuracy: "+k.getAccuracy()+"\nAltitude Accuracy: "+k.getAltitudeAccuracy()+"\nHeading: "+k.getHeading()+"\nSpeed: "+k.getSpeed()+"\nTimestamp: "+new Date(k.getTimestamp())+"\n");c.setLastPosition(i);g.fireEvent("locationupdate",i);};var h=function(m,i,j,l,k){console.debug("GeoLocation Error["+k+"]");if(i){console.debug("TIMEOUT");if(!b){Ext.device.Notification.show({title:"Timeout Error",message:g.geoLocationTimeoutErrorMsg,buttons:["Dismiss"],callback:function(){g.fireEvent("locationupdate",b);}});}else{g.fireEvent("locationupdate",b);}}else{if(l){if(f<g.geoRetryAttempts){console.debug("Retry #"+f);Ext.defer(g.getGeoLocation,0.25*1000,g,[++f]);}else{console.debug("POSITION_UNAVAILABLE");if(!b){Ext.device.Notification.show({title:"Location Services",message:g.geoLocationUnavailableMsg,buttons:["Dismiss"],callback:function(){g.fireEvent("locationupdate",b);}});}else{g.fireEvent("locationupdate",b);}}}else{console.debug("PERMISSION_DENIED");c.setLastPosition(null);g.fireEvent("locationupdate",null);}}};if(!g.geoLocation){g.geoLocation=Ext.create("Ext.util.Geolocation",Ext.applyIf({listeners:{locationupdate:a,locationerror:function(m,i,j,l,k){if(i&&(f<g.geoRetryAttempts)){f=g.geoRetryAttemptsme;g.getGeoLocation(f);}else{h(m,i,j,l,k);}}}},e));}g.geoLocation.updateLocation(null,null,(f>=g.geoRetryAttempts)?Ext.applyIf({allowHighAccuracy:false,enableHighAccuracy:false},e):e);},scanQRCode:function(){var b=this;var e=function(f){var g;Ext.Viewport.setMasked(null);if(Genesis.fn.isNative()){switch(window.plugins.qrCodeReader.scanType){case"RL":g=(f.response==undefined)?"":(f.response||"");console.debug("QR Code RL  = "+g);break;case"Nigma":g=(f.response==undefined)?"":(f.response||"");if(!g){console.debug("QR Code Nigma = Empty");}else{console.debug("QR Code Nigma = "+((g.responseCode)?g.responseCode:"NONE")+" Sent = "+g.bytesSent+" bytes");}if(g&&g.responseCode){g=g.responseCode;}break;case"Default":g=f;if(!g||g.format!="QR_CODE"){g=null;console.debug("QR Code Default = Unsupported Code");if(device.platform.match(/simulator/i)){g=Math.random().toFixed(16);}}else{if(g.cancelled){g=Math.random().toFixed(16);}else{g=g.text;}}console.debug("QR Code Default = "+((g)?g:"NONE"));break;}}else{g=f.response;console.debug("QR Code = "+g);}Ext.device.Notification.beep();b.fireEvent("scannedqrcode",g);};var a=function(f){Ext.Viewport.setMasked(null);console.debug("Failed because: "+f);Ext.device.Notification.beep();b.fireEvent("scannedqrcode",null);};console.debug("Scanning QR Code ...");if(!Genesis.fn.isNative()){var d="0";if(!merchantMode){var c=b.getViewPortCntlr().getVenue()||Ext.StoreMgr.get("CheckinExploreStore").first()||null;d=c?c.getId():"0";}e({response:d});}else{Ext.Viewport.setMasked({xtype:"loadmask",message:b.loadingScannerMsg});window.plugins.qrCodeReader.getCode(e,a);}},tnfToString:function(a){var b=a;switch(a){case ndef.TNF_EMPTY:b="Empty";break;case ndef.TNF_WELL_KNOWN:b="Well Known";break;case ndef.TNF_MIME_MEDIA:b="Mime Media";break;case ndef.TNF_ABSOLUTE_URI:b="Absolute URI";break;case ndef.TNF_EXTERNAL_TYPE:b="External";break;case ndef.TNF_UNKNOWN:b="Unknown";break;case ndef.TNF_UNCHANGED:b="Unchanged";break;case ndef.TNF_RESERVED:b="Reserved";break;}return b;},showProperty:function(a,b){console.log("Name["+a+"] Value["+b+"]");},printNfcTag:function(f){var e=this;function d(h){var n="",j=e.tnfToString(h.tnf),m=nfc.bytesToString(h.type),k;if(h.id&&(h.id.length>0)){n="Record Id: "+h.id+"\n";}switch(m){case"T":var g=h.payload[0],l=h.payload.slice((1+g),h.payload.length);k=nfc.bytesToString(l);break;case"U":var i=nfc.bytesToString(h.payload);k="URL["+i+"]";break;default:k=nfc.bytesToString(h.payload);break;}return(n+"TNF: "+j+"\nRecord Type: "+m+"\n"+k);}var a=f.tag,b=a.ndefMessage||[];console.log("Scanned an NDEF tag with "+b.length+" record"+((b.length===1)?"":"s"));if(a.id){e.showProperty("Id",nfc.bytesToHexString(a.id));}e.showProperty("Tag Type",a.type);e.showProperty("Max Size",a.maxSize+" bytes");e.showProperty("Is Writable",a.isWritable);e.showProperty("Can Make Read Only",a.canMakeReadOnly);for(var c=0;c<b.length;c++){console.log(d(b[c]));}}});Ext.define("Genesis.controller.ViewportBase",{extend:"Genesis.controller.ControllerBase",requires:["Ext.Sheet"],inheritableStatics:{},config:{sound_files:null,refs:{view:"viewportview",backButton:"button[tag=back]",closeButton:"button[tag=close]"},control:{view:{activate:"onActivate"},backButton:{tap:"onBackButtonTap"},closeButton:{tap:"onBackButtonTap"},"viewportview button":{tap:"onButtonTap"}}},mainPageStorePathToken:/\{platform_path\}/mg,popViewInProgress:false,viewStack:[],animationFlag:0,gatherCheckinInfoMsg:"Prepare to scan Check-in Code ...",retrieveChallengesMsg:"Retrieving Challenges ...",updateBadges:function(a){var c=this,b=Ext.StoreMgr.get("BadgeStore");if(a){b.setData(a);}},updateAccountInfo:function(a,b){var l=this,f=false,j=l.getViewPortCntlr();var p=Ext.StoreMgr.get("BadgeStore"),c=Ext.StoreMgr.get("CustomerStore");var h=j.getCustomer(),o=a.customer_id||((h)?h.getId():0);var g=function(){if(b&&(b.visits==1)){console.debug("Adding New Customer Record ...");var i=l.getApplication().getController("client.Merchants"),q=l.getApplication().getController("client.Checkins");var s=j.getCustomer(),r=Ext.create("Genesis.model.Customer",Ext.applyIf({id:o,merchant:s.getMerchant().raw},b));r.setLastCheckin(Ext.create("Genesis.model.Checkin"));c.add(r);i.getMain().cleanView(q.getExplore());q.fireEvent("setupCheckinInfo","checkin",j.getVenue(),r,a);console.debug("New Customer Record Added.");l.persistSyncStores("CustomerStore");h=r;}};if(o>0){console.debug("updateAccountInfo - customerId["+o+"]");h=c.getById(o);if(h){h.beginEdit();if(b){if(Ext.isDefined(b.points)){h.set("points",b.points);}if(Ext.isDefined(b.prize_points)){h.set("prize_points",b.prize_points);}if(Ext.isDefined(b.visits)){h.set("visits",b.visits);}if(Ext.isDefined(b.next_badge_visits)){h.set("next_badge_visits",b.next_badge_visits);}var e,n=[{id:b.badge_id,prefix:"Customer's Current Badge is - [",badgeId:"badge_id"},{id:b.next_badge_id,prefix:"Customer's Next Badge is - [",badgeId:"next_badge_id"}];for(e=0;e<n.length;e++){if(Ext.isDefined(n[e].id)){var k=p.getById(n[e].id);console.debug(n[e].prefix+k.get("type").display_value+"/"+k.get("visits")+"]");h.set(n[e].badgeId,n[e].id);}}var m=b.eligible_for_reward;if(Ext.isDefined(m)){h.set("eligible_for_reward",m);}var d=b.eligible_for_prize;if(Ext.isDefined(d)){h.set("eligible_for_prize",d);}}h.endEdit();l.persistSyncStores("CustomerStore");}else{g();}}else{g();}return h;},updateRewards:function(e){if(e&&(e.length>0)){var b,c=this,a=c.getViewPortCntlr(),d=a.getVenue().getMerchant();console.debug("Total Redemption Rewards - "+e.length);for(b=0;b<e.length;b++){e[b]["merchant"]=d;}Ext.StoreMgr.get("RedeemStore").setData(e);}},updatePrizes:function(b){if(b&&(b.length>0)){var c,d=this,a=d.getViewPortCntlr(),e=a.getVenue().getMerchant();console.debug("Total Redemption Prizes - "+b.length);for(c=0;c<b.length;c++){b[c]["merchant"]=e;}Ext.StoreMgr.get("PrizeStore").setData(b);}},updateNews:function(b){var a=Ext.StoreMgr.get("NewsStore");if(b&&(b.length>0)){console.debug("Total News Items - "+b.length);a.setData(b);}else{console.debug("No News Items");a.removeAll();}},updateAuthCode:function(a){var d=this,f=false,b=Genesis.db.getLocalDB();var c=a.auth_token,g=a.csrf_token,e=a.account;if(!c){return f;}f=true;if((c!=b.auth_code)||(g!=b.csrf_code)){b.auth_code=c;b.csrf_code=g;b.account=e||{};Genesis.db.setLocalDB(b);console.debug("\nauth_code ["+c+"]\ncsrf_code ["+g+"]\naccount ["+Ext.encode(e)+"]\ncurrFbId ["+b.currFbId+"]");}return f;},updateMetaDataInfo:function(b){var j=this,h=null,i=j.getViewPortCntlr(),k=Genesis.db.getLocalDB(),f=Ext.StoreMgr.get("CheckinExploreStore");try{if(j.updateAuthCode(b)){i.setLoggedIn(true);i.fireEvent("updateDeviceToken");if(!k.last_check_in){if((k.enableFB&&(k.currFbId>0))||k.disableFBReminderMsg||!Genesis.fn.isNative()){j.redirectTo("checkin");}else{Genesis.fb.createFBReminderMsg();}}return;}j.updateBadges(b.badges);h=j.updateAccountInfo(b,b.account_info);var c=b.venue_id||((f.first())?f.first().getId():0);venue=f.getById(c)||i.getVenue();if(Ext.isDefined(b.venue)){venue=Ext.create("Genesis.model.Venue",b.venue);var d=j.getApplication().getController("client.Checkins");var a=b.prize_jackpots;if(a>=0){console.debug("Prize Jackpots won by customers at this merchant this month - ["+a+"]");venue.set("prize_jackpots",a);}console.debug("customer_id - "+h.getId()+"\nmerchant_id - "+venue.getMerchant().getId()+"\n");d.fireEvent("setupCheckinInfo","checkin",venue,h,b);}else{var a=b.prize_jackpots;if(a>=0){console.debug("Prize Jackpots won by customers at this merchant this month - ["+a+"]");venue.set("prize_jackpots",a);}}j.updateRewards(b.rewards);j.updatePrizes(b.prizes);j.updateNews(b.newsfeed);}catch(g){console.debug("updateMetaDataInfo Exception - "+g);}return h;},onCompleteRefreshCSRF:Ext.emptyFn,onUpdateDeviceToken:Ext.emptyFn,onActivate:function(){var f=this,d=Ext.Loader.getPath("Genesis")+"/store/"+((!merchantMode)?"mainClientPage":"mainServerPage")+".json",g="",b=Genesis.db.getLocalDB();var e=new XMLHttpRequest(),c=b.enablePrizes,a=b.enableChallenges;if((typeof(device)!="undefined")&&device.uuid){if(Ext.os.is("iOS")){g="";}else{if(Ext.os.is("Android")){g="file:///android_asset/www/";}}}d=g+d;console.log("Loading MainPage Store ...");e.onreadystatechange=function(){if(e.readyState==4){if(e.status==200||e.status==0){var n=e.responseText.replace(f.mainPageStorePathToken,Genesis.constants._iconPath);console.log("Loaded MainPage Store ...");var h=Ext.decode(n);var m=h.data;for(var k=0;k<m.length;k++){var l=m[k];var j=m.indexOf(l);if(Ext.isDefined(c)){if(!c){if(l.id=="redeemPrizes"){m.splice(j,1);}}}if(Ext.isDefined(a)){if(!a){if(l.id=="challenges"){m.splice(j,1);}}}}Ext.StoreMgr.get("MainPageStore").setData(h.data);}}};e.open("GET",d,true);e.send(null);},onButtonTap:function(a,d,c){this.self.playSoundFile(this.sound_files.clickSound);},onBackButtonTap:function(a,d,c){this.popView();},resetView:function(){var b=this;var a=b.getViewport();b.viewStack=[];b.getApplication().getHistory().setActions([]);},pushView:function(b,d){if(!b){return;}var c=this;d=Ext.apply(d,{reverse:false});var a=(c.viewStack.length>1)?c.viewStack[c.viewStack.length-2]:null;if((c.viewStack.length>0)&&(b==c.viewStack[c.viewStack.length-1]["view"])){}else{if(a&&(a.view==b)){c.popView();}else{var e=c.getApplication().getHistory().getActions();c.viewStack.push({view:b,animation:d,url:e[e.length-1].getUrl()});c.getViewport().animateActiveItem(b,d);}}},silentPopView:function(b){var c=this;b=Math.min(c.viewStack.length,b);var d=c.getApplication().getHistory().getActions();if((c.viewStack.length>0)&&(b>0)){while(b-->0){var a=c.viewStack.pop();d.pop();}}},popView:function(){var c=this;var d=c.getApplication().getHistory().getActions();if(c.viewStack.length>1){var a=c.viewStack.pop();var b=c.viewStack[c.viewStack.length-1];if(!c.popViewInProgress){c.popViewInProgress=true;d.pop();if(b.view.isDestroyed){b.view=Ext.create(b.view.alias[0]);}c.getApplication().getHistory().setToken(b.url);window.location.hash=b.url;c.getViewport().animateActiveItem(b.view,Ext.apply(a.animation,{reverse:true}));}}else{if(!c.getLoggedIn||c.getLoggedIn()){c.goToMerchantMain(true);}else{c.redirectTo("login");}}},init:function(b){var a=this;Genesis.constants.init();a.callParent(arguments);QRCodeReader.prototype.scanType="Default";console.debug("QRCode Scanner Mode["+QRCodeReader.prototype.scanType+"]");if(Ext.isDefined(window.device)){console.debug("\ndevice.platform - "+device.platform+"\ndevice.uuid - "+device.uuid+"\nBrowser EngineVersion - "+Ext.browser.engineVersion+"");}a.on({viewanimend:"onViewAnimEnd",baranimend:{buffer:0.5*1000,fn:"onBarAnimEnd"},pushview:"pushView",silentpopview:"silentPopView",popview:"popView",resetview:"resetView"});Ext.regStore("LicenseStore",{model:"Genesis.model.frontend.LicenseKey",autoLoad:false,});a.last_click_time=new Date().getTime();document.addEventListener("click",function(d){var c=d.timeStamp;if(c&&(c-a.last_click_time)<1000){d.stopPropagation();d.preventDefault();return false;}a.last_click_time=c;return true;});console.log("ViewportBase Init");},loadSoundFile:function(a,b,d){var f=this,c="."+(b.split(".")[1]||"mp3");b=b.split(".")[0];if(Genesis.fn.isNative()){var g=function(){switch(d){case"FX":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,function(){console.debug("loaded "+b);},function(h){console.debug("Audio Error: "+h);});break;case"Audio":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,3,function(){console.debug("loaded "+b);},function(h){console.debug("Audio Error: "+h);});break;}};switch(d){case"Media":b=new Media((Ext.os.is("Android")?"/android_asset/www/":"")+"resources/audio/"+b+c,function(){f.sound_files[a].successCallback();},function(h){f.sound_files[a].successCallback();console.log("Audio Error: "+h);});break;default:LowLatencyAudio.unload(b,g,g);break;}}else{var e=Ext.get(b);if(e){e.dom.addEventListener("ended",function(){f.sound_files[a].successCallback();},false);}}f.sound_files[a]={name:b,type:d};},openMainPage:Ext.emptyFn});Ext.define("Genesis.controller.RedeemBase",{extend:"Genesis.controller.ControllerBase",inheritableStatics:{},xtype:"redeemBaseCntlr",config:{models:["PurchaseReward","CustomerReward"],listeners:{redeemitem:"onRedeemItem"}},controllerType:"redemption",redeemSuccessfulMsg:"Transaction Complete",redeemFailedMsg:"Transaction Failed",init:function(){var a=this;Ext.regStore(a.getRenderStore(),{model:"Genesis.model.Customer",autoLoad:false});Ext.regStore(a.getRedeemStore(),{model:"Genesis.model.CustomerReward",autoLoad:false,pageSize:5,sorters:[{property:"points",direction:"ASC"}],listeners:{scope:a,metachange:function(b,d,c){if(b.isLoading()){a.fireEvent("updatemetadata",d.getReader().metaData);}}}});this.callParent(arguments);console.log("RedeemBase Init");Ext.defer(function(){a.getRedeemItem();a.getRedemptions();},1,a);},onCreateView:function(b){var a=this;b.item=a.redeemItem;},onShowView:function(d){if(Ext.os.is("Android")){var b=this.getEventDispatcher().getPublishers()["elementSize"].monitors;var c=d.query("list[tag="+d.getListCls()+"]")[0];console.debug("Refreshing RenderStore ...");var a=d.query("dataview[tag=ptsEarnPanel]")[0];if(a){a.refresh();}b[c.container.getId()].forceRefresh();}},onActivate:function(e,l,p,h){var m=this;var k=m.getRedemptions();var j=m.getViewPortCntlr();var g=j.getCustomer();var n=Ext.StoreMgr.get(m.getRenderStore());var f=j.getCheckinInfo().venue;var b=j.getVenue();var a=b.getId();var o=b.getMerchant().getId();m.exploreMode=!f||(f&&(f.getId()!=b.getId()));if(g!=n.getRange()[0]){n.setData(g);}for(var d=0;d<e.getInnerItems().length;d++){}console.debug("ReedeemBase: onActivate");if(m.mixins&&m.mixins.redeemBase){m.mixins.redeemBase.onActivate.apply(m,arguments);}},onDeactivate:function(a,e,d,b){console.debug("ReedeemBase: onDeactivate");},onItemListSelect:function(c,a,b){c.deselect([a]);this.onItemListDisclose(c,a,null,null,null,null,null,false);return false;},onItemListDisclose:function(h,b,f,c,g,i,a,k){var j=this;var d=j.getViewPortCntlr();var l=function(){if(d.getCustomer()){var e=d.getCustomer().get(j.getPtsProperty());var m=b.get("points");if(m>e){Ext.device.Notification.show({title:"Redeem"+j.getTitle(),message:j.needPointsMsg(m-e),buttons:["Dismiss"]});return;}}j.fireEvent("showredeemitem",b);};if(!k){j.self.playSoundFile(d.sound_files.clickSound);}switch(j.getBrowseMode()){case"redeemBrowse":if(!j.exploreMode){l();}else{Ext.device.Notification.show({title:"Warning",message:j.checkinFirstMsg,buttons:["Dismiss"]});}break;case"redeemBrowseSC":l();break;}return true;},onRedeemItemCreateView:function(c){var b=this;var a=b.getRedeemMainPage();a.item=b.redeemItem;},onRedeemItemActivate:function(g,h,b,e){var f=this,a=g.query("titlebar")[0],d=Ext.StoreMgr.get(f.getRedeemStore());f.getSCloseBB()[(d.getAllCount()==1)?"hide":"show"]();if(f.getSBackBB){f.getSBackBB()[(d.getAllCount()==1)?"show":"hide"]();}a.setTitle(f.getTitle());a.removeCls("kbTitle");console.log("Base onRedeemItemActivate - Updated RewardItem View!");},onRedeemItemDeactivate:function(a,f,e,b){var d=this;if(d.getSDoneBtn()){d.getSDoneBtn()["hide"]();}if(Genesis.fn.isNative()){window.plugins.proximityID.stop();}console.log("onRedeemItemDeactivate - Done with RewardItem View!");},onDoneTap:function(a,i,d,h,g){var f=this;var c=f.getRedeemMainPage();if(Genesis.fn.isNative()){if(Ext.os.is("iOS")){}else{if(Ext.os.is("Android")){}}}if(c.isPainted()&&!c.isHidden()){f.popView();}},onShowItemQRCode:function(d,c){var b=this;var a;var f="Redeem "+b.getTitle();a=Genesis.controller.ControllerBase.genQRCode(c);if(a[0]){var e=Ext.DomQuery.select("div.itemPoints",b.getRedeemItem().element.dom)[0];if(b.getSRedeemBtn()){b.getSRedeemBtn().hide();}if(b.getSDoneBtn()){b.getSDoneBtn()["show"]();}b.getSCloseBB().hide();if(e){Ext.fly(e).addCls("x-item-hidden");}b.fireEvent("refreshQRCode",a);Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:f,message:b.showQrCodeMsg,buttons:["OK"]});Ext.device.Notification.vibrate();}else{console.debug("onShowItemQRCode - QR Code encoding Error");}},redeemBrowsePage:function(){this.openPage("redeemBrowse");if(this.getCloseBtn()){this.getCloseBtn().show();this.getBackBtn().hide();}},getRedeemMainPage:function(){var a=this;var b=null;switch(a.getRedeemMode()){case"authReward":case"redeemPrize":case"redeemReward":a.setAnimationMode(Genesis.controller.ControllerBase.animationMode.coverUp);b=a.getRedeemItem();break;}return b;},getBrowseMainPage:function(){var b=this;var c=null;switch(b.getBrowseMode()){case"redeemBrowseSC":b.setAnimationMode(Genesis.controller.ControllerBase.animationMode.coverUp);break;case"redeemBrowse":default:b.setAnimationMode(Genesis.controller.ControllerBase.animationMode.cover);break;}var a=Ext.StoreMgr.get(b.getRedeemStore());if(a.getAllCount()==1){b.onItemListDisclose(null,a.first(),null,null,null,null,null,true);}else{c=b.getRedemptions();}return c;},openPage:function(a){var b=this;if(a.match(/Browse/)){b.setBrowseMode(a);b.pushView(b.getBrowseMainPage());}else{b.setRedeemMode(a);b.pushView(b.getRedeemMainPage());}},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.RewardRedemptionsBase",{extend:"Genesis.controller.RedeemBase",requires:["Ext.data.Store"],inheritableStatics:{},xtype:"rewardRedemptionsBaseCntlr",controllerType:"redemption",config:{redeeemSuccessfulMsg:"Reward selected has been successfully redeemed!",redeemInfoMsg:"Getting the Redemptions List ...",redeemPopupTitle:"Redeem Rewards",browseMode:"redeemBrowse",redeemMode:"redeemReward",renderStore:"RedemptionRenderCStore",redeemStore:"RedeemStore",redeemUrl:"setGetRewardsURL",redeemPath:"redeemBrowseRewardsSC",ptsProperty:"points",title:"Rewards",routes:{redemptions:"redeemBrowsePage",redeemRewardsChooseSC:"redeemChooseSCPage",redeemBrowseRewardsSC:"redeemBrowseSCPage",redeemReward:"redeemItemPage"},refs:{},control:{redemptions:{createView:"onCreateView",showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},redemptionsList:{select:"onItemListSelect",disclose:"onItemListDisclose"},redeemItem:{createView:"onRedeemItemCreateView",showView:"onRedeemItemShowView",activate:"onRedeemItemActivate",deactivate:"onRedeemItemDeactivate",redeemItemTap:"onRedeemItemTap"}}},xtype:"redemptionsBaseCntlr",checkinFirstMsg:"Please Check-In before redeeming Rewards",init:function(){var a=this;a.callParent(arguments);a.on({showredeemitem:"onShowRedeemItem",showQRCode:"onShowItemQRCode",refreshQRCode:"onRefreshQRCode"});console.log("RewardRedemptionsBase Init");},onRefreshQRCode:function(b){var f=this;var a=f.getRedeemMainPage();var h=a.query("carousel")[0];var e=h?h.getActiveItem():a.getInnerItems()[0];var g=e.query("component[tag=info]")[0];g.hide();var d=e.query("component[tag=itemPhoto]")[0];var c=Ext.get(Ext.DomQuery.select("img",d.element.dom)[0]);c.setStyle({width:Genesis.fn.addUnit(b[1]*1.5),height:Genesis.fn.addUnit(b[2]*1.5)});c.set({src:b[0]});},onShowRedeemItem:function(a){var b=this;b.redeemItem=a;b.redirectTo("redeemReward");},redeemItemPage:function(){this.openPage("redeemReward");}});Ext.define("Genesis.controller.PrizeRedemptionsBase",{extend:"Genesis.controller.RedeemBase",requires:["Ext.data.Store"],inheritableStatics:{},xtype:"prizeRedemptionsCntlr",controllerType:"prize",config:{redeemInfoMsg:"Getting the Prizes List ...",redeemPopupTitle:"Redeem Prizes",redeeemSuccessfulMsg:"Prize selected has been successfully redeemed!",timeoutPeriod:10,minPrizePts:1,browseMode:"redeemBrowse",redeemMode:"redeemPrize",renderStore:"PrizeRenderCStore",redeemStore:"PrizeStore",redeemPointsFn:"setRedeemPrizePointsURL",redeemUrl:"setGetPrizesURL",ptsProperty:"prize_points",title:"Prizes",routes:{prizes:"redeemBrowsePage",redeemPrize:"redeemItemPage"},refs:{},control:{redemptions:{createView:"onCreateView",showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},redemptionsList:{select:"onItemListSelect",disclose:"onItemListDisclose"},redeemItem:{createView:"onRedeemItemCreateView",showView:"onRedeemItemShowView",activate:"onRedeemItemActivate",deactivate:"onRedeemItemDeactivate",redeemItemTap:"onRedeemItemTap"}},listeners:{}},scanPlayTitle:"Spin and Play",init:function(){var a=this;a.callParent(arguments);a.on({showredeemitem:"onShowRedeemItem",showredeemprize:"onShowRedeemPrize",showQRCode:"onShowItemQRCode"});console.log("Prize Redemptions Init");},onShowRedeemItem:function(a){var b=this;b.redeemItem=a;b.redirectTo("redeemPrize");},onShowRedeemPrize:function(d,a,e){var b=this;var c=a;b.redeemItem=d;if(e>0){console.debug("Removing Last "+e+" Views from History ...");b.silentPopView(e);}b.redirectTo("redeemPrize");},onRedeemItemActivate:function(f,g,b,d){var e=this,a=f.query("titlebar")[0];e.getSCloseBB()[(e.getRedeemMode()!="authReward")?"show":"hide"]();e.getSBackBB()[(e.getRedeemMode()=="authReward")?"show":"hide"]();a.setTitle(e.getTitle());a.removeCls("kbTitle");if(e.getSRedeemBtn()){e.getSRedeemBtn()["show"]();}console.log("Base onRedeemItemActivate - Updated RewardItem View.");},redeemItemPage:function(){this.setTitle("Prizes");this.openPage("redeemPrize");}});Ext.define("Genesis.controller.SettingsBase",{extend:"Genesis.controller.ControllerBase",inheritableStatics:{},xtype:"settingsBaseCntlr",config:{termsOfServiceTitle:"Term of Service",privacyTitle:"Privacy",aboutUsTitle:"About Us",routes:{aboutus:"documentPage",privacy:"documentPage",termsOfUse:"multipartDocumentPage",settings:"openSettingsPage"},refs:{documentPage:{selector:"documentview",autoCreate:true,xtype:"documentview"},multipartDocumentPage:{selector:"multipartdocumentview",autoCreate:true,xtype:"multipartdocumentview"}}},termsLoaded:false,privacyLoaded:false,aboutUsLoaded:false,init:function(){this.callParent(arguments);this.getMultipartDocumentPage();this.getDocumentPage();console.log("Settings Base Init");},onTermsTap:function(c,j){var g=this,f=0,a=g.getViewPortCntlr(),i=[],h=g.getMultipartDocumentPage();h.query("title")[0].setTitle(g.getTermsOfServiceTitle());g.self.playSoundFile(a.sound_files.clickSound);if(!g.termsLoaded){var d=function(){for(var b=0;b<i.length;b++){h.setHtml(b,i[b].cardConfig);}g.redirectTo("termsOfUse");g.termsLoaded=true;};Ext.Ajax.request({async:true,disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../term_of_service.htm",callback:function(e,k,b){if(k||(b.status==0)){i[0]=b;b.cardConfig={title:"Terms of Use",html:b.responseText};if((f|=1)==17){d();}}else{console.debug("Error Loading Term of Service Document.");console.debug("Status code "+b.status);}}});Ext.Ajax.request({async:true,disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../program_rules.htm",callback:function(e,k,b){if(k||(b.status==0)){i[1]=b;b.cardConfig={title:"Program Rules",html:b.responseText};if((f|=16)==17){d();}}else{console.debug("Error Loading Program Rules Document.");console.debug("Status code "+b.status);}}});}else{g.redirectTo("termsOfUse");}},onPrivacyTap:function(c,g){var d=this;var a=d.getViewPortCntlr();var f=d.getDocumentPage();f.query("title")[0].setTitle(d.getPrivacyTitle());d.self.playSoundFile(a.sound_files.clickSound);if(!d.privacyLoaded){Ext.Ajax.request({disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../privacy.htm",callback:function(e,h,b){if(h||(b.status==0)){f.setHtml(b.responseText);d.redirectTo("privacy");d.privacyLoaded=true;}else{console.debug("Error Loading Privacy Document.");console.debug("Status code "+b.status);}}});}else{d.redirectTo("privacy");}},onAboutUsTap:function(c,g){var d=this;var a=d.getViewPortCntlr();var f=d.getDocumentPage();f.query("title")[0].setTitle(d.getAboutUsTitle());d.self.playSoundFile(a.sound_files.clickSound);if(d.aboutUsLoaded){Ext.Ajax.request({disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../about_us.htm",callback:function(e,h,b){if(h||(b.status==0)){f.setHtml(b.responseText);d.redirectTo("aboutUs");d.aboutUsLoaded=true;}else{console.debug("Error Loading About US Document.");console.debug("Status code "+b.status);}}});}else{d.redirectTo("aboutUs");}},onDeviceReset:function(a,c){},openSettingsPage:Ext.emptyFn,multipartDocumentPage:function(){this.openPage("multipartDocument");},documentPage:function(){this.openPage("document");},openPage:function(a){var b=this,c;switch(a){case"settings":c=b.getSettingsPage();b.setAnimationMode(b.self.animationMode.cover);break;case"multipartDocument":c=b.getMultipartDocumentPage();b.setAnimationMode(b.self.animationMode.slide);break;case"document":c=b.getDocumentPage();b.setAnimationMode(b.self.animationMode.slide);break;}b.pushView(c);},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.mixin.RedeemBase",{extend:"Ext.mixin.Mixin",inheritableStatics:{},config:{closeBtn:null,sDoneBtn:null,sRedeemBtn:null},phoneIdMaxLength:10,redeemPtsConfirmMsg:"Please confirm to submit",onEnterPhoneNum:function(){var b=this,a=b.getRedeemItemCardContainer();a.setActiveItem(1);},onTagIdBtnTap:function(h,c,d,i){var g=this,j=h.getText();var k=g.getPhoneId(),a=k.getValue(),f=a.length;switch(j){case"AC":k.reset();break;default:if(f<g.phoneIdMaxLength){a+=j;k.setValue(a);}break;}},onTagItTap:function(){var f=this,a=f.getViewPortCntlr(),b=f.getRedeemItemCardContainer();var e=f.getPhoneId(),c=e.getValue(),d=c.length;if(d==f.phoneIdMaxLength){f.self.playSoundFile(a.sound_files.nfcEnd);f.onRedeemItemTap(null);f.onNfc({id:null,result:{phoneID:c}});}else{f.self.playSoundFile(a.sound_files.nfcError);Ext.device.Notification.show({title:f.getRedeemPopupTitle(),message:f.invalidPhoneIdFormatMsg(f.phoneIdMaxLength),buttons:["Dismiss"]});}},onNfc:function(a){var b=this;b.redeemItemFn({data:b.self.encryptFromParams({uid:(a)?a.id:null,tag_id:(a)?a.result.tagID:null,phone_id:(a)?a.result.phoneID:null,expiry_ts:new Date().addHours(3).getTime()},"reward")},true);},onRefreshQRCode:function(b){var f=this;var a=f.getRedeemItem();var e=a.getInnerItems()[0];var d=e.query("component[tag=itemPhoto]")[0];var c=Ext.get(Ext.DomQuery.select("img",d.element.dom)[0]);c.set({src:b[0]});c.setStyle({width:Genesis.fn.addUnit(b[1]*1.25),height:Genesis.fn.addUnit(b[2]*1.25)});},onRedeemItem:function(a,b,j){var h=this,i=null;var e=h.getViewPortCntlr(),m=j.query("container[tag=redeemItemContainer]")[0].getInnerItems()[0];var c=(b)?b.getId():0;var g=h.getRedeemStore(),k=Ext.StoreMgr.get(g);var d={version:Genesis.constants.serverVersion,venue_id:c};var n=h.lookingForMobileDeviceMsg();var f=k.getProxy();var l=function(o){e.popUpInProgress=false;h._actions.hide();e.setActiveController(null);if(h.scanTask){clearInterval(h.scanTask);h.scanTask=null;}if(Genesis.fn.isNative()){window.plugins.proximityID.stop();}if(o&&(o.toLowerCase()=="manual")){Ext.Viewport.setMasked(null);h.onEnterPhoneNum();}else{if(!h.dismissDialog){Ext.Viewport.setMasked(null);h.onDoneTap();}}};h.dismissDialog=false;h.redeemItemFn=function(q,o){h.dismissDialog=o;l();Ext.Viewport.setMasked({xtype:"loadmask",message:h.establishConnectionMsg});console.log("Updating Server with Redeem information ... dismissDialog("+h.dismissDialog+")");CustomerReward[h.getRedeemPointsFn()](m.getData().getId());k.load({addRecords:true,scope:h,jsonData:{},doNotRetryAttempt:true,params:Ext.apply(d,q),callback:function(r,p){Ext.Viewport.setMasked(null);if(p.wasSuccessful()){Ext.device.Notification.show({title:h.getRedeemPopupTitle(),message:h.redeemSuccessfulMsg,buttons:["OK"],callback:function(){h.onDoneTap();}});}else{f.supressErrorsPopup=true;Ext.device.Notification.show({title:h.getRedeemPopupTitle(),message:h.redeemFailedMsg,buttons:["Dismiss"],callback:function(){f.supressErrorsCallbackFn();h.onDoneTap();}});}}});};if(!a){return;}if(!h._actions){h._actions=Ext.create("Genesis.view.widgets.PopupItemDetail",{iconType:"prizewon",icon:"rss",title:n,buttons:[{margin:"0 0 0.5 0",text:h.mobilePhoneInputMsg,ui:"action",height:"3em",handler:Ext.bind(l,h,["manual"])},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",height:"3em",handler:Ext.bind(l,h,["cancel"])}]});Ext.Viewport.add(h._actions);}e.popUpInProgress=true;h._actions.show();if(Genesis.fn.isNative()){h.getLocalID(function(o){i=o;h.redeemItemFn({data:h.self.encryptFromParams({frequency:i.localID,expiry_ts:new Date().addHours(3).getTime()},"reward")},true);},function(){h._actions.hide();h.onDoneTap();},Ext.bind(h.onRedeemItem,h,arguments));e.setActiveController(h);}},onRedeemItemTap:function(j,d,f,l){var h=this,a=j,g=h.getViewPortCntlr(),c=g.getVenue();var i=h.getRedeemMainPage(),k=i.query("titlebar")[0].getTitle();switch(h.getRedeemMode()){case"redeemPrize":case"redeemReward":h.fireEvent("redeemitem",a,c,i);break;}},onActivate:function(f,g,b,d){var e=this,a=e.getRedeemItemCardContainer();a.setActiveItem(0);console.debug("Server ReedeemBase: onActivate");},onRedeemItemCardContainerActivate:function(h,g,b,d){var e=this;var a=e.getRedeemItemCardContainer();var f=a.getLayout().getAnimation();switch(g.config.tag){case"redeemItemContainer":f.setReverse(true);break;case"phoneId":e.getPhoneId().reset();f.setReverse(true);break;}console.debug("Prizes Redeem ContainerActivate Called.");},onRedeemItemShowView:function(b){var a=this;console.log("onRedeemItemShowView - RedeemMode["+a.getRedeemMode()+"]");},onRedeemItemActivate:function(e,f,a,b){var d=this;d.getRedeemItemButtonsContainer()[(d.getRedeemMode()!="authReward")?"show":"hide"]();d.getAuthText()[(d.getRedeemMode()=="authReward")?"show":"hide"]();console.log("RewardItem View - Updated RewardItem View.");},});Ext.define("Genesis.controller.server.Settings",{extend:"Genesis.controller.SettingsBase",inheritableStatics:{},xtype:"serverSettingsCntlr",config:{licenseTitle:"Refresh License Key",routes:{},refs:{settingsPage:{selector:"serversettingspageview",autoCreate:true,xtype:"serversettingspageview"},utilitiesContainer:"serversettingspageview fieldset[tag=utilities]",merchantDevice:"serversettingspageview fieldset textfield[tag=merchantDevice]",createTagId:"servertagcreatepageview calculator[tag=createTagId] textfield[name=amount]",createTagBtn:"servertagcreatepageview container[tag=bottomButtons] button[tag=createTagId]",createTagPage:{selector:"servertagcreatepageview",autoCreate:true,xtype:"servertagcreatepageview"}},control:{"serversettingspageview listfield[name=resetdevice]":{clearicontap:"onDeviceResetTap"},"serversettingspageview listfield[name=license]":{clearicontap:"onRefreshLicenseTap"},"serversettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"serversettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"serversettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"},settingsPage:{activate:"onActivate",deactivate:"onDeactivate"},"serversettingspageview listfield[tag=createTag]":{clearicontap:"onCreateTagPageTap"},"servertagcreatepageview calculator[tag=createTagId] container[tag=dialpad] button":{tap:"onTagIdBtnTap"},createTagBtn:{tap:"onCreateTagTap"},createTagPage:{activate:"onCreateTagActivate",deactivate:"onCreateTagDeactivate"}},listeners:{}},tagIdLength:8,proceedToUpdateLicenseMsg:"Please confirm to proceed with License Update",proceedToResetDeviceeMsg:"Please confirm to Reset Device",noLicenseKeyScannedMsg:"No License Key was found!",createTagMsg:function(){return"To program the TAG ID,"+Genesis.constants.addCRLF()+"Please swipe tag.";},invalidTagMsg:function(){var a=this;return"TagID must be of a valid length["+a.tagIdLength+"]";},licenseKeySuccessMsg:function(){return"License Key Updated for "+Genesis.constants.addCRLF()+"["+Genesis.fn.getPrivKey("venue")+"]";},updateLicenseKey:function(){var b=this,a=b.getViewPortCntlr();a.refreshLicenseKey(function(){Ext.device.Notification.show({title:"License Key Updated!",message:b.licenseKeySuccessMsg(),buttons:["Restart"],callback:function(){navigator.app.exitApp();}});},true);},onDeviceResetTap:function(c,f){var d=this,a=d.getViewPortCntlr();d.self.playSoundFile(a.sound_files.clickSound);Ext.device.Notification.show({title:"Device Reset Confirmation",message:d.proceedToResetDeviceeMsg,buttons:["Confirm","Cancel"],callback:function(b){if(b.toLowerCase()=="confirm"){_application.getController("server.Receipts").fireEvent("resetReceipts");}}});},onRefreshLicenseTap:function(c,g,d){var f=this,a=f.getViewPortCntlr();f.self.playSoundFile(a.sound_files.clickSound);Ext.device.Notification.show({title:"License Key Refresh",message:f.proceedToUpdateLicenseMsg,buttons:["Proceed","Cancel"],callback:function(b){if(b.toLowerCase()=="proceed"){f.updateLicenseKey();}}});},onCreateTagPageTap:function(c,g,d){var f=this,a=f.getViewPortCntlr();f.self.playSoundFile(a.sound_files.clickSound);f.openPage("createTag");},onTagIdBtnTap:function(h,d,f,i){var g=this,j=h.getText();var k=g.getCreateTagId(),a=k.getValue(),c=a.length;if(c<g.tagIdLength){switch(j){case"AC":k.reset();break;default:a+=j;k.setValue(a);break;}}},onCreateTagTap:function(a,g,c){var f=this,d=f.getCreateTagId().getValue();if(Genesis.fn.isNative()){if(d.length!=f.tagIdLength){Ext.device.Notification.show({title:"Create Tag",message:f.invalidTagMsg(),buttons:["Dismiss"]});}else{f.getViewPortCntlr().setActiveController(f);Ext.device.Notification.show({title:"Create Tag",message:f.createTagMsg(),buttons:["Cancel"],callback:function(){f.getViewPortCntlr().setActiveController(null);}});}}},onBeforeNfc:function(a){this.writeTag(null);return null;},writeTag:function(d){var c=this,f=Genesis.constants.appMimeType,b=c.getCreateTagId().getValue();var g=function(){c.getViewPortCntlr().setActiveController(null);};var e=Ext.encode({tagID:b}),a=ndef.textRecord(e);console.log("Writing ["+e+"] to TAG ...");nfc.write([a],function(){Ext.device.Notification.show({title:"Create Tag",message:"Wrote data to TAG.",buttons:["OK"]});c.getCreateTagId().reset();g();},function(h){Ext.device.Notification.show({title:"Create Tag",message:"Error Writing data to TAG["+h+"]",buttons:["Dismiss"]});g();});},onActivate:function(h,i,a,d){var f=this,e=f.getSettingsPage(),b=Genesis.db.getLocalDB();f.getMerchantDevice().setLabel(Genesis.fn.getPrivKey("venue"));f.getUtilitiesContainer()[debugMode?"show":"hide"]();e.setValues({posMode:((b.isPosEnabled===undefined)||(b.isPosEnabled))?1:0,displayMode:b.displayMode||"Mobile"});var g=e.query("togglefield[tag=posMode]")[0];g.setReadOnly(b.enablePosIntegration?false:true);g[(b.enablePosIntegration)?"enable":"disable"]();},onDeactivate:function(e,f,a,b){var d=this;},onCreateTagActivate:function(e,f,a,b){var d=this;d.getCreateTagId().reset();},onCreateTagDeactivate:function(e,f,a,b){var d=this;},openSettingsPage:function(){this.openPage("settings");},openPage:function(a){var b=this,c;switch(a){case"createTag":c=b.getCreateTagPage();b.setAnimationMode(b.self.animationMode.cover);b.pushView(c);return;break;}b.callParent(arguments);}});Ext.define("Genesis.controller.MainPageBase",{extend:"Genesis.controller.ControllerBase",xtype:"mainPageBaseCntlr",config:{csrfTokenRecv:false,models:["frontend.MainPage","frontend.Signin","frontend.Account","Customer","User","Merchant","CustomerReward"],after:{mainPage:""},routes:{main:"mainPage"},refs:{},control:{main:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"}},listeners:{itemTap:"onItemTap"}},init:function(b){var a=this;a.callParent(arguments);Genesis.db.removeLocalDBAttrib("csrf_code");Ext.regStore("MainPageStore",{model:"Genesis.model.frontend.MainPage",autoLoad:false,listeners:{scope:a,refresh:a.initCallback}});console.log("MainPageBase Init");a.getMain();backBtnCallbackListFn.push(function(e){var d=((e==a.getMain())||((merchantMode)?false:(e==a.getLogin())));if(d){var c=a.getViewPortCntlr();a.self.playSoundFile(c.sound_files.clickSound);if(Ext.os.is("Android")){navigator.app.exitApp();}return true;}return false;});},onItemTap:function(c){var b=this.getViewPortCntlr();this.self.playSoundFile(b.sound_files.clickSound);console.log("Controller=["+c.get("pageCntlr")+"]");var a=this.getApplication().getController(c.get("pageCntlr"));var d=a.isOpenAllowed();if(d===true){if(c.get("route")){this.redirectTo(c.get("route"));}else{if(c.get("subFeature")){a.openPage(c.get("subFeature"));}else{a.openMainPage();}}}else{Ext.device.Notification.show({title:"Error",message:d,buttons:["Dismiss"]});}return false;},onShowView:function(a){if(Ext.os.is("Android")){}},mainPage:function(){this.openPage("main");},openPage:function(a){var c=this;switch(a){case"main":c.setAnimationMode(c.self.animationMode.pop);c.pushView(c.getMainPage());break;case"merchant":c.goToMerchantMain(true);break;case"login":var b=c.getApplication().getController("client.Checkins");b.fireEvent("setupCheckinInfo","checkin",null,null,null);c.setAnimationMode(c.self.animationMode.fade);c.pushView(c.getLogin());break;}},getMainPage:function(){var a=this.getMain();return a;},openMainPage:function(){var a=this.getViewPortCntlr();this.setAnimationMode(this.self.animationMode.pop);this.pushView(this.getMainPage());console.log("MainPage Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.MainPage",{extend:"Genesis.controller.MainPageBase",xtype:"mainPageCntlr",config:{models:["frontend.MainPage","CustomerReward"],refs:{main:{selector:"servermainpageview",autoCreate:true,xtype:"servermainpageview"},mainCarousel:"servermainpageview"}},initCallback:function(){var a=this;a.goToMain();var b=Genesis.fn.getPrivKey("venueId");if(b==0){Ext.device.Notification.show({title:"Missing License Key!",message:a.missingLicenseKeyMsg,buttons:["Cancel","Proceed"],callback:function(c){if(c.toLowerCase()=="proceed"){a.getApplication().getController("Settings").fireEvent("upgradeDevice");}}});}},init:function(b){var a=this;a.callParent(arguments);console.log("Server MainPage Init");},onNfc:function(a){var b=this;b.getApplication().getController("server.Merchants").onNfc(a);},onActivate:function(e,f,a,b){var d=this;d.getViewPortCntlr().setActiveController(d);},onDeactivate:function(a,f,e,b){var d=this;d.getViewPortCntlr().setActiveController(null);}});var onBackKeyDown=Ext.emptyFn;Ext.require(["Ext.device.Connection","Genesis.controller.ControllerBase"],function(){onBackKeyDown=function(g){if(!_application||Ext.Viewport.getMasked()){return;}var a=_application.getController("server.Viewport");if(!a||a.popViewInProgress){return;}else{if(Ext.device.Notification.msg&&!Ext.device.Notification.msg.isHidden()){Ext.device.Notification.dismiss();return;}else{if(!a.popUpInProgress){console.debug("BackButton Pressed");var f=a.getViewport();var j=(f)?f.getActiveItem():null;if(j){var h=false;for(var c=0;c<backBtnCallbackListFn.length;c++){h=backBtnCallbackListFn[c](j);if(h){break;}}if(!h){var d=j.query("button[tag=back]")[0];var b=j.query("button[tag=close]")[0];if((d&&!d.isHidden())||(b&&!b.isHidden())){a.self.playSoundFile(a.sound_files.clickSound);a.popView();}}}else{a.self.playSoundFile(a.sound_files.clickSound);navigator.app.exitApp();}}}}};});Ext.define("Genesis.controller.server.Viewport",{extend:"Genesis.controller.ViewportBase",requires:["Genesis.model.frontend.Receipt","Ext.dataview.List","Ext.XTemplate"],config:{customer:null,venue:null,metaData:null,checkinInfo:{venue:null,customer:null,metaData:null},activeController:null},setupInfoMissingMsg:"Trouble initializing Merchant Device",licenseKeyInvalidMsg:"Missing License Key",setupTitle:"System Initialization",unsupportedPlatformMsg:"This platform is not supported.",licenseKeySuccessMsg:function(){return"License Key Updated for "+Genesis.constants.addCRLF()+"["+Genesis.fn.getPrivKey("venue")+"]";},inheritableStatics:{},updateMetaDataInfo:function(a){try{var c=this,b=Genesis.db.getLocalDB();c.updateRewards(a.rewards);c.updatePrizes(a.prizes);a.reward_model=(!b.rewardModel)?a.reward_model||"amount_spent":a.reward_model;if(a.reward_model){Genesis.db.setLocalDBAttrib("rewardModel",a.reward_model);}}catch(d){console.debug("updateMetaDataInfo Exception - "+d);}},refreshLicenseKey:function(c,b){var a=this;c=c||Ext.emptyFn;if(!Genesis.fn.isNative()){Genesis.fn.getPrivKey();a.initializeConsole(c);return;}a.persistLoadStores(function(){var g=Ext.StoreMgr.get("LicenseStore");if((g.getRange().length<1)||(b)){Ext.Viewport.setMasked({xtype:"loadmask",message:a.loadingMsg});g.removeAll();LicenseKey.setGetLicenseKeyURL();g.load({addRecords:true,scope:a,jsonData:{},params:{device_id:device.uuid},callback:function(k,j){console.debug("Loading License Key ... Record Length("+k.length+")");if(j.wasSuccessful()&&k[0]){var m=k[0].get("venue_id");var i=k[0].get("venue_name");var l=Genesis.fn.privKey={venueId:m,venue:k[0].get("venue_name")};l["r"+m]=l["p"+m]=k[0].getId();a.persistSyncStores("LicenseStore");Genesis.db.resetStorage();a.initializeConsole(c);}else{if(!k[0]){a.initNotification(a.licenseKeyInvalidMsg);}else{g.getProxy()._errorCallback=Ext.bind(a.initNotification,a,[a.licenseKeyInvalidMsg]);}}}});}else{var e=g.getRange()[0];var h=e.get("venue_id");var d=e.get("venue_name");var f=Genesis.fn.privKey={venueId:h,venue:e.get("venue_name")};f["r"+h]=f["p"+h]=e.getId();a.initializeConsole(c);}});},initNotification:function(b){var a=this;Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:a.setupTitle,message:b,buttons:["Refresh License","Restart"],callback:function(c){if(!c||(c.toLowerCase()=="restart")){navigator.app.exitApp();}else{Ext.defer(function(){a.refreshLicenseKey(function(){Ext.device.Notification.show({title:"License Key Updated!",message:a.licenseKeySuccessMsg(),buttons:["Restart"],callback:function(){navigator.app.exitApp();}});},true);},100,a);}}});},initializeLicenseKey:function(){var b=this,a=b;Ext.Viewport.setMasked({xtype:"loadmask",message:b.loadingMsg});Ext.regStore("CustomerStore",{model:"Genesis.model.Customer",autoLoad:false});b.refreshLicenseKey(posConnect);},initializeConsole:function(h){var d=this,a=d,e=a.getCheckinInfo(),g=Genesis.fn.getPrivKey("venueId"),c=Venue.getProxy();var b=Genesis.db.getLocalDB();var f={venue_id:g};console.debug("Loaded License Key for Venue("+g+")...");Venue.setGetMerchantVenueExploreURL(g);Venue.load(g,{addRecords:true,jsonData:{},params:f,scope:d,callback:function(j,k){if(!b.enablePosIntegration||!b.isPosEnabled){Ext.Viewport.setMasked(null);}var i=c.getReader().metaData;if(k.wasSuccessful()&&i){i.features_config=i.features_config||{};console.debug("features_config - "+Ext.encode(i.features_config));a.setVenue(j);a.setMetaData(i);e.venue=a.getVenue();e.metaData=a.getMetaData();d.fireEvent("updatemetadata",i);d.getApplication().getController("server.Receipts").fireEvent("updatemetadata",i);console.debug("Successfully acquired dataset for Venue("+g+")");h();return;}else{if(!k.wasSuccessful()&&!i){c.supressErrorsPopup=true;console.log(d.setupInfoMissingMsg);}}d.initNotification(d.setupInfoMissingMsg);}});},applyActiveController:function(a){var b=this;if(!Genesis.fn.isNative()){return;}if(b._mimeTypeCallback){nfc.removeNdefListener(b._mimeTypeCallback,function(){console.log("Removed NDEF Listener for NFC detection ...");});delete b._mimeTypeCallback;}if(a&&Genesis.constants.isNfcEnabled){b._mimeTypeCallback=function(e){var d=b.getActiveController(),c=d.onBeforeNfc(e);if(c){if(d){console.log("Received Message ["+Ext.encode(c)+"]");d.onNfc(c);}else{console.log("Ignored Received Message ["+Ext.encode(c)+"]");}}};nfc.addNdefListener(b._mimeTypeCallback,function(){console.log("Listening for tags with NDEF type");},function(){console.warn("Failed to register NDEF type with NFC");});}return a;},onActivate:function(){var b=this,a=this;if(!a.getVenue()){b.callParent(arguments);}},init:function(f){var d,e=this,b,a,g=Genesis.constants;e.callParent(arguments);console.log("Server Viewport Init");e.initializeLicenseKey();Ext.defer(function(){this.sound_files={};var c=[["clickSound","click_sound","FX"],["nfcEnd","nfc_end","FX"],["nfcError","nfc_error","FX"],["beepSound","beep.wav","FX"]];for(d=0;d<c.length;d++){this.loadSoundFile.apply(this,c[d]);}},1,e);if(Genesis.fn.isNative()){b=0.4;g.s_vol=40;a=0.5;g.conseqMissThreshold=1;g.magThreshold=20000;g.numSamples=4*1024;g.sigOverlapRatio=0.25;g.proximityTxTimeout=20*1000;g.proximityRxTimeout=40*1000;Genesis.fn.printProximityConfig();window.plugins.proximityID.init(b,a);}if(isPosEnabled()){console.debug("Server Viewport - establishPosConn");window.plugins.WifiConnMgr.establishPosConn();}}});Ext.define("Genesis.controller.server.Challenges",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],inheritableStatics:{},xtype:"serverChallengesCntlr",config:{models:["PurchaseReward","CustomerReward"],refs:{challenges:"serverredeemitemdetailview[tag=redeemPrize]",authText:"serverredeemitemdetailview[tag=redeemPrize] component[tag=authText]"},control:{}},invalidAuthCodeMsg:"Authorization Code is Invalid",generatingAuthCodeMsg:"Generating Code ...",refreshAuthCodeMsg:"Refresing ...",challengeSuccessfulMsg:"Challenge Completed!",challengeFailedMsg:"Failed to Complete Challenge!",init:function(){this.callParent(arguments);console.log("Server Challenges Init");},generateQRCode:function(){return this.self.genQRCodeFromParams({type:"earn_points"},"challenge",false);},onRedeemItemDeactivate:function(b,g,f,d){var e=this,a=e.getViewPortCntlr();a.setActiveController(null);if(e.scanTask){clearInterval(e.scanTask);e.scanTask=null;}},onGenerateQRCode:function(d){var e=this,b=null,a=e.getViewPortCntlr(),c=Challenge.getProxy();e.dismissDialog=false;if(!d){Ext.defer(function(){var f=e.getApplication().getController("server.Prizes");var g=Genesis.constants._thumbnailAttribPrefix+"large";var i={};i[g]={url:e.self.getPhoto({value:"transmit"})};var h=Ext.create("Genesis.model.CustomerReward",{id:0,title:"Authorization",type:{value:"earn_points"},photo:i});f.fireEvent("authreward",h);},100,e);}e.challengeItemFn=function(g,f){e.dismissDialog=f;Ext.Viewport.setMasked({xtype:"loadmask",message:e.establishConnectionMsg});Ext.device.Notification.dismiss();g=Ext.merge(g,{venue_id:Genesis.fn.getPrivKey("venueId"),data:{type:"earn_points",expiry_ts:new Date().addHours(3).getTime()}});g.data=e.self.encryptFromParams(g.data);console.log("Updating Server with EarnPoints information ... dismissDialog("+e.dismissDialog+")");Challenge.setCompleteMerchantChallengeURL();Challenge.load(1,{addRecords:true,scope:e,jsonData:{},doNotRetryAttempt:true,params:g,callback:function(h,i){Ext.Viewport.setMasked(null);if(i.wasSuccessful()){Ext.device.Notification.show({title:"Challenge",message:e.challengeSuccessfulMsg,buttons:["OK"],callback:function(){e.popView();}});}else{c.supressErrorsPopup=true;Ext.device.Notification.show({title:"Challenge",message:e.challengeFailedMsg,buttons:["Dismiss"],callback:function(){c.supressErrorsCallbackFn();}});}}});};if(Genesis.fn.isNative()){e.getLocalID(function(f){b=f;e.challengeItemFn({data:{frequency:b.localID}},true);},function(){a.setActiveController(null);Ext.Viewport.setMasked(null);e.popView();},Ext.bind(e.onGenerateQRCode,e,arguments));a.setActiveController(e);}else{e.challengeItemFn({},false);}},openMainPage:function(){var a=this;a.onGenerateQRCode();},isOpenAllowed:function(){return true;},inheritableStatics:{getPhoto:function(a){var b=null;switch(a.value){case"transmit":b=Genesis.constants.getIconPath("prizewon",a.value);break;}return b;}}});Ext.define("Genesis.controller.server.Merchants",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],inheritableStatics:{googleMapStaticUrl:"http://maps.googleapis.com/maps/api/staticmap"},xtype:"servermerchantsCntlr",config:{routes:{"venue/:id/:id":"mainPage"},refs:{main:{selector:"servermerchantaccountview",autoCreate:true,xtype:"servermerchantaccountview"},form:"servermerchantaccountview formpanel",merchantMain:"servermerchantaccountview container[tag=merchantMain]",tbPanel:"servermerchantaccountview dataview[tag=tbPanel]",prizesBtn:"merchantaccountptsitem component[tag=prizepoints]",redeemBtn:"merchantaccountptsitem component[tag=points]"},control:{main:{showView:"onMainShowView",activate:"onMainActivate",deactivate:"onMainDeactivate"}}},init:function(){var a=this;Ext.regStore("MerchantRenderStore",{model:"Genesis.model.Venue",autoLoad:false});a.callParent(arguments);console.log("Merchants Server Init");a.getMain();backBtnCallbackListFn.push(function(c){if(c==a.getMain()){var b=a.getViewPortCntlr();a.self.playSoundFile(b.sound_files.clickSound);a.redirectTo("main");return true;}return false;});},getAccountFields:function(c){var b=this,a=b.getForm();return({birthday:{field:a.query("datepickerfield[name=birthday]")[0],fn:function(e){var d=new Date.parse(c.birthday);return(!d||!(d instanceof Date))?" ":d;}},phone:{field:a.query("textfield[name=phone]")[0],fn:function(e){var d=c.phone.match(Account.phoneRegex);return(d[1]+"-"+d[2]+"-"+d[3]);}}});},showAccountInfo:function(h,c){var b,g,e=this,a=e.getAccountFields(h),d=e.getForm();for(b in a){g=a[b];if(h[b]){g[b]=g.fn(g.field);}else{g[b]=null;}}d.setValues({birthday:a.birthday.birthday,phone:a.phone.phone,tagid:c,});d.query("textfield[name=user]")[0].setLabel(h.name+"<br/><label>"+h.email+"</label>");},onNfc:function(b){var c=this,e=Genesis.fn.getPrivKey("venueId"),a=c.getViewPortCntlr();b=b||{id:null,result:{tagID:null}};console.log("Retrieving Customer Account for ID["+b.id+"] tagID["+b.result.tagID+"], venueId["+e+"]");var d={device_pixel_ratio:window.devicePixelRatio,data:c.self.encryptFromParams({uid:b.id,tag_id:b.result.tagID,},"reward")};Ext.Viewport.setMasked({xtype:"loadmask",message:c.establishConnectionMsg});Customer.setGetCustomerUrl();Customer.load(e,{addRecords:true,scope:c,jsonData:{},params:d,callback:function(g,h){var f=Customer.getProxy().getReader().metaData;Ext.Viewport.setMasked(null);if(h.wasSuccessful()&&f){c.account=f.account;c.tagID=b.result.tagID;Ext.StoreMgr.get("CustomerStore").setData(g);a.setCustomer(g);var i=a.getCheckinInfo();i.customer=a.getCustomer();c.redirectTo("venue/"+e+"/"+i.customer.getId());}}});},checkInAccount:function(){var d=this;var a=d.getViewPortCntlr();var c=d.getViewport();var g=a.getVenue();var b=c.getEventDispatcher().controller;var f=new Ext.fx.layout.Card(d.self.animationMode.fade);f.on("animationend",function(){console.debug("Animation Complete");f.destroy();},d);console.log("Reloading current Merchant Home Account Page ...");var e=d.getMainPage();e.removeAll(true);c.animateActiveItem(e,f);f.onActiveItemChange(c.getLayout(),e,e,null,b);c.doSetActiveItem(e,null);},onMainShowView:function(c){var b=this;if(Ext.os.is("Android")){console.debug("Refreshing MerchantRenderStore ...");var a=this.getEventDispatcher().getPublishers()["elementPaint"].monitors;c.query("dataview[tag=tbPanel]")[0].refresh();a[c.element.getId()].onElementPainted({animationName:"x-paint-monitor-helper"});}b.showAccountInfo(b.account,b.tagID);},onMainActivate:function(b,h,l,f){console.debug("Merchant Account Activate");var i=this,g=i.getViewPortCntlr();var d=g.getVenue();var a=g.getCustomer();g.setActiveController(i);var k=Ext.StoreMgr.get("MerchantRenderStore");k.setData(d);i.onCustomerRecordUpdate(a);var j=b.getScrollable();j.getScroller().scrollTo(0,0);var e=b.query("titlebar")[0];e.setTitle(" ");Ext.defer(function(){e.setTitle(d.get("name"));},1,i);console.log("TagID["+i.tagID+"] Account Info ["+Ext.encode(i.account)+"]");},onMainDeactivate:function(b,g,f,d){var e=this;var a=e.getViewPortCntlr();a.setActiveController(null);a.setCustomer(null);Ext.StoreMgr.get("CustomerStore").removeAll(true);},onCustomerRecordUpdate:function(e){var c=this;var a=Ext.StoreMgr.get("MerchantRenderStore");if(a&&(a.getCount()>0)){if(a&&a.getRange()[0].getMerchant().getId()==e.getMerchant().getId()){var d=c.getPrizesBtn(),b=c.getRedeemBtn();var f;if(d){f=Ext.DomQuery.select("span",d.element.dom)[0];Ext.fly(f)[e.get("eligible_for_prize")?"removeCls":"addCls"]("x-item-hidden");}if(b){f=Ext.DomQuery.select("span",b.element.dom)[0];Ext.fly(f)[e.get("eligible_for_reward")?"removeCls":"addCls"]("x-item-hidden");}}}},mainPage:function(b,a){this.openMainPage();},getMainPage:function(){return this.getMain();},openMainPage:function(){var c=this;var b=c.getViewport();var a=c.getViewPortCntlr();var d=a.getVenue();if(c.getMainPage()==b.getActiveItem()){c.checkInAccount();}else{c.setAnimationMode(c.self.animationMode.pop);c.pushView(c.getMainPage());}console.log("Merchant Account Opened");}});Ext.define("Genesis.controller.server.Rewards",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],xtype:"serverRewardsCntlr",config:{mode:"Manual",models:["PurchaseReward","CustomerReward"],routes:{earnPts:"earnPtsPage"},refs:{rewards:{selector:"serverrewardsview",autoCreate:true,xtype:"serverrewardsview"},calcBtn:"serverrewardsview button[tag=calculator]",refreshBtn:"serverrewardsview button[tag=refresh]",receiptsList:"serverrewardsview container list",tableSelectField:"serverrewardsview selectfield[tag=tableFilter]",backBB:"serverrewardsview button[tag=back]",rptCloseBB:"serverrewardsview button[tag=rptClose]",receiptDetail:"serverrewardsview dataview[tag=receiptDetail]",rewardsContainer:"serverrewardsview container[tag=rewards]",rewardTBar:"serverrewardsview container[tag=tbBottomSelection]",rewardSelection:"serverrewardsview container[tag=tbBottomSelection] button[tag=rewardsSC]",rewardDetail:"serverrewardsview container[tag=tbBottomDetail] button[tag=rewardsSC]",amount:"serverrewardsview calculator[tag=amount] textfield",itemsPurchased:"serverrewardsview calculator[tag=itemsPurchased] textfield",phoneId:"serverrewardsview calculator[tag=phoneId] textfield",title:"serverrewardsview container[tag=qrcodeContainer] component[tag=title]"},control:{rptCloseBB:{tap:"onRptCloseTap"},calcBtn:{tap:"onCalcBtnOverrideTap"},rewards:{activate:"onActivate",deactivate:"onDeactivate"},rewardsContainer:{activeitemchange:"onContainerActivate"},receiptsList:{disclose:"onReceiptDisclose"},tableSelectField:{change:"onTableSelectFieldChange"},"serverrewardsview calculator[tag=amount] container[tag=dialpad] button":{tap:"onCalcBtnTap"},"serverrewardsview calculator[tag=amount] container[tag=bottomButtons] button[tag=earnPts]":{tap:"onEarnPtsTap"},"serverrewardsview calculator[tag=phoneId] container[tag=dialpad] button":{tap:"onTagIdBtnTap"},"serverrewardsview calculator[tag=phoneId] container[tag=bottomButtons] button[tag=earnTagId]":{tap:"onTagItTap"},"serverrewardsview calculator[tag=itemsPurchased] container[tag=dialpad] button":{tap:"onStampBtnTap"},"serverrewardsview calculator[tag=itemsPurchased] container[tag=bottomButtons] button[tag=earnPts]":{tap:"onEarnPtsTap"},rewardSelection:{tap:"onRewardSelectionTap"},rewardDetail:{tap:"onRewardDetailTap"}},listeners:{rewarditem:"onRewardItem"}},maxValue:1000,maxStampValue:9,phoneIdMaxLength:10,rewardSuccessfulMsg:"Transaction Complete",rewardFailedMsg:"Transaction Failed",invalidAmountMsg:"Please enter a valid amount (eg. 5.00), upto $1000",invalidStampMsg:"Please enter a valid Stamp amount (1-9)",earnPtsConfirmMsg:"Please confirm to submit",earnPtsTitle:"Earn Reward Points",selectRewardMsg:"Please select your Receipt(s)",unRegAccountMsg:function(){return("This account is unregistered"+Genesis.constants.addCRLF()+"Phone Number is required for registration");},init:function(){var a=this;a.callParent(arguments);console.log("Server Rewards Init");a.getRewards();Ext.StoreMgr.get("ReceiptStore").on({filter:"onReceiptStoreUpdate",addrecords:"onReceiptStoreUpdate",refresh:"onReceiptStoreUpdate",updaterecord:"onReceiptStoreUpdate",scope:a});backBtnCallbackListFn.push(function(d){var b=a.getViewPortCntlr(),c=d.query("button[tag=rptClose]")[0];if((d==a.getRewards())&&(c&&!c.isHidden())){b.self.playSoundFile(b.sound_files.clickSound);c.fireEvent("tap",c,null);return true;}return false;});},getAmountPrecision:function(b){var a=b.split(".");return((a.length>1)?a[1].length:0);},validateAmount:function(){var d=this,c,b=Genesis.db.getLocalDB();switch(b.rewardModel){case"items_purchased":c=d.getItemsPurchased().getValue();console.debug("Stamp Ammount = ["+c+"]");if(c<=0){Ext.device.Notification.show({title:"Validation Error",message:d.invalidStampMsg,buttons:["Dismiss"]});c=-1;}break;case"amount_spent":c=d.getAmount().getValue();console.debug("Ammount = ["+c+"]");var a=d.getAmountPrecision(c);if(a<2){Ext.device.Notification.show({title:"Validation Error",message:d.invalidAmountMsg,buttons:["Dismiss"]});c=-1;}break;case"visits":default:break;}return c;},onActivate:function(b,f,k,e){var g=this,a=g.getRewardsContainer(),i=Ext.StoreMgr.get("ReceiptStore"),j=Genesis.db.getLocalDB();var h=((j.rewardModel=="items_purchased")?4:0),d=isPosEnabled();if(a){g.getAmount().reset();g.getItemsPurchased().reset();g.onReceiptStoreUpdate(i);a.setActiveItem((d)?2:h);}if(debugMode){g.getCalcBtn()[(d)?"show":"hide"]();}g.getRefreshBtn()[(d)?"show":"hide"]();},onCalcBtnOverrideTap:function(a,i){var g=this,c=g.getRewardsContainer(),h=c.getLayout().getAnimation(),f=Genesis.db.getLocalDB();var d=((f.rewardModel=="items_purchased")?4:0);if(c){g.getAmount().reset();g.getItemsPurchased().reset();h.setDirection("down");c.setActiveItem(d);g.getRptCloseBB()["hide"]();g.getBackBB()["show"]();if(debugMode){g.getCalcBtn()["hide"]();}}},onDeactivate:function(a,f,e,b){var d=this;if(Genesis.fn.isNative()){window.plugins.proximityID.stop();}d.getViewPortCntlr().setActiveController(null);console.debug("Rewards onDeactivate Called. Reset Amount ...");},onContainerActivate:function(h,g,b,d){var e=this,a=e.getRewardsContainer(),f=a.getLayout().getAnimation();e.getRefreshBtn()[(g.config.tag=="posSelect")?"show":"hide"]();switch(g.config.tag){case"posSelect":f.setDirection("left");console.debug("Rewards ContainerActivate Called. Showing POS Receipts ...");break;case"posDetail":f.setDirection("right");console.debug("Rewards ContainerActivate Called. Showing POS Receipt Detail ...");break;case"amount":e.getAmount().reset();f.setReverse(true);console.debug("Rewards ContainerActivate Called. Reset Amount ...");break;case"itemsPurchased":e.getItemsPurchased().reset();f.setReverse(true);console.debug("Rewards ContainerActivate Called. Reset ItemsPurchased ...");break;case"phoneId":e.getPhoneId().reset();f.setReverse(true);console.debug("Rewards ContainerActivate Called. Reset PhoneID ...");break;case"qrcodeContainer":f.setDirection("down");f.setReverse(false);console.debug("Rewards ContainerActivate Called.");break;}},rewardItemCb:function(c){var d=this,a=d.getViewPortCntlr();a.popUpInProgress=false;d._actions.hide();a.setActiveController(null);if(d.scanTask){clearInterval(d.scanTask);d.scanTask=null;}if(Genesis.fn.isNative()){window.plugins.proximityID.stop();}if(c&&(c.toLowerCase()=="manual")){Ext.Viewport.setMasked(null);d.onEnterPhoneNum();}else{if(!d.dismissDialog){Ext.Viewport.setMasked(null);d.onDoneTap();}}},rewardItemFn:function(c,b){var l=this,j=l.getViewPortCntlr(),k=PurchaseReward.getProxy(),e=0,a=0,g=0,m=Genesis.db.getLocalDB();var f=isPosEnabled();switch(l.getMode()){case"Manual":e=l.getAmount().getValue();a=l.getItemsPurchased().getValue();g++;break;case"POS_Detail":case"POS_Selection":var h;for(var d=0;d<l.receiptSelected.length;d++){h=l.receiptSelected[d];e+=Number(h.get("subtotal"));a+=Number(h.get("itemsPurchased"));g++;}break;case"Visit":g++;break;default:break;}console.debug("Amount:$"+e+", ItemsPurchased = "+a+", Visits = "+g);l.dismissDialog=b;l.rewardItemCb();c=Ext.merge(c,{version:Genesis.constants.serverVersion,venue_id:Genesis.fn.getPrivKey("venueId"),data:{amount:e,items:Number(a),visits:Number(g),type:"earn_points",expiry_ts:new Date().addHours(3).getTime()}});l._params=c.data;c.data=l.self.encryptFromParams(c.data);Ext.Viewport.setMasked({xtype:"loadmask",message:l.establishConnectionMsg});console.log("Updating Server with Reward information ... dismissDialog("+l.dismissDialog+")");PurchaseReward.setMerchantEarnPointsURL();PurchaseReward.load(1,{addRecords:true,scope:l,jsonData:{},doNotRetryAttempt:true,params:c,callback:function(s,o){Ext.Viewport.setMasked(null);if(o.wasSuccessful()){var n=k.getReader().metaData;Ext.device.Notification.show({title:l.earnPtsTitle,message:l.rewardSuccessfulMsg,buttons:["OK"],callback:function(){l.onDoneTap();}});if(f){var u,r=[],t,v=Ext.StoreMgr.get("ReceiptStore"),w=Ext.StoreMgr.get("EarnedReceiptStore");for(var q=0;q<l.receiptSelected.length;q++){if(n.txn_id&&(n.txn_id>0)){l.receiptSelected[q].set("txnId",n.txn_id);}r.push(l.receiptSelected[q].getData(true));for(var p=0;p<r[q]["items"].length;p++){delete r[q]["items"][p]["id"];}}w.add(l.receiptSelected);_application.getController("server.Receipts").fireEvent("insertReceipts",r);l.getReceiptsList().deselectAll();v.filter();}}else{k.supressErrorsPopup=true;if(k.getReader().metaData){switch(k.getReader().metaData.rescode){case"unregistered_account":Ext.device.Notification.show({title:l.earnPtsTitle,message:l.unRegAccountMsg(),buttons:["Register","Cancel"],callback:function(i){k.supressErrorsCallbackFn();if(i.toLowerCase()=="register"){l.onEnterPhoneNum();}else{l.onDoneTap();}}});return;break;default:break;}}Ext.device.Notification.show({title:l.earnPtsTitle,message:l.rewardFailedMsg,buttons:["Dismiss"],callback:function(){k.supressErrorsCallbackFn();l.onDoneTap();}});}}});},onRewardItem:function(e){var d=this,b=null,a=d.getViewPortCntlr(),c=PurchaseReward.getProxy();d.dismissDialog=false;if(!e){return;}if(!d._actions){d._actions=Ext.create("Genesis.view.widgets.PopupItemDetail",{iconType:"prizewon",icon:"rss",title:(Genesis.fn.isNative())?d.lookingForMobileDeviceMsg():d.genQRCodeMsg,buttons:[{margin:"0 0 0.5 0",text:d.mobilePhoneInputMsg,ui:"action",height:"3em",handler:Ext.bind(d.rewardItemCb,d,["manual"])},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",height:"3em",handler:Ext.bind(d.rewardItemCb,d,["cancel"])}]});Ext.Viewport.add(d._actions);}a.popUpInProgress=true;d._actions.show();if(Genesis.fn.isNative()){d.getLocalID(function(f){b=f;d.rewardItemFn({data:{frequency:b.localID}},true);},function(){d._actions.hide();d.onDoneTap();},Ext.bind(d.onRewardItem,d,arguments));a.setActiveController(d);}},onEnterPhoneNum:function(){var c=this,b=c.validateAmount(),a=c.getRewardsContainer();if(b<0){return;}if(debugMode){c.getCalcBtn()["hide"]();}a.setActiveItem(1);},onEarnPtsTap:function(a,i,f,h){var g=this,c=g.getRewardsContainer(),d=g.validateAmount();if(d<0){return;}g.setMode("Manual");g.fireEvent("rewarditem",a);},onRewardDetailTap:function(a,g,c,f){var d=this;d.setMode("POS_Detail");d.fireEvent("rewarditem",a);},onRewardSelectionTap:function(a,j,f,i){var h=this,c=h.getRewardsContainer(),d=h.getReceiptsList(),g=d.getSelection();if(g&&(g.length>0)){h.receiptSelected=g;h.setMode("POS_Selection");h.fireEvent("rewarditem",a);}else{Ext.device.Notification.show({title:h.earnPtsTitle,message:h.selectRewardMsg,buttons:["Cancel"]});}},onCalcBtnTap:function(i,f,g,j){var h=this;var a=h.getAmount();var k=i.getText();switch(k){case"AC":a.reset();break;default:var c=a.getValue().length,d=Number(a.getValue()||0);if(c<2){if((d==0)&&(c>0)){d+=k;}else{d=(10*d)+Number(k);}}else{if(c==2){d=(d+k)/100;}else{d=(10*d)+(Number(k)/100);}d=d.toFixed(2);}if(d<=h.maxValue){a.setValue(d);}break;}},onStampBtnTap:function(i,f,g,j){var h=this;var a=h.getItemsPurchased();var k=i.getText();switch(k){case"AC":a.reset();break;default:var c=a.getValue().length,d=Number(a.getValue()||0);if((d==0)&&(c>0)){d=Number(k);}else{d=(10*d)+Number(k);}if(d<=h.maxStampValue){a.setValue(d);}break;}},onTagIdBtnTap:function(h,c,d,i){var g=this,j=h.getText();var k=g.getPhoneId(),a=k.getValue(),f=a.length;switch(j){case"AC":k.reset();break;default:if(f<g.phoneIdMaxLength){a+=j;k.setValue(a);}break;}},onTagItTap:function(){var e=this,a=e.getViewPortCntlr();var d=e.getPhoneId(),b=d.getValue(),c=b.length;if(c==e.phoneIdMaxLength){e.self.playSoundFile(a.sound_files.nfcEnd);e.onEarnPtsTap(null);e.onNfc({id:(e._params)?e._params.uid:null,result:{tagID:(e._params)?e._params.tag_id:null,phoneID:b}});delete e._params;}else{e.self.playSoundFile(a.sound_files.nfcError);Ext.device.Notification.show({title:e.earnPtsTitle,message:e.invalidPhoneIdFormatMsg(e.phoneIdMaxLength),buttons:["Dismiss"]});}},onRptCloseTap:function(a,f){var d=this;var c=d.getRewardsContainer();if(c){c.setActiveItem(2);d.getRptCloseBB()["hide"]();d.getBackBB()["show"]();if(debugMode){d.getCalcBtn()["show"]();}}},onReceiptDisclose:function(i,c,g,d,h,j,l){var k=this,f=k.getViewPortCntlr(),a=k.getRewardsContainer(),b=a.getLayout().getAnimation();k.self.playSoundFile(f.sound_files.clickSound);if(a){b.setDirection("left");a.setActiveItem(3);var m=k.getReceiptDetail().getStore();m.setData({receipt:Ext.decode(c.get("receipt"))});k.receiptSelected=[c];k.getRptCloseBB()["show"]();k.getBackBB()["hide"]();if(debugMode){k.getCalcBtn()["show"]();}}},onReceiptStoreUpdate:function(b){var d=this,a=Genesis.db.getLocalDB(),e=d.getReceiptsList(),f=(b.getCount()>0)?"show":"hide";var c=isPosEnabled();if(e){console.debug("Refreshing ReceiptStore ... count["+b.getCount()+"]");if(c&&d.getRewardTBar()){d.getRewardTBar()[f]();d.getTableSelectField()[f]();}}else{}},onTableSelectFieldChange:function(f,e,b,c){var d=this,a=Ext.StoreMgr.get("ReceiptStore");a.tableFilterId=(e!="None")?e:null;console.debug("Filter by Table["+a.tableFilterId+"] ...");Ext.defer(function(){a.filter();},1*1000);},onDoneTap:function(i,d,f,j){var g=this,a=g.getRewardsContainer(),l=Genesis.db.getLocalDB(),k=Ext.StoreMgr.get("ReceiptStore");var c=isPosEnabled();var h=((l.rewardModel=="items_purchased")?4:0);delete g._params;switch(g.getMode()){case"Manual":if(a){g.getAmount().reset();g.getItemsPurchased().reset();a.setActiveItem((c)?2:h);}break;case"POS_Detail":if(a){a.setActiveItem(3);}break;case"POS_Selection":if(a){a.setActiveItem(2);}break;case"Visit":g.getViewPortCntlr().setActiveController(g.getApplication().getController("server.MainPage"));break;default:break;}console.debug("onDoneTap - Mode["+g.getMode()+"], rewardModel["+l.rewardModel+"]");if(g.getCalcBtn()){g.getCalcBtn()[(c)?"show":"hide"]();}console.debug("Rewards onDoneTap Called ...");},onNfc:function(a){var b=this;b.rewardItemFn({data:{uid:(a)?a.id:null,tag_id:(a)?a.result.tagID:null,phone_id:(a)?a.result.phoneID:null,}},true);},earnPtsPage:function(){var a=this;var b=a.getRewards();a.setAnimationMode(a.self.animationMode.cover);a.pushView(b);},getMainPage:function(){var a=this.getRewards();return a;},openPage:function(a){var d=this,b=Genesis.db.getLocalDB(),c=isPosEnabled();switch(a){case"rewards":switch(b.rewardModel){case"visits":if(!c){d.setMode("Visit");d.fireEvent("rewarditem",a);break;}case"amount_spent":case"items_purchased":default:d.redirectTo("earnPts");break;}break;}},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.server.Redemptions",{extend:"Genesis.controller.RewardRedemptionsBase",mixins:{redeemBase:"Genesis.controller.server.mixin.RedeemBase"},requires:["Ext.data.Store","Genesis.view.server.Redemptions"],inheritableStatics:{},xtype:"serverRedemptionsCntlr",config:{redeemPointsFn:"setMerchantRedeemPointsURL",routes:{},refs:{backBtn:"serverredemptionsview button[tag=back]",redemptions:{selector:"serverredemptionsview",autoCreate:true,xtype:"serverredemptionsview"},redemptionsList:"serverredemptionsview list[tag=redemptionsList]",redeemItemCardContainer:"serverredeemitemdetailview[tag=redeemReward] container[tag=redeemItemCardContainer]",redeemItemButtonsContainer:"serverredeemitemdetailview[tag=redeemReward] container[tag=bottomButtons]",phoneId:"serverredeemitemdetailview[tag=redeemReward] calculator[tag=phoneId] textfield",mRedeemBtn:"serverredeemitemdetailview[tag=redeemReward] button[tag=merchantRedeem]",sBackBB:"serverredeemitemdetailview[tag=redeemReward] button[tag=back]",sCloseBB:"serverredeemitemdetailview[tag=redeemReward] button[tag=close]",authText:"serverredeemitemdetailview[tag=redeemReward] component[tag=authText]",redeemItem:{selector:"serverredeemitemdetailview[tag=redeemReward]",autoCreate:true,tag:"redeemReward",xtype:"serverredeemitemdetailview"}},control:{mRedeemBtn:{tap:"onRedeemItemTap"},redeemItemCardContainer:{activeitemchange:"onRedeemItemCardContainerActivate"},"serverredeemitemdetailview[tag=redeemReward] calculator[tag=phoneId] container[tag=dialpad] button":{tap:"onTagIdBtnTap"},"serverredeemitemdetailview[tag=redeemReward] calculator[tag=phoneId] container[tag=bottomButtons] button[tag=redeemTagId]":{tap:"onTagItTap"}},listeners:{}},onRedeemItemActivate:function(e,f,a,b){var d=this;d.callParent(arguments);d.mixins.redeemBase.onRedeemItemActivate.apply(d,arguments);},onNfc:function(a){var b=this;b.mixins.redeemBase.onNfc.apply(b,arguments);}});Ext.define("Genesis.controller.server.Prizes",{extend:"Genesis.controller.PrizeRedemptionsBase",mixins:{redeemBase:"Genesis.controller.server.mixin.RedeemBase"},requires:["Ext.data.Store","Genesis.view.server.Prizes"],inheritableStatics:{},xtype:"serverPrizesCntlr",config:{redeemPointsFn:"setMerchantRedeemPointsURL",routes:{authReward:"authRewardPage"},refs:{backBtn:"serverprizesview button[tag=back]",redemptions:{selector:"serverprizesview",autoCreate:true,xtype:"serverprizesview"},redemptionsList:"serverprizesview list[tag=prizesList]",redeemItemCardContainer:"serverredeemitemdetailview[tag=redeemPrize] container[tag=redeemItemCardContainer]",redeemItemButtonsContainer:"serverredeemitemdetailview[tag=redeemPrize] container[tag=bottomButtons]",phoneId:"serverredeemitemdetailview[tag=redeemPrize] calculator[tag=phoneId] textfield",mRedeemBtn:"serverredeemitemdetailview[tag=redeemPrize] button[tag=merchantRedeem]",sBackBB:"serverredeemitemdetailview[tag=redeemPrize] button[tag=back]",sCloseBB:"serverredeemitemdetailview[tag=redeemPrize] button[tag=close]",authText:"serverredeemitemdetailview[tag=redeemPrize] component[tag=authText]",redeemItem:{selector:"serverredeemitemdetailview[tag=redeemPrize]",autoCreate:true,tag:"redeemPrize",xtype:"serverredeemitemdetailview"}},control:{mRedeemBtn:{tap:"onRedeemItemTap"},redeemItemCardContainer:{activeitemchange:"onRedeemItemCardContainerActivate"},"serverredeemitemdetailview[tag=redeemPrize] calculator[tag=phoneId] container[tag=dialpad] button":{tap:"onTagIdBtnTap"},"serverredeemitemdetailview[tag=redeemPrize] calculator[tag=phoneId] container[tag=bottomButtons] button[tag=redeemTagId]":{tap:"onTagItTap"}},listeners:{authreward:"onAuthReward",refreshQRCode:"onRefreshQRCode"}},redeemPtsConfirmMsg:"Please confirm to submit",init:function(){var a=this;a.callParent(arguments);console.log("Prizes Server Init");},onNfc:function(a){var b=this;b.mixins.redeemBase.onNfc.apply(b,arguments);},onAuthReward:function(a){this.redeemItem=a;this.redirectTo("authReward");},onRedeemItemActivate:function(e,f,a,b){var d=this;d.callParent(arguments);d.mixins.redeemBase.onRedeemItemActivate.apply(d,arguments);},onRedeemItemDeactivate:function(a,f,e,b){var d=this;if(d.getRedeemMode()=="authReward"){d.getApplication().getController("server.Challenges").onRedeemItemDeactivate(a,f,e,b);}d.callParent(arguments);},authRewardPage:function(){this.setTitle("Challenges");this.openPage("authReward");}});var wssocket=null,initReceipt=0,posConnect=Ext.emptyFn,posDisconnect=Ext.emptyFn,lastPosDisonnectTime=0;var isPosEnabled=function(){var a=Genesis.db.getLocalDB(),b=a.enablePosIntegration&&a.isPosEnabled;return b;};Ext.require(["Genesis.model.frontend.ReceiptItem","Genesis.model.frontend.Receipt","Ext.device.Connection","Genesis.controller.ControllerBase"],function(){var db=Genesis.db.getLocalDB();if(db.receiptFilters){WebSocket.prototype.receiptFilters=Ext.clone(db.receiptFilters);for(filter in db.receiptFilters){if(isNaN(db.receiptFilters[filter])){WebSocket.prototype.receiptFilters[filter]=new RegExp(db.receiptFilters[filter],"i");}}}WebSocket._connTask=Ext.create("Ext.util.DelayedTask");Ext.merge(WebSocket.prototype,{scheme:"ws://",host:"192.168.159.1",port:"443",reconnectTimeoutTimer:5*60*1000,reconnectTimer:5*1000,createReceipt:function(receiptText){var me=this,i,match,currItemPrice=0,maxItemPrice=0,id=receiptText[0],matchFlag=0,rc=null;receiptText.splice(0,1);var receipt={id:id,subtotal:currItemPrice.toFixed(2),price:currItemPrice.toFixed(2),table:"",itemsPurchased:0,title:"",receipt:Ext.encode(receiptText),items:[]};for(i=0;i<receiptText.length;i++){var text=receiptText[i];if(text.length>me.receiptFilters.minLineLength){match=me.receiptFilters.subtotal.exec(text);if(match){matchFlag|=1;receipt.subtotal=match[1];continue;}match=me.receiptFilters.grandtotal.exec(text);if(match){matchFlag|=16;receipt.price=match[1];continue;}match=me.receiptFilters.table.exec(text);if(match){matchFlag|=256;receipt.table=match[1];continue;}match=me.receiptFilters.item.exec(text);if(match){matchFlag|=4096;var qty=Number(match[2]);var currItemPrice=(Number(match[3])/qty);receipt.items.push(new Ext.create("Genesis.model.frontend.ReceiptItem",{qty:qty,price:currItemPrice,name:match[1].trim()}));if(Math.max(currItemPrice,maxItemPrice)==currItemPrice){maxItemPrice=currItemPrice;receipt.title=match[1].trim();}if(me.receiptFilters.itemsPurchased){match=me.receiptFilters.itemsPurchased.exec(text);if(match){matchFlag|=65536;receipt.itemsPurchased+=qty;}}continue;}}}if(((matchFlag&17)&&!me.receiptFilters.itemsPurchased)||((matchFlag&65553)&&me.receiptFilters.itemsPurchased)){rc=Ext.create("Genesis.model.frontend.Receipt",receipt);rc.items().add(receipt.items);}return rc;},receiptIncomingHandler:function(receipts,supress){var receiptsList=[],tableList=[];for(var i=0;i<receipts.length;i++){var receipt=this.createReceipt(receipts[i]);if(receipt){if(receipt.get("table")){tableList.push(Ext.create("Genesis.model.frontend.Table",{id:receipt.get("table")}));}if(!supress){console.debug("WebSocketClient::receiptIncomingHandler - \nDate: "+Genesis.fn.convertDateFullTime(new Date(receipt.get("id")*1000))+"\nSubtotal: $"+receipt.get("subtotal").toFixed(2)+"\nPrice: $"+receipt.get("price").toFixed(2)+"\ntable: "+receipt.get("table")+"\nitemsPurchased: "+receipt.get("itemsPurchased")+"\nTitle: "+receipt.get("title")+"\nReceipt: [\n"+Ext.decode(receipt.get("receipt"))+"\n]");}receiptsList.push(receipt);}else{console.debug("Receipt["+i+"] is not valid, discarded.");}}if(!supress){Ext.StoreMgr.get("ReceiptStore").add(receiptsList);Ext.StoreMgr.get("TableStore").add(tableList);}return[receiptsList,tableList];},receiptResponseHandler:function(receipts){var lists=this.receiptIncomingHandler(receipts,true),rstore=Ext.StoreMgr.get("ReceiptStore"),tstore=Ext.StoreMgr.get("TableStore"),cntlr=_application.getController("server.Receipts");lists[1].push(Ext.create("Genesis.model.frontend.Table",{id:"None"}));(lists[0].length>0)?rstore.setData(lists[0]):rstore.clearData();rstore.tableFilterId=null;tstore.setData(lists[1]);console.debug("WebSocketClient::receiptResponseHandler - Processed "+lists[0].length+" Valid Receipts");cntlr.receiptCleanFn(Genesis.db.getLocalDB()["displayMode"]);}});posConnect=function(i){var posEnabled=isPosEnabled();if(posEnabled&&Ext.Viewport){i=i||0;if(!wssocket&&Ext.device.Connection.isOnline()){var ws=WebSocket.prototype;var url=ws.scheme+ws.host+":"+ws.port+"/pos";wssocket=new WebSocket(url,"json");wssocket.onopen=function(event){Ext.Viewport.setMasked(null);var db=Genesis.db.getLocalDB();var cntlr=_application.getController("server.Receipts");console.debug("WebSocketClient::onopen");lastPosDisonnectTime=db.lastPosDisconnectTime||0;initReceipt|=16;if(cntlr){cntlr.fireEvent("retrieveReceipts");}Genesis.db.setLocalDBAttrib("lastPosConnectTime",Date.now());};wssocket.onmessage=function(event){try{var inputStream=eval("["+event.data+"]")[0];var cmd=inputStream.code;Genesis.fn.systemTime=inputStream.systemTime*1000;Genesis.fn.clientTime=new Date().getTime();switch(cmd){case"receipt_incoming":wssocket.receiptIncomingHandler(inputStream.receipts);break;case"receipt_response":wssocket.receiptResponseHandler(inputStream.receipts);break;default:break;}}catch(e){console.debug("Exception while parsing Incoming Receipt ...\n"+e);Ext.Viewport.setMasked(null);}};wssocket.onerror=function(event){console.debug("WebSocketClient::onerror");};wssocket.onclose=function(event){var timeout=wssocket.reconnectTimer;console.debug("WebSocketClient::onclose, 5sec before retrying ...");wssocket=null;Genesis.db.setLocalDBAttrib("lastPosDisconnectTime",Date.now());WebSocket._connTask.delay(timeout,posConnect,wssocket,[++i]);};Ext.Viewport.setMasked(null);Ext.Viewport.setMasked({xtype:"loadmask",message:Genesis.controller.ControllerBase.prototype.lostPosConnectionMsg,listeners:{tap:function(b,e,eOpts){Ext.Viewport.setMasked(null);WebSocket._connTask.cancel();}}});console.debug("WebSocketClient::posConnect("+url+")");}}};posDisconnect=function(forced){if(Genesis.db.getLocalDB()["enablePosIntegration"]||forced){if(wssocket&&wssocket.socket){WebSocket._connTask.cancel();wssocket.socket.close();console.debug("WebSocketClient::posDisconnect called");}}};});Ext.define("Genesis.controller.server.Receipts",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store","Genesis.model.frontend.Receipt","Ext.dataview.List","Ext.XTemplate","Ext.util.DelayedTask"],inheritableStatics:{},xtype:"serverreceiptsCntlr",config:{models:["Venue","frontend.Receipt","frontend.Table"],refs:{posMode:"serversettingspageview togglefield[tag=posMode]",displayMode:"serversettingspageview selectfield[tag=displayMode]"},control:{posMode:{change:"onPosModeChange"},displayMode:{change:"onDisplayModeChange"}},listeners:{insertReceipts:"onInsertReceipts",resetReceipts:"onResetReceipts",retrieveReceipts:"onRetrieveReceipts"}},mobileTimeout:((debugMode)?0.25:1)*60*1000,fixedTimeout:((debugMode)?0.25:4*60)*60*1000,cleanupTimer:4*60*60*1000,batteryTimer:30*1000,filter_config:{minLineLength:5,grandtotal:"\\s*\\bGrand Total\\b\\s+\\$(\\d+.\\d{2})\\s*",subtotal:"\\s*\\bSubtotal\\b\\s+\\$(\\d+.\\d{2})\\s*",item:"\\s*([\\w+\\W*]+)\\s+\\(?(\\d+(?=\\@\\$\\d+\\.\\d{2}\\))?).*?\\s+\\$(\\d+\\.\\d{2})",table:"\\s*\\bTABLE\\b:\\s+(Bar\\s+\\d+)\\s*",itemsPurchased:""},_statusInfo:{isPlugged:false,level:0},_hyteresisTask:null,_syncTask:null,_receiptCleanTask:null,init:function(b){var a=this;a.callParent(arguments);console.log("Server Receipts Init");a.initEvent();a.initStore();a.initWorker(Ext.StoreMgr.get("EarnedReceiptStore"));},initEvent:function(){var a=this;window.addEventListener("batterystatus",function(b){if(!a._hyteresisTask){a._hyteresisTask=Ext.create("Ext.util.DelayedTask");}a._hyteresisTask.delay(a.batteryTimer,a.batteryStatusFn,a,[b]);},false);window.addEventListener("batterylow",function(b){if(Ext.device){Ext.device.Notification.show({title:"Battery Level Low",messsage:"Battery is at "+b.level+"%"});Ext.device.Notification.vibrate();}},false);window.addEventListener("batterycritical",function(b){if(Ext.device){Ext.device.Notification.show({title:"Battery Level Critical",messsage:"Battery is at "+b.level+"%\nRecharge Soon!"});Ext.device.Notification.vibrate();Ext.device.Notification.beep();}},false);console.debug("Server Receipts : initEvent");},initWorker:function(estore){var me=this,worker=me.worker=new Worker("worker/server.js");worker.onmessage=function(e){var result=eval("["+e.data+"]")[0];switch(result.cmd){case"createReceipts":console.debug("Successfully created/retrieved KickBak-Receipt Table");break;case"uploadReceipts":var items=[],ids=[],item;result=result.result;for(var i=0;i<result.length;i++){item=Ext.decode(result[i]["receipt"]);for(var j=0;j<item.items.length;j++){delete item.items["receipt_id"];}items.push({txnId:item.txnId,items:item.items});ids.push(item.id);}if(items.length>0){me.uploadReceipts(items,ids);}console.debug("uploadReceipts  --- Found(unsync) "+items.length+" Receipts to Upload to Server");break;case"insertReceipts":console.debug("insertReceipts --- Inserted(unsync) "+result.result+" Receipts into KickBak-Receipt DB ...");break;case"updateReceipts":console.debug("updateReceipts --- Updated(synced) "+result.result+" Receipts in the KickBak-Receipt DB");break;case"restoreReceipts":for(var i=0;i<result.result.length;i++){result.result[i]=eval("["+result.result[i]["receipt"]+"]")[0];}estore.setData(result.result);console.debug("restoreReceipt  --- Restored "+result.result.length+" Receipts from the KickBak-Receipt DB");initReceipt|=1;me.fireEvent("retrieveReceipts",null);break;case"resetReceipts":console.debug("resetReceipts --- Successfully drop KickBak-Receipt Table");navigator.app.exitApp();break;default:break;}};worker.postMessage({cmd:"createReceipts"});worker.postMessage({cmd:"restoreReceipts"});console.debug("Server Receipts : initWorker");},initStore:function(){var b=this,a;Ext.regStore("TableStore",{model:"Genesis.model.frontend.Table",autoLoad:false,sorters:[{sorterFn:function(e,c){var m,k,f,l,h=0,g,j,d=/(\.\d+)|(\d+(\.\d+)?)|([^\d.]+)|(\.\D+)|(\.$)/g;if(e.data.id===c.data.id){return 0;}if(e.data.id=="None"){return -1;}if(c.data.id=="None"){return 1;}m=e.data.id.toLowerCase().match(d);k=c.data.id.toLowerCase().match(d);j=m.length;while(h<j){if(!k[h]){return 1;}f=m[h],l=k[h++];if(f!==l){g=f-l;if(!isNaN(g)){return g;}return f>l?1:-1;}}return k[h]?-1:0;},direction:"ASC"}]});Ext.regStore("ReceiptStore",{model:"Genesis.model.frontend.Receipt",autoLoad:false,sorters:[{property:"id",direction:"DESC"}],filters:[{filterFn:function(c){return((a.find("id",c.getId())>=0)?false:true);}},{filterFn:Ext.bind(b.tableFilterFn,b)}]});Ext.regStore("EarnedReceiptStore",{model:"Genesis.model.frontend.Receipt",autoLoad:false,sorters:[{property:"id",direction:"DESC"}]});a=Ext.StoreMgr.get("EarnedReceiptStore");console.debug("Server Receipts : initStore");},updateMetaDataInfo:function(a){var c=this,b=Genesis.db.getLocalDB();try{c.posIntegrationHandler(a,b.isPosEnabled);}catch(d){console.debug("updateMetaDataInfo Exception - "+d);}},posIntegrationHandler:function(a,e){var g=this,c=Genesis.db.getLocalDB(),d=a.features_config;c.enablePosIntegration=d.enable_pos;c.isPosEnabled=((e===undefined)||(e));if(isPosEnabled()){var f=d.receipt_filter=(d.receipt_filter||{});c.receiptFilters={minLineLength:f.min_line_length||g.filter_config.minLineLength,grandtotal:f.grand_total||g.filter_config.grandtotal,subtotal:f.subtotal||g.filter_config.subtotal,item:f.item||g.filter_config.item,table:f.table||g.filter_config.table,itemsPurchased:f.items_purchased||g.filter_config.itemsPurchased};WebSocket.prototype.receiptFilters=Ext.clone(c.receiptFilters);for(filter in c.receiptFilters){if(isNaN(c.receiptFilters[filter])){WebSocket.prototype.receiptFilters[filter]=new RegExp(c.receiptFilters[filter],"i");}}posConnect();console.debug("posIntegrationHandler - Enabled");}else{var b=Ext.StoreMgr.get("ReceiptStore");posDisconnect(true);b.removeAll();b.remove(b.getRange());delete WebSocket.prototype.receiptFilters;console.debug("posIntegrationHandler - Disabled");}c.enableReceiptUpload=d.enable_sku_data_upload;c.enablePrizes=d.enable_prizes;Genesis.db.setLocalDB(c);Genesis.controller.ViewportBase.prototype.onActivate.call(g.getViewPortCntlr());},batteryStatusFn:function(d){var a=this,c=Genesis.db.getLocalDB.displayMode;d=d||a._statusInfo;console.log("Device is "+((d.isPlugged)?"Plugged":"Unplugged")+", Battery "+d.level+"%");var b=a._statusInfo.isPlugged!==d.isPlugged;if(!d.isPlugged){if(a._syncTask){a._syncTask.cancel();}}else{if(Ext.device&&(b||(a._statusInfo===d))&&(d.level>=3)){switch(c){case"Fixed":a.syncReceiptDB(a.fixedTimeout);break;case"Mobile":default:a.syncReceiptDB(a.mobileTimeout);break;}}}a._statusInfo=d;},receiptCleanFn:function(b){var a=this;if(!a._receiptCleanTask){a._receiptCleanTask=Ext.create("Ext.util.DelayedTask",function(){var o=Ext.StoreMgr.get("ReceiptStore"),k=Ext.StoreMgr.get("TableStore");var f=o.getRange(),m,e;var n=[],g=[],c=(new Date()).addHours(-4).getTime();var d=true;for(var l=0,h=0;l<f.length;l++){m=f[l];e=m.getId()*1000;if(c>e){n.push(m);}else{g[h++]=Ext.create("Genesis.model.frontend.Table",{id:m.get("table")});if(o.tableFilterId==m.get("table")){d=false;}}}if(n.length>0){o.remove(n);}g.push(Ext.create("Genesis.model.frontend.Table",{id:"None"}));k.setData(g);if(d){o.tableFilterId=null;}console.debug("receiptCleanFn - Removed "+n.length+" old records from the Receipt Store\n4hrs till the next cleanup");a._receiptCleanTask.delay(a.cleanupTimer);});}switch(b){case"Fixed":console.debug("receiptCleanFn(Enabled) --- DisplayMode("+b+")\nCleanup is scheduled to start in 4hrs");a._receiptCleanTask.delay(a.cleanupTimer);break;case"Mobile":default:console.debug("receiptCleanFn(Disabled) --- DisplayMode("+b+")");a._receiptCleanTask.cancel();break;}},uploadReceipts:function(e,a){var h=this,g=Venue.getProxy(),i=Genesis.db.getLocalDB();var b=i.displayMode,c=i.enableReceiptUpload,f=isPosEnabled();var d={version:Genesis.constants.serverVersion,venue_id:Genesis.fn.getPrivKey("venueId"),data:{receipts:e}};if(!f||(f&&!c)){h.worker.postMessage({cmd:"updateReceipts",ids:a});console.log("Successfully DISCARDED "+e.length+" Receipt(s) sent to Server");}d.data=h.self.encryptFromParams(d.data);Venue.setMerchantReceiptUploadURL(d.venue_id);Venue.load(1,{addRecords:true,scope:h,jsonData:{},doNotRetryAttempt:false,params:d,callback:function(j,k){Ext.Viewport.setMasked(null);if(k.wasSuccessful()){h.worker.postMessage({cmd:"updateReceipts",ids:a});console.log("Successfully Uploaded "+e.length+" Receipt(s) to Server");}else{console.log("Error Uploading Receipt information to Server");g.supressErrorsPopup=true;g.quiet=false;switch(b){case"Fixed":h.syncReceiptDB(h.fixedTimeout);break;case"Mobile":default:h.syncReceiptDB(h.mobileTimeout);break;}}}});},syncReceiptDB:function(b){var a=this;if(!a._syncTask){a._syncTask=Ext.create("Ext.util.DelayedTask",function(){var f=Ext.StoreMgr.get("ReceiptStore").getData().all;var c=Number.MAX_VALUE;for(var d=0;d<f.length;d++){var e=f[d];if(Math.min(e.getId(),c)==e.getId()){c=e.getId();}}a.worker.postMessage({cmd:"uploadReceipts",lastReceiptTime:(c==Number.MAX_VALUE)?0:c});});}a._syncTask.delay(b);console.debug("syncReceiptDB - process starting in "+(b/(1000*60)).toFixed(0)+"mins");},tableFilterFn:function(c){var b=this,a=Ext.StoreMgr.get("ReceiptStore");return(a.tableFilterId)?(c.get("table")==a.tableFilterId):true;},onPosModeChange:function(g,f,b,c){var e=this,a=e.getViewPortCntlr();if(a.getMetaData()){var d=(g.getValue()==1)?true:false;Genesis.db.setLocalDBAttrib("isPosEnabled",d);console.debug("onPosModeChange - "+d);e.updateMetaDataInfo(a.getMetaData());window.plugins.WifiConnMgr.setIsPosEnabled(isPosEnabled());}else{Ext.defer(function(){g.toggle();},1);}},onDisplayModeChange:function(e,d,a,b){var c=this;Genesis.db.setLocalDBAttrib("displayMode",d);console.debug("onDisplayModeChange - "+d);c.receiptCleanFn(d);c.batteryStatusFn();},onInsertReceipts:function(a){this.worker.postMessage({cmd:"insertReceipts",receipts:a});},onResetReceipts:function(){this.worker.postMessage({cmd:"resetReceipts"});},onRetrieveReceipts:function(){var d=this;if(initReceipt==17){var c=Ext.StoreMgr.get("ReceiptStore");var b=Genesis.db.getLocalDB(),a=b.lastPosConnectTime||0;if(((lastPosDisonnectTime-a)>(wssocket.reconnectTimeoutTimer))||!c||!(c.getAllCount()>0)){wssocket.send("get_receipts");}}}});