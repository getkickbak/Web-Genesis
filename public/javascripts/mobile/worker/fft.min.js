importScripts("../lib/dsp.min.js");var fft,sampleRate,fftSize,bwWidth,MAG_THRESHOLD=0,MATCH_THRESHOLD=3,ERROR_THRESHOLD=175,FREQ_GAP=500,NUM_SIGNALS=3;var fft_init=function(a,b){sampleRate=a.sampleRate,fftSize=a.fftSize,bwWidth=sampleRate/fftSize;fft=new FFT(fftSize,sampleRate);b.postMessage(JSON.stringify({cmd:"init"}));};var fft_forward=function(b,m){var k=this,d=0,c,f,a=[],h=k.fft,g,l,j;h.forward(b);mag=h.spectrum;for(d=Math.floor(loFreq/bwWidth);d<Math.ceil(hiFreq/bwWidth);d++){c=mag[d];if(c<=MAG_THRESHOLD){continue;}a.sort(function(n,i){return n.val-i.val;});l=a.binarySearch({val:c,index:d},function(n,i){g=Math.abs(n.index-i.index)<=ERROR_THRESHOLD;return(g)?0:(n.index-i.index);});if(l>=0){j=a[l];if(j.val<mag){j.val=mag;j.index=d;}}else{a.push({val:mag,index:d});}}if(a.length>=MATCH_THRESHOLD){var e=[];for(d=0;d<MATCH_THRESHOLD;d++){e[d]=Math.round(a[d]["index"]*bwWidth);console.debug("PostFFT - Mag Resolution= "+a[d]["val"]+", Freq = "+e[d]+"Hz");}e.sort(function(n,i){return(n-i);});m.postMessage(JSON.stringify({cmd:"forward",freqs:e}));}else{}};onmessage=function(b){var a=b.data;switch(a.cmd){case"init":fft_init(a.config,self);break;case"forward":fft_forward(a.buf,self);break;}};Array.prototype.binarySearch=function(f,b){var a=0,e=this.length-1,c,d;while(a<=e){c=Math.floor((a+e)/2);d=b(this[c],f);if(d<0){a=c+1;continue;}if(d>0){e=c-1;continue;}return c;}return null;};