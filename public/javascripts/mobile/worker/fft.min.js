if(typeof(importScripts)!="undefined"){var prefix;if(location.href.match("testing")){prefix=".";}else{if(location.href.match(/mobileServer/i)){prefix="../..";}else{prefix="/merchant";}}importScripts(prefix+"/lib/dsp.min.js");}var fft,sampleRate,fftSize,bwWidth,MAG_THRESHOLD=0.00001,MATCH_THRESHOLD=3,ERROR_THRESHOLD=175,loFreq=17000,hiFreq=20000,FREQ_GAP=500,NUM_SIGNALS=3;var fft_init=function(a,b){sampleRate=a.sampleRate,fftSize=a.fftSize,bwWidth=sampleRate/fftSize;fft=new FFT(fftSize,sampleRate);b.postMessage(JSON.stringify({cmd:"init"}));};var fft_forward=function(b,m){var k=this,c=0,d,f,a=[],h=k.fft,g,l,j;h.forward(b);mags=h.spectrum;for(c=Math.floor(loFreq/bwWidth);c<Math.ceil(hiFreq/bwWidth);c++){d=mags[c];if(d<=MAG_THRESHOLD){continue;}l=null;if(a.length>0){a.sort(function(n,i){return n.index-i.index;});l=a.binarySearch({val:d,index:c},function(n,i){g=(Math.abs(n.index-i.index)<=ERROR_THRESHOLD);return(g)?0:(n.index-i.index);});}if(l==null){l=-1;}if(l>=0){j=a[l];if(j.val<d){j.val=d;j.index=c;}}else{a.push({val:d,index:c});}}if(a.length>=MATCH_THRESHOLD){var e=[];for(c=0;c<MATCH_THRESHOLD;c++){e[c]=Math.round(a[c]["index"]*bwWidth);console.debug("PostFFT - Mag Resolution= "+a[c]["val"]+", Freq = "+e[c]+"Hz");}e.sort(function(n,i){return(n-i);});m.postMessage(JSON.stringify({cmd:"forward",freqs:e}));}else{}};onmessage=function(b){var a=b.data;switch(a.cmd){case"init":fft_init(a.config,self);break;case"forward":fft_forward(a.buf,self);break;}};Array.prototype.binarySearch=function(f,b){var a=0,e=this.length-1,c,d;while(a<=e){c=Math.floor((a+e)/2);d=b(this[c],f);if(d<0){a=c+1;continue;}if(d>0){e=c-1;continue;}return c;}return null;};