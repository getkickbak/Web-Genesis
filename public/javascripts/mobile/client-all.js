Ext.define("Genesis.fx.animation.Scroll",{extend:"Ext.fx.animation.Abstract",alternateClassName:"Ext.fx.animation.ScrollIn",alias:["animation.scroll","animation.scrollIn"],config:{direction:"left",out:false,offset:0,easing:"auto",containerBox:"auto",elementBox:"auto",isElementBoxFit:true},reverseDirectionMap:{up:"down",down:"up",left:"right",right:"left"},applyEasing:function(a){if(a==="auto"){return"ease-"+((this.getOut())?"in":"out");}return a;},getData:function(){var e=this.getElement();var l=this.getFrom(),m=this.getTo(),d=this.getOut(),c=this.getOffset(),k=this.getDirection(),f=this.getReverse(),b=0,a=0,j,h,i,g;if(f){k=this.reverseDirectionMap[k];}switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:a=e.getHeight();break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:b=e.getWidth();break;}j=(d)?0:b;h=(d)?0:a;l.set("overflow","hidden");switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:l.set("height",h+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:l.set("width",j+"px");break;}i=(d)?b:0;g=(d)?a:0;m.set("overflow","hidden");switch(k){case this.DIRECTION_UP:case this.DIRECTION_DOWN:m.set("height",g+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:m.set("width",i+"px");break;}return this.callParent(arguments);}});Ext.define("Genesis.view.widgets.ListField",{extend:"Ext.field.Text",alternateClassName:"Genesis.field.List",xtype:"listfield",config:{ui:"list",component:{useMask:false},clearIcon:true,iconCls:"",readOnly:false},initialize:function(){var b=this,a=b.getComponent();b.callParent();if(b.getIconCls()){Ext.fly(b.element.query("."+Ext.baseCSSPrefix.trim()+"component-outer")[0]).addCls(b.getIconCls());}a.setReadOnly(true);},doClearIconTap:Ext.emptyFn});Ext.define("Genesis.view.widgets.ComponentListItem",{extend:"Ext.dataview.element.List",config:{maxItemCache:20},initialize:function(){this.callParent();this.doInitialize();this.itemCache=[];},getItemElementConfig:function(e,h){var f=this,c=f.dataview,g=c.getItemCls(),b=f.itemClsShortCache,d,a;if(g){b+=" "+g;}d={cls:b,children:[{cls:f.labelClsShortCache,}]};if(c.getIcon()){a=h.iconSrc;d.children.push({cls:f.iconClsShortCache,style:"background-image: "+a?'url("'+newSrc+'")':""});}return d;},moveItemsToCache:function(k,l){var j=this,d=j.dataview,b=d.getMaxItemCache(),h=j.getViewItems(),g=j.itemCache,f=g.length,n=d.getPressedCls(),e=d.getSelectedCls(),c=l-k,o;for(;c>=0;c--){o=Ext.get(h[k+c]);var m=o.down(j.labelClsCache,true);var a=Ext.getCmp(m.childNodes[0].id);if(f!==b){o.removeCls([n,e]);g.push(a);f++;}else{Ext.Array.remove(j.itemCache,a);a.destroy();}o.dom.parentNode.removeChild(o.dom);}if(j.getViewItems().length==0){this.dataview.showEmptyText();}},moveItemsFromCache:function(b){var l=this,e=l.dataview,m=e.getStore(),k=b.length;var a=e.getDefaultType(),h=e.getItemConfig();var g=l.itemCache,f=g.length,j=[],c,n,d;if(k){e.hideEmptyText();}for(c=0;c<k;c++){b[c]._tmpIndex=m.indexOf(b[c]);}Ext.Array.sort(b,function(o,i){return o._tmpIndex>i._tmpIndex?1:-1;});for(c=0;c<k;c++){d=b[c];if(f){f--;n=g.pop();l.updateListItem(d,n);}l.addListItem(d._tmpIndex,d,n);delete d._tmpIndex;}return j;},addListItem:function(f,d,m){var j=this,e=j.dataview,b=e.prepareData(d.getData(true),e.getStore().indexOf(d),d);var c=j.element,l=c.dom.childNodes,i=l.length,h;h=Ext.Element.create(this.getItemElementConfig(f,b));var a=e.getDefaultType(),g=e.getItemConfig();if(!i||f==i){h.appendTo(c);}else{h.insertBefore(l[f]);}var k=h.down(j.labelClsCache,true);if(!m){m=new Ext.widget(a,{xtype:a,record:d,dataview:e,itemCls:e.getItemCls(),defaults:g,renderTo:k});}else{m.element.appendTo(k);}},updateListItem:function(b,c){if(c.isComponent&&c.updateRecord){c.updateRecord(b);}else{var d=Ext.fly(c).down(this.labelClsCache,true);var a=Ext.getCmp(d.childNodes[0].id);a.updateRecord(b);}},destroy:function(){var d=this.getViewItems(),c=d.length,b=0,a=this.itemCache.length;for(;b<a;b++){this.itemCache[b].destroy();this.itemCache[b]=null;}delete this.itemCache;for(b=0;b<c;b++){Ext.removeNode(d[b]);}this.callParent();}});Ext.define("Genesis.view.widgets.ComponentList",{alternateClassName:"Genesis.ComponentList",extend:"Ext.dataview.List",xtype:"componentlist",requires:["Genesis.view.widgets.ComponentListItem"],initialize:function(){var b=this,a;b.on(b.getTriggerCtEvent(),b.onContainerTrigger,b);a=b.container=this.add(new Genesis.view.widgets.ComponentListItem({baseCls:this.getBaseCls()}));a.dataview=b;b.on(b.getTriggerEvent(),b.onItemTrigger,b);a.element.on({delegate:"."+this.getBaseCls()+"-disclosure",tap:"handleItemDisclosure",scope:b});a.on({itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd",itemtap:"onItemTap",itemtaphold:"onItemTapHold",itemtouchmove:"onItemTouchMove",itemsingletap:"onItemSingleTap",itemdoubletap:"onItemDoubleTap",itemswipe:"onItemSwipe",scope:b});if(this.getStore()){this.refresh();}}});Ext.define("Genesis.view.widgets.MerchantDetailsItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.XTemplate"],xtype:"merchantdetailsitem",alias:"widget.merchantdetailsitem",config:{layout:{type:"hbox",align:"stretch"},image:{docked:"left",cls:"photo",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>',{getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_medium"].url;}})},address:{flex:1,tpl:Ext.create("Ext.XTemplate",'<div class="merchantDetailsWrapper"><div class="itemTitle">{name}</div><div class="itemDesc">{[this.getAddress(values)]}</div></div>',{getAddress:function(a){return(a.address+",<br/>"+a.city+", "+a.state+", "+a.country+",</br>"+a.zipcode);}}),cls:"address"},dataMap:{getImage:{setData:"image"},getAddress:{setData:"address"}}},applyImage:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getImage());},updateImage:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyAddress:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getAddress());},updateAddress:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),k=e.first(),i=h.getDataMap(),f,j,g,a;if(!k){return;}for(f in i){g=i[f];j=h[f]();if(j){for(a in g){if(j[a]){switch(g[a]){case"image":case"address":j[a](b);break;default:j[a](b[g[a]]);break;}}}}}k.updateData(b);}});Ext.define("Genesis.view.widgets.RedeemItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.Button","Ext.XTemplate"],xtype:"redeemitem",alias:"widget.redeemitem",config:{background:{cls:"redeemItem",tag:"redeemItem",layout:{type:"vbox",pack:"top",align:"stretch"},items:[{docked:"top",xtype:"component",tag:"title",cls:"title",margin:"0 0 0.8 0",defaultUnit:"em",tpl:Ext.create("Ext.XTemplate","{[this.getDescription(values)]}",{getDescription:function(a){return a.title;}})},{xtype:"component",flex:1,tag:"itemPhoto",cls:"itemPhoto",tpl:Ext.create("Ext.XTemplate",'<div class="itemPoints {[this.isVisible(values)]}">{[this.getPoints(values)]}</div>',{isVisible:function(a){return((a.Merchant)?"":"x-item-hidden");},getPoints:function(a){return((a.points>0)?a.points+"  Pts":"");}})},{docked:"bottom",xtype:"component",hidden:true,tag:"itemPoints",cls:"itemPoints",tpl:Ext.create("Ext.XTemplate","{[this.getPoints(values)]}",{getPoints:function(a){return((a.points>0)?a.points+"  Pts":"");}})},{docked:"bottom",xtype:"component",tag:"info",cls:"info",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="infoWrapper"><div class="name">{[this.getName(values)]}</div><div class="disclaimer">{[this.getDisclaimer(values)]}</div><div class="date">{[this.getExpiryDate(values)]}</div></div>',{getExpiryDate:function(a){var b=a.time_limited;return((b)?"Offer Expires: "+a.expiry_date:"");},getDisclaimer:function(a){var c=(a.quantity_limited)?"<b>Quantity : "+a.quantity+"</b><br/>":"Limited Quantities. ";var b=a.Merchant["reward_terms"]||"";return(c+b);},getPhoto:function(a){return a.Merchant["photo"]["thumbnail_ios_small"].url;},getName:function(a){return a.Merchant["name"];}})}]},dataMap:{getBackground:{setData:"background"}},listeners:{painted:function(b,a){}}},applyBackground:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBackground());},updateBackground:function(a,b){if(a){this.add(a);}if(b){this.remove(b);}},setDataBackground:function(d){var f=d;var a=this.self.getPhoto(f.type)||f.photo["thumbnail_ios_medium"];var e=this.query("component[tag=info]")[0];var c=this.query("component[tag=itemPhoto]")[0];var g=this.query("component[tag=title]")[0];var b=this.query("component[tag=itemPoints]")[0];if(d.Merchant){e.setData(d);e.element.setVisibility(true);b.hide();}else{e.element.setVisibility(false);e.element.setHeight("4.5em");b.setData(d);b.show();}if(f.title){g.setData(f);g.element.setVisibility(true);}else{g.element.setVisibility(false);}c.element.setStyle((Ext.isString(a))?{"background-image":"url("+a+")","background-size":""}:{"background-image":"url("+a.url+")","background-size":(a.width)?Genesis.fn.addUnit(a.width)+" "+Genesis.fn.addUnit(a.height):""});c.element.setHeight("12.7em");c.setData(f);},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),k=e.first(),i=h.getDataMap(),f,j,g,a;if(!k){return;}for(f in i){g=i[f];j=h[f]();if(j){for(a in g){if(j[a]){switch(g[a]){case"background":h.setDataBackground(b);break;default:j[a](b[g[a]]);break;}}}}}k.updateData(b);},statics:{getPhoto:function(a){var b=null;switch(a.value){case"earn_points":case"promotion":break;default:b=Genesis.constants.getIconPath("prizewon",a.value);break;}return b;}}});Ext.define("Genesis.view.widgets.MerchantAccountPtsItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.Button","Ext.XTemplate"],xtype:"merchantaccountptsitem",alias:"widget.merchantaccountptsitem",config:{layout:"vbox",background:{cls:"tbPanel",tag:"background",height:window.innerWidth,items:[{xtype:"container",bottom:0,width:"100%",cls:"container",layout:"hbox",defaults:{flex:1,xtype:"component"},items:[{tag:"prizepoints",tpl:"{prize_points}",cls:"prizephotodesc"},{tag:"points",tpl:"{points}",cls:"pointsphotodesc"}],}]},winnersCount:{tag:"prizesWonPanel",xtype:"component",cls:"prizesWonPanel x-list",tpl:Ext.create("Ext.XTemplate",'<div class="prizeswonphoto">','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">{[this.getDesc(values)]}</div>',"</div>",'<div class="x-list-disclosure"></div>',{getTitle:function(a){var b=" Jackpot"+((a.prize_jackpots>1)?"s":"");var c=((a.prize_jackpots>0)?a.prize_jackpots+b+" won this month":"Be our first winner this month!");return c;},getDesc:function(a){return"Check out our winners!";}})},badgeProgress:{tag:"badgeProgressPanel",xtype:"component",cls:"badgeProgressPanel",tpl:Ext.create("Ext.XTemplate",'<tpl if="this.isVisible(values)">','<div class="badgephoto">','<img class="itemPhoto" src="{[this.getPhoto(values)]}"/>','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">','<div class="progressBarContainer">','<div class="progressBar" style="{[this.getProgress(values)]}"></div>','<div class="progressBarValue">{[this.getDesc(values)]}</div>',"</div>","{[this.cleanup(values)]}","</div>","</div>","</tpl>",{isVisible:function(b){var a=_application.getController("Viewport");var d=a.getCustomer();var c=false;if(d){c=Customer.isValid(d.getId());b._customer=(c)?Ext.StoreMgr.get("CustomerStore").getById(d.getId()):null;}return c;},getPhoto:function(a){a._badgeType=Ext.StoreMgr.get("BadgeStore").getById(a._customer.get("badge_id")).get("type");return Genesis.view.client.Badges.getPhoto(a._badgeType,"thumbnail_medium_url");},getTitle:function(a){var b=('You are our <span class ="badgehighlight">'+a._badgeType.display_value.toUpperCase()+"</span>");return b;},getProgress:function(b){var d=b._customer;var e=b._nextBadge=Ext.StoreMgr.get("BadgeStore").getById(d.get("next_badge_id"));var c=b._nvisit=e.get("visits");var a=d.get("next_badge_visits");return("width:"+(a/c*100)+"%;");},getDesc:function(b){var d=b._customer;var c=b._nvisit;var a=d.get("next_badge_visits");var e=b._nextBadge;return((c-a)+" more visit"+(((c-a)>1)?"s":"")+" to be our "+((e)?e.get("type").display_value.toUpperCase():"None")+"!");},cleanup:function(a){delete a._customer;delete a._nextBadge;delete a._badgeType;delete a._nvisit;}})},dataMap:{getBackground:{setData:"background"},getWinnersCount:{setData:"winnersCount"},getBadgeProgress:{setData:"badgeProgress"}},listeners:{painted:function(b,a){}}},initialize:function(){},applyBackground:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBackground());},updateBackground:function(a,b){if(a){this.add(a);}if(b){this.remove(b);}},setDataBackground:function(c){var f=_application.getController("Viewport");var e=f.getCustomer();var a=f.getVenue();var b=a.getId();var g=f.getCheckinInfo().venue;var j=e.getId();var d=this.query("container[tag=background]")[0];d.setStyle({"background-image":"url("+c.Merchant.alt_photo["url"]+")"});if(Customer.isValid(j)&&Ext.StoreMgr.get("CustomerStore").getById(j)){d.getItems().items[0].show();var i=this.query("component[tag=points]")[0];i.setData(e.getData());var h=this.query("component[tag=prizepoints]")[0];h.setData(e.getData());}else{d.getItems().items[0].hide();}},applyWinnersCount:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getWinnersCount());},updateWinnersCount:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},setDataWinnersCount:function(b){var a=this.query("component[tag=prizesWonPanel]")[0];a.setData(b);},applyBadgeProgress:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBadgeProgress());},updateBadgeProgress:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},setDataBadgeProgress:function(d){var a=_application.getController("Viewport");var b=this.query("component[tag=badgeProgressPanel]")[0];var c=Customer.isValid(a.getCustomer().getId());if(c){b.setData(d);}b[(c)?"show":"hide"]();},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),k=e.first(),i=h.getDataMap(),f,j,g,a;if(!k){return;}for(f in i){g=i[f];j=h[f]();if(j){for(a in g){if(j[a]){switch(g[a]){case"background":h.setDataBackground(b);break;case"badgeProgress":h.setDataBadgeProgress(b);break;case"winnersCount":h.setDataWinnersCount(b);break;default:j[a](b[g[a]]);break;}}}}}k.updateData(b);}});Ext.define("Genesis.view.widgets.RedeemPtsItemBase",{extend:"Ext.dataview.component.DataItem",requires:["Ext.XTemplate"],xtype:"redeemptsitembase",alias:"widget.redeemptsitembase",config:{},applyPoints:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getPoints());},updatePoints:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),k=e.first(),i=h.getDataMap(),f,j,g,a;if(!k){return;}for(f in i){g=i[f];j=h[f]();if(j){for(a in g){if(j[a]){switch(g[a]){case"points":j[a](b);break;default:j[a](b[g[a]]);break;}}}}}k.updateData(b);}});Ext.define("Genesis.view.widgets.RewardPtsItem",{extend:"Genesis.view.widgets.RedeemPtsItemBase",xtype:"rewardptsitem",alias:"widget.rewardptsitem",config:{layout:{type:"hbox",align:"stretch"},points:{flex:1,tpl:"{points} Pts",cls:"pointsphoto"},dataMap:{getPoints:{setData:"points"}}}});Ext.define("Genesis.view.widgets.PrizePtsItem",{extend:"Genesis.view.widgets.RedeemPtsItemBase",xtype:"prizeptsitem",alias:"widget.prizeptsitem",config:{layout:{type:"hbox",align:"stretch"},points:{flex:1,tpl:"{prize_points} Pts",cls:"prizephoto"},dataMap:{getPoints:{setData:"points"}}}});Ext.define("Genesis.model.frontend.MainPage",{extend:"Ext.data.Model",id:"MainPage",config:{fields:["name","photo_url","desc","pageCntlr","subFeature","route","hide"],proxy:{noCache:false,enablePagingParams:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"},type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/"+((!merchantMode)?"mainClientPage.json":"mainServerPage.json")}}});Ext.define("Genesis.model.frontend.JackpotWinner",{extend:"Ext.data.Model",alternateClassName:"JackpotWinner",id:"JackpotWinner",config:{fields:[{name:"time",type:"date",convert:function(a,b){b.set("date",a);return(a)?Genesis.fn.convertDate(a):null;}},"facebook_id","name","points","date"],idProperty:"id",proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},statics:{setGetJackpotWinnersUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customers/show_jackpot_winners");}}});Ext.define("Genesis.model.UserProfile",{extend:"Ext.data.Model",alternateClassName:"UserProfile",id:"UserProfile",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"}],fields:["gender","birthday","zipcode","created_ts","update_ts","user_id"]},getUser:function(){}});Ext.define("Genesis.model.User",{extend:"Ext.data.Model",requires:["Genesis.model.UserProfile"],alternateClassName:"User",id:"User",config:{hasOne:[{model:"Genesis.model.UserProfile",associationKey:"profile"}],proxy:{type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/users.json",reader:{type:"json"}},fields:["user_id","name","email","facebook_id","photo_url","created_ts","update_ts","profile_id"],idProperty:"user_id"}});Ext.define("Genesis.model.Merchant",{extend:"Ext.data.Model",alternateClassName:"Merchant",id:"Merchant",config:{fields:["id","name","email","photo","alt_photo","account_first_name","account_last_name","phone","auth_code","qr_code","payment_account_id","created_ts","update_ts","type","reward_terms"],idProperty:"id"}});Ext.define("Genesis.model.Challenge",{extend:"Ext.data.Model",id:"Challenge",alternateClassName:"Challenge",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],fields:["id","type","name","description","require_verif","data","points","created_ts","update_ts","photo","merchant_id","venue_id"],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetChallengesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/challenges":Ext.Loader.getPath("Genesis")+"/store/challenges.json");},setCompleteChallengeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/"+a+"/complete");},setCompleteReferralChallengeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/complete_referral");},setSendReferralsUrl:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/"+a+"/start");}}});Ext.define("Genesis.model.Checkin",{extend:"Ext.data.Model",alternateClassName:"Checkin",id:"Checkin",config:{identifier:"uuid",belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"},{model:"Genesis.model.Venue",getterName:"getVenue",setterName:"setVenue"}],fields:["id","time"]}});Ext.define("Genesis.model.PurchaseReward",{extend:"Ext.data.Model",id:"PurchaseReward",alternateClassName:"PurchaseReward",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"},listeners:{metachange:function(d,b,c){var a=_application.getController("client.Rewards");a.fireEvent("updatemetadata",b);}}},fields:["id","title","points","type","photo","created_ts","update_ts"]},getMerchant:function(){},statics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/purchase_rewards":Ext.Loader.getPath("Genesis")+"/store/rewards.json");},setEarnPointsURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/purchase_rewards/earn");},}});Ext.define("Genesis.model.CustomerReward",{extend:"Ext.data.Model",id:"CustomerReward",alternateClassName:"CustomerReward",config:{fields:["id","title","points","type","photo","quantity_limited","quantity","time_limited",{name:"expiry_date",type:"date",convert:function(a,b){a=Date.parse(a,"yyyy-MM-dd");return(a)?Genesis.fn.convertDateNoTimeNoWeek(a):null;}}],idProperty:"id",belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/customer_rewards?mode=reward":Ext.Loader.getPath("Genesis")+"/store/redemptions.json");},setRedeemPointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customer_rewards/"+a+"/redeem?mode=reward");},setGetPrizesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/customer_rewards?mode=prize":Ext.Loader.getPath("Genesis")+"/store/redemptions.json");},setRedeemPrizePointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customer_rewards/"+a+"/redeem?mode=prize");}}});Ext.define("Genesis.model.Venue",{extend:"Ext.data.Model",requires:["Genesis.model.Challenge","Genesis.model.PurchaseReward","Genesis.model.CustomerReward"],alternateClassName:"Venue",id:"Venue",config:{fields:["id","name","address","description","distance","city","state","country","zipcode","phone","website","latitude","longitude","created_ts","update_ts","type","merchant_id","prize_jackpots"],belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"}],hasMany:[{model:"Genesis.model.Challenge",name:"challenges"},{model:"Genesis.model.PurchaseReward",name:"purchaseReward"},{model:"Genesis.model.CustomerReward",name:"customerReward"}],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}},idProperty:"id",},statics:{setFindNearestURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_nearest":Ext.Loader.getPath("Genesis")+"/store/checkinRecords.json");},setGetClosestVenueURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_closest":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setSharePhotoURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/share_photo":Ext.Loader.getPath("Genesis")+"/store/sharePhoto.json");},setGetLicenseKeyURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/venues/updateLicenseKey");}}});Ext.define("Genesis.model.News",{extend:"Ext.data.Model",id:"News",alternateClassName:"News",config:{idProperty:"id",fields:["id","item_id","title","text","type","item_type","photo"]}});Ext.define("Genesis.model.Badge",{extend:"Ext.data.Model",id:"Badge",alternateClassName:"Badge",config:{idProperty:"id",fields:["id","type","visits","rank"],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},statics:{setGetBadgesUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/badges");}}});Ext.define("Genesis.model.CustomerJSON",{extend:"Ext.data.Model",alternateClassName:"CustomerJSON",id:"CustomerJSON",config:{proxy:{type:"localstorage",id:"CustomerJSON",writer:{type:"json"},reader:{type:"json"}},identifier:"uuid",fields:["json","id"],idProperty:"id"}});Ext.define("Genesis.model.Customer",{extend:"Ext.data.Model",requires:["Genesis.model.Checkin","Genesis.model.Merchant"],alternateClassName:"Customer",id:"Customer",config:{belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",name:"merchant",setterName:"setMerchant",getterName:"getMerchant",},{model:"Genesis.model.User",associationKey:"user",name:"user",getterName:"getUser",setterName:"setUser"}],hasOne:[{model:"Genesis.model.Checkin",associationKey:"last_check_in",name:"last_check_in",getterName:"getLastCheckin",setterName:"setLastCheckin"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["id","points","prize_points","visits","next_badge_visits","eligible_for_reward","eligible_for_prize","badge_id","next_badge_id"],idProperty:"id"},getUser:function(){},statics:{isValid:function(a){return a!=0;},updateCustomer:function(d,l){var f,k=false;d.beginEdit();for(var g=0;g<d.fields.length;g++){f=d.fields.items[g].getName();if(d.get(f)!=l.get(f)){d.set(f,l.get(f));k=true;}}try{if(d.getLastCheckin()!=l.getLastCheckin()){d.setLastCheckin(l.getLastCheckin());k=true;}}catch(h){d.setLastCheckin(Ext.create("Genesis.model.Checkin"));k=true;}var b=d.getMerchant()||"";var j=l.getMerchant()||"";var a=b.toString();var c=j.toString();if((a!=c)&&(c!="")){d.handleInlineAssociationData({merchant:j.raw});k=true;}d.endEdit();return k;},setFbLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens/create_from_facebook":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setLogoutUrl:function(a){this.getProxy().setActionMethods({read:"DELETE"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/tokens/"+a);},setCreateAccountUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/sign_up":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setVenueScanCheckinUrl:function(){this.setVenueCheckinUrl();},setVenueCheckinUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/check_ins":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setVenueExploreUrl:function(a){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/"+a+"/explore":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setSendPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customers/transfer_points");},setRecvPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customers/receive_points");}}});Ext.define("Genesis.model.frontend.Account",{extend:"Ext.data.Model",alternateClassName:"Account",id:"Account",config:{fields:["name","username","password"],validations:[{type:"format",field:"name",matcher:/^([a-zA-Z'-]+\s+){1,4}[a-zA-z'-]+$/},{type:"email",field:"username"},{type:"length",field:"password",min:6}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"},listeners:{metachange:function(d,b,c){var a=_application.getController("Viewport");a.fireEvent("updatemetadata",b);}}}},statics:{setUpdateFbLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/account/update_facebook_info");},setPasswdResetUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/account/reset_password");},setPasswdChangeUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/account/change_password");},setRefreshCsrfTokenUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/tokens/get_csrf_token");}}});Ext.define("Genesis.model.frontend.Signin",{extend:"Ext.data.Model",alternateClassName:"Signin",id:"Sigin",config:{fields:["username","password"],validations:[{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.model.frontend.ChangePassword",{extend:"Ext.data.Model",alternateClassName:"ChangePassword",id:"ChangePassword",config:{fields:["oldpassword","newpassword"],validations:[{type:"length",field:"oldpassword",min:6},{type:"length",field:"newpassword",min:6}]}});Ext.define("Genesis.view.ViewBase",{extend:"Ext.Container",xtype:"viewbase",statics:{generateTitleBarConfig:function(){return({xtype:"titlebar",docked:"top",tag:"navigationBarTop",cls:"navigationBarTop",masked:{xtype:"mask",transparent:true},defaults:{iconMask:true}});},invisibleMask:{xtype:"mask",transparent:true}},config:{preRender:null},initialize:function(){this.callParent(arguments);this.setPreRender([]);},cleanView:function(){this.fireEvent("cleanView",this);},removeAll:function(a,b){var c=this.callParent(arguments);this.setPreRender([]);return c;},createView:function(){this.fireEvent("createView",this);return(this.getPreRender().length==0);},showView:function(){if(this.getInnerItems().length==0){this.add(this.getPreRender());}Ext.defer(this.fireEvent,0.01*1000,this,["showView",this]);}});Ext.define("Genesis.view.Document",{extend:"Genesis.view.ViewBase",xtype:"documentview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"container",tag:"content",scrollable:"vertical",padding:"0.7 0.8",defaultUnit:"em",html:" "}]},disableAnimation:true,setHtml:function(b){var c=this.query("container[tag=content]")[0];var a=c.getScrollable();c.setHtml(b);if(a){a.getScroller().scrollTo(0,0);}},createView:function(){if(!this.callParent(arguments)){return;}}});Ext.define("Genesis.view.MultipartDocument",{requires:["Ext.tab.Panel"],extend:"Genesis.view.ViewBase",xtype:"multipartdocumentview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"tabpanel",defaults:{xtype:"container",scrollable:"vertical",padding:"0.7 0.8",defaultUnit:"em",html:" "},layout:"card",tabBarPosition:"top",tabBar:{layout:{pack:"justify"}}}]},disableAnimation:true,setHtml:function(b,d){var e=this.query("tabpanel")[0];var c=e.getInnerItems()[b];if(!c){c=e.insert(b,Ext.apply({xtype:"container"},d));}else{var a=c.getScrollable();a.getScroller().scrollTo(0,0);c.setHtml(html);}},createView:function(){if(!this.callParent(arguments)){return;}}});Ext.define("Genesis.view.client.CheckinExplore",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.plugin.ListPaging","Ext.plugin.PullRefresh"],alias:"widget.clientcheckinexploreview",config:{layout:"fit",cls:"viewport",merchant:null,items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",ui:"normal",iconCls:"home",tag:"home"},{align:"right",ui:"normal",tag:"rewardsSC",text:"Earn Pts!"}]}),{docked:"bottom",cls:"checkInNow",tag:"checkInNow",xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"button",tag:"checkInNow",text:"CheckIn Now!"}]}]},disableAnimation:true,createView:function(){if(!this.callParent(arguments)){return;}this.getPreRender().push(Ext.create("Ext.List",{xtype:"list",store:"CheckinExploreStore",plugins:[{type:"pullrefresh",refreshFn:function(b){var a=_application.getController("client.Checkins");a.fireEvent("exploreLoad",true);}},{type:"listpaging",autoPaging:true,loadMoreText:"",noMoreRecordsText:""}],refreshHeightOnUpdate:false,variableHeights:false,deferEmptyText:false,itemHeight:Genesis.fn.calcPx(Genesis.fn.calcPxEm(Genesis.constants.defaultIconSize(),2*0.65,1),1),emptyText:" ",tag:"checkInExploreList",cls:"checkInExploreList",itemTpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div><div class="listItemDetailsWrapper"><div class="itemDistance">{[this.getDistance(values)]}</div><div class="itemTitle">{name}</div><div class="itemDesc">{[this.getAddress(values)]}</div></div>',{getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_small"].url;},getAddress:function(a){return(a.address+",<br/>"+a.city+", "+a.state+", "+a.country+",<br/>"+a.zipcode);},getDistance:function(a){return a.distance.toFixed(1)+"km";}}),onItemDisclosure:Ext.emptyFn}));}});Ext.define("Genesis.view.Viewport",{extend:"Ext.Container",requires:["Ext.fx.layout.Card","Genesis.view.ViewBase"],xtype:"viewportview",config:{autoDestroy:false,cls:"viewport",layout:{type:"card",animation:{type:"cover",reverse:false,direction:"left"}},fullscreen:true},loadingMsg:"Loading ...",initialize:function(){this.callParent(arguments);},animateActiveItem:function(c,b){var e=this.getLayout(),i=(e.getAnimation)?e.getAnimation():null;var j=this.getActiveItem();var h=(c.disableAnimation||((j)?j.disableAnimation:false));var g,f=_application.getController("Viewport");if(this.activeItemAnimation){this.activeItemAnimation.destroy();}this.activeItemAnimation=b=new Ext.fx.layout.Card(b);console.debug("Activate View ["+c._itemId+"]");if(b&&e.isCard&&!h){b.setLayout(e);if(i){var d=_application.getController("Viewport").getEventDispatcher().controller;i.disable();d.pause();c.createView();b.on("animationend",function(){console.debug("Animation Complete");i.enable();b.destroy();delete this.activeItemAnimation;if(j){j.cleanView(c);g=j.query("titlebar")[0];if(g){g.setMasked(Genesis.view.ViewBase.invisibleMask);}}c.showView();g=c.query("titlebar")[0];if(g){g.setMasked(false);}d.resume();f.popViewInProgress=false;},this);}else{}}if(i&&h){i.disable();}var a=this.setActiveItem(c);if(!e.isCard||h){if(i){i.enable();}b.destroy();if(j){j.cleanView(c);var g=j.query("titlebar")[0];if(g){g.setMasked(Genesis.view.ViewBase.invisibleMask);}}c.createView();Ext.defer(function(){c.showView();g=c.query("titlebar")[0];if(g){g.setMasked(false);}f.popViewInProgress=false;},0.1*1000,this);}return a;}});Ext.define("Genesis.view.client.ChallengePage",{extend:"Genesis.view.ViewBase",requires:["Ext.data.Store","Ext.Carousel","Ext.dataview.DataView","Ext.XTemplate","Ext.Toolbar","Genesis.model.Challenge"],alias:"widget.clientchallengepageview",config:{layout:"fit",cls:"viewport",scrollable:undefined,items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Challenges",items:[{align:"left",ui:"normal",tag:"close",text:"Close"}]}),{xtype:"carousel",cls:"challengePageItem shadows",direction:"horizontal"},{docked:"bottom",cls:"checkInNow",tag:"challengeContainer",hidden:true,xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"button",iconCls:"dochallenges",iconMask:true,tag:"doit",text:"Lets do it!"}]},{docked:"bottom",xtype:"container",tag:"challengePageItemDescWrapper",cls:"challengePageItemDescWrapper",layout:{type:"vbox",align:"stretch",pack:"start"},defaults:{xtype:"component"},items:[{cls:"itemDesc",data:{description:""},tpl:Ext.create("Ext.XTemplate","{[this.getDesc(values)]}",{getDesc:function(a){return a.description;}})}]}],listeners:[{element:"element",delegate:"div.itemWrapper",event:"tap",fn:"onItemTap"}]},takePhoto:function(){if(!this.photoAction){this.photoAction=Ext.create("Ext.ActionSheet",{hideOnMaskTap:false,defaults:{defaultUnit:"em",margin:"0 0 0.5 0",xtype:"button",handler:Ext.emptyFn},items:[{text:"Use Photo from Library",tag:"library"},{text:"Use Photo from Photo Album",tag:"album"},{text:"Take a Picture",tag:"camera"},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",scope:this,handler:function(){this.photoAction.hide();}}]});Ext.Viewport.add(this.photoAction);}this.photoAction.show();},deselectItems:function(){var c=this.query("carousel")[0];var a=Ext.DomQuery.select("div.itemWrapper",c.element.dom);for(var b=0;b<a.length;b++){Ext.get(a).removeCls("x-item-selected");}},onItemTap:function(g,f,c,b){this.deselectItems();var a=Ext.get(g.delegatedTarget);a.addCls("x-item-selected");var d=Ext.create("Genesis.model.Challenge",Ext.decode(decodeURIComponent(g.delegatedTarget.getAttribute("data"))));_application.getController("client.Challenges").fireEvent("itemTap",d);},cleanView:function(){this.callParent(arguments);},createView:function(){var d=this.query("carousel")[0];var a=_application.getController("Viewport").getVenue();var e=a.getId();var b=a.challenges().getRange();if((d.getInnerItems().length>0)&&(d.getInnerItems()[0].getStore().getRange()[0].getId()==b[0].getId())){this.deselectItems();console.log("ChallengePage Icons Refreshed.");}else{d.removeAll(true);for(var c=0;c<Math.ceil(b.length/6);c++){d.add({xtype:"component",cls:"challengeMenuSelections",tag:"challengeMenuSelections",scrollable:undefined,data:Ext.Array.pluck(b.slice(c*6,((c+1)*6)),"data"),tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="itemWrapper x-hasbadge" data="{[this.encodeData(values)]}">','<span class="x-badge round">{[this.getPoints(values)]}</span>','<div class="photo"><img src="{[this.getPhoto(values)]}" /></div>','<div class="photoName">{name}</div>',"</div>","</tpl>",{encodeData:function(f){return encodeURIComponent(Ext.encode(f));},getPoints:function(f){return f.points+" Points";},getPhoto:function(f){return Ext.isEmpty(f.photo)?Genesis.view.client.ChallengePage.getPhoto(f.type):f.photo.url;}})});}if(d.getInnerItems().length>0){d.setActiveItem(0);}console.log("ChallengePage Icons Updated.");}this.callParent(arguments);},statics:{getPhoto:function(a){var b=null;var c=a.value;switch(c){case"custom":c="mystery";default:b=Genesis.constants.getIconPath("mainicons",c);break;}return b;}}});Ext.define("Genesis.view.MainPage",{extend:"Genesis.view.ViewBase",requires:["Ext.data.Store","Ext.Carousel","Ext.dataview.DataView","Ext.XTemplate","Ext.Toolbar"],alias:"widget.mainpageview",config:{layout:"fit",cls:"viewport",listeners:[{element:"element",delegate:"div.itemWrapper",event:"tap",fn:"onItemTap"}],scrollable:undefined,items:(function(){var a=[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{xtype:"titlebar",cls:"navigationBarTop kbTitle",items:[{align:"right",tag:"info",iconCls:"info",destroy:function(){this.actions.destroy();this.callParent(arguments);},handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{defaultUnit:"em",padding:"1em",hideOnMaskTap:false,defaults:{xtype:"button",defaultUnit:"em"},items:[{margin:"0 0 0.5 0",text:"Logout",tag:"logout"},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",scope:this,handler:function(){this.actions.hide();}}]});Ext.Viewport.add(this.actions);}this.actions.show();}}]}),{xtype:"carousel",direction:"horizontal"}];if(!merchantMode){a.push({docked:"bottom",cls:"navigationBarBottom",tag:"navigationBarBottom",xtype:"tabbar",ui:"light",layout:{pack:"justify",align:"center"},defaults:{iconMask:true,iconAlign:"top"},items:[{xtype:"spacer"},{iconCls:"rewards",tag:"rewardsSC",title:"Earn Pts"},{xtype:"spacer"}]});}return a;}())},disableAnimation:(!merchantMode)?true:true,initialize:function(){this.setPreRender([]);this.callParent(arguments);},onItemTap:function(f,d,b,a){var c=Ext.create("Genesis.model.frontend.MainPage",Ext.decode(decodeURIComponent(f.delegatedTarget.getAttribute("data"))));_application.getController("MainPage").fireEvent("itemTap",c);},cleanView:function(){var a=this.query("carousel")[0];a.removeAll(true);this.callParent(arguments);},createView:function(){var m=this.query("carousel")[0];var b=_application;var g=b.getController("Viewport");var n=g.getViewport();var k=g.getCheckinInfo().venue!=null;var h=Ext.StoreMgr.get("MainPageStore").getRange();var f=Ext.Array.clone(h);if(!m._listitems){m._listitems=[];}if(!k){Ext.Array.forEach(f,function(p,i,o){switch(p.get("hide")){case"true":Ext.Array.remove(h,p);break;}});}if((Ext.Array.difference(h,m._listitems).length>0)||(h.length!=m._listitems.length)){m._listitems=h;m.removeAll(true);for(var d=0;d<Math.ceil(h.length/6);d++){m.add({xtype:"component",cls:"mainMenuSelections",tag:"mainMenuSelections",scrollable:undefined,data:Ext.Array.pluck(h.slice(d*6,((d+1)*6)),"data"),tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="itemWrapper x-hasbadge" data="{[this.encodeData(values)]}">',"{[this.isEligible(values)]}",'<div class="photo"><img src="{[this.getPhoto(values.photo_url)]}" /></div>','<div class="photoName">{name}</div>',"</div>","</tpl>",{encodeData:function(i){return encodeURIComponent(Ext.encode(i));},getType:function(){return values.pageCntlr;},isEligible:function(p,s){var t=(p.pageCntlr=="client.Redemptions");var o=(p.pageCntlr=="client.Prizes");var v=false;p.index=s-1;if(t||o){var q=Ext.StoreMgr.get("CustomerStore").getRange();for(var r=0;r<q.length;r++){var u=q[r];if(o){if(u.get("eligible_for_prize")){v=true;break;}}else{if(t){if(u.get("eligible_for_reward")){v=true;break;}}}}}return((t||o)?'<span data="'+p.pageCntlr+'" class="x-badge round '+((v)?"":"x-item-hidden")+'">✔</span>':"");},getPhoto:function(i){return Ext.isEmpty(i)?Ext.BLANK_IMAGE_URL:i;}})});}console.log("MainPage Icons Refreshed.");}else{var l=Ext.StoreMgr.get("CustomerStore").getRange();var a=false;var j=false;for(var d=0;d<l.length;d++){var e=l[d];if(e.get("eligible_for_reward")){a=true;break;}if(e.get("eligible_for_prize")){j=true;break;}}if(m.getInnerItems().length>0){var c=Ext.DomQuery.select("span[data=client.Redemptions]",m.element.dom)[0];if(a){c.innerHTML=count;Ext.fly(c).removeCls("x-item-hidden");}else{if(!c.className.match(/x-item-hidden/)){Ext.fly(c).addCls("x-item-hidden");}}c=Ext.DomQuery.select("span[data=client.Prizes]",m.element.dom)[0];if(j){c.innerHTML=count;Ext.fly(c).removeCls("x-item-hidden");}else{if(!c.className.match(/x-item-hidden/)){Ext.fly(c).addCls("x-item-hidden");}}}console.log("MainPage Icons Not changed.");}delete m._listitems;this.callParent(arguments);},showView:function(){var a=this.query("carousel")[0];if(a.getInnerItems().length>0){a.setActiveItem(0);}this.callParent(arguments);}});Ext.define("Genesis.view.LoginPage",{extend:"Genesis.view.ViewBase",requires:["Ext.ActionSheet"],alias:"widget.loginpageview",config:{cls:"bgImage",scrollable:undefined},initialize:function(){var a=Ext.create("Ext.ActionSheet",{modal:false,style:{background:"transparent",border:"none"},showAnimation:null,hideAnimation:null,defaultUnit:"em",padding:"1em",hideOnMaskTap:false,defaults:{defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"},items:[{tag:"facebook",ui:"fbBlue",text:"Facebook"},{tag:"createAccount",ui:"action",text:"Create Account"},{tag:"signIn",text:"Sign In"}]});this.add(a);this.callParent(arguments);}});Ext.define("Genesis.view.SignInPage",{extend:"Ext.form.Panel",alias:"widget.signinpageview",requires:["Ext.field.Email","Ext.field.Password"],config:{preRender:null,fullscreen:true,cls:"viewport",layout:{type:"vbox",align:"stretch",pack:"start"},changeTitle:false,items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Sign In",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"fieldset",title:"Login Credentials:",defaults:{required:true,labelAlign:"top"},items:[{xtype:"emailfield",name:"username",label:"User Name",clearIcon:true,placeHolder:"Email Address"},{xtype:"passwordfield",name:"password",label:"Password",clearIcon:true}]},{xtype:"button",ui:"action",tag:"login",text:"Sign In",defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"},{xtype:"button",tag:"reset",text:"Password Reset",defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"}]},initialize:function(){this.callParent(arguments);this.setPreRender([]);},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments);},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments);},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments);},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments);}});Ext.define("Genesis.view.PasswdResetPage",{extend:"Ext.form.Panel",alias:"widget.passwdresetpageview",requires:["Ext.field.Email"],config:{preRender:null,fullscreen:true,cls:"viewport",layout:{type:"vbox",align:"stretch",pack:"start"},changeTitle:false,scrollable:"vertical",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Password Reset",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"fieldset",title:"Login Credentials:",defaults:{required:true,labelAlign:"top"},items:[{xtype:"emailfield",name:"username",label:"User Name",clearIcon:true,placeHolder:"Email Address"}]},{xtype:"button",tag:"submit",text:"Reset",defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"}]},initialize:function(){this.callParent(arguments);this.setPreRender([]);},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments);},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments);},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments);},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments);}});Ext.define("Genesis.view.PasswdChangePage",{extend:"Ext.form.Panel",alias:"widget.passwdchangepageview",requires:["Ext.field.Password","Ext.field.Text"],config:{preRender:null,fullscreen:true,cls:"viewport",layout:{type:"vbox",align:"stretch",pack:"start"},changeTitle:false,scrollable:"vertical",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Password Change",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"fieldset",title:"Login Credentials:",defaults:{required:true,labelAlign:"top"},items:[{xtype:"passwordfield",name:"oldpassword",label:"Old Password",clearIcon:true},{xtype:"passwordfield",name:"newpassword",label:"New Password",clearIcon:true}]},{xtype:"button",tag:"submit",text:"Change Password",defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"}]},initialize:function(){this.callParent(arguments);this.setPreRender([]);},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments);},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments);},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments);},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments);}});Ext.define("Genesis.view.CreateAccountPage",{extend:"Ext.form.Panel",alias:"widget.createaccountpageview",requires:["Ext.field.Text","Ext.field.Email","Ext.field.Password"],config:{preRender:null,fullscreen:true,cls:"viewport",layout:{type:"vbox",align:"stretch",pack:"start"},changeTitle:false,scrollable:"vertical",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Create Account",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{flex:1,xtype:"fieldset",title:"Account Credentials:",defaults:{required:true,labelAlign:"top"},items:[{xtype:"textfield",name:"name",label:"Full Name",clearIcon:true,placeHolder:"John Smith"},{xtype:"emailfield",name:"username",label:"User Name",clearIcon:true,placeHolder:"Email Address"},{xtype:"passwordfield",name:"password",label:"Password",clearIcon:true}]},{xtype:"button",ui:"createAccount",tag:"createAccount",text:"Create Account"}]},initialize:function(){this.callParent(arguments);this.setPreRender([]);},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments);},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments);},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments);},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments);}});Ext.define("Genesis.view.RedeemItemDetail",{extend:"Genesis.view.ViewBase",requires:["Ext.XTemplate","Ext.Carousel","Genesis.view.widgets.RedeemItem"],alias:"widget.redeemitemdetailview",config:{scrollable:undefined,cls:"redeemItemMain viewport",layout:"fit",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Prizes",items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{align:"left",tag:"back",ui:"normal",text:"Back"},{align:"right",tag:"redeem",text:"Redeem"},{align:"right",hidden:true,tag:"done",text:"Done"}]})]},cleanView:function(){switch(this.config.tag){case"userPrizes":break;case"merchantPrizes":this.removeAll(true);break;}this.callParent(arguments);},createView:function(){switch(this.config.tag){case"userPrizes":this.onUserCreateView();break;case"merchantPrizes":this.onMerchantCreateView();break;}this.callParent(arguments);},onUserCreateView:function(){var c=this;var a=Ext.StoreMgr.get("PrizeStore").getRange();if(a.length==0){this.getPreRender().push(Ext.create("Ext.Component",{tag:"rewardPanel",cls:"noprizes",xtype:"component",scrollable:false,defaultUnit:"em",margin:"0 0 0.8 0"}));console.log("UserPrize View - No Prizes found.");}else{var b=c.getInnerItems()[0];var d=[];if(b&&b.isXType("carousel",true)){console.log("UserPrize View - do not need to be updated.");}else{if(!b){b=Ext.create("Ext.Carousel",{xtype:"carousel",scrollable:undefined});this.getPreRender().push(b);}for(var e=0;e<a.length;e++){d.push(Ext.create("Ext.dataview.DataView",{tag:"rewardPanel",xtype:"dataview",store:{model:"Genesis.model.EarnPrize",autoLoad:false,data:a[e]},maxItemCache:0,useComponents:true,scrollable:false,defaultType:"redeemitem",defaultUnit:"em",margin:"0 0 0.8 0"}));}b.add(d);console.log("UserPrize View - Found "+a.length+" Prizes needed to update.");}}},onMerchantCreateView:function(){var e=this;var c=_application.getController("Viewport");var h=(c.getVenue())?c.getVenue().getMerchant().getId():0;var d;var b=[];var a=Ext.StoreMgr.get("PrizeStore").getRange();if(a.length>0){for(var g=0;g<a.length;g++){if(a[g].getMerchant().getId()!=h){continue;}b.push(a[g]);}}if(b.length==0){this.getPreRender().push(Ext.create("Ext.Component",{tag:"rewardPanel",cls:"noprizes",xtype:"component",scrollable:false,defaultUnit:"em",margin:"0 0 0.8 0"}));console.log("MerchantPrize View - No Prizes found.");}else{var d=e.getInnerItems()[0];if(!d){this.getPreRender().push(d=Ext.create("Ext.Carousel",{xtype:"carousel",scrollable:undefined}));}if((d&&d.isXType("carousel",true)&&d.query("dataview")[0]&&d.query("dataview")[0].getStore().first().getMerchant().getId()==h)){console.log("MerchantPrize View - do not need to be updated.");}else{var f=[];for(var g=0;g<b.length;g++){f.push(Ext.create("Ext.dataview.DataView",{tag:"rewardPanel",xtype:"dataview",store:{model:"Genesis.model.EarnPrize",autoLoad:false,data:b[g]},maxItemCache:0,useComponents:true,scrollable:false,defaultType:"reedemitem",defaultUnit:"em",margin:"0 0 0.8 0"}));}d.add(f);d.setActiveItem(0);d.show();console.log("MerchantPrize View - Found "+b.length+" Prizes needed to update.");}}},showView:function(){var a=this.query("carousel")[0];if(a){a.setActiveItem(0);}this.getInnerItems()[0].setVisibility(true);this.callParent(arguments);},statics:{getPhoto:function(a){var b=null;switch(a.value){case"earn_points":break;default:b=Genesis.constants.getIconPath("prizewon",a.value);break;}return b;}}});Ext.define("Genesis.view.ShowRedeemItemDetail",{extend:"Genesis.view.ViewBase",requires:["Ext.XTemplate","Genesis.view.widgets.RedeemItem"],alias:"widget.showredeemitemdetailview",config:{scrollable:undefined,cls:"redeemItemMain viewport",layout:{type:"vbox",pack:"center",align:"stretch"},items:[{xtype:"titlebar",docked:"top",tag:"navigationBarTop",cls:"navigationBarTop",title:"Prizes",defaults:{iconMask:true},items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{align:"right",tag:"redeem",text:"Redeem"},{align:"right",hidden:true,tag:"done",text:"Done"}]},{docked:"bottom",xtype:"button",margin:"0.8 0.7",defaultUnit:"em",tag:"refresh",text:"Refresh",ui:"orange-large"},{docked:"bottom",margin:"0.8 0.7",defaultUnit:"em",xtype:"button",cls:"separator",tag:"verify",text:"Verified!",ui:"orange-large"}]},cleanView:function(){this.callParent(arguments);},createView:function(){if(!this.callParent(arguments)){this.query("dataview[tag=rewardPanel]")[0].getStore().setData(this.redeemItem);delete this.redeemItem;return;}this.getPreRender().push(Ext.create("Ext.dataview.DataView",{flex:1,tag:"rewardPanel",xtype:"dataview",store:{model:"Genesis.model.CustomerReward",autoLoad:false,data:this.redeemItem},maxItemCache:0,useComponents:true,scrollable:false,defaultType:"redeemitem",defaultUnit:"em",margin:"0 0 0.8 0"}));delete this.redeemItem;}});Ext.define("Genesis.view.PromotionItem",{extend:"Genesis.view.ShowRedeemItemDetail",alias:"widget.promotionalitemview",config:{scrollable:undefined,cls:"redeemItemMain viewport",layout:"fit",items:[{xtype:"titlebar",docked:"top",tag:"navigationBarTop",cls:"navigationBarTop",title:" ",defaults:{iconMask:true},items:[{align:"left",hidden:true,tag:"back",ui:"normal",text:"Back"},{align:"right",tag:"done",text:"Done"}]}]}});Ext.define("Genesis.view.client.Badges",{extend:"Ext.Carousel",requires:["Ext.dataview.DataView","Ext.XTemplate"],alias:"widget.clientbadgesview",config:{cls:"viewport",preRender:null,direction:"horizontal",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Badges",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]})],listeners:[{element:"element",delegate:"div.itemWrapper",event:"tap",fn:"onItemTap"}]},initialize:function(){this.setPreRender([]);this.callParent(arguments);},onItemTap:function(f,d,b,a){var c=Ext.create("Genesis.model.Badge",Ext.decode(decodeURIComponent(f.delegatedTarget.getAttribute("data"))));_application.getController("client.Badges").fireEvent("itemTap",c);},cleanView:function(){this.removeAll(true);return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments);},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments);},createView:function(){var f=this;if(!Genesis.view.ViewBase.prototype.createView.apply(this,arguments)){return;}f.removeAll(true);var g=_application;var a=g.getController("Viewport");var d=a.getViewport();var b=Ext.StoreMgr.get("BadgeStore").getRange();var e=Ext.Array.clone(b);for(var c=0;c<Math.ceil(e.length/16);c++){this.getPreRender().push({xtype:"component",cls:"badgesMenuSelections",tag:"badgesMenuSelections",scrollable:undefined,data:Ext.Array.pluck(e.slice(c*16,((c+1)*16)),"data"),tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="itemWrapper" data="{[this.encodeData(values)]}">','<div class="photo"><img src="{[this.getPhoto(values)]}" /></div>','<div class="photoName">{[this.getName(values)]}</div>',"</div>","</tpl>",{encodeData:function(h){return encodeURIComponent(Ext.encode(h));},getName:function(h){return h.type.display_value;},getPhoto:function(i){var j=i.type;var k=_application.getController("Viewport").getCustomer();var h=Ext.StoreMgr.get("BadgeStore").getById(k.get("badge_id"));var l=h.get("rank");return Genesis.view.client.Badges.getPhoto((i.rank<=l)?j:"nobadge","thumbnail_medium_url");}})});}console.log("Badge Icons Refreshed.");},showView:function(){if(this.getInnerItems().length==0){this.add(this.getPreRender());}var a=this;if(a.getInnerItems().length>0){a.setActiveItem(0);}return Genesis.view.ViewBase.prototype.showView.apply(this,arguments);},statics:{getPhoto:function(c,b){var a;switch(c){case"nobadge":switch(b){case"thumbnail_small_url":b="small";break;case"thumbnail_medium_url":b="medium";break;case"thumbnail_large_url":b="large";break;}a=Genesis.constants.getIconPath("badges",b+"/nobadge",false);break;default:a=(Genesis.constants.photoSite+c[b]);break;}return a;}}});Ext.define("Genesis.view.client.MerchantAccount",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar","Ext.tab.Bar","Genesis.view.widgets.MerchantAccountPtsItem"],alias:"widget.clientmerchantaccountview",config:{tag:"merchantMain",cls:"merchantMain viewport",scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",iconCls:"maps",tag:"mapBtn"}]}),{docked:"bottom",cls:"navigationBarBottom",tag:"navigationBarBottom",xtype:"tabbar",ui:"light",layout:{pack:"justify",align:"center"},scrollable:{direction:"horizontal",indicators:false},defaults:{iconMask:true,iconAlign:"top"},items:[{iconCls:"home",tag:"home",title:"Home"},{tag:"prizes",iconMask:false,badgeCls:"x-badge round",title:"Prizes"},{iconCls:"rewards",tag:"rewards",title:"Earn Pts"},{xtype:"spacer"},{iconCls:"challenges",tag:"challenges",title:"Challenges"},{xtype:"spacer"},{iconCls:"redeem",badgeCls:"x-badge round",tag:"redemption",title:"Rewards"},{iconCls:"tocheckedinmerch",tag:"main",title:"Meal Stop"},{iconCls:"checkin",tag:"checkin",title:"Check-ins"}]}],listeners:[{element:"element",delegate:"div.badgephoto",event:"tap",fn:"onBadgeTap"},{element:"element",delegate:"div.prizeswonphoto",event:"tap",fn:"onJackpotWinnersTap"}]},disableAnimation:true,loadingText:"Loading ...",cleanView:function(a){if(a.isXType("checkinexploreview",true)||a.isXType("mainpageview",true)){this.removeAll(true);}this.callParent(arguments);},showView:function(){this.callParent(arguments);this.query("tabbar")[0].show();for(var b=0;b<this.getInnerItems().length;b++){this.getInnerItems()[b].setVisibility(true);}var a=this.query("container[tag=feedContainer]")[0];if(a){a[(Ext.StoreMgr.get("NewsStore").getRange().length>0)?"show":"hide"]();}},createView:function(){if(!this.callParent(arguments)){return;}this.getPreRender().push(Ext.create("Ext.dataview.DataView",{tag:"tbPanel",xtype:"dataview",store:"MerchantRenderStore",useComponents:true,scrollable:undefined,minHeight:window.innerWidth,defaultType:"merchantaccountptsitem",defaultUnit:"em",margin:"0 0 0.7 0"}));if(this.renderFeed&&(Ext.StoreMgr.get("NewsStore").getCount()>0)){this.getPreRender().push(Ext.create("Ext.Container",{xtype:"container",tag:"feedContainer",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"dataview",scrollable:undefined,store:"NewsStore",cls:"feedPanel",tag:"feedPanel",items:[{docked:"top",xtype:"toolbar",ui:"dark",cls:"feedPanelHdr",centered:false,items:[{xtype:"title",title:"What's going on?"},{xtype:"spacer"}]}],itemTpl:Ext.create("Ext.XTemplate",'<div class="itemWrapper" style="{[this.getDisclose(values)]}">','<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">{[this.getDesc(values)]}</div>',"</div>",{getDisclose:function(a){switch(a.type){case"vip":a.disclosure=false;break;}return((a.disclosure===false)?"padding-right:0;":"");},getPhoto:function(a){if(!a.photo){return Genesis.view.client.MerchantAccount.getPhoto({value:a.type});}return a.photo.url;},getTitle:function(a){return a.title;},getDesc:function(a){return a.text;}}),onItemDisclosure:Ext.emptyFn}]}));}this.setPreRender(this.getPreRender().concat([Ext.create("Ext.Container",{xtype:"container",tag:"descContainer",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"dataview",store:"MerchantRenderStore",scrollable:undefined,cls:"descPanel",tag:"descPanel",items:[{docked:"top",xtype:"toolbar",cls:"descPanelHdr",ui:"light",centered:false,items:[{xtype:"title",title:"About Us"},{xtype:"spacer"}]}],itemTpl:Ext.create("Ext.XTemplate","{[this.getDesc(values)]}",{getDesc:function(a){return a.description;}})}]})]));},onBadgeTap:function(c,f,d){var a=_application.getController("Viewport");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);this.fireEvent("badgeTap");},onJackpotWinnersTap:function(c,f,d){var a=_application.getController("Viewport");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);this.fireEvent("jackpotWinnersTap");},statics:{getPhoto:function(a){if(!a.value){return Genesis.constants.getIconPath("miscicons","pushnotification");}else{}}}});Ext.define("Genesis.view.client.MerchantDetails",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.DataView","Ext.XTemplate","Ext.Map","Genesis.view.widgets.MerchantDetailsItem"],alias:"widget.clientmerchantdetailsview",config:{cls:"merchantDetails viewport",layout:{type:"vbox",align:"stretch",pack:"start"},defaults:{cls:"separator"},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",tag:"back",ui:"normal",text:"Back"},{align:"right",iconCls:"share",tag:"shareBtn",handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{hideOnMaskTap:false,defaults:{defaultUnit:"em",margin:"0 0 0.5 0",xtype:"button"},items:[{text:"Refer-A-Friend",ui:"action",tag:"emailShareBtn",scope:this,handler:function(){this.actions.hide();}},{text:"Post on Facebook",tag:"fbShareBtn",ui:"fbBlue",scope:this,handler:function(){this.actions.hide();}},{margin:"0.5 0 0 0",text:"Cancel",iconMaskCls:"dummymask",ui:"cancel",scope:this,handler:function(){this.actions.hide();}}]});Ext.Viewport.add(this.actions);}this.actions.show();}}]})]},renderView:function(e){var a=_application.getController("client.Merchants");var c=e.getSize();var d=Genesis.fn.calcPx(0.7,1);e.setSize(c.width,c.height-(1*12));var f=Ext.Object.toQueryString(Ext.apply({zoom:15,scale:window.devicePixelRatio,maptype:"roadmap",sensor:false,size:c.width+"x"+(c.height-(1*d))},a.markerOptions));var b=Ext.String.urlAppend(a.self.googleMapStaticUrl,f);Ext.getCmp(e.observableId.split(e.observableIdPrefix)[1]).setData({width:c.width,height:c.height-(1*d),photo:b});},cleanView:function(){this.removeAll(true);this.callParent(arguments);},createView:function(){var a=this;if(!a.callParent(arguments)){a.renderView(a.query("component[tag=map]")[0]);return;}a.setPreRender(a.getPreRender().concat([Ext.create("Ext.dataview.DataView",{xtype:"dataview",cls:"separator",tag:"details",useComponents:true,defaultType:"merchantdetailsitem",scrollable:undefined,store:"MerchantRenderStore"}),Ext.create("Ext.Component",{xtype:"component",tag:"map",flex:1,cls:"separator_pad gmap",defaultUnit:"em",listeners:{painted:function(b){a.renderView(b);}},tpl:Ext.create("Ext.XTemplate",'<img height="{height}" width="{width}" src="{photo}"/>')})]));}});Ext.define("Genesis.view.client.SettingsPage",{extend:"Ext.form.Panel",requires:["Ext.dataview.List","Ext.XTemplate","Genesis.view.widgets.ListField"],alias:"widget.clientsettingspageview",config:{preRender:null,cls:"viewport",scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Settings",items:[{align:"left",tag:"back",ui:"normal",text:"Back"}]}),{xtype:"fieldset",title:"Login Profile",items:[{xtype:"togglefield",name:"facebook",label:"Facebook",labelWidth:(!Genesis.constants.isNative())?"65%":"57.5%",value:0},{xtype:"listfield",name:"changepassword",value:"Change Password"}]},{xtype:"fieldset",title:"About Kickbak",items:[{xtype:"textfield",value:"Version 1.0.2",readOnly:true},{xtype:"listfield",name:"terms",value:"Terms of Use"},{xtype:"listfield",name:"privacy",value:"Privacy"}]}]},initialize:function(){this.callParent(arguments);this.setPreRender([]);},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments);},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments);},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments);},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments);}});Ext.define("Genesis.view.client.Accounts",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar","Ext.plugin.ListPaging"],alias:"widget.clientaccountsview",config:{cls:"accountsMain viewport",layout:{type:"card",animation:{duration:400,easing:"ease-in-out",type:"slide",direction:"left"}},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",tag:"back",ui:"normal",text:"Back"},{align:"left",tag:"vback",hidden:true,ui:"normal",text:"Back"}]})]},showTransferHdr:false,cleanView:function(){this.removeAll(true);this.callParent(arguments);},createView:function(){var a=this;if(!a.callParent(arguments)){return;}a.setPreRender(a.getPreRender().concat([Ext.create("Ext.List",{xtype:"list",store:"CustomerStore",tag:"accountsList",cls:"accountsList",plugins:[{type:"listpaging",autoPaging:true,noMoreRecordsText:"",loadMoreText:""}],refreshHeightOnUpdate:false,variableHeights:false,deferEmptyText:false,itemHeight:Genesis.fn.calcPx(Genesis.fn.calcPxEm(Genesis.constants.defaultIconSize(),2*0.65,1),1),loadingText:null,deferEmptyText:false,emptyText:" ",pinHeaders:false,grouped:true,items:[{docked:"top",xtype:"toolbar",centered:false,tag:"transferHdr",hidden:!a.showTransferHdr,defaults:{iconMask:true},items:[{xtype:"title",title:"Select Account :"},{xtype:"spacer",align:"right"}]}],itemTpl:Ext.create("Ext.XTemplate",'<tpl if="this.isValidCustomer(values)">','<div class="photo x-hasbadge">',"{[this.isEligible(values)]}",'<img src="{[this.getPhoto(values)]}"/>',"</div>",'<div class="listItemDetailsWrapper {[this.isSingle(values)]}">','<tpl if="this.showRewardPoints()">','<div class="points">',"{[this.getRewardPoints(values)]}","</div>","</tpl>",'<tpl if="this.showPrizePoints()">','<div class="points">',"{[this.getPrizePoints(values)]}</div>","</tpl>","</div>","</tpl>",{isSingle:function(b){rc="";switch(a.mode){case"redeemPrizesProfile":case"redeemRewardsProfile":rc="single";break;case"profile":case"emailtransfer":case"transfer":default:break;}return rc;},getTitle:function(){return("Reward Points: <br/>Prize Points:");},isValidCustomer:function(b){return Customer.isValid(b.id);},isEligible:function(b){var c=false;switch(a.mode){case"redeemRewardsProfile":c=b.eligible_for_reward;break;case"redeemPrizesProfile":c=b.eligible_for_prize;break;case"profile":c=b.eligible_for_reward||b.eligible_for_prize;break;case"emailtransfer":case"transfer":default:break;}return('<span class="x-badge round '+((c)?"":"x-item-hidden")+'">✔</span>');},getPhoto:function(b){return b.merchant.photo["thumbnail_ios_small"].url;},showRewardPoints:function(){var b=true;switch(a.mode){case"redeemPrizesProfile":b=false;break;case"redeemRewardsProfile":case"emailtransfer":case"transfer":default:break;}return b;},getRewardPoints:function(b){return b.points+'<img src="'+Genesis.constants.getIconPath("miscicons","points")+'">';},showPrizePoints:function(){var b=true;switch(a.mode){case"redeemRewardsProfile":case"emailtransfer":case"transfer":b=false;break;case"redeemPrizesProfile":default:break;}return b;},getPrizePoints:function(b){return b.prize_points+'<img src="'+Genesis.constants.getIconPath("miscicons","prize_points")+'">';}}),onItemDisclosure:Ext.emptyFn}),Ext.create("Ext.List",{xtype:"list",store:"VenueStore",tag:"venuesList",loadingText:null,refreshHeightOnUpdate:false,variableHeights:false,deferEmptyText:false,itemHeight:Genesis.fn.calcPx(Genesis.fn.calcPxEm(Genesis.constants.defaultIconSize(),2*0.65,1),1),cls:"venuesList",deferEmptyText:false,emptyText:" ",itemTpl:Ext.create("Ext.XTemplate",'<div class="merchantDetailsWrapper">','<div class="itemDistance">{[this.getDistance(values)]}</div><div class="itemTitle">{name}</div>','<div class="itemDesc">{[this.getAddress(values)]}</div>',"</div>",{getAddress:function(b){return(b.address+",<br/>"+b.city+", "+b.state+", "+b.country+",</br>"+b.zipcode);},getDistance:function(b){return b.distance.toFixed(1)+"km";}}),onItemDisclosure:Ext.emptyFn})]));}});Ext.define("Genesis.view.client.AccountsTransfer",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar","Ext.field.Text"],alias:"widget.clientaccountstransferview",config:{tag:"accountsTransferMain",cls:"viewport accountsTransferMain",layout:"card",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{tag:"navigationBarTop",cls:"navigationBarTop kbTitle",title:" ",items:[{align:"left",tag:"back",ui:"normal",text:"Back"},{align:"left",tag:"close",ui:"normal",text:"Close"},{align:"left",tag:"calcClose",hidden:true,ui:"normal",text:"Close"}]})]},disableAnimation:true,createView:function(b,a){if(!this.callParent(arguments)){return;}this.num=a;this.setPreRender(this.getPreRender().concat([Ext.create("Ext.Container",{xtype:"container",tag:"accountsTransferMode",cls:"accountsTransferMode",layout:"vbox",items:[{docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Select Options :"},{xtype:"spacer",align:"right"}]},{xtype:"list",deferEmptyText:false,flex:1,scrollable:undefined,cls:"transferPanel",data:[{text:"Transfer Out",desc:"(Send it directly over to your friend's mobile phone)",cls:"sender",tag:"sender"},{text:"Email Transfer",desc:"(Send it over to your friend's email account)",cls:"emailsender",tag:"emailsender"},{text:"Receive",desc:"(Scan your friend's Transfer Code)",cls:"recipient",tag:"recipient"}],itemTpl:Ext.create("Ext.XTemplate",'<div class="listItemDetailsWrapper" style="padding-right:0;">','<div class="itemTitle {[this.getCls(values)]}">{[this.getTitle(values)]}</div>','<div class="itemDesc {[this.getCls(values)]}">{[this.getDesc(values)]}</div>',"</div>",{getCls:function(c){return c.cls;},getDesc:function(c){return c.desc;},getTitle:function(c){return c.text;}})}]}),Ext.create("Ext.Container",{xtype:"container",tag:"accountsMainCalculator",cls:"accountsMainCalculator",layout:"fit",items:[{docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Points to Send"},{xtype:"spacer",align:"right"}]},{docked:"top",xtype:"textfield",name:"price",clearIcon:false,placeHolder:"0",readOnly:true,required:true,cls:"accountsCalculator"},{xtype:"container",layout:"vbox",tag:"dialpad",cls:"dialpad",defaults:{xtype:"container",layout:"hbox",flex:1,defaults:{xtype:"button",flex:1}},items:[{items:[{text:"1"},{text:"2"},{text:"3"}]},{items:[{text:"4"},{text:"5"},{text:"6"}]},{items:[{text:"7"},{text:"8"},{text:"9"}]},{items:[{text:"AC"},{flex:2,text:"0"}]}]},{docked:"bottom",xtype:"button",cls:"separator",tag:"showQrCode",text:"Transfer Points!",ui:"orange-large"}]}),Ext.create("Ext.Container",{xtype:"container",tag:"qrcodeContainer",cls:"qrcodeContainer",layout:"fit",items:[{docked:"top",xtype:"component",tag:"title",width:"100%",cls:"title",tpl:Ext.create("Ext.XTemplate","{[this.getPoints(values)]}",{getPoints:function(c){return c.points;}})},{xtype:"component",tag:"qrcode",cls:"qrcode"},{docked:"bottom",xtype:"button",cls:"separator done",tag:"done",text:"Done!",ui:"orange-large"}]})]));},showView:function(){if(this.num){this.setActiveItem(this.num);}this.callParent(arguments);},statics:{}});Ext.define("Genesis.view.client.UploadPhotosPage",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.DataView","Ext.XTemplate","Ext.form.Panel","Ext.field.TextArea"],alias:"widget.clientuploadphotospageview",scrollable:"vertical",config:{cls:"photoUploadPage",layout:"vbox",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Photo Upload",items:[{align:"right",tag:"post",text:"Post"}]}),{xtype:"textareafield",bottom:0,left:0,right:0,name:"desc",tag:"desc",cls:"desc",autoComplete:true,defaultUnit:"em",minHeight:"2",autoCorrect:true,autoCapitalize:true,maxLength:256,maxRows:4,placeHolder:"Please enter your photo description",clearIcon:false}]},showView:function(){this.callParent(arguments);console.debug("Rendering ["+this.metaData.photo_url+"]");this.query("container[tag=background]")[0].element.dom.style.cssText+="background-image:url("+this.metaData.photo_url+");";delete this.metaData;},createView:function(){if(!this.callParent(arguments)){return;}this.setPreRender(this.getPreRender().concat([photo=Ext.create("Ext.Container",{flex:1,width:"100%",xtype:"container",tag:"background",cls:"background"})]));}});Ext.define("Genesis.view.client.Referrals",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar","Ext.field.Text"],alias:"widget.clientreferralsview",config:{layout:"vbox",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Refer A Friend",items:[{align:"left",tag:"back",ui:"normal",text:"Back"}]})]},createView:function(){if(!this.callParent(arguments)){return;}this.getPreRender().push(Ext.create("Ext.Container",{xtype:"container",tag:"referralsMain",cls:"referralsMain",flex:1,layout:{type:"card",animation:{duration:600,easing:"ease-in-out",type:"slide",direction:"down"}},activeItem:0,defaults:{layout:"fit"},items:[{xtype:"container",tag:"referralsMode",cls:"referralsMode",layout:"vbox",items:[{docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Select Options :"},{xtype:"spacer",align:"right"}]},{xtype:"list",scrollable:false,cls:"referralsPanel",data:[{text:"Refer Now!",desc:"(Refer your friends by sending directly over to their phone)",cls:"sender",tag:"sender"},{text:"Refer by E-Mail",desc:"(Refer your friends by sending them an E-Mail)",cls:"emailsender",tag:"emailsender"},{text:"Receive Referrals",desc:"(Scan your friends' Referral Code to get bonus Reward Points!)",cls:"receiver",tag:"receiver"}],itemTpl:Ext.create("Ext.XTemplate",'<div class="listItemDetailsWrapper" style="padding-right:0;">','<div class="itemTitle {[this.getCls(values)]}">{[this.getTitle(values)]}</div>','<div class="itemDesc {[this.getCls(values)]}">{[this.getDesc(values)]}</div>',"</div>",{getCls:function(a){return a.cls;},getDesc:function(a){return a.desc;},getTitle:function(a){return a.text;}})}]},{xtype:"container",tag:"qrcodeContainer",cls:"qrcodeContainer",items:[{docked:"top",xtype:"component",tag:"title",width:"100%",cls:"subtitle",data:{title:"Referral Code"},tpl:"{title}"},{xtype:"component",tag:"qrcode",cls:"qrcode"},{docked:"bottom",xtype:"button",cls:"separator done",tag:"done",text:"Done!",ui:"orange-large"}]}]}));},statics:{}});Ext.define("Genesis.view.client.Rewards",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar"],alias:"widget.clientrewardsview",config:{layout:"fit",cls:"rouletteBg",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Scan and Play"}),{xtype:"component",tag:"prizeCheck",cls:"prizeCheck",data:{},tpl:'<div class="rouletteTable"></div><div class="rouletteBall"></div>',}]},statics:{getPhoto:function(a){var b=null;switch(a.value){case"vip":b=Genesis.constants.getIconPath("miscicons",a.value);break;default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.view.client.RedeemBase",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar","Genesis.view.widgets.RedeemPtsItemBase"],alias:"widget.clientredeeembaseview",config:{},disableAnimation:true,cleanView:function(){this.removeAll(true);this.callParent(arguments);},showView:function(){for(var a=0;a<this.getInnerItems().length;a++){this.getInnerItems()[a].setVisibility(true);}this.callParent(arguments);console.debug("RedeemBase : showView");},_createView:function(b,c,a){var d=this;d.setPreRender(d.getPreRender().concat([{cls:"ptsEarnPanel",tag:"ptsEarnPanel",xtype:"dataview",useComponents:true,scrollable:undefined,defaultType:d.getDefaultItemType(),store:c},{xtype:"list",flex:1,refreshHeightOnUpdate:false,variableHeights:false,itemHeight:Genesis.fn.calcPx(Genesis.fn.calcPxEm(Genesis.constants.defaultIconSize(),2*0.65,1),1),ui:"bottom-round",store:b,cls:d.getListCls()+" separator_pad",tag:d.getListCls(),itemTpl:Ext.create("Ext.XTemplate",'<div class="photo x-hasbadge"><span class="x-badge round">{[this.getPoints(values)]}</span>','<img src="{[this.getPhoto(values)]}"/></div>','<div class="listItemDetailsWrapper">','<div class="itemTitle">{[this.getTitle(values)]}</div>',"</div>",{getPhoto:function(e){if(!e.photo){return d.self.getPhoto(e.type);}return e.photo.url;},getTitle:function(e){return e.title;},getDesc:function(e){return"This will cost you "+e.points+" Pts";},getPoints:function(e){return e.points;}}),onItemDisclosure:Ext.emptyFn,items:[{docked:"top",xtype:"toolbar",cls:"ptsEarnPanelHdr",ui:"light",centered:false,items:[{xtype:"title",title:d.getRedeemTitleText()},{xtype:"spacer"}]}]}]));},statics:{}});Ext.define("Genesis.view.client.Redemptions",{extend:"Genesis.view.client.RedeemBase",requires:["Genesis.view.widgets.RewardPtsItem"],alias:"widget.clientredemptionsview",config:{defaultItemType:"rewardptsitem",redeemTitleText:"Rewards available to redeem (Select an item below)",ptsEarnTitleText:"Rewards Points Available",listCls:"redemptionsList",scrollable:undefined,cls:"redemptionsMain viewport",layout:"vbox",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Rewards",items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{hidden:true,align:"left",tag:"back",ui:"normal",text:"Back"}]})]},createView:function(a){if(!this.callParent(arguments)){return;}this._createView("RedeemStore","RedemptionRenderCStore",a);},statics:{getPhoto:function(a){var b=null;switch(a.value){default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.view.client.Prizes",{extend:"Genesis.view.client.RedeemBase",requires:["Genesis.view.widgets.PrizePtsItem"],alias:"widget.clientprizesview",config:{defaultItemType:"prizeptsitem",ptsEarnTitleText:"Prize Points Available",redeemTitleText:"Prizes available to redeem (Select an item below)",listCls:"prizesList",scrollable:undefined,cls:"prizesMain viewport",layout:"vbox",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Prizes",items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{hidden:true,align:"left",tag:"back",ui:"normal",text:"Back"}]})]},createView:function(a){if(!this.callParent(arguments)){return;}this._createView("PrizeStore","PrizeRenderCStore",a);},statics:{getPhoto:function(a){var b=null;switch(a.value){default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.view.client.JackpotWinners",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.plugin.ListPaging","Ext.plugin.PullRefresh"],alias:"widget.clientjackpotwinnersview",config:{cls:"jackpotWinnersMain viewport",layout:"fit",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Jackpot Winners",items:[{align:"left",tag:"close",ui:"normal",text:"Close"}]})]},cleanView:function(){this.removeAll(true);this.callParent(arguments);},createView:function(){var a=this;a.setPreRender(a.getPreRender().concat([Ext.create("Ext.dataview.List",{tag:"jackpotWinnersList",store:"JackpotWinnerStore",cls:"jackpotWinnersList",scrollable:"vertical",deferEmptyText:false,disableSelection:true,emptyText:" ",itemTpl:Ext.create("Ext.XTemplate",'<div class="photo">','<img src="{[this.getPhoto(values)]}"/>',"</div>",'<div class="listItemDetailsWrapper">','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">{[this.getDesc(values)]}</div>',"</div>",{getPhoto:function(b){return((b.facebook_id>0)?Genesis.fb.getFbProfilePhoto(b.facebook_id):Genesis.constants.getIconPath("miscicons","profile"));},getTitle:function(b){console.debug(b.name+" won "+b.points+" Points!");return(b.name+" won "+b.points+" Points!");},getDesc:function(b){return b.time;}}),plugins:[{type:"listpaging",autoPaging:true,loadMoreText:"",noMoreRecordsText:""},{type:"pullrefresh",refreshFn:function(b){_application.getController("client.JackpotWinners").fireEvent("reload");}}]})]));this.callParent(arguments);}});Ext.define("Genesis.controller.ControllerBase",{extend:"Ext.app.Controller",requires:["Ext.data.Store","Ext.util.Geolocation"],config:{animationMode:null,},checkinMsg:"Checking in ...",loadingScannerMsg:"Loading Scanner ...",loadingMsg:"Loading ...",genQRCodeMsg:"Generating QRCode ...",retrieveAuthModeMsg:"Retrieving Authorization Code from Server ...",noCodeScannedMsg:"No Authorization Code was Scanned!",geoLocationErrorMsg:function(){var a="Your current location is unavailable. ";if(Ext.os.is("Android")){a+='Enable Location Services under Main Screen of your phone: "Settings App >> Location Services >> GPS satellites"';}else{if(Ext.os.is("iPhone")){a+=((Ext.os.version.isLessThan("6.0"))?'Enable Location Services under Main Screen of your phone: "Settings App >> Location Services >> KICKBAK"':'Enable Location Services under Main Screen of your phone: "Settings App >> Privacy >> Location Services >> KICKBAK"');}else{a+='Enable Location Services under Main Screen of your phone: "Settings App >> Location Services"';}}return a;},geoLocationTimeoutErrorMsg:"Cannot locate your current location. Try again or enable permission to do so!",geoLocationPermissionErrorMsg:"No permission to location current location. Please enable permission to do so!",geoLocationUnavailableMsg:"We are not able to locate your GPS coordinates",geoLocationUseLastPositionMsg:"We are not able to locate your current location. Using your last known GPS Coordinates ...",getMerchantInfoMsg:"Retrieving Merchant Information ...",getVenueInfoMsg:"Retrieving Venue Information ...",missingVenueInfoMsg:"Error loading Venue information.",showToServerMsg:"Show this to your server before proceeding.",errProcQRCodeMsg:"Error Processing Authentication Code",cameraAccessMsg:"Accessing your Camera Phone ...",updatingServerMsg:"Updating Server ...",referredByFriendsMsg:function(a){return"Have you been referred "+Genesis.constants.addCRLF()+"by a friend to visit"+Genesis.constants.addCRLF()+a+"?";},recvReferralb4VisitMsg:function(a){return"Claim your reward points by becoming a customer at "+Genesis.constants.addCRLF()+a+"!";},showScreenTimeoutExpireMsg:function(a){return a+" are up! Press OK to confirm.";},showScreenTimeoutMsg:function(a){return"You have "+a+" to show this screen to a employee before it disappears!";},uploadFbMsg:"Uploading to Facebook ...",uploadServerMsg:"Uploading to server ...",statics:{animationMode:{cover:{type:"cover",direction:"left",duration:400},coverUp:{type:"cover",direction:"up",duration:400},slide:{type:"slide",direction:"left",duration:400},slideUp:{type:"slide",direction:"up",duration:400},pop:{type:"pop",duration:400},flip:{type:"flip",duration:400},fade:{type:"fade",duration:400}},playSoundFile:function(b,a,c){if(Genesis.constants.isNative()){switch(b.type){case"FX":case"Audio":LowLatencyAudio.play(b.name,a||Ext.emptyFn,c||Ext.emptyFn);break;case"Media":b.successCallback=a||Ext.emptyFn;b.name.play();break;}}else{b.successCallback=a||Ext.emptyFn;Ext.get(b.name).dom.play();}},stopSoundFile:function(a){if(Genesis.constants.isNative()){LowLatencyAudio.stop(a.name);}else{var b=Ext.get(a.name).dom;b.pause();b.currentTime=0;}},genQRCodeFromParams:function(c,d,h){var i=this;var f;GibberishAES.size(256);var j=Genesis.constants.getPrivKey();var b,a;for(key in j){switch(d){case"prize":a=key.split("r")[1];break;case"reward":case"challenge":a=key.split("v")[1];break;default:veuneId=0;break;}if(a>0){try{b=new Date().addHours(3);f=GibberishAES.enc(Ext.encode(Ext.applyIf({expiry_ts:b.getTime()},c)),j[key]);switch(d){case"prize":case"reward":f=a+"$"+f;break;default:break;}}catch(g){}console.debug("Used key["+j[key]+"]");break;}}console.log("\nEncrypted Code Length: "+f.length+"\nEncrypted Code ["+f+"]\nExpiry Date: ["+b+"]");return(h)?[f,0,0]:i.genQRCode(f);},genQRCode:function(e,c,f){c=c||3;f=f||10;var d=0;var b=QRCode(f,"L");b.addData(e);b.make();var a=b.createBase64(c,d);console.log("QR Code Minimum Size = ["+a[1]+"x"+a[1]+"]");return[a[0],a[1],a[1]];},genQRCodeInlineImg:function(e,c,f){c=c||4;f=f||8;var d=0;var a=QRCode(f,"L");a.addData(e);a.make();var b=a.createTableTag(c,d);return b;}},init:function(){this.callParent(arguments);this.on({scope:this,scannedqrcode:this.onScannedQRcode,locationupdate:this.onLocationUpdate,openpage:this.onOpenPage,updatemetadata:this.updateMetaDataInfo,triggerCallbacksChain:this.triggerCallbacksChain});var a=this.getViewPortCntlr();if(a!=this){a.relayEvents(this,["pushview","popview","silentpopview","resetview"]);a.on("animationCompleted",this.onAnimationCompleted,this);}},getViewPortCntlr:function(){return this.getApplication().getController("Viewport");},getViewport:function(){return this.getViewPortCntlr().getView();},getMainPage:Ext.emptyFn,openMainPage:Ext.emptyFn,openPage:Ext.emptyFn,goToMain:function(){var b=this;var a=b.getViewPortCntlr();a.setLoggedIn(true);b.resetView();b.redirectTo("main");console.log("LoggedIn, Going to Main Page ...");},isOpenAllowed:function(){return"Cannot Open Folder";},onScannedQRcode:Ext.emptyFn,onLocationUpdate:Ext.emptyFn,onOpenPage:function(d,b,a,c,e){if((appName=="GetKickBak")&&!Ext.device.Connection.isOnline()&&(d!="MainPage")){Ext.device.Notification.show({title:"Network Error",message:"You have lost internet connectivity"});me.resetView();me.redirectTo("login");return;}var f=this.getApplication();controller=f.getController(d);if(!b){controller.openMainPage();}else{controller.openPage(b,a);}},triggerCallbacksChain:function(){var c=this;var d=c.callBackStack.startIndex;var b=c.callBackStack.callbacks.length;for(var a=d;a<b;a++){c.callBackStack.startIndex++;if(c[c.callBackStack.callbacks[a]].apply(c,c.callBackStack["arguments"])){break;}}if(a>=b){console.debug("Clear Callback Chain["+a+"].");c.callBackStack.startIndex=0;c.callBackStack["arguments"]=[];}},updateBadges:function(a){var c=this;var b=Ext.StoreMgr.get("BadgeStore");if(a){b.setData(a);}},updateAccountInfo:function(a,b){var k=this;var f=false;var h=k.getViewPortCntlr();var o=Ext.StoreMgr.get("BadgeStore");var c=Ext.StoreMgr.get("CustomerStore");var g=h.getCustomer();var n=a.customer_id||((g)?g.getId():0);if(n>0){console.debug("updateAccountInfo - customerId["+n+"]");g=c.getById(n);if(g){g.beginEdit();if(b){if(Ext.isDefined(b.points)){g.set("points",b.points);}if(Ext.isDefined(b.prize_points)){g.set("prize_points",b.prize_points);}if(Ext.isDefined(b.visits)){g.set("visits",b.visits);}if(Ext.isDefined(b.next_badge_visits)){g.set("next_badge_visits",b.next_badge_visits);}var m=[{id:b.badge_id,prefix:"Customer's Current Badge is - [",badgeId:"badge_id"},{id:b.next_badge_id,prefix:"Customer's Next Badge is - [",badgeId:"next_badge_id"}];for(var e=0;e<m.length;e++){if(Ext.isDefined(m[e].id)){var j=o.getById(m[e].id);console.debug(m[e].prefix+j.get("type").display_value+"/"+j.get("visits")+"]");g.set(m[e].badgeId,m[e].id);}}var l=b.eligible_for_reward;if(Ext.isDefined(l)){g.set("eligible_for_reward",l);}var d=b.eligible_for_prize;if(Ext.isDefined(d)){g.set("eligible_for_prize",d);}}g.endEdit();k.persistSyncStores("CustomerStore");}}return g;},updateRewards:function(f){if(f&&(f.length>0)){var d=this;var b=d.getViewPortCntlr();var e=b.getVenue().getMerchant();console.debug("Total Redemption Rewards - "+f.length);for(var c=0;c<f.length;c++){f[c]["merchant"]=e;}var a=Ext.StoreMgr.get("RedeemStore");a.setData(f);}},updatePrizes:function(b){if(b&&(b.length>0)){var e=this;var a=e.getViewPortCntlr();var f=a.getVenue().getMerchant();console.debug("Total Redemption Prizes - "+b.length);for(var d=0;d<b.length;d++){b[d]["merchant"]=f;}var c=Ext.StoreMgr.get("PrizeStore");c.setData(b);}},updateNews:function(b){if(b&&(b.length>0)){console.debug("Total News Items - "+b.length);var a=Ext.StoreMgr.get("NewsStore");a.setData(b);}},updateAuthCode:function(b,e){var c=this,d=false;if(b){var a=Genesis.db.getLocalDB();if((b!=a.auth_code)||(e!=a.csrf_code)){a.auth_code=b;a.csrf_code=e;Genesis.db.setLocalDB(a);}console.debug("\nauth_code ["+b+"]\ncsrf_code ["+e+"]\ncurrFbId ["+a.currFbId+"]");if(!a.last_check_in){c.redirectTo("checkin");}d=true;}return d;},updateMetaDataInfo:function(b){var j=this;var h=null;var i=j.getViewPortCntlr();var f=Ext.StoreMgr.get("CheckinExploreStore");try{if(j.updateAuthCode(b.auth_token,b.csrf_token)){return;}j.updateBadges(b.badges);h=j.updateAccountInfo(b,b.account_info);var c=b.venue_id||((f.first())?f.first().getId():0);venue=f.getById(c)||i.getVenue();if(Ext.isDefined(b.venue)){venue=Ext.create("Genesis.model.Venue",b.venue);var d=j.getApplication().getController("client.Checkins");var a=b.prize_jackpots;if(a>=0){console.debug("Prize Jackpots won by customers at this merchant this month - ["+a+"]");venue.set("prize_jackpots",a);}console.debug("customer_id - "+h.getId()+"\nmerchant_id - "+venue.getMerchant().getId()+"\n");d.fireEvent("setupCheckinInfo","checkin",venue,h,b);}else{var a=b.prize_jackpots;if(a>=0){console.debug("Prize Jackpots won by customers at this merchant this month - ["+a+"]");venue.set("prize_jackpots",a);}}j.updateRewards(b.rewards);j.updatePrizes(b.prizes);j.updateNews(b.newsfeed);}catch(g){console.debug("updateMetaDataInfo Exception - "+g);}return h;},checkReferralPrompt:function(a,d){var g=this;var f=g.getViewPortCntlr();var e=f.getCustomer();var b=f.getVenue().getMerchant();var h=b.getId();var j=a||Ext.emptyFn;var c=d||Ext.emptyFn;var i=function(k){Ext.defer(function(){if(k.toLowerCase()=="yes"){g.fireEvent("openpage","client.Challenges","referrals",j);}else{c();}},1,g);};if((!Customer.isValid(e.getId())||(e.get("visits")<=0))&&(!Genesis.db.getReferralDBAttrib("m"+h))){console.debug("Customer Visit Count["+e.get("visits")+"]");Ext.device.Notification.show({title:"Referral Challenge",message:g.referredByFriendsMsg(b.get("name")),buttons:["Yes","No"],callback:i});}else{c();}},persistStore:function(b){var a={CustomerStore:[Ext.StoreMgr.get("PersistentCustomerStore"),"CustomerStore","CustomerJSON"]};for(var c in a){if(!a[c][0]){Ext.regStore("Persistent"+a[c][1],{model:"Genesis.model."+a[c][2],autoLoad:false});a[c][0]=Ext.StoreMgr.get("Persistent"+a[c][1]);}}return a[b][0];},persistLoadStores:function(d){var b=[[this.persistStore("CustomerStore"),"CustomerStore",1]];var a=0;d=d||Ext.emptyFn;for(var c=0;c<b.length;c++){b[c][0].load({callback:function(i,g){var f=[];if(g.wasSuccessful()){var h=Ext.StoreMgr.get(b[c][1]);h.removeAll();for(var e=0;e<i.length;e++){f.push(i[e].get("json"));}h.setData(f);console.debug("Restored "+i.length+" records to "+b[c][1]+" ...");}else{console.debug("Error Restoring "+b[c][1]+" ...");}d();}});}},persistSyncStores:function(d,g){var b=[[this.persistStore("CustomerStore"),"CustomerStore",1]];for(var f=0;f<b.length;f++){if(!d||(b[f][1]==d)){b[f][0].removeAll();if(!g){var c=Ext.StoreMgr.get(b[f][1]).getRange();for(var a=0;a<c.length;a++){var e=c[a].getData(true);b[f][0].add({json:e});}}b[f][0].sync();console.debug("Synced "+b[f][1]+" ... ");}}},resetView:function(a){this.fireEvent("resetview");},pushView:function(a){this.fireEvent("pushview",a,this.getAnimationMode());},silentPopView:function(a){this.fireEvent("silentpopview",a);},popView:function(){this.fireEvent("popview");},getGeoLocation:function(d){var e=this;var b=e.getViewPortCntlr();var c={autoUpdate:false,maximumAge:30000,timeout:10000,allowHighAccuracy:true,enableHighAccuracy:true};d=d||0;console.debug("Getting GeoLocation ...");if(!Genesis.constants.isNative()){e.fireEvent("locationupdate",{coords:{getLatitude:function(){return"-50.000000";},getLongitude:function(){return"50.000000";}}});return;}var a=function(i,h){if(!i){console.log("No GeoLocation found!");return;}var g={coords:i};console.debug("\nLatitude: "+i.getLatitude()+"\nLongitude: "+i.getLongitude()+"\nAltitude: "+i.getAltitude()+"\nAccuracy: "+i.getAccuracy()+"\nAltitude Accuracy: "+i.getAltitudeAccuracy()+"\nHeading: "+i.getHeading()+"\nSpeed: "+i.getSpeed()+"\nTimestamp: "+new Date(i.getTimestamp())+"\n");b.setLastPosition(g);e.fireEvent("locationupdate",g);};var f=function(k,g,h,j,i){console.debug("GeoLocation Error["+i+"]");Ext.Viewport.setMasked(false);if(h){console.debug("PERMISSION_DENIED");Ext.device.Notification.show({title:"Permission Error",message:e.geoLocationPermissionErrorMsg});}else{if(g){console.debug("TIMEOUT");Ext.device.Notification.show({title:"Timeout Error",message:(b.getLastPosition())?e.geoLocationUseLastPositionMsg:e.geoLocationTimeoutErrorMsg,callback:function(){if(b.getLastPosition()){e.fireEvent("locationupdate",b.getLastPosition());}}});}else{if(j){if(d<3){Ext.defer(e.getGeoLocation,1*1000,e,[++d]);}else{console.debug("POSITION_UNAVAILABLE");Ext.device.Notification.show({title:"Location Services",message:(b.getLastPosition())?e.geoLocationUseLastPositionMsg:e.geoLocationUnavailableMsg,callback:function(){if(b.getLastPosition()){e.fireEvent("locationupdate",b.getLastPosition());}}});}}else{console.debug("PERMISSION ERROR");Ext.device.Notification.show({title:"Location Services",message:e.geoLocationErrorMsg()});}}}};console.debug("Connection type: ["+Ext.device.Connection.getType()+"]");if(!e.geoLocation){e.geoLocation=Ext.create("Ext.util.Geolocation",Ext.applyIf({listeners:{locationupdate:a,locationerror:function(k,g,h,j,i){if(g&&(d<4)){e.getGeoLocation(4);}else{f(k,g,h,j,i);}}}},c));}e.geoLocation.updateLocation(null,null,(d>=4)?Ext.applyIf({allowHighAccuracy:false,enableHighAccuracy:false},c):c);},scanQRCode:function(){var b=this;var e=function(f){var g;Ext.Viewport.setMasked(false);if(Genesis.constants.isNative()){switch(window.plugins.qrCodeReader.scanType){case"RL":g=(f.response==undefined)?"":(f.response||"");console.debug("QR Code RL  = "+g);break;case"Nigma":g=(f.response==undefined)?"":(f.response||"");if(!g){console.debug("QR Code Nigma = Empty");}else{console.debug("QR Code Nigma = "+((g.responseCode)?g.responseCode:"NONE")+" Sent = "+g.bytesSent+" bytes");}if(g&&g.responseCode){g=g.responseCode;}break;case"Default":g=f;if(!g||g.format!="QR_CODE"){g=null;console.debug("QR Code Default = Unsupported Code");if(device.platform.match(/simulator/i)){g=Math.random().toFixed(16);}}else{if(g.cancelled){g=Math.random().toFixed(16);}else{g=g.text;}}console.debug("QR Code Default = "+((g)?g:"NONE"));break;}}else{g=f.response;console.debug("QR Code = "+g);}Ext.device.Notification.beep();b.fireEvent("scannedqrcode",g);};var a=function(f){Ext.Viewport.setMasked(false);console.debug("Failed because: "+f);Ext.device.Notification.beep();b.fireEvent("scannedqrcode",null);};console.debug("Scanning QR Code ...");if(!Genesis.constants.isNative()){var d="0";if(!merchantMode){var c=b.getViewPortCntlr().getVenue()||Ext.StoreMgr.get("CheckinExploreStore").first()||null;d=c?c.getId():"0";}e({response:d});}else{Ext.Viewport.setMasked({xtype:"loadmask",message:b.loadingScannerMsg});window.plugins.qrCodeReader.getCode(e,a);}}});Ext.define("Genesis.controller.Viewport",{extend:"Genesis.controller.ControllerBase",requires:["Ext.util.DelayedTask"],statics:{},config:{sound_files:null,loggedIn:false,customer:null,venue:null,metaData:null,checkinInfo:{venue:null,customer:null,metaData:null},lastPosition:null,refs:{view:"viewportview",backButton:"button[tag=back]",closeButton:"button[tag=close]",shareBtn:"button[tag=shareBtn]",emailShareBtn:"actionsheet button[tag=emailShareBtn]",fbShareBtn:"actionsheet button[tag=fbShareBtn]",checkInNowBtn:"button[tag=checkInNow]"},control:{fbShareBtn:{tap:"onShareMerchantTap"},emailShareBtn:{tap:"onShareEmailTap"},backButton:{tap:"onBackButtonTap"},closeButton:{tap:"onBackButtonTap"},checkInNowBtn:{tap:"onCheckinScanTap"},"tabbar[tag=navigationBarTop] button[tag=info]":{tap:"onInfoTap"},"viewportview button[tag=home]":{tap:"onHomeButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=prizes]":{tap:"onPrizesButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=prizesSC]":{tap:"onRedeemPrizesSCButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=accounts]":{tap:"onAccountsButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=challenges]":{tap:"onChallengesButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=rewards]":{tap:"onRewardsButtonTap"},"viewportview button[tag=rewardsSC]":{tap:"onRewardsSCButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=redemption]":{tap:"onRedemptionsButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=redemptionSC]":{tap:"onRedeemRewardsSCButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=main]":{tap:"onCheckedInAccountTap"},"tabbar[tag=navigationBarBottom] button[tag=checkin]":{tap:"onCheckinTap"},"tabbar[tag=navigationBarBottom] button[tag=browse]":{tap:"onBrowseTap"},view:{activate:"onActivate"},"viewportview dataview[tag=mainMenuSelections]":{select:"onButtonTap"},"viewportview dataview[tag=badgesMenuSelections]":{select:"onButtonTap"},"viewportview dataview[tag=challengeMenuSelections]":{select:"onButtonTap"},"viewportview list[tag=jackpotWinnersList]":{select:"onButtonTap"},"viewportview button":{tap:"onButtonTap"},"actionsheet button":{tap:"onButtonTap"}},listeners:{viewanimend:"onViewAnimEnd",baranimend:{buffer:0.5*1000,fn:"onBarAnimEnd"},pushview:"pushView",silentpopview:"silentPopView",popview:"popView",resetview:"resetView"}},popViewInProgress:false,viewStack:[],animationFlag:0,gatherCheckinInfoMsg:"Gathering Checkin information ...",retrieveChallengesMsg:"Retrieving Challenges ...",fbShareSuccessMsg:"Posted on your Facebook Timeline!",shareReqMsg:function(){return"Would you like to do our"+Genesis.constants.addCRLF()+"Referral Challenge?";},onLocationUpdate:function(a){var d=this;var f=d.getApplication();var b=f.getController("client.Checkins");var e=Ext.StoreMgr.get("CheckinExploreStore");var c=e.getProxy();Venue.setFindNearestURL();e.load({params:{latitude:a.coords.getLatitude(),longitude:a.coords.getLongitude()},callback:function(h,g){if(g.wasSuccessful()){b.setPosition(a);b.fireEvent("checkinScan");}else{c.supressErrorsPopup=true;Ext.device.Notification.show({title:"Error",message:d.missingVenueInfoMsg,callback:function(){c.supressErrorsPopup=false;}});}},scope:d});},onActivate:function(){console.log("Loading MainPage Store ...");if(Genesis.constants.isNative()){var a="app/store/"+((!merchantMode)?"mainClientPage.json":"mainServerPage.json"),c="";if(Ext.os.is("iPhone")){}else{if(Ext.os.is("Android")){c="file:///android_asset/www/";}}var b=new XMLHttpRequest();b.open("GET",c+a,true);b.onreadystatechange=function(){if(b.readyState==4){if(b.status==200||b.status==0){Ext.StoreMgr.get("MainPageStore").setData(Ext.decode(b.responseText).data);}}};b.send();}else{Ext.StoreMgr.get("MainPageStore").load();}},onButtonTap:function(a,d,c){Genesis.controller.ControllerBase.playSoundFile(this.sound_files.clickSound);},onBackButtonTap:function(a,d,c){this.popView();},onShareEmailTap:function(a,g,c,f){var d=this;Ext.device.Notification.show({title:"Referral Challenge",message:d.shareReqMsg(),buttons:["Yes","No"],callback:function(b){if(b.toLowerCase()=="yes"){var e=d.getApplication();d.onChallengesButtonTap(null,null,null,null,function(){var m=d.getViewPortCntlr().getVenue();var l=m.getId();var j=m.challenges().getRange();var h=e.getController("client.Challenges");for(var k=0;k<j.length;k++){if(j[k].get("type").value=="referral"){h.selectedItem=j[k];break;}}h.fireEvent("doChallenge");});}}});},onShareMerchantTap:function(a,h,d,g){var f=this;var c=Genesis.constants.site;Genesis.fb.facebook_onLogin(function(i){var e=f.getVenue();var b=e.getMerchant();console.log("Posting to Facebook ...");FB.api("/me/feed","post",{name:e.get("name"),link:e.get("website")||c,caption:e.get("website")||c,description:e.get("description"),picture:b.get("photo")["thumbnail_ios_medium"].url,message:"Check out this place!"},function(j){Ext.Viewport.setMasked(false);if(!j||j.error){console.log("Post was not published to Facebook.");}else{console.log(f.fbShareSuccessMsg);Ext.device.Notification.show({title:"Facebook Connect",message:f.fbShareSuccessMsg});}});},true);},onInfoTap:function(a,f,c,d){},onCheckinScanTap:function(a,f,c,g){var d=this;Ext.Viewport.setMasked({xtype:"loadmask",message:d.gatherCheckinInfoMsg});d.getGeoLocation();},onAccountsButtonTap:function(a,f,c,d){this.redirect("accounts");console.log("Going to Accounts Page ...");},onChallengesButtonTap:function(a,h,d,g,j){var f=this;var i=f.getVenue();var c=function(){if(j){j();}else{f.redirectTo("challenges");console.log("Going to Challenges Page ...");}};if(i.challenges().getData().length==0){Ext.Viewport.setMasked({xtype:"loadmask",message:f.retrieveChallengesMsg});Challenge.setGetChallengesURL();Challenge.load(i.getId(),{params:{merchant_id:i.getMerchant().getId(),venue_id:i.getId()},callback:function(b,e){Ext.Viewport.setMasked(false);if(e.wasSuccessful()){i.challenges().add(e.getRecords());c();}}});}else{c();}},onRewardsButtonTap:function(a,f,c,d){this.fireEvent("openpage","client.Rewards","rewards",null);console.log("Going to Client Rewards Page ...");},onRewardsSCButtonTap:function(a,f,c,d){this.fireEvent("openpage","client.Rewards","rewardsSC",null);console.log("Going to Client Rewards Shortcut Page ...");},onRedemptionsButtonTap:function(a,f,c,d){this.redirectTo("redemptions");console.log("Going to Client Redemptions Page ...");},onRedeemRewardsSCButtonTap:function(a,f,c,d){this.redirectTo("redeemRewardsChooseSC");console.log("Going to Client Redeem Rewards Choose Page ...");},onPrizesButtonTap:function(a,f,c,d){this.redirectTo("prizes");console.log("Going to Merchant Prizes Page ...");},onRedeemPrizesSCButtonTap:function(a,f,c,d){this.redirectTo("redeemPrizesChooseSC");console.log("Going to Client Redeem Prizes Choose Page ...");},onHomeButtonTap:function(a,f,c,d){this.resetView();this.redirectTo("main");console.log("Going back to HomePage ...");},onCheckedInAccountTap:function(a,g,c,d){var f=this.getViewPortCntlr().getCheckinInfo();this.redirectTo("venue/"+f.venue.getId()+"/"+f.customer.getId()+"/1");},onBrowseTap:function(a,f,c,d){this.redirectTo("exploreS");},onCheckinTap:function(a,f,c,d){this.redirectTo("checkin");},resetView:function(){var b=this;var a=b.getViewport();b.viewStack=[];b.getApplication().getHistory().setActions([]);},pushView:function(b,d){var c=this;d=Ext.apply(d,{reverse:false});var a=(c.viewStack.length>1)?c.viewStack[c.viewStack.length-2]:null;if((c.viewStack.length>0)&&(b==c.viewStack[c.viewStack.length-1]["view"])){}else{if(a&&(a.view==b)){c.popView();}else{var e=c.getApplication().getHistory().getActions();c.viewStack.push({view:b,animation:d,url:e[e.length-1].getUrl()});c.getViewport().animateActiveItem(b,d);}}},silentPopView:function(b){var c=this;b=Math.min(c.viewStack.length,b);var d=c.getApplication().getHistory().getActions();if((c.viewStack.length>0)&&(b>0)){while(b-->0){var a=c.viewStack.pop();d.pop();}}},popView:function(){var c=this;var d=c.getApplication().getHistory().getActions();if(c.viewStack.length>1){var a=c.viewStack.pop();var b=c.viewStack[c.viewStack.length-1];if(!c.popViewInProgress){c.popViewInProgress=true;d.pop();if(b.view.isDestroyed){b.view=Ext.create(b.view.alias[0]);}c.getApplication().getHistory().setToken(b.url);window.location.hash=b.url;c.getViewport().animateActiveItem(b.view,Ext.apply(a.animation,{reverse:true}));}}else{c.redirectTo("checkin");}},init:function(b){var a=this;console.log("Viewport Init");a.callParent(arguments);if(merchantMode){console.log("Loading License Keys ...");Genesis.constants.getPrivKey();}QRCodeReader.prototype.scanType="Default";console.debug("QRCode Scanner Mode["+QRCodeReader.prototype.scanType+"]");if(!merchantMode){Genesis.fb.initFb();}if(Ext.isDefined(window.device)){console.debug("\ndevice.platform - "+device.platform+"\nBrowser EngineVersion - "+Ext.browser.engineVersion+"");}Ext.defer(function(){this.sound_files={};var c;if(merchantMode){c=[["clickSound","click_sound","FX"],["beepSound","beep.wav","FX"]];}else{c=[["rouletteSpinSound","roulette_spin_sound","Media"],["winPrizeSound","win_prize_sound","Media"],["losePrizeSound","lose_prize_sound","Media"],["promoteSound","promote_sound","FX"],["clickSound","click_sound","FX"],["beepSound","beep.wav","FX"]];}for(var d=0;d<c.length;d++){this.loadSoundFile.apply(this,c[d]);}},1,a);},loadSoundFile:function(a,b,d){var f=this;var c="."+(b.split(".")[1]||"mp3");b=b.split(".")[0];if(Genesis.constants.isNative()){var g=function(){switch(d){case"FX":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,function(){console.debug("loaded "+b);},function(h){console.debug("Audio Error: "+h);});break;case"Audio":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,3,function(){console.debug("loaded "+b);},function(h){console.debug("Audio Error: "+h);});break;}};switch(d){case"Media":b=new Media((Ext.os.is("Android")?"/android_asset/www/":"")+"resources/audio/"+b+c,function(){f.sound_files[a].successCallback();},function(h){f.sound_files[a].successCallback();console.log("Audio Error: "+h);});break;default:LowLatencyAudio.unload(b,g,g);break;}}else{var e=Ext.get(b);if(e){e.dom.addEventListener("ended",function(){f.sound_files[a].successCallback();},false);}}f.sound_files[a]={name:b,type:d};},openMainPage:function(){var c=this;var b=Genesis.db.getLocalDB();var a=(b.auth_code)?true:false;if(!merchantMode){c.resetView();if(a){c.setLoggedIn(a);console.debug("Going to SignIn Page ...");c.redirectTo("signIn");}else{console.debug("Going to Login Page ...");Genesis.db.resetStorage();c.redirectTo("login");}}}});Ext.define("Genesis.controller.Settings",{extend:"Genesis.controller.ControllerBase",statics:{},xtype:"settingsCntlr",config:{termsOfServiceTitle:"Term of Service",privacyTitle:"Privacy",aboutUsTitle:"About Us",licenseTitle:"Refresh License Key",routes:{clientSettings:"clientSettingsPage",serverSettings:"serverSettingsPage",aboutus:"documentPage",privacy:"documentPage",termsOfUse:"multipartDocumentPage"},refs:{clientSettingsPage:{selector:"clientsettingspageview",autoCreate:true,xtype:"clientsettingspageview"},serverSettingsPage:{selector:"serversettingspageview",autoCreate:true,xtype:"serversettingspageview"},documentPage:{selector:"documentview",autoCreate:true,xtype:"documentview"},multipartDocumentPage:{selector:"multipartdocumentview",autoCreate:true,xtype:"multipartdocumentview"},merchantDevice:"serversettingspageview fieldset textfield[tag=merchantDevice]"},control:{}},termsLoaded:false,privacyLoaded:false,aboutUsLoaded:false,fbLoggedInIdentityMsg:function(a){return"You're logged into Facebook as "+Genesis.constants.addCRLF()+a;},proceedToUpdateLicenseMsg:"Please confirm to proceed with License Update",updatingFbLoginMsg:"Updating Facebok Login Credentials",licenseKeySuccessMsg:function(){return"License Key Updated for "+Genesis.constants.addCRLF()+"["+Genesis.constants.privKey.venue+"]";},init:function(){this.callParent(arguments);if(!merchantMode){this.initClientControl();}else{this.initServerControl();}console.log("Settings Init");},initClientControl:function(){this.control({"clientsettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"clientsettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"clientsettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"},"clientsettingspageview togglefield[name=facebook]":{change:"onFacebookChange"},"clientsettingspageview listfield[name=changepassword]":{clearicontap:"onPasswordChangeTap"}});this.getMultipartDocumentPage();this.getDocumentPage();this.on({scope:this,facebookToggle:{fn:this.onFacebookToggle,buffer:5000}});},initServerControl:function(){this.control({"serversettingspageview listfield[name=license]":{clearicontap:"onRefreshLicenseTap"},"serversettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"serversettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"serversettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"},serverSettingsPage:{activate:"onServerActivate"}});},updateLicenseKey:function(a){Genesis.fn.writeFile("resources/keys.txt",Ext.encode(a),function(b){console.debug("Content Written to Disk");Genesis.constants.privKey=a;Ext.device.Notification.show({title:"License Key Updated!",message:me.licenseKeySuccessMsg()});});},onFacebookToggle:function(a,d){var c=this;var b=Genesis.db.getLocalDB();if(d==1){Genesis.fb.facebook_onLogin(function(g,f){if(!f||f.wasSuccessful()){a.originalValue=d;Ext.device.Notification.show({title:"Facebook Connect",message:c.fbLoggedInIdentityMsg(g.email)});}else{if(c.getClientSettingsPage().isVisible()){a.toggle();}}},true);}else{if(b.enableFB!=a.originalValue){console.debug("Cancelling Facebook Login ...");var e={facebook_id:0};Account.setUpdateFbLoginUrl();Account.load(0,{jsonData:{},params:{user:Ext.encode(e)},callback:function(f,g){if(g.wasSuccessful()){a.originalValue=0;b=Genesis.db.getLocalDB();b.enableFB=false;b.currFbId=0;delete b.fbAccountId;delete b.fbResponse;Genesis.db.setLocalDB(b);Genesis.fb.facebook_onLogout(null,true);}else{if(c.getClientSettingsPage().isVisible()){a.toggle();}}}});}}},onFacebookChange:function(b,g,c,h,d,e){var f=this;var a=f.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);this.fireEvent("facebookToggle",b,h);},onRefreshLicenseTap:function(a,d){var c=this;Ext.device.Notification.show({title:"Confirmation Required",message:c.proceedToUpdateLicenseMsg,buttons:["Proceed","Cancel"],callback:function(b){if(b.toLowerCase()=="proceed"){c.scanQRCode();}}});},onTermsTap:function(c,j){var g=this,f=0;var a=g.getViewPortCntlr();var i=[];var h=g.getMultipartDocumentPage();h.query("title")[0].setTitle(g.getTermsOfServiceTitle());Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);if(!g.termsLoaded){var d=function(){for(var b=0;b<i.length;b++){h.setHtml(b,i[b].cardConfig);}g.redirectTo("termsOfUse");g.termsLoaded=true;};Ext.Ajax.request({async:true,disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../term_of_service.htm",callback:function(e,k,b){if(k){i[0]=b;b.cardConfig={title:"Terms of Use",html:b.responseText};if((f|=1)==17){d();}}else{console.debug("Error Loading Term of Service Document.");console.debug("Status code "+b.status);}}});Ext.Ajax.request({async:true,disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../program_rules.htm",callback:function(e,k,b){if(k){i[1]=b;b.cardConfig={title:"Program Rules",html:b.responseText};if((f|=16)==17){d();}}else{console.debug("Error Loading Program Rules Document.");console.debug("Status code "+b.status);}}});}else{g.redirectTo("termsOfUse");}},onPrivacyTap:function(c,g){var d=this;var a=d.getViewPortCntlr();var f=d.getDocumentPage();f.query("title")[0].setTitle(d.getPrivacyTitle());Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);if(!d.privacyLoaded){Ext.Ajax.request({disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../privacy.htm",callback:function(e,h,b){if(h){f.setHtml(b.responseText);d.redirectTo("privacy");d.privacyLoaded=true;}else{console.debug("Error Loading Privacy Document.");console.debug("Status code "+b.status);}}});}else{d.redirectTo("privacy");}},onAboutUsTap:function(c,g){var d=this;var a=d.getViewPortCntlr();var f=d.getDocumentPage();f.query("title")[0].setTitle(d.getAboutUsTitle());Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);if(d.aboutUsLoaded){Ext.Ajax.request({disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../about_us.htm",callback:function(e,h,b){if(h){f.setHtml(b.responseText);d.redirectTo("aboutUs");d.aboutUsLoaded=true;}else{console.debug("Error Loading About US Document.");console.debug("Status code "+b.status);}}});}else{d.redirectTo("aboutUs");}},onPasswordChangeTap:function(c,f){var d=this;var a=d.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);d.redirectTo("password_change");},onScannedQRcode:function(c){var b=this;var a=b.getViewport();if(c){console.debug("Programming License Key into Merchant Device ...");Venue.setGetLicenseKeyURL();Venue.load(0,{jsonData:{},params:{update_token:c,deviceId:(Genesis.constants.isNative())?device.uuid:null,},callback:function(e,f){var d=Venue.getProxy().getReader().metaData;Ext.Viewport.setMasked(false);if(f.wasSuccessful()){b.updateLicenseKey(d);}}});}else{console.debug(b.noCodeScannedMsg);Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:b.noCodeScannedMsg});}},onServerActivate:function(d,e,a,b){this.getMerchantDevice().setValue(Genesis.constants.getPrivKey()["venue"]);},clientSettingsPage:function(){var d=this;var b=Genesis.db.getLocalDB()["enableFB"];var c=d.getClientSettingsPage();console.log("enableFB - "+b);var a=c.query("togglefield[name=facebook]")[0];a.originalValue=b;c.setValues({facebook:(b)?1:0});d.openPage("client");},serverSettingsPage:function(){this.openPage("server");},multipartDocumentPage:function(){this.openPage("multipartDocument");},documentPage:function(){this.openPage("document");},openPage:function(a){var b=this,c;switch(a){case"multipartDocument":c=b.getMultipartDocumentPage();b.setAnimationMode(b.self.superclass.self.animationMode.slide);break;case"document":c=b.getDocumentPage();b.setAnimationMode(b.self.superclass.self.animationMode.slide);break;case"client":c=b.getClientSettingsPage();b.setAnimationMode(b.self.superclass.self.animationMode.cover);break;case"server":c=b.getServerSettingsPage();b.setAnimationMode(b.self.superclass.self.animationMode.cover);break;}b.pushView(c);},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.MainPage",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{},xtype:"mainPageCntlr",config:{csrfTokenRecv:false,models:["frontend.MainPage","frontend.Signin","frontend.Account","Customer","User","Merchant","CustomerReward"],routes:{"":"openPage",main:"mainPage",login:"loginPage",merchant:"merchantPage",signin:"signInPage",password_reset:"signInResetPage",password_change:"signInChangePage",createAccount:"createAccountPage",},refs:{login:{selector:"loginpageview",autoCreate:true,xtype:"loginpageview"},signin:{selector:"signinpageview",autoCreate:true,xtype:"signinpageview"},passwdReset:{selector:"passwdresetpageview",autoCreate:true,xtype:"passwdresetpageview"},passwdChange:{selector:"passwdchangepageview",autoCreate:true,xtype:"passwdchangepageview"},createAccount:{selector:"createaccountpageview",autoCreate:true,xtype:"createaccountpageview"},main:{selector:"mainpageview",autoCreate:true,xtype:"mainpageview"},mainCarousel:"mainpageview",shortcutTabBar:"mainpageview tabbar[tag=navigationBarBottom]",infoBtn:"button[tag=info]",prizesBtn:"mainpageview tabbar[tag=navigationBarBottom] button[tag=prizesSC]"},control:{login:{activate:"onLoginActivate",deactivate:"onLoginDeactivate"},"actionsheet button[tag=facebook]":{tap:"onFacebookTap"},"actionsheet button[tag=createAccount]":{tap:"onCreateAccountTap"},"actionsheet button[tag=signIn]":{tap:"onSignInTap"},"signinpageview button[tag=login]":{tap:"onSignInSubmit"},"signinpageview button[tag=reset]":{tap:"onSignInResetSubmit"},"passwdresetpageview button[tag=submit]":{tap:"onPasswdResetSubmit"},"passwdchangepageview button[tag=submit]":{tap:"onPasswdChangeSubmit"},"actionsheet button[tag=logout]":{tap:"onLogoutTap"},main:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},shortcutTabBar:{tabchange:"onTabBarTabChange"},createAccount:{activate:"onCreateActivate",deactivate:"onCreateDeactivate"},"createaccountpageview button[tag=createAccount]":{tap:"onCreateAccountSubmit"}},listeners:{refreshCSRF:"onRefreshCSRF",itemTap:"onItemTap"}},sessionTimeoutMsg:"Session Timeout",passwdResetConfirmMsg:"Please confirm to reset your account password",passwdResetSuccessMsg:function(){return("Password Reset was Successful."+Genesis.constants.addCRLF()+"Please check your email account for instructions.");},passwdChangeSuccessMsg:"Password Change was Successful.",signInFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please Try Again";},passwdResetFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please fix the errors";},passwdChangeFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please retype the passwords";},loginWithFbMsg:function(a){return"Logging in ...";},init:function(b){var a=this;a.callParent(arguments);Genesis.db.removeLocalDBAttrib("csrf_code");var c=function(){if(merchantMode){a.goToMain();}else{var d=Genesis.db.getLocalDB();if(d.auth_code){a.fireEvent("refreshCSRF");}else{a.resetView();a.redirectTo("login");}}};Ext.regStore("MainPageStore",{model:"Genesis.model.frontend.MainPage",autoLoad:false,listeners:{scope:a,refresh:c}});if(!merchantMode){Ext.regStore("UserStore",{model:"Genesis.model.User",autoLoad:false});a.initCustomerStore();a.initVenueStore();}console.log("MainPage Init");a.getMain();backBtnCallbackListFn.push(function(f){var e=((f==a.getMain())||((merchantMode)?false:(f==a.getLogin())));if(e){var d=a.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(d.sound_files.clickSound);navigator.app.exitApp();return true;}return false;});},initCustomerStore:function(){var a=this;Ext.regStore("CustomerStore",{model:"Genesis.model.Customer",autoLoad:false,pageSize:1000,listeners:{scope:a,load:function(d,c,f,b,e){},metachange:function(d,f,e){var c=f.getReader().metaData;var g=c.data;if(g){var h=a.getApplication();var b=h.getController("client.Accounts");b.callBackStack["arguments"]=[c];b.fireEvent("triggerCallbacksChain");}}},grouper:{groupFn:function(b){return b.getMerchant().get("name");}},filters:[{filterFn:function(b){return Customer.isValid(b.getId());}}],sorters:[{sorterFn:function(d,b){var e=d.getMerchant().get("name"),c=b.getMerchant().get("name");if(e<c){return -1;}if(e>c){return 1;}return 0;}}]});},initVenueStore:function(){var a=this;Ext.regStore("VenueStore",{model:"Genesis.model.Venue",autoLoad:false,sorters:[{property:"distance",direction:"ASC"}],listeners:{metachange:function(b,d,c){if(b.isLoading()){a.fireEvent("updatemetadata",d.getReader().metaData);}}}});},onLocationUpdate:function(g){var m=this;var l=m.getViewPortCntlr();var j=g.coords.getLatitude();var h=g.coords.getLongitude();var n=Genesis.db.getLocalDB();var c=Ext.create("Genesis.model.Venue",n.last_check_in.venue);var i=c.get("latitude");var f=c.get("longitude");var b=6371000*Math.acos(Math.cos(Math.radians(j))*Math.cos(Math.radians(i))*Math.cos(Math.radians(f)-Math.radians(h))+Math.sin(Math.radians(j))*Math.sin(Math.radians(i)));if(b<=Genesis.constants.minDistance){var d=m.getApplication();var e=d.getController("client.Checkins");var k=Ext.StoreMgr.get("CustomerStore").getById(n.last_check_in.customerId);var a=n.last_check_in.metaData;console.log("Restoring Previous Venue Location ...");e.fireEvent("setupCheckinInfo","explore",c,k,a);e.fireEvent("checkinMerchant","checkin",a,c.getId(),k,null,Ext.emptyFn);}else{console.log("Reset Previous Location back to Home Page ...");Genesis.db.removeLocalDBAttrib("last_check_in");m.redirectTo("checkin");}},onItemTap:function(c){var b=this.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(b.sound_files.clickSound);console.log("Controller=["+c.get("pageCntlr")+"]");var a=this.getApplication().getController(c.get("pageCntlr"));var d=a.isOpenAllowed();if(d===true){if(c.get("route")){this.redirectTo(c.get("route"));}else{if(c.get("subFeature")){a.openPage(c.get("subFeature"));}else{a.openMainPage();}}}else{Ext.device.Notification.show({title:"Error",message:d});}return false;},onShowView:function(c){if(Ext.os.is("Android")){var b=c.query("carousel")[0];var a=b.getInnerItems();console.debug("Refreshing MainPage ...");}},onActivate:function(d,e,a,b){this.getInfoBtn()[(merchantMode)?"hide":"show"]();Ext.Viewport.setMasked(false);},onDeactivate:function(a,e,d,b){},onTabBarTabChange:function(b,d,c,a){switch(d.config.tag){default:case"rewards":Ext.defer(function(){try{if(d){d.setActive(false);}if(c){c.setActive(false);}b._activeTab=null;}catch(f){}},2*1000);break;}return true;},facebookLogin:function(b){var a=this;Customer.setFbLoginUrl();console.log("setFbLoginUrl - Logging in ...");Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:Ext.apply(b,{device:Ext.encode(Genesis.constants.device)}),callback:function(d,c){if(!c.wasSuccessful()){Genesis.db.resetStorage();}else{Genesis.db.setLocalDBAttrib("enableFB",true);a.persistSyncStores("CustomerStore");a.fireEvent("updatemetadata",Customer.getProxy().getReader().metaData);}}});},onLoginActivate:function(e,f,b,d){var a=this.getViewPortCntlr();Genesis.db.resetStorage();a.setLoggedIn(false);},onLoginDeactivate:function(a,f,e,b){var d=this;},onLogoutTap:function(i,c,d,j){var h=this;var l=h.getViewport();var f=h.getViewPortCntlr();var g=0;var k=function(){console.log("Resetting Session information ...");if(Genesis.db.getLocalDB()["currFbId"]>0){Genesis.fb.facebook_onLogout(null,true);}h.resetView();h.redirectTo("login");};var a=function(){var b=Genesis.db.getLocalDB()["auth_code"];if(b){console.log("Logging out ...");Customer.setLogoutUrl(b);Ext.StoreMgr.get("CustomerStore").load({jsonData:{},callback:function(m,e){Ext.Viewport.setMasked(false);if(e.wasSuccessful()){h.persistSyncStores(null,true);console.log("Logout Successful!");}else{console.log("Logout Failed!");}}});}k();};i.parent.onAfter({hiddenchange:function(){if((g|=1)==17){a();}},single:true});i.parent.hide();if(Genesis.db.getLocalDB()["currFbId"]>0){console.log("Logging out of Facebook ...");Genesis.fb.facebook_onLogout(function(){if((g|=16)==17){a();}});}else{console.log("No Login info found from Facebook ...");if((g|=16)==17){a();}}},onFacebookTap:function(a,g,c,f){var d=this;Ext.Viewport.setMasked({xtype:"loadmask",message:d.loginWithFbMsg()});Genesis.db.removeLocalDBAttrib("currFbId");Genesis.fb.facebook_onLogin(function(b){console.log(d.loginWithFbMsg());d.facebookLogin(b);},true);},onCreateAccountTap:function(a,f,c,d){this.setAnimationMode(this.self.superclass.self.animationMode.cover);this.pushView(this.getCreateAccount());},onSignInTap:function(a,f,c,d){this.redirectTo("signin");},onRefreshCSRF:function(){var b=this;var a=Account.getProxy();Account.setRefreshCsrfTokenUrl();console.log("setRefreshCsrfTokenUrl - Refreshing CSRF Token ...");Account.load(0,{jsonData:{},params:{device:Ext.encode(Genesis.constants.device)},callback:function(c,e){Ext.Viewport.setMasked(false);if(e.wasSuccessful()){var d=Genesis.db.getLocalDB();b.persistLoadStores(Ext.emptyFn);if(d.last_check_in){b.getGeoLocation();}}else{b.resetView();b.redirectTo("login");}}});},onCreateAccountSubmit:function(k,h,i,n){var j=this;var g=j.getCreateAccount();var o=g.getValues();var f=Ext.create("Genesis.model.frontend.Account",o);var a=f.validate();var d=Genesis.db.getLocalDB()["fbResponse"]||null;if(!a.isValid()){var m=a.first();var l=Ext.ComponentQuery.query("field[name="+m.getField()+"]")[0].getLabel();var p=l+" "+m.getMessage()+Genesis.constants.addCRLF()+"Please Try Again";console.log(p);Ext.device.Notification.show({title:"Oops",message:p});}else{console.debug("Creating Account ...");var c={name:o.name,email:o.username,password:o.password};if(d){c=Ext.apply(c,d);}Customer.setCreateAccountUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:{user:Ext.encode(c),device:Ext.encode(Genesis.constants.device)},callback:function(e,b){if(!b.wasSuccessful()){}else{j.persistSyncStores();j.fireEvent("updatemetadata",Customer.getProxy().getReader().metaData);}}});}},onSignIn:function(d,a){Genesis.fb.facebook_onLogout(null,Genesis.db.getLocalDB()["currFbId"]>0);var b=this;var c={device:Ext.encode(Genesis.constants.device)};if(d){c=Ext.apply(c,{email:d,password:a});}Customer.setLoginUrl();console.log("setLoginUrl - Logging in ...");Ext.StoreMgr.get("CustomerStore").load({params:c,jsonData:{},callback:function(f,e){if(!e.wasSuccessful()){}else{b.persistSyncStores("CustomerStore");b.fireEvent("updatemetadata",Customer.getProxy().getReader().metaData);}}});},onSignInResetSubmit:function(a,f,c,d){this.redirectTo("password_reset");},onSignInSubmit:function(g,d,f,j){var k=this.getSignin();var l=k.getValues();var c=Ext.create("Genesis.model.frontend.Signin",l);var a=c.validate();if(!a.isValid()){var i=a.first();var h=Ext.ComponentQuery.query("field[name="+i.getField()+"]")[0].getLabel();Ext.device.Notification.show({title:"Oops",message:this.signInFailMsg(h+" "+i.getMessage())});}else{this.onSignIn(l.username,l.password);}},onPasswdReset:function(c){var a=this;var b={device:Ext.encode(Genesis.constants.device)};if(c){b=Ext.apply(b,{email:c});}Account.setPasswdResetUrl();console.log("setPasswdResetUrl - Resetting Password ...");Account.load(0,{params:b,jsonData:{},callback:function(d,e){if(e.wasSuccessful()){Ext.device.Notification.show({title:"Password Reset",message:a.passwdResetSuccessMsg()});a.popView();}Ext.Viewport.setMasked(false);}});},onPasswdResetSubmit:function(a,h,c,g){var f=this;var d=function(){var j=f.getPasswdReset();var e=j.getValues();var b=Ext.create("Genesis.model.frontend.Signin",e);var i=b.validate();var k=true;if(!i.isValid()){i.each(function(o,m,n){if(o.getField()=="username"){var l=j.query("field[name=username]")[0].getLabel();Ext.device.Notification.show({title:"Oops",message:f.passwdResetFailMsg(l+" "+field.getMessage())});k=false;}},f);}if(k){f.onPasswdReset(e.username);}};Ext.device.Notification.show({title:"Password Reset",message:this.passwdResetConfirmMsg,buttons:["Confirm","Cancel"],callback:function(b){if(b.toLowerCase()=="confirm"){Ext.defer(d,1);}}});},onPasswdChange:function(b,c){var a=this;var d={device:Ext.encode(Genesis.constants.device)};if(b&&c){d=Ext.apply(d,{old_password:b,new_password:c});}Account.setPasswdChangeUrl();console.log("setPasswdChangeUrl - Changing Password ...");Account.load(0,{params:d,jsonData:{},callback:function(e,f){if(f.wasSuccessful()){Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Password Reset",message:a.passwdChangeSuccessMsg});}}});},onPasswdChangeSubmit:function(h,d,f,k){var g=this.getPasswdChange();var l=g.getValues(true);var c=Ext.create("Genesis.model.frontend.ChangePassword",l);var a=c.validate();if(!a.isValid()){var j=a.first();var i=Ext.ComponentQuery.query("field[name="+j.getField()+"]")[0].getLabel();var m=this.passwdChangeFailMsg(i+" "+j.getMessage());console.log(m);Ext.device.Notification.show({title:"Oops",message:m});}else{this.onPasswdChange(l.oldpassword,l.newpassword);}},onCreateActivate:function(f,g,a,d){var b=Genesis.db.getLocalDB()["fbResponse"]||null;if(b){var e=this.getCreateAccount();e.setValues({name:b.name,username:b.email});}},onCreateDeactivate:function(a,f,e,b){var d=this;},mainPage:function(){this.openPage("main");},loginPage:function(){this.openPage("login");},merchantPage:function(){this.openPage("merchant");},signInPage:function(){this.setAnimationMode(this.self.superclass.self.animationMode.cover);this.pushView(this.getSignin());},signInResetPage:function(){this.setAnimationMode(this.self.superclass.self.animationMode.slide);this.pushView(this.getPasswdReset());},signInChangePage:function(){this.setAnimationMode(this.self.superclass.self.animationMode.slide);this.pushView(this.getPasswdChange());},createAccountPage:function(){this.onCreateAccountTap();},openPage:function(a){var c=this;switch(a){case"main":c.setAnimationMode(c.self.superclass.self.animationMode.pop);c.pushView(c.getMainPage());break;case"merchant":c.resetView();var d=c.getViewPortCntlr().getCheckinInfo();c.redirectTo("venue/"+d.venue.getId()+"/"+d.customer.getId()+"/1");break;case"login":var b=c.getApplication().getController("client.Checkins");b.fireEvent("setupCheckinInfo","checkin",null,null,null);c.setAnimationMode(c.self.superclass.self.animationMode.fade);c.pushView(c.getLogin());break;}},getMainPage:function(){var a=this.getMain();return a;},openMainPage:function(){var a=this.getViewPortCntlr();this.setAnimationMode(this.self.superclass.self.animationMode.pop);this.pushView(this.getMainPage());console.log("MainPage Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.client.Checkins",{extend:"Genesis.controller.ControllerBase",statics:{checkin_path:"/checkin"},xtype:"clientcheckinsCntlr",config:{routes:{exploreS:"explorePageUp",explore:"explorePage",checkin:"checkinPage"},refs:{exploreList:"clientcheckinexploreview list",explore:{selector:"clientcheckinexploreview",autoCreate:true,xtype:"clientcheckinexploreview"},checkInNowBar:"clientcheckinexploreview container[tag=checkInNow]",shareBtn:"viewportview button[tag=shareBtn]"},control:{explore:{showView:"onExploreShowView",activate:"onExploreActivate",deactivate:"onExploreDeactivate"},exploreList:{select:"onExploreSelect"}},listeners:{exploreLoad:"onExploreLoad",checkin:"onCheckinTap",explore:"onNonCheckinTap",checkinScan:"onCheckinScanTap",checkinMerchant:"onCheckinHandler",setupCheckinInfo:"onSetupCheckinInfo"},position:null,},metaDataMissingMsg:"Missing Checkin MetaData information.",noCheckinCodeMsg:"No Checkin Code found!",loadingPlaces:"Loading ...",init:function(){var a=this;Ext.regStore("CheckinExploreStore",{model:"Genesis.model.Venue",autoLoad:false,sorters:[{property:"distance",direction:"ASC"}],listeners:{metachange:function(b,d,c){if(b.isLoading()){a.fireEvent("updatemetadata",d.getReader().metaData);}}}});a.callParent(arguments);console.log("Checkins Init");a.getExplore();backBtnCallbackListFn.push(function(c){if(c==a.getExplore()){var b=a.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(b.sound_files.clickSound);b.goToMain();return true;}return false;});},checkinCommon:function(i){var h=this;var c=Ext.StoreMgr.get("CustomerStore");var f=h.callback.mode;var a=h.callback.url;var e=h.callback.position;var j=h.callback.callback;var g=h.getViewPortCntlr();var b=null;switch(h.callback.url){case"setVenueScanCheckinUrl":break;default:b=(g.getVenue()?g.getVenue().getId():null);break;}Customer[a](b);var d={latitude:(e)?e.coords.getLatitude():0,longitude:(e)?e.coords.getLongitude():0,auth_code:i||0};if(b){d=Ext.apply(d,{venue_id:b});}console.debug("CheckIn - auth_code:'"+i+"' venue_id:'"+b+"'");c.load({addRecords:true,jsonData:{},params:d,scope:h,callback:function(m,l){var k=Customer.getProxy().getReader().metaData;if(l.wasSuccessful()&&k){h.fireEvent("checkinMerchant",f,k,b,m[0],l,j);}else{if(!l.wasSuccessful()&&!k){console.log(h.metaDataMissingMsg);}}}});},onScannedQRcode:function(b){var a=this;if(b){console.log(a.checkinMsg);Ext.Viewport.setMasked({xtype:"loadmask",message:a.checkinMsg});a.checkinCommon(b);}else{console.debug(a.noCheckinCodeMsg);Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:a.noCheckinCodeMsg});}},onCheckInScanNow:function(i,d,f,j,c,a,h,k){var g=this;switch(h){case"scan":g.callback={mode:c,position:g.getPosition(),url:a,type:h,callback:k};g.scanQRCode();break;default:g.callback={mode:c,position:g.getPosition(),url:a,type:"",callback:k};Ext.Viewport.setMasked({xtype:"loadmask",message:g.getMerchantInfoMsg});g.checkinCommon(null);break;}g.setPosition(null);},onSetupCheckinInfo:function(e,d,c,b){var a=this.getViewPortCntlr();a.setVenue(d);a.setCustomer(c);a.setMetaData(b);switch(e){case"checkin":a.setCheckinInfo({venue:a.getVenue(),customer:a.getCustomer(),metaData:a.getMetaData()});break;default:break;}},onCheckinScanTap:function(a,d,c,f){this.onCheckInScanNow(a,d,c,f,"checkin","setVenueScanCheckinUrl","scan",function(){Ext.device.Notification.vibrate();});},onCheckinTap:function(a,d,c,f){this.onCheckInScanNow(a,d,c,f,"checkin","setVenueCheckinUrl","noscan",function(){Ext.device.Notification.vibrate();});},onNonCheckinTap:function(a,d,c,f,g){this.onCheckInScanNow(a,d,c,f,"explore","setVenueExploreUrl","noscan",g);},onCheckinHandler:function(m,p,a,b,l,d){var t=this;var k=t.getApplication();var r=Ext.StoreMgr.get("CustomerStore");var o=Ext.StoreMgr.get("CheckinExploreStore");var f=k.getController("client.Merchants");var s=t.getViewPortCntlr();var c=t.getViewport();var j=false,e=false;var i,g,h,q;i=b.getId();q=b.get("points");d=d||Ext.emptyFn;var n=p.venue_id||((o.first())?o.first().getId():0);h=o.getById(n)||s.getVenue();console.debug("CheckIn - new_venueId:'"+n+"' venue_id:'"+a+"' points:'"+q+"'");if((n==a)||(a==null)){e=(m=="checkin");if(Customer.isValid(i)){g=r.getById(i);console.debug("Checking In Venue ...");}else{console.debug("Exploring Venue ...");}t.fireEvent("setupCheckinInfo",m,h,g||b,p);t.fireEvent("updatemetadata",p);}else{console.log("CheckIn - venueIDs do not match!");}t.resetView();Ext.Viewport.setMasked(false);switch(m){case"checkin":case"explore":t.redirectTo("venue/"+h.getId()+"/"+i);break;default:break;}d();if(e){Ext.defer(t.checkReferralPrompt,0.1*1000,t,[function(){Ext.device.Notification.show({title:"Successful Referral!",message:t.recvReferralb4VisitMsg(g.getMerchant().get("name"))});},null]);console.debug("CheckIn - Complete");}else{console.debug("CheckInExplore - Complete");}},onLocationUpdate:function(a){var c=this;var d=Ext.StoreMgr.get("CheckinExploreStore");var b=d.getProxy();if(!a){c.popView();}else{Venue.setFindNearestURL();d.load({params:{latitude:a.coords.getLatitude(),longitude:a.coords.getLongitude()},callback:function(g,f){if(f.wasSuccessful()){Ext.Viewport.setMasked(false);var e=c.getCheckInNowBar();c.setPosition(a);e.setDisabled(false);}else{b.supressErrorsPopup=true;Ext.device.Notification.show({title:"Warning",message:c.missingVenueInfoMsg,callback:function(){b.supressErrorsPopup=false;}});}},scope:c});}},onExploreLoad:function(c){var a=this;var b=Ext.StoreMgr.get("CheckinExploreStore");if((b.getCount()==0)||c){if(Genesis.db.getLocalDB()["csrf_code"]){a.getGeoLocation();}}},onExploreShowView:function(c){var b=this.getExploreList();if(Ext.os.is("Android")){var a=this.getEventDispatcher().getPublishers()["elementSize"].monitors;console.debug("Refreshing CheckinExploreStore ...");a[b.container.getId()].forceRefresh();}},onExploreActivate:function(h,i,e,f){var g=this;var a=g.getViewPortCntlr();var d=g.getCheckInNowBar();var b=h.query("titlebar")[0];switch(g.animMode){case"cover":break;case"coverUp":break;}b.removeCls("kbTitle");switch(g.mode){case"checkin":b.setTitle(" ");b.addCls("kbTitle");d.setDisabled(true);d.show();break;case"explore":d.hide();break;}if(g.getExploreList()){}g.fireEvent("exploreLoad");},onExploreDeactivate:function(a,e,d,b){},onExploreSelect:function(c,a,b){c.deselect([a]);this.onExploreDisclose(c,a);return false;},onExploreDisclose:function(g,a,d,b,f,h,j){var i=this;var c=i.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(c.sound_files.clickSound);c.setVenue(a);switch(this.mode){case"checkin":this.onCheckinTap(null,f,h,j);break;case"explore":this.onNonCheckinTap(null,f,h,j);break;}},explorePageUp:function(){this.openPage("explore","coverUp");},explorePage:function(){this.openPage("explore");},checkinPage:function(){this.openPage("checkin");},openPage:function(a,c){var b=this;var d=b.getMainPage();b.mode=d.mode=a;b.animMode=c||"cover";b.setAnimationMode(b.self.superclass.self.animationMode[b.animMode]);b.pushView(d);},getMainPage:function(){var a=this.getExplore();return a;},openMainPage:function(){var a=this.getMainPage();this.pushView(a);console.log("Checkin Explore Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.client.Challenges",{extend:"Genesis.controller.ControllerBase",requires:["Ext.Anim"],statics:{challenges_path:"/clientChallenges"},xtype:"clientChallengesCntlr",config:{routes:{referrals:"referralsPage",challenges:"challengesPage",photoUpload:"photoUploadPage"},refs:{challengeBtn:"clientchallengepageview button[tag=doit]",challengePage:{selector:"clientchallengepageview",autoCreate:true,xtype:"clientchallengepageview"},challengeContainer:"clientchallengepageview container[tag=challengeContainer]",challengeDescContainer:"clientchallengepageview container[tag=challengePageItemDescWrapper]",uploadPhotosPage:{selector:"clientuploadphotospageview",autoCreate:true,xtype:"clientuploadphotospageview"},uploadPhotosBackground:"clientuploadphotospageview container[tag=background]",postBtn:"viewportview button[tag=post]",photoTextarea:"clientuploadphotospageview textareafield",referralsPage:{selector:"clientreferralsview",autoCreate:true,xtype:"clientreferralsview"},qrcode:"clientreferralsview component[tag=qrcode]",title:"clientreferralsview component[tag=title]",referralsContainer:"clientreferralsview container[tag=referralsMain]"},control:{challengePage:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},"clientchallengepageview > carousel dataview":{select:"onItemSelect"},challengeBtn:{tap:"onChallengeBtnTap"},"actionsheet button[tag=library]":{tap:"onLibraryBtnTap"},"actionsheet button[tag=album]":{tap:"onAlbumBtnTap"},"actionsheet button[tag=camera]":{tap:"onCameraBtnTap"},uploadPhotosPage:{activate:"onUploadPhotosActivate",deactivate:"onUploadPhotosDeactivate"},postBtn:{tap:"onUploadPhotosTap"},referralsPage:{activate:"onReferralsActivate",deactivate:"onReferralsDeactivate"},"clientreferralsview container[tag=referralsMain] list":{select:"onReferralsSelect"},"clientreferralsview container button[tag=done]":{tap:"onCompleteReferralsChallenge"}},listeners:{fbphotouploadcomplete:"onFbPhotoUploadComplete",challengecomplete:"onChallengeComplete",doChallenge:"onChallengeBtnTap",itemTap:"onItemTap"}},metaData:null,reservedReferralId:0,referralCbFn:null,defaultDescText:"Please Select a challenge to perform",samplePhotoURL:"http://photos.getkickbak.com/paella9finish1.jpg",noPhotoUploadedMsg:"Failed to upload photo to server.",fbUploadFailedMsg:"Failed to upload the photo onto your Facebook account",checkinFirstMsg:"Please Check-In before performing challenges",photoUploadFbReqMsg:"Connectivity to Facebook is required to upload photos to your account",completingChallengeMsg:"Completing Challenge ...",referralInstructionMsg:"Get your friend to scan this code using their KickBak App on their mobile phone!",customerFirstMsg:"Before you can make referrals, your must be one of our paying customers! ;-)",photoUploadSuccessMsg:function(a){return"We've added earned "+a+" points"+Genesis.constants.addCRLF()+"towards your account for uploading photos to Facebook!";},photoTakenFailMsg:function(a){return a+Genesis.constants.addCRLF()+"No Photos were taken.";},photoUploadIncompletesMsg:"Trouble updating to server.",photoUploadFailValidationMsg:"Please enter a comment with at least 16 characters in length",getPointsMsg:function(a,b){return"You have earned "+a+" Pts from this challenge!";},getConsolationMsg:function(a){return a+Genesis.constants.addCRLF()+"Try our other challenges as well!";},confirmRecvReferralsMsg:"Please have your Referral Code ready to be scanned",referralFailedMsg:"Email failed to send",referralSavedMsg:"Email saved.",sendReferralSuccessMsg:function(){return"Email was sent successfully!"+Genesis.constants.addCRLF()+"Every successful referral will get you extra points!";},visitFirstMsg:"You must visit this establishment first before you are eligible to do this Challenge",init:function(b){var a=this;this.callParent(arguments);console.log("Challenge Init");a.getChallengePage();},photoEventHandler:function(a){var e=this;if(e.imageURI){if(Genesis.constants.isNative()){var c=new FileUploadOptions();c.fileKey="image";c.fileName="DummyPhoto.jpg";c.mimeType="image/jpg";c.params={auth_token:Genesis.db.getLocalDB()["auth_code"]};c.chunkedMode=true;Ext.Viewport.setMasked({xtype:"loadmask",message:e.uploadServerMsg});var f=new FileTransfer();var d,b;f.upload(e.imageURI,Genesis.constants.host+"/api/v1/venues/share_photo",function(h){try{d=decodeURIComponent(h.response)||"";console.debug("\nResponse = ["+d+"]\nCode = "+h.responseCode+"\nSent = "+h.bytesSent);d=Ext.decode(d);if(d){b=e.metaData=d.metaData||null;b.position=a;}else{console.log("No Data returned by the server.");}}catch(g){console.log("Unable to parse the JSON returned by the server: "+g.toString());}Ext.Viewport.setMasked(false);if(b&&b.photo_url&&b.upload_token){console.log("Uploading to Facebook using upload_token["+b.upload_token+"]...");e.redirectTo("photoUpload");}delete e.imageURI;},function(g){Ext.Viewport.setMasked(false);console.log(e.noPhotoUploadedMsg(g.message+Genesis.constants.addCRLF()));Ext.device.Notification.show({title:"Error",message:e.noPhotoUploadedMsg(g.message+Genesis.constants.addCRLF())});delete e.imageURI;},c);}else{e.metaData={photo_url:e.imageURI};e.redirectTo("photoUpload");}}},sendReferralEmailHandler:function(d,c,a){var b=this;window.plugins.emailComposer.showEmailComposerWithCB(function(e){Ext.defer(function(){Ext.Viewport.setMasked(false);b.onCompleteReferralsChallenge();switch(e){case EmailComposer.ComposeResultType.Failed:case EmailComposer.ComposeResultType.NotSent:case EmailComposer.ComposeResultType.Cancelled:Ext.device.Notification.show({title:"Email Error",message:b.referralFailedMsg});break;case EmailComposer.ComposeResultType.Saved:Ext.device.Notification.show({title:"Email Saved",message:b.referralSavedMsg});break;case EmailComposer.ComposeResultType.Sent:Ext.device.Notification.show({title:"Email Sent!",message:b.sendReferralSuccessMsg()});break;}},1,b);},a,c,null,null,null,true,[d]);},referralEventHandler:function(f){var d=this,c;var e=d.getViewPortCntlr().getVenue();var b=d.getReferralsContainer();var a=f.get("tag");switch(a){case"sender":c="direct";Ext.Viewport.setMasked({xtype:"loadmask",message:d.genQRCodeMsg});break;case"emailsender":c="email";Ext.Viewport.setMasked({xtype:"loadmask",message:d.retrieveAuthModeMsg});break;case"receiver":d.openPage("referrals");return;break;}Challenge.setSendReferralsUrl(d.selectedItem.getId());Challenge.load(d.selectedItem.getId(),{jsonData:{},params:{venue_id:e.getId(),type:c},callback:function(i,h){var g=Challenge.getProxy().getReader().metaData;if(h.wasSuccessful()){var l;switch(a){case"sender":l=Genesis.controller.ControllerBase.genQRCode(g.data);if(l[0]){d.getQrcode().setStyle({"background-image":"url("+l[0]+")","background-size":Genesis.fn.addUnit(l[1]*1.25)+" "+Genesis.fn.addUnit(l[2]*1.25)});b.setActiveItem(1);}Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Refer A Friend",message:d.referralInstructionMsg});break;case"emailsender":l=g.data["qrcode"];var k=g.data["body"];var j=g.data["subject"];console.debug("\nQRCode - "+l+"\nSubject - "+j+"\n");l=Genesis.controller.ControllerBase.genQRCode(l)[0].replace("data:image/gif;base64,","");d.sendReferralEmailHandler(l,k,j);break;}}else{Ext.Viewport.setMasked(false);}}});},vipEventHandler:function(a){this.completeChallenge(null,a);},onLocationUpdate:function(a){var b=this;switch(b.selectedItem.get("type").value){case"photo":b.photoEventHandler(a);break;case"vip":b.vipEventHandler(a);break;case"referral":break;case"menu":case"birthday":case"custom":default:b.metaData={position:a};b.scanQRCode();break;}},onScannedQRcode:function(b){var a=this;if(b!=null){a.completeChallenge(b,(a.metaData)?a.metaData.position:null);}else{console.debug(a.noCodeScannedMsg);Ext.device.Notification.show({title:"Error",message:a.noCodeScannedMsg});a.referralCbFn=null;}a.metaData=null;},onChallengeComplete:function(j,m,e,n,f,h,k){var i=this;var a=Challenge.getProxy().getReader().metaData;var d=Ext.StoreMgr.get("CustomerStore");switch(j){case"referral":var b=a.id;var g=d.getById(b);if(!g){g=d.add(a)[0];i.persistSyncStores("CustomerStore");}console.debug("Adding Referral Code to Referral DB ...");Genesis.db.addReferralDBAttrib("m"+g.getMerchant().getId(),m);if(i.referralCbFn){console.debug("Calling Referral CallbackFn ...");i.referralCbFn();i.referralCbFn=null;}else{Ext.device.Notification.show({title:"Successful Referral!",message:i.recvReferralb4VisitMsg(g.getMerchant().get("name")),callback:function(){console.debug("Opening Merchant Account ...");var p=i.getApplication();var o=p.getController("client.Accounts");o.setMode("profile");o.fireEvent("selectMerchant",null,g);}});}break;case"vip":Ext.device.Notification.show({title:"VIP Challenge",message:i.getConsolationMsg(a.message)});i.fireEvent("updatemetadata",a);break;default:var l=a.account_info;var c=a.reward_info;Ext.device.Notification.show({title:"Completed Challenge!",message:((c.points>0)?i.getPointsMsg(c.points,l.points):i.getConsolationMsg(a.message))});i.fireEvent("updatemetadata",a);break;}},onFbPhotoUploadComplete:function(){var h=this;var e=Ext.StoreMgr.get("CustomerStore");var f=h.getViewPortCntlr();var c=f.getVenue();var d=c.getId();var a=h.metaData;var j=f.getCustomer().getId();var i=h.selectedItem.get("points");var b=h.selectedItem.getId();var g=Challenge.getProxy();Challenge.setCompleteChallengeURL(b);Challenge.load(b,{jsonData:{},params:{venue_id:d,latitude:a.position.coords.getLatitude(),longitude:a.position.coords.getLongitude(),upload_token:a.upload_token},callback:function(n,m){Ext.Viewport.setMasked(false);var o=g.getReader().metaData;if(m.wasSuccessful()&&o){var l=o.account_info;var k=o.reward_info;var p=e.getById(j);p.set("points",l.points);h.persistSyncStores("CustomerStore");console.debug("Points Earned = "+o.points+" Pts");Ext.device.Notification.show({title:"Upload Complete",message:((k.points>0)?h.photoUploadSuccessMsg(k.points):h.getConsolationMsg(o.message)),callback:function(){h.metaData=null;h.popView();}});h.fireEvent("updatemetadata",o);}else{g.supressErrorsPopup=true;Ext.device.Notification.show({title:"Upload Failed!",message:h.photoUploadIncompletesMsg,buttons:["Try Again","Cancel"],callback:function(q){g.supressErrorsPopup=false;if(q.toLowerCase()=="try again"){Ext.defer(h.fireEvent,1*1000,h,["fbphotouploadcomplete"]);}else{h.metaData=null;f.onCheckedInAccountTap();}}});}}});},onItemTap:function(b){var a=this.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);var c=this.getChallengeDescContainer();Ext.Anim.run(c.element,"fade",{duration:600,out:false,autoClear:true,scope:this,before:function(){for(var d=0;d<c.getItems().length;d++){c.getItems().getAt(d).updateData(b.getData());}this.selectedItem=b;}});this.getChallengeContainer().show();return true;},onChallengeBtnTap:function(j,d,f,k){var i=this;var g=i.getViewPortCntlr();var h=g.getCheckinInfo().venue;var a=g.getVenue();var c=i.selectedItem;if(c){switch(c.get("type").value){case"referral":if(g.getCustomer().get("visits")<=0){Ext.device.Notification.show({title:"Refer A Friend",message:i.customerFirstMsg});return;}break;default:if(!(h&&a&&(h.getId()==a.getId()))){Ext.device.Notification.show({title:"Error",message:i.checkinFirstMsg});return;}break;}switch(c.get("type").value){case"photo":i.getChallengePage().takePhoto();break;case"referral":i.redirectTo("referrals");break;case"menu":case"birthday":case"vip":case"custom":if(c.get("require_verif")){Ext.device.Notification.show({title:i.selectedItem.get("name")+" Challenge",message:i.showToServerMsg,callback:function(){i.getGeoLocation();}});}else{i.getGeoLocation();}break;}}},onShowView:function(c){if(Ext.os.is("Android")){var b=c.query("carousel")[0];var a=b.getInnerItems();console.debug("Refreshing MainPage ...");}},onActivate:function(e,f,a,b){var d=this;Ext.defer(function(){var g=d.getChallengeDescContainer();for(var c=0;c<g.getItems().length;c++){g.getItems().getAt(c).updateData({description:d.defaultDescText});d.getChallengeContainer().hide();}},1,e);delete d.selectedItem;},onDeactivate:function(a,e,d,b){},completeChallenge:function(j,d,f,i){var g=this;var a,h,c;if(!d){h="referral";a=g.reservedReferralId;c={};Challenge.setCompleteReferralChallengeURL();}else{var e=g.getViewPortCntlr();var b=e.getVenue().getId();var k=e.getCustomer().getId();a=g.selectedItem.getId();h=g.selectedItem.get("type").value;c={venue_id:b,latitude:d.coords.getLatitude(),longitude:d.coords.getLongitude(),};Challenge.setCompleteChallengeURL(a);}console.log("Completing Challenge ID("+a+")");Challenge.load(a,{jsonData:{},params:Ext.apply(c,{data:j}),callback:function(m,n){var l=Challenge.getProxy().getReader().metaData;console.log("Challenge Completed("+n.wasSuccessful()+")");Ext.Viewport.setMasked(false);if(n.wasSuccessful()&&l){g.fireEvent("challengecomplete",h,j,b,k,d);}}});},onReferralsActivate:function(f,g,b,d){var e=this;var a=e.getReferralsContainer();if(a){a.setActiveItem(0);}},onReferralsDeactivate:function(a,e,d,b){},onCompleteReferralsChallenge:function(a,d,c){this.popView();},onReferralsSelect:function(e,b,c){var d=this;var a=d.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);if(a.getCustomer().get("visits")>0){if(e){e.deselect([b]);}switch(b.get("tag")){case"emailsender":case"sender":d.referralEventHandler(b);break;}}else{Ext.device.Notification.show({title:"Referral Challenge",message:d.visitFirstMsg});}return false;},onCameraSuccessFn:function(b){var a=this;console.debug("image URI =["+b+"]");Ext.Viewport.setMasked(false);a.imageURI=b;a.getGeoLocation();},onCameraErrorFn:function(b){var a=this;console.debug("onCameraErrorFn - message["+b+"]");Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:a.photoTakenFailMsg(b)});},onPhotoBtnCommon:function(a){var b=this;var c=b.getChallengePage().photoAction;c.hide();console.log("Checking for Facebook Plugin ...");if(Genesis.constants.isNative()){Genesis.fb.facebook_onLogin(function(d){console.log("Accessing Camera Plugin ...");Ext.Viewport.setMasked({xtype:"loadmask",message:b.cameraAccessMsg});Ext.device.Camera.capture({success:b.onCameraSuccessFn,failure:b.onCameraErrorFn,scope:b,quality:49,correctOrientation:true,destination:"file",source:a,allowEdit:true,encoding:"jpeg",width:960});},true,b.photoUploadFbReqMsg);}else{b.onCameraSuccessFn(b.samplePhotoURL);}},onLibraryBtnTap:function(a,f,c,d){this.onPhotoBtnCommon(Genesis.constants.isNative()?"library":null);},onAlbumBtnTap:function(a,f,c,d){this.onPhotoBtnCommon(Genesis.constants.isNative()?"album":null);},onCameraBtnTap:function(a,f,c,d){this.onPhotoBtnCommon(Genesis.constants.isNative()?"camera":null);},onUploadPhotosActivate:function(e,f,a,b){var d=this;e.metaData=d.metaData;},onUploadPhotosDeactivate:function(a,e,d,b){this.getPhotoTextarea().setValue(null);},onUploadPhotosTap:function(j,f,g,k){var i=this;var h=i.getUploadPhotosPage();var l=i.getPhotoTextarea();var c=l.getValue();if((c.length>l.getMaxLength())||(c.length<16)){Ext.device.Notification.show({title:"Error",message:i.photoUploadFailValidationMsg,callback:function(){l.focus();}});return;}var d=i.getViewPortCntlr();var a=d.getVenue();if(typeof(FB)!="undefined"){Ext.Viewport.setMasked({xtype:"loadmask",message:i.completingChallengeMsg});FB.api("/me/photos","post",{message:c,url:i.metaData.photo_url,access_token:FB.getAccessToken()},function(b){if(!b||b.error){var e=(b&&b.error)?b.error.message:i.fbUploadFailedMsg;Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Upload Failed!",message:e,buttons:["Try Again","Cancel"],callback:function(m){if(m.toLowerCase()=="try again"){Ext.defer(i.onUploadPhotosTap,1*1000,i);}else{i.metaData=null;d.onCheckedInAccountTap();}}});}else{console.debug("Facebook Post ID - "+b.id);i.fireEvent("fbphotouploadcomplete");}});}else{i.metaData=null;i.popView();}},referralsPage:function(){var a=this;a.setAnimationMode(a.self.superclass.self.animationMode.cover);a.pushView(a.getReferralsPage());},challengesPage:function(){this.setAnimationMode(this.self.superclass.self.animationMode.coverUp);this.pushView(this.getMainPage());},photoUploadPage:function(){var a=this;a.setAnimationMode(a.self.superclass.self.animationMode.coverUp);a.pushView(a.getUploadPhotosPage());},openPage:function(b,a){var c=this;switch(b){case"referrals":Ext.device.Notification.show({title:"Referral Challenge",message:c.confirmRecvReferralsMsg,buttons:["Proceed","Cancel"],callback:function(d){if(d.toLowerCase()=="proceed"){if(a){c.referralCbFn=a;}delete c.selectedItem;c.metaData=null;c.scanQRCode();}}});break;default:break;}},getMainPage:function(){var a=this.getChallengePage();return a;},openMainPage:function(){this.redirectTo("challenges");console.log("Client ChallengePage Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.client.Merchants",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{googleMapStaticUrl:"http://maps.googleapis.com/maps/api/staticmap"},xtype:"clientmerchantsCntlr",config:{routes:{"venue/:id/:id":"mainPage","venue/:id/:id/:id":"backToMainPage",venueDetails:"venueDetails"},refs:{main:{selector:"clientmerchantaccountview",autoCreate:true,xtype:"clientmerchantaccountview"},merchantMain:"clientmerchantaccountview container[tag=merchantMain]",tbPanel:"clientmerchantaccountview dataview[tag=tbPanel]",feedContainer:"clientmerchantaccountview container[tag=feedContainer]",descContainer:"clientmerchantaccountview container[tag=descContainer]",descPanel:"clientmerchantaccountview container[tag=descPanel]",merchantDetails:{selector:"clientmerchantdetailsview",autoCreate:true,xtype:"clientmerchantdetailsview"},mapBtn:"viewportview button[tag=mapBtn]",shareBtn:"viewportview button[tag=shareBtn]",mainBtn:"clientmerchantaccountview tabbar[tag=navigationBarBottom] button[tag=main]",prizesBtn:"clientmerchantaccountview tabbar[tag=navigationBarBottom] button[tag=prizes]",redeemBtn:"clientmerchantaccountview tabbar[tag=navigationBarBottom] button[tag=redemption]",merchantTabBar:"clientmerchantaccountview tabbar"},control:{main:{showView:"onMainShowView",activate:"onMainActivate",deactivate:"onMainDeactivate",jackpotWinnersTap:"onJackpotWinnersTap",badgeTap:"onBadgeTap"},mapBtn:{tap:"onMapBtnTap"},"clientmerchantaccountview button[ui=orange]":{tap:"onMerchantAccountRewardsTap"},"clientmerchantaccountview list":{select:"onMainSelect"},merchantTabBar:{tabchange:"onTabBarTabChange"},merchantDetails:{showView:"onDetailsShowView",activate:"onDetailsActivate",deactivate:"onDetailsDeactivate"},"clientmerchantdetailsview map":{maprender:"onMapRender"},"clientmerchantdetailsview component[tag=map]":{},},listeners:{backToMain:"onBackToCheckIn"}},checkinFirstMsg:"Please Check-in before redeeming rewards",init:function(){var a=this;a.markersArray=[];if(window.google&&window.google.maps&&window.google.maps.Map){google.maps.Map.prototype.clearOverlays=function(){if(a.markersArray){for(var b=0;b<a.markersArray.length;b++){a.markersArray[b].setMap(null);}}};}else{console.debug("Google Maps API cannot be instantiated");}Ext.regStore("NewsStore",{model:"Genesis.model.News",autoLoad:false});Ext.regStore("MerchantRenderStore",{model:"Genesis.model.Venue",autoLoad:false});a.callParent(arguments);console.log("Merchants Init");a.getMain();backBtnCallbackListFn.push(function(c){if(c==a.getMain()){var b=a.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(b.sound_files.clickSound);a.redirectTo("checkin");return true;}return false;});},onActivateCommon:function(c,a){var b=(window.google&&window.google.maps&&window.google.maps.Marker)?window.google.maps:null;if(a&&b){c.getMap().clearOverlays();this.marker=new b.Marker(Ext.apply(this.markerOptions,{map:a}));c.setMapCenter(this.latLng);}else{}},onDetailsShowView:function(c){if(Ext.os.is("Android")){var a=this.getEventDispatcher().getPublishers()["elementPaint"].monitors;var b=c.query("component[tag=map]")[0];console.debug("Refreshing MerchantDetails ...");c.query("dataview[tag=details]")[0].refresh();a[b.element.getId()].onElementPainted({animationName:"x-paint-monitor-helper"});}},onDetailsActivate:function(e,f,a,b){var d=this.getViewPortCntlr().getVenue();this.getShareBtn().show();e.query("titlebar")[0].setTitle(d.get("name"));},onDetailsDeactivate:function(a,e,d,b){},onMapRender:function(c,b,a){},onLocationUpdate:function(a){var c=this;var d=c.getApplication();var b=d.getController("client.Checkins");b.setPosition(a);b.fireEvent("checkin");},checkInAccount:function(){var d=this;var a=d.getViewPortCntlr();var c=d.getViewport();var h=a.getVenue();if(d.getMainPage()==c.getActiveItem()){var b=c.getEventDispatcher().controller;var f=new Ext.fx.layout.Card(d.self.superclass.self.animationMode.fade);f.on("animationend",function(){console.debug("Animation Complete");f.destroy();},d);console.log("Reloading current Merchant Home Account Page ...");var e=d.getMainPage();e.removeAll(true);c.animateActiveItem(e,f);f.onActiveItemChange(c.getLayout(),e,e,null,b);c.doSetActiveItem(e,null);}else{var g=a.getCheckinInfo();console.log("Going back to Checked-In Merchant Home Account Page ...");d.resetView();d.redirectTo("venue/"+g.venue.getId()+"/"+g.customer.getId());}},onMainShowView:function(a){if(Ext.os.is("Android")){console.debug("Refreshing MerchantRenderStore ...");a.query("dataview[tag=tbPanel]")[0].refresh();var b=a.query("dataview[tag=feedPanel]")[0];if(b){b.refresh();}a.query("dataview[tag=descPanel]")[0].refresh();}},onMainActivate:function(k,q,n,e){console.debug("Merchant Account Activate");var s=this;var p=s.getViewPortCntlr();var a=p.getVenue();var g=p.getCustomer();var j=g.getId();var f=a.getId();var d=a.getMerchant().getId();var l=p.getCheckinInfo().venue;var t=(l!=null);var o=(t&&(l.getId()==f));var h=Ext.StoreMgr.get("MerchantRenderStore");h.setData(a);s.onCustomerRecordUpdate(g);k.showMainBtn=(t&&!o);if(o){k.renderFeed=true;console.debug("Merchant Checkin Mode");}else{k.renderFeed=s.showFeed;console.debug("Merchant Explore Mode");}var b=k.getScrollable();b.getScroller().scrollTo(0,0);var r=s.getFeedContainer();if(r){r[k.renderFeed?"show":"hide"];}s.getMainBtn()[(k.showMainBtn)?"show":"hide"]();var i=s.getPrizesBtn();i.setIcon("");i.setIconCls("prizes");var m=k.query("titlebar")[0];m.setTitle(" ");Ext.defer(function(){m.setTitle(a.get("name"));},1,s);},onMainDeactivate:function(a,g,f,d){var e=this;for(var b=0;b<f.getInnerItems().length;b++){}},onMainDisclose:function(j,d,h,f,i,k){var m=this;var l=m.getViewPortCntlr();var g=l.getCheckinInfo().venue;var a=l.getVenue();if(!g||!a||(a.getId()!=g.getId())){Ext.device.Notification.show({title:"Rewards",message:m.checkinFirstMsg});return;}switch(d.get("reward_type")){case"vip":break;default:var b=m.getApplication();var c=b.getController("client.Prizes");var n=Ext.StoreMgr.get("RedeemStore");d=n.getById(d.get("reward_id"));c.fireEvent("showredeemitem",d);break;}},onMainSelect:function(c,a,b){c.deselect([a]);this.onMainDisclose(c,a);return false;},onCustomerRecordUpdate:function(c){var b=this;var a=Ext.StoreMgr.get("MerchantRenderStore");if(a&&(a.getCount()>0)){if(a&&a.getRange()[0].getMerchant().getId()==c.getMerchant().getId()){if(b.getPrizesBtn()){b.getPrizesBtn().setBadgeText(c.get("eligible_for_prize")?"✔":null);}if(b.getRedeemBtn()){b.getRedeemBtn().setBadgeText(c.get("eligible_for_reward")?"✔":null);}}}},onCheckinTap:function(a,g,c,f){var d=this;d.getGeoLocation();},onBackToCheckIn:function(){var g=this;var e=g.getViewPortCntlr();var a=e.getVenue();var d=e.getCheckinInfo();var b=g.getApplication();var h=b.getController("client.Checkins");var c=d.customer;var f=d.venue;var i=d.metaData;if(a.getId()!=f.getId()){console.log("Update current Venue to be Checked-In Merchant Account ...");h.fireEvent("setupCheckinInfo","checkin",f,c,i);g.fireEvent("updatemetadata",i);}g.checkInAccount();},onMapBtnTap:function(a,g,c,f){var d=this;d.redirectTo("venueDetails");},onTabBarTabChange:function(b,d,c,a){switch(d.config.tag){default:case"rewards":case"main":Ext.defer(function(){try{if(d){d.setActive(false);}if(c){c.setActive(false);}b._activeTab=null;}catch(f){}},2*1000);break;}return true;},onJackpotWinnersTap:function(a,g,c,f){var d=this;var h=d.getViewPortCntlr().getVenue().getMerchant().getId();d.redirectTo("jackpotWinners/"+h);},onBadgeTap:function(a,f,c,d){this.redirectTo("badges");},mainPage:function(b,a){this.backToMainPage(b,a,0);},backToMainPage:function(f,e,c){var d=this;var a=d.getViewPortCntlr();var b=true;this.openMainPage(b,c>0);},venueDetails:function(){var e=this;var b=e.getViewPortCntlr().getVenue();e.latLng=b.get("latitude")+","+b.get("longitude");var c="red",d="";var a=b.get("address")+", "+b.get("city")+", "+b.get("state")+", "+b.get("country")+", "+b.get("zipcode");e.markerOptions={markers:"color:"+c+"|label:"+d+"|"+this.latLng,center:e.latLng,title:b.get("name")};e.setAnimationMode(e.self.superclass.self.animationMode.cover);e.pushView(e.getMerchantDetails());},getMainPage:function(){return this.getMain();},openMainPage:function(b,c){var e=this;var d=e.getViewport();e.showFeed=b;if(!c){var a=e.getViewPortCntlr();var f=a.getVenue();if(e.getMainPage()==d.getActiveItem()){e.checkInAccount();}else{e.setAnimationMode(e.self.superclass.self.animationMode.pop);e.pushView(e.getMainPage());}}else{e.fireEvent("backToMain");}console.log("Merchant Account Opened");}});Ext.define("Genesis.controller.client.Badges",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{},xtype:"clientbadgesCntlr",config:{routes:{badges:"mainPage",badgeDesc:"badgeDescPage"},models:["Badge","Customer","Merchant"],refs:{main:{selector:"clientbadgesview",autoCreate:true,xtype:"clientbadgesview"},mainCarousel:"clientbadgesview",badgeDesc:{selector:"promotionalitemview[tag=badgeDesc]",autoCreate:true,tag:"badgeDesc",xtype:"promotionalitemview"}},control:{main:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},badgeDesc:{createView:"onBadgeDescCreateView",activate:"onBadgeDescActivate",deactivate:"onBadgeDescDeactivate"}},listeners:{itemTap:"onItemTap"}},badgeLevelNotAchievedMsg:"You have achieved this badge level yet!",init:function(b){var a=this;a.callParent(arguments);Ext.regStore("BadgeStore",{model:"Genesis.model.Badge",autoLoad:false,sorters:[{property:"rank",direction:"ASC"}],listeners:{scope:a,load:function(e,d,g,c,f){}}});console.log("Badges Init");a.getMain();},onShowView:function(c){if(Ext.os.is("Android")){var b=c.query("carousel")[0];var a=b.getInnerItems();console.debug("Refreshing BadgesPage ...");}},onActivate:function(d,e,a,b){},onDeactivate:function(a,e,d,b){},onBadgeDescCreateView:function(b){var a=this;b.redeemItem=a.redeemItem;},onBadgeDescActivate:function(f,g,b,d){var e=this;var a=f.query("titlebar")[0];f.query("button[tag=back]")[0].show();f.query("button[tag=done]")[0].hide();a.setTitle("Badge Promotion");},onBadgeDescDeactivate:function(d,e,a,b){},onItemTap:function(d){var e=this;var a=e.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);var f=a.getCustomer();var b=d;var h=b.get("rank");var c=Ext.StoreMgr.get("BadgeStore").getById(f.get("badge_id"));var g=c.get("rank");if(h<=g){e.redeemItem=Ext.create("Genesis.model.CustomerReward",{title:b.get("type").display_value,type:{value:"promotion"},photo:{thumbnail_ios_medium:Genesis.view.client.Badges.getPhoto(b.get("type"),"thumbnail_large_url")},time_limited:false,quantity_limited:false,merchant:null});e.redirectTo("badgeDesc");}else{Ext.device.Notification.show({title:"Badges",message:e.badgeLevelNotAchievedMsg});}return false;},badgeDescPage:function(){this.openPage("badgeDesc");},mainPage:function(){this.openPage("main");},openPage:function(a){var b=this;switch(a){case"badgeDesc":b.setAnimationMode(b.self.superclass.self.animationMode.cover);b.pushView(b.getBadgeDesc());break;case"main":b.setAnimationMode(b.self.superclass.self.animationMode.coverUp);b.pushView(b.getMainPage());break;}},getMainPage:function(){var a=this.getMain();return a;},openMainPage:function(){var a=this.getViewPortCntlr();this.setAnimationMode(this.self.superclass.self.animationMode.cover);this.pushView(this.getMainPage());console.log("Badges Page Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.client.Rewards",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{clientRewards_path:"/clientRewards"},xtype:"clientRewardsCntlr",config:{mode:"rewards",models:["PurchaseReward","CustomerReward"],routes:{scanAndWin:"scanAndWinPage",promotion:"promotionPage"},refs:{rewards:{selector:"clientrewardsview",autoCreate:true,xtype:"clientrewardsview"},price:"clientrewardsview textfield",promotion:{selector:"promotionalitemview[tag=promotion]",autoCreate:true,tag:"promotion",xtype:"promotionalitemview"},pDoneBtn:"promotionalitemview[tag=promotion] button[tag=done]"},control:{rewards:{activate:"onActivate",deactivate:"onDeactivate"},promotion:{createView:"onPromotionCreateView",activate:"onPromotionActivate",deactivate:"onPromotionDeactivate"},pDoneBtn:{tap:"onPromotionDoneTap"}}},missingEarnPtsCodeMsg:"No Authorization Code was found.",checkinFirstMsg:"Please Check-In before earning rewards",authCodeReqMsg:"Proceed to scan an Authorization Code from your server to earn Reward Pts!",signupPageTitle:"Signup Reward",signupPromotionTitle:"Welcome!",referralPageTitle:"Refer A Friend",referralPromotionTitle:"Referral Award",prizeCheckMsg:"Play our Instant Win Game to find out how many Prize Pts you won!",earnPtsMsg:"Updating Points Earned ...",signupPromotionMsg:function(a){return"You've earned "+a+" Reward Pts from Signing Up with this Merchant!";},getPointsMsg:function(a){var d=this;var b=a.points;var c=a.referral_points;return"You've earned "+b+" Reward Pts from this purchase."+((c>0)?"":" "+d.prizeCheckMsg);},getReferralMsg:function(a){return this.getVipMsg(a);},getVipMsg:function(a){return("You've earned an additional "+Genesis.constants.addCRLF()+a+" Reward Pts!"+Genesis.constants.addCRLF()+this.prizeCheckMsg);},vipPopUp:function(a,b){b=b||Ext.emptyFn;Ext.device.Notification.show({title:"VIP Challenge",message:this.getVipMsg(a),callback:b});},init:function(){this.callParent(arguments);console.log("Client Rewards Init");this.callBackStack={callbacks:["signupPromotionHandler","earnPtsHandler","referralPromotionHandler","scanAndWinHandler"],arguments:[],startIndex:0};this.getRewards();},onScannedQRcode:function(b){var a=this;if(b){a.qrcode=b;switch(a.getMode()){case"rewardsSC":a.onLocationUpdate();break;default:a.getGeoLocation();break;}}else{console.debug(a.missingEarnPtsCodeMsg);Ext.device.Notification.show({title:"Error",message:a.missingEarnPtsCodeMsg,callback:function(){}});}},onLocationUpdate:function(c){var d=this;var b=d.getViewPortCntlr();var f=(!c)?null:b.getVenue().getId();var a=PurchaseReward.getProxy().getReader();var e={data:d.qrcode,latitude:(c)?c.coords.getLatitude():0,longitude:(c)?c.coords.getLongitude():0};if(f){e=Ext.apply(e,{venue_id:f});}PurchaseReward.setEarnPointsURL();a.setRootProperty("");a.buildExtractors();Ext.Viewport.setMasked({xtype:"loadmask",message:d.earnPtsMsg});PurchaseReward.load(1,{jsonData:{},params:e,callback:function(g,h){a.setRootProperty("data");a.buildExtractors();Ext.Viewport.setMasked(false);if(h.wasSuccessful()){d.fireEvent("triggerCallbacksChain");}}});delete d.qrcode;},promotionHandler:function(e,g,b){var d=this;var c=d.getViewport();var f=d.getPromotion();d.promoteCount++;d.redeemItem=Ext.create("Genesis.model.CustomerReward",{title:null,type:{value:"promotion"},photo:{thumbnail_ios_medium:Genesis.constants.getIconPath("prizewon","reward")},points:b,time_limited:false,quantity_limited:false,merchant:null});var a=f.query("titlebar")[0];a.setTitle(e);d.redirectTo("promotion");},signupPromotionHandler:function(b,e,c,g){var f=this;var d=b.reward_info;var i=f.getViewport();var h=d.signup_points;var a=Ext.isDefined(h)&&(h>0);f.promoteCount=0;if(a){f.promotionHandler(f.signupPageTitle,f.signupPromotionTitle,h);Ext.device.Notification.show({title:"Signup Promotion Alert!",message:f.signupPromotionMsg(h)});}return a;},earnPtsHandler:function(a,d,f,e){var b=this;var c=a.reward_info;Ext.device.Notification.show({title:"Rewards",message:b.getPointsMsg(c),callback:function(){b.fireEvent("triggerCallbacksChain");}});return true;},referralPromotionHandler:function(a,f,h,g){var c=this;var e=a.reward_info;var b=e.referral_points;var d=Ext.isDefined(b)&&(b>0);if(d){c.promotionHandler(c.referralPageTitle,c.referralPromotionTitle,b);Ext.device.Notification.show({title:"Referral Challenge",message:c.getReferralMsg(b)});}return d;},scanAndWinHandler:function(a,c,e,d){var b=this;if(b.promoteCount>0){console.debug("Removing Promotion View from History ...");b.silentPopView(1);}b.promoteCount=0;if(d>0){Genesis.db.removeReferralDBAttrib("m"+d);}b.redirectTo("scanAndWin");return false;},startRouletteScreen:function(){var a=this.getRewards();var b=Ext.get(Ext.DomQuery.select("div.rouletteTable",a.element.dom)[0]);b.addCls("spinFwd");var c=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);c.addCls("spinBack");},onEarnPtsSC:function(){var a=this;Ext.device.Notification.show({title:"Rewards",message:a.authCodeReqMsg,buttons:["OK","Cancel"],callback:function(b){if(b.toLowerCase()=="ok"){a.scanQRCode();}}});},onEarnPts:function(){var c=this;var b=c.isOpenAllowed();if(b!==true){Ext.device.Notification.show({title:"Error",message:b});return;}else{var a=Ext.bind(c.onEarnPtsSC,c);c.checkReferralPrompt(a,a);}},updateMetaDataInfo:function(c){var d=this;var a=d.getViewPortCntlr();var e=d.callParent(arguments);var g=a.getVenue();var f=c.merchant_id||g.getMerchant().getId();d.callBackStack["arguments"]=[c,e,g,f];if(c.data){var b=d.getApplication().getController("client.Prizes");b.fireEvent("showQRCode",0,c.data);}},onActivate:function(f,g,b,d){var e=this;var a=e.callBackStack["arguments"][0];Ext.defer(function(){var i=e.getRewards();var c=e.getViewPortCntlr();var j=e.getApplication();var h=j.getController("client.Prizes");e.startRouletteScreen();Genesis.controller.ControllerBase.playSoundFile(c.sound_files.rouletteSpinSound,function(){console.debug("RouletteSound Done, checking for prizes ...");h.fireEvent("prizecheck",a);});},1,f);},onDeactivate:function(a,e,d,b){},onContainerActivate:function(e,d,a,b){},onPromotionCreateView:function(b){var a=this;b.redeemItem=a.redeemItem;},onPromotionActivate:function(d,e,a,b){},onPromotionDeactivate:function(d,e,a,b){},onPromotionDoneTap:function(a,f,c){console.debug("Closing Promotional Page");var d=this;d.fireEvent("triggerCallbacksChain");},scanAndWinPage:function(){var a=this;this.openPage("scanAndWin");},promotionPage:function(){var a=this;this.openPage("promotion");},getMainPage:function(){var a=this.getRewards();return a;},openPage:function(a){var d=this;var c=d.getViewport();d.setMode(a);switch(a){case"scanAndWin":d.setAnimationMode(d.self.superclass.self.animationMode.coverUp);d.pushView(d.getRewards());break;case"rewardsSC":d.onEarnPtsSC();break;case"rewards":d.onEarnPts();break;case"promotion":var f=d.getPromotion();if(c.getActiveItem()==f){var b=c.getEventDispatcher().controller;var e=new Ext.fx.layout.Card(d.self.superclass.self.animationMode.fade);e.on("animationend",function(){console.debug("Animation Complete");e.destroy();},d);console.log("Reloading Promotion Page");c.animateActiveItem(f,e);e.onActiveItemChange(c.getLayout(),f,f,null,b);c.doSetActiveItem(f,null);}else{d.setAnimationMode(d.self.superclass.self.animationMode.coverUp);d.pushView(d.getPromotion());}break;}},isOpenAllowed:function(){var b=this.getViewPortCntlr();var a=b.getCheckinInfo().venue;var c=b.getVenue();return((a&&c&&(a.getId()==c.getId()))?true:this.checkinFirstMsg);}});Ext.define("Genesis.controller.client.RedeemBase",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{},xtype:"clientRedemptionsBaseCntlr",config:{models:["PurchaseReward","CustomerReward"],},needPointsMsg:function(a){return("You need "+a+" more points "+Genesis.constants.addCRLF()+"to be eligible for this item.");},retrievingQRCodeMsg:"Retrieving QRCode ...",showQrCodeMsg:"Show this Authorization Code to your server to redeem!",redeemItemConfirmMsg:"Please confim to redeem this item",init:function(){var a=this;Ext.regStore(a.getRenderStore(),{model:"Genesis.model.Customer",autoLoad:false});Ext.regStore(a.getRedeemStore(),{model:"Genesis.model.CustomerReward",autoLoad:false,pageSize:5,sorters:[{property:"points",direction:"ASC"}],listeners:{scope:a,metachange:function(b,d,c){if(b.isLoading()){a.fireEvent("updatemetadata",d.getReader().metaData);}}}});this.callParent(arguments);console.log("Client Redemptions Init");Ext.defer(function(){a.getRedeemItem();a.getRedemptions();},1,a);},onCreateView:function(b){var a=this;b.redeemItem=a.redeemItem;},onShowView:function(c){if(Ext.os.is("Android")){var a=this.getEventDispatcher().getPublishers()["elementSize"].monitors;var b=c.query("list[tag="+c.getListCls()+"]")[0];console.debug("Refreshing RenderStore ...");c.query("dataview[tag=ptsEarnPanel]")[0].refresh();a[b.container.getId()].forceRefresh();}},onActivate:function(e,l,p,h){var m=this;var k=m.getRedemptions();var j=m.getViewPortCntlr();var g=j.getCustomer();var n=Ext.StoreMgr.get(m.getRenderStore());var f=j.getCheckinInfo().venue;var b=j.getVenue();var a=b.getId();var o=b.getMerchant().getId();m.exploreMode=!f||(f&&(f.getId()!=b.getId()));if(g!=n.getRange()[0]){n.setData(g);}for(var d=0;d<e.getInnerItems().length;d++){}console.debug("ReedeemBase: onActivate");},onDeactivate:function(a,e,d,b){},onItemListSelect:function(c,a,b){c.deselect([a]);this.onItemListDisclose(c,a);return false;},onItemListDisclose:function(f,a,c,b,d,g){var i=this;var h=i.getViewPortCntlr();var j=function(){var e=h.getCustomer().get(i.getPtsProperty());var k=a.get("points");if(k>e){Ext.device.Notification.show({title:"Oops!",message:i.needPointsMsg(k-e)});}else{i.fireEvent("showredeemitem",a);}};Genesis.controller.ControllerBase.playSoundFile(h.sound_files.clickSound);switch(i.getBrowseMode()){case"redeemBrowse":if(!i.exploreMode){j();}else{Ext.device.Notification.show({title:"Warning",message:i.checkinFirstMsg});}break;case"redeemBrowseSC":j();break;}return true;},updateMetaDataInfo:function(a){var b=this;var c=b.callParent(arguments);if(a.data){b.fireEvent("showQRCode",0,a.data);}return c;},onRedeemItemTap:function(l,h,i,n){var j=this,c=null;var k=j.getRedeemMainPage();var m=k.query("titlebar")[0].getTitle();var a=l;switch(j.getRedeemMode()){case"redeemPrize":case"redeemReward":var d=j.getBrowseMode()=="redeemBrowseSC";var g=j.getViewPortCntlr();c=g.getVenue();var f=g.getCheckinInfo().venue;if(!d&&(!f||!c||(c.getId()!=f.getId()))){Ext.device.Notification.show({title:m,message:j.checkinFirstMsg});}else{Ext.device.Notification.show({title:m,message:j.redeemItemConfirmMsg,buttons:["Confirm","Cancel"],callback:function(e){if(e.toLowerCase()=="confirm"){j.fireEvent("redeemitem",a,c,k);}}});}break;}},onRedeemItem:function(c,g,a){var e=this;var f=(g)?g.getId():0;var d=a.getInnerItems()[0];var b=e.getRedeemStore();CustomerReward[e.getRedeemPointsFn()](d.getStore().first().getId());c.hide();Ext.Viewport.setMasked({xtype:"loadmask",message:e.retrievingQRCodeMsg});Ext.StoreMgr.get(b).load({addRecords:true,scope:e,jsonData:{},params:{venue_id:f},callback:function(i,h){if(!h.wasSuccessful()){Ext.Viewport.setMasked(false);c.show();}}});},onRedeemItemCreateView:function(c){var b=this;var a=b.getRedeemMainPage();a.redeemItem=b.redeemItem;},onRedeemItemActivate:function(h,i,d,f){var g=this;var a=g.getViewPortCntlr();var b=h.query("titlebar")[0];var e=g.redeemItem.get("photo");g.getSCloseBB().show();b.setTitle(g.getTitle());b.removeCls("kbTitle");g.getRefreshBtn()["hide"]();g.getVerifyBtn()["hide"]();g.getSRedeemBtn().show();console.log("RewardItem View - Updated RewardItem View.");},onRedeemItemDeactivate:function(a,f,e,b){var d=this;d.getSDoneBtn().hide();},onDoneTap:function(a,i,d,h,g){var f=this;var c=f.getRedeemMainPage();if(c.isPainted()&&!c.isHidden()){f.popView();}},onShowItemQRCode:function(c,b){var a=this;var e="Redeem "+a.getTitle();console.log("\nEncrypted Code :\n"+b+"\nEncrypted Code Length: "+b.length);b=Genesis.controller.ControllerBase.genQRCode(b);if(b[0]){var d=Ext.DomQuery.select("div.itemPoints",a.getRedeemItem().element.dom)[0];a.getSRedeemBtn().hide();a.getSDoneBtn().show();a.getSCloseBB().hide();if(d){Ext.fly(d).addCls("x-item-hidden");}a.fireEvent("refreshQRCode",b);Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:e,message:a.showQrCodeMsg});Ext.device.Notification.vibrate();}},onRefreshQRCode:function(b){var e=this;var a=e.getRedeemMainPage();var g=a.query("carousel")[0];var d=g?g.getActiveItem():a.getInnerItems()[0];var f=d.query("component[tag=info]")[0];f.hide();var c=d.query("component[tag=itemPhoto]")[0];c.element.setStyle({"background-image":"url("+b[0]+")","background-size":Genesis.fn.addUnit(b[1]*1.5)+" "+Genesis.fn.addUnit(b[2]*1.5)});c.element.setHeight("16em");},redeemBrowsePage:function(){this.openPage("redeemBrowse");this.getCloseBtn().show();this.getBackBtn().hide();},redeemBrowseSCPage:function(){this.openPage("redeemBrowseSC");this.getCloseBtn().hide();this.getBackBtn().show();},getRedeemMainPage:function(){var a=this;var b=null;switch(a.getRedeemMode()){case"redeemPrize":case"redeemReward":a.setAnimationMode(Genesis.controller.ControllerBase.animationMode.coverUp);b=a.getRedeemItem();break;}return b;},getBrowseMainPage:function(){var a=this;var b=null;switch(a.getBrowseMode()){case"redeemBrowse":a.setAnimationMode(Genesis.controller.ControllerBase.animationMode.cover);b=a.getRedemptions();break;case"redeemBrowseSC":a.setAnimationMode(Genesis.controller.ControllerBase.animationMode.coverUp);b=a.getRedemptions();break;}return b;},openPage:function(a){var b=this;if(a.match(/Browse/)){b.setBrowseMode(a);b.pushView(b.getBrowseMainPage());}else{b.setRedeemMode(a);b.pushView(b.getRedeemMainPage());}},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.client.Redemptions",{extend:"Genesis.controller.client.RedeemBase",requires:["Ext.data.Store"],statics:{clientRedemption_path:"/clientRedemptions"},xtype:"clientRedemptionsCntlr",controllerType:"redemption",config:{browseMode:"redeemBrowse",redeemMode:"redeemReward",renderStore:"RedemptionRenderCStore",redeemStore:"RedeemStore",redeemPointsFn:"setRedeemPointsURL",redeemUrl:"setGetRewardsURL",redeemPath:"redeemBrowseRewardsSC",ptsProperty:"points",title:"Rewards",routes:{redemptions:"redeemBrowsePage",redeemRewardsChooseSC:"redeemChooseSCPage",redeemBrowseRewardsSC:"redeemBrowseSCPage",redeemReward:"redeemItemPage"},refs:{backBtn:"clientredemptionsview button[tag=back]",closeBtn:"clientredemptionsview button[tag=close]",redemptions:{selector:"clientredemptionsview",autoCreate:true,xtype:"clientredemptionsview"},redemptionsList:"clientredemptionsview list[tag=redemptionsList]",redemptionsPts:"clientredemptionsview component[tag=points]",redemptionsPtsEarnPanel:"clientredemptionsview dataview[tag=ptsEarnPanel]",sCloseBB:"showredeemitemdetailview[tag=redeemReward] button[tag=close]",sDoneBtn:"showredeemitemdetailview[tag=redeemReward] button[tag=done]",sRedeemBtn:"showredeemitemdetailview[tag=redeemReward] button[tag=redeem]",refreshBtn:"showredeemitemdetailview[tag=redeemReward] button[tag=refresh]",verifyBtn:"showredeemitemdetailview[tag=redeemReward] button[tag=verify]",redeemItem:{selector:"showredeemitemdetailview[tag=redeemReward]",autoCreate:true,tag:"redeemReward",xtype:"showredeemitemdetailview"}},control:{redemptions:{createView:"onCreateView",showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},redemptionsList:{select:"onItemListSelect"},sDoneBtn:{tap:"onDoneTap"},sRedeemBtn:{tap:"onRedeemItemTap"},redeemItem:{createView:"onRedeemItemCreateView",activate:"onRedeemItemActivate",deactivate:"onRedeemItemDeactivate"},verifyBtn:{tap:"popView"}},listeners:{redeemitem:"onRedeemItem",showredeemitem:"onShowRedeemItem",showQRCode:"onShowItemQRCode",refreshQRCode:"onRefreshQRCode"}},checkinFirstMsg:"Please Check-In before redeeming Rewards",onShowRedeemItem:function(a){var b=this;b.redeemItem=a;b.redirectTo("redeemReward");},redeemChooseSCPage:function(){var a=this.getApplication().getController("client.Accounts");a.redeemRewardsChooseSCPage();},redeemItemPage:function(){this.openPage("redeemReward");},});Ext.define("Genesis.controller.client.Accounts",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{accounts_path:"/accounts"},xtype:"accountsCntlr",config:{mode:"profile",routes:{accounts:"mainPage",etransfer:"emailTransferPage",transfer:"transferPage",selectTransfer:"selectTransferPage",transferComplete:"transferCompletePage",},refs:{aBB:"clientaccountsview button[tag=back]",avBB:"clientaccountsview button[tag=vback]",accounts:{selector:"clientaccountsview",autoCreate:true,xtype:"clientaccountsview"},accountsList:"clientaccountsview list[tag=accountsList]",venuesList:"clientaccountsview list[tag=venuesList]",transferHdr:"clientaccountsview toolbar[tag=transferHdr]",atrCloseBB:"clientaccountstransferview button[tag=close]",atrCalcCloseBB:"clientaccountstransferview button[tag=calcClose]",atrBB:"clientaccountstransferview button[tag=back]",transferPage:{selector:"clientaccountstransferview",autoCreate:true,xtype:"clientaccountstransferview"},points:"clientaccountstransferview textfield",qrcode:"clientaccountstransferview component[tag=qrcode]",title:"clientaccountstransferview component[tag=title]",transferContainer:"clientaccountstransferview"},control:{accounts:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate",activeitemchange:"onItemChangeActivate"},accountsList:{select:"onSelect"},venuesList:{select:"onVenueSelect"},"clientaccountstransferview button[tag=transfer]":{select:"onTransferTap"},avBB:{tap:"onAvBBTap"},transferPage:{activate:"onTransferActivate",deactivate:"onTransferDeactivate"},"clientaccountstransferview container[tag=accountsTransferMode] list":{select:"onTransferSelect"},"clientaccountstransferview container[tag=dialpad] button":{tap:"onCalcBtnTap"},"clientaccountstransferview button[tag=showQrCode]":{tap:"onShowQrCodeTap"},"clientaccountstransferview container button[tag=done]":{tap:"onTransferCompleteTap"},atrCalcCloseBB:{tap:"onTransferCompleteTap"}},listeners:{selectMerchant:"onDisclose"}},qrcodeRegExp:/%qrcode_image%/,noTransferCodeMsg:"No Transfer Code was scanned",pointsReqMsg:"Points are required for transfer",startTransferMsg:"Prepare to scan the Sender's Transfer Code",transferFailedMsg:"Transfer operation did not complete",transferSavedMsg:"Transfer messasge was saved, but not sent.",transferSuccessMsg:function(){return"Your account information won't be updated until your next check-in.";},xferWithinRangeMsg:function(b,a){return"Please enter a value between "+b+" and "+a;},noPtsXferMsg:function(){return"No Points were transferred."+Genesis.constants.addCRLF()+"Please Try Again.";},recvTransferMsg:function(a,b){return"We have added "+a+" points "+Genesis.constants.addCRLF()+"towards your account at "+Genesis.constants.addCRLF()+b+"!";},xferCodeRecv:false,init:function(){var a=this;this.callParent(arguments);console.log("Accounts Init");a.callBackStack={callbacks:["onXferCodeRecv"],arguments:[],startIndex:0};a.getAccounts();backBtnCallbackListFn.push(function(d){var c=(d==a.getAccounts());if(c&&(d.getActiveItem()!=a.getAccountsList())){var b=a.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(b.sound_files.clickSound);d.setActiveItem(0);return true;}return false;});},onScannedQRcode:function(d){var c=this;var b=c.getViewport();var a=Ext.StoreMgr.get("CustomerStore");if(d){Ext.Viewport.setMasked({xtype:"loadmask",message:c.updatingServerMsg});Customer.setRecvPtsXferUrl();a.load({addRecords:true,jsonData:{},params:{data:d},callback:function(g,f){Ext.Viewport.setMasked(false);if(f.wasSuccessful()){var e=Customer.getProxy().getReader().metaData;Ext.device.Notification.show({title:"Transfer Received",message:c.recvTransferMsg(e.points,g[0].getMerchant().get("name")),callback:function(h){c.resetView();c.redirectTo("accounts");}});c.persistSyncStores("CustomerStore");}}});}else{console.debug(c.noCodeScannedMsg);Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:c.noCodeScannedMsg});}},onLocationUpdate:function(a){var c=this;var e=c.merchantId;var d=Ext.StoreMgr.get("VenueStore");var b=d.getProxy();if(a){Venue.setFindNearestURL();d.load({scope:c,params:{merchant_id:e,latitude:a.coords.getLatitude(),longitude:a.coords.getLongitude()},callback:function(h,g){Ext.Viewport.setMasked(false);if(g.wasSuccessful()){console.debug("Found "+h.length+" venues matching current location ...");if(h.length>1){var f=c.getAccounts();if(!f.isPainted()||f.isHidden()){console.debug("Opening Accounts Page ...");f.on("showView",function(){this.setActiveItem(1);},f,{single:true});c.redirectTo("accounts");}else{f.setActiveItem(1);}}else{c.getVenueMetaData(h[0]);}}else{b.supressErrorsPopup=true;Ext.device.Notification.show({title:"Error",message:c.missingVenueInfoMsg,callback:function(){b.supressErrorsPopup=false;}});}}});}},onShowView:function(c){if(Ext.os.is("Android")){var a=this.getEventDispatcher().getPublishers()["elementSize"].monitors;var b=c.query("list[tag=accountsList]")[0];console.debug("Refreshing CustomerStore ...");a[b.container.getId()].forceRefresh();}else{c.query("list[tag=accountsList]")[0].refresh();}},onActivate:function(h,i,b,d){var e=this;var g=e.getMode();var a=h.query("titlebar")[0];h.mode=g;switch(g){case"profile":a.setTitle("Accounts");a.removeCls("kbTitle");break;case"redeemRewardsProfile":a.setTitle("Rewards");a.removeCls("kbTitle");break;case"redeemPrizesProfile":a.setTitle("Prizes");a.removeCls("kbTitle");break;case"emailtransfer":case"transfer":a.setTitle(" ");a.addCls("kbTitle");var f=e.getTransferHdr();h.showTransferHdr=true;if(f){f.show();}break;}if(h.getInnerItems().length>0){h.setActiveItem(0);}},onDeactivate:function(a,f,e,b){var d=this;d.getTransferHdr().hide();},onSelect:function(c,a,b){c.deselect([a]);this.onDisclose(c,a);return false;},onDisclose:function(f,a,c,b,d,g){var h=this;var i=a.getId();var j=h.getViewport();Genesis.controller.ControllerBase.playSoundFile(h.getViewPortCntlr().sound_files.clickSound);h.merchantId=a.getMerchant().getId();h.rec=a;switch(h.getMode()){case"profile":case"redeemRewardsProfile":case"redeemPrizesProfile":Ext.Viewport.setMasked({xtype:"loadmask",message:h.getMerchantInfoMsg});h.getGeoLocation();break;case"emailtransfer":case"transfer":if(a.get("points")<1){Ext.device.Notification.show({title:"Points Required",message:h.pointsReqMsg,});return;}h.silentPopView(2);h.redirectTo("transferComplete");break;}},onAvBBTap:function(a,d,c){this.getAccounts().setActiveItem(0);},onVenueSelect:function(c,a,b){c.deselect([a]);this.onVenueDisclose(c,a);return false;},getVenueMetaData:function(b){var h=this;var c=b.getId();var g=h.getViewPortCntlr();var f=h.getApplication().getController("client.Checkins");var d=h.rec;var i,a,e;Ext.Viewport.setMasked({xtype:"loadmask",message:h.getVenueInfoMsg});switch(h.getMode()){case"redeemPrizesProfile":e=h.getApplication().getController("client.Prizes");break;case"redeemRewardsProfile":e=h.getApplication().getController("client.Redemptions");break;case"profile":default:g.setVenue(b);var f=h.getApplication().getController("client.Checkins");f.fireEvent("checkin");return;break;}i=Ext.StoreMgr.get(e.getRedeemStore());a=e.getRedeemUrl();path=e.getRedeemPath();CustomerReward[a]();i.load({jsonData:{},params:{venue_id:c},scope:h,callback:function(l,k){if(k.wasSuccessful()){var j={venue_id:c};for(var m=0;m<l.length;m++){l[m].handleInlineAssociationData({merchant:b.getMerchant().raw});}g.setVenue(b);switch(h.getMode()){case"redeemRewardsProfile":case"redeemPrizesProfile":default:f.fireEvent("checkinMerchant","redemption",j,c,d,k,Ext.emptyFn);h.redirectTo(path);break;}delete h.rec;}else{if(!k.wasSuccessful()&&!j){Ext.Viewport.setMasked(false);console.log(h.metaDataMissingMsg);}}}});},onVenueDisclose:function(g,b,i,c,h,d){var f=this;var a=f.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);f.getVenueMetaData(b);},onItemChangeActivate:function(h,g,b,d){var e=this;var a=e.getAccounts();var f=a.getLayout().getAnimation();if(Ext.isObject(g)){switch(g.config.tag){case"accountsList":f.setReverse(true);e.getABB().show();e.getAvBB().hide();break;case"venuesList":f.setReverse(false);e.getABB().hide();e.getAvBB().show();break;}console.debug("Accounts onItemChangeActivate["+g.config.tag+"] Called.");}},onXferCodeRecv:function(b){var e=this;switch(e.getMode()){case"transfer":e.xferCodeRecv=true;var a=e.getTransferContainer();var g=Genesis.controller.ControllerBase.genQRCode(b.data);var d=b.points||e.getPoints().getValue();console.debug("\nPoints - "+d);if(g[0]){e.getQrcode().setStyle({"background-image":"url("+g[0]+")","background-size":Genesis.fn.addUnit(g[1]*1.25)+" "+Genesis.fn.addUnit(g[2]*1.25)});e.getTitle().setData({points:d+" Pts"});a.setActiveItem(2);}Ext.Viewport.setMasked(false);break;case"emailtransfer":var g=b.data["qrcode"];var f=b.data["body"];var c=b.data["subject"];console.debug("\nSubject - "+c+"\n");g=Genesis.controller.ControllerBase.genQRCode(g)[0].replace("data:image/gif;base64,","");window.plugins.emailComposer.showEmailComposerWithCB(function(h){Ext.defer(function(){Ext.Viewport.setMasked(false);switch(h){case EmailComposer.ComposeResultType.Failed:case EmailComposer.ComposeResultType.NotSent:case EmailComposer.ComposeResultType.Cancelled:Ext.device.Notification.show({title:"Transfer Failed",message:e.transferFailedMsg,callback:function(){}});break;case EmailComposer.ComposeResultType.Saved:e.onTransferCompleteTap();Ext.device.Notification.show({title:"Trasfer Deferred",message:e.transferSavedMsg});break;case EmailComposer.ComposeResultType.Sent:e.xferCodeRecv=true;e.onTransferCompleteTap();break;}},1,e);},c,f,null,null,null,true,[g]);break;}return false;},onTransferActivate:function(g,h,b,e){var f=this;var d=0;var a=f.getTransferContainer();switch(f.getMode()){case"redeemRewardsProfile":case"redeemPrizesProfile":case"profile":f.getAtrCloseBB().hide();f.getAtrCalcCloseBB().hide();f.getAtrBB().show();break;case"emailtransfer":case"transfer":f.getAtrCloseBB().hide();f.getAtrCalcCloseBB().show();f.getAtrBB().hide();if(b&&(b==f.getAccounts()&&!f.rec)){f.setMode("profile");}else{if(f.getPoints()){f.getPoints().setValue(null);}d=1;}break;}},onTransferDeactivate:function(b,g,f,d){var e=this;var a=e.getTransferContainer();if(a){a.setActiveItem(0);}},onTransferTap:function(a,d,c){},onTransferSelect:function(e,b,c){var d=this;var a=d.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(a.sound_files.clickSound);e.deselect([b]);delete d.merchantId;delete d.rec;switch(b.get("tag")){case"sender":d.setMode("transfer");d.redirectTo("selectTransfer");break;case"emailsender":d.setMode("emailtransfer");d.redirectTo("selectTransfer");break;case"recipient":d.setMode("profile");Ext.device.Notification.show({title:"Start Transfer",message:d.startTransferMsg,buttons:["Proceed","Cancel"],callback:function(f){if(f.toLowerCase()=="proceed"){d.scanQRCode();}}});break;}return false;},onCalcBtnTap:function(h,a,c,i){var f=this;var d=f.getViewPortCntlr();var j=h.getText();var g=f.getPoints();var k=g.getValue()||"0";if(k.length<8){switch(j){case"AC":k=null;break;default:k=(k!="0")?k.concat(j):j;break;}g.setValue(k);}},onShowQrCodeTap:function(a,j,d,i){var h=this;var c=Ext.StoreMgr.get("CustomerStore");var g=h.getPoints().getValue();var f;if((Number(g)>0)&&(Number(g)<=h.rec.get("points"))){switch(h.getMode()){case"transfer":f="direct";Ext.Viewport.setMasked({xtype:"loadmask",message:h.genQRCodeMsg});break;case"emailtransfer":f="email";Ext.Viewport.setMasked({xtype:"loadmask",message:h.retrieveAuthModeMsg});break;}Customer.setSendPtsXferUrl();c.load({addRecords:true,jsonData:{},params:{merchant_id:h.merchantId,points:g,type:f},callback:function(k,e){var b=c.getProxy().getReader().metaData;if(e.wasSuccessful()&&(!b.data)){Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:h.noPtsXferMsg()});}}});}else{Ext.device.Notification.show({title:"Error",message:h.xferWithinRangeMsg(1,h.rec.get("points"))});}},onTransferCompleteTap:function(a,h,d,g){var f=this;var c=function(){f.popView();};f.setMode("profile");if(f.xferCodeRecv){Ext.device.Notification.show({title:"Transfer Success!",message:f.transferSuccessMsg(),callback:c});}else{c();}f.xferCodeRecv=false;},mainPage:function(){this.openPage("profile");},emailTransferPage:function(){this.openPage("emailtransfer");},transferPage:function(){this.openPage("transfer");},selectTransferPage:function(){this.openMainPage();},transferCompletePage:function(){var b=this;var a=b.getTransferContainer();a.setActiveItem(1);b.setAnimationMode(b.self.superclass.self.animationMode.coverUp);b.pushView(b.getTransferPage());},redeemRewardsChooseSCPage:function(){this.openPage("redeemRewardsProfile");},redeemPrizesChooseSCPage:function(){this.openPage("redeemPrizesProfile");},openPage:function(a){var b=this,c;b.setAnimationMode(b.self.superclass.self.animationMode.cover);switch(a){case"emailtransfer":case"transfer":b.setMode("profile");c=b.getTransferPage();break;case"redeemPrizesProfile":case"redeemRewardsProfile":case"profile":default:b.setMode(a);c=b.getMainPage();break;}b.pushView(c);},getMainPage:function(){var a=this.getAccounts();return a;},openMainPage:function(){this.pushView(this.getMainPage());console.log("Accounts Page Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.client.JackpotWinners",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{},xtype:"clientJackpotWinnersCntlr",config:{routes:{"jackpotWinners/:id":"mainPage",},models:["frontend.JackpotWinner"],refs:{main:{selector:"clientjackpotwinnersview",autoCreate:true,xtype:"clientjackpotwinnersview"}},control:{main:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"}},listeners:{reload:"onReload"}},init:function(b){var a=this;a.callParent(arguments);Ext.regStore("JackpotWinnerStore",{model:"Genesis.model.frontend.JackpotWinner",autoLoad:false,pageSize:5,sorters:[{property:"date",direction:"DESC"}],listeners:{scope:a,load:function(e,d,g,c,f){}}});console.log("JackpotWinners Init");a.getMain();},onReload:function(){var a=this;JackpotWinner.setGetJackpotWinnersUrl();Ext.StoreMgr.get("JackpotWinnerStore").load({jsonData:{},params:{merchant_id:a.merchantId},callback:function(c,b){}});},onShowView:function(c){if(Ext.os.is("Android")){var a=this.getEventDispatcher().getPublishers()["elementSize"].monitors;var b=c.query("list[tag=jackpotWinnersList]")[0];console.debug("Refreshing RenderStore ...");a[b.container.getId()].forceRefresh();}},onActivate:function(d,e,a,b){},onDeactivate:function(a,e,d,b){},mainPage:function(a){this.openPage("main",a);},openPage:function(a,c){var b=this;switch(a){case"main":b.merchantId=c;b.setAnimationMode(b.self.superclass.self.animationMode.coverUp);b.pushView(b.getMainPage());b.onReload();break;}},getMainPage:function(){var a=this.getMain();return a;},openMainPage:function(){var a=this;a.setAnimationMode(a.self.superclass.self.animationMode.coverUp);a.pushView(a.getMainPage());console.log("Jackpot Winners Page Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.client.Prizes",{extend:"Genesis.controller.client.RedeemBase",requires:["Ext.data.Store","Genesis.view.client.Prizes","Genesis.view.client.Badges"],statics:{clientRedemption_path:"/clientPrizes",prizes_path:"/prizes"},xtype:"clientPrizesCntlr",controllerType:"prize",config:{timeoutPeriod:10,minPrizePts:1,browseMode:"redeemBrowse",redeemMode:"redeemPrize",renderStore:"PrizeRenderCStore",redeemStore:"PrizeStore",redeemPointsFn:"setRedeemPrizePointsURL",redeemUrl:"setGetPrizesURL",redeemPath:"redeemBrowsePrizesSC",ptsProperty:"prize_points",title:"Prizes",routes:{prizes:"redeemBrowsePage",redeemPrizesChooseSC:"redeemChooseSCPage",redeemBrowsePrizesSC:"redeemBrowseSCPage",redeemPrize:"redeemItemPage",badgeDetail:"badgeDetailPage"},refs:{backBtn:"clientprizesview button[tag=back]",closeBtn:"clientprizesview button[tag=close]",redemptions:{selector:"clientprizesview",autoCreate:true,xtype:"clientprizesview"},redemptionsList:"clientprizesview list[tag=prizesList]",redemptionsPts:"clientprizesview component[tag=points]",redemptionsPtsEarnPanel:"clientprizesview dataview[tag=ptsEarnPanel]",sCloseBB:"showredeemitemdetailview[tag=redeemPrize] button[tag=close]",sDoneBtn:"showredeemitemdetailview[tag=redeemPrize] button[tag=done]",sRedeemBtn:"showredeemitemdetailview[tag=redeemPrize] button[tag=redeem]",refreshBtn:"showredeemitemdetailview[tag=redeemPrize] button[tag=refresh]",verifyBtn:"showredeemitemdetailview[tag=redeemPrize] button[tag=verify]",redeemItem:{selector:"showredeemitemdetailview[tag=redeemPrize]",autoCreate:true,tag:"redeemPrize",xtype:"showredeemitemdetailview"},prizeCheckScreen:"clientrewardsview",badgeDetail:{selector:"promotionalitemview[tag=badgeDetail]",autoCreate:true,tag:"badgeDetail",xtype:"promotionalitemview"},bDoneBtn:"promotionalitemview[tag=badgeDetail] button[tag=done]"},control:{redemptions:{createView:"onCreateView",showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},redemptionsList:{select:"onItemListSelect"},sDoneBtn:{tap:"onDoneTap"},sRedeemBtn:{tap:"onRedeemItemTap"},redeemItem:{createView:"onRedeemItemCreateView",activate:"onRedeemItemActivate",deactivate:"onRedeemItemDeactivate"},badgeDetail:{activate:"onBadgeDetailActivate",deactivate:"onBadgeDetailDeactivate"},bDoneBtn:{tap:"onBadgeDetailDoneTap"}},listeners:{prizecheck:"onPrizeCheck",redeemitem:"onRedeemItem",showredeemitem:"onShowRedeemItem",showredeemprize:"onShowRedeemPrize",showQRCode:"onShowItemQRCode",refreshQRCode:"onRefreshQRCode"}},checkinFirstMsg:"Please Check-In before redeeming Prizes",eligibleRewardMsg:"Check out an Eligible Prize you can redeem with your Prize Points!",scanPlayTitle:"Scan and Play",evtFlag:0,flag:0,loadCallback:null,initSound:false,authRewardVerifiedMsg:"Verified",updateOnFbMsg:"Would you like to friends on Facebook about it?",wonPrizeMsg:function(a){var d=this;var b=a.prize_points;var c=a.badge_prize_points;return(((b>d.getMinPrizePts())?"You've won a JACKPOT of"+Genesis.constants.addCRLF()+b+" Prize Points!":d.gotMinPrizePtsMsg(b))+((c==0)?Genesis.constants.addCRLF()+d.eligibleRewardMsg:""));},wonPrizeEmailMsg:function(b,a){return("I've just won enough Prize Points to redeem \""+b+'" for eating out at '+a+"!");},getBadgePrizeMsg:function(b,a){if(b>0){return("You've been awarded an "+Genesis.constants.addCRLF()+"additional "+b+" Prize Points!"+Genesis.constants.addCRLF()+this.eligibleRewardMsg);}return("You've been Promoted to Badge Level ["+a.get("type").display_value+"]!");},upgradeBadgeEmailMsg:function(a){return("I've been promoted to "+a.toUpperCase()+" status at "+venueName+"!");},gotMinPrizePtsMsg:function(a){return("You've won "+a+" Prize Points!");},init:function(){var a=this;a.callParent(arguments);a.callBackStack={callbacks:["eligibleForPrizeHandler","badgePrizePointsHandler","redeemPrizeHandler"],arguments:[],startIndex:0};console.log("Prizes Init");},stopRouletteTable:function(){var a=this.getPrizeCheckScreen();var b=Ext.get(Ext.DomQuery.select("div.rouletteTable",a.element.dom)[0]);b.removeCls("spinFwd");b.removeCls("spinBack");},stopRouletteBall:function(){var a=this.getPrizeCheckScreen();var b=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);b.removeCls("spinBack");b.addCls("spinFwd");},stopRouletteScreen:function(){this.stopRouletteTable();var a=this.getPrizeCheckScreen();var b=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);b.removeCls("spinBack");b.removeCls("spinFwd");},updatingPrizeOnFacebook:function(d){var i=this;try{var h=i.getViewPortCntlr();var c=h.getVenue();var a=Genesis.constants.site;var k=c.get("website")?c.get("website").split(/http[s]*:\/\//):[null];var b=c.get("name");var j=k[k.length-1]||a;var f=c.get("description").trunc(256);var l=i.wonPrizeEmailMsg(d.get("title"),c.get("name"));console.log("Posting Prize Win to Facebook ...\nName: "+b+"\nCaption: "+j+"\nDescription: "+f+"\nMessage : "+l+"\n");FB.api("/me/feed","post",{name:b,link:j,caption:j,description:f,picture:c.getMerchant().get("photo")["thumbnail_ios_medium"].url,message:l},function(e){if(!e||e.error){console.log("Post was not published to Facebook.");}else{console.log("Posted to your Facebook Newsfeed.");}});}catch(g){console.log("Exception ["+g+"]\nPost was not published to Facebook.");}},updatingBadgeOnFacebook:function(d){var i=this;var l=d.get("photo")["thumbnail_ios_medium"];try{var h=i.getViewPortCntlr();var c=h.getVenue();var a=Genesis.constants.site;var k=c.get("website")?c.get("website").split(/http[s]*:\/\//):[null];var b=c.get("name");var j=k[k.length-1]||a;var f=c.get("description").trunc(256);var m=i.upgradeBadgeEmailMsg(d.get("title"),b);console.log("Posting Badge Promotion to Facebook ...\nName: "+b+"\nCaption: "+j+"\nDescription: "+f+"\nMessage : "+m+"\n");FB.api("/me/feed","post",{name:b,link:j,caption:j,description:f,picture:l,message:m},function(e){if(!e||e.error){console.log("Post was not published to Facebook.");}else{console.log("Posted to your Facebook Newsfeed.");}});}catch(g){console.log("Exception ["+g+"]\nPost was not published to Facebook.");}},removeViewHandler:function(a,c){var b=this;if(c>0){console.debug("Removing Last "+c+" Views from History ...");b.silentPopView(c);}b.popView();},redeemPrizeHandler:function(a,f){var c=this;var e=a.reward_info;var b=e.eligible_prize_id>0;if(b){var e=a.reward_info;var d=Ext.StoreMgr.get("PrizeStore").getById(e.eligible_prize_id);console.debug("Eligible Prize Id["+e.eligible_prize_id+"]");c.fireEvent("showredeemprize",d,e,f);}else{console.debug("No Eligible Prize");c.removeViewHandler(a,f);}return false;},badgePrizePointsHandler:function(b,h){var d=this;var g=b.reward_info;var f=b.account_info;var c=b.account_info["badge_id"];var a=Ext.StoreMgr.get("BadgeStore").getById(c);var e=(g.badge_prize_points>0)||(f.visits==1);if(e){Ext.device.Notification.show({title:"Badge Promotion Alert!",message:d.getBadgePrizeMsg(g.badge_prize_points,a),callback:function(){d.redeemBadgeItem=Ext.create("Genesis.model.CustomerReward",{title:a.get("type").display_value,type:{value:"promotion"},photo:{thumbnail_ios_medium:Genesis.view.client.Badges.getPhoto(a.get("type"),"thumbnail_large_url")},points:g.badge_prize_points,time_limited:false,quantity_limited:false,merchant:null});Genesis.controller.ControllerBase.playSoundFile(d.getViewPortCntlr().sound_files.promoteSound);d.redirectTo("badgeDetail");}});}return e;},eligibleForPrizeHandler:function(a,g){var f=this;var e=f.getViewPortCntlr();var b=a.reward_info;var h=b.eligible_prize_id>0;var c,i;var d=function(j,k){if((f.flag|=j)==17){f.flag=0;f.fireEvent("triggerCallbacksChain");}};if(b.prize_points>f.getMinPrizePts()){c="winPrizeSound";i=f.wonPrizeMsg(b);Ext.device.Notification.vibrate();}else{c="losePrizeSound";i=f.gotMinPrizePtsMsg(b.prize_points);}Genesis.controller.ControllerBase.playSoundFile(e.sound_files[c],Ext.bind(d,f,[1,g]));Ext.device.Notification.show({title:f.scanPlayTitle,message:i,callback:Ext.bind(d,f,[16,g])});return true;},onPrizeCheck:function(b){var c=this;var a=c.getViewPortCntlr();var e=b.reward_info;var d=b.account_info;c.stopRouletteBall();if(!Ext.isDefined(e.eligible_prize_id)||(e.eligible_prize_id==0)){console.log("No Prize to Show.");viewsPopLength=((e.badge_prize_points>0)||(d.visits==1))?1:0;}else{console.log("WON LumpSum Prize Points.");viewsPopLength=((e.badge_prize_points>0)||(d.visits==1))?2:1;}c.callBackStack["arguments"]=[b,viewsPopLength];c.fireEvent("triggerCallbacksChain");},onBadgeDetailDoneTap:function(a,f,c){console.debug("Closing Promotional Badge Details");var d=this;d.fireEvent("triggerCallbacksChain");},onShowRedeemItem:function(a){var b=this;b.redeemItem=a;b.redirectTo("redeemPrize");},onShowRedeemPrize:function(e,a,f){var c=this;var b=c.redeemItem=e;var d=a;if(f>0){console.debug("Removing Last "+f+" Views from History ...");c.silentPopView(f);}c.stopRouletteScreen();c.redirectTo("redeemPrize");if(typeof(FB)!="undefined"){Genesis.fb.facebook_onLogin(function(g){if((d.eligible_prize_id)&&(d.eligible_prize_id>0)){c.updatingPrizeOnFacebook(b);}if(d.badge_prize_points>0){c.updatingBadgeOnFacebook(b);}},false,c.updateOnFbMsg);}},onBadgeDetailCreateView:function(b){var a=this;b.redeemItem=a.redeemBadgeItem;},onBadgeDetailActivate:function(f,g,b,d){var e=this;var a=f.query("titlebar")[0];a.setTitle("Badge Promotion");},onBadgeDetailDeactivate:function(d,e,a,b){},redeemChooseSCPage:function(){var a=this.getApplication().getController("client.Accounts");a.redeemPrizesChooseSCPage();},redeemItemPage:function(){this.openPage("redeemPrize");},badgeDetailPage:function(){this.openPage("badgeDetail");},getRedeemMainPage:function(){var a=this;var b=a.callParent(arguments);if(!b){switch(a.getRedeemMode()){case"badgeDetail":a.setAnimationMode(Genesis.controller.ControllerBase.animationMode.coverUp);b=a.getBadgeDetail();break;}}return b;},isOpenAllowed:function(){return true;}});