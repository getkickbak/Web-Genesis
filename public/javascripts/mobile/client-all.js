Ext.define("Genesis.profile.Iphone",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.is.iPhone;}});Ext.define("Genesis.device.notification.PhoneGap",{override:"Ext.device.notification.PhoneGap",beep:function(b){var a=_application.getController("Viewport");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.beepSound);console.log("Beep "+b+" times.");},vibrate:function(a){navigator.notification.vibrate(a||2000);}});Ext.define("Genesis.profile.Android",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.is.Android;}});Ext.define("Genesis.device.notification.PhoneGap",{override:"Ext.device.notification.PhoneGap",beep:function(b){var a=_application.getController("Viewport");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.beepSound);},vibrate:function(a){navigator.notification.vibrate(a||2000);}});Ext.define("Genesis.profile.Desktop",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.deviceType=="Desktop";}});Ext.define("Genesis.device.notification.Simulator",{override:"Ext.device.notification.Simulator",beep:function(b){var a=_application.getController("Viewport");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.beepSound);console.log("Beep "+b+" times.");}});Ext.define("Genesis.device.notification.Desktop",{override:"Ext.device.notification.Desktop",beep:function(b){var a=_application.getController("Viewport");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.beepSound);console.log("Beep "+b+" times.");}});Ext.define("Genesis.fx.animation.Scroll",{extend:"Ext.fx.animation.Abstract",alternateClassName:"Ext.fx.animation.ScrollIn",alias:["animation.scroll","animation.scrollIn"],config:{direction:"left",out:false,offset:0,easing:"auto",containerBox:"auto",elementBox:"auto",isElementBoxFit:true},reverseDirectionMap:{up:"down",down:"up",left:"right",right:"left"},applyEasing:function(a){if(a==="auto"){return"ease-"+((this.getOut())?"in":"out");}return a;},getData:function(){var e=this.getElement();var m=this.getFrom(),n=this.getTo(),d=this.getOut(),c=this.getOffset(),l=this.getDirection(),f=this.getReverse(),b=0,a=0,k,h,j,g;if(f){l=this.reverseDirectionMap[l];}switch(l){case this.DIRECTION_UP:case this.DIRECTION_DOWN:a=e.getHeight();break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:b=e.getWidth();break;}k=(d)?0:b;h=(d)?0:a;m.set("overflow","hidden");switch(l){case this.DIRECTION_UP:case this.DIRECTION_DOWN:m.set("height",h+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:m.set("width",k+"px");break;}j=(d)?b:0;g=(d)?a:0;n.set("overflow","hidden");switch(l){case this.DIRECTION_UP:case this.DIRECTION_DOWN:n.set("height",g+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:n.set("width",j+"px");break;}return this.callParent(arguments);}});Ext.define("Genesis.view.widgets.ListField",{extend:"Ext.field.Text",alternateClassName:"Genesis.field.List",xtype:"listfield",config:{ui:"list",component:{useMask:false},clearIcon:true,iconCls:"",readOnly:false},initialize:function(){var b=this,a=b.getComponent();b.callParent();if(b.getIconCls()){Ext.fly(b.element.query("."+Ext.baseCSSPrefix.trim()+"component-outer")[0]).addCls(b.getIconCls());}a.setReadOnly(true);},doClearIconTap:Ext.emptyFn});Ext.define("Genesis.view.widgets.ComponentListItem",{extend:"Ext.dataview.element.List",config:{maxItemCache:20},initialize:function(){this.callParent();this.doInitialize();this.itemCache=[];},getItemElementConfig:function(e,h){var f=this,c=f.dataview,g=c.getItemCls(),b=f.itemClsShortCache,d,a;if(g){b+=" "+g;}d={cls:b,children:[{cls:f.labelClsShortCache,}]};if(c.getIcon()){a=h.iconSrc;d.children.push({cls:f.iconClsShortCache,style:"background-image: "+a?'url("'+newSrc+'")':""});}return d;},moveItemsToCache:function(k,l){var j=this,d=j.dataview,b=d.getMaxItemCache(),h=j.getViewItems(),g=j.itemCache,f=g.length,n=d.getPressedCls(),e=d.getSelectedCls(),c=l-k,o;for(;c>=0;c--){o=Ext.get(h[k+c]);var m=o.down(j.labelClsCache,true);var a=Ext.getCmp(m.childNodes[0].id);if(f!==b){o.removeCls([n,e]);g.push(a);f++;}else{Ext.Array.remove(j.itemCache,a);a.destroy();}o.dom.parentNode.removeChild(o.dom);}if(j.getViewItems().length==0){this.dataview.showEmptyText();}},moveItemsFromCache:function(b){var l=this,e=l.dataview,m=e.getStore(),k=b.length;var a=e.getDefaultType(),h=e.getItemConfig();var g=l.itemCache,f=g.length,j=[],c,n,d;if(k){e.hideEmptyText();}for(c=0;c<k;c++){b[c]._tmpIndex=m.indexOf(b[c]);}Ext.Array.sort(b,function(p,o){return p._tmpIndex>o._tmpIndex?1:-1;});for(c=0;c<k;c++){d=b[c];if(f){f--;n=g.pop();l.updateListItem(d,n);}l.addListItem(d._tmpIndex,d,n);delete d._tmpIndex;}return j;},addListItem:function(f,d,n){var k=this,e=k.dataview,b=e.prepareData(d.getData(true),e.getStore().indexOf(d),d);var c=k.element,m=c.dom.childNodes,j=m.length,h;h=Ext.Element.create(this.getItemElementConfig(f,b));var a=e.getDefaultType(),g=e.getItemConfig();if(!j||f==j){h.appendTo(c);}else{h.insertBefore(m[f]);}var l=h.down(k.labelClsCache,true);if(!n){n=new Ext.widget(a,{xtype:a,record:d,dataview:e,itemCls:e.getItemCls(),defaults:g,renderTo:l});}else{n.element.appendTo(l);}},updateListItem:function(b,c){if(c.isComponent&&c.updateRecord){c.updateRecord(b);}else{var d=Ext.fly(c).down(this.labelClsCache,true);var a=Ext.getCmp(d.childNodes[0].id);a.updateRecord(b);}},destroy:function(){var d=this.getViewItems(),c=d.length,b=0,a=this.itemCache.length;for(;b<a;b++){this.itemCache[b].destroy();this.itemCache[b]=null;}delete this.itemCache;for(b=0;b<c;b++){Ext.removeNode(d[b]);}this.callParent();}});Ext.define("Genesis.view.widgets.ComponentList",{alternateClassName:"Genesis.ComponentList",extend:"Ext.dataview.List",xtype:"componentlist",requires:["Genesis.view.widgets.ComponentListItem"],initialize:function(){var b=this,a;b.on(b.getTriggerCtEvent(),b.onContainerTrigger,b);a=b.container=this.add(new Genesis.view.widgets.ComponentListItem({baseCls:this.getBaseCls()}));a.dataview=b;b.on(b.getTriggerEvent(),b.onItemTrigger,b);a.element.on({delegate:"."+this.getBaseCls()+"-disclosure",tap:"handleItemDisclosure",scope:b});a.on({itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd",itemtap:"onItemTap",itemtaphold:"onItemTapHold",itemtouchmove:"onItemTouchMove",itemsingletap:"onItemSingleTap",itemdoubletap:"onItemDoubleTap",itemswipe:"onItemSwipe",scope:b});if(this.getStore()){this.refresh();}}});Ext.define("Genesis.navigation.Bar",{extend:"Ext.navigation.Bar",requires:["Ext.fx.layout.card.Style"],config:{ui:"dark",defaultBackButtonText:"Back",altBackButtonText:"Close",mode:"slide",callbackFn:Ext.emptyFn,listeners:{activeitemchange:"onActiveItemChange"}},getTitleText:function(){var a=this.backButtonStack[this.backButtonStack.length-1];return((a)?a.trunc(19):"");},onViewAdd:function(b,g,c){var f=this;var h=b.getLayout().getAnimation();var a=f.titleComponent;f.endAnimation();f.backButtonStack.push(g.config.title||f.getDefaultBackButtonText());f.refreshNavigationBarProxy();var d=f.getNavigationBarProxyProperties();if(d.title.left){}if(d.title.width){a.setWidth(d.title.width);}var e=f.getBackButton();e.setText(f.getBackButtonText());e[((b.stack.length>0)&&(!g.hideBackButton))?"show":"hide"]();switch(b.getAnimMode()){case"fade":f.setMode("fade");break;case"flip":f.setMode("flip");break;default:f.setMode("slide");break;}f.titleComponent.setTitle(f.getTitleText());if(h&&h.isAnimation&&b.isPainted()&&f.elementGhost){if(b.getInnerItems().length>1){f.pushTbAnimated(g,f.getBackButtonText());}else{if(f.elementGhost){f.elementGhost.destroy();delete f.elementGhost;}}}else{if(b.getInnerItems().length>1){f.pushTb(g,f.getBackButtonText());}else{}}f.getCallbackFn()();},onViewRemove:function(b,f,c){var e=this;var g=b.getLayout().getAnimation();var a=e.titleComponent;e.endAnimation();e.backButtonStack.pop();e.refreshNavigationBarProxy();var d=e.getNavigationBarProxyProperties();if(d.title.left){}if(d.title.width){a.setWidth(d.title.width);}switch(b.getAnimMode()){case"fade":e.setMode("fade");break;case"flip":e.setMode("flip");break;default:e.setMode("slide");break;}if(g&&g.isAnimation&&b.isPainted()&&e.elementGhost){e.popTbAnimated(f,e.getBackButtonText());}else{e.popTb(f,e.getBackButtonText());}e.titleComponent.setTitle(e.getTitleText());e.getCallbackFn()();},getTbAnimationProperties:function(a){var e=this,c=e.renderElement,f,d=e.getLayout();var b=a.parent.getLayout().getAnimation();if(e.slideAnimation){e.slideAnimation.destroy();}if(e.fadeAnimation){e.fadeAnimation.destroy();}if(e.flipAnimation){e.flipAnimation.destroy();}switch(e.getMode()){case"fade":case"flip":case"slide":e[e.getMode().toLowerCase()+"Animation"]=f=new Ext.fx.layout.card[e.getMode().capitalize()]({direction:b.getInAnimation().getDirection(),reverse:b.getReverse(),listeners:{animationend:function(){if(e.elementGhost){e.elementGhost.destroy();delete e.elementGhost;e.getCallbackFn()();}}}});break;default:console.debug("Unkown Special Effect - ["+e.getMode()+"]");f=e.getLayout().getAnimation();break;}f.setReverse(false);f.setLayout(d);d.setAnimation(f);return f;},getTbAnimationReverseProperties:function(a){var b=this.getTbAnimationProperties(a);b.setReverse(true);return b;},pushTb:function(a,f){var e=this;var b=e.getNavigationBarProxyProperties();var d=e.getBackButton();var c=b.backButton;if(c.left){d.setLeft(c.left);}if(c.width){d.setWidth(c.width);}e[(Ext.isEmpty(a.getHideNavBar)||!a.getHideNavBar())?"show":"hide"]();},pushTbAnimated:function(g,h){var f=this;var c=0;var j=f.getBackButton(),a=j.getText();var d=f.getTbAnimationProperties(g);var e=f.getNavigationBarProxyProperties();var b=e.backButton;if(b.left){j.setLeft(b.left);}if(b.width){j.setWidth(b.width);}f.fireEvent("activeitemchange",g,f,{renderElement:f.elementGhost,isPainted:f.isPainted});},popTb:function(a,f){var e=this,d=e.getBackButton();var b=this.getNavigationBarProxyProperties();if(f&&e.backButtonStack.length){d.setText(this.getBackButtonText());d.show();}else{d.hide();}var c=b.backButton;if(c.left){d.setLeft(c.left);}if(c.width){d.setWidth(c.width);}e[(Ext.isEmpty(a.getHideNavBar)||!a.getHideNavBar())?"show":"hide"]();},popTbAnimated:function(h,j){var g=this;var d=g.element,c=g.renderElement,k=g.getBackButton();var a=k.getText();var f=g.getTbAnimationReverseProperties(h);var e=this.getNavigationBarProxyProperties();if(j&&g.backButtonStack.length){k.setText(this.getBackButtonText());k.show();}else{k.hide();}var b=e.backButton;if(b.width){k.setWidth(b.width);}g.fireEvent("activeitemchange",h,g,{renderElement:g.elementGhost,isPainted:g.isPainted});},createNavigationBarProxy:function(){var a=this.proxy;if(a){return;}this.proxy=a=Ext.create("Ext.TitleBar",{title:this.backButtonStack[0]});a.add(Ext.applyIf({hidden:false,text:""},this.config.backButton));a.add(this.config.rightButton);a.backButton=a.down("button[ui=back]");Ext.getBody().appendChild(a.renderElement);a.renderElement.setStyle("position","absolute");a.element.setStyle("visibility","hidden");a.renderElement.setX(0);a.renderElement.setY(-1000);},refreshNavigationBarProxy:function(){var c=this.proxy,b=this.renderElement,a=this.backButtonStack,e=a[a.length-1],d=this.getBackButtonText();if(!c){this.createNavigationBarProxy();c=this.proxy;}c.renderElement.setWidth(b.getWidth());c.renderElement.setHeight(b.getHeight());c.setTitle(e);if(d){c.backButton.setText(d);c.backButton.show();}else{}c.refreshTitlePosition();},getNavigationBarProxyProperties:function(){return({title:{left:this.proxy.titleComponent.renderElement.getLeft(),width:this.proxy.titleComponent.renderElement.getWidth()},leftBox:{left:this.proxy.leftBox.renderElement.getLeft(),width:this.proxy.leftBox.renderElement.getWidth()},rightBox:{left:this.proxy.rightBox.renderElement.getLeft(),width:this.proxy.rightBox.renderElement.getWidth()},backButton:{left:this.proxy.backButton.renderElement.getLeft(),width:this.proxy.backButton.renderElement.getWidth()}});},createProxy:function(c,d,b,a){var f=this;var e=(a)?d.element.getParent():d.element,g=Ext.get(e.id+"-proxy");if(!g){g=e.dom.cloneNode(true);g.id=e.id+"-proxy";g.children[0].id=e.dom.children[0].id+"-proxy";e.getParent().dom.appendChild(g);g=Ext.get(g);g.setStyle("position","absolute");g.setY(e.getY());g.setX(e.getX());g.setWidth(e.getWidth());g.dom.style.setProperty("z-index",1,"important");}f[!Ext.isEmpty(b.getHideNavBar)?(b.getHideNavBar()?"hide":"show"):"show"]();return g;},reset:function(){this.backButtonStack=[];this.lastAnimationProperties={};},onActiveItemChange:function(j,f,l,m,d){var h=this,b,e=h.getLayout();var a=e.getAnimation().getInAnimation(),k=e.getAnimation().getOutAnimation(),g,c;if(f&&l&&l.isPainted()){g=f.renderElement;c=l.renderElement;a.setOut(!Ext.isEmpty(j.getHideNavBar)&&j.getHideNavBar());a.setElement(g);k.setElement(c);k.setOnBeforeEnd(function(n,o){if(o||Ext.Animator.hasRunningAnimations(n)){d.firingArguments[1]=null;d.firingArguments[2]=null;}});k.setOnEnd(function(){d.resume();});g.dom.style.setProperty("visibility","hidden","!important");if(Ext.isEmpty(j.getHideNavBar)||!j.getHideNavBar()){f.show();}h.activeAnimations=[k,a];Ext.Animator.run(h.activeAnimations);d.pause();}return b;}});Ext.define("Genesis.view.widgets.MerchantDetailsItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.XTemplate"],xtype:"merchantdetailsitem",alias:"widget.merchantdetailsitem",config:{layout:{type:"hbox",align:"stretch"},image:{docked:"left",cls:"photo",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>',{getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_medium"].url;}})},address:{flex:1,tpl:Ext.create("Ext.XTemplate",'<div class="merchantDetailsWrapper"><div class="itemTitle">{name}</div><div class="itemDesc">{[this.getAddress(values)]}</div></div>',{getAddress:function(a){return(a.address+",<br/>"+a.city+", "+a.state+", "+a.country+",</br>"+a.zipcode);}}),cls:"address"},dataMap:{getImage:{setData:"image"},getAddress:{setData:"address"}}},applyImage:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getImage());},updateImage:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyAddress:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getAddress());},updateAddress:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"image":case"address":k[a](b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);}});Ext.define("Genesis.view.widgets.ChallengeMenuItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.XTemplate"],xtype:"challengemenuitem",alias:"widget.challengemenuitem",config:{layout:{type:"hbox",pack:"center",align:"stretch"},image:{cls:"photo",tpl:Ext.create("Ext.XTemplate",'<div class="mainPageItemWrapper x-hasbadge">','<span class="x-badge round">{[this.getPoints(values)]}</span>','<div class="photo"><img src="{[this.getPhoto(values)]}" /></div>','<div class="photoName">{name}</div>',"</div>",{getPoints:function(a){return a.points+" Points";},getPhoto:function(a){return Ext.isEmpty(a.photo)?Genesis.view.widgets.ChallengeMenuItem.getPhoto(a.type):a.photo.url;}})},dataMap:{getImage:{setData:"photo_url"}}},applyImage:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getImage());},updateImage:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"photo_url":k[a](b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);},statics:{getPhoto:function(a){var b=null;var c=a.value;switch(c){case"custom":c="mystery";default:b=Genesis.constants.getIconPath("mainicons",c);break;}return b;}}});Ext.define("Genesis.view.widgets.RewardItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.Button","Ext.XTemplate"],xtype:"rewarditem",alias:"widget.rewarditem",config:{background:{cls:"rewardItem",tag:"rewardItem",layout:{type:"vbox"},items:[{docked:"top",xtype:"component",tag:"title",cls:"title",margin:"0 0 0.8 0",defaultUnit:"em",tpl:Ext.create("Ext.XTemplate","{[this.getDescription(values)]}",{getDescription:function(a){return a.title;}})},{xtype:"component",flex:1,tag:"itemPhoto",cls:"itemPhoto",tpl:Ext.create("Ext.XTemplate",'<div class="itemPoints">{[this.getPoints(values)]}</div>',{getPoints:function(a){return((a.points>0)?a.points+"  Pts":"");}})},{docked:"bottom",xtype:"component",tag:"info",cls:"info",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="infoWrapper"><div class="name">{[this.getName(values)]}</div><div class="disclaimer">{[this.getDisclaimer(values)]}</div><div class="date">{[this.getExpiryDate(values)]}</div></div>',{getExpiryDate:function(a){var b=a.expiry_date;return((!b)?"":"Offer Expires "+b);},getDisclaimer:function(a){return a.Merchant.prize_terms||"Not valid with any other offer. No cash value. One coupon per customer per visit. Void where prohibited. Good at participating stores only.";},getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_small"].url;},getName:function(a){return a.Merchant.name;}})},{docked:"bottom",xtype:"button",hidden:true,cls:"separator",tag:"refresh",text:"Refresh",ui:"orange-large"},{docked:"bottom",xtype:"button",hidden:true,cls:"separator",tag:"verify",text:"Verified!",ui:"orange-large"}]},dataMap:{getBackground:{setData:"background"}},listeners:{painted:function(d,b){var a=Ext.ComponentQuery.query("viewportview")[0].getActiveItem().renderElement.getHeight();d.config.dataview.setHeight(a);d.query("container[tag=rewardItem]")[0].setHeight(a);d.setHeight(a);}}},applyBackground:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBackground());},updateBackground:function(a,b){if(a){this.add(a);}if(b){this.remove(b);}},setDataBackground:function(d){var g=d.CustomerReward;var a=Genesis.view.Prizes.getPhoto(g.type)||g.photo["thumbnail_ios_medium"];var f=this.query("component[tag=info]")[0];var c=this.query("button[tag=refresh]")[0];var e=this.query("button[tag=verify]")[0];var b=this.query("component[tag=itemPhoto]")[0];if(d.Merchant){f.setData(d);f.show();c.hide();e.hide();}else{f.hide();c[g.photo?"show":"hide"]();e[g.photo?"hide":"show"]();}this.query("component[tag=title]")[0].setData(g);b.element.setStyle((Ext.isString(a))?{"background-image":"url("+a+")","background-size":""}:{"background-image":"url("+a.url+")","background-size":(a.width)?Genesis.fn.addUnit(a.width)+" "+Genesis.fn.addUnit(a.height):""});b.setData((!d.expiry_date||(d.expiry_date=="N/A"))?g:{points:null});},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"background":h.setDataBackground(b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);}});Ext.define("Genesis.view.widgets.MerchantAccountPtsItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.Button","Ext.XTemplate"],xtype:"merchantaccountptsitem",alias:"widget.merchantaccountptsitem",config:{layout:"fit",background:{cls:"tbPanel",tag:"background",items:[{xtype:"container",docked:"bottom",cls:"container",layout:{type:"hbox",align:"stretch"},defaults:{xtype:"component"},items:[{docked:"left",tag:"visits",tpl:"{visits}",cls:"visitsphoto"},{docked:"right",tag:"points",tpl:"{points}",cls:"pointsphoto"}],}]},dataMap:{getBackground:{setData:"background"}}},applyBackground:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBackground());},updateBackground:function(a,b){if(a){this.add(a);}if(b){this.remove(b);}},setDataBackground:function(c){var g=_application.getController("Viewport");var f=g.getCustomer();var a=g.getVenue();var b=a.getId();var h=g.getCheckinInfo().venue;var d=this.query("container[tag=background]")[0];this.setHeight(Ext.Viewport.getSize().width);d.setStyle({"background-image":"url("+c.Merchant.alt_photo["url"]+")"});if(Ext.StoreMgr.get("CustomerStore").getById(f.getId())){d.getItems().items[0].show();var j=this.query("component[tag=points]")[0];j.setData(f.getData());var e=this.query("component[tag=visits]")[0];e.setData(f.getData());}else{d.getItems().items[0].hide();}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"background":h.setDataBackground(b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);}});Ext.define("Genesis.view.widgets.RedemptionsPtsItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.XTemplate"],xtype:"redemptionsptsitem",alias:"widget.redemptionsptsitem",config:{layout:{type:"hbox",align:"stretch"},points:{flex:1,tpl:"{points} Pts",cls:"pointsphotobase"},dataMap:{getPoints:{setData:"points"}}},applyPoints:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getPoints());},updatePoints:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"points":k[a](b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);}});Ext.define("Genesis.view.widgets.RewardsCartItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.Button","Ext.field.Spinner","Ext.XTemplate"],xtype:"rewardscartitem",alias:"widget.rewardscartitem",config:{hideAnimation:!Ext.os.is.Android2?{type:"scroll",direction:"up",duration:250,easing:"ease-out"}:null,layout:{type:"hbox",align:"center",pack:"start"},image:{cls:"photo x-hasbadge",tpl:Ext.create("Ext.XTemplate",'<span class="x-badge round">{[this.getPoints(values)]} Pts</span>','<img src="{[this.getPhoto(values)]}"/>',{getPoints:function(a){return a.points;},getPhoto:function(a){if(!a.photo){return Genesis.view.Rewards.getPhoto(a.type);}return a.photo.url;}})},title:{flex:1,cls:"itemDetails",tpl:Ext.create("Ext.XTemplate",'<div class="itemTitle">{[this.getTitle(values)]}</div>',{getTitle:function(a){return a.title;},getDesc:function(a){return a.title;}})},qty:{minValue:0,maxValue:99,increment:1,groupButtons:false,cycle:false,listeners:{initialize:function(b,a){var c=Ext.fly(Ext.DomQuery.select("div.x-field-input",b.element.dom)[0]);c[(b.getValue()>0)?"removeCls":"addCls"]("x-item-hidden");}}},dataMap:{getImage:{setData:"photo_url"},getTitle:{setData:"title"},getQty:{setValue:"qty"}}},applyQty:function(a){return Ext.factory(Ext.apply(a,{value:this.config.record.get("qty")||0}),Ext.field.Spinner,this.getQty());},updateQty:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyImage:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getImage());},updateImage:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyTitle:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getTitle());},updateTitle:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),n=e.first(),j=h.getDataMap(),f,k,g,a;if(!n){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"photo_url":case"title":k[a](b);break;case"qty":var m=b[g[a]];k[a](m);var l=Ext.get(Ext.DomQuery.select("div.x-field-input",k.element.dom)[0]);l[(m>0)?"removeCls":"addCls"]("x-item-hidden");break;default:k[a](b[g[a]]);break;}}}}}n.updateData(b);}});Ext.define("Genesis.view.widgets.RewardsCheckoutItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.Button","Ext.XTemplate"],xtype:"rewardscheckoutitem",alias:"widget.rewardscheckoutitem",config:{hideAnimation:!Ext.os.is.Android2?{type:"scroll",direction:"up",duration:250,easing:"ease-out"}:null,layout:{type:"hbox",align:"center"},qty:{cls:"qty",tpl:Ext.create("Ext.XTemplate","{[this.getQty(values)]}",{getQty:function(a){return a.qty;}})},multiplier:{iconCls:"delete_black2",disabled:true,iconMask:true,cls:"plain"},image:{cls:"photo",tpl:Ext.create("Ext.XTemplate",'<img src="{[this.getPhoto(values)]}"/>',{getPhoto:function(a){if(!a.photo){return Genesis.view.Rewards.getPhoto(a.type);}return a.photo.url;}})},title:{flex:1,cls:"itemDetails",tpl:Ext.create("Ext.XTemplate",'<div class="itemTitle">{[this.getTitle(values)]}</div>',{getTitle:function(a){return a.title;},getDesc:function(a){return a.title;}})},points:{cls:"points",tpl:Ext.create("Ext.XTemplate","{[this.getPoints(values)]} Pts",{getPoints:function(a){return a.qty*a.points;}})},dataMap:{getImage:{setData:"photo_url"},getTitle:{setData:"title"},getPoints:{setData:"points"},getQty:{setData:"qty"}}},applyMultiplier:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Button,this.getMultiplier());},updateMultiplier:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyImage:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getImage());},updateImage:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyTitle:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getTitle());},updateTitle:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyPoints:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getPoints());},updatePoints:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyQty:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getQty());},updateQty:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"qty":case"points":case"photo_url":case"title":k[a](b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);}});Ext.define("Genesis.model.frontend.MainPage",{extend:"Ext.data.Model",id:"MainPage",config:{fields:["name","photo_url","desc","pageCntlr","subFeature","hide"],proxy:{reader:{type:"json",messageProperty:"message",rootProperty:"data"},type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/"+((!merchantMode)?"mainClientPage.json":"mainServerPage.json")}}});Ext.define("Genesis.model.UserProfile",{extend:"Ext.data.Model",alternateClassName:"UserProfile",id:"UserProfile",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"}],fields:["gender","birthday","zipcode","created_ts","update_ts","user_id"]},getUser:function(){}});Ext.define("Genesis.model.User",{extend:"Ext.data.Model",requires:["Genesis.model.UserProfile"],alternateClassName:"User",id:"User",config:{hasOne:[{model:"Genesis.model.UserProfile",associationKey:"profile"}],proxy:{type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/users.json",reader:{type:"json"}},fields:["user_id","name","email","facebook_id","photo_url","created_ts","update_ts","profile_id"],idProperty:"user_id"}});Ext.define("Genesis.model.Merchant",{extend:"Ext.data.Model",alternateClassName:"Merchant",id:"Merchant",config:{fields:["id","name","email","photo","alt_photo","account_first_name","account_last_name","phone","auth_code","qr_code","payment_account_id","created_ts","update_ts","type"],idProperty:"id"}});Ext.define("Genesis.model.Challenge",{extend:"Ext.data.Model",id:"Challenge",alternateClassName:"Challenge",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],fields:["id","type","name","description","require_verif","data","points","created_ts","update_ts","photo","merchant_id","venue_id"],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetChallengesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/challenges":Ext.Loader.getPath("Genesis")+"/store/challenges.json");},setCompleteChallengeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/"+a+"/complete");},setSendReferralsUrl:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/merchant/"+a+"/referrals");}}});Ext.define("Genesis.model.Checkin",{extend:"Ext.data.Model",alternateClassName:"Checkin",id:"Checkin",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"},{model:"Genesis.model.Venue",getterName:"getVenue",setterName:"setVenue"}],fields:["id","time"]}});Ext.define("Genesis.model.PurchaseReward",{extend:"Ext.data.Model",id:"PurchaseReward",alternateClassName:"PurchaseReward",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["id","title","points","type","photo","created_ts","update_ts","qty"]},getMerchant:function(){},statics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/purchase_rewards":Ext.Loader.getPath("Genesis")+"/store/rewards.json");}}});Ext.define("Genesis.model.CustomerReward",{extend:"Ext.data.Model",id:"CustomerReward",alternateClassName:"CustomerReward",config:{fields:["id","title","points","type","photo"],idProperty:"id",belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetRedemptionsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/customer_rewards":Ext.Loader.getPath("Genesis")+"/store/redemptions.json");},setRedeemPointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customer_rewards/"+a+"/redeem");}}});Ext.define("Genesis.model.EarnPrize",{extend:"Ext.data.Model",id:"EarnPrize",alternateClassName:"EarnPrize",config:{fields:["id",{name:"expiry_date",type:"date",convert:function(a,b){var a=Date.parse(a,"yyyy-MM-dd");return(!a)?"N/A":Genesis.fn.convertDateNoTimeNoWeek.apply(this,arguments);}}],idProperty:"id",belongsTo:[{model:"Genesis.model.CustomerReward",associationKey:"reward",getterName:"getCustomerReward",setterName:"setCustomerReward"},{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"},{model:"Genesis.model.User",associationKey:"user",getterName:"getUser",setterName:"setUser"}],proxy:{type:"ajax",disableCaching:false,actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getUser:function(){},statics:{setEarnPrizeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/purchase_rewards/earn");},setRedeemPrizeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/earn_prizes/"+a+"/redeem");}}});Ext.define("Genesis.model.Venue",{extend:"Ext.data.Model",requires:["Genesis.model.Challenge","Genesis.model.PurchaseReward","Genesis.model.CustomerReward"],alternateClassName:"Venue",id:"Venue",config:{fields:["id","name","address","description","distance","city","state","country","zipcode","phone","website","latitude","longitude","created_ts","update_ts","type","merchant_id","sort_id"],belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"}],hasMany:[{model:"Genesis.model.Challenge",name:"challenges"},{model:"Genesis.model.PurchaseReward",name:"purchaseReward"},{model:"Genesis.model.CustomerReward",name:"customerReward"}],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}},idProperty:"id",},statics:{setFindNearestURL:function(){this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_nearest":Ext.Loader.getPath("Genesis")+"/store/checkinRecords.json");},setGetClosestVenueURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_closest":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setSharePhotoURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/share_photo":Ext.Loader.getPath("Genesis")+"/store/sharePhoto.json");}}});Ext.define("Genesis.model.EligibleReward",{extend:"Ext.data.Model",id:"EligibleReward",alternateClassName:"EligibleReward",config:{idProperty:"id",fields:["id","reward_id","reward_title","reward_text","reward_type","photo"]}});Ext.define("Genesis.model.Customer",{extend:"Ext.data.Model",requires:["Genesis.model.Checkin"],alternateClassName:"Customer",id:"Customer",config:{belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"},{model:"Genesis.model.User",associationKey:"user",getterName:"getUser",setterName:"setUser"}],hasOne:{model:"Genesis.model.Checkin",associationKey:"last_check_in",getterName:"getLastCheckin",setterName:"setLastCheckin"},proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["points","visits","id"],idProperty:"id"},getUser:function(){},statics:{isValidCustomer:function(a){return a!=0;},updateCustomer:function(f,a){var c;for(var b=0;b<f.fields.length;b++){c=f.fields.items[b].getName();f.set(c,a.get(c));}try{f.setLastCheckin(a.getLastCheckin());}catch(d){f.setLastCheckin(Ext.create("Genesis.model.Checkin"));}},setFbLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens/create_from_facebook":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setUpdateFbLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/account/update_facebook_info");},setLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setLogoutUrl:function(a){this.getProxy().setActionMethods({read:"DELETE"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/tokens/"+a);},setCreateAccountUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/sign_up":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setVenueScanCheckinUrl:function(){this.setVenueCheckinUrl();},setVenueCheckinUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/check_ins":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setVenueExploreUrl:function(a){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/"+a+"/explore":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setSendPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customers/transfer_points");},setRecvPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customers/receive_points");}}});Ext.define("Genesis.model.frontend.Account",{extend:"Ext.data.Model",alternateClassName:"Account",id:"Account",config:{fields:["name","username","password"],validations:[{type:"format",field:"name",matcher:/^([a-zA-Z'-]+\s+){1,4}[a-zA-z'-]+$/},{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.model.frontend.Signin",{extend:"Ext.data.Model",alternateClassName:"Signin",id:"Sigin",config:{fields:["username","password"],validations:[{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.view.ViewBase",{extend:"Ext.Container",xtype:"viewbase",config:{},beforeActivate:function(h,b){if(b){var a=Ext.ComponentQuery.query("viewportview")[0];var c=b.getXTypes();for(var f=0;f<a.stack.length;f++){if(a.stack[f].getXTypes().match("merchantaccountview")){var g=a.getNavigationBar();var d=g.getBackButton();var e=g.proxy.backButton;e.setUi("normal");d.setUi("normal");g.setDefaultBackButtonText(g.getAltBackButtonText());e.setText(g.getAltBackButtonText());break;}}if(c.match("merchantaccountview")){a.setAnimationDir("up");}}},beforeDeactivate:function(g,b){var a=Ext.ComponentQuery.query("viewportview")[0];var f=a.getNavigationBar();var c=f.getBackButton();var d=f.proxy.backButton;d.setUi("back");c.setUi("back");f.setDefaultBackButtonText(f.config.defaultBackButtonText);d.setText(f.config.defaultBackButtonText);if(b){var e=g.getXTypes();if(e.match("merchantaccountview")){a.setAnimationDir("up");}}},afterActivate:function(b,a){},afterDeactivate:function(b,a){}});Ext.define("Genesis.view.CheckinExplore",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.plugin.PullRefresh"],alias:"widget.checkinexploreview",config:{title:"Nearby Places",changeTitle:false,layout:"fit",merchant:null,items:[{xtype:"list",store:"CheckinExploreStore",scrollable:"vertical",emptyText:" ",cls:"checkInExploreList",itemTpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div><div class="listItemDetailsWrapper"><div class="itemDistance">{[this.getDistance(values)]}</div><div class="itemTitle">{name}</div><div class="itemDesc">{[this.getAddress(values)]}</div></div>',{getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_small"].url;},getAddress:function(a){return(a.address+",<br/>"+a.city+", "+a.state+", "+a.country+",<br/>"+a.zipcode);},getDistance:function(a){return a.distance.toFixed(1)+"km";}}),onItemDisclosure:Ext.emptyFn,plugins:[{xclass:"Ext.plugin.PullRefresh",refreshFn:function(b){var a=_application.getController("Checkins");_application.dispatch({action:"onExploreLoad",args:[true],controller:a,scope:a});}}]},{docked:"bottom",cls:"checkInNow",tag:"checkInNow",xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"button",tag:"checkInNow",text:"CheckIn Now!"}]}]},beforeActivate:function(c,a){switch(this.mode){case"checkin":this.getInitialConfig().title="Nearby Places";break;case"explore":this.getInitialConfig().title="Explore Places";break;}if(a){var b=a.getXTypes();if(b.match("merchantaccountview|checkinmerchantview")){this.callParent(arguments);}}},beforeDeactivate:function(c,a){var b=c.getXTypes();if(b.match("merchantaccountview|checkinmerchantview")){this.callParent(arguments);}}});Ext.define("Genesis.view.Viewport",{extend:"Ext.navigation.View",requires:["Ext.MessageBox","Ext.ActionSheet","Ext.fx.layout.Card","Ext.SegmentedButton","Genesis.navigation.Bar"],xtype:"viewportview",config:{animMode:"default",enableAnim:true,autoDestroy:false,cls:"viewport",fullscreen:true,useTitleForBackButtonText:false,defaultBackButtonText:"Back",altBackButtonText:"Close",navigationBar:{defaults:{iconMask:true},docked:"top",cls:"navigationBarTop",layout:{pack:"justify",align:"center"},items:[{align:"left",iconCls:"maps",tag:"mapBtn",hidden:true},{align:"right",iconCls:"share",tag:"shareBtn",hidden:true,handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{hideOnMaskTap:false,defaults:{defaultUnit:"em",margin:"0 0 0.5 0",xtype:"button"},items:[{text:"Email",ui:"action",tag:"mail",handler:Ext.emptyFn},{text:"SMS Message",tag:"sms",ui:"action",handler:Ext.emptyFn},{text:"Facebook",tag:"fbShareBtn",ui:"blue",handler:Ext.emptyFn},{margin:"0.5 0 0 0",text:"Cancel",iconMaskCls:"dummymask",ui:"cancel",scope:this,handler:function(){this.actions.hide();}}]});Ext.Viewport.add(this.actions);}this.actions.show();}},{align:"right",tag:"info",iconCls:"info",destroy:function(){this.actions.destroy();this.callParent(arguments);},handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{defaultUnit:"em",padding:"1em",hideOnMaskTap:false,defaults:{xtype:"button",defaultUnit:"em"},items:[{margin:"0 0 0.5 0",text:"Logout",tag:"logout"},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",scope:this,handler:function(){this.actions.hide();}}]});Ext.Viewport.add(this.actions);}this.actions.show();}},{align:"right",tag:"checkin",iconCls:"checkin",hidden:true},{align:"right",tag:"done",text:"Done",hidden:true},{align:"right",tag:"redeem",text:"Redeem",hidden:true},{align:"right",tag:"post",text:"Post",hidden:true}]},items:[]},initialize:function(){this.stack=[];this.fadeAnimation={type:"fade",listeners:{scope:this,animationend:"resetAnimation"}};this.flipAnimation={type:"flip",listeners:{scope:this,animationend:"resetAnimation"}};this.callParent(arguments);var b=this.getLayout(),a=b.getAnimation();a.on("animationend","resetAnimation",this);this.getNavigationBar()["hide"]();},applyNavigationBar:function(a){if(!a){a={hidden:true,docked:"top"};}if(a.title){delete a.title;Ext.Logger.warn("Ext.navigation.View: The 'navigationBar' configuration does not accept a 'title' property. You set the title of the navigationBar by giving this navigation view's children a 'title' property.");}a.view=this;return Ext.factory(a,Genesis.navigation.Bar,this.getNavigationBar());},resetAnimation:function(){var d=this.getActiveItem().getXTypes();if(this.defaultInAnimationDir){var a=this.getLayout().getAnimation(0);a.getInAnimation().setDirection(this.defaultInAnimationDir);a.getOutAnimation().setDirection(this.defaultOutAnimationDir);}var b=this.getLayout();var c=b.getAnimation();if(this.defaultAnimation&&(c!=this.defaultAnimation)){b.setAnimation(this.defaultAnimation);this.setAnimMode("default");}},setAnimationDir:function(b){var c=this.getLayout(),a;if(c.isCard){a=c.getAnimation();if(a){this.defaultInAnimationDir=a.getInAnimation().getDirection();this.defaultOutAnimationDir=a.getOutAnimation().getDirection();a.getInAnimation().setDirection(b);a.getOutAnimation().setDirection(b);}if(!this.defaultAnimation){this.defaultAnimation=a;}}},setFadeAnimation:function(){var a=this.getLayout();if(!this.defaultAnimation){this.defaultAnimation=a.getAnimation();}a.setAnimation(this.fadeAnimation);this.setAnimMode("fade");},setFlipAnimation:function(){var a=this.getLayout();if(!this.defaultAnimation){this.defaultAnimation=a.getAnimation();}a.setAnimation(this.flipAnimation);this.setAnimMode("flip");},doPop:function(b){var d=this;var f=d.getLayout().getAnimation();d.stack.pop();var a=d.stack[d.stack.length-1];var e=d.getActiveItem().getXTypes();if(f&&f.isAnimation&&d.getEnableAnim()){f.setReverse(true);var c=d.getNavigationBar();c.elementGhost=c.createProxy(d,c,a);}d.setActiveItem(a);d.getNavigationBar().onViewRemove(d,a,null);return a;},getPreviousItem:function(){var a=this;return a.stack[a.stack.length-1];},push:function(a){var c=this;var d=c.getLayout().getAnimation();var b=c.getNavigationBar();if(a==c.stack[c.stack.length-1]){console.log("Cannot push the current view into stack ...");return;}if((c.stack.length==0)&&(!b.titleComponent.getTitle())){b.titleComponent.setTitle(a.config.title||b.getDefaultBackButtonText());}if(d&&d.isAnimation&&c.getEnableAnim()){d.setReverse(false);b.elementGhost=b.createProxy(c,b,a);}if(c.getInnerItems().indexOf(a)<0){a=c.add(a);}else{c.setActiveItem(a);c.getNavigationBar().onViewAdd(c,a,null);}c.stack.push(a);return a;},doSetActiveItem:function(d,a){if(!d){return;}var c=this;if(d.getInitialConfig().changeTitle===true){var b=_application.getController("Viewport").getVenue();if(b){d.getInitialConfig().title=b.get("name");}}if(a){a.beforeDeactivate(d,a);}d.beforeActivate(d,a);c.callParent(arguments);if(a){a.afterDeactivate(d,a);}d.afterActivate(d,a);},beforePop:function(d){var c=this;var b=c.stack.length;if(!Ext.isNumber(d)||d<1){d=1;}d=Math.min(d,b);if(d){if(d==b){var a=c.getNavigationBar();a.reset();c.stack=[];a.getBackButton().hide();a.getBackButton().setText(null);}else{c.getNavigationBar().beforePop(d);for(i=0;i<d-1;i++){this.stack.pop();}return true;}}return false;},pop:function(c){var b=this;var a=b.getNavigationBar();b.callParent(arguments);},reset:function(){var b=this;var a=b.stack.length;this.pop(a);},silentPop:function(c){var a;var b=this.getNavigationBar();for(a=0;a<c;a++){this.stack.pop();b.backButtonStack.pop();}}});Ext.define("Genesis.view.UploadPhotosPage",{extend:"Ext.Container",requires:["Ext.dataview.DataView","Ext.XTemplate","Ext.form.Panel","Ext.field.TextArea"],alias:"widget.uploadphotospageview",scrollable:"vertical",config:{cls:"photoUploadPage",changeTitle:false,title:"Photo Upload",layout:"fit",items:[{xtype:"component",tag:"background",cls:"background"},{xtype:"textareafield",bottom:0,left:0,right:0,name:"desc",tag:"desc",cls:"desc",autoComplete:true,defaultUnit:"em",minHeight:"2",autoCorrect:true,autoCapitalize:true,maxLength:256,maxRows:4,placeHolder:"Please enter your photo description",clearIcon:false}]},beforeActivate:function(b,a){b.query("textareafield")[0].reset();},beforeDeactivate:function(b,a){},afterActivate:function(b,a){},afterDeactivate:function(b,a){}});Ext.define("Genesis.view.client.ChallengePage",{extend:"Genesis.view.ViewBase",requires:["Ext.data.Store","Ext.dataview.DataView","Ext.XTemplate","Ext.Toolbar","Genesis.model.Challenge","Genesis.view.widgets.ChallengeMenuItem"],alias:"widget.clientchallengepageview",config:{title:"Challenges",changeTitle:false,layout:"fit",scrollable:false,items:[{xtype:"carousel",cls:"challengePageItem shadows",direction:"horizontal"},{docked:"bottom",cls:"checkInNow",tag:"checkInNow",xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"button",iconCls:"dochallenges",iconMask:true,tag:"doit",text:"Lets do it!"}]},{docked:"bottom",xtype:"container",tag:"challengePageItemDescWrapper",cls:"challengePageItemDescWrapper",layout:{type:"vbox",align:"stretch",pack:"start"},defaults:{xtype:"component"},items:[{flex:1,cls:"itemDesc",tpl:"{description}"}]}]},takePhoto:function(){if(!this.photoAction){this.photoAction=Ext.create("Ext.ActionSheet",{hideOnMaskTap:false,defaults:{defaultUnit:"em",margin:"0 0 0.5 0",xtype:"button",handler:Ext.emptyFn},items:[{text:"Use Photo from Library",tag:"library"},{text:"Use Photo from Photo Album",tag:"album"},{text:"Take a Picture",tag:"camera"},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",scope:this,handler:function(){this.photoAction.hide();}}]});Ext.Viewport.add(this.photoAction);}this.photoAction.show();}});Ext.define("Genesis.view.MainPage",{extend:"Ext.Carousel",requires:["Ext.dataview.DataView","Ext.XTemplate"],alias:"widget.mainpageview",config:{title:" ",changeTitle:false,direction:"horizontal",items:(!merchantMode)?[{docked:"bottom",cls:"checkInNow",tag:"checkInNow",xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"button",tag:"checkInNow",text:"CheckIn Now!"}]}]:null},beforeActivate:function(){var g=this;var a=_application.getController("Viewport");var c=Ext.ComponentQuery.query("viewportview")[0];var b=a.getCheckinInfo().venue!=null;var d=Ext.StoreMgr.get("MainPageStore").getRange();var f=Ext.Array.clone(d);g.removeAll(true);if(!b){Ext.Array.forEach(f,function(k,h,j){switch(k.get("hide")){case"true":Ext.Array.remove(d,k);break;}});}for(var e=0;e<Math.ceil(d.length/6);e++){g.add({xtype:"dataview",cls:"mainMenuSelections",scrollable:false,deferInitialRefresh:false,store:{model:"Genesis.model.frontend.MainPage",data:Ext.Array.pluck(d.slice(e*6,((e+1)*6)),"data")},itemTpl:Ext.create("Ext.XTemplate",'<div class="mainPageItemWrapper x-hasbadge">',"{[this.getPrizeCount(values)]}",'<div class="photo"><img src="{[this.getPhoto(values.photo_url)]}" /></div>','<div class="photoName">{name}</div>',"</div>",{getPrizeCount:function(j){var l=0;var k=j.pageCntlr;var h=Ext.StoreMgr.get("MerchantPrizeStore");if(h){l=h.getCount();}return(((l>0)&&(k=="Prizes"))?'<span class="x-badge round">'+l+"</span>":"");},getPhoto:function(h){return Ext.isEmpty(h)?Ext.BLANK_IMAGE_URL:h;}}),autoScroll:true});}if(g.getInnerItems().length>0){g.setActiveItem(0);}},beforeDeactivate:function(){var a=Ext.ComponentQuery.query("viewportview")[0];a.getNavigationBar().removeCls("kbTitle");},afterActivate:function(){var a=Ext.ComponentQuery.query("viewportview")[0];a.getNavigationBar().addCls("kbTitle");},afterDeactivate:function(){}});Ext.define("Genesis.view.LoginPage",{extend:"Ext.Container",requires:["Ext.ActionSheet"],alias:"widget.loginpageview",config:{title:"",cls:"bgImage",hideNavBar:true,changeTitle:false,scrollable:false},initialize:function(){var a=Ext.create("Ext.ActionSheet",{modal:false,style:{background:"transparent",border:"none"},showAnimation:null,hideAnimation:null,defaultUnit:"em",padding:"1em",hideOnMaskTap:false,defaults:{defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"},items:[{tag:"facebook",text:"Facebook"},{tag:"createAccount",text:"Create Account"},{tag:"signIn",text:"Sign In"}]});this.add(a);this.callParent(arguments);},beforeActivate:function(b,a){},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.SignInPage",{extend:"Ext.form.Panel",alias:"widget.signinpageview",requires:["Ext.field.Email","Ext.field.Password"],config:{title:"Sign In",changeTitle:false,scrollable:"vertical",items:[{xtype:"fieldset",title:"Login Credentials:",defaults:{required:true,labelAlign:"top"},items:[{xtype:"emailfield",name:"username",label:"User Name",clearIcon:true,placeHolder:"Email Address"},{xtype:"passwordfield",name:"password",label:"Password",clearIcon:false}]},{xtype:"button",ui:"login",tag:"login",text:"Sign In"}]},beforeActivate:function(b,a){b.reset();},beforeDeactivate:function(b,a){},afterActivate:function(b,a){},afterDeactivate:function(b,a){}});Ext.define("Genesis.view.CreateAccountPage",{extend:"Ext.form.Panel",alias:"widget.createaccountpageview",requires:["Ext.field.Text","Ext.field.Email","Ext.field.Password"],config:{title:"Create Account",changeTitle:false,scrollable:"vertical",items:[{xtype:"fieldset",title:"Account Credentials:",defaults:{required:true,labelAlign:"top"},items:[{xtype:"textfield",name:"name",label:"Full Name",clearIcon:true,placeHolder:"John Smith"},{xtype:"emailfield",name:"username",label:"User Name",clearIcon:true,placeHolder:"Email Address"},{xtype:"passwordfield",name:"password",label:"Password",clearIcon:false}]},{xtype:"button",ui:"createAccount",tag:"createAccount",text:"Create Account"}]},beforeActivate:function(b,a){b.reset();},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.Accounts",{extend:"Ext.Container",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar"],alias:"widget.accountsview",config:{title:" ",changeTitle:false,cls:"accountsMain",layout:"fit",items:[{xtype:"list",store:"CustomerStore",tag:"accountsList",scrollable:"vertical",cls:"accountsList",emptyText:" ",pinHeaders:false,grouped:true,itemTpl:Ext.create("Ext.XTemplate",'<tpl if="this.isValidCustomer(values)">','<div class="photo">','<img src="{[this.getPhoto(values)]}"/>',"</div>",'<div class="listItemDetailsWrapper">','<div class="points">{[this.getPoints(values)]}</div>',"</div>","</tpl>",{isValidCustomer:function(a){return true;},getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_small"].url;},getPoints:function(a){return a.points+" Pts";}}),onItemDisclosure:Ext.emptyFn}]},beforeActivate:function(c,a){var b=_application.getController("Accounts").getMode();switch(b){case"profile":c.getInitialConfig().title="Accounts";break;case"transfer":c.getInitialConfig().title=" ";break;}},beforeDeactivate:function(c,b){var a=Ext.ComponentQuery.query("viewportview")[0];a.getNavigationBar().removeCls("kbTitle");},afterActivate:function(d,b){var c=_application.getController("Accounts").getMode();switch(c){case"profile":break;case"emailtransfer":case"transfer":d.getInitialConfig().title=" ";var a=Ext.ComponentQuery.query("viewportview")[0];a.getNavigationBar().addCls("kbTitle");break;}},afterDeactivate:function(b,a){}});Ext.define("Genesis.view.MerchantAccount",{extend:"Ext.Container",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar","Ext.tab.Bar","Genesis.view.widgets.MerchantAccountPtsItem"],alias:"widget.merchantaccountview",config:{tag:"merchantMain",cls:"merchantMain",title:"Venue Name",changeTitle:false,scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{tag:"tbPanel",xtype:"dataview",store:{model:"Genesis.model.Venue",autoLoad:false},useComponents:true,scrollable:false,defaultType:"merchantaccountptsitem",defaultUnit:"em",margin:"0 0 0.8 0"},{tag:"prizesWonPanel",xtype:"component",cls:"prizesWonPanel",tpl:Ext.create("Ext.XTemplate",'<div class="prizeswonphoto">','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">{[this.getDesc(values)]}</div>',"</div>",{getTitle:function(a){return"Prizes won this month";},getDesc:function(a){return a.winners_count+" Winners!";}}),},{xtype:"container",tag:"feedContainer",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"toolbar",ui:"dark",cls:"feedPanelHdr",centered:false,items:[{xtype:"title",title:"What can I get?"},{xtype:"spacer"}]},{xtype:"list",scrollable:false,ui:"bottom-round",store:"EligibleRewardsStore",emptyText:" ",cls:"feedPanel separator",itemTpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="listItemDetailsWrapper" style="{[this.getDisclose(values)]}">','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">{[this.getDesc(values)]}</div>',"</div>",{getDisclose:function(a){switch(a.reward_type){case"vip":a.disclosure=false;break;}return((a.disclosure===false)?"padding-right:0;":"");},getPhoto:function(a){if(!a.photo){return Genesis.view.client.Rewards.getPhoto({value:a.reward_type});}return a.photo.url;},getTitle:function(a){return a.reward_title;},getDesc:function(a){return a.reward_text;}}),onItemDisclosure:Ext.emptyFn}]},{xtype:"container",tag:"descContainer",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"toolbar",cls:"descPanelHdr",ui:"light",centered:false,items:[{xtype:"title",title:"About Us"},{xtype:"spacer"}]},{xtype:"container",cls:"descPanel separator",tag:"descPanel",tpl:Ext.create("Ext.XTemplate","{[this.getDesc(values)]}",{getDesc:function(a){return a.get("description");}})}]},{docked:"bottom",cls:"navigationBarBottom",xtype:"tabbar",ui:"light",layout:{pack:"justify",align:"center"},scrollable:{direction:"horizontal",indicators:false},defaults:{iconMask:true,iconAlign:"top"},items:[{iconCls:"home",tag:"home",title:"Home"},{iconCls:"prizes",tag:"prizes",badgeCls:"x-badge round",title:"Prizes"},{iconCls:"rewards",tag:"rewards",title:"Rewards"},{xtype:"spacer"},{iconCls:"challenges",tag:"challenges",title:"Challenges"},{xtype:"spacer"},{iconCls:"redeem",tag:"redemption",title:"Redeem"},{iconCls:"tocheckedinmerch",tag:"main",title:"Main Menu"},{iconCls:"explore",tag:"browse",title:"Explore"}]}]},statics:{},beforeActivate:function(c,a){var b=_application.getController("Viewport").getVenue();if(b){c.getInitialConfig().title=b.get("name");}},beforeDeactivate:function(b,a){},afterActivate:function(b,a){},afterDeactivate:function(b,a){}});Ext.define("Genesis.view.MerchantDetails",{extend:"Ext.Container",requires:["Ext.dataview.DataView","Ext.XTemplate","Ext.Map","Genesis.view.widgets.MerchantDetailsItem"],alias:"widget.merchantdetailsview",config:{title:"Venue Name",changeTitle:true,cls:"merchantDetails",layout:{type:"vbox",align:"stretch",pack:"start"},defaults:{cls:"separator"},items:[{xtype:"dataview",cls:"separator",useComponents:true,defaultType:"merchantdetailsitem",scrollable:undefined,store:{model:"Genesis.model.Venue",autoLoad:false}},{xtype:"component",tag:"map",flex:1,cls:"separator gmap",defaultUnit:"em",listeners:{painted:function(d,c){cntlr=_application.getController("Merchants");var b=d.innerElement.getSize();d.setSize(b.width,b.height);var e=Ext.Object.toQueryString(Ext.apply({zoom:15,scale:window.devicePixelRatio,maptype:"roadmap",sensor:false,size:b.width+"x"+b.height},cntlr.markerOptions));var a=Ext.String.urlAppend(cntlr.self.googleMapStaticUrl,e);d.setData({width:b.width,height:b.height,photo:a});}},tpl:Ext.create("Ext.XTemplate",'<img height="{height}" width="{width}" src="{photo}"/>')}]},beforeActivate:function(){},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.client.SettingsPage",{extend:"Ext.form.Panel",requires:["Ext.dataview.List","Ext.XTemplate","Genesis.view.widgets.ListField"],alias:"widget.clientsettingspageview",config:{title:"Settings",changeTitle:false,scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"fieldset",title:"Login Profile",items:[{xtype:"listfield",iconCls:"facebook",name:"facebook",value:"Facebook"}]},{xtype:"fieldset",title:"About Kickbak",items:[{xtype:"textfield",value:"Version 1.0",readOnly:true},{xtype:"listfield",name:"terms",value:"Terms & Conditions"},{xtype:"listfield",name:"privacy",value:"Privacy"},{xtype:"listfield",name:"aboutus",value:"About Us"}]}]},beforeActivate:function(){},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.client.AccountsTransfer",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar","Ext.field.Text"],alias:"widget.clientaccountstransferview",config:{title:" ",changeTitle:false,layout:"vbox",items:[{xtype:"container",tag:"accountsTransferMain",cls:"accountsTransferMain",flex:1,layout:{type:"card",animation:{duration:600,easing:"ease-in-out",type:"slide",direction:"down"}},activeItem:0,defaults:{layout:"fit"},items:[{xtype:"container",tag:"accountsTransferMode",cls:"accountsTransferMode",layout:"vbox",items:[{docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Select Options :"},{xtype:"spacer",align:"right"}]},{xtype:"list",scrollable:false,cls:"transferPanel",data:[{text:"Transfer Now",cls:"sender",tag:"sender"},{text:"Email Transfer",cls:"emailsender",tag:"emailsender"},{text:"Receive",cls:"recipient",tag:"recipient"}],itemTpl:Ext.create("Ext.XTemplate",'<div class="listItemDetailsWrapper" style="padding-right:0;">','<div class="itemTitle {[this.getCls(values)]}">{[this.getTitle(values)]}</div>',"</div>",{getCls:function(a){return a.cls;},getTitle:function(a){return a.text;}})}]},{xtype:"container",tag:"accountsMainCalculator",cls:"accountsMainCalculator",items:[{docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Points to Send"},{xtype:"spacer",align:"right"}]},{docked:"top",xtype:"textfield",name:"price",clearIcon:false,placeHolder:"0",readOnly:true,required:true,cls:"accountsCalculator"},{xtype:"container",layout:"vbox",tag:"dialpad",cls:"dialpad",defaults:{xtype:"container",layout:"hbox",flex:1,defaults:{xtype:"button",flex:1}},items:[{items:[{text:"1"},{text:"2"},{text:"3"}]},{items:[{text:"4"},{text:"5"},{text:"6"}]},{items:[{text:"7"},{text:"8"},{text:"9"}]},{items:[{text:"AC"},{flex:2,text:"0"}]}]},{docked:"bottom",xtype:"button",cls:"separator",tag:"showQrCode",text:"Transfer Points!",ui:"orange-large"}]},{xtype:"container",tag:"qrcodeContainer",cls:"qrcodeContainer",items:[{docked:"top",xtype:"component",tag:"title",width:"100%",cls:"title",tpl:Ext.create("Ext.XTemplate","{[this.getPoints(values)]}",{getPoints:function(a){return a.points;}})},{xtype:"component",tag:"qrcode",cls:"qrcode"},{docked:"bottom",xtype:"button",cls:"separator done",tag:"done",text:"Transfer Complete!",ui:"orange-large"}]}]}]},beforeDeactivate:function(c,b){this.callParent(arguments);var a=Ext.ComponentQuery.query("viewportview")[0];a.getNavigationBar().removeCls("kbTitle");},afterActivate:function(c,b){this.callParent(arguments);var a=Ext.ComponentQuery.query("viewportview")[0];a.getNavigationBar().addCls("kbTitle");},statics:{}});Ext.define("Genesis.view.client.Referrals",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar","Ext.field.Text"],alias:"widget.clientreferralsview",config:{title:"Referrals",changeTitle:false,layout:"vbox",items:[{xtype:"container",tag:"referralsMain",cls:"referralsMain",flex:1,layout:{type:"card",animation:{duration:600,easing:"ease-in-out",type:"slide",direction:"down"}},activeItem:0,defaults:{layout:"fit"},items:[{xtype:"container",tag:"referralsMode",cls:"referralsMode",layout:"vbox",items:[{docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Select Options :"},{xtype:"spacer",align:"right"}]},{xtype:"list",scrollable:false,cls:"referralsPanel",data:[{text:"Refer Now!",cls:"sender",tag:"sender"},{text:"Refer over Email",cls:"emailsender",tag:"emailsender"}],itemTpl:Ext.create("Ext.XTemplate",'<div class="listItemDetailsWrapper" style="padding-right:0;">','<div class="itemTitle {[this.getCls(values)]}">{[this.getTitle(values)]}</div>',"</div>",{getCls:function(a){return a.cls;},getTitle:function(a){return a.text;}})}]},{xtype:"container",tag:"qrcodeContainer",cls:"qrcodeContainer",items:[{docked:"top",xtype:"component",tag:"title",width:"100%",cls:"title",tpl:Ext.create("Ext.XTemplate","{[this.getPoints(values)]}",{getPoints:function(a){return a.points;}})},{xtype:"component",tag:"qrcode",cls:"qrcode"},{docked:"bottom",xtype:"button",cls:"separator done",tag:"done",text:"Transfer Complete!",ui:"orange-large"}]}]}]},beforeDeactivate:function(b,a){this.callParent(arguments);},afterActivate:function(b,a){this.callParent(arguments);},statics:{}});Ext.define("Genesis.view.client.Rewards",{extend:"Genesis.view.ViewBase",requires:["Ext.Toolbar"],alias:"widget.clientrewardsview",config:{title:"Earn Rewards",changeTitle:false,layout:"fit",tag:"prizeCheck",cls:"prizeCheck",data:{},tpl:'<div class="rouletteBg"></div><div class="rouletteTable"></div><div class="rouletteBall"></div>'},hideBackButton:true,statics:{getPhoto:function(a){var b=null;switch(a.value){case"vip":b=Genesis.constants.getIconPath("miscicons",a.value);break;default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.view.client.Redemptions",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar","Genesis.view.widgets.RedemptionsPtsItem"],alias:"widget.clientredemptionsview",config:{title:"Redemptions",changeTitle:false,scrollable:"vertical",cls:"redemptionsMain",layout:"vbox",items:[{xtype:"toolbar",ui:"light",cls:"ptsEarnPanelHdr",centered:false,items:[{xtype:"title",title:"Points Earned"},{xtype:"spacer"}]},{cls:"ptsEarnPanel separator",tag:"ptsEarnPanel",xtype:"dataview",useComponents:true,scrollable:undefined,defaultType:"redemptionsptsitem",store:{model:"Genesis.model.Customer",autoLoad:false}},{xtype:"toolbar",cls:"ptsEarnPanelHdr",ui:"light",centered:false,items:[{xtype:"title",title:"Redemptions Available (Select an item below)"},{xtype:"spacer"}]},{xtype:"list",scrollable:undefined,ui:"bottom-round",store:{model:"Genesis.model.CustomerReward",autoLoad:false,grouper:{groupFn:function(a){return a.get("points")+" Points";}},sorters:[{property:"points",direction:"ASC"}]},cls:"redemptionsList separator_pad",tag:"redemptionsList",grouped:true,itemTpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="listItemDetailsWrapper">','<div class="itemTitle">{[this.getTitle(values)]}</div>',"</div>",{getPhoto:function(a){if(!a.photo){return Genesis.view.client.Redemptions.getPhoto(a.type);}return a.photo.url;},getTitle:function(a){return a.title;}}),onItemDisclosure:Ext.emptyFn}]},statics:{getPhoto:function(a){var b=null;switch(a.value){default:b=Genesis.constants.getIconPath("fooditems",a.value);break;}return b;}}});Ext.define("Genesis.view.Prizes",{extend:"Genesis.view.ViewBase",requires:["Ext.XTemplate","Ext.Carousel","Genesis.view.widgets.RewardItem"],alias:"widget.prizesview",config:{title:"Prizes Header",changeTitle:true,scrollable:false,layout:"fit",cls:"prizesMain"},beforeActivate:function(c,b){var d=_application.getController("Prizes").getMode();switch(d){case"showPrize":case"prizes":c.getInitialConfig().title="Prizes";break;case"reward":c.getInitialConfig().title="Rewards";break;case"authReward":c.getInitialConfig().title=" ";var a=Ext.ComponentQuery.query("viewportview")[0];a.getNavigationBar().addCls("kbTitle");break;}this.callParent(arguments);},beforeDeactivate:function(c,b){var d=_application.getController("Prizes").getMode();switch(d){case"showPrize":case"prizes":case"reward":break;case"authReward":var a=Ext.ComponentQuery.query("viewportview")[0];a.getNavigationBar().removeCls("kbTitle");break;}this.callParent(arguments);},statics:{getPhoto:function(a){var b=null;switch(a.value){case"earn_points":break;default:b=Genesis.constants.getIconPath("prizewon",a.value);break;}return b;}}});Ext.define("Genesis.controller.ControllerBase",{extend:"Ext.app.Controller",requires:["Ext.data.Store","Ext.util.Geolocation"],config:{listeners:{scannedqrcode:"onScannedQRcode",locationupdate:"onLocationUpdate",openpage:"onOpenPage"}},checkinMsg:"Checking in ...",loadingScannerMsg:"Loading Scanner ...",loadingMsg:"Loading ...",genQRCodeMsg:"Generating QRCode ...",retrieveAuthModeMsg:"Retrieving Authorization Code from Server ...",noCodeScannedMsg:"No Authorization Code was Scanned!",geoLocationErrorMsg:"Cannot locate your current location. Try again or enable permission to do so!",geoLocationTimeoutErrorMsg:"Cannot locate your current location. Try again or enable permission to do so!",geoLocationPermissionErrorMsg:"No permission to location current location. Please enable permission to do so!",missingVenueInfoMsg:"Error loading Venue information.",showToServerMsg:"Show this to your server before proceeding.",errProcQRCodeMsg:"Error Processing Authentication Code",cameraAccessMsg:"Accessing your Camera Phone ...",updatingServerMsg:"Updating Server ...",referredByFriendsMsg:"Have you been referred to by a friend to this merchant?",showScreenTimeoutExpireMsg:function(a){return a+" are up! Press OK to confirm.";},showScreenTimeoutMsg:function(a){return"You have "+a+" to show this screen to a employee before it disappears!";},uploadFbMsg:"Uploading to Facebook ...",uploadServerMsg:"Uploading to server ...",statics:{playSoundFile:function(b,a,c){if(Genesis.constants.isNative()){switch(b.type){case"FX":case"Audio":LowLatencyAudio.play(b.name,a||Ext.emptyFn,c||Ext.emptyFn);break;case"Media":b.successCallback=a||Ext.emptyFn;b.name.play();break;}}else{b.successCallback=a||Ext.emptyFn;Ext.get(b.name).dom.play();}},stopSoundFile:function(a){if(Genesis.constants.isNative()){LowLatencyAudio.stop(a.name);}else{var b=Ext.get(a.name).dom;b.pause();b.currentTime=0;}},genQRCodeFromParams:function(j,b){var f=this;var g;var a=function(){return Math.random().toFixed(16);};GibberishAES.size(256);var d=Genesis.constants.getPrivKey();var c;for(key in d){try{c=new Date().addHours(3);g=GibberishAES.enc(Ext.encode(Ext.applyIf({expiry_ts:c.getTime()},j)),d[key]);}catch(h){}break;}console.log("\nEncrypted Code Length: "+g.length+"\nEncrypted Code ["+g+"]\nExpiry Date: ["+c+"]");return(b)?[g,0,0]:f.genQRCode(g);},genQRCode:function(e,c,f){c=c||4;f=f||8;var d=0;var b=QRCode(f,"L");b.addData(e);b.make();var a=b.createBase64(c,d);console.log("QR Code Minimum Size = ["+a[1]+"x"+a[1]+"]");return[a[0],a[1],a[1]];},genQRCodeInlineImg:function(e,c,f){c=c||4;f=f||8;var d=0;var a=QRCode(f,"L");a.addData(e);a.make();var b=a.createTableTag(c,d);return b;}},init:function(){this.callParent(arguments);},getViewPortCntlr:function(){return this.getApplication().getController("Viewport");},getViewport:function(){return this.getViewPortCntlr().getView();},onOpenPage:function(d,b,a){if((appName=="GetKickBak")&&!Ext.device.Connection.isOnline()&&(b!="login")){Ext.device.Notification.show({title:"Network Error",message:"You have lost internet connectivity"});return;}var e=this.getApplication();var c=e.getController(d);e.dispatch({action:(!b)?"openMainPage":"openPage",args:(!b)?[]:[b,a],controller:c,scope:c});},updateRewards:function(b){var m=this;try{var c=b.rewards;if(c){var l=m.getViewPortCntlr();var d=b.venue_id||l.getVenue().getId();console.debug("Total Redemption Rewards - "+c.length);var n=Ext.StoreMgr.get("RedemptionsStore");for(var h=0;h<c.length;h++){c[h]["venue_id"]=d;}n.setData(c);}var a=b.eligible_rewards;if(a){console.debug("Total Eligible Rewards - "+a.length);var o=Ext.StoreMgr.get("EligibleRewardsStore");o.setData(a);}var g=b.winners_count;if(g>=0){console.debug("Prizes won by customers at this merchant this month - ["+g+"]");var f=m.getApplication();var j=f.getController("Merchants");f.dispatch({action:"onUpdateWinnersCount",args:[b],controller:j,scope:j});}var p=b.data;if(p){m.fireEvent("authcoderecv",b);}}catch(k){console.debug("updateRewards Exception - "+k);}},checkReferralPrompt:function(d,b){var c=this;var a=c.getViewPortCntlr();b=b||Ext.emptyFn;d=d||a.getVenue().getMerchant().getId();if((a.getCheckinInfo().customer.get("visits")==0)&&(Genesis.db.getReferralDBAttrib("m"+d))){Ext.device.Notification.show({title:"Friends Referral",message:c.referredByFriendsMsg,buttons:["Yes","No"],callback:function(e){if(e.toLowerCase()=="yes"){c.fireEvent("openpage","client.Challenges","referrals",b);}else{b();}}});}else{b();}},pushView:function(d){var b=this.getViewport();var e=this.getApplication();var a=b.stack;var c=(a.length>1)?a[a.length-2]:null;if(c&&c==d){this.popView();}else{b.push(d);}},popView:function(c,g,d,f){var a=this.getViewport();var h=this.getApplication();a.pop();},getMainPage:Ext.emptyFn,openMainPage:Ext.emptyFn,openPage:Ext.emptyFn,goToMain:function(){var b=this;var a=b.getViewPortCntlr();a.setLoggedIn(true);b.getViewport().reset();b.fireEvent("openpage","MainPage","main");console.log("LoggedIn, Going back to Main Page ...");},isOpenAllowed:function(){return"Cannot Open Folder";},getGeoLocation:function(a){var b=this;a=a||0;console.debug("Getting GeoLocation ...");if(!Genesis.constants.isNative()){b.fireEvent("locationupdate",{coords:{getLatitude:function(){return"-50.000000";},getLongitude:function(){return"50.000000";}}});}else{console.debug("Connection type: ["+Ext.device.Connection.getType()+"]");if(!b.geoLocation){b.geoLocation=Ext.create("Ext.util.Geolocation",{autoUpdate:false,frequency:1,maximumAge:30000,timeout:50000,allowHighAccuracy:true,listeners:{locationupdate:function(e,d){if(!e){console.log("No GeoLocation found!");return;}var c={coords:e};console.debug("\nLatitude: "+e.getLatitude()+"\nLongitude: "+e.getLongitude()+"\nAltitude: "+e.getAltitude()+"\nAccuracy: "+e.getAccuracy()+"\nAltitude Accuracy: "+e.getAltitudeAccuracy()+"\nHeading: "+e.getHeading()+"\nSpeed: "+e.getSpeed()+"\nTimestamp: "+new Date(e.getTimestamp())+"\n");b.fireEvent("locationupdate",c);},locationerror:function(g,c,d,f,e){console.debug("GeoLocation Error["+e+"]");Ext.Viewport.setMasked(false);if(d){console.debug("PERMISSION_DENIED");Ext.device.Notification.show({title:"Permission Error",message:b.geoLocationPermissionErrorMsg});}else{if(f){console.debug("POSITION_UNAVAILABLE");if(++a<=5){Ext.Function.defer(b.getGeoLocation,1*1000,b,[callback,a]);console.debug("Retry getting current location("+a+") ...");}else{Ext.device.Notification.show({title:"Error",message:b.geoLocationErrorMsg});}}else{if(c){console.debug("TIMEOUT");Ext.device.Notification.show({title:"Timeout Error",message:b.geoLocationTimeoutErrorMsg});}}}}}});}b.geoLocation.updateLocation();}},scanQRCode:function(){var b=this;var a=function(f){Ext.Viewport.setMasked(false);config.callback();console.debug("Failed because: "+f);};var e=function(f){var g;Ext.Viewport.setMasked(false);if(Genesis.constants.isNative()){switch(window.plugins.qrCodeReader.scanType){case"RL":g=(f.response=="undefined")?"":(f.response||"");console.debug("QR Code RL  = "+g);break;case"Nigma":g=(f.response=="undefined")?"":(f.response||"");if(!g){console.debug("QR Code Nigma = Empty");}else{console.debug("QR Code Nigma = "+((g.responseCode)?g.responseCode:"NONE")+" Sent = "+g.bytesSent+" bytes");}if(g&&g.responseCode){g=g.responseCode;}break;case"Default":g=f;if(!g||g.format!="QR_CODE"){g=null;console.debug("QR Code Default = Unsupported Code");}else{if(g.cancelled){g=Math.random().toFixed(16);}else{g=g.text;console.debug("QR Code Default = "+((g)?g:"NONE"));}}break;}}else{g=f.response;console.debug("QR Code = "+g);}b.fireEvent("scannedqrcode",g);};console.debug("Scanning QR Code ...");if(!Genesis.constants.isNative()){var d=0;if(!merchantMode){var c=Ext.StoreMgr.get("CheckinExploreStore").first()||b.getViewPortCntlr().getVenue()||null;d=c?c.getId():0;}e({response:d});}else{Ext.Viewport.setMasked({xtype:"loadmask",message:b.loadingScannerMsg});window.plugins.qrCodeReader.getCode(e,a);}}});var _application;Ext.define("Genesis.controller.Viewport",{extend:"Genesis.controller.ControllerBase",requires:["Ext.util.DelayedTask"],statics:{},config:{sound_files:null,loggedIn:false,customer:null,venue:null,metaData:null,checkinInfo:{venue:null,customer:null,metaData:null},refs:{view:"viewportview",shareBtn:"viewportview button[tag=shareBtn]",fbShareBtn:"actionsheet button[tag=fbShareBtn]",checkInNowBtn:"button[tag=checkInNow]"},control:{view:{push:"onPush"},fbShareBtn:{tap:"onShareMerchantTap"},"viewportview button[tag=close]":{tap:"popView"},checkInNowBtn:{tap:"onCheckinScanTap"},"tabbar[cls=navigationBarBottom] button[tag=info]":{tap:"onInfoTap"},"tabbar[cls=navigationBarBottom] button[tag=home]":{tap:"onHomeButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=prizes]":{tap:"onPrizesButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=accounts]":{tap:"onAccountsButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=challenges]":{tap:"onChallengesButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=rewards]":{tap:"onRewardsButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=redemption]":{tap:"onRedemptionsButtonTap"},tabbar:{tabchange:"onTabBarTabChange"}}},gatherCheckinInfoMsg:"Gathering Checkin information ...",retrieveChallengesMsg:"Retrieving Challenges ...",fbShareSuccessMsg:"Posted on your Timeline!",onShareMerchantTap:function(a,h,d,g){var f=this;var c=Genesis.constants.site;Genesis.constants.facebook_onLogin(function(j){var e=f.getVenue();var b=e.getMerchant();console.log("Posting to Facebook ...");FB.api("/me/feed","post",{name:e.get("name"),link:e.get("website")||c,caption:e.get("website")||c,description:e.get("description"),picture:b.get("photo")["thumbnail_ios_medium"].url,message:"Check out this place!"},function(k){Ext.Viewport.setMasked(false);if(!k||k.error){console.log("Post was not published to Facebook.");}else{console.log(f.fbShareSuccessMsg);Ext.device.Notification.show({title:"Facebook Connect",message:f.fbShareSuccessMsg});}});},true);},onInfoTap:function(a,f,c,d){},onLocationUpdate:function(a){var c=this;var e=c.getApplication();var b=e.getController("Checkins");var d=Ext.StoreMgr.get("CheckinExploreStore");Venue.setFindNearestURL();d.load({params:{latitude:a.coords.getLatitude(),longitude:a.coords.getLongitude()},callback:function(g,f){if(f.wasSuccessful()){b.setPosition(a);e.dispatch({action:"onCheckinScanTap",controller:b,args:[],scope:b});}else{Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:c.missingVenueInfoMsg});}},scope:c});},onCheckinScanTap:function(a,f,c,g){var d=this;Ext.Viewport.setMasked({xtype:"loadmask",message:d.gatherCheckinInfoMsg});d.getGeoLocation();},onAccountsButtonTap:function(a,f,c,d){this.fireEvent("openpage","Accounts");console.log("Going to Accounts Page ...");},onChallengesButtonTap:function(a,g,c,f){var d=this;var h=d.getVenue();Ext.Viewport.setMasked({xtype:"loadmask",message:d.retrieveChallengesMsg});Challenge.setGetChallengesURL();Challenge.load(h.getId(),{params:{merchant_id:h.getMerchant().getId(),venue_id:h.getId()},callback:function(b,e){Ext.Viewport.setMasked(false);if(e.wasSuccessful()){h.challenges().add(e.getRecords());d.fireEvent("openpage","client.Challenges");console.log("Going to Challenges Page ...");}}});},onRewardsButtonTap:function(a,f,c,d){this.fireEvent("openpage","client.Rewards","rewards");console.log("Going to Client Rewards Page ...");},onRedemptionsButtonTap:function(a,f,c,d){this.fireEvent("openpage","client.Redemptions","redemptions");console.log("Going to Client Redemptions Page ...");},onPrizesButtonTap:function(a,f,c,d){this.fireEvent("openpage","Prizes");console.log("Going to Prizes Page ...");},onHomeButtonTap:function(a,g,c,f){var d=this.getViewport();d.reset();d.setFlipAnimation();this.fireEvent("openpage","MainPage");console.log("Going back to HomePage ...");},onTabBarTabChange:function(b,d,c,a){Ext.defer(function(){if(d){d.setActive(false);}if(c){c.setActive(false);}},500);return true;},onPush:function(a,b){},init:function(b){var a=this;console.log("Viewport Init");_application=b;a.callParent(arguments);console.log("Loading License Keys ...");Genesis.constants.getPrivKey();QRCodeReader.prototype.scanType="Default";console.debug("QRCode Scanner Mode["+QRCodeReader.prototype.scanType+"]");if(!merchantMode){Genesis.constants.initFb();a.updateRewardsTask=Ext.create("Ext.util.DelayedTask");}Ext.defer(function(){this.sound_files={};var c=[["rouletteSpinSound","roulette_spin_sound","Media"],["winPrizeSound","win_prize_sound","Media"],["clickSound","click_sound","FX"],["beepSound","beep.wav","FX"]];for(var d=0;d<c.length;d++){this.loadSoundFile.apply(this,c[d]);}},1,a);},loadSoundFile:function(a,b,d){var f=this;var c="."+(b.split(".")[1]||"mp3");b=b.split(".")[0];if(Genesis.constants.isNative()){switch(d){case"FX":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,function(){console.debug("loaded "+b);},function(g){console.debug("Audio Error: "+g);});break;case"Audio":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,3,function(){console.debug("loaded "+b);},function(g){console.debug("Audio Error: "+g);});break;case"Media":b=new Media("resources/audio/"+b+c,function(){f.sound_files[a].successCallback();},function(g){console.log("Audio Error: "+g);});break;}}else{var e=Ext.get(b);if(e){e.dom.addEventListener("ended",function(){f.sound_files[a].successCallback();},false);}}f.sound_files[a]={name:b,type:d};},openMainPage:function(){var c=Genesis.db.getLocalDB();var a=(c.auth_code)?true:false;if(!merchantMode){if(a){var d=this.getApplication();var b=d.getController("MainPage");this.setLoggedIn(a);console.debug("Going to Main Page ...");if(c.currFbId>0){d.dispatch({action:"facebookLogin",args:[c.fbResponse],controller:b,scope:b});}else{d.dispatch({action:"onSignIn",args:[],controller:b,scope:b});}}else{console.debug("Going to Login Page ...");this.fireEvent("openpage","MainPage","login");}}}});Ext.define("Genesis.controller.Settings",{extend:"Genesis.controller.ControllerBase",statics:{settings_path:"/settings",},xtype:"settingsCntlr",config:{refs:{clientSettingsPage:{selector:"clientsettingspageview",autoCreate:true,xtype:"clientsettingspageview"},serverSettingsPage:{selector:"serversettingspageview",autoCreate:true,xtype:"serversettingspageview"}},control:{}},init:function(){this.callParent(arguments);this.initClientControl();this.initServerControl();console.log("Settings Init");},initClientControl:function(){this.control({"clientsettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"clientsettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"clientsettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"},"clientsettingspageview listfield[name=facebook]":{clearicontap:"onFacebookTap"}});},initServerControl:function(){this.control({"serversettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"serversettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"serversettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"}});},getMainPage:function(){return this.getSettingsPage();},openMainPage:function(){var a=this.getMainPage();this.pushView(a);console.log("SettingsPage Opened");},onTermsTap:function(a,c){Ext.device.Notification.show({title:"Button Tapped",message:"Disclose List Item"});},onFacebookTap:function(a,c){Genesis.constants.facebook_onLogin(function(b){Ext.Viewport.setMasked(false);Customer.setUpdateFbLoginUrl();Customer.load(1,{jsonData:{},params:{user:Ext.encode(b)}});},true);},onTermsTap:function(a,c){Ext.device.Notification.show({title:"Terms Tapped",message:"Disclose List Item"});},onPrivacyTap:function(a,c){Ext.device.Notification.show({title:"Privacy Tapped",message:"Disclose List Item"});},onAboutUsTap:function(a,c){Ext.device.Notification.show({title:"About Us Tapped",message:"Disclose List Item"});},openPage:function(a){var b;switch(a){case"client":b=this.getClientSettingsPage();break;case"server":b=this.getServerSettingsPage();break;}this.pushView(b);},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.MainPage",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store","Genesis.model.EarnPrize"],statics:{mainPage_path:"/mainPage",loginPage_path:"/loginPage",sign_in_path:"/sign_in",sign_out_path:"/sign_out",},xtype:"mainPageCntlr",config:{models:["frontend.MainPage","frontend.Signin","frontend.Account","EligibleReward","Customer","User","Merchant","EarnPrize","CustomerReward"],listeners:{scannedqrcode:"onScannedQRcode",locationupdate:"onLocationUpdate",authcoderecv:"onAuthCodeRecv",openpage:"onOpenPage"},refs:{login:{selector:"loginpageview",autoCreate:true,xtype:"loginpageview"},signin:{selector:"signinpageview",autoCreate:true,xtype:"signinpageview"},createAccount:{selector:"createaccountpageview",autoCreate:true,xtype:"createaccountpageview"},main:{selector:"mainpageview",autoCreate:true,xtype:"mainpageview"},mainCarousel:"mainpageview",infoBtn:"viewportview button[tag=info]"},control:{login:{activate:"onLoginActivate",deactivate:"onLoginDeactivate"},"actionsheet button[tag=facebook]":{tap:"onFacebookTap"},"actionsheet button[tag=createAccount]":{tap:"onCreateAccountTap"},"actionsheet button[tag=signIn]":{tap:"onSignInTap"},"signinpageview button[tag=login]":{tap:"onSignInSubmit"},"actionsheet button[tag=logout]":{tap:"onLogoutTap"},main:{activate:"onActivate",deactivate:"onDeactivate"},"mainpageview dataview":{select:"onItemSelect",itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd"},createAccount:{activate:"onCreateActivate",deactivate:"onCreateDeactivate"},"createaccountpageview button[tag=createAccount]":{tap:"onCreateAccountSubmit"}}},signInFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please Try Again";},init:function(b){this.callParent(arguments);var a=this;Ext.regStore("MainPageStore",{model:"Genesis.model.frontend.MainPage",autoLoad:true,listeners:{scope:a,load:function(e,d,g,c,f){if(merchantMode){a.goToMain();}}}});if(!merchantMode){Ext.regStore("UserStore",{model:"Genesis.model.User",autoLoad:false});a.initMerchantPrizeStore();Ext.regStore("EligibleRewardsStore",{model:"Genesis.model.EligibleReward",autoLoad:false});a.initCustomerStore();}console.log("MainPage Init");},initCustomerStore:function(){var b=this,a;Ext.regStore("CustomerStore",{model:"Genesis.model.Customer",autoLoad:false,pageSize:1000,listeners:{scope:b,load:function(f,e,h,d,g){var c=f.getProxy().getReader().metaData;if(h&&c&&c.auth_token){a=Genesis.db.getLocalDB();console.debug("auth_code ["+a.auth_code+"]\ncurrFbId ["+a.currFbId+"]");b.goToMain();}},metachange:function(e,j,h){var d=j.getReader().metaData;var c=d.prizes;if(c){console.debug("Total Prizes - "+c.length);for(var g=0;g<c.length;g++){c[g].reward={data:c[g].reward};}Ext.StoreMgr.get("MerchantPrizeStore").setData(c);}var f=d.auth_token;if(f){console.debug("Login Auth Code - "+f);a=Genesis.db.getLocalDB();if(f!=a.auth_code){Genesis.db.setLocalDBAttrib("auth_code",f);}}b.getViewPortCntlr().updateRewardsTask.delay(1*1000,b.updateRewards,b,[d]);}},grouper:{groupFn:function(c){return c.getMerchant().get("name");}},sorters:[{sorterFn:function(e,c){var f=e.getMerchant().get("name"),d=c.getMerchant().get("name");if(f<d){return -1;}if(f>d){return 1;}return 0;}}]});},initMerchantPrizeStore:function(){var a=this;var b=a.getApplication();Ext.regStore("MerchantPrizeStore",{model:"Genesis.model.EarnPrize",autoLoad:false,clearOnPageLoad:false,sorters:[{sorterFn:function(d,c){return d.getMerchant().getId()-c.getMerchant().getId();}},{sorterFn:function(d,c){return Date.parse(c.get("expiry_date"))-Date.parse(d.get("expiry_date"));}},{sorterFn:function(d,c){return c.getId()-d.getId();}}],listeners:{scope:this,metachange:function(d,f,e){var c=b.getController("client.Rewards");b.dispatch({action:"onPrizeStoreMetaChange",args:[d,f.getReader().metaData],controller:c,scope:c});}}});},onAuthCodeRecv:function(b){var c=this;var d=c.getApplication();var a=d.getController("Accounts");d.dispatch({action:"onAuthCodeRecv",args:[b],controller:a,scope:a});},onItemSelect:function(f,b,c){f.deselect([b],false);console.log("Controller=["+b.data.pageCntlr+"]");var a=this.getApplication().getController(b.get("pageCntlr"));var e=a.isOpenAllowed();if(e===true){if(b.get("subFeature")){a.openPage(b.get("subFeature"));}else{a.openMainPage();}}else{Ext.device.Notification.show({title:"Error",message:e});}return false;},onItemTouchStart:function(g,a,f,c,b){},onItemTouchEnd:function(g,a,f,c,b){},onActivate:function(b,a){this.getInfoBtn()[(merchantMode)?"hide":"show"]();},onDeactivate:function(b,a){this.getInfoBtn().hide();},facebookLogin:function(a){Customer.setFbLoginUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:a});},onLoginActivate:function(b,a){this.getInfoBtn().hide();},onLoginDeactivate:function(b,a){},onLogoutTap:function(j,c,d,k){var h=this;var f=h.getViewport();var m=h.getViewPortCntlr();var g=0;var l=function(){console.log("Resetting Session information ...");f.setFadeAnimation();m.setLoggedIn(false);Genesis.db.removeLocalDBAttrib("auth_code");if(db.currFbId>0){Genesis.constants.facebook_onLogout(null,true);}h.fireEvent("openpage","MainPage","login");};var a=function(){if(db.auth_code){console.log("Logging out ...");Customer.setLogoutUrl(Genesis.db.getLocalDB()["auth_code"]);Ext.StoreMgr.get("CustomerStore").load({jsonData:{},callback:function(e,b){if(b.wasSuccessful()){console.log("Logout Successful!");}else{console.log("Logout Failed!");}}});}l();};j.parent.onAfter({hiddenchange:function(){if((g|=1)==17){a();}},single:true});j.parent.hide();if(db.currFbId>0){console.log("Logging out of Facebook ...");Genesis.constants.facebook_onLogout(function(){if((g|=16)==17){a();}});}else{console.log("No Login info found from Facebook ...");if((g|=16)==17){a();}}},onFacebookTap:function(a,g,c,f){var d=this;Genesis.db.removeLocalDBAttrib("currFbId");Genesis.constants.facebook_onLogin(function(b){console.log("Logging into Kickbak using Facebook account ...");Ext.Viewport.setMasked(false);d.facebookLogin(b);},true);},onCreateAccountTap:function(a,f,c,d){this.pushView(this.getCreateAccount());},onSignInTap:function(a,f,c,d){this.pushView(this.getSignin());},onCreateAccountSubmit:function(k,h,j,n){var g=this.getCreateAccount();var o=g.getValues();var f=Ext.create("Genesis.model.frontend.Account",o);var a=f.validate();var d=Genesis.db.getLocalDB()["fbResponse"]||null;if(!a.isValid()){var m=a.first();var l=Ext.ComponentQuery.query("field[name="+m.getField()+"]")[0].getLabel();var p=l+" "+m.getMessage()+Genesis.constants.addCRLF()+"Please Try Again";console.log(p);Ext.device.Notification.show({title:"Oops",message:p});}else{console.debug("Creating Account ...");var c={name:o.name,email:o.username,password:o.password};if(d){c=Ext.apply(c,d);}Customer.setCreateAccountUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:{user:Ext.encode(c)}});}},onSignIn:function(d,a){Genesis.constants.facebook_onLogout(null,Genesis.db.getLocalDB()["currFbId"]>0);var b=this;var c={};if(d){c={email:d,password:a};}Customer.setLoginUrl();Ext.StoreMgr.get("CustomerStore").load({params:c,jsonData:{},callback:function(f,e){if(!e.wasSuccessful()){Genesis.constants.resetStorage();b.fireEvent("openpage","MainPage","login");}}});},onSignInSubmit:function(g,d,f,k){var l=this.getSignin();var m=l.getValues();var c=Ext.create("Genesis.model.frontend.Signin",m);var a=c.validate();if(!a.isValid()){var j=a.first();var h=Ext.ComponentQuery.query("field[name="+j.getField()+"]")[0].getLabel();Ext.device.Notification.show({title:"Oops",message:signInFailMsg(h+" "+j.getMessage())});}else{this.onSignIn(m.username,m.password);}},onCreateActivate:function(e,b){var a=Genesis.db.getLocalDB()["fbResponse"]||null;if(a){var d=this.getCreateAccount();d.setValues({name:a.name,username:a.email});}},onCreateDeactivate:function(b,a){},openPage:function(a){switch(a){case"main":this.pushView(this.getMainPage());break;case"merchant":var c=this.getApplication();var b=c.getController("Merchants");c.dispatch({action:"onGotoCheckedInAccountTap",args:[],controller:b,scope:b});break;case"login":Ext.Viewport.setMasked(false);this.pushView(this.getLogin());break;}},getMainPage:function(){return this.getMain();},openMainPage:function(){var a=this.getViewPortCntlr();this.pushView(this.getMainPage());console.log("MainPage Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.Checkins",{extend:"Genesis.controller.ControllerBase",statics:{checkin_path:"/checkin"},xtype:"checkinsCntlr",config:{refs:{explore:{selector:"checkinexploreview",autoCreate:true,xtype:"checkinexploreview"},checkInNowBar:"checkinexploreview container[tag=checkInNow]",shareBtn:"viewportview button[tag=shareBtn]"},control:{checkinexploreview:{activate:"onExploreActivate",deactivate:"onExploreDeactivate"},"checkinexploreview list":{select:"onExploreSelect",disclose:"onExploreDisclose"}},models:["Venue","Merchant","EarnPrize"],position:null,},metaDataMissingMsg:"Missing Checkin MetaData information.",noCheckinCodeMsg:"No Checkin Code found!",getMerchantInfoMsg:"Retrieving Merchant Info ...",init:function(){var a=this;Ext.regStore("CheckinExploreStore",{model:"Genesis.model.Venue",autoLoad:false,sorters:[{property:"distance",direction:"ASC"}],listeners:{metachange:function(b,d,c){a.getViewPortCntlr().updateRewardsTask.delay(1*1000,a.updateRewards,a,[d.getReader().metaData]);}}});Ext.regStore("CheckinStore",{model:"Genesis.model.Customer",autoLoad:false,listeners:{metachange:function(b,d,c){}}});console.log("Checkins Init");},onCheckinCommonTap:function(j){var h=this;var f=h.callback.mode;var a=h.callback.url;var e=h.callback.position;var k=h.callback.callback;var g=h.getViewPortCntlr();var c=Ext.StoreMgr.get("CheckinStore");var b=(g.getVenue()?g.getVenue().getId():null);Customer[a](b);var d={latitude:(e)?e.coords.getLatitude():0,longitude:(e)?e.coords.getLongitude():0,auth_code:j||0};if(b){d=Ext.apply(d,{venue_id:b});}console.debug("CheckIn - auth_code:'"+j+"' venue_id:'"+b+"'");c.load({jsonData:{},params:d,scope:h,callback:function(n,m){var l=c.getProxy().getReader().metaData;if(m.wasSuccessful()&&l){h.onCheckinHandler(f,l,c,b,n,m,k);}else{if(!m.wasSuccessful()&&!l){console.log(h.metaDataMissingMsg);}}}});},onScannedQRcode:function(b){var a=this;if(b){console.log(a.checkinMsg);Ext.Viewport.setMasked({xtype:"loadmask",message:a.checkinMsg});a.onCheckinCommonTap(b);}else{console.debug(a.noCheckinCodeMsg);Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:a.noCheckinCodeMsg});}},onCheckInScanNow:function(j,d,f,k,c,a,h,l){var g=this;switch(h){case"scan":g.callback={mode:c,url:a,type:h,callback:l};g.scanQRCode();break;default:g.callback={mode:c,url:a,type:"",callback:l};Ext.Viewport.setMasked({xtype:"loadmask",message:g.getMerchantInfoMsg});g.onCheckinCommonTap(null);break;}},setupCheckinInfo:function(e,d,c,b){var a=this.getViewPortCntlr();a.setVenue(d);a.setCustomer(c);a.setMetaData(b);switch(e){case"checkin":a.setCheckinInfo({venue:a.getVenue(),customer:a.getCustomer(),metaData:a.getMetaData()});break;default:break;}},onCheckinScanTap:function(a,d,c,f){this.getViewPortCntlr().setVenue(null);this.onCheckInScanNow(a,d,c,f,"checkin","setVenueScanCheckinUrl","scan",function(){Ext.device.Notification.vibrate();});},onCheckinTap:function(a,d,c,f){this.onCheckInScanNow(a,d,c,f,"checkin","setVenueCheckinUrl","scan",function(){Ext.device.Notification.vibrate();});},onNonCheckinTap:function(a,d,c,f,g){this.onCheckInScanNow(a,d,c,f,"explore","setVenueExploreUrl","noscan",g);},onCheckinHandler:function(m,p,h,a,s,l,d){var k=this.getApplication();var t=Ext.StoreMgr.get("CustomerStore");var o=Ext.StoreMgr.get("CheckinExploreStore");var e=k.getController("Merchants");var v=this.getViewPortCntlr();var c=this.getViewport();var u=false;var b,j,f,g,r;for(var q=0;q<s.length;q++){b=s[q];j=b.getId();r=b.get("points");var n=p.venue_id||o.first().getId();g=o.getById(n)||v.getVenue();console.debug("CheckIn - new_venueId:'"+n+"' venue_id:'"+a+"'");if((n==a)||(a==null)){if(Customer.isValidCustomer(j)){var f=t.getById(j);if(f!=null){Customer.updateCustomer(f,b);console.debug("Customer ID=["+f.getId()+"] is in CustAcct Database");u=true;}else{f=t.add(b)[0];console.debug("Customer ID=["+f.getId()+"] is ADDED to CustAcct Database");}}else{console.debug("Exploring Venue ...");}console.debug("CheckIn - points:'"+r+"'");this.setupCheckinInfo(m,g,f||b,p);break;}}if(q>s.length){console.debug("CheckIn - No Merchants Found!");return;}console.debug("CheckIn - Opening Merchant Account Page ...");c.silentPop(1);c.reset();c.setFlipAnimation();Ext.Viewport.setMasked(false);k.dispatch({action:"openMainPage",args:[u],controller:e,scope:e});if(d){d();}console.debug("CheckIn - Done");},onLocationUpdate:function(a){var c=this;var d=Ext.StoreMgr.get("CheckinExploreStore");var b=c.getCheckInNowBar();Venue.setFindNearestURL();d.load({params:{latitude:a.coords.getLatitude(),longitude:a.coords.getLongitude()},callback:function(f,e){if(e.wasSuccessful()){c.setPosition(a);b.setDisabled(false);}else{Ext.device.Notification.show({title:"Warning",message:c.missingVenueInfoMsg});}},scope:c});},onExploreLoad:function(c){var a=this;var b=Ext.StoreMgr.get("CheckinExploreStore");if((b.getCount()==0)||c){a.getGeoLocation();}},onExploreActivate:function(){var c=this;var a=c.getViewPortCntlr();var b=c.getCheckInNowBar();c.onExploreLoad();switch(c.mode){case"checkin":b.setDisabled(true);b.show();break;case"explore":b.hide();break;}},onExploreDeactivate:function(){},onExploreSelect:function(c,a,b){c.deselect([a]);this.onExploreDisclose(c,a);return false;},onExploreDisclose:function(f,a,h,b,g,c,d){this.getViewPortCntlr().setVenue(a);switch(this.mode){case"checkin":this.onCheckinTap(null,g,c,d);break;case"explore":this.onNonCheckinTap(null,g,c,d);break;}},openPage:function(a){var c=this.getMainPage();var b=c.query("list")[0].getPlugins()[0];b.refreshFn=b.getRefreshFn();this.mode=c.mode=a;this.pushView(c);},getMainPage:function(){return this.getExplore();},openMainPage:function(){var b=this.getMainPage();var a=b.query("list")[0].getPlugins()[0];a.refreshFn=a.getRefreshFn();this.pushView(b);console.log("Checkin Explore Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.client.Challenges",{extend:"Genesis.controller.ControllerBase",requires:["Ext.Anim"],statics:{challenges_path:"/clientChallenges"},xtype:"clientChallengesCntlr",config:{refs:{challengeBtn:"clientchallengepageview button[tag=doit]",challengePage:{selector:"clientchallengepageview",autoCreate:true,xtype:"clientchallengepageview"},challengeDescContainer:"clientchallengepageview container[tag=challengePageItemDescWrapper]",uploadPhotosPage:{selector:"uploadphotospageview",autoCreate:true,xtype:"uploadphotospageview"},uploadPhotosBackground:"uploadphotospageview component[tag=background]",postBtn:"viewportview button[tag=post]",referralsPage:{selector:"clientreferralsview",autoCreate:true,xtype:"clientreferralsview"},qrcode:"clientreferralsview component[tag=qrcode]",title:"clientreferralsview component[tag=title]",referralsContainer:"clientreferralsview container[tag=referralsMain]"},control:{challengePage:{activate:"onActivate",deactivate:"onDeactivate"},"clientchallengepageview > carousel dataview":{select:"onItemSelect"},challengeBtn:{tap:"onChallengeBtnTap"},"actionsheet button[tag=library]":{tap:"onLibraryBtnTap"},"actionsheet button[tag=album]":{tap:"onAlbumBtnTap"},"actionsheet button[tag=camera]":{tap:"onCameraBtnTap"},uploadPhotosPage:{activate:"onUploadPhotosActivate",deactivate:"onUploadPhotosDeactivate"},postBtn:{tap:"onUploadPhotosTap"},referralsPage:{activate:"onReferralsActivate"},"clientreferralsview container[tag=referralsMain] list":{select:"onReferralsSelect"},"clientreferralsview container button[tag=done]":{tap:"onCompleteReferralsChallenge"}},listeners:{scannedqrcode:"onScannedQRcode",locationupdate:"onLocationUpdate",fbphotouploadcomplete:"onFbPhotoUploadComplete",openpage:"onOpenPage"}},metaData:null,reservedReferralId:0,referralCbFn:null,samplePhotoURL:"http://photos.getkickbak.com/paella9finish1.jpg",noPhotoUploadedMsg:"Failed to upload photo to server.",fbUploadFailedMsg:"Failed to upload the photo onto your Facebook account",checkinFirstMsg:"Please Check-In before performing challenges",photoUploadFbReqMsg:"Connectivity to Facebook is required to upload photos to your account",defaultChallengeMsg:"Please Select a challenge to perform",photoUploadSuccessMsg:function(a){return"You have earned "+a+" Pts for uploading it to Facebook!";},photoTakenFailMsg:function(a){return a+Genesis.constants.addCRLF()+"No Photos were taken.";},photoUploadIncompletesMsg:"Trouble updating to server.",photoUploadFailValidationMsg:"Please enter a comment with at least 16 characters in length",getPointsMsg:function(a){return"You have earned "+a+" Pts from this challenge!";},getConsolationMsg:function(a){return a+Genesis.constants.addCRLF()+"Try our other challenges as well!";},confirmRecvReferralsMsg:"Please have your Referral Code ready to be scanned",referralFailedMsg:"Email failed to send",referralSavedMsg:"Email saved.",sendReferralSuccessMsg:function(){return"Email was sent successfully!"+Genesis.constants.addCRLF()+"Every successful referral will get your extra points!!1";},recvReferralSuccessMsg:function(){return"You have been successfully referred."+Genesis.constants.addCRLF()+"Claim your Reward Points by visiting the Merchant now!";},init:function(a){this.callParent(arguments);console.log("Challenge Init");},photoEventHandler:function(a){var e=this;if(e.imageURI){if(Genesis.constants.isNative()){var c=new FileUploadOptions();c.fileKey="image";c.fileName="DummyPhoto.jpg";c.mimeType="image/jpg";c.params={auth_token:Genesis.db.getLocalDB()["auth_code"]};c.chunkedMode=true;Ext.Viewport.setMasked({xtype:"loadmask",message:e.uploadServerMsg});var f=new FileTransfer();var d,b;f.upload(e.imageURI,Genesis.constants.host+"/api/v1/venues/share_photo",function(h){try{d=decodeURIComponent(h.response)||"";console.debug("\nResponse = ["+d+"]\nCode = "+h.responseCode+"\nSent = "+h.bytesSent);d=Ext.decode(d);if(d){b=e.metaData=d.metaData||null;b.position=a;}else{console.log("No Data returned by the server.");}}catch(g){console.log("Unable to parse the JSON returned by the server: "+g.toString());}Ext.Viewport.setMasked(false);if(b&&b.photo_url&&b.upload_token){console.log("Uploading to Facebook using upload_token["+b.upload_token+"]...");e.pushView(e.getUploadPhotosPage());}delete e.imageURI;},function(g){Ext.Viewport.setMasked(false);console.log(e.noPhotoUploadedMsg);console.log("An error has occurred: Code = "+g.code);Ext.device.Notification.show({title:"Error",message:e.noPhotoUploadedMsg(g.message+Genesis.constants.addCRLF())});delete e.imageURI;},c);}else{Ext.device.Notification.show({title:"Error",message:"Cannot upload photo in Non-Native Mode"});}}},referralEventHandler:function(f){var d=this,c;var e=d.getViewPortCntlr().getVenue().getMerchant();var b=d.getReferralsContainer();var a=f.get("tag");switch(a){case"sender":c="direct";Ext.Viewport.setMasked({xtype:"loadmask",message:d.genQRCodeMsg});break;case"emailsender":c="email";Ext.Viewport.setMasked({xtype:"loadmask",message:d.retrieveAuthModeMsg});break;}Challenge.setSendReferralsUrl(e.getId());Challenge.load(d.selectedItem.getId(),{jsonData:{},params:{merchant_id:e.getId(),type:c},callback:function(h,g){if(g.wasSuccessful()){var l;switch(a){case"sender":l=Genesis.controller.ControllerBase.genQRCode(metaData.data);console.debug("\nQRCode - "+l[0]+"\n");if(l[0]){d.getQrcode().setStyle({"background-image":"url("+l[0]+")","background-size":Genesis.fn.addUnit(l[1])+" "+Genesis.fn.addUnit(l[2])});d.getTitle().setData({points:points+" Pts"});b.setActiveItem(1);}Ext.Viewport.setMasked(false);break;case"emailsender":l=metaData.data["qrcode"];var k=metaData.data["body"];var j=metaData.data["subject"];console.debug("\nQRCode - "+l+"\nSubject - "+j+"\n");l=Genesis.controller.ControllerBase.genQRCode(l)[0].replace("data:image/gif;base64,","");window.plugins.emailComposer.showEmailComposerWithCB(function(m){Ext.defer(function(){Ext.Viewport.setMasked(false);switch(m){case EmailComposer.ComposeResultType.Failed:case EmailComposer.ComposeResultType.NotSent:case EmailComposer.ComposeResultType.Cancelled:Ext.device.Notification.show({title:"Email Error",message:d.referralFailedMsg,callback:function(){d.onCompleteReferralsChallenge();}});break;case EmailComposer.ComposeResultType.Saved:Ext.device.Notification.show({title:"Email Saved",message:d.referralSavedMsg,callback:function(){d.onCompleteReferralsChallenge();}});break;case EmailComposer.ComposeResultType.Sent:Ext.device.Notification.show({title:"Email Sent!",message:d.sendReferralSuccessMsg(),callback:function(){d.onCompleteReferralsChallenge();}});break;}},1,d);},j,k,null,null,null,true,[l]);break;}}else{Ext.Viewport.setMasked(false);}}});},vipEventHandler:function(b){var c=this;var a=c.getViewPortCntlr();var e=a.getVenue().getId();var d=a.getCustomer().getId();c.onCompleteChallenge(null,e,d,b);},onLocationUpdate:function(a){var b=this;switch(b.selectedItem.get("type").value){case"photo":b.photoEventHandler(a);break;case"vip":b.vipEventHandler(a);break;case"referral":break;case"menu":case"birthday":case"custom":default:b.metaData={position:a};b.scanQRCode();break;}},onScannedQRcode:function(e){var c=this;var b=(c.metaData)?c.selectedItem.get("type").value:"referral";if(e){switch(b){case"referral":c.onCompleteChallenge(e,null,null,null);break;default:var a=c.getViewPortCntlr();var f=a.getVenue().getId();var d=a.getCustomer().getId();c.onCompleteChallenge(e,f,d,c.metaData.position);break;}}else{console.debug(c.noCodeScannedMsg);Ext.device.Notification.show({title:"Error",message:c.noCodeScannedMsg});}c.metaData=null;},onFbPhotoUploadComplete:function(){var g=this;var e=Ext.StoreMgr.get("CustomerStore");var f=g.getViewPortCntlr();var c=f.getVenue();var d=c.getId();var a=g.metaData;var j=f.getCustomer().getId();var h=g.selectedItem.get("points");var b=g.selectedItem.getId();Challenge.setCompleteChallengeURL(b);Challenge.load(b,{jsonData:{},params:{venue_id:d,latitude:a.position.coords.getLatitude(),longitude:a.position.coords.getLongitude(),upload_token:a.upload_token},callback:function(l,k){var m=Challenge.getProxy().getReader().metaData;if(k.wasSuccessful()&&m){e.getById(j).set("points",m.account_points);console.debug("Points Earned = "+m.points+" Pts");Ext.device.Notification.show({title:"Upload Complete",message:((m.points>0)?g.photoUploadSuccessMsg(m.points):g.getConsolationMsg(m.message)),callback:function(){g.metaData=null;g.popView();}});f.updateRewardsTask.delay(1*1000,g.updateRewards,g,[m]);}else{Ext.device.Notification.show({title:"Upload Failed!",message:g.photoUploadIncompletesMsg,buttons:["Try Again","Cancel"],callback:function(n){if(n.toLowerCase()=="try again"){Ext.defer(g.completeUploadPhotosChallenge,1*1000,g);}else{g.metaData=null;g.fireEvent("openpage","MainPage","main");}}});}}});},onCompleteChallenge:function(e,g,d,a){var c=this;var h,b,f;if(!g){b="referral";h=c.reservedReferralId;f={};}else{h=c.selectedItem.getId();b=c.selectedItem.get("type").value;f={venue_id:g,latitude:a.coords.getLatitude(),longitude:a.coords.getLongitude(),};}console.log("Completing Challenge ID("+h+")");Challenge.setCompleteChallengeURL(h);Challenge.load(h,{jsonData:{},params:Ext.apply(f,{data:e}),callback:function(k,l){var j=Challenge.getProxy().getReader().metaData;var m=Ext.StoreMgr.get("CustomerStore");console.log("Challenge Completed("+l.wasSuccessful()+")");if(l.wasSuccessful()&&j){switch(b){case"referral":Ext.device.Notification.show({title:"Receive Referral",message:c.recvReferralSuccessMsg,callback:function(){Ext.defer(function(){var q=j.id;var o=m.getById(q);if(!o){o=m.add(j)[0];}c.setMode("profile");Genesis.db.addReferralDBAttrib("m"+o.getMerchant().getId());if(c.referralCbFn){c.referralCbFn();c.referralCbFn=null;}else{var p=c.getApplication();var n=p.getController("Accounts");p.dispatch({action:"onDisclose",args:[m,o],controller:n,scope:n});}},1,c);}});break;case"vip":Ext.device.Notification.show({title:"VIP Challenge",message:c.getConsolationMsg(j.message)});c.getViewPortCntlr().updateRewardsTask.delay(1*1000,c.updateRewards,c,[j]);break;default:console.log("Total Points - "+j.account_points);if(j.account_points){var m=Ext.StoreMgr.get("CustomerStore");m.getById(d).set("points",j.account_points);}console.log("Points Earned - "+j.points);Ext.device.Notification.show({title:"Earn Points",message:((j.points>0)?c.getPointsMsg(j.points):c.getConsolationMsg(j.message))});c.getViewPortCntlr().updateRewardsTask.delay(1*1000,c.updateRewards,c,[j]);break;}}}});},onItemSelect:function(e,a,b){var c=this.getChallengeDescContainer();Ext.Anim.run(c.element,"fade",{direction:"right",duration:600,out:false,autoClear:true,scope:this,before:function(){for(var d=0;d<c.getItems().length;d++){c.getItems().getAt(d).updateData(a.getData());}this.selectedItem=a;}});return true;},onChallengeBtnTap:function(k,d,f,l){var j=this;var g=j.getViewPortCntlr();var h=g.getCheckinInfo().venue;var a=g.getVenue();var c=j.selectedItem;if(!(h&&a&&(h.getId()==a.getId()))){Ext.device.Notification.show({title:"Error",message:j.checkinFirstMsg});return;}if(c){switch(c.get("type").value){case"photo":j.getChallengePage().takePhoto();break;case"referral":j.pushView(j.getReferralsPage());break;case"menu":case"birthday":case"vip":case"custom":if(c.get("require_verif")){Ext.device.Notification.show({title:j.selectedItem.get("name")+" Challenge",message:j.showToServerMsg,callback:function(){j.getGeoLocation();}});}else{j.getGeoLocation();}break;}}},onActivate:function(d,j,m,g){var k=this;var e=this.getViewPortCntlr().getVenue();var a=e.getId();var l=this.getChallengePage().query("carousel")[0];var h=e.challenges().getRange();if((l.getInnerItems().length>0)&&(l.getInnerItems()[0].getStore().getRange()[0].getId()==h[0].getId())){}else{l.removeAll(true);Ext.defer(function(){for(var c=0;c<Math.ceil(h.length/6);c++){l.add({xtype:"dataview",cls:"challengeMenuSelections",useComponents:true,defaultType:"challengemenuitem",scrollable:undefined,store:{model:"Genesis.model.Challenge",data:Ext.Array.pluck(h.slice(c*6,((c+1)*6)),"data")}});}if(l.getInnerItems().length>0){l.setActiveItem(0);}},1,k);}var f=k.getChallengeDescContainer();for(var b=0;b<f.getItems().length;b++){f.getItems().getAt(b).updateData({description:k.defaultChallengeMsg,name:""});}delete k.selectedItem;},onDeactivate:function(d,e,a,b){},onReferralsActivate:function(f,g,b,d){var e=this;var a=e.getReferralsContainer();a.setActiveItem(0);},onCompleteReferralsChallenge:function(a,d,c){this.popView();},onReferralsSelect:function(d,a,b){var c=this;d.deselect([a]);switch(a.get("tag")){case"emailsender":case"sender":c.referralEventHandler(a);break;}return false;},onCameraSuccessFn:function(b){var a=this;console.debug("image URI =["+b+"]");Ext.Viewport.setMasked(false);a.imageURI=b;a.getGeoLocation();},onCameraErrorFn:function(b){var a=this;console.debug("onCameraErrorFn - message["+b+"]");Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:a.photoTakenFailMsg(b)});},onPhotoBtnCommon:function(a){var b=this;var c=b.getChallengePage().photoAction;c.hide();console.log("Checking for Facebook Plugin ...");Genesis.constants.facebook_onLogin(function(d){console.log("Accessing Camera Plugin ...");if(Genesis.constants.isNative()){Ext.Viewport.setMasked({xtype:"loadmask",message:b.cameraAccessMsg});var e={quality:75,destinationType:Camera.DestinationType.FILE_URI,sourceType:a,allowEdit:true,encodingType:Camera.EncodingType.JPEG,targetWidth:960};navigator.camera.getPicture(Ext.bind(b.onCameraSuccessFn,b),Ext.bind(b.onCameraErrorFn,b),e);}else{b.onCameraSuccessFn(b.samplePhotoURL);}},true,b.photoUploadFbReqMsg);},onLibraryBtnTap:function(a,f,c,d){this.onPhotoBtnCommon(Genesis.constants.isNative()?Camera.PictureSourceType.PHOTOLIBRARY:null);},onAlbumBtnTap:function(a,f,c,d){this.onPhotoBtnCommon(Genesis.constants.isNative()?Camera.PictureSourceType.SAVEDPHOTOALBUM:null);},onCameraBtnTap:function(a,f,c,d){this.onPhotoBtnCommon(Genesis.constants.isNative()?Camera.PictureSourceType.CAMERA:null);},onUploadPhotosActivate:function(f,g,a,d){var e=this;var b=e.getUploadPhotosBackground();e.getPostBtn().show();b.setStyle({"background-image":"url("+e.metaData.photo_url+")"});},onUploadPhotosDeactivate:function(d,e,a,b){this.getPostBtn().hide();},onUploadPhotosTap:function(k,f,g,l){var j=this;var h=j.getUploadPhotosPage();var m=h.query("textareafield")[0];var c=m.getValue();if((c.length>m.getMaxLength())||(c.length<16)){Ext.device.Notification.show({title:"Error",message:j.photoUploadFailValidationMsg,callback:function(){m.focus();}});return;}var d=j.getViewPortCntlr();var a=d.getVenue();FB.api("/me/photos","post",{message:c,url:j.metaData.photo_url,access_token:FB.getAccessToken()},function(b){if(!b||b.error){var e=(b&&b.error)?b.error.message:j.fbUploadFailedMsg;Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Upload Failed!",message:e,buttons:["Try Again","Cancel"],callback:function(n){if(n.toLowerCase()=="try again"){Ext.defer(j.onUploadPhotosTap,100,j);}else{j.metaData=null;j.popView();}}});}else{console.debug("Facebook Post ID - "+b.id);j.fireEvent("fbphotouploadcomplete");}});},openPage:function(b,a){var c=this;if(a){c.referralCbFn=a;}switch(b){case"referrals":Ext.device.Notification.show({title:"Receive Referrals",message:c.confirmRecvReferralsMsg,buttons:["Proceed","Cancel"],callback:function(d){if(d.toLowerCase()=="proceed"){delete c.selectedItem;c.metaData=null;c.scanQRCode();}}});break;default:break;}},getMainPage:function(){return this.getChallengePage();},openMainPage:function(){this.pushView(this.getMainPage());console.log("Client ChallengePage Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.Merchants",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{merchantMain_path:"/merchantMain",merchant_path:"/merchant",merchantDetails_path:"/merchantDetails",googleMapStaticUrl:"http://maps.googleapis.com/maps/api/staticmap"},xtype:"merchantsCntlr",config:{refs:{main:{selector:"merchantaccountview",autoCreate:true,xtype:"merchantaccountview"},merchantMain:"merchantaccountview container[tag=merchantMain]",tbPanel:"merchantaccountview dataview[tag=tbPanel]",prizesWonPanel:"merchantaccountview component[tag=prizesWonPanel]",feedContainer:"merchantaccountview container[tag=feedContainer]",descContainer:"merchantaccountview container[tag=descContainer]",descPanel:"merchantaccountview container[tag=descPanel]",merchantDetails:{selector:"merchantdetailsview",autoCreate:true,xtype:"merchantdetailsview"},mapBtn:"viewportview button[tag=mapBtn]",shareBtn:"viewportview button[tag=shareBtn]",checkinBtn:"viewportview button[tag=checkin]",mainBtn:"merchantaccountview tabbar[cls=navigationBarBottom] button[tag=main]",prizesBtn:"merchantaccountview tabbar[cls=navigationBarBottom] button[tag=prizes]"},control:{main:{activate:"onMainActivate",deactivate:"onMainDeactivate"},mainBtn:{tap:"onGotoCheckedInAccountTap"},mapBtn:{tap:"onMapBtnTap"},"merchantaccountview button[ui=orange]":{tap:"onMerchantAccountRewardsTap"},"merchantaccountview list":{select:"onMainSelect",disclose:"onMainDisclose"},checkinBtn:{tap:"onCheckinTap"},"merchantaccountview tabbar[cls=navigationBarBottom] button[tag=browse]":{tap:"onBrowseTap"},merchantDetails:{activate:"onDetailsActivate",deactivate:"onDetailsDeactivate"},"merchantdetailsview map":{maprender:"onMapRender"},"merchantdetailsview component[tag=map]":{}}},checkinFirstMsg:"Please Check-in before redeeming rewards",init:function(){var a=this;a.markersArray=[];if(window.google&&window.google.maps&&window.google.maps.Map){google.maps.Map.prototype.clearOverlays=function(){if(a.markersArray){for(var b=0;b<a.markersArray.length;b++){a.markersArray[b].setMap(null);}}};}else{console.debug("Google Maps API cannot be instantiated");}a.callParent(arguments);console.log("Merchants Init");},onActivateCommon:function(c,a){var b=(window.google&&window.google.maps&&window.google.maps.Marker)?window.google.maps:null;if(a&&b){c.getMap().clearOverlays();this.marker=new b.Marker(Ext.apply(this.markerOptions,{map:a}));c.setMapCenter(this.latLng);}else{}},onDetailsActivate:function(a,j,h,d){var e=this.getMerchantDetails();var g=this.getViewPortCntlr().getVenue();var f=e.query("component[tag=map]")[0];var b=e.query("dataview")[0].getStore();if((b.getData().length==0)||(b.first().getId()!=g.getId())){console.debug("Refreshing Merchant Account Details ...");b.setData(g);}this.getShareBtn().show();this.onActivateCommon(f,null);},onDetailsDeactivate:function(b,h,g,d){var a=this.getViewPortCntlr();var e=this.getMerchantDetails();var f=a.getVenue();this.getShareBtn().hide();},onMapRender:function(c,b,a){this.onActivateCommon(c,b);},onLocationUpdate:function(a){var c=this;var d=c.getApplication();var b=d.getController("Checkins");b.setPosition(a);d.dispatch({action:"onCheckinTap",args:[],controller:b,scope:b});},onUpdateWinnersCount:function(b){var a=this.getPrizesWonPanel();if(!a){this.getMain();a=this.getPrizesWonPanel();}a.setData(b);},onMainActivate:function(o,r,l,d){var s=this;var q=s.getViewPortCntlr();var h=s.getMain();var a=q.getVenue();var j=q.getCustomer();var k=q.getCustomer().getId();var e=a.getId();var b=a.getMerchant().getId();var m=q.getCheckinInfo().venue;var t=(m!=null);var p=(t&&(m.getId()==e));s.getTbPanel().getStore().setData(a);if(p){s.getFeedContainer().show();console.debug("Checkin Mode");Ext.defer(s.checkReferralPrompt,0.1*1000,s,[b]);}else{s.getFeedContainer()[s.showFeed?"show":"hide"]();console.debug("Explore Mode");}s.getDescPanel().setData(a);s.getDescContainer().show();s.getMapBtn().show();s.getCheckinBtn()[(!t||!p)?"show":"hide"]();s.getMainBtn()[(t&&!p)?"show":"hide"]();var g=0,f=Ext.StoreMgr.get("MerchantPrizeStore").getRange();for(var n=0;n<f.length;n++){if(f[n].getMerchant().getId()==b){g++;}}s.getPrizesBtn().setBadgeText((g>0)?g:null);s.getMain().getScrollable().getScroller().scrollTo(0,0);},onMainDeactivate:function(a,e,d,b){this.getMapBtn().hide();this.getCheckinBtn().hide();},onMainDisclose:function(k,d,h,f,j,l){var n=this;var m=n.getViewPortCntlr();var g=m.getCheckinInfo().venue;var a=m.getVenue();if(!g||!a||(a.getId()!=g.getId())){Ext.device.Notification.show({title:"Rewards",message:n.checkinFirstMsg});return;}switch(d.get("reward_type")){case"vip":break;default:var b=n.getApplication();var c=b.getController("Prizes");var o=Ext.StoreMgr.get("RedemptionsStore");d=o.getById(d.get("reward_id"));b.dispatch({action:"onRedeemRewards",args:[Ext.create("Genesis.model.EarnPrize",{id:1,expiry_date:null,reward:d,merchant:m.getCheckinInfo().venue.getMerchant()})],controller:c,scope:c});break;}},onMainSelect:function(c,a,b){c.deselect([a]);this.onMainDisclose(c,a);return false;},onCheckinTap:function(a,g,c,f){var d=this;d.getGeoLocation();},onBrowseTap:function(a,g,d,f){var h=this.getApplication();var c=h.getController("Checkins");h.dispatch({action:"openPage",args:["explore"],controller:c,scope:c});},onGotoCheckedInAccountTap:function(m,h,j,o,r){var l=this;var k=l.getViewPortCntlr();var q=l.getViewport();var d=l.getApplication();var n=d.getController("Checkins");var p=Ext.StoreMgr.get("EligibleRewardsStore");var g=k.getCheckinInfo();var c=g.customer;var f=g.venue;var s=g.metaData;var a=k.getVenue();console.log("Going to Merchant Home Account Page ...");if(a.getId()!=f.getId()){n.setupCheckinInfo("checkin",f,c,s);}if(!r&&(a.getId()!=f.getId())){k.updateRewardsTask.delay(1*1000,l.updateRewards,l,[s]);}q.setFlipAnimation();q.reset();if(l.getMainPage()==q.getActiveItem()){q.doSetActiveItem(l.getMainPage(),null);}l.pushView(l.getMainPage());q.resetAnimation();},onMapBtnTap:function(a,k,h,j){var d=this.getViewPortCntlr().getVenue();this.latLng=d.get("latitude")+","+d.get("longitude");var f="red",g="";var c=d.get("address")+", "+d.get("city")+", "+d.get("state")+", "+d.get("country")+", "+d.get("zipcode");this.markerOptions={markers:"color:"+f+"|label:"+g+"|"+this.latLng,center:this.latLng,title:d.get("name")};this.pushView(this.getMerchantDetails());},getMainPage:function(){return this.getMain();},openMainPage:function(a){var c=this;var b=c.getViewport();var d=(c.getMainPage()==b.getActiveItem());c.showFeed=a;if(!d){c.pushView(c.getMainPage());}else{c.onGotoCheckedInAccountTap();}console.log("Merchant Account Opened");}});Ext.define("Genesis.controller.client.Rewards",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{clientRewards_path:"/clientRewards"},xtype:"clientRewardsCntlr",models:["PurchaseReward","CustomerReward"],config:{refs:{backButton:"viewportview button[text=Close]",rewards:{selector:"clientrewardsview",autoCreate:true,xtype:"clientrewardsview"},price:"clientrewardsview textfield"},control:{rewards:{activate:"onActivate",deactivate:"onDeactivate"}}},loadCallback:null,missingEarnPtsCodeMsg:"No Authorization Code was found.",checkinFirstMsg:"Please Check-In before earning rewards",authCodeReqMsg:"Proceed to scan an Authorization Code from your server to earn Reward Points!",prizeCheckMsg:"Find out if you won a PRIZE!",getPointsMsg:function(a){return"You've earned "+a+" Points from this purchase!";},getReferralMsg:function(a){return"You've earned an additional "+a+" Points!"+Genesis.constants.addCRLF()+this.prizeCheckMsg;},getVipMsg:function(a){return"You've earned an additional "+a+" Points!"+Genesis.constants.addCRLF()+this.prizeCheckMsg;},vipPopUp:function(a,b){b=b||Ext.emptyFn;Ext.device.Notification.show({title:"VIP Challenge Update",message:this.getVipMsg(a),callback:b});},referralPopUp:function(a,b){b=b||Ext.emptyFn;Ext.device.Notification.show({title:"Referral Challenge Update",message:this.getReferralMsg(a),callback:b});},init:function(){console.log("Client Rewards Init");},onScannedQRcode:function(b){var a=this;if(b){a.qrcode=b;a.getGeoLocation();}else{console.debug(a.missingEarnPtsCodeMsg);Ext.device.Notification.show({title:"Error",message:a.missingEarnPtsCodeMsg,callback:function(){}});}},onLocationUpdate:function(c){var e=this;var b=e.getViewPortCntlr();var g=b.getVenue();var f=g.getId();var a=CustomerReward.getProxy().getReader();var d=Ext.StoreMgr.get("MerchantPrizeStore");EarnPrize.setEarnPrizeURL();a.setRootProperty("");a.buildExtractors();d.loadPage(1,{jsonData:{},params:{venue_id:f,data:e.qrcode,latitude:c.coords.getLatitude(),longitude:c.coords.getLongitude()},callback:function(j,h){a.setRootProperty("data");a.buildExtractors();if(h.wasSuccessful()){e.loadCallback=arguments;}else{}}});delete e.qrcode;},startRouletteScreen:function(){var a=this.getRewards();var b=Ext.get(Ext.DomQuery.select("div.rouletteTable",a.element.dom)[0]);b.addCls("spinFwd");var c=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);c.addCls("spinBack");},onEarnPtsTap:function(c,h,d,g){var f=this;var a=f.isOpenAllowed();if(a!==true){Ext.device.Notification.show({title:"Error",message:a});return;}else{f.referredByFriendsMsg(null,function(){Ext.device.Notification.show({title:"Earning Reward Points",message:f.authCodeReqMsg,buttons:["OK","Cancel"],callback:function(b){if(b.toLowerCase()=="ok"){f.scanQRCode();}}});});}},metaDataHandler:function(b){var e=this;var a=e.getViewPortCntlr();var c=function(){Genesis.db.removeReferralDBAttrib("m"+a.getVenue().getMerchant().getId());e.pushView(e.getRewards());};var d=Ext.StoreMgr.get("CustomerStore");var f=a.getCustomer().getId();if(b.account_points){d.getById(f).set("points",b.account_points);}if(b.account_visits){d.getById(f).set("visits",b.account_visits);}if(Ext.isDefined(b.points)){e.getRewards();message=e.getPointsMsg(b.points);if(!b.vip_challenge&&!b.vip_challenge){message+=Genesis.constants.addCRLF()+e.prizeCheckMsg;}Ext.device.Notification.show({title:"Reward Points Update",message:message,callback:function(){if((b.vip_challenge)){e.vipPopUp(b.vip_challenge.points,c);}else{if((b.referral_points)){e.referralPopUp(b.referral_points.points,c);}else{c();}}}});}else{if(b.vip_challenge){e.getRewards();e.vipPopUp(b.vip_challenge.points,c);}else{if(b.referral_points){e.getRewards();e.referralPopUp(b.referral_points.points,c);}}}},onPrizeStoreMetaChange:function(d,c){var e=this;var a=e.getViewPortCntlr();e.metaDataHandler(c);if(c.data){var f=e.getApplication();var b=f.getController("Prizes");f.dispatch({action:"showPrizeQRCode",args:[0,c.data],controller:b,scope:b});}},onActivate:function(h,g,d,e){var f=this;var b=f.getRewards();var a=f.getViewPortCntlr();f.startRouletteScreen();Genesis.controller.ControllerBase.playSoundFile(a.sound_files.rouletteSpinSound,function(){console.debug("RouletteSound Done, checking for prizes ...");var j=f.getApplication();var c=j.getController("Prizes");j.dispatch({action:"onPrizeCheck",args:f.loadCallback,controller:c,scope:c});delete f.loadCallback;});},onDeactivate:function(e,d,a,b){this.getBackButton().enable();},onContainerActivate:function(e,d,a,b){},getMainPage:function(){return this.getRewards();},openPage:function(b){var d;var c=this;var a=c.getViewPortCntlr();switch(b){case"rewards":d=c.getRewards();c.onEarnPtsTap();break;}},isOpenAllowed:function(){var b=this.getViewPortCntlr();var a=b.getCheckinInfo().venue;var c=b.getVenue();return((a&&c&&(a.getId()==c.getId()))?true:this.checkinFirstMsg);}});Ext.define("Genesis.controller.client.Redemptions",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{clientRedemption_path:"/clientRedemptions"},xtype:"clientRedemptionsCntlr",models:["PurchaseReward","CustomerReward"],config:{refs:{backButton:"viewportview button[text=Close]",redemptions:{selector:"clientredemptionsview",autoCreate:true,xtype:"clientredemptionsview"},redemptionsList:"clientredemptionsview list[tag=redemptionsList]",redemptionsPts:"clientredemptionsview component[tag=points]",redemptionsPtsEarnPanel:"clientredemptionsview dataview[tag=ptsEarnPanel]"},control:{redemptions:{activate:"onActivate",deactivate:"onDeactivate"},redemptionsList:{select:"onItemListSelect",disclose:"onItemListDisclose"}}},checkinFirstMsg:"Please Check-In before redeeming rewards",needPointsMsg:function(a){return"You need "+a+" more points "+Genesis.constants.addCRLF()+"to be eligible for this item.";},init:function(){Ext.regStore("RedemptionsStore",{model:"Genesis.model.CustomerReward",autoLoad:false,grouper:{groupFn:function(a){return a.get("points")+" Points";}},sorters:[{property:"points",direction:"ASC"}],listeners:{scope:this,metachange:function(a,c,b){this.onRedeemMetaChange(a,c.getReader().metaData);}}});console.log("Client Redemptions Init");},onActivate:function(){},onDeactivate:function(){},onItemListSelect:function(c,a,b){c.deselect([a]);this.onItemListDisclose(c,a);return false;},onItemListDisclose:function(j,d,g,f,h,k){var m=this;var l=m.getViewPortCntlr();if(!m.exploreMode){var b=l.getCustomer().get("points");var n=d.get("points");if(n>b){Ext.device.Notification.show({title:"Oops!",message:m.needPointsMsg(n-b)});}else{var a=m.getApplication();var c=a.getController("Prizes");a.dispatch({action:"onRedeemRewards",args:[Ext.create("Genesis.model.EarnPrize",{id:1,expiry_date:null,reward:d,merchant:l.getCheckinInfo().venue.getMerchant()})],controller:c,scope:c});}}else{Ext.device.Notification.show({title:"Warning",message:m.checkinFirstMsg});}return true;},onRedeemCheckMetaData:function(b){var d=this;var a=d.getViewPortCntlr();var c=Ext.StoreMgr.get("CustomerStore");var e=a.getCustomer().getId();if(b.account_points){c.getById(e).set("points",b.account_points);}if(b.account_visits){c.getById(e).set("visits",b.account_visits);}},onRedeemMetaChange:function(d,c){var e=this;var a=e.getViewPortCntlr();e.onRedeemCheckMetaData(c);if(c.data){var f=e.getApplication();var b=f.getController("Prizes");f.dispatch({action:"showPrizeQRCode",args:[0,c.data],controller:b,scope:b});}},getMainPage:function(){return this.getRewards();},openPage:function(m){var g,l,j,e,k;var h=this;var f=h.getViewPortCntlr();var d=f.getCheckinInfo().venue;var c=f.getVenue();var b=c.getId();var n=c.getMerchant().getId();var a=function(p,o){k.getScroller().scrollTo(0,0);h.exploreMode=!d||(d&&(d.getId()!=c.getId()));switch(m){case"redemptions":h.getRedemptionsPtsEarnPanel().getStore().setData(f.getCustomer());break;}l.filter([{filterFn:function(q){return q.get("venue_id")==b;}}]);j.setData(l.getRange());h.pushView(g);};switch(m){case"redemptions":g=h.getRedemptions();e=h.getRedemptionsList();l=Ext.StoreMgr.get("RedemptionsStore");j=e.getStore();k=g.getScrollable();l.clearFilter();a();break;}},isOpenAllowed:function(){return((this.getViewPortCntlr().getVenue())?true:"You need to Explore or Check-in to a Venue first");}});Ext.define("Genesis.controller.Accounts",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{accounts_path:"/accounts"},xtype:"accountsCntlr",config:{mode:"profile",refs:{accounts:{selector:"accountsview",autoCreate:true,xtype:"accountsview"},accountsList:"accountsview list[tag=accountsList]",transferPage:{selector:"clientaccountstransferview",autoCreate:true,xtype:"clientaccountstransferview"},points:"clientaccountstransferview textfield",qrcode:"clientaccountstransferview component[tag=qrcode]",title:"clientaccountstransferview component[tag=title]",transferContainer:"clientaccountstransferview container[tag=accountsTransferMain]"},control:{accounts:{activate:"onActivate",deactivate:"onDeactivate"},accountsList:{select:"onSelect",disclose:"onDisclose"},"clientaccountstransferview button[tag=transfer]":{select:"onTransferTap"},transferPage:{activate:"onTransferActivate"},"clientaccountstransferview container[tag=accountsTransferMain] list":{select:"onTransferSelect"},"clientaccountstransferview container[tag=dialpad] button":{tap:"onCalcBtnTap"},"clientaccountstransferview button[tag=showQrCode]":{tap:"onShowQrCodeTap"},"clientaccountstransferview container button[tag=done]":{tap:"onTransferCompleteTap"}}},qrcodeRegExp:/%qrcode_image%/,noTransferCodeMsg:"No Transfer Authorization Code was scanned",pointsReqMsg:"Points are required for transfer",startTransferMsg:"Prepare to scan the Sender's Authorization Code",transferFailedMsg:"Transfer operation did not complete",transferSavedMsg:"Transfer messasge was saved.",transferSuccessMsg:"Transfer operation was successfully completed",xferWithinRangeMsg:function(b,a){return"Please enter a value between "+b+" and "+a;},noPtsXferMsg:function(){return"No Points were transferred."+Genesis.constants.addCRLF()+"Try again.";},recvTransferMsg:function(a,b){return"You have received "+a+" points at "+Genesis.constants.addCRLF()+b;},init:function(){this.callParent(arguments);console.log("Accounts Init");},onScannedQRcode:function(d){var c=this;var b=c.getViewport();var a=Ext.StoreMgr.get("CustomerStore");if(d){Ext.Viewport.setMasked({xtype:"loadmask",message:c.updatingServerMsg});Customer.setRecvPtsXferUrl();a.load({addRecords:true,jsonData:{},params:{data:d},callback:function(g,f){Ext.Viewport.setMasked(false);if(f.wasSuccessful()){var e=Customer.getProxy().getReader().metaData;Ext.device.Notification.show({title:"Transfer Received",message:c.recvTransferMsg(e.points,g[0].getMerchant().get("name")),callback:function(h){b.silentPop(1);Ext.defer(function(){c.onDisclose(a,g[0]);},1,c);}});}}});}else{console.debug(c.noCodeScannedMsg);Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:c.noCodeScannedMsg});}},onLocationUpdate:function(a){var d=this;var g=d.merchantId;var f=d.rec;var b=f.getMerchant().getId();var e=f.getId();var c=f.getMerchant().get("name");Venue.setGetClosestVenueURL();Venue.load(g,{scope:d,params:{merchant_id:g,latitude:a.coords.getLatitude(),longitude:a.coords.getLongitude()},callback:function(l,m){if(m.wasSuccessful()){var k=Venue.getProxy().getReader().metaData;if(k){var o=d.getApplication();var j=o.getController("Checkins");var n=Ext.StoreMgr.get("CustomerStore");var h=d.getViewPortCntlr();k.venue_id=l.getId();h.setVenue(l);o.dispatch({action:"onCheckinHandler",args:["explore",k,n,null,[f],m],controller:j,scope:j});}else{console.log("No MetaData found on Venue!");}}else{Ext.device.Notification.show({title:"Error",message:d.missingVenueInfoMsg});}},});},onActivate:function(d,e,a,b){this.getAccountsList().getScrollable().getScroller().scrollTo(0,0);},onDeactivate:function(){},onSelect:function(c,a,b){c.deselect([a]);this.onDisclose(c,a);return false;},onDisclose:function(f,a,c,b,d,g){var h=this;var k=a.getId();var j=a.getMerchant().get("name");var l=h.getViewport();h.merchantId=a.getMerchant().getId();h.rec=a;switch(h.getMode()){case"profile":h.getGeoLocation();break;case"emailtransfer":case"transfer":if(a.get("points")<1){Ext.device.Notification.show({title:"Points Required",message:h.pointsReqMsg,});return;}l.silentPop(2);h.pushView(h.getTransferPage());break;}},onTransferActivate:function(f,g,b,d){var e=this;var a=e.getTransferContainer();switch(e.getMode()){case"profile":a.setActiveItem(0);break;case"emailtransfer":case"transfer":if(b&&(b==e.getAccounts()&&!e.rec)){e.setMode("profile");a.setActiveItem(0);}else{e.getPoints().setValue(null);a.setActiveItem(1);}break;}},onTransferTap:function(a,d,c){},onTransferSelect:function(d,a,b){var c=this;d.deselect([a]);delete c.merchantId;delete c.rec;switch(a.get("tag")){case"sender":c.setMode("transfer");c.openMainPage();break;case"emailsender":c.setMode("emailtransfer");c.openMainPage();break;case"recipient":c.setMode("profile");Ext.device.Notification.show({title:"Start Transfer",message:c.startTransferMsg,buttons:["Proceed","Cancel"],callback:function(e){if(e.toLowerCase()=="proceed"){c.scanQRCode();}}});break;}return false;},onCalcBtnTap:function(h,a,c,j){var f=this;var d=f.getViewPortCntlr();Genesis.controller.ControllerBase.playSoundFile(d.sound_files.clickSound);var k=h.getText();var g=f.getPoints();var l=g.getValue()||"0";if(l.length<8){switch(k){case"AC":l=null;break;default:l=(l!="0")?l.concat(k):k;break;}g.setValue(l);}},onAuthCodeRecv:function(b){var e=this;switch(e.getMode()){case"transfer":var a=e.getTransferContainer();var g=Genesis.controller.ControllerBase.genQRCode(b.data);var d=b.points||e.getPoints().getValue();console.debug("\nQRCode - "+g[0]+"\nPoints - "+d);if(g[0]){e.getQrcode().setStyle({"background-image":"url("+g[0]+")","background-size":Genesis.fn.addUnit(g[1])+" "+Genesis.fn.addUnit(g[2])});e.getTitle().setData({points:d+" Pts"});a.setActiveItem(2);}Ext.Viewport.setMasked(false);break;case"emailtransfer":var g=b.data["qrcode"];var f=b.data["body"];var c=b.data["subject"];console.debug("\nQRCode - "+g+"\nSubject - "+c+"\n");g=Genesis.controller.ControllerBase.genQRCode(g)[0].replace("data:image/gif;base64,","");window.plugins.emailComposer.showEmailComposerWithCB(function(h){Ext.defer(function(){Ext.Viewport.setMasked(false);switch(h){case EmailComposer.ComposeResultType.Failed:case EmailComposer.ComposeResultType.NotSent:case EmailComposer.ComposeResultType.Cancelled:Ext.device.Notification.show({title:"Transfer Failed",message:e.transferFailedMsg,callback:function(){}});break;case EmailComposer.ComposeResultType.Saved:e.onTransferCompleteTap();Ext.device.Notification.show({title:"Trasfer Deferred",message:e.transferSavedMsg});break;case EmailComposer.ComposeResultType.Sent:e.onTransferCompleteTap();Ext.device.Notification.show({title:"Transfer Success!",message:e.transferSuccessMsg});break;}},1,e);},c,f,null,null,null,true,[g]);break;}},onShowQrCodeTap:function(a,k,d,j){var h=this;var c=Ext.StoreMgr.get("CustomerStore");var g=h.getPoints().getValue();var f;if((Number(g)>0)&&(Number(g)<=h.rec.get("points"))){switch(h.getMode()){case"transfer":f="direct";Ext.Viewport.setMasked({xtype:"loadmask",message:h.genQRCodeMsg});break;case"emailtransfer":f="email";Ext.Viewport.setMasked({xtype:"loadmask",message:h.retrieveAuthModeMsg});break;}Customer.setSendPtsXferUrl();c.load({addRecords:true,jsonData:{},params:{merchant_id:h.merchantId,points:g,type:f},callback:function(l,e){var b=c.getProxy().getReader().metaData;if(e.wasSuccessful()&&(!b.data)){Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Error",message:h.noPtsXferMsg()});}}});}else{Ext.device.Notification.show({title:"Error",message:h.xferWithinRangeMsg(1,h.rec.get("points"))});}},onTransferCompleteTap:function(a,f,c,d){this.popView();},openPage:function(a){var b;this.setMode("profile");switch(a){case"profile":b=this.getMainPage();break;case"emailtransfer":case"transfer":b=this.getTransferPage();break;}this.pushView(b);},getMainPage:function(){return this.getAccounts();},openMainPage:function(){this.pushView(this.getMainPage());console.log("Accounts Page Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.Prizes",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store","Ext.util.Sorter"],statics:{prizes_path:"/prizes"},xtype:"prizesCntlr",config:{timeoutPeriod:10,mode:"prizes",models:["Venue","Merchant","EarnPrize","CustomerReward"],listeners:{scannedqrcode:"onScannedQRcode",locationupdate:"onLocationUpdate",redeemprize:"onRedeemPrize",openpage:"onOpenPage"},refs:{closeBackButton:"viewportview button[text=Close]",backButton:"viewportview button[ui=back]",doneBtn:"viewportview button[tag=done]",redeemBtn:"viewportview button[tag=redeem]",prizeCheckScreen:"clientrewardsview",prizes:{selector:"prizesview",autoCreate:true,xtype:"prizesview"},prizesCarousel:"prizesview carousel"},control:{doneBtn:{tap:"onDoneTap"},redeemBtn:{tap:"onRedeemPrizeTap"},prizes:{activate:"onActivate",deactivate:"onDeactivate"},prizesCarousel:{activeitemchange:"onPrizeCarouselItemChange"}}},evtFlag:0,loadCallback:null,initSound:false,authRewardVerifiedMsg:"Verified",updatePrizeOnFbMsg:"Tell your friends on Facebook about the prize you just won!",retrievingQRCodeMsg:"Retrieving QRCode ...",wonPrizeMsg:function(a){return"You haved won "+((a>1)?"some PRIZES":"a PRIZE")+"!";},lostPrizeMsg:"Oops, Play Again!",showQrCodeMsg:"Show this Authorization Code to your server to redeem!",checkinFirstMsg:"Please Check-in before claiming any prize(s)",redeemPrizeConfirmMsg:"Please confim to redeem this item",init:function(){this.callParent(arguments);console.log("Prizes Init");},stopRouletteTable:function(){var a=this.getPrizeCheckScreen();var b=Ext.get(Ext.DomQuery.select("div.rouletteTable",a.element.dom)[0]);b.removeCls("spinFwd");b.removeCls("spinBack");},stopRouletteBall:function(){var a=this.getPrizeCheckScreen();var b=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);b.removeCls("spinBack");b.addCls("spinFwd");},stopRouletteScreen:function(){this.stopRouletteTable();var a=this.getPrizeCheckScreen();var b=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);b.removeCls("spinBack");b.removeCls("spinFwd");},updatingPrizeOnFacebook:function(d){var j=this;try{var h=j.getViewPortCntlr();var c=h.getVenue();var a=Genesis.constants.site;var l=c.get("website")?c.get("website").split(/http[s]*:\/\//):[null];var b=c.get("name");var k=l[l.length-1]||a;var f=c.get("description").trunc(256);var m="I just won "+d.getCustomerReward().get("title")+" for purchasing at "+c.get("name")+"!";console.log("Posting to Facebook ...\nName: "+b+"\nCaption: "+k+"\nDescription: "+f+"\nMessage : "+m+"\n");FB.api("/me/feed","post",{name:b,link:c.get("website")||a,caption:k,description:f,picture:c.getMerchant().get("photo")["thumbnail_ios_medium"].url,message:m},function(e){Ext.Viewport.setMasked(false);if(!e||e.error){console.log("Post was not published to Facebook.");}else{console.log("Posted to your Facebook Newsfeed.");}});}catch(g){Ext.Viewport.setMasked(false);console.log("Exception ["+g+"]\nPost was not published to Facebook.");}},onPrizeCheck:function(e,d){var g=this;var a=g.getViewPortCntlr();g.stopRouletteBall();console.debug("onPrizeCheck Completed!");if(e.length==0){console.log("Prize LOST!");Ext.device.Notification.show({title:"Scan And Win!",message:g.lostPrizeMsg,callback:function(){Ext.defer(g.popView,3*1000,g);}});}else{var b=0;var c=Ext.StoreMgr.get("CustomerStore");var h=g.getApplication();var f=g.getViewport();console.log("Prize WON!");Genesis.controller.ControllerBase.playSoundFile(a.sound_files.winPrizeSound,function(){if(b&16){f.silentPop(1);}if((b|=1)==17){Ext.defer(g.onShowPrize,3*1000,g,[e[0]]);}});Ext.device.Notification.vibrate();Ext.device.Notification.show({title:"Scan And Win!",message:g.wonPrizeMsg(e.length),callback:function(){if(b&1){f.silentPop(1);}if((b|=16)==17){Ext.defer(g.onShowPrize,3*1000,g,[e[0]]);}}});}},onActivate:function(g,l,p,h){var m=this;var n=m.getPrizes();var j=m.getViewPortCntlr();var k=[],a;var d=function(c){k.push({tag:"rewardPanel",xtype:"dataview",store:{model:"Genesis.model.EarnPrize",autoLoad:false,data:c},useComponents:true,scrollable:false,defaultType:"rewarditem",defaultUnit:"em",margin:"0 0 0.8 0"});};n.removeAll();switch(m.getMode()){case"prizes":var f=Ext.StoreMgr.get("MerchantPrizeStore").getRange();if(f.length>0){var o=(j.getVenue())?j.getVenue().getMerchant().getId():0;for(var e=0;e<f.length;e++){if(p){var b=p.getXTypes();if(b.match("merchantaccountview")||b.match("clientrewardsview")){if(f[e].getMerchant().getId()!=o){continue;}}}if(!a){n.add({xtype:"carousel",scrollable:undefined});a=n.getItems().items[0];}d(f[e]);}}if(!a){a=n;}break;case"reward":case"authReward":case"showPrize":d(m.showPrize);delete m.showPrize;a=n;break;}if(k.length==0){a.add({tag:"rewardPanel",cls:"noprizes",xtype:"component",scrollable:false,defaultUnit:"em",margin:"0 0 0.8 0"});m.getRedeemBtn().hide();}else{a.add(k);switch(m.getMode()){case"authReward":break;default:m.getRedeemBtn().show();break;}}},onDeactivate:function(a,f,e,b){var d=this;d.getDoneBtn().hide();d.getRedeemBtn().hide();},onDoneTap:function(h,d,f,j){var c=this.getPrizes();if(c.isPainted()&&!c.isHidden()){var g=this;var k=Ext.StoreMgr.get("MerchantPrizeStore");clearTimeout(g.cancelId);clearTimeout(g.hideId);delete g.cancelId;delete g.hidelId;switch(g.getMode()){case"prizes":case"showPrize":var m=c.query("carousel")[0];var a=m||c;var l=m?a.getActiveItem():a.getItems().items[0];a.remove(l,true);k.remove(l.getStore().getData().items[0]);break;case"reward":break;}g.getDoneBtn().hide();g.getRedeemBtn().hide();g.popView();}},onPrizeCarouselItemChange:function(j,f,b,d){var e=(f.getStore())?f.getStore().getData().get(0):null;var g=(e)?e.getMerchant().getId():0;var a=this.getViewPortCntlr().getCheckinInfo().venue;var h=(a)?a.getMerchant().getId():0;},onRedeemPrize:function(b,e){var d=this;var c=b.getId();var g=b.getMerchant().getId();var a=d.getCloseBackButton()||d.getBackButton();a.hide();var f;var j=e.query("carousel")[0];var h=j?j.getActiveItem():e.getItems().items[0];switch(d.getMode()){case"showPrize":case"prizes":f=Ext.StoreMgr.get("MerchantPrizeStore");EarnPrize.setRedeemPrizeURL(h.getStore().first().getId());break;case"reward":f=Ext.StoreMgr.get("RedemptionsStore");CustomerReward.setRedeemPointsURL(h.getStore().first().getCustomerReward().getId());break;}Ext.Viewport.setMasked({xtype:"loadmask",message:d.retrievingQRCodeMsg});f.load({addRecords:true,scope:d,jsonData:{},params:{venue_id:c},callback:function(l,k){if(!k.wasSuccessful()){Ext.Viewport.setMasked(false);a.show();}}});},onRedeemPrizeTap:function(k,d,f,l){var h=this;var j=h.getPrizes();var g=h.getViewPortCntlr();var a=g.getVenue();var c=g.getCheckinInfo().venue;if(!c||!a||(a.getId()!=c.getId())){Ext.device.Notification.show({title:j.getInitialConfig().title,message:h.checkinFirstMsg});return;}Ext.device.Notification.show({title:j.getInitialConfig().title,message:h.redeemPrizeConfirmMsg,buttons:["Confirm","Cancel"],callback:function(b){if(b.toLowerCase()=="confirm"){h.fireEvent("redeemprize",a,j);}}});},onRefreshQRCode:function(b){var e=this;var a=e.getPrizes();var f=a.query("carousel")[0];var d=f?f.getActiveItem():a.getItems().items[0];var c=d.query("component[tag=itemPhoto]")[0];c.element.setStyle({"background-image":"url("+b[0]+")","background-size":Genesis.fn.addUnit(b[1])+" "+Genesis.fn.addUnit(b[2])});},showPrizeQRCode:function(c,b){var a=this;console.log("\nEncrypted Code :\n"+b+"\nEncrypted Code Length: "+b.length);b=Genesis.controller.ControllerBase.genQRCode(b);if(b[0]){a.getRedeemBtn().hide();a.getDoneBtn().show();a.onRefreshQRCode(b);Ext.Viewport.setMasked(false);Ext.device.Notification.show({title:"Redemption Alert",message:a.showQrCodeMsg});Ext.device.Notification.vibrate();}},onRedeemRewards:function(a){this.showPrize=a;this.setMode("reward");this.pushView(this.getMainPage());},onShowPrize:function(b){var a=this;a.stopRouletteScreen();a.showPrize=b;a.setMode("showPrize");a.pushView(a.getMainPage());Genesis.constants.facebook_onLogin(function(c){a.updatingPrizeOnFacebook(b);},false,a.updatePrizeOnFbMsg);},onAuthReward:function(a){this.showPrize=a;this.setMode("authReward");this.pushView(this.getMainPage());},getMainPage:function(){return this.getPrizes();},openMainPage:function(){this.setMode("prizes");this.pushView(this.getMainPage());console.log("Prizes Page Opened");},isOpenAllowed:function(){return true;}});