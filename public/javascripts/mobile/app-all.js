Ext.define("Genesis.profile.Iphone",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.is.iPhone;}});Ext.define("Genesis.profile.Android",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.is.Android;}});Ext.define("Genesis.profile.Desktop",{extend:"Ext.app.Profile",config:{},isActive:function(){return Ext.os.deviceType=="Desktop";}});Ext.define("Genesis.fx.animation.Scroll",{extend:"Ext.fx.animation.Abstract",alternateClassName:"Ext.fx.animation.ScrollIn",alias:["animation.scroll","animation.scrollIn"],config:{direction:"left",out:false,offset:0,easing:"auto",containerBox:"auto",elementBox:"auto",isElementBoxFit:true},reverseDirectionMap:{up:"down",down:"up",left:"right",right:"left"},applyEasing:function(a){if(a==="auto"){return"ease-"+((this.getOut())?"in":"out");}return a;},getData:function(){var e=this.getElement();var m=this.getFrom(),n=this.getTo(),d=this.getOut(),c=this.getOffset(),l=this.getDirection(),f=this.getReverse(),b=0,a=0,k,h,j,g;if(f){l=this.reverseDirectionMap[l];}switch(l){case this.DIRECTION_UP:case this.DIRECTION_DOWN:a=e.getHeight();break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:b=e.getWidth();break;}k=(d)?0:b;h=(d)?0:a;m.set("overflow","hidden");switch(l){case this.DIRECTION_UP:case this.DIRECTION_DOWN:m.set("height",h+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:m.set("width",k+"px");break;}j=(d)?b:0;g=(d)?a:0;n.set("overflow","hidden");switch(l){case this.DIRECTION_UP:case this.DIRECTION_DOWN:n.set("height",g+"px");break;case this.DIRECTION_RIGHT:case this.DIRECTION_LEFT:n.set("width",j+"px");break;}return this.callParent(arguments);}});Ext.define("Genesis.view.widgets.ListField",{extend:"Ext.field.Text",alternateClassName:"Genesis.field.List",xtype:"listfield",config:{ui:"list",component:{useMask:false},clearIcon:true,iconCls:"",readOnly:false},initialize:function(){var b=this,a=b.getComponent();b.callParent();if(b.getIconCls()){Ext.fly(b.element.query("."+Ext.baseCSSPrefix.trim()+"component-outer")[0]).addCls(b.getIconCls());}a.setReadOnly(true);},doClearIconTap:Ext.emptyFn});Ext.define("Genesis.navigation.Bar",{extend:"Ext.navigation.Bar",requires:["Ext.fx.layout.card.Style"],config:{defaultBackButtonText:"Back",altBackButtonText:"Close",mode:"slide",callbackFn:Ext.emptyFn,listeners:{activeitemchange:"onActiveItemChange"}},onViewAdd:function(b,g,c){var f=this;var h=b.getLayout().getAnimation();var a=f.titleComponent;f.endAnimation();f.backButtonStack.push(g.config.title||f.getDefaultBackButtonText());f.refreshNavigationBarProxy();var d=f.getNavigationBarProxyProperties();if(d.title.left){}if(d.title.width){a.setWidth(d.title.width);}var e=f.getBackButton();if(b.stack.length>0){e.setText(f.getBackButtonText());e.show();}else{e.hide();}f.setMode(b.getFadeMode()?"fade":"slide");f.titleComponent.setTitle(f.getTitleText());if(h&&h.isAnimation&&b.isPainted()&&f.elementGhost){if(b.getInnerItems().length>1){f.pushTbAnimated(g,f.getBackButtonText());}else{if(f.elementGhost){f.elementGhost.destroy();delete f.elementGhost;}}}else{if(b.getInnerItems().length>1){f.pushTb(g,f.getBackButtonText());}else{}}f.getCallbackFn()();},onViewRemove:function(b,f,c){var e=this;var g=b.getLayout().getAnimation();var a=e.titleComponent;e.endAnimation();e.backButtonStack.pop();e.refreshNavigationBarProxy();var d=e.getNavigationBarProxyProperties();if(d.title.left){}if(d.title.width){a.setWidth(d.title.width);}e.setMode(b.getFadeMode()?"fade":"slide");if(g&&g.isAnimation&&b.isPainted()&&e.elementGhost){e.popTbAnimated(f,e.getBackButtonText());}else{e.popTb(f,e.getBackButtonText());}e.titleComponent.setTitle(e.getTitleText());e.getCallbackFn()();},getTbAnimationProperties:function(a){var d=this,b=d.renderElement,e,c=d.getLayout();if(d.slideAnimation){d.slideAnimation.destroy();}if(d.fadeAnimation){d.fadeAnimation.destroy();}switch(d.getMode()){case"slide":d.slideAnimation=e=new Ext.fx.layout.card.Slide({direction:"left",listeners:{animationend:function(){if(d.elementGhost){d.elementGhost.destroy();delete d.elementGhost;d.getCallbackFn()();}}}});console.debug("Toolbar set to Slide Transition");break;case"fade":d.fadeAnimation=e=new Ext.fx.layout.card.Fade({listeners:{animationend:function(){if(d.elementGhost){d.elementGhost.destroy();delete d.elementGhost;d.getCallbackFn()();}}}});console.debug("Toolbar set to Fade Transition");break;default:console.debug("Unkown Special Effect - ["+d.getMode()+"]");e=d.getLayout().getAnimation();break;}e.setReverse(false);e.setLayout(c);c.setAnimation(e);return e;},getTbAnimationReverseProperties:function(a){var b=this.getTbAnimationProperties(a);b.setReverse(true);return b;},pushTb:function(a,f){var e=this;var b=e.getNavigationBarProxyProperties();var d=e.getBackButton();var c=b.backButton;if(c.left){d.setLeft(c.left);}if(c.width){d.setWidth(c.width);}e[(!a.getHideNavBar())?"show":"hide"]();},pushTbAnimated:function(g,h){var f=this;var c=0;var j=f.getBackButton(),a=j.getText();var d=f.getTbAnimationProperties(g);var e=f.getNavigationBarProxyProperties();var b=e.backButton;if(b.left){j.setLeft(b.left);}if(b.width){j.setWidth(b.width);}f.fireEvent("activeitemchange",g,f,{renderElement:f.elementGhost,isPainted:f.isPainted});},popTb:function(a,f){var e=this,d=e.getBackButton();var b=this.getNavigationBarProxyProperties();if(f&&e.backButtonStack.length){d.setText(this.getBackButtonText());d.show();}else{d.hide();}var c=b.backButton;if(c.left){d.setLeft(c.left);}if(c.width){d.setWidth(c.width);}e[(!a.getHideNavBar())?"show":"hide"]();},popTbAnimated:function(h,j){var g=this;var d=g.element,c=g.renderElement,k=g.getBackButton();var a=k.getText();var f=g.getTbAnimationReverseProperties(h);var e=this.getNavigationBarProxyProperties();if(j&&g.backButtonStack.length){k.setText(this.getBackButtonText());k.show();}else{k.hide();}var b=e.backButton;if(b.width){k.setWidth(b.width);}g.fireEvent("activeitemchange",h,g,{renderElement:g.elementGhost,isPainted:g.isPainted});},createNavigationBarProxy:function(){var a=this.proxy;if(a){return;}this.proxy=a=Ext.create("Ext.TitleBar",{title:this.backButtonStack[0]});a.add(Ext.applyIf({hidden:false,text:""},this.config.backButton));a.add(this.config.rightButton);a.backButton=a.down("button[ui=back]");Ext.getBody().appendChild(a.renderElement);a.renderElement.setStyle("position","absolute");a.element.setStyle("visibility","hidden");a.renderElement.setX(0);a.renderElement.setY(-1000);},refreshNavigationBarProxy:function(){var c=this.proxy,b=this.renderElement,a=this.backButtonStack,e=a[a.length-1],d=this.getBackButtonText();if(!c){this.createNavigationBarProxy();c=this.proxy;}c.renderElement.setWidth(b.getWidth());c.renderElement.setHeight(b.getHeight());c.setTitle(e);if(d){c.backButton.setText(d);c.backButton.show();}else{}c.refreshTitlePosition();},getNavigationBarProxyProperties:function(){return({title:{left:this.proxy.titleComponent.renderElement.getLeft(),width:this.proxy.titleComponent.renderElement.getWidth()},leftBox:{left:this.proxy.leftBox.renderElement.getLeft(),width:this.proxy.leftBox.renderElement.getWidth()},rightBox:{left:this.proxy.rightBox.renderElement.getLeft(),width:this.proxy.rightBox.renderElement.getWidth()},backButton:{left:this.proxy.backButton.renderElement.getLeft(),width:this.proxy.backButton.renderElement.getWidth()}});},createProxy:function(c,d,b,a){var f=this;var e=(a)?d.element.getParent():d.element,g=Ext.get(e.id+"-proxy");if(!g){g=e.dom.cloneNode(true);g.id=e.id+"-proxy";g.children[0].id=e.dom.children[0].id+"-proxy";e.getParent().dom.appendChild(g);g=Ext.get(g);g.setStyle("position","absolute");g.setY(e.getY());g.setX(e.getX());g.setWidth(e.getWidth());g.dom.style.setProperty("z-index",1,"important");}f[!Ext.isEmpty(b.getHideNavBar)?(b.getHideNavBar()?"hide":"show"):"show"]();return g;},reset:function(){this.backButtonStack=[];this.lastAnimationProperties={};},onActiveItemChange:function(j,f,l,m,d){var h=this,b,e=h.getLayout();var a=e.getAnimation().getInAnimation(),k=e.getAnimation().getOutAnimation(),g,c;if(f&&l&&l.isPainted()){g=f.renderElement;c=l.renderElement;a.setOut(!Ext.isEmpty(j.getHideNavBar)&&j.getHideNavBar());a.setElement(g);k.setElement(c);k.setOnBeforeEnd(function(n,o){if(o||Ext.Animator.hasRunningAnimations(n)){d.firingArguments[1]=null;d.firingArguments[2]=null;}});k.setOnEnd(function(){d.resume();});g.dom.style.setProperty("visibility","hidden","!important");if(Ext.isEmpty(j.getHideNavBar)||!j.getHideNavBar()){f.show();}h.activeAnimations=[k,a];Ext.Animator.run(h.activeAnimations);d.pause();}return b;}});Ext.define("Genesis.view.widgets.MerchantDetailsItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.XTemplate"],xtype:"merchantdetailsitem",alias:"widget.merchantdetailsitem",config:{layout:{type:"hbox",align:"stretch"},image:{docked:"left",cls:"photo",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>',{getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_medium"].url;}})},address:{flex:1,tpl:Ext.create("Ext.XTemplate",'<div class="merchantDetailsWrapper"><div class="itemTitle">{name}</div><div class="itemDesc">{[this.getAddress(values)]}</div></div>',{getAddress:function(a){return(a.address+",<br/>"+a.city+", "+a.state+", "+a.country+",</br>"+a.zipcode);}}),cls:"points"},dataMap:{getImage:{setData:"image"},getAddress:{setData:"address"}}},applyImage:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getImage());},updateImage:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyAddress:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getAddress());},updateAddress:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"image":case"address":k[a](b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);}});Ext.define("Genesis.view.widgets.ChallengeMenuItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.XTemplate"],xtype:"challengemenuitem",alias:"widget.challengemenuitem",config:{layout:{type:"hbox",pack:"center",align:"stretch"},image:{cls:"photo",tpl:Ext.create("Ext.XTemplate",'<div class="mainPageItemWrapper">','<div class="photo"><img src="{[this.getPhoto(values)]}" /></div>','<div class="photoName">{name}</div>',"</div>",{getPhoto:function(a){return Ext.isEmpty(a.photo)?Genesis.view.widgets.ChallengeMenuItem.getPhoto(a.type):a.photo.url;}})},dataMap:{getImage:{setData:"photo_url"}}},applyImage:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getImage());},updateImage:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"photo_url":k[a](b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);},statics:{getPhoto:function(a){var b;switch(a.value){case"birthday":b="resources/img/sprites/birthday.jpg";break;case"menu":b="resources/img/sprites/menu.jpg";break;case"photo":b="resources/img/sprites/photo.jpg";break;case"referral":b="resources/img/sprites/referral.jpg";break;case"vip":b="resources/img/sprites/checkin.jpg";break;case"custom":b="resources/img/sprites/star.jpg";break;}return b;}}});Ext.define("Genesis.view.widgets.RewardItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.Button","Ext.XTemplate"],xtype:"rewarditem",alias:"widget.rewarditem",config:{background:{cls:"rewardItem",tag:"rewardItem",layout:{type:"vbox"},items:[{docked:"top",xtype:"component",tag:"title",cls:"title",padding:"0.7 0.8",defaultUnit:"em",tpl:Ext.create("Ext.XTemplate","{[this.getDescription(values)]}",{getDescription:function(a){return a.title;}})},{xtype:"component",width:57*3,tag:"itemPhoto",cls:"reward",tpl:Ext.create("Ext.XTemplate",'<img src="{[this.getPhoto(values)]}" />',{getPhoto:function(a){return Genesis.view.Redemptions.getPhoto(a.type);}})},{docked:"bottom",xtype:"component",tag:"info",cls:"info",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="infoWrapper"><div class="name">{[this.getName(values)]}</div><div class="disclaimer">{[this.getDisclaimer(values)]}</div><div class="date">{[this.getExpiryDate(values)]}</div></div>',{getExpiryDate:function(a){var b=a.expiry_date;return((!b)?"":"Offer Expires "+b);},getDisclaimer:function(a){return a.Merchant.prize_terms||"Not valid with any other offer. No cash value. One coupon per customer per visit. Void where prohibited. Good at participating stores only.";},getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_small"].url;},getName:function(a){return a.Merchant.name;}})}]},dataMap:{getBackground:{setData:"background"}},listeners:{painted:function(d,b){var a=Ext.ComponentQuery.query("viewportview")[0].getActiveItem().renderElement.getHeight();d.config.dataview.setHeight(a);d.query("container[tag=rewardItem]")[0].setHeight(a);d.setHeight(a);}}},applyBackground:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBackground());},updateBackground:function(a,b){if(a){this.add(a);}if(b){this.remove(b);}},setDataBackground:function(a){this.query("component[tag=title]")[0].setData(a.CustomerReward);this.query("component[tag=itemPhoto]")[0].setData(a.CustomerReward);this.query("component[tag=info]")[0].setData(a);},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"background":h.setDataBackground(b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);}});Ext.define("Genesis.view.widgets.MerchantAccountPtsItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.Button","Ext.XTemplate"],xtype:"merchantaccountptsitem",alias:"widget.merchantaccountptsitem",config:{layout:"fit",background:{cls:"merchantPagePanel",tag:"background",items:[{xtype:"container",docked:"bottom",cls:"container",layout:{type:"hbox",align:"stretch"},defaults:{xtype:"component"},items:[{docked:"right",tag:"points",tpl:"+{points} Pts",cls:"points"},{docked:"right",tag:"coinphoto",data:{photo_url:"resources/img/sprites/coin.jpg"},tpl:'<img class="coinphoto" src="{photo_url}" />'}],}],},dataMap:{getBackground:{setData:"background"}}},applyBackground:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBackground());},updateBackground:function(a,b){if(a){this.add(a);}if(b){this.remove(b);}},setDataBackground:function(e){var b=_application.getController("Viewport");var f=b.getCustomer();var h=b.getVenue();var g=h.getId();var a=b.getCheckinInfo().venue;var c=this.query("container[tag=background]")[0];this.setHeight(Ext.Viewport.getSize().width);c.setStyle({"background-image":"url("+e.Merchant.alt_photo["url"]+")"});if(a&&(a.getId()==g)){c.getItems().items[0].show();var d=this.query("component[tag=points]")[0];d.setData(f.getData());}else{c.getItems().items[0].hide();}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"background":h.setDataBackground(b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);}});Ext.define("Genesis.view.widgets.RedemptionsPtsItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.XTemplate"],xtype:"redemptionsptsitem",alias:"widget.redemptionsptsitem",config:{layout:{type:"hbox",align:"stretch"},image:{docked:"left",cls:"photo",data:{photo_url:"resources/img/sprites/coin.jpg"},tpl:'<img src="{photo_url}"/>'},points:{flex:1,tpl:"{points} Points",cls:"points"},dataMap:{getPoints:{setData:"points"}}},applyImage:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getImage());},updateImage:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyPoints:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getPoints());},updatePoints:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"points":k[a](b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);}});Ext.define("Genesis.view.widgets.RewardsCartItem",{extend:"Ext.dataview.component.DataItem",requires:["Ext.field.Select","Ext.XTemplate"],xtype:"rewardscartitem",alias:"widget.rewardscartitem",config:{hideAnimation:!Ext.os.is.Android2?{type:"scroll",direction:"up",duration:250,easing:"ease-out"}:null,layout:{type:"hbox",align:"center"},qty:{value:0,options:[{text:"1",value:1},{text:"2",value:2},{text:"3",value:3},{text:"4",value:4},{text:"5",value:5},{text:"6",value:6},{text:"7",value:7},{text:"8",value:8},{text:"9",value:9}]},image:{cls:"photo",tpl:Ext.create("Ext.XTemplate",'<img src="{[this.getPhoto(values)]}"/>',{getPhoto:function(a){if(!a.photo){return Genesis.view.Rewards.getPhoto(a.type);}return a.photo.url;}})},title:{flex:1,cls:"title",},points:{cls:"points",tpl:Ext.create("Ext.XTemplate","{[this.getPoints(values)]} Pts",{getPoints:function(a){return a.qty*a.points;}})},remove:{hidden:true,iconCls:"delete_black2",tag:"deleteItem",iconMask:true,cls:"plain"},dataMap:{getImage:{setData:"photo_url"},getTitle:{setHtml:"title"},getPoints:{setData:"points"},getQty:{setValue:"qty"}}},applyRemove:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Button,this.getRemove());},updateRemove:function(a,b){if(a){this.add(a);}if(b){this.remove(b);}},applyImage:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getImage());},updateImage:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyTitle:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getTitle());},updateTitle:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyPoints:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getPoints());},updatePoints:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},applyQty:function(a){return Ext.factory(Ext.apply(a,{}),Ext.field.Select,this.getQty());},updateQty:function(b,a){if(b){this.add(b);}if(a){this.remove(a);}},updateRecord:function(d){if(!d){return;}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),l=e.first(),j=h.getDataMap(),f,k,g,a;if(!l){return;}for(f in j){g=j[f];k=h[f]();if(k){for(a in g){if(k[a]){switch(g[a]){case"points":case"photo_url":k[a](b);break;default:k[a](b[g[a]]);break;}}}}}l.updateData(b);}});Ext.define("Genesis.model.frontend.MainPage",{extend:"Ext.data.Model",id:"MainPage",config:{fields:["name","photo_url","desc","pageCntlr","subFeature"],proxy:{reader:{type:"json",messageProperty:"message",rootProperty:"data"},type:"ajax",disableCaching:false,defaultHeaders:{"If-None-Match":""},url:Ext.Loader.getPath("Genesis")+"/store/mainPage.json"}}});Ext.define("Genesis.model.UserProfile",{extend:"Ext.data.Model",alternateClassName:"UserProfile",id:"UserProfile",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"}],fields:["gender","birthday","zipcode","created_ts","update_ts","user_id"]},getUser:function(){}});Ext.define("Genesis.model.User",{extend:"Ext.data.Model",requires:["Genesis.model.UserProfile"],alternateClassName:"User",id:"User",config:{hasOne:[{model:"Genesis.model.UserProfile",associationKey:"profile"}],proxy:{type:"ajax",disableCaching:false,defaultHeaders:{"If-None-Match":""},url:Ext.Loader.getPath("Genesis")+"/store/users.json",reader:{type:"json"}},fields:["user_id","name","email","facebook_id","photo_url","created_ts","update_ts","profile_id"],idProperty:"user_id"}});Ext.define("Genesis.model.Merchant",{extend:"Ext.data.Model",alternateClassName:"Merchant",id:"Merchant",config:{fields:["id","name","email","photo","alt_photo","account_first_name","account_last_name","phone","auth_code","qr_code","payment_account_id","created_ts","update_ts","type"],idProperty:"id"}});Ext.define("Genesis.model.Challenge",{extend:"Ext.data.Model",id:"Challenge",alternateClassName:"Challenge",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],fields:["id","type","name","description","require_verif","data","points","created_ts","update_ts","photo","merchant_id","venue_id"],proxy:{type:"ajax",disableCaching:false,defaultHeaders:{"If-None-Match":""},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetChallengesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/challenges":Ext.Loader.getPath("Genesis")+"/store/challenges.json");},setCompleteChallengeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/challenges/"+a+"/complete");},}});Ext.define("Genesis.model.Checkin",{extend:"Ext.data.Model",alternateClassName:"Checkin",id:"Checkin",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"},{model:"Genesis.model.Venue",getterName:"getVenue",setterName:"setVenue"}],fields:["id","time"]}});Ext.define("Genesis.model.PurchaseReward",{extend:"Ext.data.Model",id:"PurchaseReward",alternateClassName:"PurchaseReward",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,defaultHeaders:{"If-None-Match":""},writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["id","title","points","type","photo","created_ts","update_ts","qty"]},getMerchant:function(){},statics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/purchase_rewards":Ext.Loader.getPath("Genesis")+"/store/rewards.json");}}});Ext.define("Genesis.model.CustomerReward",{extend:"Ext.data.Model",id:"CustomerReward",alternateClassName:"CustomerReward",config:{fields:["id","title","points","type","photo"],idProperty:"id",belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,defaultHeaders:{"If-None-Match":""},writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},statics:{setGetRedemptionsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/customer_rewards":Ext.Loader.getPath("Genesis")+"/store/redemptions.json");},setRedeemPointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/customer_rewards/"+a+"/redeem");}}});Ext.define("Genesis.model.EarnPrize",{extend:"Ext.data.Model",id:"EarnPrize",alternateClassName:"EarnPrize",config:{fields:["id",{name:"expiry_date",type:"date",convert:function(a,b){var a=Date.parse(a,"yyyy-MM-dd");return(!a)?"N/A":Genesis.constants.convertDateNoTimeNoWeek.apply(this,arguments);}}],idProperty:"id",belongsTo:[{model:"Genesis.model.CustomerReward",associationKey:"reward",getterName:"getCustomerReward",setterName:"setCustomerReward"},{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"},{model:"Genesis.model.User",associationKey:"user",getterName:"getUser",setterName:"setUser"}],proxy:{type:"ajax",disableCaching:false,defaultHeaders:{"If-None-Match":""},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getUser:function(){},statics:{setEarnPrizeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/purchase_rewards/earn");},setRedeemPrizeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/earn_prizes/"+a+"/redeem");}}});Ext.define("Genesis.model.Venue",{extend:"Ext.data.Model",requires:["Genesis.model.Challenge","Genesis.model.PurchaseReward","Genesis.model.CustomerReward"],alternateClassName:"Venue",id:"Venue",config:{fields:["id","name","address","city","state","country","zipcode","phone","website","latitude","longitude","created_ts","update_ts","type","merchant_id","sort_id"],belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"}],hasMany:[{model:"Genesis.model.Challenge",name:"challenges"},{model:"Genesis.model.PurchaseReward",name:"purchaseReward"},{model:"Genesis.model.CustomerReward",name:"customerReward"}],proxy:{type:"ajax",disableCaching:false,defaultHeaders:{"If-None-Match":""},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},idProperty:"id",},statics:{setFindNearestURL:function(){this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_nearest":Ext.Loader.getPath("Genesis")+"/store/checkinRecords.json");},setGetClosestVenueURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/find_closest":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");}}});Ext.define("Genesis.model.EligibleReward",{extend:"Ext.data.Model",id:"EligibleReward",alternateClassName:"EligibleReward",config:{idProperty:"reward_id",fields:["reward_id","reward_title","points_difference","reward_type","photo"]}});Ext.define("Genesis.model.Customer",{extend:"Ext.data.Model",requires:["Genesis.model.Checkin"],alternateClassName:"Customer",id:"Customer",config:{belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"},{model:"Genesis.model.User",associationKey:"user",getterName:"getUser",setterName:"setUser"}],hasOne:{model:"Genesis.model.Checkin",associationKey:"last_check_in",getterName:"getLastCheckin",setterName:"setLastCheckin"},proxy:{type:"ajax",disableCaching:false,defaultHeaders:{"If-None-Match":""},writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["points","id"],idProperty:"id"},getUser:function(){},statics:{setFbLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens/create_from_facebook":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setUpdateFbLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/account/update_facebook_info");},setLoginUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/tokens":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setLogoutUrl:function(){this.getProxy().setActionMethods({read:"DELETE"});this.getProxy().setUrl(Genesis.constants.host+"/api/v1/tokens/"+Genesis.constants.authToken);},setCreateAccountUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/sign_up":Ext.Loader.getPath("Genesis")+"/store/customers.json");},setVenueScanCheckinUrl:function(){this.setVenueCheckinUrl();},setVenueCheckinUrl:function(){this.getProxy().setActionMethods({read:(!debugMode)?"POST":"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/check_ins":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");},setVenueExploreUrl:function(a){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl((!debugMode)?Genesis.constants.host+"/api/v1/venues/"+a+"/explore":Ext.Loader.getPath("Genesis")+"/store/customerCheckin.json");}}});Ext.define("Genesis.model.frontend.Account",{extend:"Ext.data.Model",alternateClassName:"Account",id:"Account",config:{fields:["name","username","password"],validations:[{type:"format",field:"name",matcher:/^([a-zA-Z'-]+\s+){1,4}[a-zA-z'-]+$/},{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.model.frontend.Signin",{extend:"Ext.data.Model",alternateClassName:"Signin",id:"Sigin",config:{fields:["username","password"],validations:[{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.view.ViewBase",{extend:"Ext.Container",xtype:"viewbase",config:{},beforeActivate:function(h,b){if(b){var a=Ext.ComponentQuery.query("viewportview")[0];var c=b.getXTypes();for(var f=0;f<a.stack.length;f++){if(a.stack[f].getXTypes().match("merchantaccountview")){var g=a.getNavigationBar();var d=g.getBackButton();var e=g.proxy.backButton;e.setUi("normal");d.setUi("normal");g.setDefaultBackButtonText(g.getAltBackButtonText());e.setText(g.getAltBackButtonText());break;}}if(c.match("merchantaccountview")){a.setAnimationDir("up");}}},beforeDeactivate:function(g,b){var a=Ext.ComponentQuery.query("viewportview")[0];var f=a.getNavigationBar();var c=f.getBackButton();var d=f.proxy.backButton;d.setUi("back");c.setUi("back");f.setDefaultBackButtonText(f.config.defaultBackButtonText);d.setText(f.config.defaultBackButtonText);if(b){var e=g.getXTypes();if(e.match("merchantaccountview")){a.setAnimationDir("up");}}},afterActivate:function(b,a){},afterDeactivate:function(b,a){}});Ext.define("Genesis.view.CheckinExplore",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.plugin.PullRefresh"],alias:"widget.checkinexploreview",config:{title:"Check-in Nearby Places",changeTitle:false,layout:"fit",merchant:null,items:[{xtype:"list",store:"CheckinExploreStore",scrollable:"vertical",emptyText:" ",cls:"checkInExploreList",itemTpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div><div class="listItemDetailsWrapper"><div class="itemTitle">{name}</div><div class="itemDesc">{[this.getAddress(values)]}</div></div>',{getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_small"].url;},getAddress:function(a){return(a.address+",<br/>"+a.city+", "+a.state+", "+a.country+",<br/>"+a.zipcode);}}),onItemDisclosure:Ext.emptyFn,plugins:[{xclass:"Ext.plugin.PullRefresh",refreshFn:function(b){var a=_application.getController("Checkins");_application.dispatch({action:"onExploreLoad",args:[],controller:a,scope:a});}}]},{docked:"bottom",cls:"checkInNow",tag:"checkInNow",xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"button",ui:"checkInNow",tag:"checkInNow",text:"Check In Now!"}]}]},beforeActivate:function(c,a){switch(this.mode){case"checkin":this.getInitialConfig().title="Check-in Nearby Places";break;case"explore":this.getInitialConfig().title="Explore Nearby Places";break;}if(a){var b=a.getXTypes();if(b.match("merchantaccountview|checkinmerchantview")){this.callParent(arguments);}}},beforeDeactivate:function(c,a){var b=c.getXTypes();if(b.match("merchantaccountview|checkinmerchantview")){this.callParent(arguments);}}});Ext.define("Genesis.view.Viewport",{extend:"Ext.navigation.View",requires:["Ext.MessageBox","Ext.ActionSheet","Ext.fx.layout.Card","Ext.SegmentedButton","Genesis.navigation.Bar"],xtype:"viewportview",config:{fadeMode:false,enableAnim:true,autoDestroy:false,cls:"viewport bgImage",fullscreen:true,useTitleForBackButtonText:false,defaultBackButtonText:"Back",altBackButtonText:"Close",navigationBar:{defaults:{iconMask:true},rightButton:{align:"right",iconMask:true,iconCls:"check_black1"},docked:"top",cls:"navigationBarTop",layout:{pack:"justify",align:"center"},items:[{align:"left",iconCls:"maps",tag:"mapBtn",hidden:true},{align:"right",iconCls:"share",tag:"shareBtn",hidden:true,handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{hideOnMaskTap:false,defaults:{defaultUnit:"em",margin:"0 0 0.5 0",xtype:"button",iconCls:"dummy",iconAlign:"left",iconMask:true},items:[{text:"Email",iconCls:"mail",tag:"mail",handler:Ext.emptyFn},{text:"SMS Message",tag:"sms",iconCls:"compose",handler:Ext.emptyFn},{text:"Facebook",tag:"facebook",ui:"blue",iconCls:"facebook",handler:Ext.emptyFn},{margin:"0.5 0 0 0",text:"Cancel",iconMaskCls:"dummymask",ui:"confirm",scope:this,handler:function(){this.actions.hide();}}]});Ext.Viewport.add(this.actions);}this.actions.show();}},{align:"right",tag:"info",iconCls:"info_plain",destroy:function(){this.actions.destroy();this.callParent(arguments);},handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{defaultUnit:"em",padding:"1em",hideOnMaskTap:false,defaults:{xtype:"button",defaultUnit:"em"},items:[{margin:"0 0 0.5 0",text:"Logout",tag:"logout"},{margin:"0.5 0 0 0",text:"Cancel",scope:this,handler:function(){this.actions.hide();}}]});Ext.Viewport.add(this.actions);}this.actions.show();}},{align:"right",tag:"main",iconCls:"check_black1",hidden:true},{align:"right",tag:"checkin",iconCls:"check_black1",hidden:true},{align:"right",tag:"edit",text:"Edit",hidden:true},{align:"right",tag:"done",text:"Done",hidden:true},{align:"right",tag:"redeem",text:"Redeem",hidden:true}]},items:[]},initialize:function(){this.stack=[];this.fadeAnimation={type:"fade",listeners:{scope:this,animationend:"resetFadeAnimation"}};this.callParent(arguments);var b=this.getLayout(),a=b.getAnimation();a.on("animationend","resetAnimation",this);},applyNavigationBar:function(a){if(!a){a={hidden:true,docked:"top"};}if(a.title){delete a.title;Ext.Logger.warn("Ext.navigation.View: The 'navigationBar' configuration does not accept a 'title' property. You set the title of the navigationBar by giving this navigation view's children a 'title' property.");}a.view=this;return Ext.factory(a,Genesis.navigation.Bar,this.getNavigationBar());},resetAnimation:function(){var b=this.getActiveItem().getXTypes();var a=this.getLayout().getAnimation(0);a.getInAnimation().setDirection(this.defaultInAnimationDir);a.getOutAnimation().setDirection(this.defaultOutAnimationDir);this.setFadeMode(false);},setAnimationDir:function(b){var c=this.getLayout(),a;if(c.isCard){a=c.getAnimation();if(a){this.defaultInAnimationDir=a.getInAnimation().getDirection();this.defaultOutAnimationDir=a.getOutAnimation().getDirection();a.getInAnimation().setDirection(b);a.getOutAnimation().setDirection(b);this.setFadeMode(b=="up");}}},resetFadeAnimation:function(){var a=this.getLayout();a.setAnimation(this.defaultAnimation);this.setFadeMode(false);},setFadeAnimation:function(){var a=this.getLayout();this.defaultAnimation=a.getAnimation();a.setAnimation(this.fadeAnimation);this.setFadeMode(true);},doPop:function(b){var d=this;d.stack.pop();var f=d.getLayout().getAnimation();var a=d.stack[d.stack.length-1];var e=d.getActiveItem().getXTypes();if(f&&f.isAnimation&&d.getEnableAnim()){f.setReverse(true);var c=d.getNavigationBar();c.elementGhost=c.createProxy(d,c,a);}d.setActiveItem(a);d.getNavigationBar().onViewRemove(d,a,null);return a;},getPreviousItem:function(){var a=this;return a.stack[a.stack.length-1];},push:function(a){var c=this;var d=c.getLayout().getAnimation();var b=c.getNavigationBar();if((c.stack.length==0)&&(!b.titleComponent.getTitle())){b.titleComponent.setTitle(a.config.title||b.getDefaultBackButtonText());}if(d&&d.isAnimation&&c.getEnableAnim()){d.setReverse(false);b.elementGhost=b.createProxy(c,b,a);}if(c.getInnerItems().indexOf(a)<0){a=c.add(a);}else{c.setActiveItem(a);c.getNavigationBar().onViewAdd(c,a,null);}c.stack.push(a);return a;},doSetActiveItem:function(d,a){if(!d){return;}var c=this;if(d.getInitialConfig().changeTitle===true){var b=((a&&a.getMerchant)?a.getMerchant():null)||_application.getController("Viewport").getVenue();d.getInitialConfig().title=b.get("name");}if(a){a.beforeDeactivate(d,a);}d.beforeActivate(d,a);c.callParent(arguments);if(a){a.afterDeactivate(d,a);}d.afterActivate(d,a);},beforePop:function(d){var c=this;var b=c.stack.length;if(!Ext.isNumber(d)||d<1){d=1;}d=Math.min(d,b);if(d){if(d==b){var a=c.getNavigationBar();a.reset();c.stack=[];a.getBackButton().hide();a.getBackButton().setText(null);}else{c.getNavigationBar().beforePop(d);for(i=0;i<d-1;i++){this.stack.pop();}return true;}}return false;},pop:function(c){var b=this;var a=b.getNavigationBar();b.callParent(arguments);},reset:function(){var b=this;var a=b.stack.length;this.pop(a);}});Ext.define("Genesis.view.ChallengePage",{extend:"Genesis.view.ViewBase",requires:["Ext.data.Store","Ext.dataview.DataView","Ext.XTemplate","Ext.Toolbar","Genesis.model.Challenge","Genesis.view.widgets.ChallengeMenuItem"],alias:"widget.challengepageview",config:{title:"Challenges",changeTitle:false,layout:"fit",scrollable:false,items:[{xtype:"carousel",direction:"horizontal"},{docked:"bottom",cls:"navigationBarBottom",xtype:"tabbar",layout:{pack:"justify",align:"center"},scrollable:{direction:"horizontal",indicators:false},defaults:{iconMask:true,iconAlign:"top"},items:[{xtype:"spacer"},{tag:"doit",iconCls:"doit",title:"Do it!"},{xtype:"spacer"}]},{docked:"bottom",xtype:"container",cls:"challengePageItemDescWrapper",layout:{type:"vbox",align:"stretch",pack:"start"},defaults:{xtype:"component"},items:[{flex:1,cls:"itemDesc",tpl:"{description}"},{cls:"itemDescName",tpl:"{name}"}]}]},takePhoto:function(){if(!this.photoAction){this.photoAction=Ext.create("Ext.ActionSheet",{hideOnMaskTap:false,defaults:{defaultUnit:"em",margin:"0 0 0.5 0",xtype:"button",handler:Ext.emptyFn},items:[{text:"Use Photo from Library",tag:"library"},{text:"Use Photo from Photo Album",tag:"album"},{text:"Take a Picture",tag:"camera"},{margin:"0.5 0 0 0",text:"Cancel",ui:"confirm",scope:this,handler:function(){this.photoAction.hide();}}]});Ext.Viewport.add(this.photoAction);}this.photoAction.show();}});Ext.define("Genesis.view.MainPage",{extend:"Ext.Carousel",requires:["Ext.dataview.DataView","Ext.XTemplate"],alias:"widget.mainpageview",config:{title:"KickBak",changeTitle:false,direction:"horizontal",items:[{docked:"bottom",cls:"checkInNow",tag:"checkInNow",xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"button",ui:"checkInNow",tag:"checkInNow",text:"Check In Now!"}]}]},beforeActivate:function(){var g=this;var a=_application.getController("Viewport");var c=Ext.ComponentQuery.query("viewportview")[0];var b=a.getCheckinInfo().venue!=null;var d=Ext.StoreMgr.get("MainPageStore").getRange();var f=Ext.Array.clone(d);g.removeAll(true);if(!b){Ext.Array.forEach(f,function(k,h,j){switch(k.get("pageCntlr")){case"MainPage":Ext.Array.remove(d,k);break;}});}for(var e=0;e<Math.ceil(d.length/6);e++){g.add({xtype:"dataview",cls:"mainMenuSelections",scrollable:false,deferInitialRefresh:false,store:{model:"Genesis.model.frontend.MainPage",data:Ext.Array.pluck(d.slice(e*6,((e+1)*6)),"data")},itemTpl:Ext.create("Ext.XTemplate",'<div class="mainPageItemWrapper">','<div class="photo"><img src="{[this.getPhoto(values.photo_url)]}" /></div>','<div class="photoName">{name}</div>',"</div>",{getPhoto:function(h){return Ext.isEmpty(h)?Ext.BLANK_IMAGE_URL:h;}}),autoScroll:true});}if(g.getInnerItems().length>0){g.setActiveItem(0);}},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.SettingsPage",{extend:"Ext.form.Panel",requires:["Ext.dataview.List","Ext.XTemplate","Genesis.view.widgets.ListField"],alias:"widget.settingspageview",config:{title:"Settings",changeTitle:false,scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"fieldset",title:"Login Profile",items:[{xtype:"listfield",iconCls:"facebook",name:"facebook",value:"Facebook"}]},{xtype:"fieldset",title:"About Kickbak",items:[{xtype:"listfield",name:"terms",value:"Terms & Conditions"},{xtype:"listfield",name:"privacy",value:"Privacy"},{xtype:"listfield",name:"aboutus",value:"About Us"}]}]},beforeActivate:function(){},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.LoginPage",{extend:"Ext.Container",requires:["Ext.ActionSheet"],alias:"widget.loginpageview",config:{title:"",hideNavBar:true,changeTitle:false,scrollable:false,style:"background:transparent"},initialize:function(){var a=Ext.create("Ext.ActionSheet",{modal:false,style:{background:"transparent",border:"none"},showAnimation:null,hideAnimation:null,defaultUnit:"em",padding:"1em",hideOnMaskTap:false,defaults:{defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"},items:[{tag:"facebook",text:"Facebook"},{tag:"createAccount",text:"Create Account"},{tag:"signIn",text:"Sign In"}]});this.add(a);this.callParent(arguments);},beforeActivate:function(b,a){},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.SignInPage",{extend:"Ext.form.Panel",alias:"widget.signinpageview",requires:["Ext.field.Email","Ext.field.Password"],config:{title:"Sign In",changeTitle:false,scrollable:"vertical",style:"background:transparent",items:[{xtype:"fieldset",title:"Login Credentials:",defaults:{required:true,labelAlign:"top"},items:[{xtype:"emailfield",name:"username",label:"User Name",useClearIcon:true,placeHolder:"Email Address"},{xtype:"passwordfield",name:"password",label:"Password",useClearIcon:false}]},{xtype:"button",ui:"login",tag:"login",text:"Sign In"}]},beforeActivate:function(b,a){b.reset();},beforeDeactivate:function(b,a){},afterActivate:function(b,a){},afterDeactivate:function(b,a){}});Ext.define("Genesis.view.CreateAccountPage",{extend:"Ext.form.Panel",alias:"widget.createaccountpageview",requires:["Ext.field.Text","Ext.field.Email","Ext.field.Password"],config:{title:"Create Account",changeTitle:false,scrollable:"vertical",style:"background:transparent",items:[{xtype:"fieldset",title:"Account Credentials:",defaults:{required:true,labelAlign:"top"},items:[{xtype:"textfield",name:"name",label:"Full Name",useClearIcon:true,placeHolder:"John Smith"},{xtype:"emailfield",name:"username",label:"User Name",useClearIcon:true,placeHolder:"Email Address"},{xtype:"passwordfield",name:"password",label:"Password",useClearIcon:false}]},{xtype:"button",ui:"createAccount",tag:"createAccount",text:"Create Account"}]},beforeActivate:function(b,a){b.reset();},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.Accounts",{extend:"Ext.Container",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar"],alias:"widget.accountsview",config:{title:"Loyalty Accounts",scrollable:false,changeTitle:false,cls:"accountsMain",layout:"fit",items:[{xtype:"list",store:"CustomerStore",tag:"accountsList",scrollable:"vertical",cls:"accountsList",pinHeaders:false,grouped:true,itemTpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="listItemDetailsWrapper">','<div class="points">{[this.getPoints(values)]}</div></div>',{getPhoto:function(a){return a.Merchant.photo["thumbnail_ios_small"].url;},getCoin:function(){return"resources/img/sprites/coin.jpg";},getPoints:function(a){return a.points+" Pts";}}),onItemDisclosure:Ext.emptyFn}]},beforeActivate:function(b,a){},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.MerchantAccount",{extend:"Ext.Container",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar","Ext.tab.Bar","Genesis.view.widgets.MerchantAccountPtsItem"],alias:"widget.merchantaccountview",config:{title:"Venue Name",changeTitle:true,scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{tag:"menchantPagePanel",xtype:"dataview",store:{model:"Genesis.model.Venue",autoLoad:false},useComponents:true,scrollable:false,defaultType:"merchantaccountptsitem",defaultUnit:"em",margin:"0 0 0.8 0"},{xtype:"container",tag:"merchantFeedContainer",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"toolbar",cls:"merchantFeedPanelHdr",centered:false,items:[{xtype:"title",title:"Latest News"},{xtype:"spacer"}]},{xtype:"list",scrollable:false,ui:"bottom-round",store:"EligibleRewardsStore",emptyText:" ",cls:"merchantFeedPanel separator",itemTpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="listItemDetailsWrapper">','<div class="itemDesc wrap">{[this.getDesc(values)]}</div>',"</div>",{getPhoto:function(a){if(!a.photo){return Genesis.view.Rewards.getPhoto({value:a.reward_type});}return a.photo.url;},getDesc:function(a){if(a.points_difference>0){a.disclosure=false;}return a.reward_title;}}),onItemDisclosure:Ext.emptyFn}]},{xtype:"container",tag:"merchantDescContainer",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"toolbar",cls:"merchantDescPanelHdr",centered:false,items:[{xtype:"title",title:"About Us"},{xtype:"spacer"}]},{xtype:"container",cls:"merchantDescPanel separator",tag:"merchantDescPanel",tpl:"{desc}"}]},{docked:"bottom",cls:"navigationBarBottom",xtype:"tabbar",layout:{pack:"justify",align:"center"},scrollable:{direction:"horizontal",indicators:false},defaults:{iconMask:true,iconAlign:"top"},items:[{iconCls:"home",tag:"home",title:"Home"},{iconCls:"prize",tag:"prizes",badgeCls:"x-badge round",title:"Prizes"},{iconCls:"rewards",tag:"rewards",title:"Rewards"},{xtype:"spacer"},{iconCls:"challenges",tag:"challenges",title:"Challenges"},{xtype:"spacer"},{iconCls:"redemption",tag:"redemption",title:"Redeem"},{iconCls:"favorites_circle",tag:"main",title:"Main Menu"},{iconCls:"search1",tag:"browse",title:"Explore"}]}]},statics:{},beforeActivate:function(){},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.MerchantDetails",{extend:"Ext.Container",requires:["Ext.dataview.DataView","Ext.XTemplate","Ext.Map","Genesis.view.widgets.MerchantDetailsItem"],alias:"widget.merchantdetailsview",config:{title:"Venue Name",changeTitle:true,cls:"merchantDetails",scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},defaults:{cls:"separator"},items:[{xtype:"dataview",cls:"separator",useComponents:true,defaultType:"merchantdetailsitem",scrollable:false,store:{model:"Genesis.model.Venue",autoLoad:false}},{xtype:"component",tag:"map",flex:1,cls:"separator gmap",defaultUnit:"em",listeners:{painted:function(d,c){cntlr=_application.getController("Merchants");var b=d.innerElement.getSize();d.setSize(b.width,b.height);var e=Ext.Object.toQueryString(Ext.apply({zoom:15,maptype:"roadmap",sensor:false,size:b.width+"x"+b.height},cntlr.markerOptions));var a=Ext.String.urlAppend(cntlr.self.googleMapStaticUrl,e);d.setData({width:b.width,height:b.height,photo:a});}},tpl:Ext.create("Ext.XTemplate",'<img height="{height}" width="{width}" src="{photo}"/>')}]},beforeActivate:function(){},beforeDeactivate:function(){},afterActivate:function(){},afterDeactivate:function(){}});Ext.define("Genesis.view.Rewards",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar","Genesis.view.widgets.RewardsCartItem"],alias:"widget.rewardsview",config:{title:"Earn Rewards",changeTitle:false,scrollable:false,layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"container",tag:"rewards",flex:1,layout:{type:"card",animation:{duration:600,easing:"ease-in-out",type:"slide",direction:"down"}},activeItem:0,defaults:{xtype:"container",layout:{type:"vbox",align:"stretch",pack:"top"}},items:[{tag:"rewardMainList",items:[{xtype:"toolbar",cls:"earnPtsPanelHdr",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Earn Points (Select Items in your Order)"},{xtype:"spacer",align:"right"}]},{xtype:"list",flex:1,scrollable:"vertical",store:{model:"Genesis.model.PurchaseReward",grouper:{groupFn:function(a){return a.get("points")+" Points";}},sorters:[{property:"points",direction:"ASC"}],autoLoad:false},cls:"rewardsMain",pinHeaders:false,grouped:true,itemTpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="listItemDetailsWrapper">','<div class="itemDesc wrap">{[this.getDesc(values)]}</div>',"</div>",{getPhoto:function(a){if(!a.photo){return Genesis.view.Rewards.getPhoto(a.type);}return a.photo.url;},getDesc:function(a){return a.title;}})}]},{tag:"rewardTallyList",items:[{flex:1,cls:"shadows",xtype:"dataview",maxItemCache:0,scrollable:"vertical",useComponents:true,tag:"rewardsCart",defaultType:"rewardscartitem",cls:"rewardsCart separator_pad",store:"RewardsCartStore"},{xtype:"container",cls:"separator rewardsCartFooter",defaults:{xtype:"component"},items:[{docked:"left",html:"Total"},{cls:"points",tag:"total",docked:"right",data:{points:0},tpl:"{points} Pts"}]},{xtype:"button",cls:"separator",tag:"earnPts",text:"Earn Points!",ui:"yellow-large"}]},{xtype:"component",tag:"prizeCheck",cls:"prizeCheck"}]},{docked:"bottom",cls:"navigationBarBottom",showAnimation:!Ext.os.is.Android2?{type:"slideIn",direction:"up",duration:250,easing:"ease-out"}:null,hideAnimation:!Ext.os.is.Android2?{type:"scroll",direction:"up",duration:250,easing:"ease-out"}:null,xtype:"tabbar",layout:{pack:"justify",align:"center"},scrollable:{direction:"horizontal",indicators:false},defaults:{iconMask:true,iconAlign:"top"},items:[{xtype:"spacer"},{iconCls:"shop2",tag:"cart",badgeCls:"x-badge round",title:"Check Out"},{xtype:"spacer"}]}]},statics:{getPhoto:function(a){var b;switch(a.value){case"appetizer":b="resources/img/sprites/shoes.jpg";break;case"bread":b="resources/img/sprites/heroburgers.jpg";break;case"dessert":b="resources/img/sprites/springrolls.jpg";break;case"drinks":b="resources/img/sprites/phoboga.jpg";break;case"entrees":b="resources/img/sprites/star.jpg";break;case"noodles":b="resources/img/sprites/star.jpg";break;case"pasta":b="resources/img/sprites/star.jpg";break;case"pastry":b="resources/img/sprites/star.jpg";break;case"salad":b="resources/img/sprites/star.jpg";break;case"sandwich":b="resources/img/sprites/shoes.jpg";break;case"side_dish":b="resources/img/sprites/star.jpg";break;case"soup":b="resources/img/sprites/star.jpg";break;}return b;}}});Ext.define("Genesis.view.Redemptions",{extend:"Genesis.view.ViewBase",requires:["Ext.dataview.List","Ext.XTemplate","Ext.Toolbar","Genesis.view.widgets.RedemptionsPtsItem"],alias:"widget.redemptionsview",config:{title:"Redemptions",changeTitle:false,scrollable:"vertical",cls:"redemptionsMain",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"toolbar",cls:"ptsEarnPanelHdr",centered:false,items:[{xtype:"title",title:"Points Earned"},{xtype:"spacer"}]},{cls:"ptsEarnPanel separator",tag:"ptsEarnPanel",xtype:"dataview",useComponents:true,scrollable:false,defaultType:"redemptionsptsitem",store:{model:"Genesis.model.Customer",autoLoad:false}},{xtype:"toolbar",cls:"ptsEarnPanelHdr",centered:false,items:[{xtype:"title",title:"Redemptions Available (Select an item below)"},{xtype:"spacer"}]},{xtype:"list",scrollable:false,ui:"bottom-round",store:{model:"Genesis.model.CustomerReward",autoLoad:false,grouper:{groupFn:function(a){return a.get("points")+" Points";}},sorters:[{property:"points",direction:"ASC"}]},cls:"redemptionsList separator",tag:"redemptionsList",pinHeaders:false,grouped:true,itemTpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>','<div class="listItemDetailsWrapper">','<div class="itemDesc wrap">{[this.getDesc(values)]}</div>',"</div>",{getPhoto:function(a){if(!a.photo){return Genesis.view.Redemptions.getPhoto(a.type);}return a.photo.url;},getDesc:function(a){return a.title;}}),onItemDisclosure:Ext.emptyFn}]},statics:{getPhoto:function(a){var b;switch(a.value){case"appetizer":b="resources/img/sprites/shoes.jpg";break;case"bread":b="resources/img/sprites/heroburgers.jpg";break;case"dessert":b="resources/img/sprites/springrolls.jpg";break;case"drinks":b="resources/img/sprites/phoboga.jpg";break;case"entrees":b="resources/img/sprites/star.jpg";break;case"noodles":b="resources/img/sprites/star.jpg";break;case"pasta":b="resources/img/sprites/star.jpg";break;case"pastry":b="resources/img/sprites/star.jpg";break;case"salad":b="resources/img/sprites/star.jpg";break;case"sandwich":b="resources/img/sprites/shoes.jpg";break;case"side_dish":b="resources/img/sprites/star.jpg";break;case"soup":b="resources/img/sprites/star.jpg";break;case"custom":b="resources/img/sprites/star.jpg";break;}return b;}}});Ext.define("Genesis.view.Prizes",{extend:"Genesis.view.ViewBase",requires:["Ext.XTemplate","Ext.Carousel","Genesis.view.widgets.RewardItem"],alias:"widget.prizesview",config:{title:"Prizes",changeTitle:false,scrollable:false,layout:"fit"},beforeActivate:function(c,b){var d=!(b&&b.getXTypes().match("redemptionsview"));c.getInitialConfig().title=(d)?"Prizes":"Redeem Reward";this.callParent(arguments);if(!d){var a=Ext.ComponentQuery.query("viewportview")[0];a.setAnimationDir("up");}},beforeDeactivate:function(c,b){var d=!c.getXTypes().match("redemptionsview");this.callParent(arguments);if(!d){var a=Ext.ComponentQuery.query("viewportview")[0];a.setAnimationDir("up");}}});Ext.define("Genesis.controller.ControllerBase",{extend:"Ext.app.Controller",requires:["Ext.data.Store"],statics:{sign_in_path:"/sign_in",sign_out_path:"/sign_out",error:function(){var a={};a[FileError.NOT_FOUND_ERR]="File not found";a[FileError.SECURITY_ERR]="Security error";a[FileError.ABORT_ERR]="Abort error";a[FileError.NOT_READABLE_ERR]="Not readable";a[FileError.ENCODING_ERR]="Encoding error";a[FileError.NO_MODIFICATION_ALLOWED_ERR]="No mobification allowed";a[FileError.INVALID_STATE_ERR]="Invalid state";a[FileError.SYFNTAX_ERR]="Syntax error";a[FileError.INVALID_MODIFICATION_ERR]="Invalid modification";a[FileError.QUOTA_EXCEEDED_ERR]="Quota exceeded";a[FileError.TYPE_MISMATCH_ERR]="Type mismatch";a[FileError.PATH_EXISTS_ERR]="Path does not exist";return a;}(),ftError:function(){var a={};a[FileTransferError.FILE_NOT_FOUND_ERR]="File not found";a[FileTransferError.INVALID_URL_ERR]="Invalid URL Error";a[FileTransferError.CONNECTION_ERR]="Connection Error";return a;}(),connection:function(){var a={};a[Connection.UNKNOWN]="Unknown connection";a[Connection.ETHERNET]="Ethernet connection";a[Connection.WIFI]="WiFi connection";a[Connection.CELL_2G]="Cell 2G connection";a[Connection.CELL_3G]="Cell 3G connection";a[Connection.CELL_4G]="Cell 4G connection";a[Connection.NONE]="No network connection";return a;}()},init:function(){this.callParent(arguments);},getViewPortCntlr:function(){return this.getApplication().getController("Viewport");},getViewport:function(){return this.getViewPortCntlr().getView();},pushView:function(d){var b=this.getViewport();var e=this.getApplication();var a=b.stack;var c=(a.length>1)?a[a.length-2]:null;if(c&&c==d){this.popView();}else{b.push(d);}},popView:function(c,f,d){var a=this.getViewport();var g=this.getApplication();a.pop();},getMainPage:Ext.emptyFn,openMainPage:Ext.emptyFn,openPage:Ext.emptyFn,isOpenAllowed:function(){return"Cannot Open Folder";},getGeoLocation:function(b){if(!Genesis.constants.isNative()){b({coords:{latitude:"-50.000000",longitude:"50.000000"}});}else{var a=navigator.network.connection.type;console.debug("Checking Connectivity Type ...["+a+"]");console.debug("Connection type: ["+Genesis.controller.ControllerBase.connection[a]+"]");console.debug("Getting GeoLocation ...");navigator.geolocation.getCurrentPosition(function(c){console.debug("\nLatitude: "+c.coords.latitude+"\nLongitude: "+c.coords.longitude+"\nAltitude: "+c.coords.altitude+"\nAccuracy: "+c.coords.accuracy+"\nAltitude Accuracy: "+c.coords.altitudeAccuracy+"\nHeading: "+c.coords.heading+"\nSpeed: "+c.coords.speed+"\nTimestamp: "+new Date(c.timestamp)+"\n");b(c);},function(c){console.debug("GeoLocation Error["+c.message+"]");switch(c.code){case PositionError.PERMISSION_DENIED:console.debug("PERMISSION_DENIED");break;case PositionError.POSITION_UNAVAILABLE:console.debug("PERMISSION_UNAVAILABLE");break;case PositionError.TIMEOUT:console.debug("TIMEOUT");break;}},{maximumAge:30000,timeout:50000,enableHighAccuracy:true});}},scanQRCode:function(b){var a=function(e){b.callback();console.debug("Failed because: "+ftError[e.code]);};var d=function(e){b.callback(e.response);console.debug("Code = "+e.response.responseCode+" Sent = "+e.bytesSent+" bytes");};console.debug("Scanning QR Code ...");if(!Genesis.constants.isNative()){var c=(this.getCheckinMerchant&&this.getCheckinMerchant().venue)?this.getCheckinMerchant().venue.getId():Ext.StoreMgr.get("CheckinExploreStore").first().getId();d({bytesSent:0,response:{responseCode:c}});}else{window.plugins.qrCodeReader.getCode("file://localhost/test.jpg","http://www.getkickbak.com/test",d,a,new FileUploadOptions());}}});var _application;Ext.define("Genesis.controller.Viewport",{extend:"Genesis.controller.ControllerBase",statics:{},config:{loggedIn:false,customer:null,venue:null,metaData:null,checkinInfo:{venue:null,customer:null,metaData:null},refs:{view:"viewportview",shareBtn:"viewportview button[tag=shareBtn]",checkInNowBar:"container[tag=checkInNow]",},control:{view:{push:"onPush"},shareBtn:{tap:"onShareMerchantTap"},"viewportview button[tag=close]":{tap:"popView"},"button[tag=checkInNow]":{tap:"onCheckinScanTap"},"tabbar[cls=navigationBarBottom] button[tag=info]":{tap:"onInfoTap"},"tabbar[cls=navigationBarBottom] button[tag=home]":{tap:"onHomeButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=prizes]":{tap:"onPrizesButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=accounts]":{tap:"onAccountsButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=challenges]":{tap:"onChallengesButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=rewards]":{tap:"onRewardsButtonTap"},"tabbar[cls=navigationBarBottom] button[tag=redemption]":{tap:"onRedemptionsButtonTap"},tabbar:{tabchange:"onTabBarTabChange"}}},onFeatureTap:function(c,a){var d=this.getApplication();var b=d.getController(c);d.dispatch({action:(!a)?"openMainPage":"openPage",args:(!a)?[]:[a],controller:b,scope:b});},onShareMerchantTap:function(a,d,c){},onInfoTap:function(a,d,c){},onCheckinScanTap:function(a,g,c,h){var d=this;var f=Ext.StoreMgr.get("CheckinExploreStore");d.getGeoLocation(function(b){f.load({jsonData:{},params:{latitude:b.coords.latitude,longitude:b.coords.longitude},callback:function(k,j){if(j.wasSuccessful()){var l=d.getApplication();var e=l.getController("Checkins");e.setPosition(b);l.dispatch({action:"onCheckinScanTap",controller:e,args:arguments,scope:e});}else{Ext.device.Notification.show({title:"Warning",message:"Error loading Venue information."});}},scope:d});});},onAccountsButtonTap:function(a,d,c){this.onFeatureTap("Accounts");console.log("Going to Accounts Page ...");},onChallengesButtonTap:function(a,f,c){var d=this;var g=d.getVenue();Ext.Viewport.setMasked({xtype:"loadmask",message:"Retrieving Challenges ..."});Challenge.setGetChallengesURL();Challenge.load(g.getId(),{params:{merchant_id:g.getMerchant().getId(),venue_id:g.getId()},callback:function(b,e){Ext.Viewport.setMasked(false);if(e.success){g.challenges().add(b);d.onFeatureTap("Challenges");console.log("Going to Challenges Page ...");}}});},onRewardsButtonTap:function(a,d,c){this.onFeatureTap("RewardsRedemptions","rewards");console.log("Going to Rewards Page ...");},onRedemptionsButtonTap:function(a,d,c){this.onFeatureTap("RewardsRedemptions","redemptions");console.log("Going to Redemptions Page ...");},onPrizesButtonTap:function(a,d,c){this.onFeatureTap("Prizes");console.log("Going to Prizes Page ...");},onHomeButtonTap:function(a,d,c){this.getViewport().reset();this.onFeatureTap("MainPage");console.log("Going back to HomePage ...");},onTabBarTabChange:function(b,d,c,a){Ext.defer(function(){if(d){d.setActive(false);}if(c){c.setActive(false);}},500);return true;},onPush:function(a,b){},init:function(a){this.callParent(arguments);console.log("Viewport Init");_application=a;},openMainPage:function(){if(!this.getLoggedIn()){this.onFeatureTap("MainPage","login");}else{this.onFeatureTap("MainPage","main");}}});Ext.define("Genesis.controller.Settings",{extend:"Genesis.controller.ControllerBase",statics:{settings_path:"/settings",},xtype:"settingsCntlr",config:{refs:{settingsPage:{selector:"settingspageview",autoCreate:true,xtype:"settingspageview"}},control:{"settingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"settingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"settingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"},"settingspageview listfield[name=facebook]":{clearicontap:"onFacebookTap"}}},init:function(){this.callParent(arguments);console.log("Settings Init");},getMainPage:function(){return this.getSettingsPage();},openMainPage:function(){var a=this.getMainPage();this.pushView(a);console.log("SettingsPage Opened");},onTermsTap:function(a,c){Ext.device.Notification.show({title:"Button Tapped",message:"Disclose List Item"});},onFacebookTap:function(a,c){Customer.setUpdateFbLoginUrl();Genesis.constants.facebook_onLogin(function(b){Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:b});});},onTermsTap:function(a,c){Ext.device.Notification.show({title:"Terms Tapped",message:"Disclose List Item"});},onPrivacyTap:function(a,c){Ext.device.Notification.show({title:"Privacy Tapped",message:"Disclose List Item"});},onAboutUsTap:function(a,c){Ext.device.Notification.show({title:"About Us Tapped",message:"Disclose List Item"});},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.MainPage",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store","Genesis.model.EarnPrize"],statics:{mainPage_path:"/mainPage",loginPage_path:"/loginPage",sign_in_path:"/sign_in",sign_out_path:"/sign_out",},xtype:"mainPageCntlr",config:{models:["frontend.MainPage","frontend.Signin","frontend.Account","EligibleReward","Customer","User","Merchant","EarnPrize","CustomerReward"],refs:{login:{selector:"loginpageview",autoCreate:true,xtype:"loginpageview"},signin:{selector:"signinpageview",autoCreate:true,xtype:"signinpageview"},createAccount:{selector:"createaccountpageview",autoCreate:true,xtype:"createaccountpageview"},main:{selector:"mainpageview",autoCreate:true,xtype:"mainpageview"},mainCarousel:"mainpageview",mainBtn:"viewportview button[tag=main]",infoBtn:"viewportview button[tag=info]"},control:{login:{activate:"onLoginActivate",deactivate:"onLoginDeactivate"},"actionsheet button[tag=facebook]":{tap:"onFacebookTap"},"actionsheet button[tag=createAccount]":{tap:"onCreateAccountTap"},"actionsheet button[tag=signIn]":{tap:"onSignInTap"},"signinpageview button[tag=login]":{tap:"onSignInSubmit"},"createaccountpageview button[tag=createAccount]":{tap:"onCreateAccountSubmit"},"actionsheet button[tag=logout]":{tap:"onLogoutTap"},"mainpageview dataview":{select:"onItemSelect",itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd"},main:{activate:"onActivate",deactivate:"onDeactivate"}}},init:function(b){this.callParent(arguments);var a=this;Ext.regStore("MainPageStore",{model:"Genesis.model.frontend.MainPage",autoLoad:true});Ext.regStore("UserStore",{model:"Genesis.model.User",autoLoad:false});Ext.regStore("MerchantPrizeStore",{model:"Genesis.model.EarnPrize",autoLoad:false,clearOnPageLoad:false,sorters:[{sorterFn:function(d,c){return d.getMerchant().getId()-c.getMerchant().getId();}},{sorterFn:function(d,c){return d.get("expiry_date")-c.get("expiry_date");}},{sorterFn:function(d,c){return d.getId()-c.getId();}}],listeners:{scope:this,load:function(e,d,g,c,f){e.loadCallback=[d,c];},metachange:function(d,f,e){var g=a.getApplication();var c=g.getController("RewardsRedemptions");g.dispatch({action:"onRewardMetaChange",args:[d,f.getReader().metaData],controller:c,scope:c});}}});Ext.regStore("EligibleRewardsStore",{model:"Genesis.model.EligibleReward",autoLoad:false});console.log("MainPage Controller Init");},onItemSelect:function(f,b,c){f.deselect([b],false);console.log("Controller=["+b.data.pageCntlr+"]");var a=this.getApplication().getController(b.get("pageCntlr"));var e=a.isOpenAllowed();if(e===true){if(b.get("subFeature")){a.openPage(b.get("subFeature"));}else{a.openMainPage();}}else{Ext.device.Notification.show({title:"Error",message:e});}return false;},onItemTouchStart:function(g,a,f,c,b){},onItemTouchEnd:function(g,a,f,c,b){},onActivate:function(b,a){this.getInfoBtn().show();this.getMainBtn().hide();},onDeactivate:function(b,a){this.getInfoBtn().hide();},onLoginActivate:function(b,a){this.getInfoBtn().hide();this.getMainBtn().hide();},onLoginDeactivate:function(b,a){},onLogoutTap:function(k,f,g){var h=this.getViewport();var l=this.getViewPortCntlr();var c=Genesis.constants;var j=0;var a=function(){h.setFadeAnimation();l.onFeatureTap("MainPage","login");};var d=function(){console.log("Logging out ...");Customer.setLogoutUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},callback:function(e,b){if(b.wasSuccessful()){console.log("Logout Successful!");l.setLoggedIn(false);c.authToken=null;if(c.currFbId){Genesis.constants.facebook_onLogout(function(){a();});}else{a();}}}});};k.parent.onAfter({hiddenchange:function(){if((j|=1)==17){d();}},single:true});k.parent.hide();if(c.currFbId){console.log("Logging out of Facebook ...");Genesis.constants.facebook_onLogout(function(){if((j|=16)==17){d();}});}else{console.log("No Login info found from Facebook ...");if((j|=16)==17){d();}}},onFacebookTap:function(a,d,c){if(!Ext.StoreMgr.get("CustomerStore")){this.loginCommon();}Genesis.constants.fbLogin(function(b){console.log("Logging into Kickbak using Facebook account ...");Customer.setFbLoginUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:b});});},onCreateAccountTap:function(a,d,c){this.pushView(this.getCreateAccount());},onSignInTap:function(a,d,c){this.pushView(this.getSignin());},loginCommon:function(){Ext.regStore("CustomerStore",{model:"Genesis.model.Customer",autoLoad:false,pageSize:1000,listeners:{scope:this,load:function(c,b,f,a,d){if(f){var e=this.getViewPortCntlr();e.setLoggedIn(true);this.getViewport().reset(this);e.onFeatureTap("MainPage");}},metachange:function(j,f,e){var a=f.getReader().metaData;var d=a.prizes;if(d){console.debug("Total Prizes - "+d.length);for(var c=0;c<d.length;c++){d[c].reward={data:d[c].reward};}Ext.StoreMgr.get("MerchantPrizeStore").setData(d);}var h=a.auth_token;if(h){console.debug("AuthToken - "+h);Genesis.constants.authToken=h;}var b=a.eligible_rewards;if(b){console.debug("Total Eligible Rewards - "+b.length);var g=Ext.StoreMgr.get("EligibleRewardsStore");g.setData(b);}}},grouper:{groupFn:function(a){return a.getMerchant().get("name");}},sorters:[{sorterFn:function(b,a){return a.getMerchant().get("name")-b.getMerchant().get("name");}}]});},onCreateAccountSubmit:function(h,f,g){var d=this.getCreateAccount();var l=d.getValues();var c=Ext.create("Genesis.model.frontend.Account",l);var a=c.validate();if(!a.isValid()){var k=a.first();var j=Ext.ComponentQuery.query("field[name="+k.getField()+"]")[0].getLabel();Ext.device.Notification.show({title:"Oops",message:j+" "+k.getMessage()+((Genesis.constants.isNative())?".<br/>":"\n")+"Please Try Again"});}else{Customer.setCreateAccountUrl();if(!Ext.StoreMgr.get("CustomerStore")){this.loginCommon();}Ext.StoreMgr.get("CustomerStore").load({params:{name:l.name,email:l.username,password:l.password},jsonData:{}});}},onSignInSubmit:function(g,d,f){var k=this.getSignin();var l=k.getValues();var c=Ext.create("Genesis.model.frontend.Signin",l);var a=c.validate();if(!a.isValid()){var j=a.first();var h=Ext.ComponentQuery.query("field[name="+j.getField()+"]")[0].getLabel();Ext.device.Notification.show({title:"Oops",message:h+" "+j.getMessage()+((Genesis.constants.isNative())?".<br/>":"\n")+"Please Try Again"});}else{Customer.setLoginUrl();if(!Ext.StoreMgr.get("CustomerStore")){this.loginCommon();}Ext.StoreMgr.get("CustomerStore").load({params:{email:l.username,password:l.password},jsonData:{}});}},openPage:function(a){switch(a){case"main":var c=this.getApplication();var b=c.getController("Merchants");c.dispatch({action:"onMainButtonTap",args:["checkin"],controller:b,scope:b});break;case"login":this.pushView(this.getLogin());break;}},getMainPage:function(){return this.getMain();},openMainPage:function(){var a=this.getViewPortCntlr();this.pushView(this.getMainPage());console.log("MainPage Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.Checkins",{extend:"Genesis.controller.ControllerBase",statics:{checkin_path:"/checkin"},xtype:"checkinsCntlr",config:{refs:{explore:{selector:"checkinexploreview",autoCreate:true,xtype:"checkinexploreview"},checkInNowBar:"checkinexploreview container[tag=checkInNow]",shareBtn:"viewportview button[tag=shareBtn]"},control:{checkinexploreview:{activate:"onExploreActivate",deactivate:"onExploreDeactivate"},"checkinexploreview list":{select:"onExploreSelect",disclose:"onExploreDisclose"}},models:["Venue","Merchant","EarnPrize"],position:null,},init:function(){Ext.regStore("CheckinExploreStore",{model:"Genesis.model.Venue",autoLoad:false,listeners:{metachange:function(c,e,d){var a=e.getReader().metaData;var f=a.eligible_rewards;if(f){console.debug("Total Eligible Rewards - "+f.length);var b=Ext.StoreMgr.get("EligibleRewardsStore");b.setData(f);}}}});Ext.regStore("CheckinStore",{model:"Genesis.model.Customer",autoLoad:false,listeners:{metachange:function(a,c,b){}}});console.log("Checkins Init");},onCheckInScanNow:function(j,d,f,k,c,a,h,m){c=c||"checkin";a=a||"setVenueCheckinUrl";h=h||"scan";var l;var g=this;switch(h){case"scan":g.scanQRCode({callback:function(b){if(b){Ext.Viewport.setMasked({xtype:"loadmask",message:"Checking in ..."});var e=b.responseCode||"";console.debug("qrcode - "+e);g.onCheckinCommonTap(j,d,f,c,a,e,g.getPosition(),m);}else{console.debug("No QR Code Scanned!");Ext.device.Notification.show({title:"Warning",message:"No QR Code Scanned!"});}}});break;default:Ext.Viewport.setMasked({xtype:"loadmask",message:"Retrieving Merchant Info"});this.onCheckinCommonTap(j,d,f,c,a,"",null,m);break;}},setupCheckinInfo:function(e,d,c,b){var a=this.getViewPortCntlr();a.setVenue(d);a.setCustomer(c);a.setMetaData(b);switch(e){case"checkin":a.setCheckinInfo({venue:a.getVenue(),customer:a.getCustomer(),metaData:a.getMetaData()});break;default:break;}this.getExplore().setMerchant(null);},onCheckinTap:function(a,d,c,f){this.onCheckInScanNow(a,d,c,f,"checkin","setVenueCheckinUrl","scan",function(){Ext.device.Notification.vibrate();});},onNonCheckinTap:function(a,d,c,f,g){this.onCheckInScanNow(a,d,c,f,"explore","setVenueExploreUrl","noscan",g);},onCheckinHandler:function(m,p,g,a,t,l,d){var k=this.getApplication();var u=Ext.StoreMgr.get("CustomerStore");var o=Ext.StoreMgr.get("CheckinExploreStore");var e=k.getController("Merchants");var b,j,f,h,q;if(l.wasSuccessful()&&p){for(var r=0;r<t.length;r++){b=t[r];j=b.getId();q=b.get("points");var n=p.venue_id||o.first().getId();h=o.getById(n);f=g.getById(j);console.debug("CheckIn - new_venueId:'"+n+"' venue_id:'"+a+"'");if((n==a)||(a==null)){var c=u.getById(j);if(c!=null){c.set("points",q);c.setLastCheckin(b.getLastCheckin());}else{c=u.add(b)[0];console.debug("CheckIn - Not in current Customer DB! CustomerId=["+c.getId()+"]");}console.debug("CheckIn - points:'"+q+"'");this.setupCheckinInfo(m,h,c,p);break;}}if(r>t.length){console.debug("CheckIn - No Merchants Found!");return;}console.debug("CheckIn - Opening Merchant Account Page ...");this.getViewport().reset();Ext.Viewport.setMasked(false);k.dispatch({action:"openMainPage",args:[],controller:e,scope:e});if(d){d();}console.debug("CheckIn - Done");}},onExploreLoad:function(){var a=this;a.getGeoLocation(function(b){a.setPosition(b);Venue.setFindNearestURL();Ext.StoreMgr.get("CheckinExploreStore").load({params:{latitude:b.coords.latitude,longitude:b.coords.longitude},callback:function(d,c){if(c.wasSuccessful()){a.getCheckInNowBar().setDisabled(false);}},scope:a});});},onExploreActivate:function(){var b=this;var a=b.getViewPortCntlr();b.getExplore().setMerchant(null);b.onExploreLoad();switch(b.mode){case"checkin":b.getCheckInNowBar().show();b.getCheckInNowBar().setDisabled(true);break;case"explore":b.getCheckInNowBar().hide();break;}},onExploreDeactivate:function(){},onExploreSelect:function(c,a,b){c.deselect([a]);this.onExploreDisclose(c,a);return false;},onExploreDisclose:function(f,a,h,b,g,c,d){this.getExplore().setMerchant(a?a.getMerchant():null);this.getViewPortCntlr().setVenue(a);switch(this.mode){case"checkin":this.onCheckinTap(null,g,c,d);break;case"explore":this.onNonCheckinTap(null,g,c,d);break;}},onCheckinCommonTap:function(p,n,o,j,a,q,h,r){var k,m;if(h){k=h.coords.latitude;m=h.coords.longitude;}var l=this.getViewPortCntlr();var f=Ext.StoreMgr.get("CheckinStore");var c=this.getViewport().getActiveItem();var d=(l.getVenue()?l.getVenue().getId():null);console.debug("CheckIn - auth_code:'"+q+"' venue_id:'"+d+"'");Customer[a](d);var g={latitude:k||0,longitude:m||0,auth_code:q||0};if(d){g=Ext.apply(g,{venue_id:d});}f.load({jsonData:{},params:g,scope:this,callback:function(e,b){this.onCheckinHandler(j,f.getProxy().getReader().metaData,f,d,e,b,r);}});},onCheckinScanTap:function(a,d,c,f){this.getExplore().setMerchant(null);this.getViewPortCntlr().setVenue(null);this.onCheckInScanNow(a,d,c,f,"checkin","setVenueScanCheckinUrl","scan",function(){Ext.device.Notification.vibrate();});},openPage:function(a){var c=this.getMainPage();var b=c.query("list")[0].getPlugins()[0];b.refreshFn=b.getRefreshFn();this.mode=c.mode=a;this.pushView(c);},getMainPage:function(){return this.getExplore();},openMainPage:function(){var b=this.getMainPage();var a=b.query("list")[0].getPlugins()[0];a.refreshFn=a.getRefreshFn();this.pushView(b);console.log("Checkin Explore Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.Challenges",{extend:"Genesis.controller.ControllerBase",statics:{challenges_path:"/challenges"},xtype:"challengesCntlr",config:{refs:{challengeBtn:"challengepageview tabbar button[tag=doit]",challengePage:{selector:"challengepageview",autoCreate:true,xtype:"challengepageview"}},control:{challengePage:{activate:"onActivate",deactivate:"onDeactivate"},"challengepageview > carousel dataview":{select:"onItemSelect"},challengeBtn:{tap:"onChallengeBtnTap"},"actionsheet button[tag=library]":{tap:"onLibraryBtnTap"},"actionsheet button[tag=album]":{tap:"onAlbumBtnTap"},"actionsheet button[tag=camera]":{tap:"onCameraBtnTap"}}},model:["Challenge"],init:function(a){this.callParent(arguments);console.log("Challenge Init");},getPointsMsg:function(a){return"You've earned "+a+" Points from this challenge!";},onItemSelect:function(f,a,c){f.deselect([a],false);var e=this.getChallengePage().query("container[docked=bottom][xtype=container]")[0];for(var b=0;b<e.getItems().length;b++){e.getItems().getAt(b).updateData(a.getData());}this.selectedItem=a;return true;},onItemTouchStart:function(g,a,f,c,b){Ext.fly(Ext.query("#"+f.id+" div.photo")[0]).mask();},onItemTouchEnd:function(g,a,f,c,b){Ext.fly(Ext.query("#"+f.id+" div.photo")[0]).unmask();},onChallengeBtnTap:function(m,h,j){var l=this;var f=Ext.StoreMgr.get("CustomerStore");var k=l.getViewPortCntlr();var c=k.getVenue();var d=c.getId();var o=k.getCustomer().getId();var n=c.getMerchant().getId();var g=l.selectedItem;var a=g.getId();if(g){switch(g.get("challenge_type")){case"menu":break;case"checkin":break;case"photo":l.getChallengePage().takePhoto();break;s;case"birthday":break;case"referral":break;case"custom":break;}}if(g.get("require_verif")){Ext.device.Notification.show({title:l.selectedItem.get("name")+" Challenge",message:"Show this to your server before proceeding.",callback:function(){l.getGeoLocation(function(b){l.scanQRCode({callback:function(e){if(e&&e.responseCode){var p=e.responseCode;console.debug("qrcode - "+p);Challenge.setCompleteChallengeURL(a);Challenge.load(a,{jsonData:{},params:{venue_id:d,merchant_id:n,latitude:b.coords.latitude,longitude:b.coords.longitude,auth_code:p},callback:function(){var q=Challenge.getProxy().getReader().metaData;Ext.device.Notification.show({title:"Earn Points",message:l.getPointsMsg(q.points)});f.getById(o).set("points",q.account_points);}});}else{console.debug("No QR Code Scanned!");Ext.device.Notification.show({title:"Error",message:"No QR Code Scanned!"});}}});});}});}},onCameraSuccessFn:function(a){var c=this;var d=c.getChallengePage().photoAction;var b=c.selectedItem.get("points");console.debug("image size =["+a.length+" bytes]");console.debug("Points Earned = "+b+" Pts");if(Genesis.constants.isNative()){}else{}var e={message:"Photo Description",url:"data:image/jpeg;base64,"+a,access_token:FB.getAccessToken()};Ext.Viewport.setMasked({xtype:"loadmask",message:"Uploading to Facebook ..."});FB.api("/me/photos","post",e,function(f){Ext.Viewport.setMasked(false);if(!f||f.error){var g=(f&&f.error)?f.error.message:"Failed to upload the photo onto your Facebook account";Ext.device.Notification.show({title:"Upload Failed!",message:g});}else{console.debug("Post ID - "+f.id);Ext.device.Notification.show({title:"Upload Complete",message:"Your Photo has been uploaded to your Facebook account",callback:function(){c.popView();}});}});},onCameraErrorFn:function(a){console.debug("onCameraErrorFn - message["+a+"]");Ext.device.Notification.show({title:"Error",message:a+((!Genesis.constants.isNative())?"<br/>":"\n")+"No Photos were taken."});},onPhotoBtnCommon:function(a){var b=this;var c=b.getChallengePage().photoAction;c.hide();if(Genesis.constants.isNative()){var d={quality:75,destinationType:Camera.DestinationType.DATA_URL,sourceType:a,allowEdit:true,encodingType:Camera.EncodingType.JPEG,targetWidth:960};navigator.camera.getPicture(Ext.bind(b.onCameraSuccessFn,b),Ext.bind(b.onCameraErrorFn,b),d);}else{b.onCameraSuccessFn("http://photos.getkickbak.com/paella9finish1.jpg");}},onLibraryBtnTap:function(a,d,c){this.onPhotoBtnCommon(Camera.PictureSourceType.PHOTOLIBRARY);},onAlbumBtnTap:function(a,d,c){this.onPhotoBtnCommon(Camera.PictureSourceType.SAVEDPHOTOALBUM);},onCameraBtnTap:function(a,d,c){this.onPhotoBtnCommon(Camera.PictureSourceType.CAMERA);},onActivate:function(){var a=this.getViewPortCntlr().getVenue();var e=a.getId();var d=this.getChallengePage().query("carousel")[0];var b=a.challenges().getRange();d.removeAll(true);for(var c=0;c<Math.ceil(b.length/6);c++){d.add({xtype:"dataview",cls:"challengeMenuSelections",useComponents:true,defaultType:"challengemenuitem",scrollable:false,store:{model:"Genesis.model.Challenge",data:Ext.Array.pluck(b.slice(c*6,((c+1)*6)),"data")}});}if(d.getInnerItems().length>0){d.setActiveItem(0);}},onDeactivate:function(){},getMainPage:function(){return this.getChallengePage();},openMainPage:function(){this.pushView(this.getMainPage());console.log("ChallengePage Opened");},isOpenAllowed:function(){return((this.getViewportCntlr().getVenue())?true:"Cannot open Challenges until You have Checked-in into a Venue");}});Ext.define("Genesis.controller.Merchants",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{merchantMain_path:"/merchantMain",merchant_path:"/merchant",merchantDetails_path:"/merchantDetails",googleMapStaticUrl:"http://maps.googleapis.com/maps/api/staticmap"},xtype:"merchantsCntlr",config:{refs:{main:{selector:"merchantaccountview",autoCreate:true,xtype:"merchantaccountview"},merchantDetails:{selector:"merchantdetailsview",autoCreate:true,xtype:"merchantdetailsview"},pagePanel:"merchantaccountview dataview[tag=menchantPagePanel]",merchantFeedContainer:"merchantaccountview container[tag=merchantFeedContainer]",merchantDescContainer:"merchantaccountview container[tag=merchantDescContainer]",merchantDescPanel:"merchantaccountview container[tag=merchantDescPanel]",mapBtn:"viewportview button[tag=mapBtn]",shareBtn:"viewportview button[tag=shareBtn]",checkinBtn:"viewportview button[tag=checkin]",mainBtn:"merchantaccountview tabbar[cls=navigationBarBottom] button[tag=main]",prizesBtn:"merchantaccountview tabbar[cls=navigationBarBottom] button[tag=prizes]"},control:{main:{activate:"onMainActivate",deactivate:"onMainDeactivate"},mainBtn:{tap:"onMainButtonTap"},mapBtn:{tap:"onMapBtnTap"},"merchantaccountview button[ui=yellow]":{tap:"onMerchantAccountRewardsTap"},"merchantaccountview list":{select:"onMainSelect",disclose:"onMainDisclose"},checkinBtn:{tap:"onCheckinTap"},"merchantaccountview tabbar[cls=navigationBarBottom] button[tag=browse]":{tap:"onBrowseTap"},merchantDetails:{activate:"onDetailsActivate",deactivate:"onDetailsDeactivate"},"merchantdetailsview map":{maprender:"onMapRender"},"merchantdetailsview component[tag=map]":{}}},init:function(){var a=this;a.markersArray=[];if(window.google&&window.google.maps&&window.google.maps.Map){google.maps.Map.prototype.clearOverlays=function(){if(a.markersArray){for(var b=0;b<a.markersArray.length;b++){a.markersArray[b].setMap(null);}}};}else{console.debug("Google Maps API cannot be instantiated");}a.callParent(arguments);console.log("Merchants Init");},onActivateCommon:function(c,a){var b=(window.google&&window.google.maps&&window.google.maps.Marker)?window.google.maps:null;if(a&&b){c.getMap().clearOverlays();this.marker=new b.Marker(Ext.apply(this.markerOptions,{map:a}));c.setMapCenter(this.latLng);}else{}},onDetailsActivate:function(){var a=this.getMerchantDetails();var c=this.getViewPortCntlr().getVenue();var b=a.query("component[tag=map]")[0];a.query("dataview")[0].getStore().setData(c);this.getShareBtn().show();this.getMainBtn().hide();this.onActivateCommon(b,null);a.getScrollable().getScroller().scrollTo(0,0);},onDetailsDeactivate:function(){var a=this.getViewPortCntlr();var b=this.getMerchantDetails();var c=a.getVenue();this.getShareBtn().hide();},onMapRender:function(c,b,a){this.onActivateCommon(c,b);},onMainActivate:function(){var m=this;var k=m.getViewPortCntlr();var l=m.getMain();var h=k.getVenue();var c=k.getCustomer();var o=k.getCustomer().getId();var b=h.getId();var n=h.getMerchant().getId();var j=k.getCheckinInfo().venue;var d=(j!=null);var a=(d&&(j.getId()==b));m.getPagePanel().getStore().setData(h);if(o>0){m.getMerchantDescContainer().hide();m.getMerchantFeedContainer().show();}else{m.getMerchantFeedContainer().hide();m.getMerchantDescPanel().setData(h.getMerchant());m.getMerchantDescContainer().show();}m.getMapBtn().show();m.getCheckinBtn()[(d&&!a)?"show":"hide"]();m.getMainBtn()[(d&&!a)?"show":"hide"]();var e=0,g=Ext.StoreMgr.get("MerchantPrizeStore").getRange();for(var f=0;f<g.length;f++){if(g[f].getMerchant().getId()==n){e++;}}m.getPrizesBtn().setBadgeText((e>0)?e:null);m.getMain().getScrollable().getScroller().scrollTo(0,0);},onMainDeactivate:function(){this.getMapBtn().hide();this.getCheckinBtn().hide();},onMainDisclose:function(d,a,g,b,f,c){},onMainSelect:function(c,a,b){c.deselect([a]);this.onMainDisclose(c,a);return false;},onCheckinTap:function(c,h,f){var g=this;var j=g.getApplication();var a=g.getViewPortCntlr();var d=j.getController("Checkins");g.getGeoLocation(function(b){d.setPosition(b);j.dispatch({action:"onCheckinTap",args:arguments,controller:d,scope:d});});},onBrowseTap:function(a,f,d){var g=this.getApplication();var c=g.getController("Checkins");g.dispatch({action:"openPage",args:["explore"],controller:c,scope:c});},onPageActivate:function(){},onPageDeactivate:function(){},onMainButtonTap:function(l,g,h,n){var k=this;var j=k.getViewPortCntlr();var p=k.getViewport();var c=k.getApplication();var a=j.getCheckinInfo().customer;var f=j.getCheckinInfo().venue;var q=j.getCheckinInfo().metaData;var m=c.getController("Checkins");var o=Ext.StoreMgr.get("EligibleRewardsStore");var d=(k.getMainPage()==p.getActiveItem());if(j.getVenue().getId()!=f.getId()){m.setupCheckinInfo("checkin",f,a,q);}console.log("Going to Merchant Home Account Page ...");o.setData(q.eligible_rewards);p.reset();if(d){p.setFadeAnimation();p.doSetActiveItem(k.getMainPage(),null);}k.openMainPage();},onMapBtnTap:function(a,k,h){var j=(window.google&&window.google.maps&&window.google.maps.LatLng)?window.google.maps:null;var d=this.getViewPortCntlr().getVenue();this.latLng=d.get("latitude")+","+d.get("longitude");var f="red",g="";var c=d.get("address")+", "+d.get("city")+", "+d.get("state")+", "+d.get("country")+", "+d.get("zipcode");this.markerOptions={markers:"color:"+f+"|label:"+g+"|"+this.latLng,center:this.latLng,title:d.get("name")};console.debug("Cannot Retrieve Google Map Information.");this.pushView(this.getMerchantDetails());},getMainPage:function(){return this.getMain();},openMainPage:function(){this.pushView(this.getMainPage());console.log("Merchant Account Opened");}});Ext.define("Genesis.controller.RewardsRedemptions",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{rewards_path:"/rewards",redemption_path:"/redemption"},xtype:"rewardsRedemptionsCntlr",models:["PurchaseReward","CustomerReward"],config:{prizeCheckMsg:"Find out if you won a PRIZE!",refs:{backButton:"viewportview button[text=Close]",doneBtn:"viewportview button[tag=done]",editBtn:"viewportview button[tag=edit]",rewards:{selector:"rewardsview",autoCreate:true,xtype:"rewardsview"},rewardsCart:"rewardsview dataview[tag=rewardsCart]",rewardsCartTotal:"rewardsview component[tag=total]",rewardsTallyList:"rewardsview container[tag=rewardTallyList]",rewardsContainer:"rewardsview container[tag=rewards]",rewardsList:"rewardsview container[tag=rewardMainList] list",earnPtsBtn:"rewardsview button[tag=cart]",navigationBarBottom:"rewardsview tabbar[cls=navigationBarBottom]",redemptions:{selector:"redemptionsview",autoCreate:true,xtype:"redemptionsview"},redemptionsList:"redemptionsview list[tag=redemptionsList]",redemptionsPts:"redemptionsview component[tag=points]",redemptionsPtsEarnPanel:"redemptionsview dataview[tag=ptsEarnPanel]"},control:{}},init:function(){this.initRewards();this.initRedemptions();console.log("Rewards & Redemptions Init");},initRewards:function(){this.control({editBtn:{tap:this.onRewardsCartEditTap},doneBtn:{tap:this.onRewardsCartDoneTap},rewards:{activate:this.onRewardsActivate,deactivate:this.onRewardsDeactivate},"rewardsview list":{select:this.onRewardsItemSelect},earnPtsBtn:{tap:this.onRewardsShopCartTap},rewardsContainer:{activeitemchange:this.onRewardsContainerActivate},"rewardsview dataview[tag=rewardsCart] rewardscartitem button[iconCls=delete_black2]":{tap:this.onRewardsCartItemDeleteTap},"rewardsview dataview[tag=rewardsCart] rewardscartitem selectfield":{change:this.onRewardsCartItemSelectChange},"rewardsview container[tag=rewardTallyList] button[tag=earnPts]":{tap:this.onRewardsEarnPtsTap},"checkinmerchantview button[tag=checkinBtn]":{tap:this.onCheckInTap}});Ext.regStore("RewardsStore",{model:"Genesis.model.PurchaseReward",config:{autoLoad:false}});Ext.regStore("RewardsCartStore",{model:"Genesis.model.PurchaseReward",config:{autoLoad:false,},proxy:{type:"memory"}});},initRedemptions:function(){this.control({redemptions:{activate:this.onRedemptionsActivate,deactivate:this.onRedemptionsDeactivate},redemptionsList:{select:this.onRedemptionsItemListSelect,disclose:this.onRedemptionsItemListDisclose}});Ext.regStore("RedemptionsStore",{model:"Genesis.model.CustomerReward",autoLoad:false,grouper:{groupFn:function(a){return a.get("points")+" Points";}},sorters:[{property:"points",direction:"ASC"}],listeners:{scope:this,metachange:function(a,c,b){this.onRedeemMetaChange(a,c.getReader().metaData);}}});},getPointsMsg:function(a){return"You've earned "+a+" Points from this purchase!";},getVipMsg:function(a){return"You've earned an additional"+a+" Points!"+((!Genesis.constants.isNative())?"<br/>":"\n")+this.getPrizeCheckMsg();},showNavBar:function(){var d=Ext.StoreMgr.get("RewardsCartStore");var b=this.getViewPortCntlr();var e=b.getVenue();var a=b.getCheckinInfo().venue;var c=(a&&(a.getId()==e.getId()))&&(d.getCount()>0);this.getNavigationBarBottom()[(c)?"show":"hide"]();},updateRewardsCartTotal:function(b){var d=this.getRewardsCartTotal(),a=0;for(var c=0;c<b.length;c++){a+=b[c].get("qty")*b[c].get("points");}if(d){d.setData({points:a});}var e=this.getEarnPtsBtn();if(e){Ext.Anim.run(e.badgeElement,"pop",{out:false,autoClear:false});this.getEarnPtsBtn().setBadgeText((b.length>0)?a+"Pts":null);}return a;},clearRewardsCart:function(){var a=Ext.StoreMgr.get("RewardsCartStore");if(a){a.removeAll();a.data.updateIndices();}this.updateRewardsCartTotal([]);},prizeCheck:function(e){var f=this;var d=e.loadCallback[0];var c=e.loadCallback[1];var a=f.getViewPortCntlr();if(!c.wasSuccessful()){var b=f.getRewardsContainer();b.setActiveItem(0);}else{f.clearRewardsCart();if(d.length==0){Ext.device.Notification.show({title:"Scan And Win!",message:"Oops, Play Again!",callback:function(){f.popView();}});}else{Ext.device.Notification.show({title:"Scan And Win!",message:"You haved won "+((d.length>1)?"some PRIZES":"a PRIZE")+"!",callback:function(){var j=f.getApplication();var g=j.getController("Prizes");var h=f.getViewport();h.setEnableAnim(false);h.getNavigationBar().setCallbackFn(function(){h.setEnableAnim(true);h.getNavigationBar().setCallbackFn(Ext.emptyFn);j.dispatch({action:"onShowPrize",args:[d[0]],controller:g,scope:g});});f.popView();}});}Ext.device.Notification.vibrate();}},earnPts:function(){var h=this;var b=Ext.StoreMgr.get("MerchantPrizeStore");var a=Ext.StoreMgr.get("RewardsCartStore");var f=h.getViewPortCntlr();var g=f.getCheckinInfo().venue;var c=f.getVenue();var d=c.getId();var j=c.getMerchant().getId();var e=CustomerReward.getProxy().getReader();h.getGeoLocation(function(k){var l=[];Ext.Array.forEach(a.getRange(),function(o,m,n){var p=o.get(PurchaseReward.getIdProperty());l.push({quantity:o.get("qty"),id:p});},h);EarnPrize.setEarnPrizeURL();e.setRootProperty("");e.buildExtractors();b.loadPage(1,{jsonData:{},params:{venue_id:d,merchant_id:j,reward_ids:JSON.stringify(l),latitude:k.coords.latitude,longitude:k.coords.longitude},callback:function(){e.setRootProperty("data");e.buildExtractors();}});});},onRewardsActivate:function(h,f,b,d){var a=this.getRewardsContainer();if(a){var g=a.getActiveItem();var e=a.getLayout().getAnimation();e.disable();switch(g.config.tag){case"rewardTallyList":case"prizeCheck":this.onRewardsShopCartTap(null,null,null);break;default:break;}e.enable();}this.showNavBar();},onRewardsDeactivate:function(e,d,a,b){},onRewardsShopCartTap:function(a,h,d){var g=this.getEarnPtsBtn();var c=this.getRewardsContainer();var j=c.getActiveItem();var f=Ext.StoreMgr.get("RewardsCartStore");g.updateActive(false);switch(j.config.tag){case"rewardMainList":c.setActiveItem(1);break;case"prizeCheck":case"rewardTallyList":if(!this.getDoneBtn().isHidden()){this.onRewardsCartDoneTap(this.getDoneBtn(),h,d);}c.setActiveItem(0);break;}return true;},onRewardsContainerActivate:function(j,h,b,d){var e=this;var g=e.getEarnPtsBtn();var a=e.getRewardsContainer();var f=a.getLayout().getAnimation();switch(h.config.tag){case"rewardTallyList":e.getDoneBtn().hide();e.getEditBtn().show();e.getBackButton().hide();g.setTitle("Order Menu");f.setReverse(false);e.showNavBar();break;case"rewardMainList":e.getDoneBtn().hide();e.getEditBtn().hide();e.getBackButton().show();g.setTitle("Check Out");f.setReverse(true);e.showNavBar();break;case"prizeCheck":e.getDoneBtn().hide();e.getEditBtn().hide();e.getBackButton().hide();e.getNavigationBarBottom().hide();break;}},onRedeemMetaChange:function(c,b){var e=this;var a=e.getViewPortCntlr();var d=Ext.StoreMgr.get("CustomerStore");var f=a.getCustomer().getId();d.getById(f).set("points",b.account_points);},onRewardMetaChange:function(c,b){var f=this;var a=f.getViewPortCntlr();var d=Ext.StoreMgr.get("CustomerStore");var g=a.getCustomer().getId();var e=function(){Ext.device.Notification.show({title:"VIP Challenge Alert!",message:f.getVipMsg(b.vip_challenge),callback:function(){Ext.defer(function(){f.prizeCheck(c);},2000);}});};if(b.points){Ext.device.Notification.show({title:"Earn Points",message:f.getPointsMsg(b.points)+((!b.vip_challenge)?((!Genesis.constants.isNative())?"<br/>":"\n")+f.getPrizeCheckMsg():""),callback:function(){if((b.vip_challenge)){e();}else{Ext.defer(function(){f.prizeCheck(c);},2000);}}});}else{if(b.vip_challenge){e();}}d.getById(g).set("points",b.account_points);},onRewardsEarnPtsTap:function(a,h,d){var f=this;var c=f.getRewardsContainer();var g=c.getLayout().getAnimation();f.scanQRCode({callback:function(b){if(b){g.disable();c.setActiveItem(2);g.enable();console.debug("response - "+b);f.earnPts();}else{console.debug("response - NONE");Ext.device.Notification.show({title:"Error",message:"Error Processing Your Earned Points"});}}});},onRewardsItemSelect:function(g,b,f){if(!this.exploreMode){var a=this.getRewardsCart();var d=a.getStore();var e=d.indexOf(b);var c;if(e<0){b.getData().qty=1;d.add(b);}else{b.set("qty",b.get("qty")+1);a.getViewItems()[e].updateRecord(b);}this.updateRewardsCartTotal(d.getRange());this.getNavigationBarBottom().show();}else{Ext.device.Notification.show({title:"Warning",message:"You need to Check-In first before you are elibigle for Rewards"});}g.deselect([b]);return false;},onRewardsCartEditTapCommon:function(d,c){this.getDoneBtn()[c[0]]();this.getEditBtn()[c[1]]();d.hide();var e=Ext.ComponentQuery.query("rewardscartitem button[tag=deleteItem]");var f=Ext.ComponentQuery.query("rewardscartitem component[cls=points]");Ext.each(e,function(b){b[c[0]]();});Ext.each(f,function(b){b[c[1]]();});var a=this.getRewardsTallyList();Ext.each(a.getItems().items,function(b){if(!b.getXTypes().match("dataview")){b[c[1]]();}});},onRewardsCartEditTap:function(a,d,c){this.onRewardsCartEditTapCommon(a,["show","hide"]);},onRewardsCartDoneTap:function(a,d,c){var f=this.getRewards();if(f.isPainted()&&!f.isHidden()){this.onRewardsCartEditTapCommon(a,["hide","show"]);}},onRewardsCartItemDeleteTap:function(j,f,g){var h=this;var l=j.up("rewardscartitem");var c=h.getRewardsCart();var d=c.getViewItems().indexOf(l);var k=c.getStore();var a=k.getAt(d);l.onAfter({hiddenchange:function(){k.remove(a);var e=h.updateRewardsCartTotal(k.getRange());if(e==0){var b=h.getNavigationBarBottom();b.onAfter({hiddenchange:function(){h.onRewardsShopCartTap(j,f,g);},single:true});b.hide();}},single:true});l.hide();},onRewardsCartItemSelectChange:function(g,h,c,d){var e=g.up("rewardscartitem");var j=this.getRewardsCart();var b=j.getViewItems().indexOf(e);var a=j.getStore().getAt(b);a.set("qty",h.get(g.getValueField()));e.updateRecord(a);this.updateRewardsCartTotal(j.getStore().getRange());return true;},onCheckInTap:function(a,d,c){this.clearRewardsCart();},onRedemptionsActivate:function(){},onRedemptionsDeactivate:function(){},onRedemptionsItemListSelect:function(c,a,b){c.deselect([a]);this.onRedemptionsItemListDisclose(c,a);return false;},onRedemptionsItemListDisclose:function(h,c,f,d,g,j){var l=this;var k=l.getViewPortCntlr();h.deselect([c]);if(!l.exploreMode){var a=l.getApplication();var b=a.getController("Prizes");a.dispatch({action:"onRedeemRewards",args:[Ext.create("Genesis.model.EarnPrize",{id:1,expiry_date:null,reward:c,merchant:k.getCheckinInfo().venue.getMerchant()})],controller:b,scope:b});}else{Ext.device.Notification.show({title:"Warning",message:"You need to Check-In first before you are elibigle for Redemptions"});}return true;},getMainPage:function(){return this.getRewards();},openPage:function(l){var f,k,h,d,j;var g=this;var e=g.getViewPortCntlr();var c=e.getCheckinInfo().venue;var b=e.getVenue();var a=b.getId();var m=b.getMerchant().getId();Ext.Viewport.setMasked({xtype:"loadmask",message:"Loading ..."});switch(l){case"rewards":f=g.getRewards();d=g.getRewardsList();k=Ext.StoreMgr.get("RewardsStore");h=d.getStore();j=d.getScrollable();PurchaseReward.setGetRewardsURL();break;case"redemptions":f=g.getRedemptions();d=g.getRedemptionsList();k=Ext.StoreMgr.get("RedemptionsStore");h=d.getStore();j=f.getScrollable();CustomerReward.setGetRedemptionsURL();break;}k.clearFilter();k.load({jsonData:{},params:{venue_id:a,merchant_id:m},scope:g,callback:function(o,n){Ext.Viewport.setMasked(false);if(n.wasSuccessful()){g.exploreMode=c&&(c.getId()!=b.getId());switch(l){case"redemptions":g.getRedemptionsPtsEarnPanel().getStore().setData(e.getCustomer());break;default:break;}j.getScroller().scrollTo(0,0);for(var p=0;p<o.length;p++){o[p].data.venue_id=a;}k.filter([{filterFn:function(q){return q.get("venue_id")==a;}}]);h.setData(k.getRange());g.pushView(f);}}});},isOpenAllowed:function(){return((this.getViewPortCntlr().getVenue())?true:"You need to Explore or Check-in to a Venue first");}});Ext.define("Genesis.controller.Accounts",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store"],statics:{accounts_path:"/accounts"},xtype:"accountsCntlr",config:{refs:{accounts:{selector:"accountsview",autoCreate:true,xtype:"accountsview"},accountsList:"accountsview list[tag=accountsList]"},control:{accounts:{activate:"onActivate",deactivate:"onDeactivate"},accountsList:{select:"onSelect",disclose:"onDisclose"}}},models:["Venue"],init:function(){this.callParent(arguments);console.log("Accounts Init");},onActivate:function(){this.getAccountsList().getScrollable().getScroller().scrollTo(0,0);},onDeactivate:function(){},onSelect:function(c,a,b){c.deselect([a]);this.onDisclose(c,a);return false;},onDisclose:function(l,d,j,g,k,m){var n=this;var b=n.getApplication();var c=b.getController("Checkins");var f=Ext.StoreMgr.get("CheckinExploreStore");var a=Ext.StoreMgr.get("CustomerStore");var o=d.getMerchant().getId();var h=n.getViewPortCntlr();n.getGeoLocation(function(e){Venue.setGetClosestVenueURL();f.load({scope:n,params:{merchant_id:o,latitude:e.coords.latitude,longitude:e.coords.longitude},callback:function(q,p){if(p.wasSuccessful()){for(var r=0;r<q.length;r++){h.setVenue(q[r]);b.dispatch({action:"onCheckinHandler",args:["explore",f.getProxy().getReader().metaData,a,null,[d],p],controller:c,scope:c});break;}}else{Ext.device.Notification.show({title:"Error",message:"Error Loading Venue information"});}},});});},getMainPage:function(){return this.getAccounts();},openMainPage:function(){this.pushView(this.getMainPage());console.log("Accounts Page Opened");},isOpenAllowed:function(){return true;}});Ext.define("Genesis.controller.Prizes",{extend:"Genesis.controller.ControllerBase",requires:["Ext.data.Store","Ext.util.Sorter"],statics:{prizes_path:"/prizes"},xtype:"prizesCntlr",config:{timeoutPeriod:10,mode:"prizes",models:["Venue","Merchant","EarnPrize","CustomerReward"],refs:{closeBackButton:"viewportview button[text=Close]",backButton:"viewportview button[ui=back]",doneBtn:"viewportview button[tag=done]",redeemBtn:"viewportview button[tag=redeem]",prizes:{selector:"prizesview",autoCreate:true,xtype:"prizesview"},prizesCarousel:"prizesview carousel"},control:{doneBtn:{tap:"onDoneTap"},redeemBtn:{tap:"onRedeemPrizeTap"},prizes:{activate:"onActivate",deactivate:"onDeactivate"},prizesCarousel:{activeitemchange:"onPrizeCarouselItemChange"}}},init:function(){this.callParent(arguments);console.log("Prizes Init");},onActivate:function(e,j,n,f){var k=this;var l=k.getPrizes();var g=k.getViewPortCntlr();var h,a;l.removeAll();switch(k.getMode()){case"prizes":h=Ext.StoreMgr.get("MerchantPrizeStore").getRange();if(h.length>0){l.add({xtype:"carousel",scrollable:false});a=l.getItems().items[0];}else{a=l;}break;case"reward":case"showPrize":h=[k.showPrize];delete k.showPrize;a=l;break;}var m=(g.getVenue())?g.getVenue().getMerchant().getId():0;for(var d=0;d<h.length;d++){if(n){var b=n.getXTypes();if(b.match("merchantaccountview")||b.match("rewardsview")){if(h[d].getMerchant().getId()!=m){continue;}}}a.add({tag:"rewardPanel",xtype:"dataview",store:{model:"Genesis.model.EarnPrize",autoLoad:false,data:h[d]},useComponents:true,scrollable:false,defaultType:"rewarditem",defaultUnit:"em",margin:"0 0 0.8 0"});}if(h.length==0){a.add({tag:"rewardPanel",xtype:"dataview",emptyText:" ",scrollable:false,defaultUnit:"em",margin:"0 0 0.8 0"});k.getRedeemBtn().hide();}else{k.getRedeemBtn().show();}},onDeactivate:function(a,f,e,b){var d=this;d.getDoneBtn().hide();d.getRedeemBtn().hide();},onDoneTap:function(h,d,f){var c=this.getPrizes();if(c.isPainted()&&!c.isHidden()){var g=this;var j=Ext.StoreMgr.get("MerchantPrizeStore");clearTimeout(g.cancelId);delete g.cancelId;switch(g.getMode()){case"prizes":case"showPrize":var l=c.query("carousel")[0];var a=l||c;var k=l?a.getActiveItem():a.getItems().items[0];a.remove(k,true);j.remove(k);break;case"reward":break;}g.getDoneBtn().hide();g.getRedeemBtn().hide();Ext.device.Notification.vibrate();g.popView();}},onPrizeCarouselItemChange:function(j,f,b,d){var e=(f.getStore())?f.getStore().getData().get(0):null;var g=(e)?e.getMerchant().getId():0;var a=this.getViewPortCntlr().getCheckinInfo().venue;var h=(a)?a.getMerchant().getId():0;this.getRedeemBtn()[((g==h)&&(g>0))?"enable":"disable"]();},onRedeemPrizeTap:function(m,g,h){var k=this;var l=k.getPrizes();var j=k.getViewPortCntlr();var d=j.getVenue();var f=d.getId();var o=d.getMerchant().getId();var c=k.getCloseBackButton()||k.getBackButton();c.hide();var n;var q=prizes.query("carousel")[0];var p=q?q.getActiveItem():l.getItems().items[0];var a=p.getStore().first().getId();switch(k.getMode()){case"showPrize":case"prizes":n=Ext.StoreMgr.get("MerchantPrizeStore");EarnPrize.setRedeemPrizeURL(a);break;case"reward":n=Ext.StoreMgr.get("RedemptionsStore");CustomerReward.setRedeemPointsURL(a);break;}n.load({addRecords:true,scope:k,jsonData:{},params:{venue_id:f,merchant_id:o},callback:function(e,b){if(b.wasSuccessful()){k.notificationPopup(k.getTimeoutPeriod());k.getRedeemBtn().hide();k.getDoneBtn().show();}}});},notificationPopup:function(b){var a=this;var c;switch(a.getMode()){case"showPrize":case"prizes":c="Prize Redemption Alert!";break;case"reward":c="Reward Redemption Alert!";break;}if(b>0){Ext.device.Notification.show({title:c,message:"You have "+b+" minute(s) to show this screen to a employee before it disappears!"});a.cancelId=Ext.defer(function(d){a.notificationPopup(d);},1*60*1000,a,[--b]);}else{Ext.device.Notification.show({title:"Prize Redemption Alert!",message:a.getTimeoutPeriod()+" minutes are up! Press OK to confirm.",buttons:["OK"],callback:function(){a.onDoneTap();}});}},onRedeemRewards:function(a){this.showPrize=a;this.setMode("reward");this.pushView(this.getMainPage());},onShowPrize:function(a){this.showPrize=a;this.setMode("showPrize");this.pushView(this.getMainPage());},getMainPage:function(){return this.getPrizes();},openMainPage:function(){this.setMode("prizes");this.pushView(this.getMainPage());console.log("Prizes Page Opened");},isOpenAllowed:function(){return true;}});