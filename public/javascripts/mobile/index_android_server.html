<html>
   <head>
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
      <meta name="apple-mobile-web-app-capable" content="yes" />
      <meta name="apple-touch-fullscreen" content="yes" />
      <meta name="format-detection" content="telephone=no" />
      <meta name="format-detection" content="email=no" />
      <!-- Default Fontsize = 11px
      iPad @132dpi = 100% - iPhone @163dpi = 114% - iPhone Retina @326dpi = 228%
      -->
      <!-- iPad/iPhone specific css below, add after your main css >
      <link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="ipad.css" type="text/css" />
      <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="iphone.css" type="text/css" />
      -->
      <!--
      <link rel="apple-touch-icon-precomposed" href="resouces/img/icon_57.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="resources/img/icon_72.png"/>
      <link rel="apple-touch-icon-precomposed" sizes="114x114" href="resources/img/icon_114.png"/>
      <link rel="apple-touch-startup-image" media="screen and (resolution: 326dpi)" href="resources/themes/images/v1/startup_640.png"
      />
      <link rel="apple-touch-startup-image" media="screen and (resolution: 163dpi)" href="resources/themes/images/v1/startup_640.png"
      />
      -->
      <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <title>MerKickBak</title>
      <link rel="stylesheet" type="text/css" media="only screen and (max-width:270px) and (-webkit-max-device-pixel-ratio: .75)" href="resources/css/android-phone-lhdpi.css">
      <link rel="stylesheet" type="text/css" media="only screen and (max-width:640px) and (-webkit-max-device-pixel-ratio: 1.0)" href="resources/css/android-phone-mxhdpi.css">
      <link rel="stylesheet" type="text/css" media="only screen and (max-width:540px) and (-webkit-max-device-pixel-ratio: 1.5)" href="resources/css/android-phone-lhdpi.css">
      <link rel="stylesheet" type="text/css" media="only screen and (max-width:1280px) and (-webkit-min-device-pixel-ratio: 2.0)" href="resources/css/android-phone-mxhdpi.css">
      
      <link rel="stylesheet" type="text/css" media="only screen and (min-width:271px) and (-webkit-max-device-pixel-ratio: .75)" href="resources/css/android-tablet-lhdpi.css">
      <link rel="stylesheet" type="text/css" media="only screen and (min-width:641px) and (-webkit-max-device-pixel-ratio: 1.0)" href="resources/css/android-tablet-mxhdpi.css">
      <link rel="stylesheet" type="text/css" media="only screen and (min-width:541px) and (-webkit-max-device-pixel-ratio: 1.5)" href="resources/css/android-tablet-lhdpi.css">
      <link rel="stylesheet" type="text/css" media="only screen and (min-width:1281px) and (-webkit-min-device-pixel-ratio: 2.0)" href="resources/css/android-tablet-mxhdpi.css">
      <!-- If your application is targeting iOS BEFORE 4.0 you MUST put json2.js from http://www.JSON.org/json2.js into your www
      <script src="http://192.168.0.52:8080/target/target-script-min.js#client"></script> 
      directory and include it here -->
      
      
      <script type="text/javascript" src="lib/gibberish-aes.min.js"></script>
      <script type="text/javascript" src="lib/cordova-2.2.0.android.js"></script>
      <script type="text/javascript" charset="utf-8" src="lib/core/phonegap-nfc.js"></script>

      <script type="text/javascript" src="lib/sencha-touch-all.js"></script>
      <!--
      Phone Gap Libs
      -->
      <script type="text/javascript">
         var launched = 0x00;
         var backBtnCallbackListFn = [];

         var offlineDialogShown = false;
         var phoneGapAvailable = true;
         var debugMode = false;
         var merchantMode = true;
         var appName = 'MerKickBak';

         var _appPath = "app", _extPath = 'lib/sencha-touch-2.1.0-commercial/src';

         function _appLaunch()
         {
            if (launched == 0x11)
            {
               var viewport = _application.getController('server.Viewport');
               viewport.appName = appName;

               Ext.create('Genesis.view.Viewport');
               console.log("Launched App");
               navigator.splashscreen.hide();               
            }
         }
      </script>
      <script type="text/javascript">
         // If you want to prevent dragging, uncomment this section
         /*
          function preventBehavior(e)
          {
          e.preventDefault();
          };
          document.addEventListener("touchmove", preventBehavior, false);
          */

         /* If you are supporting your own protocol, the var invokeString will contain any arguments to the app launch.
          see http://iphonedevelopertips.com/cocoa/launching-your-own-application-via-a-custom-url-scheme.html
          for more details -jm */
         /*
          function handleOpenURL(url)
          {
          // TODO: do something with the url passed in.
          }
          */
         /* When this function is called, PhoneGap has been initialized and is ready to roll */
         /* If you are supporting your own protocol, the var invokeString will contain any arguments to the app launch.
          see http://iphonedevelopertips.com/cocoa/launching-your-own-application-via-a-custom-url-scheme.html
          for more details -jm */
         function onBodyLoad()
         {
            document.addEventListener("online", function()
            {
               if (Ext.device)
               {
                  console.log("Phone is Online"+ ", " + //
                  Ext.device.Connection.__proto__.$className + ", " + //
                  "devicePixelRatio - " + window.devicePixelRatio + ", " + //
                  'Connection type: [' + Ext.device.Connection.getType() + ']');
               }
               //Genesis.db.redeemDBCleanup();
            }, false);

            document.addEventListener("offline", function()
            {
               if (Ext.device)
               {
                  console.log("Phone is Offline");
               }
            }, false);
            document.addEventListener("pause", function()
            {
               //Genesis.db.redeemDBSync();
               console.log("App is Paused");
            }, false);

            document.addEventListener("resume", function()
            {
               if (Ext.device)
               {
                  //Genesis.db.redeemDBCleanup();
               }
               console.log("App is Resumed");
            }, false);
            window.addEventListener("batterylow", function(info)
            {
               if (Ext.device)
               {
                  Ext.device.Notification.show(
                  {
                     title : 'Battery Level Low',
                     messsage : 'Battery is at ' + info.level + '%'
                  });
                  Ext.device.Notification.vibrate();

               }
               Genesis.db.redeemDBSync();
            }, false);
            window.addEventListener("batterycritical", function(info)
            {
               if (Ext.device)
               {
                  Ext.device.Notification.show(
                  {
                     title : 'Battery Level Critical',
                     messsage : 'Battery is at ' + info.level + '%' + '\n' + //
                     'Recharge Soon!'
                  });
                  Ext.device.Notification.vibrate();
                  Ext.device.Notification.beep();
               }
               Genesis.db.redeemDBSync();
            }, false);

            document.addEventListener("deviceready", function()
            {
               navigator.splashscreen.show();
               console.debug = console.debug || console.log;
               console.warn = console.warn || console.debug;

               console.log("PhoneGap App Launch");
               launched = 0x10;
               _appLaunch();
            }, false);

            // add back button listener
            function onBackKeyDown(e)
            {
               //e.preventDefault();

               //
               // Disable BackKey if something is in progress or application is not instantiated
               //
               if (!_application || Ext.Viewport.getMasked())
               {
                  return;
               }

               var viewport = _application.getController('server.Viewport');

               if (!viewport || viewport.popViewInProgress)
               {
                  return;
               }

               console.log("BackButton Pressed");
               var vport = viewport.getViewport();
               var activeItem = (vport) ? vport.getActiveItem() : null;
               if (activeItem)
               {
                  var success = false;
                  for (var i = 0; i < backBtnCallbackListFn.length; i++)
                  {
                     success = backBtnCallbackListFn[i](activeItem);
                     if (success)
                     {
                        break;
                     }
                  }
                  if (!success)
                  {
                     var backButton = activeItem.query('button[tag=back]')[0];
                     var closeButton = activeItem.query('button[tag=close]')[0];
                     if ((backButton && !backButton.isHidden()) || //
                     (closeButton && !closeButton.isHidden()))
                     {
                        Genesis.controller.ControllerBase.playSoundFile(viewport.sound_files['clickSound']);
                        viewport.popView();
                     }
                  }
               }
               else
               {
                  Genesis.controller.ControllerBase.playSoundFile(viewport.sound_files['clickSound']);
                  navigator.app.exitApp();
               }
            }
            
            Ext.Loader.setConfig(
            {
               enabled : false,
               paths :
               {
                  Ext : _extPath,
                  Genesis : _appPath,
                  "Ext.ux" : _appPath
               }
            });

            Ext.application(
            {
               profiles : ['Android'],
               views : ['Document', 'server.Rewards', 'server.Redemptions', 'server.MerchantAccount', 'MainPage', 'ShowRedeemItemDetail', 'server.SettingsPage', 'Viewport'],
               controllers : ['server.Viewport', 'server.MainPage', 'server.Challenges', 'server.Rewards', 'server.Redemptions', 'server.Merchants', 'Settings', 'server.Prizes'],
               launch : function()
               {
                  _application = this;
                  if (launched > 0x00)
                  {
                     launched |= 0x01;
                  }
                  else
                  {
                     launched = 0x01;
                  }
                  console.log("Ext App Launch");
                  document.addEventListener("backbutton", onBackKeyDown, false);
                  _appLaunch();
               },
               appFolder : _appPath,
               name : 'Genesis'
            });
         }
      </script>
      <script type="text/javascript" src="core.js"></script>
      <script type="text/javascript" src="app/profile/Android.js"></script>
      <script type="text/javascript" src="server-all.js"></script>
   </head>
   <body onload="onBodyLoad()">
      <script type="text/javascript">
         window.onerror = function(e, url, linenum)
         {
            console.log("Error on Line#" + linenum + "\n" + e);
         }
      </script>
      <!-- Cache images -->
      <div class="serverPhotoCache"></div>
      <!-- -->
   </body>
</html>
