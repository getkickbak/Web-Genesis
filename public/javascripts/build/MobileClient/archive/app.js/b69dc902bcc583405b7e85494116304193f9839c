/*b69dc902bcc583405b7e85494116304193f9839c*/Ext.setVersion("touch","2.1.1");Ext.apply(Ext,{version:Ext.getVersion("touch"),idSeed:0,repaint:function(){var a=Ext.getBody().createChild({cls:Ext.baseCSSPrefix+"mask "+Ext.baseCSSPrefix+"mask-transparent"});setTimeout(function(){a.destroy()},0)},id:function(a,b){if(a&&a.id){return a.id}a=Ext.getDom(a)||{};if(a===document||a===document.documentElement){a.id="ext-application"}else{if(a===document.body){a.id="ext-viewport"}else{if(a===window){a.id="ext-window"}}}a.id=a.id||((b||"ext-element-")+(++Ext.idSeed));return a.id},getBody:function(){if(!Ext.documentBodyElement){if(!document.body){throw new Error("[Ext.getBody] document.body does not exist at this point")}Ext.documentBodyElement=Ext.get(document.body)}return Ext.documentBodyElement},getHead:function(){if(!Ext.documentHeadElement){Ext.documentHeadElement=Ext.get(document.head||document.getElementsByTagName("head")[0])}return Ext.documentHeadElement},getDoc:function(){if(!Ext.documentElement){Ext.documentElement=Ext.get(document)}return Ext.documentElement},getCmp:function(a){return Ext.ComponentMgr.get(a)},copyTo:function(a,b,d,c){if(typeof d=="string"){d=d.split(/[,;\s]/)}Ext.each(d,function(e){if(c||b.hasOwnProperty(e)){a[e]=b[e]}},this);return a},destroy:function(){var a=arguments,d=a.length,b,c;for(b=0;b<d;b++){c=a[b];if(c){if(Ext.isArray(c)){this.destroy.apply(this,c)}else{if(Ext.isFunction(c.destroy)){c.destroy()}}}}},getDom:function(a){if(!a||!document){return null}return a.dom?a.dom:(typeof a=="string"?document.getElementById(a):a)},removeNode:function(a){if(a&&a.parentNode&&a.tagName!="BODY"){Ext.get(a).clearListeners();a.parentNode.removeChild(a);delete Ext.cache[a.id]}},defaultSetupConfig:{eventPublishers:{dom:{xclass:"Ext.event.publisher.Dom"},touchGesture:{xclass:"Ext.event.publisher.TouchGesture",recognizers:{drag:{xclass:"Ext.event.recognizer.Drag"},tap:{xclass:"Ext.event.recognizer.Tap"},doubleTap:{xclass:"Ext.event.recognizer.DoubleTap"},longPress:{xclass:"Ext.event.recognizer.LongPress"},swipe:{xclass:"Ext.event.recognizer.HorizontalSwipe"},pinch:{xclass:"Ext.event.recognizer.Pinch"},rotate:{xclass:"Ext.event.recognizer.Rotate"}}},componentDelegation:{xclass:"Ext.event.publisher.ComponentDelegation"},componentPaint:{xclass:"Ext.event.publisher.ComponentPaint"},elementPaint:{xclass:"Ext.event.publisher.ElementPaint"},elementSize:{xclass:"Ext.event.publisher.ElementSize"}},animator:{xclass:"Ext.fx.Runner"},viewport:{xclass:"Ext.viewport.Viewport"}},isSetup:false,frameStartTime:+new Date(),setupListeners:[],onSetup:function(b,a){if(Ext.isSetup){b.call(a)}else{Ext.setupListeners.push({fn:b,scope:a})}},setup:function(s){var k=Ext.defaultSetupConfig,m=Ext.emptyFn,b=s.onReady||m,f=s.onUpdated||m,a=s.scope,d=Ext.Array.from(s.requires),l=Ext.onReady,h=Ext.getHead(),g,q,i;Ext.setup=function(){throw new Error("Ext.setup has already been called before")};delete s.requires;delete s.onReady;delete s.onUpdated;delete s.scope;Ext.require(["Ext.event.Dispatcher"]);g=function(){var v=Ext.setupListeners,w=v.length,u,x;delete Ext.setupListeners;Ext.isSetup=true;for(u=0;u<w;u++){x=v[u];x.fn.call(x.scope)}Ext.onReady=l;Ext.onReady(b,a)};Ext.onUpdated=f;Ext.onReady=function(w,v){var u=b;b=function(){u();Ext.onReady(w,v)}};s=Ext.merge({},k,s);Ext.onDocumentReady(function(){Ext.factoryConfig(s,function(u){Ext.event.Dispatcher.getInstance().setPublishers(u.eventPublishers);if(u.logger){Ext.Logger=u.logger}if(u.animator){Ext.Animator=u.animator}if(u.viewport){Ext.Viewport=q=u.viewport;if(!a){a=q}Ext.require(d,function(){Ext.Viewport.on("ready",g,null,{single:true})})}else{Ext.require(d,g)}})});function j(u,v){var w=document.createElement("meta");w.setAttribute("name",u);w.setAttribute("content",v);h.append(w)}function n(u,w,x){var v=document.createElement("link");v.setAttribute("rel","apple-touch-icon"+(x?"-precomposed":""));v.setAttribute("href",u);if(w){v.setAttribute("sizes",w)}h.append(v)}function e(u,w){var v=document.createElement("link");v.setAttribute("rel","apple-touch-startup-image");v.setAttribute("href",u);if(w){v.setAttribute("media",w)}h.append(v)}var p=s.icon,t=Boolean(s.isIconPrecomposed),r=s.startupImage||{},c=s.statusBarStyle,o=window.devicePixelRatio||1;if(navigator.standalone){j("viewport","width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0")}else{j("viewport","initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0")}j("apple-mobile-web-app-capable","yes");j("apple-touch-fullscreen","yes");if(c){j("apple-mobile-web-app-status-bar-style",c)}if(Ext.isString(p)){p={57:p,72:p,114:p,144:p}}else{if(!p){p={}}}if(Ext.os.is.iPad){if(o>=2){if("1496x2048" in r){e(r["1496x2048"],"(orientation: landscape)")}if("1536x2008" in r){e(r["1536x2008"],"(orientation: portrait)")}if("144" in p){n(p["144"],"144x144",t)}}else{if("748x1024" in r){e(r["748x1024"],"(orientation: landscape)")}if("768x1004" in r){e(r["768x1004"],"(orientation: portrait)")}if("72" in p){n(p["72"],"72x72",t)}}}else{if(o>=2&&Ext.os.version.gtEq("4.3")){if(Ext.os.is.iPhone5){e(r["640x1096"])}else{e(r["640x920"])}if("114" in p){n(p["114"],"114x114",t)}}else{e(r["320x460"]);if("57" in p){n(p["57"],null,t)}}}},application:function(b){var a=b.name,e,d,c;if(!b){b={}}if(!Ext.Loader.config.paths[a]){Ext.Loader.setPath(a,b.appFolder||"app")}c=Ext.Array.from(b.requires);b.requires=["Ext.app.Application"];e=b.onReady;d=b.scope;b.onReady=function(){b.requires=c;new Ext.app.Application(b);if(e){e.call(d)}};Ext.setup(b)},factoryConfig:function(a,l){var g=Ext.isSimpleObject(a);if(g&&a.xclass){var f=a.xclass;delete a.xclass;Ext.require(f,function(){Ext.factoryConfig(a,function(i){l(Ext.create(f,i))})});return}var d=Ext.isArray(a),m=[],k,j,c,e;if(g||d){if(g){for(k in a){if(a.hasOwnProperty(k)){j=a[k];if(Ext.isSimpleObject(j)||Ext.isArray(j)){m.push(k)}}}}else{for(c=0,e=a.length;c<e;c++){j=a[c];if(Ext.isSimpleObject(j)||Ext.isArray(j)){m.push(c)}}}c=0;e=m.length;if(e===0){l(a);return}function h(i){a[k]=i;c++;b()}function b(){if(c>=e){l(a);return}k=m[c];j=a[k];Ext.factoryConfig(j,h)}b();return}l(a)},factory:function(b,e,a,f){var d=Ext.ClassManager,c;if(!b||b.isInstance){if(a&&a!==b){a.destroy()}return b}if(f){if(typeof b=="string"){return d.instantiateByAlias(f+"."+b)}else{if(Ext.isObject(b)&&"type" in b){return d.instantiateByAlias(f+"."+b.type,b)}}}if(b===true){return a||d.instantiate(e)}if("xtype" in b){c=d.instantiateByAlias("widget."+b.xtype,b)}else{if("xclass" in b){c=d.instantiate(b.xclass,b)}}if(c){if(a){a.destroy()}return c}if(a){return a.setConfig(b)}return d.instantiate(e,b)},deprecateClassMember:function(b,c,a,d){return this.deprecateProperty(b.prototype,c,a,d)},deprecateClassMembers:function(b,c){var d=b.prototype,e,a;for(e in c){if(c.hasOwnProperty(e)){a=c[e];this.deprecateProperty(d,e,a)}}},deprecateProperty:function(b,c,a,d){if(!d){d="'"+c+"' is deprecated"}if(a){d+=", please use '"+a+"' instead"}if(a){Ext.Object.defineProperty(b,c,{get:function(){return this[a]},set:function(e){this[a]=e},configurable:true})}},deprecatePropertyValue:function(b,a,d,c){Ext.Object.defineProperty(b,a,{get:function(){return d},configurable:true})},deprecateMethod:function(b,a,d,c){b[a]=function(){if(d){return d.apply(this,arguments)}}},deprecateClassMethod:function(a,b,h,d){if(typeof b!="string"){var g,f;for(g in b){if(b.hasOwnProperty(g)){f=b[g];Ext.deprecateClassMethod(a,g,f)}}return}var c=typeof h=="string",e;if(!d){d="'"+b+"()' is deprecated, please use '"+(c?h:h.name)+"()' instead"}if(c){e=function(){return this[h].apply(this,arguments)}}else{e=function(){return h.apply(this,arguments)}}if(b in a.prototype){Ext.Object.defineProperty(a.prototype,b,{value:null,writable:true,configurable:true})}a.addMember(b,e)},isReady:false,readyListeners:[],triggerReady:function(){var b=Ext.readyListeners,a,c,d;if(!Ext.isReady){Ext.isReady=true;for(a=0,c=b.length;a<c;a++){d=b[a];d.fn.call(d.scope)}delete Ext.readyListeners}},onDocumentReady:function(c,b){if(Ext.isReady){c.call(b)}else{var a=Ext.triggerReady;Ext.readyListeners.push({fn:c,scope:b});if(Ext.browser.is.PhoneGap&&!Ext.os.is.Desktop){if(!Ext.readyListenerAttached){Ext.readyListenerAttached=true;document.addEventListener("deviceready",a,false)}}else{if(document.readyState.match(/interactive|complete|loaded/)!==null){a()}else{if(!Ext.readyListenerAttached){Ext.readyListenerAttached=true;window.addEventListener("DOMContentLoaded",a,false)}}}}},callback:function(d,c,b,a){if(Ext.isFunction(d)){b=b||[];c=c||window;if(a){Ext.defer(d,a,c,b)}else{d.apply(c,b)}}}});Ext.define("Genesis.model.Checkin",{extend:Ext.data.Model,alternateClassName:"Checkin",id:"Checkin",config:{identifier:"uuid",belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"},{model:"Genesis.model.Venue",getterName:"getVenue",setterName:"setVenue"}],fields:["id","time"]}});Ext.define("Genesis.model.Merchant",{extend:Ext.data.Model,alternateClassName:"Merchant",id:"Merchant",config:{fields:["id","name","email","photo","alt_photo","account_first_name","account_last_name","phone","auth_code","qr_code","features_config","payment_account_id","created_ts","update_ts","type","reward_terms"],idProperty:"id"}});Ext.define("Genesis.model.CustomerJSON",{extend:Ext.data.Model,alternateClassName:"CustomerJSON",id:"CustomerJSON",config:{proxy:{type:"localstorage",id:"CustomerJSON",writer:{type:"json"},reader:{type:"json"}},identifier:"uuid",fields:["json","id"],idProperty:"id"}});Ext.define("Genesis.model.Customer",{extend:Ext.data.Model,alternateClassName:"Customer",id:"Customer",config:{belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",name:"merchant",setterName:"setMerchant",getterName:"getMerchant"},{model:"Genesis.model.User",associationKey:"user",name:"user",getterName:"getUser",setterName:"setUser"}],hasOne:[{model:"Genesis.model.Checkin",associationKey:"last_check_in",name:"last_check_in",getterName:"getLastCheckin",setterName:"setLastCheckin"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"},listeners:{metachange:function(d,b,c){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");a.fireEvent("updatemetadata",b)}}},fields:["id","points","prize_points","visits","next_badge_visits","eligible_for_reward","eligible_for_prize","badge_id","next_badge_id"],idProperty:"id"},getUser:function(){},inheritableStatics:{isValid:function(a){return a!=0},updateCustomer:function(d,l){var f,k=false;d.beginEdit();for(var g=0;g<d.fields.length;g++){f=d.fields.items[g].getName();if(d.get(f)!=l.get(f)){d.set(f,l.get(f));k=true}}try{if(d.getLastCheckin()!=l.getLastCheckin()){d.setLastCheckin(l.getLastCheckin());k=true}}catch(h){d.setLastCheckin(Ext.create("Genesis.model.Checkin"));k=true}var b=d.getMerchant()||"";var j=l.getMerchant()||"";var a=b.toString();var c=j.toString();if((a!=c)&&(c!="")){d.handleInlineAssociationData({merchant:j.raw});k=true}d.endEdit();return k},setFbLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/tokens/create_from_facebook")},setLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/tokens")},setLogoutUrl:function(a){this.getProxy().setActionMethods({read:"DELETE"});this.getProxy().setUrl(serverHost+"/api/v1/tokens/"+a)},setCreateAccountUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/sign_up")},setGetCustomerUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/customers/show_account")},setGetCustomersUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/customers")},setVenueScanCheckinUrl:function(){this.setVenueCheckinUrl()},setVenueCheckinUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/check_ins")},setVenueExploreUrl:function(a){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/venues/"+a+"/explore")},setSendPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/customers/transfer_points")},setRecvPtsXferUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/customers/receive_points")}}});Ext.define("Genesis.controller.ControllerBase",{extend:Ext.app.Controller,config:{animationMode:null,models:["Customer"]},scanTaskWait:false,scanTask:null,establishConnectionMsg:"Connecting to Server ...",loginMsg:"Logging in ...",checkinMsg:"Checking in ...",loadingScannerMsg:"Loading Scanner ...",loadingMsg:"Loading ...",genQRCodeMsg:"Generating QRCode ...",missingLicenseKeyMsg:'License Key for this Device is missing. Press "Procced" to Scan the License Key into the device.',retrieveAuthModeMsg:"Retrieving Authorization Code from Server ...",noCodeScannedMsg:"No Authorization Code was Scanned!",lostNetworkConnectionMsg:"You have lost network connectivity",networkErrorMsg:"Error Connecting to Sever",noPeerDiscoveredMsg:"No Peers were discovered",noPeerIdFoundMsg:function(a){return("No ID Found! ErrorCode("+a+")")},notAtVenuePremise:"You must be inside the Merchant's premises to continue.",errorLoadingAccountProfileMsg:"Error Loading Account Profile",invalidTagIdFormatMsg:function(a){return"Invalid "+a+"-digit Tag ID format (eg. 12345678)"},invalidPhoneIdFormatMsg:function(a){return"Invalid "+a+"-digit Telephone format (eg. 8005551234)"},transactionCancelledMsg:"This transaction is cancelled",backToMerchantPageMsg:function(a){return("Would you like to visit our Main Page?")},geoLocationErrorMsg:function(){var a="This feature must require your GeoLocation to proceed.";if(Ext.os.is("Android")){a+='Enable Location Services under Main Screen of your phone: "Settings App >> Location Services >> GPS satellites"'}else{if(Ext.os.is("iOS")){a+=((Ext.os.version.isLessThan("6.0"))?'Enable Location Services under Main Screen of your phone: "Settings App >> Location Services >> KICKBAK"':'Enable Location Services under Main Screen of your phone: "Settings App >> Privacy >> Location Services >> KICKBAK"')}else{if(Ext.os.is("BlackBerry")){a+='Enable Location Services under Main Screen of your phone: "Settings App >> Site Permissions"'}else{a+='Enable Location Services under Main Screen of your phone: "Settings App >> Location Services"'}}}return a},geoLocationTimeoutErrorMsg:"Cannot locate your current location. Try again or enable permission to do so!",geoLocationPermissionErrorMsg:"No permission to locate current location. Please enable permission to do so!",geoLocationUnavailableMsg:"To better serve you, please turn on your Location Services",geoLocationUseLastPositionMsg:"We are not able to locate your current location. Using your last known GPS Coordinates ...",getMerchantInfoMsg:"Retrieving Merchant Information ...",getVenueInfoMsg:"Retrieving Venue Information ...",prepareToSendMerchantDeviceMsg:"Prepare to send data across to Merchant Device ...",mobilePhoneInputMsg:"Enter Mobile Number",lookingForMerchantDeviceMsg:function(){return"Tap your Phone against the "+Genesis.constants.addCRLF()+"Merchant Device"},detectMerchantDeviceMsg:function(){return"Tap your Phone against the "+Genesis.constants.addCRLF()+"Merchant Device"},prepareToSendMobileDeviceMsg:"Prepare to send data across to Mobile Device ...",lookingForMobileDeviceMsg:function(){return"Please Swipe TAG or"+Genesis.constants.addCRLF()+"Tap Mobile Device"},detectMobileDeviceMsg:function(){return"Please Swipe TAG or"+Genesis.constants.addCRLF()+"Tap Mobile Device"},missingVenueInfoMsg:function(b){var a="";if(Ext.isString(b)){a=Genesis.constants.addCRLF()+b}else{if(Ext.isObject(b)){a=Genesis.constants.addCRLF()+b.statusText}}return("Error loading Venue information."+a)},showToServerMsg:function(){return("Please confirm to Proceed")},errProcQRCodeMsg:"Error Processing Authentication Code",cameraAccessMsg:"Accessing your Camera Phone ...",updatingServerMsg:"Updating Server ...",referredByFriendsMsg:function(a){return"Have you been referred "+Genesis.constants.addCRLF()+"by a friend to visit"+Genesis.constants.addCRLF()+a+"?"},recvReferralb4VisitMsg:function(a){return"Claim your reward points by becoming a customer at "+Genesis.constants.addCRLF()+a+"!"},showScreenTimeoutExpireMsg:function(a){return a+" are up! Press OK to confirm."},showScreenTimeoutMsg:function(a){return"You have "+a+" to show this screen to a employee before it disappears!"},uploadFbMsg:"Uploading to Facebook ...",uploadServerMsg:"Uploading to server ...",inheritableStatics:{animationMode:{cover:{type:"cover",direction:"left",duration:400},coverUp:{type:"cover",direction:"up",duration:400},slide:{type:"slide",direction:"left",duration:400},slideUp:{type:"slide",direction:"up",duration:400},pop:{type:"pop",duration:400},flip:{type:"flip",duration:400},fade:{type:"fade",duration:400}},playSoundFile:function(b,a,c){if(Genesis.fn.isNative()){switch(b.type){case"FX":case"Audio":LowLatencyAudio.play(b.name,a||Ext.emptyFn,c||Ext.emptyFn);break;case"Media":b.successCallback=a||Ext.emptyFn;b.name.play();break}}else{if(merchantMode){b.successCallback=a||Ext.emptyFn;Ext.get(b.name).dom.play()}else{if(a){a()}}}},stopSoundFile:function(a){if(Genesis.fn.isNative()){switch(a.type){case"FX":case"Audio":LowLatencyAudio.stop(a.name);break;case"Media":a.name.stop();break}}else{}},encryptFromParams:function(g,f){GibberishAES.size(256);var b=null,d=Genesis.fn.getPrivKey("venueId"),a=null;if((d>0)||(d<0)){try{switch(f){case"prize":a=Genesis.fn.getPrivKey("p"+d);case"reward":a=Genesis.fn.getPrivKey("r"+d);break;default:a=Genesis.fn.getPrivKey("r"+d);break}b=(d>0)?d+"$":"";b+=GibberishAES.enc(Ext.encode(g),a)}catch(c){}}return b},genQRCodeFromParams:function(c,d,h){var i=this;var f;GibberishAES.size(256);var a=Genesis.fn.getPrivKey("venueId");var j="";switch(d){case"prize":j=Genesis.fn.getPrivKey("p"+a);break;case"reward":j=Genesis.fn.getPrivKey("r"+a);break;default:j=Genesis.fn.getPrivKey("r"+a);break}var b;if(a>0){try{b=new Date().addHours(3);f=GibberishAES.enc(Ext.encode(Ext.applyIf({expiry_ts:b.getTime()},c)),j);f=a+"$"+f;console.debug("Used key["+j+"]");console.debug("\nEncrypted Code Length: "+f.length+"\nEncrypted Code ["+f+"]\nExpiry Date: ["+b+"]")}catch(g){}return(h)?[f,0,0]:i.genQRCode(f)}Ext.device.Notification.show({title:"Missing License Key!",message:i.prototype.missingLicenseKeyMsg,buttons:["Proceed","Cancel"],callback:function(e){if(e.toLowerCase()=="proceed"){_application.getController("Settings").fireEvent("upgradeDevice")}}});return(h)?["",0,0]:""},genQRCode:function(e,c,f){c=c||3;f=f||10;var d=0;var b=QRCode(f,"L");b.addData(e);b.make();var a=b.createBase64(c,d);console.debug("QR Code Minimum Size = ["+a[1]+"x"+a[1]+"]");return[a[0],a[1],a[1]]},genQRCodeInlineImg:function(e,c,f){c=c||4;f=f||8;var d=0;var a=QRCode(f,"L");a.addData(e);a.make();var b=a.createTableTag(c,d);return b}},init:function(){this.callParent(arguments);this.on({scope:this,scannedqrcode:this.onScannedQRcode,locationupdate:this.onLocationUpdate,openpage:this.onOpenPage,updatemetadata:this.updateMetaDataInfo,triggerCallbacksChain:this.triggerCallbacksChain});var a=this.getViewPortCntlr();if(a!=this){a.relayEvents(this,["pushview","popview","silentpopview","resetview"]);a.on("animationCompleted",this.onAnimationCompleted,this)}},getViewPortCntlr:function(){return this.getApplication().getController(((merchantMode)?"server":"client")+".Viewport")},getViewport:function(){return this.getViewPortCntlr().getView()},getMainPage:Ext.emptyFn,openMainPage:Ext.emptyFn,openPage:Ext.emptyFn,goToMain:function(){var b=this;var a=b.getViewPortCntlr();if(a.setLoggedIn){a.setLoggedIn(true)}b.resetView();b.redirectTo("main");console.log("LoggedIn, Going to Main Page ...")},goToMerchantMain:function(d){var b=this;var a=b.getViewPortCntlr();var c=a.getCheckinInfo();var e=function(){b.resetView();if(c.venue){b.redirectTo("venue/"+c.venue.getId()+"/"+c.customer.getId()+"/1")}else{b.redirectTo("checkin")}};if(c.venue&&!d){Ext.device.Notification.show({title:c.venue.get("name").trunc(16),message:b.backToMerchantPageMsg(c.venue),buttons:["OK","Cancel"],callback:function(f){if(f.toLowerCase()=="ok"){e()}}})}else{e()}},isOpenAllowed:function(){return"Cannot Open Folder"},onBeforeNfc:function(g){var f=this,i=null,b=null;console.log("NDEF Message received");try{var j=g.tag,c=j.ndefMessage||[],b=nfc.bytesToHexString(j.id);var a=c[0].payload[0],h=c[0].payload.slice((1+a),c[0].payload.length);console.debug("NFC ndefID["+b+"] ndefMessage["+nfc.bytesToString(h)+"]");i={result:Ext.decode(nfc.bytesToString(h)),id:b};f.printNfcTag(g)}catch(d){console.log("Exception Thrown while processing NFC Tag["+d+"]")}return i},onNfc:Ext.emptyFn,onScannedQRcode:Ext.emptyFn,onLocationUpdate:Ext.emptyFn,onOpenPage:function(e,c,b,d,f){if((appName=="GetKickBak")&&!navigator.onLine&&(e!="MainPage")){var a=me.getViewPortCntlr();if(!offlineDialogShown){Ext.device.Notification.show({title:"Network Error",message:me.lostNetworkConnectionMsg,buttons:["Dismiss"],callback:function(){offlineDialogShown=false}});offlineDialogShown=true}console.debug("Network Error - "+e+","+c);me.resetView();me.redirectTo(a.getLoggedIn()?"checkin":"login");return}var g=this.getApplication();controller=g.getController(e);if(!c){controller.openMainPage()}else{controller.openPage(c,b)}},triggerCallbacksChain:function(){var c=this;var d=c.callBackStack.startIndex;var b=c.callBackStack.callbacks.length;for(var a=d;a<b;a++){c.callBackStack.startIndex++;if(c[c.callBackStack.callbacks[a]].apply(c,c.callBackStack["arguments"])){break}}if(a>=b){console.debug("Clear Callback Chain["+a+"].");c.callBackStack.startIndex=0;c.callBackStack["arguments"]=[]}},updateMetaDataInfo:function(b){var c=this,a=c.getViewPortCntlr();a.updateMetaDataInfo(b)},checkReferralPrompt:function(a,d){var g=this;var f=g.getViewPortCntlr();var e=f.getCustomer();var b=f.getVenue().getMerchant();var h=b.getId();var i=a||Ext.emptyFn;var c=d||Ext.emptyFn;if(Customer.isValid(e.getId())&&(e.get("visits")<2)&&(!Genesis.db.getReferralDBAttrib("m"+h))&&(_build!="MobileWebClient")){console.debug("Customer Visit Count["+e.get("visits")+"]");Ext.device.Notification.show({title:"Referral Challenge",message:g.referredByFriendsMsg(b.get("name")),buttons:["Yes","No"],callback:function(j){if(j.toLowerCase()=="yes"){Ext.defer(function(){g.fireEvent("openpage","mobileClient.Challenges","referrals",i)},1,g)}else{c()}}})}else{c()}},earnRedeemPopup:function(b){var a=this;if(!a.earnRedeemPopup){a.earnRedeemPopup=(Ext.create("Ext.Sheet",{bottom:0,left:0,top:0,right:0,padding:"1.0",hideOnMaskTap:false,defaultUnit:"em",cls:"x-mask transmit-mask",layout:{type:"vbox",pack:"middle"},defaults:{xtype:"container",defaultUnit:"em"},items:[{width:"100%",flex:1,style:"text-align:center;display:inline-table;color:white;font-size:1.1em;",html:a.fbConnectRequestMsg+'<img width="160" style="margin:0.7em 0;" src="'+Genesis.constants.resourceSite+"images/"+Genesis.constants.themeName+'/facebook_icon.png"/>'},{docked:"bottom",defaults:{xtype:"button",defaultUnit:"em",scope:a},padding:"0 1.0 1.0 1.0",items:[{margin:"0 0 0.5 0",text:"Proceed",ui:"action",handler:function(){a.earnRedeemPopup.hide();b()}},{margin:"0.5 0 0 0",text:"Cancel",handler:function(){a.earnRedeemPopup.hide()}}]}]}));Ext.Viewport.add(a.earnRedeemPopup)}a.earnRedeemPopup.show()},gravityThreshold:4,accelerometerHandler:function(a,c){var b=this;navigator.accelerometer.getCurrentAcceleration(function(d){if((d.z>=(9.81-b.gravityThreshold))&&(d.z<=(9.81+b.gravityThreshold))){if(a!=Genesis.constants.s_vol){window.plugins.proximityID.setVolume(Genesis.constants.s_vol);console.debug("Accelerometer new_vol="+Genesis.constants.s_vol);c(Genesis.constants.s_vol)}}else{if(a!=-1){window.plugins.proximityID.setVolume(-1);console.debug("Accelerometer new_vol=-1");c(-1)}}},{frequency:250})},getLocalID:function(f,d,b){var e=this,g=Genesis.constants,a=e.getViewPortCntlr();e.scanTaskWait=false;e.scanTask=null;e.scanTask=setInterval(function(){if(!e.scanTaskWait){e.scanTaskWait=true;clearInterval(e.scanTask);e.scanTask=null;e.self.playSoundFile(a.sound_files.nfcError);window.plugins.proximityID.stop();Ext.device.Notification.show({title:"Local Identity",message:e.noPeerDiscoveredMsg,buttons:["Try Again","Cancel"],callback:function(c){if(c.toLowerCase()!="try again"){d()}else{Ext.defer(b,1)}}})}},g.proximityRxTimeout);window.plugins.proximityID.scan(function(h){clearInterval(e.scanTask);e.scanTask=null;window.plugins.proximityID.stop();var c=Genesis.fn.processRecvLocalID(h);if(c.message){e.self.playSoundFile(a.sound_files.nfcEnd);f(c)}},function(c){clearInterval(e.scanTask);e.scanTask=null;window.plugins.proximityID.stop();Ext.device.Notification.show({title:"Local Identity",message:e.noPeerIdFoundMsg(Ext.encode(c)),buttons:["Dismiss"]});e.self.playSoundFile(a.sound_files.nfcError);console.debug("Error Code["+Ext.encode(c)+"]");d()},g.numSamples,g.conseqMissThreshold,g.magThreshold,g.sigOverlapRatio);return e.scanTask},broadcastLocalID:function(e,a){var d=this,f=Genesis.constants,b=function(){Ext.Ajax.abort();if(d.send_vol!=-1){window.plugins.proximityID.setVolume(-1)}window.plugins.proximityID.stop()};d.send_vol=-1;e=e||Ext.emptyFn;a=a||Ext.emptyFn;window.plugins.proximityID.send(function(c){console.debug("ProximityID : Broacasting Local Identity ...");e(Genesis.fn.processSendLocalID(c,b))},function(c){console.debug("Error Code["+Ext.encode(c)+"]");b();a()})},persistStore:function(b){var c,a={CustomerStore:[Ext.StoreMgr.get("PersistentCustomerStore"),"CustomerStore","CustomerJSON"],LicenseStore:[Ext.StoreMgr.get("PersistentLicenseStore"),"LicenseStore","frontend.LicenseKeyJSON"]};console.debug("Looking for "+b);for(c in a){if(!a[c][0]){Ext.regStore("Persistent"+a[c][1],{model:"Genesis.model."+a[c][2],syncRemovedRecords:true,autoLoad:false});a[c][0]=Ext.StoreMgr.get("Persistent"+a[c][1])}else{if(a[c][0].getStoreId()==("Persistent"+b)){return a[c][0]}}}return a[b][0]},persistLoadStores:function(o){var a="CREATE TABLE IF NOT EXISTS Customer (id INTEGER PRIMARY KEY AUTOINCREMENT, json TEXT)";var k="SELECT * FROM Customer";var h=this,m,c,l,b,g=69632,f=h.getViewPortCntlr(),n=[[this.persistStore("CustomerStore"),"CustomerStore",1],[this.persistStore("LicenseStore"),"LicenseStore",256]];o=o||Ext.emptyFn;for(c=0;c<n.length;c++){m=Ext.StoreMgr.get(n[c][1]);if(!m){console.debug("Cannot find Store["+n[c][1]+"] to be restored!")}try{n[c][0].load({callback:function(q,p){g|=n[c][2];var j=[];if(p.wasSuccessful()){m.removeAll();for(l=0;l<q.length;l++){var r=q[l].get("json");j.push(r)}m.setData(j);console.debug("persistLoadStores  --- Restored "+q.length+" records to "+n[c][1])}else{console.debug("Error Restoring "+n[c][1]+" ...")}if(n[c][1]=="CustomerStore"){var i=Genesis.db.openDatabase();try{i.transaction(function(e){e.executeSql(a,[],function(){console.debug("Successfully created/retrieved KickBak-Customers Table")},function(t,u){console.debug("Failed to create KickBak-Customers Table : "+u.message)});e.executeSql(k,[],function(u,t){var v=[];var w=t.rows;for(b=0,item=null;b<w.length;b++){item=w.item(b);v.push(Ext.decode(item.json))}Ext.StoreMgr.get("CustomerStore").add(v);if((g|=16)==69905){o()}console.debug("persistLoadStores  --- Restored "+v.length+" records from SQL Database, flag="+g)},function(t,u){console.debug("No Customer Table found in SQL Database : "+u.message)})})}catch(s){}}if(g==69905){o()}}})}catch(d){console.debug("Stack Trace - ["+d.stack+"]");Ext.device.Notification.show({title:"Account Profile",message:h.errorLoadingAccountProfileMsg,buttons:["Dismiss"],callback:function(){f.resetView();f.redirectTo("login")}})}}},persistSyncStores:function(g,l){var a="CREATE TABLE IF NOT EXISTS Customer (id INTEGER PRIMARY KEY AUTOINCREMENT, json TEXT)";var h="INSERT INTO Customer (json) VALUES (?)";var o="DROP TABLE Customer";var c,j,f,n,k=[[this.persistStore("CustomerStore"),"CustomerStore","Genesis.model.CustomerJSON"],[this.persistStore("LicenseStore"),"LicenseStore","Genesis.model.frontend.LicenseKeyJSON"]];if(!g||(g==k[0][1])){var m=Genesis.db.openDatabase();var b=Ext.StoreMgr.get("CustomerStore");try{m.transaction(function(e){e.executeSql(o,[],function(p,i){console.debug("Successfully drop KickBak-Customers Table")},function(i,p){console.debug("Failed to drop KickBak-Customers Table : "+p.message)});e.executeSql(a,[],function(p,i){console.debug("Successfully created/retrieved KickBak-Customers Table")},function(i,p){console.debug("Failed to create KickBak-Customers Table : "+p.message)});if(!l){f=b.getRange();for(j=0;j<f.length;j++){item=f[j];e.executeSql(h,[Ext.encode(item.getData(true))],function(){},function(i,p){console.debug("Failed to insert Customer("+item.getId()+") to Database : "+p.message)})}console.debug("persistSyncStores  --- Inserted "+f.length+" records in Database ...")}})}catch(d){}k[0][0].removeAll();k[0][0].getProxy().clear();k[0][0].sync()}for(c=1;c<k.length;c++){if(!g||(k[c][1]==g)){k[c][0].removeAll();k[c][0].getProxy().clear();if(!l){f=Ext.StoreMgr.get(k[c][1]).getRange();for(j=0;j<f.length;j++){n=f[j].getData(true);k[c][0].add(Ext.create(k[c][2],{json:n}))}console.debug("persistSyncStores  --- Found "+f.length+" records in ["+k[c][1]+"] ...")}k[c][0].sync()}}},refreshPage:function(e){var c=this,b=c.getViewport(),a=b.getEventDispatcher().controller,d=new Ext.fx.layout.Card(c.self.animationMode.fade);d.on("animationend",function(){console.debug("Animation Complete");d.destroy()},c);console.debug("Reloading Current Page ...");e.removeAll(true);b.animateActiveItem(e,d);d.onActiveItemChange(b.getLayout(),e,e,null,a);b.doSetActiveItem(e,null)},resetView:function(a){this.fireEvent("resetview")},pushView:function(a){this.fireEvent("pushview",a,this.getAnimationMode())},silentPopView:function(a){this.fireEvent("silentpopview",a)},popView:function(){this.fireEvent("popview")},geoRetryAttempts:3,getGeoLocation:function(d){var g=this,f=d||0,c=g.getViewPortCntlr(),b=c.getLastPosition();var e={autoUpdate:false,maximumAge:60*1000,timeout:2*1000,allowHighAccuracy:true,enableHighAccuracy:true};console.debug("Getting GeoLocation ...");var a=function(k,j){if(!k){console.debug("No GeoLocation found!");return}var i={coords:k};console.debug("\nLatitude: "+k.getLatitude()+"\nLongitude: "+k.getLongitude()+"\nAltitude: "+k.getAltitude()+"\nAccuracy: "+k.getAccuracy()+"\nAltitude Accuracy: "+k.getAltitudeAccuracy()+"\nHeading: "+k.getHeading()+"\nSpeed: "+k.getSpeed()+"\nTimestamp: "+new Date(k.getTimestamp())+"\n");c.setLastPosition(i);g.fireEvent("locationupdate",i)};var h=function(m,i,j,l,k){console.debug("GeoLocation Error["+k+"]");if(i){console.debug("TIMEOUT");if(!b){Ext.device.Notification.show({title:"Timeout Error",message:g.geoLocationTimeoutErrorMsg,buttons:["Dismiss"],callback:function(){g.fireEvent("locationupdate",b)}})}else{g.fireEvent("locationupdate",b)}}else{if(l){if(f<g.geoRetryAttempts){console.debug("Retry #"+f);Ext.defer(g.getGeoLocation,0.25*1000,g,[++f])}else{console.debug("POSITION_UNAVAILABLE");if(!b){Ext.device.Notification.show({title:"Location Services",message:g.geoLocationUnavailableMsg,buttons:["Dismiss"],callback:function(){g.fireEvent("locationupdate",b)}})}else{g.fireEvent("locationupdate",b)}}}else{console.debug("PERMISSION_DENIED");c.setLastPosition(null);g.fireEvent("locationupdate",null)}}};if(!g.geoLocation){g.geoLocation=Ext.create("Ext.util.Geolocation",Ext.applyIf({listeners:{locationupdate:a,locationerror:function(m,i,j,l,k){if(i&&(f<g.geoRetryAttempts)){f=g.geoRetryAttemptsme;g.getGeoLocation(f)}else{h(m,i,j,l,k)}}}},e))}g.geoLocation.updateLocation(null,null,(f>=g.geoRetryAttempts)?Ext.applyIf({allowHighAccuracy:false,enableHighAccuracy:false},e):e)},scanQRCode:function(){var b=this;var e=function(f){var g;Ext.Viewport.setMasked(null);if(Genesis.fn.isNative()){switch(window.plugins.qrCodeReader.scanType){case"RL":g=(f.response==undefined)?"":(f.response||"");console.debug("QR Code RL  = "+g);break;case"Nigma":g=(f.response==undefined)?"":(f.response||"");if(!g){console.debug("QR Code Nigma = Empty")}else{console.debug("QR Code Nigma = "+((g.responseCode)?g.responseCode:"NONE")+" Sent = "+g.bytesSent+" bytes")}if(g&&g.responseCode){g=g.responseCode}break;case"Default":g=f;if(!g||g.format!="QR_CODE"){g=null;console.debug("QR Code Default = Unsupported Code");if(device.platform.match(/simulator/i)){g=Math.random().toFixed(16)}}else{if(g.cancelled){g=Math.random().toFixed(16)}else{g=g.text}}console.debug("QR Code Default = "+((g)?g:"NONE"));break}}else{g=f.response;console.debug("QR Code = "+g)}Ext.device.Notification.beep();b.fireEvent("scannedqrcode",g)};var a=function(f){Ext.Viewport.setMasked(null);console.debug("Failed because: "+f);Ext.device.Notification.beep();b.fireEvent("scannedqrcode",null)};console.debug("Scanning QR Code ...");if(!Genesis.fn.isNative()){var d="0";if(!merchantMode){var c=b.getViewPortCntlr().getVenue()||Ext.StoreMgr.get("CheckinExploreStore").first()||null;d=c?c.getId():"0"}e({response:d})}else{Ext.Viewport.setMasked({xtype:"loadmask",message:b.loadingScannerMsg});window.plugins.qrCodeReader.getCode(e,a)}},tnfToString:function(a){var b=a;switch(a){case ndef.TNF_EMPTY:b="Empty";break;case ndef.TNF_WELL_KNOWN:b="Well Known";break;case ndef.TNF_MIME_MEDIA:b="Mime Media";break;case ndef.TNF_ABSOLUTE_URI:b="Absolute URI";break;case ndef.TNF_EXTERNAL_TYPE:b="External";break;case ndef.TNF_UNKNOWN:b="Unknown";break;case ndef.TNF_UNCHANGED:b="Unchanged";break;case ndef.TNF_RESERVED:b="Reserved";break}return b},showProperty:function(a,b){console.debug("Name["+a+"] Value["+b+"]")},printNfcTag:function(f){var e=this;function d(h){var n="",j=e.tnfToString(h.tnf),m=nfc.bytesToString(h.type),k;if(h.id&&(h.id.length>0)){n="Record Id: "+h.id+"\n"}switch(m){case"T":var g=h.payload[0],l=h.payload.slice((1+g),h.payload.length);k=nfc.bytesToString(l);break;case"U":var i=nfc.bytesToString(h.payload);k="URL["+i+"]";break;default:k=nfc.bytesToString(h.payload);break}return(n+"TNF: "+j+"\nRecord Type: "+m+"\n"+k)}var a=f.tag,b=a.ndefMessage||[];console.debug("Scanned an NDEF tag with "+b.length+" record"+((b.length===1)?"":"s"));if(a.id){e.showProperty("Id",nfc.bytesToHexString(a.id))}e.showProperty("Tag Type",a.type);e.showProperty("Max Size",a.maxSize+" bytes");e.showProperty("Is Writable",a.isWritable);e.showProperty("Can Make Read Only",a.canMakeReadOnly);for(var c=0;c<b.length;c++){console.debug(d(b[c]))}},onFbActivate:function(){var b=this,a=Genesis.fb;a.on("connected",b.updateFBSignUpPopupCallback,b);a.on("unauthorized",b.updateFBSignUpPopupCallback,b);a.on("exception",b.updateFBSignUpPopupCallback,b)},onFbDeactivate:function(){var b=this,a=Genesis.fb;a.un("connected",b.updateFBSignUpPopupCallback);a.un("unauthorized",b.updateFBSignUpPopupCallback);a.un("exception",b.updateFBSignUpPopupCallback)},onToggleFB:function(f,d,b,c,a,g){var h=this,e=Genesis.fb,i=Genesis.db.getLocalDB();if(c==1){h.onFbActivate();e.facebook_onLogin(i.enableTwitter)}else{if(i.enableFB){h.onFbDeactivate()}}},onFacebookChange:function(b,g,c,h,d,e){var f=this,a=f.getViewPortCntlr();if(f.initializing){return}f.self.playSoundFile(a.sound_files.clickSound);f.fireEvent("toggleFB",b,g,c,h,d,e)},onTwitterChange:function(b,g,c,h,d,e){var f=this,a=f.getViewPortCntlr();if(f.initializing){return}f.self.playSoundFile(a.sound_files.clickSound);f.fireEvent("toggleTwitter",b,g,c,h,d,e)}});Ext.define("Genesis.model.UserProfile",{extend:Ext.data.Model,alternateClassName:"UserProfile",id:"UserProfile",config:{belongsTo:[{model:"Genesis.model.User",getterName:"getUser",setterName:"setUser"}],fields:["gender","birthday","zipcode","created_ts","update_ts","user_id"]},getUser:function(){}});Ext.define("Genesis.model.User",{extend:Ext.data.Model,alternateClassName:"User",id:"User",config:{hasOne:[{model:"Genesis.model.UserProfile",associationKey:"profile"}],proxy:{type:"ajax",disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/store/users.json",reader:{type:"json"}},fields:["user_id","name","email","facebook_id","photo_url","created_ts","update_ts","profile_id"],idProperty:"user_id"}});Ext.define("Genesis.model.CustomerReward",{extend:Ext.data.Model,id:"CustomerReward",alternateClassName:"CustomerReward",config:{fields:["id","title","points","type","photo","quantity_limited","quantity","time_limited",{name:"expiry_date",type:"date",convert:function(a,b){a=Date.parse(a,"yyyy-MM-dd");return(a)?Genesis.fn.convertDateNoTimeNoWeek(a):null}}],idProperty:"id",belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},inheritableStatics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/customer_rewards?mode=reward")},setRedeemPointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/customer_rewards/"+a+"/redeem")},setMerchantRedeemPointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/customer_rewards/"+a+"/merchant_redeem")},setGetPrizesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/customer_rewards?mode=prize")},setRedeemPrizePointsURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/customer_rewards/"+a+"/redeem")}}});Ext.define("Genesis.model.frontend.MainPage",{extend:Ext.data.Model,alternateClassName:"MainPage",id:"MainPage",config:{fields:["name","photo_url","desc","pageCntlr","subFeature","route","hide"],proxy:{noCache:false,enablePagingParams:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"},type:"ajax",disableCaching:false}}});Ext.define("Genesis.model.frontend.Signin",{extend:Ext.data.Model,alternateClassName:"Signin",id:"Sigin",config:{fields:["username","password"],validations:[{type:"email",field:"username"},{type:"length",field:"password",min:6}]}});Ext.define("Genesis.model.frontend.Account",{extend:Ext.data.Model,alternateClassName:"Account",id:"Account",config:{fields:["name","email","gender",{type:"date",name:"birthday",dateFormat:"time"},"phone","password","username"],validations:[{type:"format",field:"phone",matcher:/^(\d{3})\D*(\d{3})\D*(\d{4})\D*(\d*)$/},{type:"length",field:"password",min:6}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json",messageProperty:"message",rootProperty:"user"},reader:{type:"json",messageProperty:"message",rootProperty:"data"},listeners:{metachange:function(d,b,c){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");a.fireEvent("updatemetadata",b)}}}},inheritableStatics:{phoneRegex:/^(\d{3})\D*(\d{3})\D*(\d{4})\D*(\d*)$/,setUpdateFbLoginUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/account/update_facebook_info")},setPasswdResetUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/account/reset_password")},setPasswdChangeUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/account/change_password")},setRefreshCsrfTokenUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/tokens/get_csrf_token")},setUpdateRegUserDeviceUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/account/register_user_device")},setUpdateAccountUrl:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/account/update")}}});Ext.define("Genesis.controller.MainPageBase",{extend:Genesis.controller.ControllerBase,xtype:"mainPageBaseCntlr",config:{csrfTokenRecv:false,models:["Customer","User","Merchant","CustomerReward","Genesis.model.frontend.MainPage","Genesis.model.frontend.Signin","Genesis.model.frontend.Account"],after:{mainPage:""},routes:{main:"mainPage"},refs:{},control:{main:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"}},listeners:{itemTap:"onItemTap"}},init:function(b){var a=this;a.callParent(arguments);Genesis.db.removeLocalDBAttrib("csrf_code");Ext.regStore("MainPageStore",{model:"Genesis.model.frontend.MainPage",autoLoad:false,listeners:{scope:a,refresh:a.initCallback}});Ext.Viewport.on("orientationchange",function(e,d,g,c,f){var i=a.getMain(),h=a.getViewport();if(i==h.getActiveItem()){a.refreshPage(i)}});console.log("MainPageBase Init");a.getMain();backBtnCallbackListFn.push(function(e){var d=((e==a.getMain())||((merchantMode)?false:(e==a.getLogin())));if(d){var c=a.getViewPortCntlr();a.self.playSoundFile(c.sound_files.clickSound);if(Ext.os.is("Android")){navigator.app.exitApp()}else{if(!Genesis.fn.isNative()){window.location.reload()}}return true}return false})},onItemTap:function(c){var b=this.getViewPortCntlr();this.self.playSoundFile(b.sound_files.clickSound);console.debug("Controller=["+c.get("pageCntlr")+"]");var a=this.getApplication().getController(c.get("pageCntlr"));var d=a.isOpenAllowed();if(d===true){if(c.get("route")){this.redirectTo(c.get("route"))}else{if(c.get("subFeature")){a.openPage(c.get("subFeature"))}else{a.openMainPage()}}}else{Ext.device.Notification.show({title:"Error",message:d,buttons:["Dismiss"]})}return false},onShowView:function(a){if(Ext.os.is("Android")){}},mainPage:function(){this.openPage("main")},openPage:function(a){var c=this;switch(a){case"main":c.setAnimationMode(c.self.animationMode.pop);c.pushView(c.getMainPage());break;case"merchant":c.goToMerchantMain(true);break;case"login":var b=c.getApplication().getController("client.Checkins");b.fireEvent("setupCheckinInfo","checkin",null,null,null);c.setAnimationMode(c.self.animationMode.fade);c.pushView(c.getLogin());break}},getMainPage:function(){var a=this.getMain();return a},openMainPage:function(){var a=this.getViewPortCntlr();this.setAnimationMode(this.self.animationMode.pop);this.pushView(this.getMainPage());console.log("MainPage Opened")},isOpenAllowed:function(){return true}});Ext.define("Genesis.model.PurchaseReward",{extend:Ext.data.Model,id:"PurchaseReward",alternateClassName:"PurchaseReward",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"},listeners:{metachange:function(d,b,c){var a=_application.getController(((!merchantMode)?"client":"server")+".Rewards");a.fireEvent("updatemetadata",b)}}},fields:["id","title","points","type","photo","created_ts","update_ts"]},getMerchant:function(){},inheritableStatics:{setGetRewardsURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/purchase_rewards")},setEarnPointsURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/purchase_rewards/earn")},setMerchantEarnPointsURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/purchase_rewards/merchant_earn")}}});Ext.define("Genesis.controller.RedeemBase",{extend:Genesis.controller.ControllerBase,inheritableStatics:{},xtype:"redeemBaseCntlr",config:{models:["Customer","PurchaseReward","CustomerReward"],listeners:{redeemitem:"onRedeemItem"}},controllerType:"redemption",redeemSuccessfulMsg:"Transaction Complete",redeemFailedMsg:"Transaction Failed",init:function(){var a=this;Ext.regStore(a.getRenderStore(),{model:"Genesis.model.Customer",autoLoad:false});Ext.regStore(a.getRedeemStore(),{model:"Genesis.model.CustomerReward",autoLoad:false,pageSize:5,sorters:[{property:"points",direction:"ASC"}],listeners:{scope:a,metachange:function(b,d,c){if(b.isLoading()){a.fireEvent("updatemetadata",d.getReader().metaData)}}}});this.callParent(arguments);console.log("RedeemBase Init");Ext.defer(function(){a.getRedeemItem();a.getRedemptions()},1,a)},onCreateView:function(b){var a=this;b.item=a.redeemItem},onShowView:function(d){if(Ext.os.is("Android")){var b=this.getEventDispatcher().getPublishers()["elementSize"].monitors;var c=d.query("list[tag="+d.getListCls()+"]")[0];console.debug("Refreshing RenderStore ...");var a=d.query("dataview[tag=ptsEarnPanel]")[0];if(a){a.refresh()}b[c.container.getId()].forceRefresh()}},onActivate:function(e,l,p,h){var m=this;var k=m.getRedemptions();var j=m.getViewPortCntlr();var g=j.getCustomer();var n=Ext.StoreMgr.get(m.getRenderStore());var f=j.getCheckinInfo().venue;var b=j.getVenue();var a=b.getId();var o=b.getMerchant().getId();m.exploreMode=!f||(f&&(f.getId()!=b.getId()));if(g!=n.getRange()[0]){n.setData(g)}for(var d=0;d<e.getInnerItems().length;d++){}console.debug("ReedeemBase: onActivate");if(m.mixins&&m.mixins.redeemBase){m.mixins.redeemBase.onActivate.apply(m,arguments)}},onDeactivate:function(a,e,d,b){console.debug("ReedeemBase: onDeactivate")},onItemListSelect:function(c,a,b){c.deselect([a]);this.onItemListDisclose(c,a,null,null,null,null,null,false);return false},onItemListDisclose:function(h,b,f,c,g,i,a,k){var j=this;var d=j.getViewPortCntlr();var l=function(){if(d.getCustomer()){var e=d.getCustomer().get(j.getPtsProperty());var m=b.get("points");if(m>e){Ext.device.Notification.show({title:"Redeem"+j.getTitle(),message:j.needPointsMsg(m-e),buttons:["Dismiss"]});return}}j.fireEvent("showredeemitem",b)};if(!k){j.self.playSoundFile(d.sound_files.clickSound)}switch(j.getBrowseMode()){case"redeemBrowse":if(!j.exploreMode){l()}else{Ext.device.Notification.show({title:"Warning",message:j.checkinFirstMsg,buttons:["Dismiss"]})}break;case"redeemBrowseSC":l();break}return true},onRedeemItemCreateView:function(c){var b=this;var a=b.getRedeemMainPage();a.item=b.redeemItem},onRedeemItemActivate:function(g,h,b,e){var f=this,a=g.query("titlebar")[0],d=Ext.StoreMgr.get(f.getRedeemStore());f.getSCloseBB()[(d.getAllCount()==1)?"hide":"show"]();if(f.getSBackBB){f.getSBackBB()[(d.getAllCount()==1)?"show":"hide"]()}a.setTitle(f.getTitle());a.removeCls("kbTitle");console.debug("Base onRedeemItemActivate - Updated RewardItem View!")},onRedeemItemDeactivate:function(a,f,e,b){var d=this;if(d.getSDoneBtn()){d.getSDoneBtn()["hide"]()}window.plugins.proximityID.stop();console.debug("onRedeemItemDeactivate - Done with RewardItem View!")},onDoneTap:function(a,i,d,h,g){var f=this;var c=f.getRedeemMainPage();if(Genesis.fn.isNative()){if(Ext.os.is("iOS")){}else{if(Ext.os.is("Android")){}else{if(Ext.os.is("BlackBerry")){}}}}if(c.isPainted()&&!c.isHidden()){f.popView()}},onShowItemQRCode:function(d,c){var b=this;var a;var f="Redeem "+b.getTitle();a=Genesis.controller.ControllerBase.genQRCode(c);if(a[0]){var e=Ext.DomQuery.select("div.itemPoints",b.getRedeemItem().element.dom)[0];if(b.getSRedeemBtn()){b.getSRedeemBtn().hide()}if(b.getSDoneBtn()){b.getSDoneBtn()["show"]()}b.getSCloseBB().hide();if(e){Ext.fly(e).addCls("x-item-hidden")}b.fireEvent("refreshQRCode",a);Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:f,message:b.showQrCodeMsg,buttons:["OK"]});Ext.device.Notification.vibrate()}else{console.debug("onShowItemQRCode - QR Code encoding Error")}},redeemBrowsePage:function(){this.openPage("redeemBrowse");if(this.getCloseBtn()){this.getCloseBtn().show();this.getBackBtn().hide()}},getRedeemMainPage:function(){var a=this;var b=null;switch(a.getRedeemMode()){case"authReward":case"redeemPrize":case"redeemReward":a.setAnimationMode(Genesis.controller.ControllerBase.animationMode.coverUp);b=a.getRedeemItem();break}return b},getBrowseMainPage:function(){var b=this;var c=null;switch(b.getBrowseMode()){case"redeemBrowseSC":b.setAnimationMode(Genesis.controller.ControllerBase.animationMode.coverUp);break;case"redeemBrowse":default:b.setAnimationMode(Genesis.controller.ControllerBase.animationMode.cover);break}var a=Ext.StoreMgr.get(b.getRedeemStore());if(a.getAllCount()==1){b.onItemListDisclose(null,a.first(),null,null,null,null,null,true)}else{c=b.getRedemptions()}return c},openPage:function(a){var b=this;if(a.match(/Browse/)){b.setBrowseMode(a);b.pushView(b.getBrowseMainPage())}else{b.setRedeemMode(a);b.pushView(b.getRedeemMainPage())}},isOpenAllowed:function(){return true}});Ext.define("Genesis.controller.PrizeRedemptionsBase",{extend:Genesis.controller.RedeemBase,inheritableStatics:{},xtype:"prizeRedemptionsCntlr",controllerType:"prize",config:{redeemInfoMsg:"Getting the Prizes List ...",redeemPopupTitle:"Redeem Prizes",redeeemSuccessfulMsg:"Prize selected has been successfully redeemed!",timeoutPeriod:10,minPrizePts:1,browseMode:"redeemBrowse",redeemMode:"redeemPrize",renderStore:"PrizeRenderCStore",redeemStore:"PrizeStore",redeemPointsFn:"setRedeemPrizePointsURL",redeemUrl:"setGetPrizesURL",ptsProperty:"prize_points",title:"Prizes",routes:{prizes:"redeemBrowsePage",redeemPrize:"redeemItemPage"},refs:{},control:{redemptions:{createView:"onCreateView",showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},redemptionsList:{select:"onItemListSelect",disclose:"onItemListDisclose"},redeemItem:{createView:"onRedeemItemCreateView",showView:"onRedeemItemShowView",activate:"onRedeemItemActivate",deactivate:"onRedeemItemDeactivate",redeemItemTap:"onRedeemItemTap"}},listeners:{}},scanPlayTitle:"Spin and Play",init:function(){var a=this;a.callParent(arguments);a.on({showredeemitem:"onShowRedeemItem",showredeemprize:"onShowRedeemPrize",showQRCode:"onShowItemQRCode"});console.log("Prize Redemptions Init")},onShowRedeemItem:function(a){var b=this;b.redeemItem=a;b.redirectTo("redeemPrize")},onShowRedeemPrize:function(d,a,e){var b=this;var c=a;b.redeemItem=d;if(e>0){console.debug("Removing Last "+e+" Views from History ...");b.silentPopView(e)}b.redirectTo("redeemPrize")},onRedeemItemActivate:function(f,g,b,d){var e=this,a=f.query("titlebar")[0];e.getSCloseBB()[(e.getRedeemMode()!="authReward")?"show":"hide"]();e.getSBackBB()[(e.getRedeemMode()=="authReward")?"show":"hide"]();a.setTitle(e.getTitle());a.removeCls("kbTitle");if(e.getSRedeemBtn()){e.getSRedeemBtn()["show"]()}console.debug("Base onRedeemItemActivate - Updated RewardItem View.")},redeemItemPage:function(){this.setTitle("Prizes");this.openPage("redeemPrize")}});Ext.define("Genesis.controller.RewardRedemptionsBase",{extend:Genesis.controller.RedeemBase,inheritableStatics:{},xtype:"rewardRedemptionsBaseCntlr",controllerType:"redemption",config:{redeeemSuccessfulMsg:"Reward selected has been successfully redeemed!",redeemInfoMsg:"Getting the Redemptions List ...",redeemPopupTitle:"Redeem Rewards",browseMode:"redeemBrowse",redeemMode:"redeemReward",renderStore:"RedemptionRenderCStore",redeemStore:"RedeemStore",redeemUrl:"setGetRewardsURL",redeemPath:"redeemBrowseRewardsSC",ptsProperty:"points",title:"Rewards",routes:{redemptions:"redeemBrowsePage",redeemRewardsChooseSC:"redeemChooseSCPage",redeemBrowseRewardsSC:"redeemBrowseSCPage",redeemReward:"redeemItemPage"},refs:{},control:{redemptions:{createView:"onCreateView",showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},redemptionsList:{select:"onItemListSelect",disclose:"onItemListDisclose"},redeemItem:{createView:"onRedeemItemCreateView",showView:"onRedeemItemShowView",activate:"onRedeemItemActivate",deactivate:"onRedeemItemDeactivate",redeemItemTap:"onRedeemItemTap"}}},xtype:"redemptionsBaseCntlr",checkinFirstMsg:"Please Check-In before redeeming Rewards",init:function(){var a=this;a.callParent(arguments);a.on({showredeemitem:"onShowRedeemItem",showQRCode:"onShowItemQRCode",refreshQRCode:"onRefreshQRCode"});console.log("RewardRedemptionsBase Init")},onRefreshQRCode:function(b){var f=this;var a=f.getRedeemMainPage();var h=a.query("carousel")[0];var e=h?h.getActiveItem():a.getInnerItems()[0];var g=e.query("component[tag=info]")[0];g.hide();var d=e.query("component[tag=itemPhoto]")[0];var c=Ext.get(Ext.DomQuery.select("img",d.element.dom)[0]);c.setStyle({width:Genesis.fn.addUnit(b[1]*1.5),height:Genesis.fn.addUnit(b[2]*1.5)});c.set({src:b[0]})},onShowRedeemItem:function(a){var b=this;b.redeemItem=a;b.redirectTo("redeemReward")},redeemItemPage:function(){this.openPage("redeemReward")}});Ext.define("Genesis.view.ViewBase",{extend:Ext.Container,xtype:"viewbase",inheritableStatics:{generateTitleBarConfig:function(){return({xtype:"titlebar",docked:"top",tag:"navigationBarTop",cls:"navigationBarTop",masked:{xtype:"mask",transparent:true},defaults:{iconMask:true}})},invisibleMask:{xtype:"mask",transparent:true},phoneField:function(){return({xtype:"textfield",minLength:12,maxLength:12,placeHolder:"800-555-1234",listeners:{keyup:function(g,i,c){var h=i.browserEvent.keyCode,b=String.fromCharCode(h),d=g.getValue();if((h>=48&&h<=90)||(h>=106&&h<=111)||(h>=186&&h<=192)||(h>=219&&h<=222)){if(b.match(/[0-9]/)&&(!i.browserEvent.shiftKey&&!i.browserEvent.ctrlKey&&!i.browserEvent.metaKey)){if((d.length==3)||(d.length==7)){g.setValue(d+"-")}else{if((d.length==4)||(d.length==8)){var a=d.match(/-/);if(!a){g.setValue(d.slice(0,d.length-1)+"-"+d[d.length-1])}else{switch(a.length){case 1:if(d.length>4){g.setValue(d.slice(0,d.length-1)+"-"+d[d.length-1])}break;default:break}}}}}else{g.setValue(d.slice(0,d.length-1))}}}}})}},config:{preRender:null},initialize:function(){this.callParent(arguments);this.setPreRender([])},calcCarouselSize:function(b){var c=this,a=50;b=b||1;console.debug("Screen Height["+window.innerHeight+"], Width["+window.innerWidth+"]");if(window.innerHeight<(480-a)){c.setItemPerPage(4*b)}else{if(window.innerHeight<(568-a)){c.setItemPerPage(6*b)}else{if(window.innerHeight<(1024-a)){c.setItemPerPage(8*b)}else{c.setItemPerPage(10*b)}}}},cleanView:function(){this.fireEvent("cleanView",this)},removeAll:function(a,b){var c=this.callParent(arguments);this.setPreRender([]);return c},createView:function(){this.fireEvent("createView",this);return(this.getPreRender().length==0)},showView:function(){if(this.getInnerItems().length==0){this.add(this.getPreRender())}Ext.defer(this.fireEvent,0.01*1000,this,["showView",this])}});Ext.define("Genesis.view.Document",{extend:Genesis.view.ViewBase,xtype:"documentview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"container",tag:"content",scrollable:"vertical",padding:"0.7 0.8",defaultUnit:"em",html:" "}]},disableAnimation:true,setHtml:function(b){var c=this.query("container[tag=content]")[0];var a=c.getScrollable();c.setHtml(b);if(a){a.getScroller().scrollTo(0,0)}},createView:function(){if(!this.callParent(arguments)){return}}});Ext.define("Genesis.view.MultipartDocument",{extend:Genesis.view.ViewBase,xtype:"multipartdocumentview",config:{layout:"fit",cls:"viewport",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"tabpanel",defaults:{xtype:"container",scrollable:"vertical",padding:"0.7 0.8",defaultUnit:"em",html:" "},layout:"card",tabBarPosition:"top",tabBar:{layout:{pack:"justify"}}}]},disableAnimation:true,setHtml:function(b,d){var e=this.query("tabpanel")[0];var c=e.getInnerItems()[b];if(!c){c=e.insert(b,Ext.apply({xtype:"container"},d))}else{var a=c.getScrollable();a.getScroller().scrollTo(0,0);c.setHtml(html)}},createView:function(){if(!this.callParent(arguments)){return}}});Ext.define("Genesis.controller.SettingsBase",{extend:Genesis.controller.ControllerBase,inheritableStatics:{},xtype:"settingsBaseCntlr",config:{termsOfServiceTitle:"Term of Service",privacyTitle:"Privacy",aboutUsTitle:"About Us",routes:{aboutus:"documentPage",privacy:"documentPage",termsOfUse:"multipartDocumentPage",settings:"openSettingsPage"},refs:{documentPage:{selector:"documentview",autoCreate:true,xtype:"documentview"},multipartDocumentPage:{selector:"multipartdocumentview",autoCreate:true,xtype:"multipartdocumentview"}}},termsLoaded:false,privacyLoaded:false,aboutUsLoaded:false,init:function(){this.callParent(arguments);this.getMultipartDocumentPage();this.getDocumentPage();console.log("Settings Base Init")},onTermsTap:function(c,j){var g=this,f=0,a=g.getViewPortCntlr(),i=[],h=g.getMultipartDocumentPage();h.query("title")[0].setTitle(g.getTermsOfServiceTitle());g.self.playSoundFile(a.sound_files.clickSound);if(!g.termsLoaded){var d=function(){for(var b=0;b<i.length;b++){h.setHtml(b,i[b].cardConfig)}g.redirectTo("termsOfUse");g.termsLoaded=true};Ext.Ajax.request({async:true,disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../term_of_service.htm",callback:function(e,k,b){if(k||(b.status==0)){i[0]=b;b.cardConfig={title:"Terms of Use",html:b.responseText};if((f|=1)==17){d()}}else{console.debug("Error Loading Term of Service Document.");console.debug("Status code "+b.status)}}});Ext.Ajax.request({async:true,disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../program_rules.htm",callback:function(e,k,b){if(k||(b.status==0)){i[1]=b;b.cardConfig={title:"Program Rules",html:b.responseText};if((f|=16)==17){d()}}else{console.debug("Error Loading Program Rules Document.");console.debug("Status code "+b.status)}}})}else{g.redirectTo("termsOfUse")}},onPrivacyTap:function(c,g){var d=this;var a=d.getViewPortCntlr();var f=d.getDocumentPage();f.query("title")[0].setTitle(d.getPrivacyTitle());d.self.playSoundFile(a.sound_files.clickSound);if(!d.privacyLoaded){Ext.Ajax.request({disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../privacy.htm",callback:function(e,h,b){if(h||(b.status==0)){f.setHtml(b.responseText);d.redirectTo("privacy");d.privacyLoaded=true}else{console.debug("Error Loading Privacy Document.");console.debug("Status code "+b.status)}}})}else{d.redirectTo("privacy")}},onAboutUsTap:function(c,g){var d=this;var a=d.getViewPortCntlr();var f=d.getDocumentPage();f.query("title")[0].setTitle(d.getAboutUsTitle());d.self.playSoundFile(a.sound_files.clickSound);if(d.aboutUsLoaded){Ext.Ajax.request({disableCaching:false,url:Ext.Loader.getPath("Genesis")+"/../about_us.htm",callback:function(e,h,b){if(h||(b.status==0)){f.setHtml(b.responseText);d.redirectTo("aboutUs");d.aboutUsLoaded=true}else{console.debug("Error Loading About US Document.");console.debug("Status code "+b.status)}}})}else{d.redirectTo("aboutUs")}},onDeviceReset:function(a,c){},openSettingsPage:Ext.emptyFn,multipartDocumentPage:function(){this.openPage("multipartDocument")},documentPage:function(){this.openPage("document")},openPage:function(a){var b=this,c;switch(a){case"settings":c=b.getSettingsPage();b.setAnimationMode(b.self.animationMode.cover);break;case"multipartDocument":c=b.getMultipartDocumentPage();b.setAnimationMode(b.self.animationMode.slide);break;case"document":c=b.getDocumentPage();b.setAnimationMode(b.self.animationMode.slide);break}b.pushView(c)},isOpenAllowed:function(){return true}});Ext.define("Genesis.model.Challenge",{extend:Ext.data.Model,id:"Challenge",alternateClassName:"Challenge",config:{belongsTo:[{model:"Genesis.model.Merchant",getterName:"getMerchant",setterName:"setMerchant"}],fields:["id","type","name","description","require_verif","data","points","created_ts","update_ts","photo","merchant_id","venue_id"],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},getMerchant:function(){},inheritableStatics:{setGetChallengesURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/challenges")},setCompleteChallengeURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/challenges/"+a+"/complete")},setCompleteMerchantChallengeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/challenges/merchant_complete")},setCompleteReferralChallengeURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/challenges/complete_referral")},setSendReferralsUrl:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/challenges/"+a+"/start")}}});Ext.define("Genesis.model.Venue",{extend:Ext.data.Model,alternateClassName:"Venue",id:"Venue",config:{fields:["id","name","address","description","distance","city","state","country","zipcode","phone","website","latitude","longitude","created_ts","update_ts","type","merchant_id","prize_jackpots"],belongsTo:[{model:"Genesis.model.Merchant",associationKey:"merchant",getterName:"getMerchant",setterName:"setMerchant"}],hasMany:[{model:"Genesis.model.Challenge",name:"challenges"},{model:"Genesis.model.PurchaseReward",name:"purchaseReward"},{model:"Genesis.model.CustomerReward",name:"customerReward"}],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}},idProperty:"id"},inheritableStatics:{setGetMerchantVenueExploreURL:function(a){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/venues/"+a+"/merchant_explore")},setFindNearestURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/venues/find_nearest")},setGetClosestVenueURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/venues/find_closest")},setSharePhotoURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/venues/share_photo")},setGetLicenseKeyURL:function(){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/venues/updateLicenseKey")},setMerchantReceiptUploadURL:function(a){this.getProxy().setActionMethods({read:"POST"});this.getProxy().setUrl(serverHost+"/api/v1/venues/"+a+"/merchant_add_sku_data")}}});Ext.define("Genesis.model.frontend.LicenseKeyJSON",{extend:Ext.data.Model,alternateClassName:"LicenseKeyJSON",id:"LicenseKeyJSON",config:{proxy:{type:"localstorage",id:"LicenseKeyJSON",writer:{type:"json"},reader:{type:"json"}},identifier:"uuid",fields:["json","id"],idProperty:"id"}});Ext.define("Genesis.model.frontend.LicenseKey",{extend:Ext.data.Model,alternateClassName:"LicenseKey",id:"LicenseKey",config:{proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}},fields:["venue_id","venue_name","id"],idProperty:"id"},inheritableStatics:{setGetLicenseKeyURL:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/devices/get_encryption_key")}}});Ext.define("Genesis.controller.ViewportBase",{extend:Genesis.controller.ControllerBase,inheritableStatics:{},config:{models:["Customer","Checkin","Venue","Genesis.model.frontend.LicenseKey"],sound_files:null,refs:{view:"viewportview",backButton:"button[tag=back]",closeButton:"button[tag=close]"},control:{view:{activate:"onActivate"},backButton:{tap:"onBackButtonTap"},closeButton:{tap:"onBackButtonTap"},"viewportview button":{tap:"onButtonTap"}}},mainPageStorePathToken:/\{platform_path\}/mg,popViewInProgress:false,viewStack:[],animationFlag:0,gatherCheckinInfoMsg:"Prepare to scan Check-in Code ...",retrieveChallengesMsg:"Retrieving Challenges ...",updateBadges:function(a){var c=this,b=Ext.StoreMgr.get("BadgeStore");if(a){b.setData(a)}},updateAccountInfo:function(a,b){var l=this,f=false,j=l.getViewPortCntlr();var p=Ext.StoreMgr.get("BadgeStore"),c=Ext.StoreMgr.get("CustomerStore");var h=j.getCustomer(),o=a.customer_id||((h)?h.getId():0);var g=function(){if(b&&(b.visits==1)){console.debug("Adding New Customer Record ...");var i=l.getApplication().getController("client.Merchants"),q=l.getApplication().getController("client.Checkins");var s=j.getCustomer(),r=Ext.create("Genesis.model.Customer",Ext.applyIf({id:o,merchant:s.getMerchant().raw},b));r.setLastCheckin(Ext.create("Genesis.model.Checkin"));c.add(r);i.getMain().cleanView(q.getExplore());q.fireEvent("setupCheckinInfo","checkin",j.getVenue(),r,a);console.debug("New Customer Record Added.");l.persistSyncStores("CustomerStore");h=r}};if(o>0){console.debug("updateAccountInfo - customerId["+o+"]");h=c.getById(o);if(h){h.beginEdit();if(b){if(Ext.isDefined(b.points)){h.set("points",b.points)}if(Ext.isDefined(b.prize_points)){h.set("prize_points",b.prize_points)}if(Ext.isDefined(b.visits)){h.set("visits",b.visits)}if(Ext.isDefined(b.next_badge_visits)){h.set("next_badge_visits",b.next_badge_visits)}var e,n=[{id:b.badge_id,prefix:"Customer's Current Badge is - [",badgeId:"badge_id"},{id:b.next_badge_id,prefix:"Customer's Next Badge is - [",badgeId:"next_badge_id"}];for(e=0;e<n.length;e++){if(Ext.isDefined(n[e].id)){var k=p.getById(n[e].id);console.debug(n[e].prefix+k.get("type").display_value+"/"+k.get("visits")+"]");h.set(n[e].badgeId,n[e].id)}}var m=b.eligible_for_reward;if(Ext.isDefined(m)){h.set("eligible_for_reward",m)}var d=b.eligible_for_prize;if(Ext.isDefined(d)){h.set("eligible_for_prize",d)}}h.endEdit();l.persistSyncStores("CustomerStore")}else{g()}}else{g()}return h},updateRewards:function(e){if(e&&(e.length>0)){var b,c=this,a=c.getViewPortCntlr(),d=a.getVenue().getMerchant();console.debug("Total Redemption Rewards - "+e.length);for(b=0;b<e.length;b++){e[b]["merchant"]=d}Ext.StoreMgr.get("RedeemStore").setData(e)}},updatePrizes:function(b){if(b&&(b.length>0)){var c,d=this,a=d.getViewPortCntlr(),e=a.getVenue().getMerchant();console.debug("Total Redemption Prizes - "+b.length);for(c=0;c<b.length;c++){b[c]["merchant"]=e}Ext.StoreMgr.get("PrizeStore").setData(b)}},updateNews:function(b){var a=Ext.StoreMgr.get("NewsStore");if(b&&(b.length>0)){console.debug("Total News Items - "+b.length);a.setData(b)}else{console.debug("No News Items");a.removeAll()}},updateAuthCode:function(a){var d=this,f=false,b=Genesis.db.getLocalDB();var c=a.auth_token,g=a.csrf_token,e=a.account;if(!c){return f}f=true;if((c!=b.auth_code)||(g!=b.csrf_code)){b.auth_code=c;b.csrf_code=g;b.account=e||{};Genesis.db.setLocalDB(b);console.debug("\nauth_code ["+c+"]\ncsrf_code ["+g+"]\naccount ["+Ext.encode(e)+"]\ncurrFbId ["+b.currFbId+"]")}return f},updateMetaDataInfo:function(b){var j=this,h=null,i=j.getViewPortCntlr(),k=Genesis.db.getLocalDB(),f=Ext.StoreMgr.get("CheckinExploreStore");try{if(j.updateAuthCode(b)){i.setLoggedIn(true);i.fireEvent("updateDeviceToken");if(!k.last_check_in){if((k.enableFB&&(k.currFbId>0))||k.disableFBReminderMsg){j.redirectTo("checkin")}else{Genesis.fb.createFBReminderMsg()}}return}j.updateBadges(b.badges);h=j.updateAccountInfo(b,b.account_info);var c=b.venue_id||((f.first())?f.first().getId():0);venue=f.getById(c)||i.getVenue();if(Ext.isDefined(b.venue)){venue=Ext.create("Genesis.model.Venue",b.venue);var d=j.getApplication().getController("client.Checkins");var a=b.prize_jackpots;if(a>=0){console.debug("Prize Jackpots won by customers at this merchant this month - ["+a+"]");venue.set("prize_jackpots",a)}console.debug("customer_id - "+h.getId()+"\nmerchant_id - "+venue.getMerchant().getId()+"\n");d.fireEvent("setupCheckinInfo","checkin",venue,h,b)}else{var a=b.prize_jackpots;if(a>=0){console.debug("Prize Jackpots won by customers at this merchant this month - ["+a+"]");venue.set("prize_jackpots",a)}}j.updateRewards(b.rewards);j.updatePrizes(b.prizes);j.updateNews(b.newsfeed)}catch(g){console.debug("updateMetaDataInfo Exception - "+g)}return h},onCompleteRefreshCSRF:Ext.emptyFn,onUpdateDeviceToken:Ext.emptyFn,onActivate:function(){var f=this,d=Ext.Loader.getPath("Genesis")+"/store/"+((!merchantMode)?"mainClientPage":"mainServerPage")+".json",g="",b=Genesis.db.getLocalDB();var e=new XMLHttpRequest(),c=b.enablePrizes,a=b.enableChallenges;if((typeof(device)!="undefined")&&device.uuid){if(Ext.os.is("iOS")||Ext.os.is("BlackBerry")){g=""}else{if(Ext.os.is("Android")){g="file:///android_asset/www/"}}}d=g+d;console.log("Loading MainPage Store ...");e.onreadystatechange=function(){if(e.readyState==4){if(e.status==200||e.status==0){var n=e.responseText.replace(f.mainPageStorePathToken,Genesis.constants._iconPath);console.log("Loaded MainPage Store ...");var h=Ext.decode(n);var m=h.data;for(var k=0;k<m.length;k++){var l=m[k];var j=m.indexOf(l);if(merchantMode){if(Ext.isDefined(c)){if(!c){if(l.id=="redeemPrizes"){m.splice(j,1);if(j==k){k--}}}}if(Ext.isDefined(a)){if(!a){if(l.id=="challenges"){m.splice(j,1);if(j==k){k--}}}}}else{if(_build=="MobileWebClient"){switch(l.id){case"transfer":case"referrals":m.splice(j,1);if(j==k){k--}break}}}}Ext.StoreMgr.get("MainPageStore").setData(h.data)}}};e.open("GET",d,true);e.send(null)},onButtonTap:function(a,d,c){this.self.playSoundFile(this.sound_files.clickSound)},onBackButtonTap:function(a,d,c){this.popView()},resetView:function(){var b=this;var a=b.getViewport();b.viewStack=[];b.getApplication().getHistory().setActions([])},pushView:function(b,d){if(!b){return}var c=this;d=Ext.apply(d,{reverse:false});var a=(c.viewStack.length>1)?c.viewStack[c.viewStack.length-2]:null;if((c.viewStack.length>0)&&(b==c.viewStack[c.viewStack.length-1]["view"])){}else{if(a&&(a.view==b)){c.popView()}else{var e=c.getApplication().getHistory().getActions();c.viewStack.push({view:b,animation:d,url:e[e.length-1].getUrl()});c.getViewport().animateActiveItem(b,d)}}},silentPopView:function(b){var c=this;b=Math.min(c.viewStack.length,b);var d=c.getApplication().getHistory().getActions();if((c.viewStack.length>0)&&(b>0)){while(b-->0){var a=c.viewStack.pop();d.pop()}}},popView:function(){var c=this;var d=c.getApplication().getHistory().getActions();if(c.viewStack.length>1){var a=c.viewStack.pop();var b=c.viewStack[c.viewStack.length-1];if(!c.popViewInProgress){c.popViewInProgress=true;d.pop();if(b.view.isDestroyed){b.view=Ext.create(b.view.alias[0])}c.getApplication().getHistory().setToken(b.url);window.location.hash=b.url;c.getViewport().animateActiveItem(b.view,Ext.apply(a.animation,{reverse:true}))}}else{if(!c.getLoggedIn||c.getLoggedIn()){c.goToMerchantMain(true)}else{c.redirectTo("login")}}},init:function(b){var a=this;Genesis.constants.init();a.callParent(arguments);if(Ext.isDefined(window.device)){console.debug("\ndevice.platform - "+device.platform+"\ndevice.uuid - "+device.uuid+"\nBrowser EngineVersion - "+Ext.browser.engineVersion+"")}a.on({viewanimend:"onViewAnimEnd",baranimend:{buffer:0.5*1000,fn:"onBarAnimEnd"},pushview:"pushView",silentpopview:"silentPopView",popview:"popView",resetview:"resetView"});Ext.regStore("LicenseStore",{model:"Genesis.model.frontend.LicenseKey",autoLoad:false});a.last_click_time=new Date().getTime();document.addEventListener("click",function(d){var c=d.timeStamp;if(c&&(c-a.last_click_time)<1000){d.stopPropagation();d.preventDefault();return false}a.last_click_time=c;return true});console.log("ViewportBase Init")},loadSoundFile:function(a,b,d){var f=this,c="."+(b.split(".")[1]||"mp3");b=b.split(".")[0];if(Genesis.fn.isNative()){var g=function(){switch(d){case"FX":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,function(){console.debug("loaded "+b)},function(h){console.debug("Audio Error: "+h)});break;case"Audio":LowLatencyAudio["preload"+d](b,"resources/audio/"+b+c,3,function(){console.debug("loaded "+b)},function(h){console.debug("Audio Error: "+h)});break}};switch(d){case"Media":b=new Media((Ext.os.is("Android")?"/android_asset/www/":"")+"resources/audio/"+b+c,function(){f.sound_files[a].successCallback()},function(h){f.sound_files[a].successCallback();console.debug("Audio Error: "+h)});break;default:LowLatencyAudio.unload(b,g,g);break}}else{if(merchantMode){var e=Ext.get(b);if(e){e.dom.addEventListener("ended",function(){f.sound_files[a].successCallback()},false)}}}f.sound_files[a]={name:b,type:d}},openMainPage:Ext.emptyFn});Ext.define("Genesis.view.client.Accounts",{extend:Genesis.view.ViewBase,alias:"widget.clientaccountsview",config:{cls:"accountsMain viewport",layout:{type:"card",animation:{duration:400,easing:"ease-in-out",type:"slide",direction:"left"}},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",tag:"back",ui:"normal",text:"Back"},{align:"left",tag:"vback",hidden:true,ui:"normal",text:"Back"},{align:"right",ui:"normal",iconCls:"refresh",tag:"refresh"}]})]},showTransferHdr:false,cleanView:function(){this.removeAll(true);this.callParent(arguments)},createView:function(){var a=this;if(!a.callParent(arguments)){return}var b=1+Math.max(Genesis.constants.defaultIconSize(),Genesis.fn.calcPx(0.75,1)*4+Genesis.fn.calcPx(0.7*0.6,1));a.setPreRender(a.getPreRender().concat([Ext.create("Ext.List",{xtype:"list",store:"CustomerStore",tag:"accountsList",cls:"accountsList",plugins:[{type:"pullrefresh",refreshFn:function(c){a.fireEvent("refresh")}},{type:"listpaging",autoPaging:true,noMoreRecordsText:"",loadMoreText:""}],refreshHeightOnUpdate:false,variableHeights:false,itemHeight:Genesis.fn.calcPx(Genesis.fn.calcPxEm(b,(2*0.65),1),1),loadingText:null,deferEmptyText:false,emptyText:" ",pinHeaders:false,grouped:true,items:[{docked:"top",xtype:"toolbar",centered:false,tag:"transferHdr",hidden:!a.showTransferHdr,defaults:{iconMask:true},items:[{xtype:"title",title:"Select Account :"},{xtype:"spacer",align:"right"}]}],itemTpl:Ext.create("Ext.XTemplate",'<tpl if="this.isValidCustomer(values)">','<div class="photo x-hasbadge">',"{[this.isEligible(values)]}",'<img src="{[this.getPhoto(values)]}"/>',"</div>",'<div class="listItemDetailsWrapper {[this.isSingle(values)]}" style="position:relative;{[this.getDisclose(values)]}">','<tpl if="this.showRewardPoints(values)">','<div class="points">',"{[this.getRewardPoints(values)]}","</div>","</tpl>",'<tpl if="this.showPrizePoints(values)">','<div class="points">',"{[this.getPrizePoints(values)]}</div>","</tpl>","</div>","</tpl>",{getDisclose:function(e){var c="",d=e.merchant;e.disclosure=true;switch(a.mode){case"redeemPrizesProfile":if(d.features_config&&!d.features_config["enable_prizes"]){e.disclosure=false}c=((e.disclosure===false)?"padding-right:0;":"");break;case"redeemRewardsProfile":case"emailtransfer":case"transfer":case"profile":default:break}return c},isSingle:function(d){rc="";var c=d.merchant;switch(a.mode){case"redeemPrizesProfile":case"redeemRewardsProfile":case"emailtransfer":case"transfer":rc="single";break;case"profile":if(c.features_config&&!c.features_config["enable_prizes"]){rc="single"}break;default:break}return rc},getTitle:function(){return("Reward Points: <br/>Prize Points:")},isValidCustomer:function(c){return Customer.isValid(c.id)},isEligible:function(c){var d=false;switch(a.mode){case"redeemRewardsProfile":d=c.eligible_for_reward;break;case"redeemPrizesProfile":d=c.eligible_for_prize;break;case"profile":d=c.eligible_for_reward||c.eligible_for_prize;break;case"emailtransfer":case"transfer":default:break}return('<span class="x-badge round '+((d)?"":"x-item-hidden")+'">✔</span>')},getPhoto:function(c){return c.merchant.photo["thumbnail_medium_url"]},showRewardPoints:function(d){var c=true;switch(a.mode){case"redeemPrizesProfile":c=false;break;case"redeemRewardsProfile":case"emailtransfer":case"transfer":default:break}return c},getRewardPoints:function(c){return c.points+'<img src="'+Genesis.constants.getIconPath("miscicons","points")+'">'},showPrizePoints:function(e){var c=true,d=e.merchant;switch(a.mode){case"redeemRewardsProfile":case"emailtransfer":case"transfer":c=false;break;case"profile":if(d.features_config&&!d.features_config["enable_prizes"]){c=false}break;case"redeemPrizesProfile":default:break}return c},getPrizePoints:function(e){var c,d=e.merchant;switch(a.mode){case"redeemPrizesProfile":if(d.features_config&&!d.features_config["enable_prizes"]){c="Not Participating";break}case"redeemRewardsProfile":case"emailtransfer":case"transfer":case"profile":default:c=e.prize_points+'<img src="'+Genesis.constants.getIconPath("miscicons","prize_points")+'">';break}return c}}),onItemDisclosure:Ext.emptyFn}),Ext.create("Ext.List",{xtype:"list",store:"VenueStore",tag:"venuesList",loadingText:null,refreshHeightOnUpdate:false,variableHeights:false,deferEmptyText:false,itemHeight:Genesis.fn.calcPx(Genesis.fn.calcPxEm(Genesis.constants.defaultIconSize()+2,(2*0.65),1),1),cls:"venuesList",deferEmptyText:false,emptyText:" ",itemTpl:Ext.create("Ext.XTemplate",'<div class="listItemDetailsWrapper" style="padding-left:0;">','<div class="itemDistance">{[this.getDistance(values)]}</div><div class="itemTitle">{name}</div>','<div class="itemDesc">{[this.getAddress(values)]}</div>',"</div>",{getAddress:function(c){return(c.address+",<br/>"+c.city+", "+c.state+", "+c.country+",</br>"+c.zipcode)},getDistance:function(c){return((c.distance>0)?c.distance.toFixed(1)+"km":"")}}),onItemDisclosure:Ext.emptyFn})]))}});Ext.define("Genesis.view.widgets.Calculator",{extend:Ext.Container,alias:"widget.calculator",config:{title:null,bottomButtons:null,placeHolder:"0",hideZero:false,cls:"calculator",layout:"fit",items:[{height:"2.6em",docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:" "},{xtype:"spacer",align:"right"}]},{docked:"top",xtype:"textfield",name:"amount",value:"",clearIcon:false,placeHolder:" ",readOnly:true,required:true},{xtype:"container",layout:"vbox",tag:"dialpad",cls:"dialpad",defaults:{xtype:"container",layout:"hbox",flex:1,defaults:{xtype:"button",flex:1}},items:[{items:[{text:"1"},{text:"2"},{text:"3"}]},{items:[{text:"4"},{text:"5"},{text:"6"}]},{items:[{text:"7"},{text:"8"},{text:"9"}]},{items:[{text:"AC"},{tag:"zero",flex:2.3,text:"0"}]}]},{cls:"bottomButtons",xtype:"container",tag:"bottomButtons",docked:"bottom",layout:"hbox",defaults:{xtype:"button",flex:1}}]},initialize:function(){var d=this;var e=d.query("title")[0];var a=d.query("textfield")[0];var c=d.query("container[tag=bottomButtons]")[0];e.setTitle(d.getTitle());a.setPlaceHolder(d.getPlaceHolder());c.add(d.getBottomButtons());if(d.getHideZero()){var b=d.query("button[tag=zero]")[0];b.getParent().remove(b)}}});Ext.define("Genesis.view.client.AccountsTransfer",{extend:Genesis.view.ViewBase,alias:"widget.clientaccountstransferview",config:{tag:"accountsTransferMain",cls:"viewport accountsTransferMain",layout:"card",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{tag:"navigationBarTop",cls:"navigationBarTop kbTitle",title:" ",items:[{align:"left",tag:"back",ui:"normal",text:"Back"},{align:"left",tag:"close",ui:"normal",text:"Close"},{align:"left",tag:"calcClose",hidden:true,ui:"normal",text:"Close"}]})],listeners:[{element:"element",delegate:"div.listItemDetailsWrapper",event:"tap",fn:"onItemTap"}]},disableAnimation:true,onItemTap:function(d,c,b,a){_application.getController("client.Accounts").fireEvent("xferItemTap",d.delegatedTarget.getAttribute("data"))},createView:function(b,a){if(!this.callParent(arguments)){return}this.num=a;this.setPreRender(this.getPreRender().concat([Ext.create("Ext.Container",{xtype:"container",tag:"accountsTransferMode",cls:"accountsTransferMode",layout:"vbox",items:[{docked:"top",xtype:"toolbar",centered:false,defaults:{iconMask:true},items:[{xtype:"title",title:"Select Options :"},{xtype:"spacer",align:"right"}]},{xtype:"component",flex:1,scrollable:undefined,cls:"transferPanel",tag:"transferPanel",data:[{text:"Transfer Out",desc:"(Send it directly over to your friend's mobile phone)",cls:"sender",tag:"sender"},{text:"Email Transfer",desc:"(Send it over to your friend's email account)",cls:"emailsender",tag:"emailsender"},{text:"Receive",desc:"(Scan your friend's Transfer Code)",cls:"recipient",tag:"recipient"}],tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="listItemDetailsWrapper" data="{[this.encodeData(values)]}">','<div class="itemTitle {[this.getCls(values)]}">{[this.getTitle(values)]}</div>','<div class="itemDesc {[this.getCls(values)]}">{[this.getDesc(values)]}</div>',"</div>","</tpl>",{encodeData:function(c){return c.tag},getCls:function(c){return c.cls},getDesc:function(c){return c.desc},getTitle:function(c){return c.text}})}]}),{xtype:"calculator",tag:"accountsMainCalculator",cls:"accountsMainCalculator",title:"Points to Send",placeHolder:"0",bottomButtons:[{tag:"showQrCode",text:"Transfer Points!",ui:"orange-large"}]},Ext.create("Ext.Container",{xtype:"container",tag:"qrcodeContainer",cls:"qrcodeContainer",layout:"fit",items:[{docked:"top",xtype:"component",tag:"title",width:"100%",cls:"title",tpl:Ext.create("Ext.XTemplate","{[this.getPoints(values)]}",{getPoints:function(c){return c.points}})},{xtype:"component",tag:"qrcode",cls:"qrcode"},{docked:"bottom",xtype:"button",cls:"separator done",tag:"done",text:"Done!",ui:"orange-large"}]})]))},showView:function(){if(this.num){this.setActiveItem(this.num)}this.callParent(arguments)},inheritableStatics:{}});Ext.define("Genesis.controller.client.Accounts",{extend:Genesis.controller.ControllerBase,inheritableStatics:{},xtype:"accountsCntlr",config:{mode:"profile",routes:{accounts:"mainPage",etransfer:"emailTransferPage",transfer:"transferPage",selectTransfer:"selectTransferPage",transferComplete:"transferCompletePage"},refs:{aBB:"clientaccountsview button[tag=back]",avBB:"clientaccountsview button[tag=vback]",accounts:{selector:"clientaccountsview",autoCreate:true,xtype:"clientaccountsview"},accountsList:"clientaccountsview list[tag=accountsList]",venuesList:"clientaccountsview list[tag=venuesList]",transferHdr:"clientaccountsview toolbar[tag=transferHdr]",refreshBtn:"clientaccountsview button[tag=refresh]",atrCloseBB:"clientaccountstransferview button[tag=close]",atrCalcCloseBB:"clientaccountstransferview button[tag=calcClose]",atrBB:"clientaccountstransferview button[tag=back]",transferPage:{selector:"clientaccountstransferview",autoCreate:true,xtype:"clientaccountstransferview"},points:"clientaccountstransferview textfield",qrcodeContainer:"clientaccountstransferview component[tag=qrcodeContainer]",qrcode:"clientaccountstransferview component[tag=qrcode]",title:"clientaccountstransferview component[tag=title]",transferContainer:"clientaccountstransferview"},control:{accounts:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate",activeitemchange:"onItemChangeActivate",refresh:"onRefresh"},refreshBtn:{tap:"onRefresh"},accountsList:{select:"onSelect",disclose:"onDisclose"},venuesList:{select:"onVenueSelect",disclose:"onVenueDisclose"},avBB:{tap:"onAvBBTap"},transferPage:{showView:"onTransferShowView",activate:"onTransferActivate",deactivate:"onTransferDeactivate"},"clientaccountstransferview container[tag=accountsTransferMode] list":{select:"onTransferSelect"},"clientaccountstransferview container[tag=dialpad] button":{tap:"onCalcBtnTap"},"clientaccountstransferview button[tag=showQrCode]":{tap:"onShowQrCodeTap"},"clientaccountstransferview container button[tag=done]":{tap:"onTransferCompleteTap"},atrCalcCloseBB:{tap:"onTransferCompleteTap"}},listeners:{selectMerchant:"onDisclose",xferItemTap:"onTransferTap"}},qrcodeRegExp:/%qrcode_image%/,noTransferCodeMsg:"No Transfer Code was scanned",pointsReqMsg:"Points are required for transfer",startTransferMsg:"Prepare to scan the Sender's Transfer Code",transferFailedMsg:"Transfer operation did not complete",transferSavedMsg:"Transfer messasge was saved, but not sent.",transferSuccessMsg:function(){return"Your account information won't be updated until your next check-in."},xferWithinRangeMsg:function(b,a){return"Please enter a value between "+Genesis.constants.addCRLF()+b+" and "+a},noPtsXferMsg:function(){return"No Points were transferred."+Genesis.constants.addCRLF()+"Please Try Again."},recvTransferMsg:function(a,b){return"We have added "+a+" points "+Genesis.constants.addCRLF()+"towards your account at "+Genesis.constants.addCRLF()+b+"!"},xferCodeRecv:false,init:function(){var a=this;a.callParent(arguments);console.log("Accounts Init");a.callBackStack={callbacks:["onXferCodeRecv"],arguments:[],startIndex:0};a.getAccounts();backBtnCallbackListFn.push(function(c){if((c==a.getAccounts())&&(c.getActiveItem()!=a.getAccountsList())){var b=a.getViewPortCntlr();a.self.playSoundFile(b.sound_files.clickSound);a.onAvBBTap();return true}else{if(c==a.getTransferPage()){if(c.getActiveItem()==a.getQrcodeContainer()){c.setActiveItem(1)}else{a.onTransferCompleteTap()}return true}}return false})},onScannedQRcode:function(d){var c=this;var b=c.getViewport();var a=Ext.StoreMgr.get("CustomerStore");if(d){Ext.Viewport.setMasked({xtype:"loadmask",message:c.updatingServerMsg});Customer.setRecvPtsXferUrl();a.load({addRecords:true,jsonData:{},params:{data:d},callback:function(g,f){Ext.Viewport.setMasked(null);if(f.wasSuccessful()){var e=Customer.getProxy().getReader().metaData;Ext.device.Notification.show({title:"Transfer Received",message:c.recvTransferMsg(e.points,g[0].getMerchant().get("name")),buttons:["OK"],callback:function(h){c.resetView();c.redirectTo("accounts")}});c.persistSyncStores("CustomerStore")}}})}else{console.debug(c.noCodeScannedMsg);Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:"Error",message:c.noCodeScannedMsg,buttons:["Dismiss"]})}},onLocationUpdate:function(a){var c=this;var f=c.merchantId;var d=Ext.StoreMgr.get("VenueStore");var b=d.getProxy();var e={merchant_id:f};if(a){e=Ext.apply(e,{latitude:a.coords.getLatitude(),longitude:a.coords.getLongitude()})}Ext.Viewport.setMasked({xtype:"loadmask",message:c.getVenueInfoMsg});Venue.setFindNearestURL();d.load({scope:c,params:e,callback:function(i,h){Ext.Viewport.setMasked(null);if(h.wasSuccessful()){console.debug("Found "+i.length+" venues matching current location ...");if(i.length>1){var g=c.getAccounts();if(!g.isPainted()||g.isHidden()){console.debug("Opening Accounts Page ...");g.on("showView",function(){this.setActiveItem(1)},g,{single:true});c.redirectTo("accounts")}else{g.setActiveItem(1)}}else{c.getVenueMetaData(i[0])}}else{b.supressErrorsPopup=true;Ext.device.Notification.show({title:"Error",message:c.missingVenueInfoMsg(h.getError()),buttons:["Dismiss"],callback:function(){b.supressErrorsCallbackFn()}})}}})},onRefresh:function(){var a=this;Ext.Viewport.setMasked({xtype:"loadmask",message:a.establishConnectionMsg});Customer.setGetCustomersUrl();Ext.StoreMgr.get("CustomerStore").load({jsonData:{},callback:function(d,c){if(c.wasSuccessful()){var b=a.getApplication().getController("client.Checkins");b.fireEvent("setupCheckinInfo","checkin",null,null,null);a.persistSyncStores("CustomerStore")}Ext.Viewport.setMasked(null)}})},onShowView:function(c){if(Ext.os.is("Android")){var a=this.getEventDispatcher().getPublishers()["elementSize"].monitors;var b=c.query("list[tag=accountsList]")[0];console.debug("Refreshing CustomerStore ...");a[b.container.getId()].forceRefresh()}else{c.query("list[tag=accountsList]")[0].refresh()}},onActivate:function(h,i,b,d){var e=this;var g=e.getMode();var a=h.query("titlebar")[0];h.mode=g;switch(g){case"profile":a.setTitle("Accounts");a.removeCls("kbTitle");break;case"redeemRewardsProfile":a.setTitle("Rewards");a.removeCls("kbTitle");break;case"redeemPrizesProfile":a.setTitle("Prizes");a.removeCls("kbTitle");break;case"emailtransfer":case"transfer":a.setTitle(" ");a.addCls("kbTitle");var f=e.getTransferHdr();h.showTransferHdr=true;if(f){f.show()}break}if(h.getInnerItems().length>0){h.setActiveItem(0)}},onDeactivate:function(a,f,e,b){var d=this;d.getTransferHdr().hide()},onSelect:function(c,a,b){c.deselect([a]);this.onDisclose(c,a);return false},onDisclose:function(g,b,d,c,f,h){var i=this;var j=b.getId();var a=b.getMerchant();var k=i.getViewport();switch(i.getMode()){case"redeemPrizesProfile":if(a.get("features_config")&&!a.get("features_config")["enable_prizes"]){return}break;case"profile":case"redeemRewardsProfile":case"emailtransfer":case"transfer":default:break}i.self.playSoundFile(i.getViewPortCntlr().sound_files.clickSound);i.merchantId=a.getId();i.rec=b;switch(i.getMode()){case"profile":case"redeemRewardsProfile":case"redeemPrizesProfile":Ext.Viewport.setMasked({xtype:"loadmask",message:i.getMerchantInfoMsg});i.getGeoLocation();break;case"emailtransfer":case"transfer":if(b.get("points")<1){Ext.device.Notification.show({title:"Points Required",message:i.pointsReqMsg,buttons:["Dismiss"]});return}i.silentPopView(2);i.redirectTo("transferComplete");break}},onAvBBTap:function(a,d,c){this.getAccounts().setActiveItem(0)},onVenueSelect:function(c,a,b){c.deselect([a]);this.onVenueDisclose(c,a);return false},getVenueMetaData:function(h){var e=this;var g=h.getId();var b=e.getViewPortCntlr();var a,d,c;var f=e.rec;switch(e.getMode()){case"redeemPrizesProfile":c=e.getApplication().getController("client.Prizes");break;case"redeemRewardsProfile":c=e.getApplication().getController("client.Redemptions");break;case"profile":default:b.setVenue(h);c=e.getApplication().getController("client.Checkins");c.fireEvent("checkin");return;break}Ext.Viewport.setMasked({xtype:"loadmask",message:c.getRedeemInfoMsg()});a=Ext.StoreMgr.get(c.getRedeemStore());d=c.getRedeemUrl();path=c.getRedeemPath();CustomerReward[d]();a.load({jsonData:{},params:{venue_id:g},scope:e,callback:function(l,k){if(k.wasSuccessful()){Ext.Viewport.setMasked(null);var j={venue_id:g};for(var m=0;m<l.length;m++){l[m].handleInlineAssociationData({merchant:h.getMerchant().raw})}b.setVenue(h);switch(e.getMode()){case"redeemRewardsProfile":case"redeemPrizesProfile":default:c=e.getApplication().getController("client.Checkins");c.fireEvent("checkinMerchant","redemption",j,g,f,k,function(){e.redirectTo(path)});break}delete e.rec}else{if(!k.wasSuccessful()&&!j){Ext.Viewport.setMasked(null);console.log(e.metaDataMissingMsg)}}}})},onVenueDisclose:function(g,b,i,c,h,d){var f=this;var a=f.getViewPortCntlr();f.self.playSoundFile(a.sound_files.clickSound);f.getVenueMetaData(b)},onItemChangeActivate:function(h,g,b,d){var e=this;var a=e.getAccounts();var f=a.getLayout().getAnimation();if(Ext.isObject(g)){switch(g.config.tag){case"accountsList":f.setReverse(true);e.getABB().show();e.getAvBB().hide();break;case"venuesList":f.setReverse(false);e.getABB().hide();e.getAvBB().show();break}console.debug("Accounts onItemChangeActivate["+g.config.tag+"] Called.")}},sendEmailIOS:function(d,c,a){var b=this;window.plugins.emailComposer.showEmailComposerWithCB(function(e){console.log("Email callback response("+e+")");Ext.defer(function(){Ext.Viewport.setMasked(null);switch(e){case EmailComposer.ComposeResultType.Failed:case EmailComposer.ComposeResultType.NotSent:case EmailComposer.ComposeResultType.Cancelled:Ext.device.Notification.show({title:"Transfer Failed",message:b.transferFailedMsg,buttons:["Dismiss"],callback:function(){}});break;case EmailComposer.ComposeResultType.Saved:b.onTransferCompleteTap();Ext.device.Notification.show({title:"Trasfer Deferred",message:b.transferSavedMsg,buttons:["Dismiss"]});break;case EmailComposer.ComposeResultType.Sent:b.xferCodeRecv=true;b.onTransferCompleteTap();break}},1,b)},a,c,null,null,null,true,[d])},sendEmailAndroid:function(d,c,a){var b=this;b.sendEmailIOS.apply(b,arguments)},onXferCodeRecv:function(b){var e=this;switch(e.getMode()){case"transfer":e.xferCodeRecv=true;var a=e.getTransferContainer();var g=Genesis.controller.ControllerBase.genQRCode(b.data);var d=b.points||e.getPoints().getValue();console.debug("\nPoints - "+d);if(g[0]){e.getQrcode().setStyle({"background-image":"url("+g[0]+")","background-size":Genesis.fn.addUnit(g[1]*1.25)+" "+Genesis.fn.addUnit(g[2]*1.25)});e.getTitle().setData({points:d+" Pts"});a.setActiveItem(2)}Ext.Viewport.setMasked(null);break;case"emailtransfer":var g=b.data["qrcode"];var f=b.data["body"];var c=b.data["subject"];console.debug("\nSubject - "+c+"\n");g=Genesis.controller.ControllerBase.genQRCode(g)[0].replace("data:image/gif;base64,","");if(Ext.os.is("iOS")){e.sendEmailIOS(g,f,c)}else{if(Ext.os.is("Android")){e.sendEmailAndroid(g,f,c)}}break}return false},onTransferShowView:function(a){if(Ext.os.is("Android")){}},onTransferActivate:function(g,h,b,e){var f=this;var d=0;var a=f.getTransferContainer();switch(f.getMode()){case"redeemRewardsProfile":case"redeemPrizesProfile":case"profile":f.getAtrCloseBB().hide();f.getAtrCalcCloseBB().hide();f.getAtrBB().show();break;case"emailtransfer":case"transfer":f.getAtrCloseBB().hide();f.getAtrCalcCloseBB().show();f.getAtrBB().hide();if(b&&(b==f.getAccounts()&&!f.rec)){f.setMode("profile")}else{if(f.getPoints()){f.getPoints().setValue(null)}d=1}break}},onTransferDeactivate:function(b,g,f,d){var e=this;var a=e.getTransferContainer();if(a){a.setActiveItem(0)}},onTransferTap:function(b){var c=this;var a=c.getViewPortCntlr();c.self.playSoundFile(a.sound_files.clickSound);delete c.merchantId;delete c.rec;switch(b){case"sender":c.setMode("transfer");c.redirectTo("selectTransfer");break;case"emailsender":c.setMode("emailtransfer");c.redirectTo("selectTransfer");break;case"recipient":c.setMode("profile");Ext.device.Notification.show({title:"Start Transfer",message:c.startTransferMsg,buttons:["Proceed","Cancel"],callback:function(d){if(d.toLowerCase()=="proceed"){c.scanQRCode()}}});break}return false},onCalcBtnTap:function(h,a,c,i){var f=this;var d=f.getViewPortCntlr();var j=h.getText();var g=f.getPoints();var k=g.getValue()||"0";if(k.length<8){switch(j){case"AC":k=null;break;default:k=(k!="0")?k.concat(j):j;break}g.setValue(k)}},onShowQrCodeTap:function(a,j,d,i){var h=this;var c=Ext.StoreMgr.get("CustomerStore");var g=h.getPoints().getValue();var f;if((Number(g)>0)&&(Number(g)<=h.rec.get("points"))){switch(h.getMode()){case"transfer":f="direct";Ext.Viewport.setMasked({xtype:"loadmask",message:h.genQRCodeMsg});break;case"emailtransfer":f="email";Ext.Viewport.setMasked({xtype:"loadmask",message:h.retrieveAuthModeMsg});break}Customer.setSendPtsXferUrl();c.load({addRecords:true,jsonData:{},params:{merchant_id:h.merchantId,points:g,type:f},callback:function(k,e){var b=c.getProxy().getReader().metaData;if(e.wasSuccessful()&&(!b.data)){Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:"Error",message:h.noPtsXferMsg(),buttons:["Dismiss"]})}}})}else{Ext.device.Notification.show({title:"Error",message:h.xferWithinRangeMsg(1,h.rec.get("points")),buttons:["Dismiss"]})}},onTransferCompleteTap:function(a,g,c,f){var d=this;d.setMode("profile");if(d.xferCodeRecv){Ext.device.Notification.show({title:"Transfer Success!",message:d.transferSuccessMsg(),buttons:["OK"]})}d.popView();d.xferCodeRecv=false},mainPage:function(){this.openPage("profile")},emailTransferPage:function(){this.openPage("emailtransfer")},transferPage:function(){this.openPage("transfer")},selectTransferPage:function(){this.openMainPage()},transferCompletePage:function(){var b=this;var a=b.getTransferContainer();a.setActiveItem(1);b.setAnimationMode(b.self.animationMode.coverUp);b.pushView(b.getTransferPage())},redeemRewardsChooseSCPage:function(){this.openPage("redeemRewardsProfile")},redeemPrizesChooseSCPage:function(){this.openPage("redeemPrizesProfile")},openPage:function(a){var b=this,c;b.setAnimationMode(b.self.animationMode.cover);switch(a){case"emailtransfer":case"transfer":b.setMode("profile");c=b.getTransferPage();break;case"redeemPrizesProfile":case"redeemRewardsProfile":case"profile":default:b.setMode(a);c=b.getMainPage();break}b.pushView(c)},getMainPage:function(){var a=this.getAccounts();return a},openMainPage:function(){this.pushView(this.getMainPage());console.log("Accounts Page Opened")},isOpenAllowed:function(){return true}});Ext.define("Genesis.model.Badge",{extend:Ext.data.Model,id:"Badge",alternateClassName:"Badge",config:{idProperty:"id",fields:["id","type","visits","rank"],proxy:{type:"ajax",disableCaching:false,reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},inheritableStatics:{setGetBadgesUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/badges")}}});Ext.define("Genesis.view.client.Badges",{extend:Ext.Carousel,alias:"widget.clientbadgesview",config:{models:["Badge"],cls:"viewport",itemPerPage:12,preRender:null,direction:"horizontal",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Badges",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]})],listeners:[{element:"element",delegate:"div.itemWrapper",event:"tap",fn:"onItemTap"}]},initialize:function(){this.setPreRender([]);this.callParent(arguments)},onItemTap:function(f,d,b,a){var c=Ext.create("Genesis.model.Badge",Ext.decode(decodeURIComponent(f.delegatedTarget.getAttribute("data"))));this.fireEvent("itemTap",c)},cleanView:function(){this.removeAll(true);return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments)},removeAll:function(){var a=this;a.setPreRender([]);a.callParent(arguments)},createView:function(){var e=this,g=this;if(!Genesis.view.ViewBase.prototype.createView.apply(this,arguments)){return}Genesis.view.ViewBase.prototype.calcCarouselSize.apply(e,[2]);g.removeAll(true);var h=_application,a=h.getController(((merchantMode)?"server":"client")+".Viewport");var d=a.getViewport(),b=Ext.StoreMgr.get("BadgeStore").getRange(),f=Ext.Array.clone(b);for(var c=0;c<Math.ceil(f.length/e.getItemPerPage());c++){e.getPreRender().push({xtype:"component",cls:"badgesMenuSelections",tag:"badgesMenuSelections",scrollable:undefined,data:Ext.Array.pluck(f.slice(c*e.getItemPerPage(),((c+1)*e.getItemPerPage())),"data"),tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="itemWrapper" data="{[this.encodeData(values)]}">','<div class="photo"><img src="{[this.getPhoto(values)]}" /></div>','<div class="photoName">{[this.getName(values)]}</div>',"</div>","</tpl>",{encodeData:function(i){return encodeURIComponent(Ext.encode(i))},getName:function(i){return i.type.display_value},getPhoto:function(j){var k=j.type;var l=_application.getController(((merchantMode)?"server":"client")+".Viewport").getCustomer();var i=Ext.StoreMgr.get("BadgeStore").getById(l.get("badge_id"));var m=i.get("rank");return e.self.getPhoto((j.rank<=m)?k:"nobadge","thumbnail_medium_url")}})})}console.debug("Badge Icons Refreshed.")},showView:function(){var a=this;Genesis.view.ViewBase.prototype.showView.apply(this,arguments);if(a.getInnerItems().length>0){a.setActiveItem(0)}},inheritableStatics:{getPhoto:function(c,b){var a;switch(c){case"nobadge":if(b.match(/small/)){b="small"}else{if(b.match(/medium/)){b="medium"}else{b="large"}}a=Genesis.constants.getIconPath("badges",b+"/nobadge",false);break;default:a=c[b];break}return a}}});Ext.define("Genesis.view.widgets.ItemDetail",{extend:Genesis.view.ViewBase,alias:"widget.itemdetailview",config:{scrollable:undefined,itemXType:"item",cls:"itemDetailMain viewport",layout:{type:"vbox",pack:"center",align:"stretch"}},createView:function(){var b=this;if(!b.callParent(arguments)&&(b.getInnerItems().length>0)){var a=b.getInnerItems()[0];a.setData(b.item);a.updateItem(b.item)}else{b.setPreRender([{flex:1,xtype:b.getItemXType(),data:b.item}])}delete b.item}});Ext.define("Genesis.view.widgets.PopupItemDetail",{extend:Ext.Sheet,alias:"widget.popupitemdetailview",config:{models:["CustomerReward"],bottom:0,left:0,top:0,right:0,hideOnMaskTap:false,defaultUnit:"em",layout:{type:"vbox",pack:"middle"},defaults:{xtype:"container",defaultUnit:"em"}},constructor:function(b){var d=this;b=b||{};var c=b.buttons||[];delete b.buttons;var a=b.preItemsConfig||[];var e=b.postItemsConfig||[];delete b.preItemsConfig;delete b.postItemsConfig;Ext.merge(b,{items:[{preItemsConfig:a,postItemsConfig:e,iconType:b.iconType,flex:1,xtype:"popupitem",data:Ext.create("Genesis.model.CustomerReward",{title:b.title,type:{value:b.icon}})},{docked:"bottom",defaults:{xtype:"button",defaultUnit:"em"},padding:"0 1.0 1.0 1.0",items:c}]});delete b.iconType;delete b.icon;d.callParent(arguments)}});Ext.define("Genesis.view.widgets.Item",{extend:Ext.Container,xtype:"item",alias:"widget.item",config:{cls:"item",tag:"item",layout:"fit"},constructor:function(c){var d=this;c=c||{};d.config.preItemsConfig=d.config.preItemsConfig||[];d.config.postItemsConfig=d.config.postItemsConfig||[];d.config.photoTemplate=d.config.photoTemplate||null;var a=c.preItemsConfig||[];var e=c.postItemsConfig||[];var b=c.photoTemplate||d.config.photoTemplate;Ext.merge(a,d.config.preItemsConfig);Ext.merge(e,d.config.postItemsConfig);delete c.preItemsConfig;delete c.postItemsConfig;delete c.photoTemplate;Ext.merge(c,{items:[{docked:"top",xtype:"component",tag:"title",cls:"title",defaultUnit:"em",tpl:Ext.create("Ext.XTemplate","{[this.getDescription(values)]}",{getDescription:function(f){return f.title}})}].concat(a,[{xtype:"component",tag:"itemPhoto",cls:"itemPhoto",tpl:(b)?b:Ext.create("Ext.XTemplate",'<div class="photoVCenterHelper"></div>','<div class="photoVCenterContent"><img {[this.getPhoto(values)]} /></div>',{getPhoto:function(f){var g=f.photo;if(Ext.isString(g)){return'src="'+g+'"'}else{return'src="'+g.url+'" '+((g.width)?'style="width:'+Genesis.fn.addUnit(g.width)+";height:"+Genesis.fn.addUnit(g.height)+';"':"")}}})}],e)});this.callParent(arguments)},initialize:function(){this.callParent(arguments);this.updateItem(this.getData())},updateItem:function(d){var c=this;var b=d.raw;var a=c.query("component[tag=itemPhoto]")[0];var e=c.query("component[tag=title]")[0];if(b.title){e.setData(b);e.show()}else{e.hide()}a.setData(b);c.setData(d);return b},inheritableStatics:{}});Ext.define("Genesis.view.widgets.RedeemItem",{extend:Genesis.view.widgets.Item,xtype:"redeemitem",alias:"widget.redeemitem",config:{iconType:"prizewon",hideMerchant:false,cls:"item redeemItem",tag:"redeemItem",layout:"fit",postItemsConfig:[{docked:"bottom",xtype:"component",hidden:true,tag:"itemPoints",cls:"itemPoints",tpl:Ext.create("Ext.XTemplate","{[this.getPoints(values)]}",{getPoints:function(a){return((a.points>0)?a.points+"  Pts":" ")}})},{docked:"bottom",xtype:"component",tag:"info",cls:"info",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div><div class="infoWrapper"><div class="name">{[this.getName(values)]}</div><div class="disclaimer">{[this.getDisclaimer(values)]}</div><div class="date">{[this.getExpiryDate(values)]}</div></div>',{getExpiryDate:function(a){var b=a.get("time_limited");return((b)?"Offer Expires: "+a.get("expiry_date"):"")},getDisclaimer:function(a){var c=(a.get("quantity_limited"))?"<b>Quantity : "+a.get("quantity")+"</b><br/>":"Limited Quantities. ";var b=a.getMerchant().get("reward_terms")||"";return(c+b)},getPhoto:function(a){return a.getMerchant().get("photo")["thumbnail_medium_url"]},getName:function(a){return a.getMerchant().get("name")}})}]},constructor:function(a){var b=this;a=Ext.merge({photoTemplate:Ext.create("Ext.XTemplate",'<div class="photoVCenterHelper"></div>','<div class="photoVCenterContent"><img {[this.getPhoto(values)]} /></div>','<div class="itemPoints {[this.isVisible(values)]}">{[this.getPoints(values)]}</div>',{getPhoto:function(c){var e=Genesis.constants._thumbnailAttribPrefix+"large";var d=(c.photo&&c.photo[e])?c.photo[e]:b.self.getPhoto(c.type,b.getIconType());if(Ext.isString(d)){return'src="'+d+'"'}else{return'src="'+d.url+'" '+((d.width)?'style="width:'+Genesis.fn.addUnit(d.width)+";height:"+Genesis.fn.addUnit(d.height)+';"':"")}},isVisible:function(c){return((c.merchant)?"":"x-item-hidden")},getPoints:function(c){return((c.points>0)?c.points+"  Pts":" ")}})},a);this.callParent(arguments)},updateItem:function(d){var c=this;var b=d.raw;var e=c.query("component[tag=info]")[0];var a=c.query("component[tag=itemPoints]")[0];if(b.merchant&&!c.getHideMerchant()){e.setData(d);e.show();a.setData({points:0})}else{e.hide();a.setData(b);a.show()}c.callParent(arguments)},inheritableStatics:{getPhoto:function(b,a){var c=null;switch(b.value){case"earn_points":case"promotion":break;default:c=Genesis.constants.getIconPath(a,b.value);break}return c}}});Ext.define("Genesis.view.widgets.PopupItem",{extend:Genesis.view.widgets.Item,xtype:"popupitem",alias:"widget.popupitem",config:{iconType:null},constructor:function(a){var b=this;Ext.merge(a,{tag:"popupItem",photoTemplate:Ext.create("Ext.XTemplate",'<div class="photoVCenterHelper"></div>','<div class="photoVCenterContent"><img {[this.getPhoto(values)]} /></div>',{getPhoto:function(c){var d=b.self.getPhoto(c.type,b.getIconType());return'src="'+d+'"'}})});b.callParent(arguments)},inheritableStatics:{getPhoto:function(b,a){var c=Genesis.constants.getIconPath(a,b.value);return c}}});Ext.define("Genesis.view.widgets.client.RedeemItemDetail",{extend:Genesis.view.widgets.ItemDetail,alias:"widget.clientredeemitemdetailview",config:{itemXType:"redeemitem",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Prizes",items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{hidden:true,align:"left",tag:"back",ui:"normal",text:"Back"},{align:"right",tag:"redeem",text:"Redeem"},{align:"right",hidden:true,tag:"done",text:"Done"}]})],listeners:[{element:"element",delegate:"div.itemPhoto",event:"tap",fn:"onRedeemItemTap"}]},onRedeemItemTap:function(c,g,d){var f=this,a=_application.getController("client.Viewport");a.self.playSoundFile(a.sound_files.clickSound);f.fireEvent("redeemItemTap",null)}});Ext.define("Genesis.view.widgets.client.PromotionItem",{extend:Genesis.view.widgets.client.RedeemItemDetail,alias:"widget.clientpromotionalitemview",config:{layout:"fit",items:[{xtype:"titlebar",docked:"top",tag:"navigationBarTop",cls:"navigationBarTop",title:" ",defaults:{iconMask:true},items:[{align:"left",hidden:true,tag:"back",ui:"normal",text:"Back"},{align:"right",tag:"done",text:"Done"}]}]},onRedeemItemTap:function(c,g,d){var f=this,a=_application.getController("client.Viewport");a.self.playSoundFile(a.sound_files.clickSound);f.fireEvent("promoteItemTap",null)}});Ext.define("Genesis.controller.client.Badges",{extend:Genesis.controller.ControllerBase,inheritableStatics:{},xtype:"clientbadgesCntlr",config:{routes:{badges:"mainPage",badgeDesc:"badgeDescPage"},models:["CustomerReward","Badge","Customer","Merchant"],refs:{main:{selector:"clientbadgesview",autoCreate:true,xtype:"clientbadgesview"},mainCarousel:"clientbadgesview",badgeDesc:{selector:"clientpromotionalitemview[tag=badgeDesc]",autoCreate:true,tag:"badgeDesc",xtype:"clientpromotionalitemview"}},control:{main:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate",itemTap:"onItemTap"},badgeDesc:{createView:"onBadgeDescCreateView",activate:"onBadgeDescActivate",deactivate:"onBadgeDescDeactivate",promoteItemTap:"onPromoteItemTap"}}},badgeLevelNotAchievedMsg:function(){return("You have achieved this"+Genesis.constants.addCRLF()+"badge level yet!")},init:function(b){var a=this;a.callParent(arguments);Ext.regStore("BadgeStore",{model:"Genesis.model.Badge",autoLoad:false,sorters:[{property:"rank",direction:"ASC"}],listeners:{scope:a,load:function(e,d,g,c,f){}}});Ext.Viewport.on("orientationchange",function(f,e,h,c,g){var d=a.getMain(),i=a.getViewport();if(d==i.getActiveItem()){a.refreshPage(d)}});console.log("Badges Init");a.getMain()},onPromoteItemTap:function(a,f,c,d){},onShowView:function(b){if(Ext.os.is("Android")){var a=this.getEventDispatcher().getPublishers()["elementSize"].monitors;a[b.element.getId()].forceRefresh();console.debug("Refreshing BadgesPage ...")}},onActivate:function(d,e,a,b){},onDeactivate:function(a,e,d,b){},onBadgeDescCreateView:function(b){var a=this;b.item=a.item},onBadgeDescActivate:function(f,g,b,d){var e=this;var a=f.query("titlebar")[0];f.query("button[tag=back]")[0].show();f.query("button[tag=done]")[0].hide();a.setTitle("Badge Promotion")},onBadgeDescDeactivate:function(d,e,a,b){},onItemTap:function(d){var h=this;var g=h.getViewPortCntlr();h.self.playSoundFile(g.sound_files.clickSound);var f=g.getCustomer();var i=d;var b=i.get("rank");var a=Ext.StoreMgr.get("BadgeStore").getById(f.get("badge_id"));var j=a.get("rank");if(b<=j){var e=Genesis.constants._thumbnailAttribPrefix+"large";var c={};c[e]=Genesis.view.client.Badges.getPhoto(i.get("type"),"thumbnail_large_url");h.item=Ext.create("Genesis.model.CustomerReward",{title:i.get("type").display_value,type:{value:"promotion"},photo:c,time_limited:false,quantity_limited:false,merchant:null});h.redirectTo("badgeDesc")}else{Ext.device.Notification.show({title:"Badges",message:h.badgeLevelNotAchievedMsg(),buttons:["Dismiss"]})}return false},badgeDescPage:function(){this.openPage("badgeDesc")},mainPage:function(){this.openPage("main")},openPage:function(a){var b=this;switch(a){case"badgeDesc":b.setAnimationMode(b.self.animationMode.cover);b.pushView(b.getBadgeDesc());break;case"main":b.setAnimationMode(b.self.animationMode.coverUp);b.pushView(b.getMainPage());break}},getMainPage:function(){var a=this.getMain();return a},openMainPage:function(){var a=this.getViewPortCntlr();this.setAnimationMode(this.self.animationMode.cover);this.pushView(this.getMainPage());console.log("Badges Page Opened")},isOpenAllowed:function(){return true}});Ext.define("Genesis.view.client.ChallengePage",{extend:Genesis.view.ViewBase,alias:"widget.clientchallengepageview",config:{models:["Challenge"],itemPerPage:6,layout:"fit",cls:"viewport",scrollable:undefined,items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Challenges",items:[{align:"left",ui:"normal",tag:"close",text:"Close"}]}),{xtype:"carousel",cls:"challengePageItem shadows",direction:"horizontal"},{docked:"bottom",cls:"challengeContainer",tag:"challengeContainer",hidden:true,xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"button",iconCls:"dochallenges",iconMask:true,tag:"doit",text:"Lets do it!"}]},{docked:"bottom",xtype:"container",tag:"challengePageItemDescWrapper",cls:"challengePageItemDescWrapper",layout:{type:"vbox",align:"stretch",pack:"start"},defaults:{xtype:"component"},items:[{cls:"itemDesc",data:{description:""},tpl:Ext.create("Ext.XTemplate","{[this.getDesc(values)]}",{getDesc:function(a){return a.description}})}]}],listeners:[{element:"element",delegate:"div.itemWrapper",event:"tap",fn:"onItemTap"}]},takePhoto:function(){if(!this.photoAction){this.photoAction=Ext.create("Ext.ActionSheet",{hideOnMaskTap:false,defaults:{defaultUnit:"em",margin:"0 0 0.5 0",xtype:"button",handler:Ext.emptyFn},items:[{text:"Use Photo from Library",tag:"library"},{text:"Use Photo from Photo Album",tag:"album"},{text:"Take a Picture",tag:"camera"},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",scope:this,handler:function(){this.photoAction.hide()}}]});Ext.Viewport.add(this.photoAction)}this.photoAction.show()},deselectItems:function(){var c=this.query("carousel")[0];var a=Ext.DomQuery.select("div.itemWrapper",c.element.dom);for(var b=0;b<a.length;b++){Ext.get(a).removeCls("x-item-selected")}},onItemTap:function(h,g,d,c){this.deselectItems();var b=Ext.get(h.delegatedTarget);b.addCls("x-item-selected");var f=Ext.create("Genesis.model.Challenge",Ext.decode(decodeURIComponent(h.delegatedTarget.getAttribute("data"))));var a=(_build=="MobileWebClient");_application.getController(((a)?"mobileClient":"client")+".Challenges").fireEvent("itemTap",f)},cleanView:function(){this.removeAll(true);this.callParent(arguments)},removeAll:function(a,b){var c=this.query("carousel")[0];return c.removeAll(true)},_createView:function(f,a){var e=this;if(_build=="MobileWebClient"){for(var c=0;c<a.length;c++){var d=a[c];switch(d.get("type").value){case"photo":case"referral":var b=a.indexOf(d);a.splice(b,1);if(b==c){c--}break}}}switch(Ext.Viewport.getOrientation()){case"landscape":e.setItemPerPage(4);break;default:e.calcCarouselSize();break}f.removeAll(true);for(var c=0;c<Math.ceil(a.length/e.getItemPerPage());c++){f.add({xtype:"component",cls:"challengeMenuSelections",tag:"challengeMenuSelections",scrollable:undefined,data:Ext.Array.pluck(a.slice(c*e.getItemPerPage(),((c+1)*e.getItemPerPage())),"data"),tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="itemWrapper x-hasbadge" data="{[this.encodeData(values)]}">','<span class="x-badge round">{[this.getPoints(values)]}</span>','<div class="photo"><img src="{[this.getPhoto(values)]}" /></div>','<div class="photoName">{name}</div>',"</div>","</tpl>",{encodeData:function(g){return encodeURIComponent(Ext.encode(g))},getPoints:function(g){return g.points+" Points"},getPhoto:function(g){if(!g.photo||!g.photo.url){return e.self.getPhoto(g.type)}return g.photo.url}})})}console.debug("ChallengePage Icons Updated.")},createView:function(){var e=this.query("carousel")[0];var a=_application.getController(((merchantMode)?"server":"client")+".Viewport").getVenue();var f=a.getId();var b=a.challenges().getRange();var c=Ext.DomQuery.select("div.itemWrapper",e.element.dom)[0];if((e.getInnerItems().length>0)&&c){var d=Ext.create("Genesis.model.Challenge",Ext.decode(decodeURIComponent(c.getAttribute("data"))));if(d.getId()==b[0].getId()){this.deselectItems();console.debug("ChallengePage Icons Refreshed.")}else{this._createView(e,b)}}else{this._createView(e,b)}this.callParent(arguments);if(e.getInnerItems().length>0){e.setActiveItem(0)}},inheritableStatics:{getPhoto:function(a){var b=null;var c=a.value;switch(c){case"custom":c="mystery";default:b=Genesis.constants.getIconPath("mainicons",c);break}return b}}});Ext.define("Genesis.controller.mobileClient.Challenges",{extend:Genesis.controller.ControllerBase,inheritableStatics:{},xtype:"clientChallengesCntlr",config:{routes:{challenges:"challengesPage"},refs:{challengeBtn:"clientchallengepageview button[tag=doit]",challengePage:{selector:"clientchallengepageview",autoCreate:true,xtype:"clientchallengepageview"},challengeContainer:"clientchallengepageview container[tag=challengeContainer]",challengeDescContainer:"clientchallengepageview container[tag=challengePageItemDescWrapper]"},control:{challengePage:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"},"clientchallengepageview > carousel dataview":{select:"onItemSelect"},challengeBtn:{tap:"onChallengeBtnTap"}},listeners:{challengecomplete:"onChallengeComplete",doChallenge:"onChallengeBtnTap",itemTap:"onItemTap"}},metaData:null,defaultDescText:"Please Select a challenge to perform",samplePhotoURL:"http://photos.getkickbak.com/paella9finish1.jpg",checkinFirstMsg:"Please Check-In before performing challenges",completingChallengeMsg:"Completing Challenge ...",updateAccountInfoMsg:"Your Birthday information is missing. Update your Account Settings to continue.",getPointsMsg:function(a,b){return"You have earned "+a+" Pts from this challenge!"},getConsolationMsg:function(a){return a+Genesis.constants.addCRLF()+"Try our other challenges as well!"},visitFirstMsg:"You must visit this establishment first before you are eligible to do this Challenge",init:function(b){var a=this;this.callParent(arguments);if(Ext.os.is("Phone")){Ext.Viewport.on("orientationchange",function(e,d,g,c,f){var i=a.getChallengePage(),h=a.getViewport();if(i==h.getActiveItem()){a.refreshPage(i)}})}console.log("Challenge Init");a.getChallengePage()},challengeItemFn:function(c,a,g,b,h,d){var f=this,e=f.getViewPortCntlr(),c,i=e.getCustomer().getId();if(!b){}else{c=Ext.apply(c,{venue_id:b})}if(h){c=Ext.apply(c,{data:h})}else{c=Ext.apply(c,{data:f.self.encryptFromParams({frequency:f.identifiers.localID})})}console.debug("Transmitting Completing Challenge ID("+a+")");Challenge.load(a,{jsonData:{},params:c,callback:function(k,l){var j=Challenge.getProxy().getReader().metaData;console.debug("Challenge Completed("+l.wasSuccessful()+")");if(f.identifiers){f.identifiers.cancelFn()}Ext.Viewport.setMasked(null);if(l.wasSuccessful()&&j){Ext.device.Notification.beep();f.fireEvent("challengecomplete",g,h,b,i,d)}}})},vipEventHandler:function(a){this.completeChallenge(null,a)},onLocationUpdate:function(a){var b=this;b.metaData={position:a};switch(b.selectedItem.get("type").value){case"vip":b.vipEventHandler(a);break;case"menu":case"birthday":case"custom":b.completeChallenge(null,a);break;default:break}},onChallengeComplete:function(g,j,c,k,d,e,h){var f=this;var a=Challenge.getProxy().getReader().metaData;switch(g){case"vip":Ext.device.Notification.show({title:"VIP Challenge",message:f.getConsolationMsg(a.message),buttons:["OK"]});f.fireEvent("updatemetadata",a);break;default:var i=a.account_info;var b=a.reward_info;Ext.device.Notification.show({title:"Completed Challenge!",message:((b.points>0)?f.getPointsMsg(b.points,i.points):f.getConsolationMsg(a.message)),buttons:["OK"]});f.fireEvent("updatemetadata",a);break}},onItemTap:function(c){var d=this,a=d.getViewPortCntlr(),b=Genesis.db.getLocalDB();d.self.playSoundFile(a.sound_files.clickSound);var f=d.getChallengeDescContainer();Ext.Anim.run(f.element,"fade",{duration:600,out:false,autoClear:true,scope:d,before:function(){for(var g=0;g<f.getItems().length;g++){f.getItems().getAt(g).updateData(c.getData())}d.selectedItem=c}});switch(c.get("type").value){case"facebook":var e=(b.enableFB&&(b.currFbId>0))||!Genesis.fn.isNative();d.getChallengeContainer()[e?"hide":"show"]();break;case"birthday":d.getChallengeContainer()["hide"]();if(!b.account.birthday){Ext.device.Notification.show({title:d.selectedItem.get("name").capitalize()+" Challenge",message:d.updateAccountInfoMsg,buttons:["OK","Cancel"],callback:function(g){if(g.toLowerCase()=="ok"){d.redirectTo("settings")}}})}break;default:d.getChallengeContainer()["show"]();break}return true},onChallengeBtnTap:function(l,g,h,m){var k=this,n=Genesis.db.getLocalDB();var i=k.getViewPortCntlr();var j=i.getCheckinInfo().venue;var a=i.getVenue();var c=k.selectedItem;if(c){switch(c.get("type").value){default:if(!(j&&a&&(j.getId()==a.getId()))){Ext.device.Notification.show({title:"Error",message:k.checkinFirstMsg,buttons:["Dismiss"]});return true}break}switch(c.get("type").value){case"birthday":break;case"facebook":var f=k.getApplication().getController("client.Settings");f.updateFBSettingsPopup(c.get("name")+" Challenge",null);break;case"menu":case"vip":case"custom":if(c.get("require_verif")){var d=function(){if(!k._actions){k._actions=Ext.create("Genesis.view.widgets.PopupItemDetail",{iconType:"prizewon",icon:"phoneInHand",title:k.showToServerMsg(),buttons:[{margin:"0 0 0.5 0",text:"Proceed",ui:"action",height:"3em",handler:function(){i.popUpInProgress=false;k._actions.hide();if(c.get("type").value=="photo"){k.getGeoLocation()}else{k.onLocationUpdate(null)}}},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",height:"3em",handler:function(){i.popUpInProgress=false;k._actions.hide()}}]});Ext.Viewport.add(k._actions)}i.popUpInProgress=true;k._actions.show()};if(Genesis.fn.isNative()){Ext.Viewport.setMasked({xtype:"loadmask",message:k.prepareToSendMerchantDeviceMsg});window.plugins.proximityID.preLoadSend(function(){Ext.Viewport.setMasked(null);d()})}else{d()}}else{k.onLocationUpdate(null)}break}}},onShowView:function(a){if(Ext.os.is("Android")){console.debug("Refreshing Challenge Main Page ...")}},onActivate:function(e,f,a,b){var d=this;Ext.defer(function(){var g=d.getChallengeDescContainer();for(var c=0;c<g.getItems().length;c++){g.getItems().getAt(c).updateData({description:d.defaultDescText});d.getChallengeContainer().hide()}},1,e);delete d.selectedItem},onDeactivate:function(a,e,d,b){},completeChallenge:function(j,d,e,i){var h=this,f=h.getViewPortCntlr(),c,k=Genesis.db.getLocalDB(),b=f.getVenue(),a=b.getId();h.identifiers=null;if(h.selectedItem){c={venue_id:a};if(d){c=Ext.apply(c,{latitude:d.coords.getLatitude(),longitude:d.coords.getLongitude()})}Challenge.setCompleteChallengeURL(h.selectedItem.getId());var g=Genesis.fn.privKey={venueId:a,venue:b.get("name")};g["r"+a]=g["p"+a]=k.csrf_code;h.broadcastLocalID(function(l){h.identifiers=l;Ext.Viewport.setMasked({xtype:"mask",cls:"transmit-mask",html:h.lookingForMerchantDeviceMsg(),listeners:{tap:function(m,o,n){if(!Ext.get(Ext.DomQuery.select(".x-innerhtml",m.element.dom)[0]).getPageBox(true).isOutOfBound({x:o.pageX,y:o.pageY})){Ext.Ajax.abort();if(h.identifiers){h.identifiers.cancelFn()}Ext.Viewport.setMasked(null);h.onDoneTap();Ext.device.Notification.show({title:h.selectedItem.get("name").capitalize()+" Challenge",message:h.transactionCancelledMsg,buttons:["Dismiss"]})}}}});console.debug("Broadcast underway ...");h.challengeItemFn(c,h.selectedItem.getId(),h.selectedItem.get("type").value,a,j,d)},function(){Ext.Viewport.setMasked(null)})}},challengesPage:function(){this.setAnimationMode(this.self.animationMode.coverUp);this.pushView(this.getMainPage())},openPage:function(b,a){var c=this;switch(b){default:break}},getMainPage:function(){var a=this.getChallengePage();return a},openMainPage:function(){this.redirectTo("challenges");console.log("Client ChallengePage Opened")},isOpenAllowed:function(){return true}});Ext.define("Genesis.view.client.UploadPhotosPage",{extend:Genesis.view.ViewBase,alias:"widget.clientuploadphotospageview",scrollable:"vertical",config:{cls:"photoUploadPage",layout:"vbox",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Photo Upload",items:[{align:"right",tag:"post",text:"Post"}]}),{xtype:"textareafield",labelAlign:"top",bottom:0,left:0,right:0,name:"desc",tag:"desc",cls:"desc",autoComplete:true,defaultUnit:"em",autoCorrect:true,autoCapitalize:true,maxLength:256,maxRows:4,placeHolder:"Please enter your photo description",clearIcon:false}]},showView:function(){this.callParent(arguments);console.debug("Rendering ["+this.metaData.photo_url+"]");this.query("container[tag=background]")[0].element.dom.style.cssText+="background-image:url("+this.metaData.photo_url+");";delete this.metaData},createView:function(){if(!this.callParent(arguments)){return}this.setPreRender(this.getPreRender().concat([photo=Ext.create("Ext.Container",{flex:1,width:"100%",xtype:"container",tag:"background",cls:"background"})]))}});Ext.define("Genesis.view.client.CheckinExplore",{extend:Genesis.view.ViewBase,alias:"widget.clientcheckinexploreview",config:{layout:"fit",cls:"viewport",merchant:null,items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",ui:"normal",iconCls:"home",tag:"home"},{align:"right",ui:"normal",iconCls:"refresh",tag:"refresh"}]}),{docked:"bottom",hidden:true,cls:"toolbarBottom",tag:"toolbarBottom",xtype:"container",layout:{type:"vbox",pack:"center"},items:[{xtype:"segmentedbutton",allowMultiple:false,defaults:{iconMask:true,ui:"blue",flex:1},items:[{iconCls:"rewards",tag:"rewardsSC",text:"Earn Points"}],listeners:{toggle:function(a,b,c){a.setPressedButtons([])}}}]}]},disableAnimation:true,createView:function(){var a=this;if(!a.callParent(arguments)){return}var b=1+Math.max(Genesis.constants.defaultIconSize(),Genesis.fn.calcPx(0.75,1)*4+Genesis.fn.calcPx(0.7*0.6,1));a.getPreRender().push(Ext.create("Ext.List",{xtype:"list",store:"CheckinExploreStore",loadingText:null,plugins:[{type:"pullrefresh",refreshFn:function(c){a.fireEvent("exploreLoad",true)}},{type:"listpaging",autoPaging:true,loadMoreText:"",noMoreRecordsText:""}],refreshHeightOnUpdate:false,variableHeights:false,deferEmptyText:false,itemHeight:Genesis.fn.calcPx(Genesis.fn.calcPxEm(b,(2*0.65),1),1),emptyText:" ",tag:"checkInExploreList",cls:"checkInExploreList",itemTpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div><div class="listItemDetailsWrapper"><div class="itemDistance">{[this.getDistance(values)]}</div><div class="itemTitle">{name}</div><div class="itemDesc">{[this.getAddress(values)]}</div></div>',{getPhoto:function(c){return c.Merchant.photo["thumbnail_medium_url"]},getAddress:function(c){return(c.address+",<br/>"+c.city+", "+c.state+", "+c.country+",<br/>"+c.zipcode)},getDistance:function(c){return((c.distance>0)?c.distance.toFixed(1)+"km":"")}}),onItemDisclosure:Ext.emptyFn}))}});Ext.define("Genesis.controller.client.Checkins",{extend:Genesis.controller.ControllerBase,inheritableStatics:{},xtype:"clientcheckinsCntlr",config:{models:["Venue"],routes:{exploreS:"explorePageUp",explore:"explorePage",checkin:"checkinPage"},refs:{exploreList:"clientcheckinexploreview list",explore:{selector:"clientcheckinexploreview",autoCreate:true,xtype:"clientcheckinexploreview"},toolbarBottom:"clientcheckinexploreview container[tag=toolbarBottom]",shareBtn:"viewportview button[tag=shareBtn]",refreshBtn:"clientcheckinexploreview button[tag=refresh]",login:"loginpageview"},control:{explore:{showView:"onExploreShowView",activate:"onExploreActivate",deactivate:"onExploreDeactivate",exploreLoad:"onExploreLoad"},refreshBtn:{tap:"onRefreshTap"},exploreList:{select:"onExploreSelect",disclose:"onExploreDisclose"},login:{activate:"onLoginActivate"}},listeners:{checkin:"onCheckinTap",explore:"onNonCheckinTap",checkinScan:"onCheckinScanTap",checkinMerchant:"onCheckinHandler",setupCheckinInfo:"onSetupCheckinInfo",exploreLoad:"onExploreLoad"},position:null},metaDataMissingMsg:"Missing Checkin MetaData information.",noCheckinCodeMsg:"No Checkin Code found!",init:function(){var a=this;Ext.regStore("CheckinExploreStore",{model:"Genesis.model.Venue",autoLoad:false,sorters:[{property:"distance",direction:"ASC"}],listeners:{metachange:function(b,d,c){if(b.isLoading()){a.fireEvent("updatemetadata",d.getReader().metaData)}}}});a.callParent(arguments);console.log("Checkins Init");a.getExplore();backBtnCallbackListFn.push(function(c){if(c==a.getExplore()){var b=a.getViewPortCntlr();a.self.playSoundFile(b.sound_files.clickSound);b.goToMain();return true}return false})},checkinCommon:function(i){var h=this;var c=Ext.StoreMgr.get("CustomerStore");var f=h.callback.mode;var a=h.callback.url;var e=h.callback.position;var j=h.callback.callback;var g=h.getViewPortCntlr();var b=null;switch(h.callback.url){case"setVenueScanCheckinUrl":break;default:b=(g.getVenue()?g.getVenue().getId():null);break}Customer[a](b);var d={latitude:(e)?e.coords.getLatitude():0,longitude:(e)?e.coords.getLongitude():0,auth_code:i||0};if(b){d=Ext.apply(d,{venue_id:b})}console.debug("CheckIn - auth_code:'"+i+"' venue_id:'"+b+"'");c.load({addRecords:true,jsonData:{},params:d,scope:h,callback:function(m,l){var k=Customer.getProxy().getReader().metaData;if(l.wasSuccessful()&&k){h.fireEvent("checkinMerchant",f,k,b,m[0],l,j)}else{if(!l.wasSuccessful()&&!k){console.debug(h.metaDataMissingMsg)}}}})},onScannedQRcode:function(b){var a=this;if(b){console.debug(a.checkinMsg);Ext.Viewport.setMasked({xtype:"loadmask",message:a.checkinMsg});a.checkinCommon(b)}else{console.debug(a.noCheckinCodeMsg);Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:"Error",message:a.noCheckinCodeMsg,buttons:["Dismiss"]})}},onCheckInScanNow:function(i,d,f,j,c,a,h,k){var g=this;switch(h){case"scan":g.callback={mode:c,position:g.getPosition(),url:a,type:h,callback:k};g.scanQRCode();break;default:g.callback={mode:c,position:g.getPosition(),url:a,type:"",callback:k};Ext.Viewport.setMasked({xtype:"loadmask",message:g.getMerchantInfoMsg});g.checkinCommon(null);break}g.setPosition(null)},onSetupCheckinInfo:function(e,d,c,b){var a=this.getViewPortCntlr();a.setVenue(d);a.setCustomer(c);a.setMetaData(b);switch(e){case"checkin":a.setCheckinInfo({venue:a.getVenue(),customer:a.getCustomer(),metaData:a.getMetaData()});break;case"explore":case"redemption":default:break}},onCheckinScanTap:function(a,d,c,f){this.onCheckInScanNow(a,d,c,f,"checkin","setVenueScanCheckinUrl","scan",Ext.emptyFn)},onCheckinTap:function(d){var b=this;if(d){var a=b.getApplication().getController("client.Merchants");var c=a.getMain();c.promotion=true}b.onCheckInScanNow(null,null,null,null,"checkin","setVenueCheckinUrl","noscan",Ext.emptyFn)},onNonCheckinTap:function(a,d,c,f,g){this.onCheckInScanNow(a,d,c,f,"explore","setVenueExploreUrl","noscan",g)},onCheckinHandler:function(m,p,a,b,l,d){var u=this;var k=u.getApplication();var r=Ext.StoreMgr.get("CustomerStore");var o=Ext.StoreMgr.get("CheckinExploreStore");var f=k.getController("client.Merchants");var t=u.getViewPortCntlr();var c=u.getViewport();var j=false,e=false,s=false;var i,g,h,q;i=b.getId();q=b.get("points");d=d||Ext.emptyFn;var n=p.venue_id||((o.first())?o.first().getId():0);h=o.getById(n)||t.getVenue();console.debug("CheckIn - new_venueId:'"+n+"' venue_id:'"+a+"' points:'"+q+"'");if((n==a)||(a==null)){e=(m=="checkin");redeemMode=(m=="redemption");if(Customer.isValid(i)){g=r.getById(i);console.debug("Checking In Venue ...")}else{console.debug("Exploring Venue ...")}u.fireEvent("setupCheckinInfo",m,h,g||b,p);u.fireEvent("updatemetadata",p)}else{console.debug("CheckIn - venueIDs do not match!")}switch(m){case"checkin":case"explore":u.resetView();Ext.Viewport.setMasked(null);u.redirectTo("venue/"+h.getId()+"/"+i);break;case"redemption":default:break}d();if(e||redeemMode){console.debug("CheckIn - Complete")}else{console.debug("CheckInExplore - Complete")}},onLoginActivate:function(f,g,a,b){var d=this;var e=Ext.StoreMgr.get("CheckinExploreStore");e.removeAll()},onLocationUpdate:function(b){var d=this,f=d.getToolbarBottom(),a=d.getViewPortCntlr(),g={},e=Ext.StoreMgr.get("CheckinExploreStore"),c=e.getProxy();Ext.Viewport.setMasked(null);if(!Genesis.db.getLocalDB()["csrf_code"]){a.on("completeRefreshCSRF",function(){d.onLocationUpdate(b)},a,{single:true})}else{pausedDisabled=false;Ext.Viewport.setMasked({xtype:"loadmask",message:d.getVenueInfoMsg});if(b){g=Ext.apply(g,{latitude:b.coords.getLatitude(),longitude:b.coords.getLongitude()})}f[(b)?"show":"hide"]();Venue.setFindNearestURL();e.load({params:g,callback:function(i,h){if(h.wasSuccessful()){Ext.Viewport.setMasked(null);f.setDisabled(false);d.setPosition(b);console.debug("Found "+i.length+" venues.")}else{c.supressErrorsPopup=true;Ext.device.Notification.show({title:"Warning",message:d.missingVenueInfoMsg(h.getError()),buttons:["Dismiss"],callback:function(){c.supressErrorsCallbackFn()}})}},scope:d})}},onExploreLoad:function(c){var a=this;var b=Ext.StoreMgr.get("CheckinExploreStore");if((b.getCount()==0)||c){a.getGeoLocation()}},onExploreShowView:function(c){var b=this.getExploreList();if(Ext.os.is("Android")){var a=this.getEventDispatcher().getPublishers()["elementSize"].monitors;console.debug("Refreshing CheckinExploreStore ...");a[b.container.getId()].forceRefresh()}},onExploreActivate:function(h,i,d,e){var f=this;var a=f.getViewPortCntlr();var g=f.getToolbarBottom();var b=h.query("titlebar")[0];switch(f.animMode){case"cover":break;case"coverUp":break}b.removeCls("kbTitle");switch(f.mode){case"checkin":b.setTitle(" ");b.addCls("kbTitle");g.setDisabled(true);break;case"explore":break}if(f.getExploreList()){}f.fireEvent("exploreLoad",false)},onExploreDeactivate:function(a,f,e,b){var d=Ext.StoreMgr.get("CheckinExploreStore")},onRefreshTap:function(a,f,c){var d=this;d.fireEvent("exploreLoad",true)},onExploreSelect:function(c,a,b){c.deselect([a]);this.onExploreDisclose(c,a);return false},onExploreDisclose:function(g,a,d,b,f,h,j){var i=this;var c=i.getViewPortCntlr();i.self.playSoundFile(c.sound_files.clickSound);c.setVenue(a);switch(this.mode){case"checkin":this.onCheckinTap(null,f,h,j);break;case"explore":this.onNonCheckinTap(null,f,h,j);break}},explorePageUp:function(){this.openPage("explore","coverUp")},explorePage:function(){this.openPage("explore")},checkinPage:function(){this.openPage("checkin")},openPage:function(a,c){var b=this;var d=b.getMainPage();b.mode=d.mode=a;b.animMode=c||"cover";b.setAnimationMode(b.self.animationMode[b.animMode]);b.pushView(d)},getMainPage:function(){var a=this.getExplore();return a},openMainPage:function(){var a=this.getMainPage();this.pushView(a);console.log("Checkin Explore Opened")},isOpenAllowed:function(){return true}});Ext.define("Genesis.model.frontend.JackpotWinner",{extend:Ext.data.Model,alternateClassName:"JackpotWinner",id:"JackpotWinner",config:{fields:[{name:"time",type:"date",convert:function(a,b){b.set("date",a);return(a)?Genesis.fn.convertDate(a):null}},"facebook_id","name","points","date"],idProperty:"id",proxy:{type:"ajax",disableCaching:false,writer:{type:"json"},reader:{type:"json",messageProperty:"message",rootProperty:"data"}}},inheritableStatics:{setGetJackpotWinnersUrl:function(){this.getProxy().setActionMethods({read:"GET"});this.getProxy().setUrl(serverHost+"/api/v1/customers/show_jackpot_winners")}}});Ext.define("Genesis.view.client.JackpotWinners",{extend:Genesis.view.ViewBase,alias:"widget.clientjackpotwinnersview",config:{cls:"jackpotWinnersMain viewport",layout:"fit",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Jackpot Winners",items:[{align:"left",tag:"close",ui:"normal",text:"Close"}]})]},cleanView:function(){this.removeAll(true);this.callParent(arguments)},createView:function(){var a=this;a.setPreRender(a.getPreRender().concat([Ext.create("Ext.dataview.List",{tag:"jackpotWinnersList",store:"JackpotWinnerStore",cls:"jackpotWinnersList",scrollable:"vertical",deferEmptyText:false,disableSelection:true,emptyText:" ",itemTpl:Ext.create("Ext.XTemplate",'<div class="photo">','<img src="{[this.getPhoto(values)]}"/>',"</div>",'<div class="listItemDetailsWrapper">','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">{[this.getDesc(values)]}</div>',"</div>",{getPhoto:function(b){return((b.facebook_id>0)?Genesis.fb.getFbProfilePhoto(b.facebook_id):Genesis.constants.getIconPath("miscicons","profile"))},getTitle:function(b){console.debug(b.name+" won "+b.points+" Points!");return(b.name+" won "+b.points+" Points!")},getDesc:function(b){return b.time}}),plugins:[{type:"listpaging",autoPaging:true,loadMoreText:"",noMoreRecordsText:""},{type:"pullrefresh",refreshFn:function(b){_application.getController("client.JackpotWinners").fireEvent("reload")}}]})]));this.callParent(arguments)}});Ext.define("Genesis.controller.client.JackpotWinners",{extend:Genesis.controller.ControllerBase,inheritableStatics:{},xtype:"clientJackpotWinnersCntlr",config:{routes:{"jackpotWinners/:id":"mainPage"},models:["Genesis.model.frontend.JackpotWinner"],refs:{main:{selector:"clientjackpotwinnersview",autoCreate:true,xtype:"clientjackpotwinnersview"}},control:{main:{showView:"onShowView",activate:"onActivate",deactivate:"onDeactivate"}},listeners:{reload:"onReload"}},init:function(b){var a=this;a.callParent(arguments);Ext.regStore("JackpotWinnerStore",{model:"Genesis.model.frontend.JackpotWinner",autoLoad:false,pageSize:5,sorters:[{property:"date",direction:"DESC"}],listeners:{scope:a,load:function(e,d,g,c,f){}}});console.log("JackpotWinners Init");a.getMain()},onReload:function(){var a=this;JackpotWinner.setGetJackpotWinnersUrl();Ext.StoreMgr.get("JackpotWinnerStore").load({jsonData:{},params:{merchant_id:a.merchantId},callback:function(c,b){}})},onShowView:function(c){if(Ext.os.is("Android")){var a=this.getEventDispatcher().getPublishers()["elementSize"].monitors;var b=c.query("list[tag=jackpotWinnersList]")[0];console.debug("Refreshing RenderStore ...");a[b.container.getId()].forceRefresh()}},onActivate:function(d,e,a,b){},onDeactivate:function(a,e,d,b){},mainPage:function(a){this.openPage("main",a)},openPage:function(a,c){var b=this;switch(a){case"main":b.merchantId=c;b.setAnimationMode(b.self.animationMode.coverUp);b.pushView(b.getMainPage());b.onReload();break}},getMainPage:function(){var a=this.getMain();return a},openMainPage:function(){var a=this;a.setAnimationMode(a.self.animationMode.coverUp);a.pushView(a.getMainPage());console.log("Jackpot Winners Page Opened")},isOpenAllowed:function(){return true}});Ext.define("Genesis.model.frontend.ChangePassword",{extend:Ext.data.Model,alternateClassName:"ChangePassword",id:"ChangePassword",config:{fields:["oldpassword","newpassword"],validations:[{type:"length",field:"oldpassword",min:6},{type:"length",field:"newpassword",min:6}]}});Ext.define("Genesis.view.MainPageBase",{extend:Genesis.view.ViewBase,alias:"widget.mainpagebaseview",config:{models:["frontend.MainPage"],itemPerPage:6,layout:"fit",cls:"viewport",listeners:[{element:"element",delegate:"div.itemWrapper",event:"tap",fn:"onItemTap"}],scrollable:undefined},isEligible:Ext.emptyFn,initialize:function(){this.setPreRender([]);this.callParent(arguments)},onItemTap:function(f,d,b,a){var c=Ext.create("Genesis.model.frontend.MainPage",Ext.decode(decodeURIComponent(f.delegatedTarget.getAttribute("data"))));_application.getController(((merchantMode)?"server":"client")+".MainPage").fireEvent("itemTap",c)},cleanView:function(){this.removeAll(true);this.callParent(arguments)},removeAll:function(a,b){var c=this.query("carousel")[0];return c.removeAll(true)},createView:function(){var f=this,h=f.query("carousel")[0],a=_application;var d=a.getController(((merchantMode)?"server":"client")+".Viewport"),j=d.getViewport();var g=(!merchantMode)?d.getCheckinInfo().venue!=null:false;var e=Ext.StoreMgr.get("MainPageStore").getRange(),c=Ext.Array.clone(e);if(!h._listitems){h._listitems=[]}if(!g){Ext.Array.forEach(c,function(l,i,k){switch(l.get("hide")){case"true":Ext.Array.remove(e,l);break}})}if((Ext.Array.difference(e,h._listitems).length>0)||(e.length!=h._listitems.length)){h._listitems=e;h.removeAll(true);for(var b=0;b<Math.ceil(e.length/f.getItemPerPage());b++){h.add({xtype:"component",cls:"mainMenuSelections",tag:"mainMenuSelections",scrollable:undefined,data:Ext.Array.pluck(e.slice(b*f.getItemPerPage(),((b+1)*f.getItemPerPage())),"data"),tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="itemWrapper x-hasbadge" data="{[this.encodeData(values)]}">',"{[this.isEligible(values)]}",'<div class="photo"><img src="{[this.getPhoto(values.photo_url)]}" /></div>','<div class="photoName">{name}</div>',"</div>","</tpl>",{encodeData:function(i){return encodeURIComponent(Ext.encode(i))},getType:function(){return values.pageCntlr},isEligible:f.isEligible,getPhoto:function(i){return Ext.isEmpty(i)?Ext.BLANK_IMAGE_URL:i}})})}console.debug("MainPage Icons Refreshed.")}else{console.debug("MainPage Icons Not changed.")}delete h._listitems;this.callParent(arguments)},showView:function(){var a=this.query("carousel")[0];this.callParent(arguments);if(a.getInnerItems().length>0){a.setActiveItem(0)}}});Ext.define("Genesis.view.client.MainPage",{extend:Genesis.view.MainPageBase,alias:"widget.clientmainpageview",config:{items:(function(){var a=[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{xtype:"titlebar",cls:"navigationBarTop kbTitle",items:[{align:"right",tag:"info",iconCls:"info",destroy:function(){this.actions.destroy();this.callParent(arguments)},handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{defaultUnit:"em",padding:"1.0",hideOnMaskTap:false,layout:"hbox",defaults:{margin:"0 0.7 0 0",flex:1,xtype:"button",defaultUnit:"em"},items:[{text:"Cancel",ui:"cancel",scope:this,handler:function(){this.actions.hide()}},{margin:"0 0 0 0",text:"Logout",tag:"logout"}]});Ext.Viewport.add(this.actions)}this.actions.show()}}]}),{xtype:"carousel",direction:"horizontal"}];return a}())},disableAnimation:true,isEligible:function(b,e){var f=(b.pageCntlr=="client.Redemptions");var a=(b.pageCntlr=="client.Prizes");var h=false;b.index=e-1;if(f||a){var c=Ext.StoreMgr.get("CustomerStore").getRange();for(var d=0;d<c.length;d++){var g=c[d];if(a){if(g.get("eligible_for_prize")){h=true;break}}else{if(f){if(g.get("eligible_for_reward")){h=true;break}}}}}return((f||a)?'<span data="'+b.pageCntlr+'" class="x-badge round '+((h)?"":"x-item-hidden")+'">✔</span>':"")},createView:function(){var k=this;var o=this.query("carousel")[0];var c=_application;var h=c.getController(((merchantMode)?"server":"client")+".Viewport");var p=h.getViewport();var m=(!merchantMode)?h.getCheckinInfo().venue!=null:false;var j=Ext.StoreMgr.get("MainPageStore").getRange();var g=Ext.Array.clone(j);k.calcCarouselSize();if(!o._listitems){o._listitems=[]}if(!m){Ext.Array.forEach(g,function(r,i,q){switch(r.get("hide")){case"true":Ext.Array.remove(j,r);break}})}if((Ext.Array.difference(j,o._listitems).length>0)||(j.length!=o._listitems.length)){}else{var b=Ext.StoreMgr.get("CustomerStore");if(b){var n=b.getRange();var a=false;var l=false;for(var e=0;e<n.length;e++){var f=n[e];if(f.get("eligible_for_reward")){a=true;break}if(f.get("eligible_for_prize")){l=true;break}}if(o.getInnerItems().length>0){var d=Ext.DomQuery.select("span[data=client.Redemptions]",o.element.dom)[0];if(a){d.innerHTML=count;Ext.fly(d).removeCls("x-item-hidden")}else{if(!d.className.match(/x-item-hidden/)){Ext.fly(d).addCls("x-item-hidden")}}d=Ext.DomQuery.select("span[data=client.Prizes]",o.element.dom)[0];if(l){d.innerHTML=count;Ext.fly(d).removeCls("x-item-hidden")}else{if(!d.className.match(/x-item-hidden/)){Ext.fly(d).addCls("x-item-hidden")}}}}console.debug("MainPage Icons Not changed.")}this.callParent(arguments)}});Ext.define("Genesis.view.LoginPage",{extend:Genesis.view.ViewBase,alias:"widget.loginpageview",config:{cls:"bgImage",scrollable:undefined},initialize:function(){var a=Ext.create("Ext.ActionSheet",{modal:false,style:{background:"transparent",border:"none"},layout:"hbox",showAnimation:null,hideAnimation:null,defaultUnit:"em",hideOnMaskTap:false,defaults:{height:"4em",flex:1,defaultUnit:"em",xtype:"button"},items:[{margin:"0 0.7 0 0",tag:"signIn",text:"Sign In"},{margin:"0 0.7 0 0",tag:"facebook",ui:"fbBlue",text:"Facebook Sign In"},{labelCls:"x-button-label wrap",tag:"createAccount",ui:"action",text:"Create Account"}]});this.add(a);this.callParent(arguments)}});Ext.define("Genesis.view.SignInPage",{extend:Ext.form.Panel,alias:"widget.signinpageview",config:{preRender:null,fullscreen:true,cls:"viewport",layout:{type:"vbox",align:"stretch",pack:"start"},changeTitle:false,items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Sign In",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"fieldset",title:"Login Credentials:",defaults:{required:true,labelAlign:"top",clearIcon:true},items:[{xtype:"emailfield",name:"username",label:"Email Address",placeHolder:"johndoe@example.com"},{xtype:"passwordfield",name:"password",label:"Password"}]},{xtype:"button",ui:"action",tag:"login",text:"Sign In",defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"},{xtype:"button",tag:"reset",text:"Password Reset",defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"}]},initialize:function(){this.callParent(arguments);this.setPreRender([])},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments)},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments)},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments)},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments)}});Ext.define("Genesis.view.PasswdResetPage",{extend:Ext.form.Panel,alias:"widget.passwdresetpageview",config:{preRender:null,fullscreen:true,cls:"viewport",layout:{type:"vbox",align:"stretch",pack:"start"},changeTitle:false,scrollable:"vertical",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Password Reset",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"fieldset",title:"Login Credentials:",defaults:{required:true,labelAlign:"top"},items:[{xtype:"emailfield",name:"username",label:"Email Address",clearIcon:true,placeHolder:"johndoe@example.com"}]},{xtype:"button",tag:"submit",text:"Reset",defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"}]},initialize:function(){this.callParent(arguments);this.setPreRender([])},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments)},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments)},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments)},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments)}});Ext.define("Genesis.view.PasswdChangePage",{extend:Ext.form.Panel,alias:"widget.passwdchangepageview",config:{preRender:null,fullscreen:true,cls:"viewport",layout:{type:"vbox",align:"stretch",pack:"start"},changeTitle:false,scrollable:"vertical",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Password Change",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"fieldset",title:"Login Credentials:",defaults:{required:true,labelAlign:"top"},items:[{xtype:"passwordfield",name:"oldpassword",label:"Old Password",clearIcon:true},{xtype:"passwordfield",name:"newpassword",label:"New Password",clearIcon:true}]},{xtype:"button",tag:"submit",text:"Change Password",defaultUnit:"em",xtype:"button",margin:"0.5 0 0 0"}]},initialize:function(){this.callParent(arguments);this.setPreRender([])},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments)},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments)},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments)},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments)}});Ext.define("Genesis.view.CreateAccountPage",{extend:Ext.form.Panel,alias:"widget.createaccountpageview",config:{preRender:null,fullscreen:true,cls:"viewport",layout:{type:"vbox",align:"stretch",pack:"start"},changeTitle:false,scrollable:"vertical",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Create Account",items:[{align:"left",ui:"normal",tag:"back",text:"Back"}]}),{xtype:"fieldset",tag:"social",title:"Social Media",defaults:{labelWidth:"60%"},items:[{xtype:"togglefield",name:"facebook",label:'<img src="'+Genesis.constants.resourceSite+"images/"+Genesis.constants.themeName+'/facebook_icon.png" style="height:'+(2.5/0.8)+'em;float:left;margin-right:0.8em;"/> Facebook',value:0},{hidden:true,xtype:"togglefield",name:"twitter",label:'<img src="'+Genesis.constants.resourceSite+"images/"+Genesis.constants.themeName+'/twitter_icon.png" style="height:'+(2.5/0.8)+'em;float:left;margin-right:0.8em;"/> Twitter',value:0}]},{xtype:"fieldset",title:"Account Credentials:",defaults:{clearIcon:true,required:true,labelAlign:"top"},items:[{xtype:"textfield",name:"name",label:"Full Name",placeHolder:"John Smith"},{xtype:"emailfield",name:"username",label:"Email Address",placeHolder:"johndoe@example.com"},Ext.apply({label:"Phone Number",name:"phone"},Genesis.view.ViewBase.phoneField()),{xtype:"passwordfield",name:"password",label:"Password"}]},{height:"3em",xtype:"button",ui:"action",tag:"createAccount",text:"Create Account"}]},initialize:function(){this.callParent(arguments);this.setPreRender([])},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments)},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments)},createView:function(){var a=Genesis.view.ViewBase.prototype.createView.apply(this,arguments);this.query("fieldset[tag=social]")[0].setInstructions(Genesis.fb.fbConnectRequestMsg);return a},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments)}});Ext.define("Genesis.controller.client.MainPage",{extend:Genesis.controller.MainPageBase,xtype:"clientMainPageCntlr",config:{csrfTokenRecv:false,models:["Genesis.model.frontend.MainPage","Genesis.model.frontend.Signin","Genesis.model.frontend.Account","Genesis.model.frontend.ChangePassword","Venue","Customer","User","Merchant","CustomerReward"],after:{mainPage:""},routes:{login:"loginPage",merchant:"merchantPage",signin:"signInPage",password_reset:"signInResetPage",password_change:"signInChangePage",createAccount:"createAccountPage"},refs:{main:{selector:"clientmainpageview",autoCreate:true,xtype:"clientmainpageview"},mainCarousel:"clientmainpageview",infoBtn:"button[tag=info]",login:{selector:"loginpageview",autoCreate:true,xtype:"loginpageview"},signin:{selector:"signinpageview",autoCreate:true,xtype:"signinpageview"},passwdReset:{selector:"passwdresetpageview",autoCreate:true,xtype:"passwdresetpageview"},passwdChange:{selector:"passwdchangepageview",autoCreate:true,xtype:"passwdchangepageview"},createAccount:{selector:"createaccountpageview",autoCreate:true,xtype:"createaccountpageview"},mainCarousel:"clientmainpageview",shortcutTabBar:"clientmainpageview tabbar[tag=navigationBarBottom]",prizesBtn:"clientmainpageview tabbar[tag=navigationBarBottom] button[tag=prizesSC]"},control:{login:{activate:"onLoginActivate",deactivate:"onLoginDeactivate"},"actionsheet button[tag=facebook]":{tap:"onMainFacebookTap"},"actionsheet button[tag=createAccount]":{tap:"onCreateAccountTap"},"actionsheet button[tag=signIn]":{tap:"onSignInTap"},"signinpageview button[tag=login]":{tap:"onSignInSubmit"},"signinpageview button[tag=reset]":{tap:"onSignInResetSubmit"},"passwdresetpageview button[tag=submit]":{tap:"onPasswdResetSubmit"},"passwdchangepageview button[tag=submit]":{tap:"onPasswdChangeSubmit"},"actionsheet button[tag=logout]":{tap:"onLogoutTap"},shortcutTabBar:{tabchange:"onTabBarTabChange"},createAccount:{activate:"onCreateActivate",deactivate:"onCreateDeactivate"},"createaccountpageview togglefield[name=facebook]":{change:"onFacebookChange"},"createaccountpageview togglefield[name=twitter]":{change:"onTwitterChange"},"createaccountpageview button[tag=createAccount]":{tap:"onCreateAccountSubmit"}},listeners:{refreshCSRF:"onRefreshCSRF",facebookTap:"onMainFacebookTap",toggleFB:{fn:"onToggleFB",buffer:500},toggleTwitter:{fn:"onToggleTwitter",buffer:300}}},initializing:true,_loggingIn:false,_loggingOut:false,_logoutflag:0,creatingAccountMsg:"Creating Your Account ...",sessionTimeoutMsg:"Session Timeout",passwdResetConfirmMsg:"Please confirm to reset your account password",passwdResetSuccessMsg:function(){return("Password Reset was Successful."+Genesis.constants.addCRLF()+"Please check your email account for instructions.")},passwdChangeSuccessMsg:"Password Change was Successful.",signInFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please Try Again"},passwdResetFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please fix the errors"},passwdChangeFailMsg:function(a){return a+Genesis.constants.addCRLF()+"Please retype the passwords"},initCallback:function(){var b=this;var a=Genesis.db.getLocalDB();if(a.auth_code){b.fireEvent("refreshCSRF")}else{b.resetView();b.redirectTo("login")}},init:function(b){var a=this;a.callParent(arguments);a.initCustomerStore();a.initVenueStore();console.log("Client MainPage Init")},initCustomerStore:function(){var a=this;Ext.regStore("CustomerStore",{model:"Genesis.model.Customer",autoLoad:false,pageSize:1000,listeners:{scope:a,load:function(d,c,f,b,e){},metachange:function(d,f,e){var c=f.getReader().metaData;var g=c.data;if(g){var h=a.getApplication();var b=h.getController("client.Accounts");b.callBackStack["arguments"]=[c];b.fireEvent("triggerCallbacksChain")}}},grouper:{groupFn:function(b){return b.getMerchant().get("name")}},filters:[{filterFn:function(b){return Customer.isValid(b.getId())}}],sorters:[{sorterFn:function(d,b){var e=d.getMerchant().get("name"),c=b.getMerchant().get("name");if(e<c){return -1}if(e>c){return 1}return 0}}]})},initVenueStore:function(){var a=this;Ext.regStore("VenueStore",{model:"Genesis.model.Venue",autoLoad:false,sorters:[{property:"distance",direction:"ASC"}],listeners:{metachange:function(b,d,c){if(b.isLoading()){a.fireEvent("updatemetadata",d.getReader().metaData)}}}})},onLocationUpdate:function(g){var m=this,l=m.getViewPortCntlr(),n=Genesis.db.getLocalDB(),c=Ext.create("Genesis.model.Venue",n.last_check_in.venue);var j=g.coords.getLatitude(),h=g.coords.getLongitude();var i=c.get("latitude"),f=c.get("longitude");var b=6371000*Math.acos(Math.cos(Math.radians(j))*Math.cos(Math.radians(i))*Math.cos(Math.radians(f)-Math.radians(h))+Math.sin(Math.radians(j))*Math.sin(Math.radians(i)));if(b<=Genesis.constants.minDistance){var d=m.getApplication(),e=d.getController("client.Checkins");var k=Ext.StoreMgr.get("CustomerStore").getById(n.last_check_in.customerId),a=n.last_check_in.metaData;console.debug("Restoring Previous Venue Location ...");e.fireEvent("setupCheckinInfo","explore",c,k,a);e.fireEvent("checkinMerchant","checkin",a,c.getId(),k,null,Ext.emptyFn)}else{console.debug("Reset Previous Location back to Home Page ...");Genesis.db.removeLocalDBAttrib("last_check_in");m.redirectTo("checkin")}},onActivate:function(d,e,a,b){if(Genesis.fn.isNative()){navigator.splashscreen.hide()}this.getInfoBtn()[(merchantMode)?"hide":"show"]()},onDeactivate:function(a,e,d,b){},onTabBarTabChange:function(b,d,c,a){switch(d.config.tag){default:case"rewards":Ext.defer(function(){try{if(d){d.setActive(false)}if(c){c.setActive(false)}b._activeTab=null}catch(f){}},2*1000);break}return true},onLoginActivate:function(f,g,b,d){var e=this,a=e.getViewPortCntlr();Genesis.db.resetStorage();Ext.StoreMgr.get("CustomerStore").removeAll();Ext.StoreMgr.get("VenueStore").removeAll();e.persistSyncStores(null,true);a.setLoggedIn(false);e._loggingIn=false},onLoginDeactivate:function(a,f,e,b){var d=this},_logout:function(){var b=this,a=Genesis.db.getLocalDB()["auth_code"];if(a){console.log("Logging out ...");Customer.setLogoutUrl(a);Ext.StoreMgr.get("CustomerStore").load({jsonData:{},callback:function(d,c){b._loggingIn=false;b._loggingOut=false;if(c.wasSuccessful()){console.log("Logout Successful!")}else{console.log("Logout Failed!")}}})}else{b._loggingOut=false}console.debug("Resetting Session information ...");if((Genesis.db.getLocalDB()["currFbId"]>0)&&(Genesis.fn.isNative())){console.debug("Logging out of Facebook ...");Genesis.fb.facebook_onLogout(null,true)}b.resetView();b.redirectTo("login")},onLogoutTap:function(c,i,d,h){var g=this,f=g.getViewport(),a=g.getViewPortCntlr();if(g._loggingOut){return}g._logoutflag=0;g._loggingOut=true;c.parent.onAfter({hiddenchange:function(){if((g._logoutflag|=1)==17){g._logout()}},single:true});c.parent.hide();if(Genesis.db.getLocalDB()["currFbId"]>0){}else{console.debug("No Login info found from Facebook ...")}if((g._logoutflag|=16)==17){g._logout()}},onFacebookLoginCallback:function(f,g,a,d,e){var c=this,b=Genesis.fb;b.un("connected",c.fn);b.un("unauthorized",c.fn);b.un("exception",c.fn);delete c.fn;if((g&&g.wasSuccessful())||(f&&(f.type!="timeout"))){Customer.setFbLoginUrl();console.debug("setFbLoginUrl - Logging in ... params("+Ext.encode(f)+")");c.updatedDeviceToken=(Genesis.constants.device)?true:false;Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:Ext.apply({version:Genesis.constants.clientVersion,device_pixel_ratio:window.devicePixelRatio,device:Ext.encode(Genesis.constants.device)},f),callback:function(i,h){c._loggingIn=false;if(!h.wasSuccessful()){e()}else{Ext.Viewport.setMasked(null);Genesis.db.setLocalDBAttrib("enableFB",true);c.persistSyncStores("CustomerStore")}}})}else{c._loggingIn=false;e()}},onMainFacebookTap:function(a,i,c,g,h){var f=this,d=Genesis.fb;h=(Ext.isFunction(h))?h:Ext.emptyFn;if(Ext.Viewport.getMasked()||f._loggingOut||f._loggingIn){h();return}f._loggingIn=true;Genesis.db.removeLocalDBAttrib("currFbId");f.fn=Ext.bind(f.onFacebookLoginCallback,f,[h],true);d.on("connected",f.fn);d.on("unauthorized",f.fn);d.on("exception",f.fn);Genesis.fb.facebook_onLogin(false)},onCreateAccountTap:function(a,g,c,f){var d=this;d.redirectTo("createAccount")},onSignInTap:function(a,g,c,f){var d=this;d.redirectTo("signin")},onRefreshCSRF:function(){var d=this,a=d.getViewPortCntlr(),c=Account.getProxy(),b=Genesis.db.getLocalDB();Account.setRefreshCsrfTokenUrl();console.debug("setRefreshCsrfTokenUrl - Refreshing CSRF Token ...");Ext.Viewport.setMasked({xtype:"loadmask",message:d.establishConnectionMsg});d.updatedDeviceToken=(Genesis.constants.device)?true:false;Account.load(0,{jsonData:{},params:{version:Genesis.constants.clientVersion,device_pixel_ratio:window.devicePixelRatio,device:Ext.encode(Genesis.constants.device)},callback:function(e,f){if(f.wasSuccessful()){a.fireEvent("completeRefreshCSRF");d.persistLoadStores(Ext.emptyFn);if(b.last_check_in){d.getGeoLocation()}}else{d.resetView();d.redirectTo("login")}}})},onCreateAccountSubmit:function(j,g,h,k){var i=this,f=i.getCreateAccount(),c=Genesis.db.getLocalDB()["fbResponse"]||null,l=f.getValues();var d=i.getApplication().getController("client.Settings").self.accountValidate(f,l);if(d){console.debug("Creating Account ...");var a={version:Genesis.constants.clientVersion,name:l.name,email:l.username,password:l.password,phone:l.phone.replace(/-/g,"")};if(c){a=Ext.applyIf(a,c)}Ext.Viewport.setMasked({xtype:"loadmask",message:i.creatingAccountMsg});Customer.setCreateAccountUrl();i.updatedDeviceToken=(Genesis.constants.device)?true:false;Ext.StoreMgr.get("CustomerStore").load({jsonData:{},params:{version:Genesis.constants.clientVersion,device_pixel_ratio:window.devicePixelRatio,user:Ext.encode(a),device:Ext.encode(Genesis.constants.device)},callback:function(e,b){if(!b.wasSuccessful()){}else{if(c){Genesis.db.setLocalDBAttrib("enableFB",true)}i.persistSyncStores()}Ext.Viewport.setMasked(null)}})}},onSignIn:function(d,a){var b=this;if(Ext.Viewport.getMasked()||b._loggingOut||b._loggingIn){return}if(Genesis.fn.isNative()){Genesis.fb.facebook_onLogout(null,Genesis.db.getLocalDB()["currFbId"]>0)}var b=this;var c={version:Genesis.constants.clientVersion,device_pixel_ratio:window.devicePixelRatio,device:Ext.encode(Genesis.constants.device)};if(d){c=Ext.apply(c,{email:d,password:a})}Customer.setLoginUrl();console.debug("setLoginUrl - Logging in ...");Ext.Viewport.setMasked({xtype:"loadmask",message:b.loginMsg});b.updatedDeviceToken=(Genesis.constants.device)?true:false;Ext.StoreMgr.get("CustomerStore").load({params:c,jsonData:{},callback:function(f,e){b._loggingIn=false;if(!e.wasSuccessful()){}else{b.persistSyncStores("CustomerStore")}Ext.Viewport.setMasked(null)}})},onSignInResetSubmit:function(a,f,c,d){this.redirectTo("password_reset")},onSignInSubmit:function(g,d,f,j){var k=this.getSignin();var l=k.getValues();var c=Ext.create("Genesis.model.frontend.Signin",l);var a=c.validate();if(!a.isValid()){var i=a.first();var h=Ext.ComponentQuery.query("field[name="+i.getField()+"]")[0].getLabel();Ext.device.Notification.show({title:"Sign In",message:this.signInFailMsg(h+" "+i.getMessage()),buttons:["Dismiss"]})}else{this.onSignIn(l.username,l.password)}},onPasswdReset:function(c){var a=this;var b={device:Ext.encode(Genesis.constants.device)};if(c){b=Ext.apply(b,{email:c})}Account.setPasswdResetUrl();console.debug("setPasswdResetUrl - Resetting Password ...");Account.load(0,{params:b,jsonData:{},callback:function(d,e){if(e.wasSuccessful()){Ext.device.Notification.show({title:"Password Reset",message:a.passwdResetSuccessMsg(),buttons:["OK"]});a.popView()}Ext.Viewport.setMasked(null)}})},onPasswdResetSubmit:function(a,h,c,g){var f=this;var d=function(){var j=f.getPasswdReset();var e=j.getValues();var b=Ext.create("Genesis.model.frontend.Signin",e);var i=b.validate();var k=true;if(!i.isValid()){i.each(function(o,m,n){if(o.getField()=="username"){var l=j.query("field[name=username]")[0].getLabel();Ext.device.Notification.show({title:"Password Reset",message:f.passwdResetFailMsg(l+" "+field.getMessage()),buttons:["Dismiss"]});k=false}},f)}if(k){f.onPasswdReset(e.username)}};Ext.device.Notification.show({title:"Password Reset",message:this.passwdResetConfirmMsg,buttons:["Confirm","Cancel"],callback:function(b){if(b.toLowerCase()=="confirm"){Ext.defer(d,1)}}})},onPasswdChange:function(b,c){var a=this;var d={device:Ext.encode(Genesis.constants.device)};if(b&&c){d=Ext.apply(d,{old_password:b,new_password:c})}Account.setPasswdChangeUrl();console.debug("setPasswdChangeUrl - Changing Password ...");Account.load(0,{params:d,jsonData:{},callback:function(e,f){if(f.wasSuccessful()){Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:"Password Reset",message:a.passwdChangeSuccessMsg,buttons:["OK"]})}}})},onPasswdChangeSubmit:function(h,d,f,k){var g=this.getPasswdChange();var l=g.getValues(true);var c=Ext.create("Genesis.model.frontend.ChangePassword",l);var a=c.validate();if(!a.isValid()){var j=a.first();var i=Ext.ComponentQuery.query("field[name="+j.getField()+"]")[0].getLabel();var m=this.passwdChangeFailMsg(i+" "+j.getMessage());console.debug(m);Ext.device.Notification.show({title:"Password Change",message:m,buttons:["Dismiss"]})}else{this.onPasswdChange(l.oldpassword,l.newpassword)}},onCreateActivate:function(h,i,a,e){var g=this,d=Genesis.db.getLocalDB(),b=d.fbResponse||null;console.debug("onCreateActivate - fbResponse["+Ext.encode(b)+"]");console.log("enableFB - "+d.enableFB+", enableTwitter - "+d.enableTwitter);g.initializing=true;if(b){var f=this.getCreateAccount();f.setValues({facebook:(d.enableFB)?1:0,twitter:(d.enableTwitter)?1:0,name:b.name,username:b.email})}g.initializing=false},onCreateDeactivate:function(a,g,f,b){var e=this,d=Genesis.fb;e.onFbDeactivate()},updateFBSignUpPopupCallback:function(e,b){var c=this,d=c.getCreateAccount();var a=(d)?d.query("togglefield[name=facebook]")[0]:null;Ext.Viewport.setMasked(null);if((b&&b.wasSuccessful())||(e&&(e.type!="timeout"))){c.updateFBSettings(e);if(a){a.originalValue=1;c.onCreateActivate()}}else{if(a){a.toggle()}Ext.device.Notification.show({title:"Facebook Connect",message:Genesis.fb.fbConnectFailMsg,buttons:["Dismiss"]})}},onToggleFB:function(f,d,b,c,a,g){var h=this,e=Genesis.fb,i=Genesis.db.getLocalDB();h.callParent(arguments);if(c==1){}else{if(i.enableFB){console.debug("Cancelling Facebook Login ...");i=Genesis.db.getLocalDB();i.enableFB=false;i.currFbId=0;delete i.fbAccountId;delete i.fbResponse;Genesis.db.setLocalDB(i);if(Genesis.fn.isNative()){Genesis.fb.facebook_onLogout(null,true)}}}},loginPage:function(){this.openPage("login")},merchantPage:function(){this.openPage("merchant")},signInPage:function(){this.setAnimationMode(this.self.animationMode.cover);this.pushView(this.getSignin())},signInResetPage:function(){this.setAnimationMode(this.self.animationMode.slide);this.pushView(this.getPasswdReset())},signInChangePage:function(){this.setAnimationMode(this.self.animationMode.slide);this.pushView(this.getPasswdChange())},createAccountPage:function(){this.setAnimationMode(this.self.animationMode.slide);this.pushView(this.getCreateAccount())}});Ext.define("Genesis.model.News",{extend:Ext.data.Model,id:"News",alternateClassName:"News",config:{idProperty:"id",fields:["id","item_id","title","text","type","item_type","photo",{name:"created_date",type:"date",convert:function(a,b){a=Date.parse(a,"yyyy-MM-dd");return(a)?Genesis.fn.convertDateNoTimeNoWeek(a):null}}]}});Ext.define("Genesis.view.widgets.MerchantAccountPtsItem",{extend:Ext.dataview.component.DataItem,xtype:"merchantaccountptsitem",alias:"widget.merchantaccountptsitem",config:{layout:"vbox",background:{cls:"tbPanel",tag:"background",height:window.innerWidth,items:[{xtype:"container",bottom:0,width:"100%",cls:"container",layout:"hbox",defaults:{flex:1,xtype:"component"},items:[{tag:"prizepoints",tpl:Ext.create("Ext.XTemplate",'<span class="x-badge round {[this.isVisible()]}">✔</span>{prize_points}',{isVisible:function(){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");var b=a.getCustomer();return(b.get("eligible_for_prize")?"":"x-item-hidden")}}),cls:"prizephotodesc x-hasbadge"},{tag:"points",tpl:Ext.create("Ext.XTemplate",'<span class="x-badge round {[this.isVisible()]}">✔</span>{points}',{isVisible:function(){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");var b=a.getCustomer();return(b.get("eligible_for_reward")?"":"x-item-hidden")}}),cls:"pointsphotodesc x-hasbadge"}]}]},winnersCount:{tag:"prizesWonPanel",xtype:"component",cls:"prizesWonPanel x-list",tpl:Ext.create("Ext.XTemplate",'<tpl if="this.isVisible(values)">','<div class="prizeswonphoto">','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">{[this.getDesc(values)]}</div>',"</div>",'<div class="x-list-disclosure"></div>',"</tpl>",{isVisible:function(a){return true},getTitle:function(a){var b=" Jackpot"+((a.prize_jackpots>1)?"s":"");var c=((a.prize_jackpots>0)?a.prize_jackpots+b+" won this month":"Be our first winner this month!");return c},getDesc:function(a){return"Check out our winners!"}})},badgeProgress:{tag:"badgeProgressPanel",xtype:"component",cls:"badgeProgressPanel",tpl:Ext.create("Ext.XTemplate",'<tpl if="this.isVisible(values)">','<div class="badgephoto">','<img class="itemPhoto" src="{[this.getPhoto(values)]}"/>','<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="itemDesc">','<div class="progressBarContainer">','<div class="progressBar" style="{[this.getProgress(values)]}"></div>','<div class="progressBarValue">{[this.getDesc(values)]}</div>',"</div>","{[this.cleanup(values)]}","</div>","</div>","</tpl>",{isVisible:function(b){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");var d=a.getCustomer();var c=false;if(d){c=Customer.isValid(d.getId());b._customer=(c)?Ext.StoreMgr.get("CustomerStore").getById(d.getId()):null}return c},getPhoto:function(a){var b=Ext.StoreMgr.get("BadgeStore");if(b){a._badgeType=b.getById(a._customer.get("badge_id")).get("type");return Genesis.view.client.Badges.getPhoto(a._badgeType,"thumbnail_medium_url")}},getTitle:function(a){var b=('You are our <span class ="badgehighlight">'+a._badgeType.display_value.toUpperCase()+"</span>");return b},getProgress:function(b){var d=b._customer;var e=b._nextBadge=Ext.StoreMgr.get("BadgeStore").getById(d.get("next_badge_id"));var c=b._nvisit=e.get("visits");var a=d.get("next_badge_visits");return("width:"+(a/c*100)+"%;")},getDesc:function(b){var d=b._customer;var c=b._nvisit;var a=d.get("next_badge_visits");var e=b._nextBadge;return((c-a)+" more visit"+(((c-a)>1)?"s":"")+" to be our "+((e)?e.get("type").display_value.toUpperCase():"None")+"!")},cleanup:function(a){delete a._customer;delete a._nextBadge;delete a._badgeType;delete a._nvisit}})},dataMap:{getBackground:{setData:"background"},getWinnersCount:{setData:"winnersCount"},getBadgeProgress:{setData:"badgeProgress"}},listeners:[{element:"element",delegate:"div.prizephotodesc",event:"tap",fn:"onPrizesButtonTap"},{element:"element",delegate:"div.pointsphotodesc",event:"tap",fn:"onRedemptionsButtonTap"},{painted:function(b,a){}}]},initialize:function(){var a=this.query("container[tag=background]")[0];a.setHeight(window.innerWidth)},applyBackground:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBackground())},updateBackground:function(a,b){if(a){this.add(a)}if(b){this.remove(b)}},setDataBackground:function(e){var g=_application.getController(((merchantMode)?"server":"client")+".Viewport");var f=g.getCustomer();var b=g.getVenue();var a=b.getMerchant();var c=b.getId();var h=g.getCheckinInfo().venue;var k=f.getId();var l=a.get("features_config");var d=this.query("container[tag=background]")[0];var j=this.query("component[tag=points]")[0];var i=this.query("component[tag=prizepoints]")[0];d.setStyle({"background-image":"url("+e.Merchant.alt_photo["thumbnail_large_url"]+")"});d.getItems().items[0].show();if(Customer.isValid(k)&&Ext.StoreMgr.get("CustomerStore").getById(k)){j.setData(f.getData());i.setData(f.getData())}else{j.setData({points:"---"});i.setData({prize_points:"---"})}i.setVisibility(!l||(l&&l.enable_prizes))},applyWinnersCount:function(a){if(Ext.StoreMgr.get("BadgeStore")){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getWinnersCount())}return new Ext.Container()},updateWinnersCount:function(b,a){if(b){this.add(b)}if(a){this.remove(a)}},setDataWinnersCount:function(b){var a=this.query("component[tag=prizesWonPanel]")[0];if(a){a.setData(b)}},applyBadgeProgress:function(a){if(Ext.StoreMgr.get("BadgeStore")){return Ext.factory(Ext.apply(a,{}),Ext.Container,this.getBadgeProgress())}return new Ext.Container()},updateBadgeProgress:function(b,a){if(b){this.add(b)}if(a){this.remove(a)}},setDataBadgeProgress:function(d){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");var b=this.query("component[tag=badgeProgressPanel]")[0];var c=Customer.isValid(a.getCustomer().getId());if(b){if(c){b.setData(d)}b[(c)?"show":"hide"]()}},updateRecord:function(d){if(!d){return}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),k=e.first(),i=h.getDataMap(),f,j,g,a;if(!k){return}for(f in i){g=i[f];j=h[f]();if(j){for(a in g){if(j[a]){switch(g[a]){case"background":h.setDataBackground(b);break;case"badgeProgress":h.setDataBadgeProgress(b);break;case"winnersCount":h.setDataWinnersCount(b);break;default:j[a](b[g[a]]);break}}}}}k.updateData(b)},onPrizesButtonTap:function(){var b=this;var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");if(a.onPrizesButtonTap){a.self.playSoundFile(a.sound_files.clickSound);a.onPrizesButtonTap()}},onRedemptionsButtonTap:function(){var b=this;var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");if(a.onRedemptionsButtonTap){a.self.playSoundFile(a.sound_files.clickSound);a.onRedemptionsButtonTap()}}});Ext.define("Genesis.view.client.MerchantAccount",{extend:Genesis.view.ViewBase,alias:"widget.clientmerchantaccountview",config:{tag:"merchantMain",cls:"merchantMain viewport",scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",iconCls:"maps",tag:"mapBtn"}]}),{docked:"bottom",cls:"navigationBarBottom",tag:"navigationBarBottom",xtype:"tabbar",ui:"light",layout:{pack:"justify",align:"center"},scrollable:{direction:"horizontal",indicators:false},defaults:{iconMask:true,iconAlign:"top"},items:[{xtype:"spacer"},{iconCls:"home",tag:"home",title:"Home"},{iconCls:"rewards",tag:"rewards",title:"Earn Pts"},{iconCls:"challenges",tag:"challenges",title:"Challenges"},{iconCls:"tocheckedinmerch",tag:"main",title:"Meal Stop"},{iconCls:"explore",tag:"checkin",title:"Explore"},{xtype:"spacer"}]}],listeners:[{element:"element",delegate:"div.badgephoto",event:"tap",fn:"onBadgeTap"},{element:"element",delegate:"div.prizeswonphoto",event:"tap",fn:"onJackpotWinnersTap"},{element:"element",delegate:"div.prizesWonPanel div.x-list-disclosure",event:"tap",fn:"onJackpotWinnersTap"}]},disableAnimation:true,loadingText:"Loading ...",cleanView:function(a){if(a.isXType("clientcheckinexploreview",true)||a.isXType("clientmainpageview",true)){console.debug("Merchant Account Page cleanup");this.removeAll(true)}this.callParent(arguments)},showView:function(){this.callParent(arguments);this.query("tabbar")[0].show();for(var b=0;b<this.getInnerItems().length;b++){this.getInnerItems()[b].setVisibility(true)}var a=this.query("container[tag=feedContainer]")[0];if(a){a[(Ext.StoreMgr.get("NewsStore").getRange().length>0)?"show":"hide"]()}},createView:function(){var a=this;if(!a.callParent(arguments)){return}a.getPreRender().push(Ext.create("Ext.dataview.DataView",{tag:"tbPanel",xtype:"dataview",store:"MerchantRenderStore",useComponents:true,scrollable:undefined,minHeight:window.innerWidth,defaultType:"merchantaccountptsitem",defaultUnit:"em",margin:"0 0 0.7 0"}));if(a.renderFeed){a.getPreRender().push(Ext.create("Ext.Container",{xtype:"container",tag:"feedContainer",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"dataview",scrollable:undefined,store:"NewsStore",cls:"feedPanel",tag:"feedPanel",items:[{docked:"top",xtype:"toolbar",ui:"dark",cls:"feedPanelHdr",centered:false,items:[{xtype:"title",title:"What's going on?"},{xtype:"spacer"}]}],itemTpl:Ext.create("Ext.XTemplate",'<div class="itemWrapper" style="position:relative;{[this.getDisclose(values)]}">','<div class="photo">','<img src="{[this.getIcon(values)]}"/>',"</div>",'<div class="itemTitle">{[this.getTitle(values)]}</div>','<div class="date">{[this.getStartDate(values)]}</div>','<div class="itemDesc">{[this.getDesc(values)]}</div>','<tpl if="this.showImage(values)">','<div class="x-mask x-mask-transparent promoImage">','<img src="{[this.getPhoto(values)]}" style="{[this.getWidth()]}" onload="Ext.removeNode(this.nextSibling);"/>',Genesis.constants.spinnerDom,"</div>",'<img class="promoImageAnchor" src="{[this.getPhoto(values)]}"/>',"</tpl>","</div>",{getDisclose:function(b){switch(b.type){case"vip":b.disclosure=false;break}return((b.disclosure===false)?"padding-right:0;":"")},getIcon:function(b){return a.self.getPhoto({value:b.type})},showImage:function(b){return(b.photo&&b.photo.thumbnail_large_url)},getPhoto:function(b){return(b.photo.thumbnail_large_url)},getStartDate:function(b){return((b.created_date)?"Posted on "+b.created_date:"No Posted Date")},getTitle:function(b){return((b.title)?b.title:"Mobile Promotion")},getDesc:function(b){return b.text},getWidth:function(){var c=Genesis.fn;var b=c.calcPxEm(document.body.clientWidth,-1*2*0.5*0.8,1);return("width:"+c.addUnit(c.calcPx(b,1))+";")}}),onItemDisclosure:Ext.emptyFn}]}))}a.setPreRender(a.getPreRender().concat([Ext.create("Ext.Container",{xtype:"container",tag:"descContainer",layout:{type:"vbox",align:"stretch",pack:"start"},items:[{xtype:"dataview",store:"MerchantRenderStore",scrollable:undefined,cls:"descPanel",tag:"descPanel",items:[{docked:"top",xtype:"toolbar",cls:"descPanelHdr",ui:"light",centered:false,items:[{xtype:"title",title:"About Us"},{xtype:"spacer"}]}],itemTpl:Ext.create("Ext.XTemplate","{[this.getDesc(values)]}",{getDesc:function(b){return b.description}})}]})]))},onBadgeTap:function(c,f,d){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");a.self.playSoundFile(a.sound_files.clickSound);this.fireEvent("badgeTap")},onJackpotWinnersTap:function(c,f,d){var a=_application.getController(((merchantMode)?"server":"client")+".Viewport");a.self.playSoundFile(a.sound_files.clickSound);this.fireEvent("jackpotWinnersTap")},inheritableStatics:{getPhoto:function(a){if(!a.value){return Genesis.constants.getIconPath("miscicons","pushnotification")}else{}}}});Ext.define("Genesis.view.widgets.MerchantDetailsItem",{extend:Ext.dataview.component.DataItem,xtype:"merchantdetailsitem",alias:"widget.merchantdetailsitem",config:{layout:{type:"hbox",align:"stretch"},image:{docked:"left",cls:"photo",tpl:Ext.create("Ext.XTemplate",'<div class="photo"><img src="{[this.getPhoto(values)]}"/></div>',{getPhoto:function(a){return a.Merchant.photo["thumbnail_large_url"]}})},address:{flex:1,tpl:Ext.create("Ext.XTemplate",'<div class="merchantDetailsWrapper"><div class="itemTitle">{name}</div><div class="itemDesc">{[this.getAddress(values)]}</div></div>',{getAddress:function(a){return(a.address+",<br/>"+a.city+", "+a.state+", "+a.country+",</br>"+a.zipcode)}}),cls:"address"},dataMap:{getImage:{setData:"image"},getAddress:{setData:"address"}}},applyImage:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getImage())},updateImage:function(b,a){if(b){this.add(b)}if(a){this.remove(a)}},applyAddress:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getAddress())},updateAddress:function(b,a){if(b){this.add(b)}if(a){this.remove(a)}},updateRecord:function(d){if(!d){return}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),k=e.first(),i=h.getDataMap(),f,j,g,a;if(!k){return}for(f in i){g=i[f];j=h[f]();if(j){for(a in g){if(j[a]){switch(g[a]){case"image":case"address":j[a](b);break;default:j[a](b[g[a]]);break}}}}}k.updateData(b)}});Ext.define("Genesis.view.client.MerchantDetails",{extend:Genesis.view.ViewBase,alias:"widget.clientmerchantdetailsview",config:{cls:"merchantDetails viewport",layout:{type:"vbox",align:"stretch",pack:"start"},defaults:{cls:"separator"},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:" ",items:[{align:"left",tag:"back",ui:"normal",text:"Back"},{align:"right",iconCls:"share",tag:"shareBtn",handler:function(){if(!this.actions){this.actions=Ext.create("Ext.ActionSheet",{hideOnMaskTap:false,defaults:{defaultUnit:"em",margin:"0 0 0.5 0",xtype:"button"},items:[{text:"Refer-A-Friend",ui:"action",tag:"emailShareBtn",scope:this,handler:function(){this.actions.hide()}},{text:"Post on Facebook",tag:"fbShareBtn",ui:"fbBlue",scope:this,handler:function(){this.actions.hide()}},{margin:"0.5 0 0 0",text:"Cancel",iconMaskCls:"dummymask",ui:"cancel",scope:this,handler:function(){this.actions.hide()}}]});Ext.Viewport.add(this.actions)}this.actions.show()}}]})]},renderView:function(e){var a=_application.getController("client.Merchants");var c=e.getSize();var d=Genesis.fn.calcPx(0.7,1);e.setSize(c.width,c.height-(1*12));var f=Ext.Object.toQueryString(Ext.apply({zoom:15,scale:window.devicePixelRatio,maptype:"roadmap",sensor:false,size:c.width+"x"+(c.height-(1*d))},a.markerOptions));var b=Ext.String.urlAppend(a.self.googleMapStaticUrl,f);Ext.getCmp(e.observableId.split(e.observableIdPrefix)[1]).setData({width:c.width,height:c.height-(1*d),photo:b})},cleanView:function(){this.removeAll(true);this.callParent(arguments)},createView:function(){var a=this;if(!a.callParent(arguments)){a.renderView(a.query("component[tag=map]")[0]);return}a.setPreRender(a.getPreRender().concat([Ext.create("Ext.dataview.DataView",{xtype:"dataview",cls:"separator",tag:"details",useComponents:true,defaultType:"merchantdetailsitem",scrollable:undefined,store:"MerchantRenderStore"}),Ext.create("Ext.Component",{xtype:"component",tag:"map",flex:1,cls:"separator_pad gmap",defaultUnit:"em",listeners:{painted:function(b){a.renderView(b)}},tpl:Ext.create("Ext.XTemplate",'<img height="{height}" width="{width}" src="{photo}"/>')})]));a.query("button[tag=shareBtn]")[0].setHidden(_build=="MobileWebClient")}});Ext.define("Genesis.controller.client.Merchants",{extend:Genesis.controller.ControllerBase,inheritableStatics:{googleMapStaticUrl:"http://maps.googleapis.com/maps/api/staticmap"},xtype:"clientmerchantsCntlr",config:{models:["News","Venue"],routes:{"venue/:id/:id":"mainPage","venue/:id/:id/:id":"backToMainPage",venueDetails:"venueDetails"},refs:{main:{selector:"clientmerchantaccountview",autoCreate:true,xtype:"clientmerchantaccountview"},merchantMain:"clientmerchantaccountview container[tag=merchantMain]",tbPanel:"clientmerchantaccountview dataview[tag=tbPanel]",feedContainer:"clientmerchantaccountview container[tag=feedContainer]",descContainer:"clientmerchantaccountview container[tag=descContainer]",descPanel:"clientmerchantaccountview container[tag=descPanel]",merchantDetails:{selector:"clientmerchantdetailsview",autoCreate:true,xtype:"clientmerchantdetailsview"},mapBtn:"viewportview button[tag=mapBtn]",shareBtn:"viewportview button[tag=shareBtn]",mainBtn:"clientmerchantaccountview tabbar[tag=navigationBarBottom] button[tag=main]",prizesBtn:"merchantaccountptsitem component[tag=prizepoints]",redeemBtn:"merchantaccountptsitem component[tag=points]",merchantTabBar:"clientmerchantaccountview tabbar"},control:{main:{showView:"onMainShowView",activate:"onMainActivate",deactivate:"onMainDeactivate",jackpotWinnersTap:"onJackpotWinnersTap",badgeTap:"onBadgeTap"},mapBtn:{tap:"onMapBtnTap"},"clientmerchantaccountview button[ui=orange]":{tap:"onMerchantAccountRewardsTap"},"clientmerchantaccountview list":{select:"onMainSelect",disclose:"onMainDisclose"},merchantTabBar:{tabchange:"onTabBarTabChange"},merchantDetails:{showView:"onDetailsShowView",activate:"onDetailsActivate",deactivate:"onDetailsDeactivate"},"clientmerchantdetailsview map":{maprender:"onMapRender"},"clientmerchantdetailsview component[tag=map]":{}},listeners:{backToMain:"onBackToCheckIn"}},checkinFirstMsg:"Please Check-in before redeeming rewards",init:function(){var a=this;a.markersArray=[];if(window.google&&window.google.maps&&window.google.maps.Map){google.maps.Map.prototype.clearOverlays=function(){if(a.markersArray){for(var b=0;b<a.markersArray.length;b++){a.markersArray[b].setMap(null)}}}}else{console.debug("Google Maps API cannot be instantiated")}Ext.regStore("NewsStore",{model:"Genesis.model.News",autoLoad:false});Ext.regStore("MerchantRenderStore",{model:"Genesis.model.Venue",autoLoad:false});a.callParent(arguments);a.getMain();backBtnCallbackListFn.push(function(c){if(c==a.getMain()){var b=a.getViewPortCntlr();a.self.playSoundFile(b.sound_files.clickSound);a.redirectTo("checkin");return true}return false});Ext.Viewport.on("orientationchange",function(e,d,g,b,f){var c=a.getMain(),h=a.getViewport(),i=a.getMerchantDetails();if(c==h.getActiveItem()){a.refreshPage(c)}else{if(i==h.getActiveItem()){a.refreshPage(i)}}});console.log("Merchants Client Init")},onActivateCommon:function(c,a){var b=(window.google&&window.google.maps&&window.google.maps.Marker)?window.google.maps:null;if(a&&b){c.getMap().clearOverlays();this.marker=new b.Marker(Ext.apply(this.markerOptions,{map:a}));c.setMapCenter(this.latLng)}else{}},onDetailsShowView:function(c){if(Ext.os.is("Android")){var a=this.getEventDispatcher().getPublishers()["elementPaint"].monitors;var b=c.query("component[tag=map]")[0];console.debug("Refreshing MerchantDetails ...");c.query("dataview[tag=details]")[0].refresh();a[b.element.getId()].onElementPainted({animationName:"x-paint-monitor-helper"})}},onDetailsActivate:function(e,f,a,b){var d=this.getViewPortCntlr().getVenue();this.getShareBtn().show();e.query("titlebar")[0].setTitle(d.get("name"))},onDetailsDeactivate:function(a,e,d,b){},onMapRender:function(c,b,a){},checkInAccount:function(){var b=this,c=b.getMainPage();if(c==vport.getActiveItem()){b.refreshPage(c)}else{var a=b.getViewPortCntlr(),e=a.getVenue(),d=a.getCheckinInfo();console.debug("Going back to Checked-In Merchant Home Account Page ...");b.resetView();b.redirectTo("venue/"+d.venue.getId()+"/"+d.customer.getId())}},onMainShowView:function(e){var d=this;if(Ext.os.is("Android")){console.debug("Refreshing MerchantRenderStore ...");var c=this.getEventDispatcher().getPublishers()["elementPaint"].monitors;e.query("dataview[tag=tbPanel]")[0].refresh();var f=e.query("dataview[tag=feedPanel]")[0];if(f){f.refresh()}e.query("dataview[tag=descPanel]")[0].refresh();c[e.element.getId()].onElementPainted({animationName:"x-paint-monitor-helper"})}var b=d.getFeedContainer(),a=e.getScrollable();if(!e.promotion||!b||!b.element){a.getScroller().scrollTo(0,0)}else{Ext.defer(function(){a.getScroller().scrollBy(0,b.element.getY(),true);console.debug("Located the latest Promotional Message Offset["+b.element.getY()+"]");delete e.promotion},3*1000,d)}},onMainActivate:function(k,s,p,e){console.debug("Merchant Account Activate");var v=this;var r=v.getViewPortCntlr();var a=r.getVenue();var g=r.getCustomer();var m=a.getMerchant();var j=g.getId();var f=a.getId();var d=m.getId();var l=r.getCheckinInfo().venue;var w=(l!=null);var q=(w&&(l.getId()==f));var h=Ext.StoreMgr.get("MerchantRenderStore"),n=Ext.StoreMgr.get("CheckinExploreStore");var t=n.getById(a.getId());if(t){t.set("prize_jackpots",a.get("prize_jackpots"))}h.setData(a);v.onCustomerRecordUpdate(g);console.debug("Updated Merchant Account Info");k.showMainBtn=(w&&!q);if(q){k.renderFeed=true;console.debug("Merchant Checkin Mode")}else{k.renderFeed=v.showFeed;console.debug("Merchant Explore Mode")}var u=v.getFeedContainer();if(u){u[(k.renderFeed&&(Ext.StoreMgr.get("NewsStore").getCount()>0))?"show":"hide"]()}v.getMainBtn()[(k.showMainBtn)?"show":"hide"]();var i=v.getPrizesBtn(),b=m.get("features_config");if(i){i.setVisibility(!b||(b&&b.enable_prizes))}var o=k.query("titlebar")[0];o.setTitle(" ");Ext.defer(function(){o.setTitle(a.get("name"))},1,v)},onMainDeactivate:function(a,g,f,d){var e=this;for(var b=0;b<f.getInnerItems().length;b++){}},onMainDisclose:function(j,d,h,f,i,k){var m=this;var l=m.getViewPortCntlr();var g=l.getCheckinInfo().venue;var a=l.getVenue();if(!g||!a||(a.getId()!=g.getId())){Ext.device.Notification.show({title:"Rewards",message:m.checkinFirstMsg,buttons:["Dismiss"]});return}switch(d.get("reward_type")){case"vip":break;default:var b=m.getApplication();var c=b.getController("client.Prizes");var n=Ext.StoreMgr.get("RedeemStore");d=n.getById(d.get("reward_id"));c.fireEvent("showredeemitem",d);break}},onMainSelect:function(c,a,b){c.deselect([a]);this.onMainDisclose(c,a);return false},onCustomerRecordUpdate:function(e){var c=this;var a=Ext.StoreMgr.get("MerchantRenderStore");if(a&&(a.getCount()>0)){if(a&&a.getRange()[0].getMerchant().getId()==e.getMerchant().getId()){var d=c.getPrizesBtn(),b=c.getRedeemBtn();var f;if(d){f=Ext.DomQuery.select("span",d.element.dom)[0];if(f){Ext.fly(f)[e.get("eligible_for_prize")?"removeCls":"addCls"]("x-item-hidden")}}if(b){f=Ext.DomQuery.select("span",b.element.dom)[0];if(f){Ext.fly(f)[e.get("eligible_for_reward")?"removeCls":"addCls"]("x-item-hidden")}}}}},onCheckinTap:function(a,h,d,g){var f=this;var i=f.getApplication();var c=i.getController("client.Checkins");c.fireEvent("checkin")},onBackToCheckIn:function(){var g=this;var e=g.getViewPortCntlr();var a=e.getVenue();var d=e.getCheckinInfo();var b=g.getApplication();var h=b.getController("client.Checkins");var c=d.customer;var f=d.venue;var i=d.metaData;if(a.getId()!=f.getId()){console.debug("Update current Venue to be Checked-In Merchant Account ...");h.fireEvent("setupCheckinInfo","checkin",f,c,i);g.fireEvent("updatemetadata",i)}g.checkInAccount()},onMapBtnTap:function(a,g,c,f){var d=this;d.redirectTo("venueDetails")},onTabBarTabChange:function(b,d,c,a){switch(d.config.tag){default:case"rewards":case"main":Ext.defer(function(){try{if(d){d.setActive(false)}if(c){c.setActive(false)}b._activeTab=null}catch(f){}},2*1000);break}return true},onJackpotWinnersTap:function(a,g,c,f){var d=this;var h=d.getViewPortCntlr().getVenue().getMerchant().getId();d.redirectTo("jackpotWinners/"+h)},onBadgeTap:function(a,f,c,d){this.redirectTo("badges")},mainPage:function(b,a){this.backToMainPage(b,a,0)},backToMainPage:function(f,e,c){var d=this;var a=d.getViewPortCntlr();var b=true;this.openMainPage(b,c>0)},venueDetails:function(){var e=this;var b=e.getViewPortCntlr().getVenue();e.latLng=b.get("latitude")+","+b.get("longitude");var c="red",d="";var a=b.get("address")+", "+b.get("city")+", "+b.get("state")+", "+b.get("country")+", "+b.get("zipcode");e.markerOptions={markers:"color:"+c+"|label:"+d+"|"+this.latLng,center:e.latLng,title:b.get("name")};e.setAnimationMode(e.self.animationMode.cover);e.pushView(e.getMerchantDetails())},getMainPage:function(){return this.getMain()},openMainPage:function(b,c){var e=this;var d=e.getViewport();e.showFeed=b;if(!c){var a=e.getViewPortCntlr();var f=a.getVenue();if(e.getMainPage()==d.getActiveItem()){e.checkInAccount()}else{e.setAnimationMode(e.self.animationMode.pop);e.pushView(e.getMainPage())}console.log("Merchant Account Opened")}else{e.fireEvent("backToMain")}}});Ext.define("Genesis.controller.client.mixin.RedeemBase",{extend:Ext.mixin.Mixin,inheritableStatics:{},config:{},redeemFbMsg:"Use your KICKBAK card or mobile app to earn rewards in your local area",needPointsMsg:function(a){return("You need "+a+" more points "+Genesis.constants.addCRLF()+"to be eligible for this item.")},retrievingQRCodeMsg:"Retrieving QRCode ...",showQrCodeMsg:"Show this Authorization Code to your merchant to redeem!",updateOnFbMsg:"Would you like to tell your friends on Facebook about it?",redeemItemEmailMsg:function(b,a){return('I just got "'+b+'" from '+a+"!")},updatingRedemptionOnFacebook:function(f){var j=this,m=window.plugins.facebookConnect;try{var i=j.getViewPortCntlr(),c=i.getVenue(),a=Genesis.constants.site;var l=c.get("website")?c.get("website").split(/http[s]*:\/\//):[null];var b=c.get("name"),k=l[l.length-1]||a,g=j.redeemFbMsg;var n=j.redeemItemEmailMsg(f.get("title"),c.get("name"));var d={};console.log("Posting Redemption to Facebook ...\nName: "+b+"\nCaption: "+k+"\nDescription: "+g+"\nMessage : "+n+"\n");m.requestWithGraphPath("/me/feed",Ext.apply(d,{name:b,link:k,caption:k,description:g,picture:c.getMerchant().get("photo")["thumbnail_large_url"],message:n}),"POST",function(e){if(!e||e.error||Ext.isString(e)){console.log("Post was not published to Facebook.");Ext.defer(function(p){var o=this;Genesis.fb.facebook_onLogout(null,false);Genesis.fb.facebook_onLogin(function(){o.updatingRedemptionOnFacebook(p)},false)},1,j,[f])}else{console.log("Posted to your Facebook Newsfeed.")}})}catch(h){console.log("Exception ["+h+"]\nPost was not published to Facebook.")}},redeemItemFn:function(g,a){var f=this,d=CustomerReward.getProxy(),e=a.getInnerItems()[0],c=f.getRedeemStore(),b=Ext.StoreMgr.get(c);console.debug("Transmitting Redeem Points Request ...");if(f.getSRedeemBtn()){f.getSRedeemBtn()["hide"]()}CustomerReward[f.getRedeemPointsFn()](e.getData().getId());b.load({addRecords:true,scope:f,jsonData:{},doNotRetryAttempt:true,params:g,callback:function(i,h){if(f.identifiers){f.identifiers.cancelFn()}Ext.Viewport.setMasked(null);if(h.wasSuccessful()){Ext.device.Notification.beep();Ext.device.Notification.show({title:f.getRedeemPopupTitle(),message:f.redeemSuccessfulMsg,buttons:["OK"],callback:function(){f.onDoneTap()}})}else{if(f.getSRedeemBtn()){f.getSRedeemBtn()["show"]()}d.supressErrorsPopup=true;Ext.device.Notification.show({title:f.getRedeemPopupTitle(),message:f.redeemFailedMsg,buttons:["Dismiss"],callback:function(){d.supressErrorsCallbackFn();f.onDoneTap()}})}}})},onActivate:function(d,e,a,b){},updateMetaDataInfo:function(a){var b=this,c=b.callParent(arguments);if(a.data){b.fireEvent("showQRCode",0,a.data)}return c},onRedeemItem:function(a,b,g){var f=this,h=window.plugins.facebookConnect,c=(b)?b.getId():0,i=Genesis.db.getLocalDB(),d={venue_id:c};var e=Genesis.fn.privKey={venueId:c,venue:b.get("name")};e["r"+c]=e["p"+c]=i.csrf_code;f.identifiers=null;f.broadcastLocalID(function(j){f.identifiers=j;Ext.Viewport.setMasked({xtype:"mask",cls:"transmit-mask",html:f.lookingForMerchantDeviceMsg(),listeners:{tap:function(k,m,l){if(!Ext.get(Ext.DomQuery.select(".x-innerhtml",k.element.dom)[0]).getPageBox(true).isOutOfBound({x:m.pageX,y:m.pageY})){Ext.Ajax.abort();if(f.identifiers){f.identifiers.cancelFn()}Ext.Viewport.setMasked(null);f.onDoneTap();Ext.device.Notification.show({title:f.getRedeemPopupTitle(),message:f.transactionCancelledMsg,buttons:["Dismiss"]})}}}});console.debug("Broadcast underway ...");f.redeemItemFn(Ext.apply(d,{data:f.self.encryptFromParams({frequency:f.identifiers.localID},"reward")}),g)},function(){Ext.Viewport.setMasked(null)})},onRedeemItemTap:function(k,f,g,m){var i=this,a=k,h=i.getViewPortCntlr(),c=h.getVenue();var j=i.getRedeemMainPage(),l=j.query("titlebar")[0].getTitle();switch(i.getRedeemMode()){case"redeemPrize":case"redeemReward":var d=function(){if(!i._actions){i._actions=Ext.create("Genesis.view.widgets.PopupItemDetail",{iconType:"prizewon",icon:"phoneInHand",title:i.showToServerMsg(),buttons:[{margin:"0 0 0.5 0",text:"Proceed",ui:"action",height:"3em",handler:function(){h.popUpInProgress=false;i._actions.hide();i.fireEvent("redeemitem",a,c,j)}},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",height:"3em",handler:function(){i._actions.hide();h.popUpInProgress=false}}]});Ext.Viewport.add(i._actions)}h.popUpInProgress=true;i._actions.show()};Ext.Viewport.setMasked({xtype:"loadmask",message:i.prepareToSendMerchantDeviceMsg});window.plugins.proximityID.preLoadSend(function(){Ext.Viewport.setMasked(null);Ext.defer(d,0.25*1000,i)});break}},onRedeemItemShowView:Ext.emptyFn,onShowItemQRCode:function(d,c){var b=this;var a;var f="Redeem "+b.getTitle();a=Genesis.controller.ControllerBase.genQRCode(c);if(a[0]){var e=Ext.DomQuery.select("div.itemPoints",b.getRedeemItem().element.dom)[0];if(b.getSRedeemBtn()){b.getSRedeemBtn().hide()}if(b.getSDoneBtn()){b.getSDoneBtn()["show"]()}b.getSCloseBB().hide();if(e){Ext.fly(e).addCls("x-item-hidden")}b.fireEvent("refreshQRCode",a);Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:f,message:b.showQrCodeMsg,buttons:["OK"]});Ext.device.Notification.vibrate()}else{console.debug("onShowItemQRCode - QR Code encoding Error")}},redeemBrowseSCPage:function(){this.openPage("redeemBrowseSC");if(this.getCloseBtn()){this.getCloseBtn().hide();this.getBackBtn().show()}}});Ext.define("Genesis.view.widgets.RedeemPtsItemBase",{extend:Ext.dataview.component.DataItem,xtype:"redeemptsitembase",alias:"widget.redeemptsitembase",config:{},applyPoints:function(a){return Ext.factory(Ext.apply(a,{}),Ext.Component,this.getPoints())},updatePoints:function(b,a){if(b){this.add(b)}if(a){this.remove(a)}},updateRecord:function(d){if(!d){return}var h=this,c=h.config.dataview,b=c.prepareData(d.getData(true),c.getStore().indexOf(d),d),e=h.getItems(),k=e.first(),i=h.getDataMap(),f,j,g,a;if(!k){return}for(f in i){g=i[f];j=h[f]();if(j){for(a in g){if(j[a]){switch(g[a]){case"points":j[a](b);break;default:j[a](b[g[a]]);break}}}}}k.updateData(b)}});Ext.define("Genesis.view.widgets.RewardPtsItem",{extend:Genesis.view.widgets.RedeemPtsItemBase,xtype:"rewardptsitem",alias:"widget.rewardptsitem",config:{layout:{type:"hbox",align:"stretch"},points:{flex:1,tpl:"{points} Pts",cls:"pointsphoto"},dataMap:{getPoints:{setData:"points"}}}});Ext.define("Genesis.view.widgets.PrizePtsItem",{extend:Genesis.view.widgets.RedeemPtsItemBase,xtype:"prizeptsitem",alias:"widget.prizeptsitem",config:{layout:{type:"hbox",align:"stretch"},points:{flex:1,tpl:"{prize_points} Pts",cls:"prizephoto"},dataMap:{getPoints:{setData:"points"}}}});Ext.define("Genesis.view.RedeemBase",{extend:Genesis.view.ViewBase,alias:"widget.redeeembaseview",config:{},disableAnimation:true,cleanView:function(){this.removeAll(true);this.callParent(arguments)},showView:function(){for(var a=0;a<this.getInnerItems().length;a++){this.getInnerItems()[a].setVisibility(true)}this.callParent(arguments);console.debug("RedeemBase : showView")},_createView:function(b,c,a){var d=this,e=1+Genesis.constants.defaultIconSize()+2*Genesis.fn.calcPx(0.65,1);console.debug("itemHeight="+e);d.setPreRender([{xtype:"list",flex:1,refreshHeightOnUpdate:false,variableHeights:false,itemHeight:e,ui:"bottom-round",store:b,cls:d.getListCls()+" separator_pad",tag:d.getListCls(),itemTpl:Ext.create("Ext.XTemplate",'<div class="photo x-hasbadge"><span class="x-badge round">{[this.getPoints(values)]}</span>','<img src="{[this.getPhoto(values)]}"/></div>','<div class="listItemDetailsWrapper">','<div class="itemTitle">{[this.getTitle(values)]}</div>',"</div>",{getPhoto:function(f){if(!f.photo||!f.photo.url){return d.self.getPhoto(f.type)}return f.photo.url},getTitle:function(f){return f.title},getDesc:function(f){return"This will cost you "+f.points+" Pts"},getPoints:function(f){return f.points}}),onItemDisclosure:Ext.emptyFn,items:[{docked:"top",xtype:"toolbar",cls:"ptsEarnPanelHdr",ui:"light",centered:false,items:[{xtype:"title",title:d.getRedeemTitleText()},{xtype:"spacer"}]}]}])},inheritableStatics:{}});Ext.define("Genesis.view.client.Prizes",{extend:Genesis.view.RedeemBase,alias:"widget.clientprizesview",config:{defaultItemType:"prizeptsitem",ptsEarnTitleText:"Prize Points Available",redeemTitleText:"Choose a Prize to redeem",listCls:"prizesList",scrollable:undefined,cls:"prizesMain viewport",layout:"vbox",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Prizes",items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{hidden:true,align:"left",tag:"back",ui:"normal",text:"Back"}]})]},_createView:function(b,c,a){var d=this;var e=_application.getController(((merchantMode)?"server":"client")+".Viewport").getCustomer();d.callParent(arguments);if(Customer.isValid(e.getId())){d.setPreRender([{cls:"ptsEarnPanel",tag:"ptsEarnPanel",xtype:"dataview",useComponents:true,scrollable:undefined,defaultType:d.getDefaultItemType(),store:c}].concat(d.getPreRender()))}},createView:function(a){var b=this;if(!b.callParent(arguments)){var c=_application.getController(((merchantMode)?"server":"client")+".Viewport").getCustomer();b.query("dataview[tag=ptsEarnPanel]")[0](Customer.isValid(c.getId())?"show":"hide")();return}b._createView("PrizeStore","PrizeRenderCStore",a)},inheritableStatics:{getPhoto:function(a){var b=null;switch(a.value){default:b=Genesis.constants.getIconPath("fooditems",a.value);break}return b}}});Ext.define("Genesis.controller.client.Prizes",{extend:Genesis.controller.PrizeRedemptionsBase,mixins:[Genesis.controller.client.mixin.RedeemBase],inheritableStatics:{},xtype:"clientPrizesCntlr",config:{models:["CustomerReward"],redeemPath:"redeemBrowsePrizesSC",routes:{redeemPrizesChooseSC:"redeemChooseSCPage",redeemBrowsePrizesSC:"redeemBrowseSCPage"},refs:{backBtn:"clientprizesview button[tag=back]",closeBtn:"clientprizesview button[tag=close]",redemptions:{selector:"clientprizesview",autoCreate:true,xtype:"clientprizesview"},redemptionsList:"clientprizesview list[tag=prizesList]",redemptionsPts:"clientprizesview component[tag=points]",redemptionsPtsEarnPanel:"clientprizesview dataview[tag=ptsEarnPanel]",prizeCheckScreen:"clientrewardsview",sBackBB:"clientredeemitemdetailview[tag=redeemPrize] button[tag=back]",sCloseBB:"clientredeemitemdetailview[tag=redeemPrize] button[tag=close]",sDoneBtn:"clientredeemitemdetailview[tag=redeemPrize] button[tag=done]",sRedeemBtn:"clientredeemitemdetailview[tag=redeemPrize] button[tag=redeem]",redeemItem:{selector:"clientredeemitemdetailview[tag=redeemPrize]",autoCreate:true,tag:"redeemPrize",xtype:"clientredeemitemdetailview"}},control:{sRedeemBtn:{tap:"onRedeemItemTap"}},listeners:{prizecheck:"onPrizeCheck",refreshQRCode:"onRefreshQRCode"}},_backToMain:false,checkinFirstMsg:"Please Check-In before redeeming Prizes",eligibleRewardMsg:"Check out an Eligible Prize you can redeem with your Prize Points!",flag:0,wonPrizeMsg:function(a){var d=this;var b=a.prize_points;var c=a.badge_points;return(((b>d.getMinPrizePts())?"You've won a JACKPOT of"+Genesis.constants.addCRLF()+b+" Prize Points!":d.gotMinPrizePtsMsg(b))+Genesis.constants.addCRLF()+d.eligibleRewardMsg)},wonPrizeEmailMsg:function(b,a){return('I just won enough Prize Points to redeem "'+b+'" from '+a+"!")},upgradeBadgeEmailMsg:function(b,a){return("I've just been promoted to "+b.toUpperCase()+" at "+a+"!")},gotMinPrizePtsMsg:function(a){return("You've won "+a+" Prize Points!")},init:function(){var a=this;a.callParent(arguments);a.callBackStack={callbacks:["eligibleForPrizeHandler","redeemPrizeHandler"],arguments:[],startIndex:0};console.log("Prizes Client Init")},stopRouletteTable:function(a){if(a){var b=Ext.get(Ext.DomQuery.select("div.rouletteTable",a.element.dom)[0]);if(b){b.removeCls("spinFwd");b.removeCls("spinBack")}}},stopRouletteBall:function(a){if(a){var b=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);if(b){b.removeCls("spinBack");b.addCls("spinFwd")}}},startRouletteScreen:function(a){if(a){var b=Ext.get(Ext.DomQuery.select("div.rouletteTable",a.element.dom)[0]);if(b){b.addCls("spinFwd")}var c=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);if(c){c.addCls("spinBack")}}},stopRouletteScreen:function(a){this.stopRouletteTable(a);if(a){var b=Ext.get(Ext.DomQuery.select("div.rouletteBall",a.element.dom)[0]);if(b){b.removeCls("spinBack");b.removeCls("spinFwd")}}},updatingPrizeOnFacebook:function(f){var j=this,m=window.plugins.facebookConnect;try{var i=j.getViewPortCntlr();var c=i.getVenue();var a=Genesis.constants.site;var l=c.get("website")?c.get("website").split(/http[s]*:\/\//):[null];var b=c.get("name");var k=l[l.length-1]||a;var g=j.redeemFbMsg;var n=j.wonPrizeEmailMsg(f.get("title"),c.get("name"));var d={};console.log("Posting Prize Win to Facebook ...\nName: "+b+"\nCaption: "+k+"\nDescription: "+g+"\nMessage : "+n+"\n");m.requestWithGraphPath("/me/feed",Ext.apply(d,{name:b,link:k,caption:k,description:g,picture:c.getMerchant().get("photo")["thumbnail_large_url"],message:n}),"POST",function(e){if(!e||e.error||Ext.isString(e)){console.log("Post was not published to Facebook.");Ext.defer(function(p){var o=this;Genesis.fb.facebook_onLogout(null,false);Genesis.fb.facebook_onLogin(function(){o.updatingPrizeOnFacebook(p)},false)},1,j,[f])}else{console.log("Posted to your Facebook Newsfeed.")}})}catch(h){console.log("Exception ["+h+"]\nPost was not published to Facebook.")}},updatingBadgeOnFacebook:function(j){var i=this,m=window.plugins.facebookConnect;try{var h=i.getViewPortCntlr(),c=h.getVenue(),a=Genesis.constants.site;var l=c.get("website")?c.get("website").split(/http[s]*:\/\//):[null];var b=c.get("name"),k=l[l.length-1]||a;var n=j.get("photo")[Genesis.constants._thumbnailAttribPrefix+"large"];var f=i.redeemFbMsg;var o=i.upgradeBadgeEmailMsg(j.get("title"),b);var d={};console.log("Posting Badge Promotion to Facebook ...\nName: "+b+"\nCaption: "+k+"\nDescription: "+f+"\nMessage : "+o+"\n");m.requestWithGraphPath("/me/feed",Ext.apply(d,{name:b,link:k,caption:k,description:f,picture:n,message:o}),"POST",function(e){if(!e||e.error||Ext.isString(e)){console.log("Post was not published to Facebook.");Ext.defer(function(p){var q=this;Genesis.fb.facebook_onLogout(null,false);Genesis.fb.facebook_onLogin(function(){q.updatingBadgeOnFacebook(p)},false)},1,i,[j])}else{console.log("Posted to your Facebook Newsfeed.")}})}catch(g){console.log("Exception ["+g+"]\nPost was not published to Facebook.")}},removeViewHandler:function(a,c){var b=this;if(c>0){console.debug("Removing Last "+c+" Views from History ...");b.silentPopView(c)}if(b._backToMain){b.goToMerchantMain(true);b._backToMain=false}else{b.popView()}},redeemPrizeHandler:function(a,h){var d=this,e=window.plugins.facebookConnect;var g=a.reward_info,c=g.badge_points;var b=Ext.isDefined(g.eligible_prize_id)&&(g.eligible_prize_id>0);d._backToMain=true;if(b){var f=Ext.StoreMgr.get("PrizeStore").getById(g.eligible_prize_id);console.debug("Eligible Prize Id["+g.eligible_prize_id+"]");d.fireEvent("showredeemprize",f,g,h)}else{console.debug("No Eligible Prize");d.removeViewHandler(a,h)}return false},eligibleForPrizeHandler:function(b,i){var h=this,g=h.getViewPortCntlr(),d,k;var c=b.reward_info,j=c.eligible_prize_id>0;var f=c.prize_points;h.flag=0;var a=Ext.isDefined(f)&&(f>0);if(a){var e=function(l,m){if(h.task&&(l==1)){h.task.cancel();h.task=null}if((h.flag|=l)==17){h.flag=0;h.fireEvent("triggerCallbacksChain")}};if(f>h.getMinPrizePts()){d="winPrizeSound";k=h.wonPrizeMsg(c);Ext.device.Notification.vibrate();h.task=Ext.create("Ext.util.DelayedTask",function(){try{h.self.stopSoundFile(g.sound_files[d]);e(1,i)}catch(l){}});h.task.delay(10*1000)}else{d="losePrizeSound";k=h.gotMinPrizePtsMsg(f)}h.self.playSoundFile(g.sound_files[d],Ext.bind(e,h,[1,i]));Ext.device.Notification.show({title:h.scanPlayTitle,message:k,buttons:["OK"],callback:Ext.bind(e,h,[16,i])})}return a},onPrizeCheck:function(b){var c=this;var a=c.getViewPortCntlr();var e=b.reward_info;var d=b.account_info;c.stopRouletteBall(c.getPrizeCheckScreen());if(!Ext.isDefined(e.eligible_prize_id)||(e.eligible_prize_id==0)){viewsPopLength=((e.badge_points>0)||(d.visits==1))?1:0;console.debug("No Prize to Show. viewsPopLength ="+viewsPopLength)}else{viewsPopLength=((e.badge_points>0)||(d.visits==1))?2:1;console.debug("WON LumpSum Prize Points. viewsPopLength ="+viewsPopLength)}c.callBackStack["arguments"]=[b,viewsPopLength];c.fireEvent("triggerCallbacksChain")},onRedeemItemActivate:function(e,f,a,b){var d=this;d.callParent(arguments);d.getSRedeemBtn()["show"]()},onShowRedeemPrize:function(c,a,d){var b=this;b.callParent(arguments);b.stopRouletteScreen(b.getPrizeCheckScreen())},redeemChooseSCPage:function(){var a=this.getApplication().getController("client.Accounts");a.redeemPrizesChooseSCPage()}});Ext.define("Genesis.view.client.Redemptions",{extend:Genesis.view.RedeemBase,alias:"widget.clientredemptionsview",config:{defaultItemType:"rewardptsitem",redeemTitleText:"Rewards available to redeem",ptsEarnTitleText:"Rewards Points Available",listCls:"redemptionsList",scrollable:undefined,cls:"redemptionsMain viewport",layout:"vbox",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Rewards",items:[{align:"left",tag:"close",ui:"normal",text:"Close"},{hidden:true,align:"left",tag:"back",ui:"normal",text:"Back"}]})]},_createView:function(b,c,a){var d=this;var e=_application.getController(((merchantMode)?"server":"client")+".Viewport").getCustomer();d.callParent(arguments);if(Customer.isValid(e.getId())){d.setPreRender([{cls:"ptsEarnPanel",tag:"ptsEarnPanel",xtype:"dataview",useComponents:true,scrollable:undefined,defaultType:d.getDefaultItemType(),store:c}].concat(d.getPreRender()))}},createView:function(a){var b=this;if(!b.callParent(arguments)){var c=_application.getController(((merchantMode)?"server":"client")+".Viewport").getCustomer();b.query("dataview[tag=ptsEarnPanel]")[0](Customer.isValid(c.getId())?"show":"hide")();return}this._createView("RedeemStore","RedemptionRenderCStore",a)},inheritableStatics:{getPhoto:function(a){var b=null;switch(a.value){default:b=Genesis.constants.getIconPath("fooditems",a.value);break}return b}}});Ext.define("Genesis.controller.client.Redemptions",{extend:Genesis.controller.RewardRedemptionsBase,mixins:[Genesis.controller.client.mixin.RedeemBase],inheritableStatics:{},xtype:"clientRedemptionsCntlr",config:{redeemPointsFn:"setRedeemPointsURL",refs:{backBtn:"clientredemptionsview button[tag=back]",closeBtn:"clientredemptionsview button[tag=close]",redemptions:{selector:"clientredemptionsview",autoCreate:true,xtype:"clientredemptionsview"},redemptionsList:"clientredemptionsview list[tag=redemptionsList]",redemptionsPts:"clientredemptionsview component[tag=points]",redemptionsPtsEarnPanel:"clientredemptionsview dataview[tag=ptsEarnPanel]",sBackBB:"clientredeemitemdetailview[tag=redeemReward] button[tag=back]",sCloseBB:"clientredeemitemdetailview[tag=redeemReward] button[tag=close]",sDoneBtn:"clientredeemitemdetailview[tag=redeemReward] button[tag=done]",sRedeemBtn:"clientredeemitemdetailview[tag=redeemReward] button[tag=redeem]",redeemItem:{selector:"clientredeemitemdetailview[tag=redeemReward]",autoCreate:true,tag:"redeemReward",xtype:"clientredeemitemdetailview"}},control:{sRedeemBtn:{tap:"onRedeemItemTap"},sDoneBtn:{tap:"onDoneTap"}}},onRedeemItemActivate:function(e,f,a,b){var d=this;d.callParent(arguments);d.getSRedeemBtn()["show"]();console.debug("RewardItem View - Updated RewardItem View.")},redeemChooseSCPage:function(){var a=this.getApplication().getController("client.Accounts");a.redeemRewardsChooseSCPage()}});Ext.define("Genesis.view.client.Rewards",{extend:Genesis.view.ViewBase,alias:"widget.clientrewardsview",config:{layout:"fit",cls:"rouletteBg",items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Spin and Play"}),{xtype:"component",tag:"prizeCheck",cls:"prizeCheck",data:{},tpl:'<div class="rouletteTable"></div><div class="rouletteBall"></div>'}],listeners:[{element:"element",delegate:"div.prizeCheck",event:"tap",fn:"onRouletteTap"}]},onRouletteTap:function(a,d,c){this.fireEvent("rouletteTap",this.metaData)},inheritableStatics:{getPhoto:function(a){var b=null;switch(a.value){case"vip":b=Genesis.constants.getIconPath("miscicons",a.value);break;default:b=Genesis.constants.getIconPath("fooditems",a.value);break}return b}}});Ext.define("Genesis.controller.client.Rewards",{extend:Genesis.controller.ControllerBase,inheritableStatics:{},xtype:"clientRewardsCntlr",config:{mode:"rewards",models:["PurchaseReward","CustomerReward"],routes:{scanAndWin:"scanAndWinPage",promotion:"promotionPage"},refs:{rewards:{selector:"clientrewardsview",autoCreate:true,xtype:"clientrewardsview"},promotion:{selector:"clientpromotionalitemview[tag=promotion]",autoCreate:true,tag:"promotion",xtype:"clientpromotionalitemview"},pDoneBtn:"clientpromotionalitemview[tag=promotion] button[tag=done]"},control:{rewards:{activate:"onActivate",deactivate:"onDeactivate",rouletteTap:"onRouletteTap"},promotion:{createView:"onPromotionCreateView",activate:"onPromotionActivate",deactivate:"onPromotionDeactivate",promoteItemTap:"onPromoteItemTap"},pDoneBtn:{tap:"onPromotionDoneTap"}},listeners:{rewarditem:"onRewardItem"}},cannotDetermineLocationMsg:"Cannot determine current location. Visit one of our venues to continue!",missingEarnPtsCodeMsg:"No Authorization Code was found.",checkinFirstMsg:"Please Check-In before earning rewards",authCodeReqMsg:"Proceed to scan an Authorization Code from your merchant to earn Reward Pts!",birthdayPageTitle:"Birthday Reward",birthdayTitle:"Happy Brithday!",signupPageTitle:"Signup Reward",signupPromotionTitle:"Welcome!",referralPageTitle:"Refer A Friend",referralPromotionTitle:"Referral Award",badgePageTitle:"Badge Promotion",badgePromotionTitle:"Badge Promotion Award",prizeCheckMsg:"Play our Instant Win Game to win Bonus Prize Points!",signupPromotionMsg:function(a){return"You've earned "+a+" Reward Pts from Signing Up for this merchant!"},birthdayMsg:function(a){return"You've earned "+a+"Bonus Reward Pts!"},getPointsMsg:function(a){var d=this;var b=a.points;var c=a.referral_points;var e=(a.prize_points&&(a.prize_points>0))?d.prizeCheckMsg:"";return"You've earned "+b+" Reward Pts from this purchase."+((c>0)?"":" "+e)},getReferralMsg:function(a){return this.getVipMsg(a)},getVipMsg:function(a){return("You've earned an additional "+Genesis.constants.addCRLF()+a+" Reward Pts!"+Genesis.constants.addCRLF()+this.prizeCheckMsg)},getBadgeMsg:function(b,a){var c="You've been Promoted to"+Genesis.constants.addCRLF()+"Badge Level "+a.get("type").display_value+"!";if(b>0){c+=(Genesis.constants.addCRLF()+"For that, you've earned "+Genesis.constants.addCRLF()+b+" Bonus Reward Pts!")}return c},vipPopUp:function(a,b){b=b||Ext.emptyFn;Ext.device.Notification.show({title:"VIP Challenge",message:this.getVipMsg(a),buttons:["OK"],callback:b})},identifiers:null,init:function(){this.callParent(arguments);console.log("Client Rewards Init");this.callBackStack={callbacks:["birthdayHandler","signupPromotionHandler","badgePtsHandler","earnPtsHandler","referralPromotionHandler","scanAndWinHandler"],arguments:[],startIndex:0};this.getRewards()},rewardItemFn:function(i){var h=this,f=h.getViewPortCntlr();if(h.identifiers==null){return}var j=Genesis.db.getLocalDB(),d=f.getLastPosition(),k=h.identifiers.localID;var a=f.getVenue(),b=(i)?a.getId():null;var e=PurchaseReward.getProxy().getReader();var c={},g;if(!b){if(!d){if(h.identifiers){h.identifiers.cancelFn()}Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:"Rewards",message:h.cannotDetermineLocationMsg,buttons:["Dismiss"]});return}c=Ext.apply(c,{data:h.self.encryptFromParams({frequency:k},"reward"),latitude:d.coords.getLatitude(),longitude:d.coords.getLongitude()})}else{c=Ext.apply(c,{data:h.self.encryptFromParams({frequency:k},"reward"),venue_id:b})}console.debug("Transmitting Reward Points Request ...");PurchaseReward.setEarnPointsURL();e.setRootProperty("");e.buildExtractors();PurchaseReward.load(1,{jsonData:{},doNotRetryAttempt:true,params:c,callback:function(l,m){e.setRootProperty("data");e.buildExtractors();if(h.identifiers){h.identifiers.cancelFn()}Ext.Viewport.setMasked(null);if(m.wasSuccessful()){Ext.device.Notification.beep();h.fireEvent("triggerCallbacksChain")}}});delete h.qrcode},onScannedQRcode:function(b){var a=this;if(b){a.qrcode=b;switch(a.getMode()){case"rewardsSC":a.onLocationUpdate();break;default:a.getGeoLocation();break}}else{console.debug(a.missingEarnPtsCodeMsg);Ext.device.Notification.show({title:"Error",message:a.missingEarnPtsCodeMsg,buttons:["Dismiss"],callback:function(){}})}},onLocationUpdate:function(a){var b=this;b.rewardItemFn(false)},onPromoteItemTap:function(a,f,c,d){this.onPromotionDoneTap()},promotionHandler:function(b,f,g,k,l,h){var e=this,j=e.getViewport(),d=e.getPromotion();var c=Genesis.constants._thumbnailAttribPrefix+"large";var a={};a[c]=(Ext.isObject(k))?Genesis.view.client.Badges.getPhoto(k.get("type"),"thumbnail_large_url"):a[c]=Genesis.constants.getIconPath(k,"reward");e.promoteCount++;e.redeemItem=Ext.create("Genesis.model.CustomerReward",{title:(Ext.isObject(k))?k.get("type").display_value:null,type:{value:"promotion"},photo:a,points:g,time_limited:false,quantity_limited:false,merchant:null});var i=d.query("titlebar")[0];i.setTitle(b);e.redirectTo("promotion");Ext.device.Notification.show({title:f,message:l,buttons:["OK"],callback:h||Ext.emptyFn})},birthdayHandler:function(b,e,c,g){var f=this,d=b.reward_info,i=f.getViewport(),h=d.birthday_points;var a=Ext.isDefined(h)&&(h>0);f.promoteCount=0;if(a){f.promotionHandler(f.birthdayPageTitle,f.birthdayTitle,h,"prizewon",f.birthdayMsg(h),function(){f.self.stopSoundFile(f.getViewPortCntlr().sound_files.birthdaySound)});f.self.playSoundFile(f.getViewPortCntlr().sound_files.birthdaySound)}return a},signupPromotionHandler:function(b,e,c,g){var f=this,d=b.reward_info,i=f.getViewport(),h=d.signup_points;var a=Ext.isDefined(h)&&(h>0);if(a){f.promotionHandler(f.signupPageTitle,f.signupPromotionTitle,h,"prizewon",f.signupPromotionMsg(h))}return a},earnPtsHandler:function(a,f,h,g){var c=this,e=a.reward_info,b=e.points;var d=Ext.isDefined(b)&&(b>0);if(d){Ext.device.Notification.show({title:"Rewards",message:c.getPointsMsg(e),buttons:["OK"],callback:function(){c.fireEvent("triggerCallbacksChain")}})}return d},referralPromotionHandler:function(a,f,h,g){var c=this,e=a.reward_info,b=e.referral_points;var d=Ext.isDefined(b)&&(b>0);if(d){c.promotionHandler(c.referralPageTitle,c.referralPromotionTitle,b,"prizewon",c.getReferralMsg(b))}return d},badgePtsHandler:function(b,g,c,k){var i=this,d=b.reward_info,j=b.account_info,l=d.badge_points,e=j.badge_id;var f=i.getViewPortCntlr(),h=Ext.StoreMgr.get("BadgeStore").getById(e);var a=(l>0)||(j.visits==1);if(a){i.promotionHandler(i.badgePageTitle,i.badgePromotionTitle,l,h,i.getBadgeMsg(l,h),function(){i.self.stopSoundFile(f.sound_files.promoteSound)});i.self.playSoundFile(f.sound_files.promoteSound)}return a},scanAndWinHandler:function(b,i,c,l){var j=this,d=b.reward_info,k=b.account_info,m=d.points,h=d.prize_points;var a=Ext.isDefined(m)&&(m>0);var f=Ext.isDefined(h)&&(h>0);if(j.promoteCount>0){console.debug("Removing Promotion View from History ...");j.silentPopView(1)}j.promoteCount=0;if((l>0)&&(k.visits>=2)){Genesis.db.removeReferralDBAttrib("m"+l)}if(a&&f){j.redirectTo("scanAndWin")}else{if(f){var e=j.getApplication(),g=e.getController("client.Prizes");g.fireEvent("prizecheck",b)}else{if(a){j.goToMerchantMain(true)}}}return false},onRedeemItemActivate:function(e,f,a,b){var d=this;d.callParent(arguments);d.getRefreshBtn()["hide"]();d.getSRedeemBtn()["show"]()},onRewardItem:function(f){var e=this,d,b=e.getViewPortCntlr();e.identifiers=null;var c=Genesis.db.getLocalDB(),h=b.getVenue(),g,a=b.getLastPosition();if(!a||(a.coords&&(a.coords.getTimestamp()<(new Date()).addMinutes(-5).getTime()))){b.setLastPosition(null)}if(!f){g=-1;privKey=Genesis.fn.privKey={venueId:g,venue:Genesis.constants.debugVenuePrivKey};privKey["r"+g]=privKey["p"+g]=c.csrf_code;if(!b.getLastPosition()){e.getGeoLocation()}}else{g=h.getId();privKey=Genesis.fn.privKey={venueId:g,venue:h.get("name")};privKey["r"+g]=privKey["p"+g]=c.csrf_code}e.broadcastLocalID(function(i){e.identifiers=i;Ext.Viewport.setMasked({xtype:"mask",cls:"transmit-mask",html:e.lookingForMerchantDeviceMsg(),listeners:{tap:function(j,l,k){if(!Ext.get(Ext.DomQuery.select(".x-innerhtml",j.element.dom)[0]).getPageBox(true).isOutOfBound({x:l.pageX,y:l.pageY})){Ext.Ajax.abort();if(e.identifiers){e.identifiers.cancelFn()}Ext.Viewport.setMasked(null);Ext.device.Notification.show({title:"Rewards",message:e.transactionCancelledMsg,buttons:["Dismiss"]})}}}});console.debug("Broadcast underway ...");if(f||b.getLastPosition()){e.rewardItemFn(f)}},function(){Ext.Viewport.setMasked(null)})},onEarnPts:function(c){var b=this;var a=b.isOpenAllowed();if(a!==true){Ext.device.Notification.show({title:"Error",message:a,buttons:["Dismiss"]});return}else{Ext.Viewport.setMasked({xtype:"loadmask",message:b.prepareToSendMerchantDeviceMsg});window.plugins.proximityID.preLoadSend(function(){Ext.Viewport.setMasked(null);Ext.defer(function(){var d=b.getViewPortCntlr();if(!b._actions){b._actions=Ext.create("Genesis.view.widgets.PopupItemDetail",{iconType:"prizewon",icon:"phoneInHand",title:b.showToServerMsg(),buttons:[{margin:"0 0 0.5 0",text:"Proceed",ui:"action",height:"3em",handler:function(){d.popUpInProgress=false;b._actions.hide();b.fireEvent("rewarditem",c)}},{margin:"0.5 0 0 0",text:"Cancel",ui:"cancel",height:"3em",handler:function(){d.popUpInProgress=false;b._actions.hide()}}]});Ext.Viewport.add(b._actions)}d.popUpInProgress=true;b._actions.show()},0.25*1000,b)})}},updateMetaDataInfo:function(c){var d=this,a=d.getViewPortCntlr(),e=d.callParent(arguments);var g=a.getVenue(),f=c.merchant_id||g.getMerchant().getId();d.callBackStack["arguments"]=[c,e,g,f];if(c.data){var b=d.getApplication().getController("client.Prizes");b.fireEvent("showQRCode",0,c.data)}},onRouletteTap:function(c){var d=this,a=d.getViewPortCntlr();var g=d.getApplication(),b=g.getController("client.Prizes");if(d.task){try{d.task.cancel();delete d.task;d.self.stopSoundFile(a.sound_files.rouletteSpinSound);d.self.playSoundFile(a.sound_files.clickSound)}catch(f){}console.debug("Stopped RouletteSound, checking for prizes ...");b.fireEvent("prizecheck",c)}},onActivate:function(d,i,k,g){var j=this,h=j.getViewPortCntlr();var b=j.getApplication(),f=b.getController("client.Prizes");var a=j.callBackStack["arguments"][0],e=Ext.bind(j.onRouletteTap,j,[a]);d.metaData=a;j.task=Ext.create("Ext.util.DelayedTask",e);j.task.delay(15*1000);j.self.playSoundFile(h.sound_files.rouletteSpinSound,e);Ext.defer(f.startRouletteScreen,1*1000,f,[j.getRewards()])},onDeactivate:function(a,e,d,b){},onContainerActivate:function(e,d,a,b){},onPromotionCreateView:function(b){var a=this;b.item=a.redeemItem},onPromotionActivate:function(d,e,a,b){},onPromotionDeactivate:function(d,e,a,b){},onPromotionDoneTap:function(a,f,c){var d=this;d.fireEvent("triggerCallbacksChain")},scanAndWinPage:function(){var a=this;this.openPage("scanAndWin")},promotionPage:function(){var a=this;this.openPage("promotion")},getMainPage:function(){var a=this.getRewards();return a},openPage:function(a){var d=this,c=d.getViewport();d.setMode(a);switch(a){case"scanAndWin":d.setAnimationMode(d.self.animationMode.coverUp);d.pushView(d.getRewards());break;case"rewardsSC":d.onEarnPts(false);break;case"rewards":d.onEarnPts(true);break;case"promotion":var f=d.getPromotion();if(c.getActiveItem()==f){var b=c.getEventDispatcher().controller,e=new Ext.fx.layout.Card(d.self.animationMode.fade);e.on("animationend",function(){console.debug("Animation Complete");e.destroy()},d);console.debug("Reloading Promotion Page");c.animateActiveItem(f,e);e.onActiveItemChange(c.getLayout(),f,f,null,b);c.doSetActiveItem(f,null)}else{d.setAnimationMode(d.self.animationMode.coverUp);d.pushView(d.getPromotion())}break}},isOpenAllowed:function(){return true}});Ext.define("Genesis.view.widgets.ListField",{extend:Ext.field.Text,alternateClassName:"Genesis.field.List",xtype:"listfield",config:{ui:"list",component:{useMask:false},clearIcon:true,iconCls:"",readOnly:false},initialize:function(){var b=this,a=b.getComponent();b.callParent();if(b.getIconCls()){Ext.fly(b.element.query("."+Ext.baseCSSPrefix.trim()+"component-outer")[0]).addCls(b.getIconCls())}a.setReadOnly(true)},doClearIconTap:Ext.emptyFn});Ext.define("Genesis.view.client.SettingsPage",{extend:Ext.form.Panel,alias:"widget.clientsettingspageview",config:{preRender:null,cls:"viewport",scrollable:"vertical",layout:{type:"vbox",align:"stretch",pack:"start"},items:[Ext.apply(Genesis.view.ViewBase.generateTitleBarConfig(),{title:"Settings",items:[{align:"left",tag:"back",ui:"normal",text:"Back"}]}),{xtype:"fieldset",title:"Account Profile",defaults:{labelWidth:"50%"},items:[{xtype:"textfield",cls:"halfHeight",labelWidth:"100%",name:"user",label:"John Smith<br/><label>johnsmith@example.com</label>",value:" ",required:false,readOnly:true},{xtype:"datepickerfield",labelWidth:"30%",label:"Birthday",name:"birthday",dateFormat:"M j, Y",required:false,picker:{yearFrom:1913,doneButton:{ui:"normal"}},value:0},Ext.apply({labelWidth:"30%",label:"Phone#",name:"phone",required:false},Genesis.view.ViewBase.phoneField()),{xtype:"listfield",name:"changepassword",label:"Change Password",value:" "}]},{tag:"accountUpdate",xtype:"button",ui:"orange-large",style:"margin-bottom:1.5em",text:"Update"},{xtype:"fieldset",title:"Social Settings",defaults:{labelWidth:"60%"},items:[{xtype:"togglefield",name:"facebook",label:'<img src="'+Genesis.constants.resourceSite+"images/"+Genesis.constants.themeName+'/facebook_icon.png" style="height:'+(2.5/0.8)+'em;float:left;margin-right:0.8em;"/> Facebook',value:0},{hidden:true,xtype:"togglefield",name:"twitter",label:'<img src="'+Genesis.constants.resourceSite+"images/"+Genesis.constants.themeName+'/twitter_icon.png" style="height:'+(2.5/0.8)+'em;float:left;margin-right:0.8em;"/> Twitter',value:0}]},{xtype:"fieldset",title:"About Kickbak",defaults:{labelWidth:"50%"},items:[{xtype:"textfield",label:"Version "+Genesis.constants.clientVersion,clearIcon:false,readOnly:true},{xtype:"listfield",name:"terms",label:"Terms of Use",value:" "},{xtype:"listfield",name:"privacy",label:"Privacy",value:" "}]}]},initialize:function(){this.callParent(arguments);this.setPreRender([])},cleanView:function(){return Genesis.view.ViewBase.prototype.cleanView.apply(this,arguments)},removeAll:function(a,b){return Genesis.view.ViewBase.prototype.removeAll.apply(this,arguments)},createView:function(){return Genesis.view.ViewBase.prototype.createView.apply(this,arguments)},showView:function(){return Genesis.view.ViewBase.prototype.showView.apply(this,arguments)}});Ext.define("Genesis.controller.client.Settings",{extend:Genesis.controller.SettingsBase,settingsTitle:"Account Settings",enableFBMsg:"By connecting to Facebook, you will receive additional Reward Pts everytime we update your KICKBAK activity to your Facebook account!",disableFBMsg:"",enableTwitterMsg:"By enabling Twitter connectivity, you will receive additional reward points everytime we update your KICKBAK activity to their site!",disableTwitterMsg:"",twitterUnconfiguredMsg:"Please configure your Twitter App",inheritableStatics:{accountValidateFailedMsg:function(a){return a+Genesis.constants.addCRLF()+"Please with correct syntax."},accountValidate:function(d,h){var e=this,c=Ext.create("Genesis.model.frontend.Account",h),b=c.validate(),g,i,a,f,j;if(!b.isValid()){do{a=false;g=b.first();if(g){i=d.query("field[name="+g.getField()+"]")[0];if(!i||!i.getRequired()||(g.getField()=="password")){if(!i||!i.getValue()||(i.getValue()=="")||(i.getValue()==" ")){b.remove(g);a=true}}}else{i=null}}while(a);if(i){f=i.getLabel();j=e.accountValidateFailedMsg(f+" "+g.getMessage());console.debug(j);Ext.device.Notification.show({title:e.settingsTitle,message:j,buttons:["Dismiss"]});return null}}return c}},xtype:"clientSettingsCntlr",config:{models:["Genesis.model.frontend.Account"],refs:{settingsPage:{selector:"clientsettingspageview",autoCreate:true,xtype:"clientsettingspageview"}},control:{settingsPage:{deactivate:"onDeactivate"},"clientsettingspageview togglefield[name=facebook]":{change:"onFacebookChange"},"clientsettingspageview togglefield[name=twitter]":{change:"onTwitterChange"},"clientsettingspageview listfield[name=changepassword]":{clearicontap:"onPasswordChangeTap"},"clientsettingspageview button[tag=accountUpdate]":{tap:"onAccountUpdateTap"},"clientsettingspageview listfield[name=terms]":{clearicontap:"onTermsTap"},"clientsettingspageview listfield[name=privacy]":{clearicontap:"onPrivacyTap"},"clientsettingspageview listfield[name=aboutus]":{clearicontap:"onAboutUsTap"}},listeners:{toggleFB:{fn:"onToggleFB",buffer:500},toggleTwitter:{fn:"onToggleTwitter",buffer:300}}},initializing:true,accountUpdateSuccessMsg:"Update Successful",accountUpdateFailedMsg:"Update Failed",fbLoggedInIdentityMsg:function(a){return"You're logged into Facebook as "+Genesis.constants.addCRLF()+a},updatingFbLoginMsg:"Updating Facebok Login Credentials",getAccountFields:function(){var c=this,a=Genesis.db.getLocalDB(),b=c.getSettingsPage();return({birthday:{preLoadFn:function(d){d.setReadOnly(false)},field:b.query("datepickerfield[name=birthday]")[0],fn:function(e){var d=new Date.parse(a.account["birthday"]);return(!d||!(d instanceof Date))?" ":d},fbFn:function(e){var d=new Date.parse(a.fbResponse["birthday"]);if(!d||!(d instanceof Date)){d=" "}if(d instanceof Date){e.setReadOnly(true)}return d}},phone:{preLoadFn:Ext.emptyFn,field:b.query("textfield[name=phone]")[0],fn:function(e){var d=a.account["phone"].match(Account.phoneRegex);return(d[1]+"-"+d[2]+"-"+d[3])},fbFn:Ext.emptyFn}})},updateFBSettings:function(b){var a=this;Ext.defer(function(){Ext.device.Notification.show({title:"Facebook Connect",message:a.fbLoggedInIdentityMsg(b.email),buttons:["OK"]})},1,a)},updateFBSettingsPopup:function(d,a){var c=this,b=Genesis.db.getLocalDB();Genesis.fb.facebook_onLogin(function(f,e){Ext.Viewport.setMasked(null);if(!f||((e&&!e.wasSuccessful()))){if(c.getSettingsPage()&&!c.getSettingsPage().isHidden()&&a){a.toggle()}}else{c.updateFBSettings(f);if(a){a.originalValue=1;c.updateAccountInfo()}}},b.enableTwitter)},updateAccountInfo:function(){var c,g,e=this,b=Genesis.db.getLocalDB(),a=e.getAccountFields(),d=e.getSettingsPage();for(c in a){g=a[c];g.preLoadFn(g.field);if(b.account[c]){g[c]=g.fn(g.field)}else{if(b.fbResponse){g[c]=g.fbFn(g.field)}else{g[c]=null}}}console.log("enableFB - "+b.enableFB+", enableTwitter - "+b.enableTwitter);e.initializing=true;d.setValues({birthday:a.birthday.birthday,phone:a.phone.phone,facebook:(b.enableFB)?1:0,twitter:(b.enableTwitter)?1:0});d.query("textfield[name=user]")[0].setLabel(b.account.name+"<br/><label>"+b.account.email+"</label>");e.initializing=false},onPasswordChangeTap:function(c,f){var d=this;var a=d.getViewPortCntlr();d.self.playSoundFile(a.sound_files.clickSound);d.redirectTo("password_change")},onAccountUpdateTap:function(a,j,f){var h=this,g=h.getSettingsPage(),c=g.getValues(true),d=Account.getProxy();var i=h.self.accountValidate(g,c);if(i){Ext.Viewport.setMasked({xtype:"loadmask",message:h.establishConnectionMsg});Account.setUpdateAccountUrl();i.save({action:"read",jsonData:{},callback:function(b,e){Ext.Viewport.setMasked(null);if(e.wasSuccessful()){Ext.device.Notification.show({title:h.settingsTitle,message:h.accountUpdateSuccessMsg,buttons:["OK"]})}else{d.supressErrorsPopup=true;Ext.device.Notification.show({title:h.settingsTitle,message:h.accountUpdateFailedMsg,buttons:["Dismiss"],callback:function(){d.supressErrorsCallbackFn()}})}}})}},onDeactivate:function(a,g,f,b){var e=this,d=Genesis.fb;console.debug("Settings: onDeactivate");e.onFbDeacitvate()},onToggleFB:function(g,d,b,c,a,h){var i=this,e=Genesis.fb,j=Genesis.db.getLocalDB();i.callParent(arguments);if(c==1){}else{if(j.enableFB){console.debug("Cancelling Facebook Login ...");var f={facebook_id:0};Account.setUpdateFbLoginUrl();Account.load(0,{jsonData:{},params:{user:Ext.encode(f)},callback:function(k,l){if(l.wasSuccessful()){j=Genesis.db.getLocalDB();j.enableFB=false;j.currFbId=0;delete j.fbAccountId;delete j.fbResponse;Genesis.db.setLocalDB(j);if(Genesis.fn.isNative()){Genesis.fb.facebook_onLogout(null,true)}}else{if(!i.getSettingsPage().isHidden()){g.toggle()}}}})}}},updateFBSignUpPopupCallback:function(e,b){var c=this,d=c.getSettingsPage();var a=(d)?d.query("togglefield[name=facebook]")[0]:null;Ext.Viewport.setMasked(null);if((b&&b.wasSuccessful())||(e&&(e.type!="timeout"))){c.updateFBSettings(e);if(a){a.originalValue=1;c.updateAccountInfo()}}else{if(a){a.toggle()}Ext.device.Notification.show({title:"Facebook Connect",message:Genesis.fb.fbConnectFailMsg,buttons:["Dismiss"]})}},updateFBSignUp:function(b){var a=this;Ext.defer(function(){Ext.device.Notification.show({title:"Facebook Connect",message:a.fbLoggedInIdentityMsg(b.email),buttons:["OK"]})},1,a);a.response=b},onToggleTwitter:function(f,d,b,c,a,g){var h=this,i=Genesis.db.getLocalDB();var e=function(){Ext.device.Notification.show({title:h.settingsTitle,message:h.enableTwitterMsg,buttons:["Dismiss"]});i.enableTwitter=true;Genesis.db.setLocalDB(i)};if(c==1){console.debug("Enabling Twitter Login ...");if(Genesis.fn.isNative()){window.plugins.twitter.isTwitterSetup(function(j){if(j==1){if(!i.enableFB){e()}}else{Ext.device.Notification.show({title:h.settingsTitle,message:h.twitterUnconfiguredMsg,buttons:["Dismiss"]});if(!h.getSettingsPage().isHidden()){f.toggle()}}})}else{e()}}else{if(i.enableTwitter){console.debug("Cancelling Twitter Login ...");i.enableTwitter=false;Genesis.db.setLocalDB(i)}}},openSettingsPage:function(){var a=this;a.updateAccountInfo();a.openPage("settings")}});Ext.require(["Genesis.controller.ControllerBase"],function(){if(!Genesis.fn.isNative()){window.onhashchange=function(){if(location.hash!=("#"+_application.getHistory().getToken())){location.hash="#"+_application.getHistory().getToken();onBackKeyDown()}}}});(function(){onBackKeyDown=function(g){if(!_application||Ext.Viewport.getMasked()){return}var a=_application.getController("client.Viewport");if(!a||a.popViewInProgress){return}else{if(Ext.device.Notification.msg&&!Ext.device.Notification.msg.isHidden()){Ext.device.Notification.dismiss();return}else{if(!a.popUpInProgress){var f=a.getViewport();var j=(f)?f.getActiveItem():null;if(j){console.debug("BackButton Pressed");var h=false;for(var c=0;c<backBtnCallbackListFn.length;c++){h=backBtnCallbackListFn[c](j);if(h){break}}if(!h){var d=j.query("button[tag=back]")[0];var b=j.query("button[tag=close]")[0];if((d&&!d.isHidden())||(b&&!b.isHidden())){a.self.playSoundFile(a.sound_files.clickSound);a.popView()}}else{a.self.playSoundFile(a.sound_files.clickSound);if(Genesis.fn.isNative()){navigator.app.exitApp()}else{window.location.reload()}}}}}}}})();Ext.define("Genesis.controller.client.Viewport",{extend:Genesis.controller.ViewportBase,inheritableStatics:{},config:{apsPayload:null,loggedIn:false,customer:null,venue:null,metaData:null,checkinInfo:{venue:null,customer:null,metaData:null},lastPosition:null,refs:{shareBtn:"button[tag=shareBtn]",emailShareBtn:"actionsheet button[tag=emailShareBtn]",fbShareBtn:"actionsheet button[tag=fbShareBtn]"},control:{fbShareBtn:{tap:"onShareMerchantTap"},emailShareBtn:{tap:"onShareEmailTap"},"tabbar[tag=navigationBarTop] button[tag=info]":{tap:"onInfoTap"},"viewportview button[tag=home]":{tap:"onHomeButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=prizes]":{tap:"onPrizesButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=prizesSC]":{tap:"onRedeemPrizesSCButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=accounts]":{tap:"onAccountsButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=challenges]":{tap:"onChallengesButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=rewards]":{tap:"onRewardsButtonTap"},"viewportview button[tag=rewardsSC]":{tap:"onRewardsSCButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=redemption]":{tap:"onRedemptionsButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=redemptionSC]":{tap:"onRedeemRewardsSCButtonTap"},"tabbar[tag=navigationBarBottom] button[tag=main]":{tap:"onCheckedInAccountTap"},"tabbar[tag=navigationBarBottom] button[tag=checkin]":{tap:"onCheckinTap"},"tabbar[tag=navigationBarBottom] button[tag=browse]":{tap:"onBrowseTap"},"viewportview dataview[tag=mainMenuSelections]":{select:"onButtonTap"},"viewportview dataview[tag=badgesMenuSelections]":{select:"onButtonTap"},"viewportview dataview[tag=challengeMenuSelections]":{select:"onButtonTap"},"viewportview list[tag=jackpotWinnersList]":{select:"onButtonTap"},"actionsheet button":{tap:"onButtonTap"},"datepicker button":{tap:"onButtonTap"}},listeners:{completeRefreshCSRF:"onCompleteRefreshCSRF",updateDeviceToken:"onUpdateDeviceToken"}},fbShareSuccessMsg:"Posted on your Facebook Timeline!",shareReqMsg:function(){return"Would you like to do our"+Genesis.constants.addCRLF()+"Referral Challenge?"},onLocationUpdate:function(b){var d=this,f=d.getApsPayload(),e=Ext.StoreMgr.get("VenueStore"),a=d,c=e.getProxy(),g={merchant_id:f.merchant_id};if(b){g=Ext.apply(g,{latitude:b.coords.getLatitude(),longitude:b.coords.getLongitude()})}Ext.Viewport.setMasked({xtype:"loadmask",message:d.getVenueInfoMsg});Venue.setGetClosestVenueURL();e.load({scope:d,params:g,callback:function(j,i){d.setApsPayload(null);Ext.Viewport.setMasked(null);if(i.wasSuccessful()){var h=j[0];if(j.length>1){console.debug("Found "+j.length+" venues matching current location, pick the first one ...")}a.setVenue(h);controller=d.getApplication().getController("client.Checkins");controller.setPosition(b);controller.fireEvent("checkin")}else{c.supressErrorsPopup=true;Ext.device.Notification.show({title:"Error",message:d.missingVenueInfoMsg(i.getError()),buttons:["Dismiss"],callback:function(){c.supressErrorsCallbackFn()}})}}})},onUpdateDeviceToken:function(){var c=this,a=c.getApplication().getController("client.MainPage"),b=Account.getProxy();if(c.getLoggedIn()&&Genesis.constants.device&&a&&!a.updatedDeviceToken){Account.setUpdateRegUserDeviceUrl();console.debug("setUpdateRegUserDeviceUrl - Refreshing Device Token ...");b.supressErrorsPopup=true;Account.load(0,{jsonData:{},params:{device:Ext.encode(Genesis.constants.device)},callback:function(d,e){b.supressErrorsPopup=false;if(e.wasSuccessful()){a.updatedDeviceToken=true}}})}},onShareEmailTap:function(a,g,c,f){var d=this;Ext.device.Notification.show({title:"Referral Challenge",message:d.shareReqMsg(),buttons:["Yes","No"],callback:function(b){if(b.toLowerCase()=="yes"){var e=d.getApplication();d.onChallengesButtonTap(null,null,null,null,function(){var m=d.getViewPortCntlr().getVenue();var l=m.getId();var j=m.challenges().getRange();var h=e.getController("mobileClient.Challenges");for(var k=0;k<j.length;k++){if(j[k].get("type").value=="referral"){h.selectedItem=j[k];break}}h.fireEvent("doChallenge")})}}})},onFacebookShareCallback:function(e,g){var b=this,a=Genesis.fb;if((g&&g.wasSuccessful())||(e&&(e.type!="timeout"))){var d=b.getVenue();var c=d.getMerchant();var f=c.get("photo")["thumbnail_large_url"];console.debug("Posting to Facebook ...");Genesis.fb.share({name:d.get("name"),link:d.get("website")||site,caption:d.get("website")||site,description:d.get("description"),picture:f,message:"Check out this place!"},function(h){Ext.Viewport.setMasked(null);console.debug(b.fbShareSuccessMsg);Ext.device.Notification.show({title:"Facebook Connect",message:b.fbShareSuccessMsg,buttons:["OK"]});a.un("connected",b.onFacebookShareCallback);a.un("unauthorized",b.onFacebookShareCallback);a.un("exception",b.onFacebookShareCallback)},function(h){Ext.Viewport.setMasked(null);console.debug("Post was not published to Facebook.");a.un("connected",b.onFacebookShareCallback);a.un("unauthorized",b.onFacebookShareCallback);a.un("exception",b.onFacebookShareCallback)})}},onShareMerchantTap:function(a,i,d,h){var g=this,c=Genesis.constants.site,f=Genesis.fb;f.on("connected",g.onFacebookShareCallback,g);f.on("unauthorized",g.onFacebookShareCallback,g);f.on("exception",g.onFacebookShareCallback,g);Genesis.fb.facebook_onLogin(true,null,true)},onInfoTap:function(a,f,c,d){},onAccountsButtonTap:function(a,f,c,d){this.redirect("accounts");console.log("Going to Accounts Page ...")},onChallengesButtonTap:function(a,h,d,g,j){var f=this;var i=f.getVenue();var c=function(){if(j){j()}else{f.redirectTo("challenges");console.log("Going to Challenges Page ...")}};if(i.challenges().getData().length==0){Ext.Viewport.setMasked({xtype:"loadmask",message:f.retrieveChallengesMsg});Challenge.setGetChallengesURL();Challenge.load(i.getId(),{params:{merchant_id:i.getMerchant().getId(),venue_id:i.getId()},callback:function(b,e){Ext.Viewport.setMasked(null);if(e.wasSuccessful()){i.challenges().add(e.getRecords());c()}}})}else{c()}},onRewardsButtonTap:function(a,f,c,d){this.fireEvent("openpage","client.Rewards","rewards",null);console.log("Going to Client Rewards Page ...")},onRewardsSCButtonTap:function(a,f,c,d){this.fireEvent("openpage","client.Rewards","rewardsSC",null);console.log("Going to Client Rewards Shortcut Page ...")},onRedemptionsButtonTap:function(a,f,c,d){this.redirectTo("redemptions");console.log("Going to Client Redemptions Page ...")},onRedeemRewardsSCButtonTap:function(a,f,c,d){this.redirectTo("redeemRewardsChooseSC");console.log("Going to Client Redeem Rewards Choose Page ...")},onPrizesButtonTap:function(a,f,c,d){this.redirectTo("prizes");console.log("Going to Merchant Prizes Page ...")},onRedeemPrizesSCButtonTap:function(a,f,c,d){this.redirectTo("redeemPrizesChooseSC");console.log("Going to Client Redeem Prizes Choose Page ...")},onHomeButtonTap:function(a,f,c,d){this.resetView();this.redirectTo("main");console.log("Going back to HomePage ...")},onCheckedInAccountTap:function(a,f,c,d){this.goToMerchantMain(true)},onBrowseTap:function(a,f,c,d){this.redirectTo("exploreS")},onCheckinTap:function(a,f,c,d){this.redirectTo("checkin")},init:function(e){var d=this;__initFb__(Genesis,"Genesis");d.callParent(arguments);console.log("Client Viewport Init");Ext.defer(function(){this.sound_files={};var c=[["rouletteSpinSound","roulette_spin_sound","Media"],["winPrizeSound","win_prize_sound","Media"],["losePrizeSound","lose_prize_sound","Media"],["birthdaySound","birthday_surprise","Media"],["promoteSound","promote_sound","FX"],["clickSound","click_sound","FX"],["beepSound","beep.wav","FX"]];for(var g=0;g<c.length;g++){this.loadSoundFile.apply(this,c[g])}},1,d);var b,a,f=Genesis.constants;if(Ext.os.is("Android")||Ext.os.is("BlackBerry")){b=0.5;f.s_vol=50;a=0.5;f.conseqMissThreshold=1;f.magThreshold=20000;f.numSamples=4*1024;f.sigOverlapRatio=0.25}else{if(Ext.os.is("iOS")||Ext.os.is("Desktop")){b=0.5;f.s_vol=50;a=0.5;f.conseqMissThreshold=1;f.magThreshold=20000;f.numSamples=4*1024;f.sigOverlapRatio=0.25}}f.proximityTxTimeout=20*1000;f.proximityRxTimeout=40*1000;Genesis.fn.printProximityConfig();window.plugins.proximityID.init(b,a)},openMainPage:function(){var c=this;var b=Genesis.db.getLocalDB();var a=(b.auth_code)?true:false;c.resetView();if(a){c.setLoggedIn(a);console.debug("Going to SignIn Page ...");c.redirectTo("signIn")}else{console.debug("Going to Login Page ...");Genesis.db.resetStorage();c.redirectTo("login")}}});function _onGotoMain(){if(!offlineDialogShown){Ext.device.Notification.show({title:"Network Error",message:Genesis.controller.ControllerBase.prototype.lostNetworkConenction,callback:function(){Ext.Viewport.setMasked(null);var a=_application.getController("client.Viewport");if(a){a.resetView();if(a.getLoggedIn()){a.redirectTo("checkin")}else{a.redirectTo("login")}}offlineDialogShown=false}})}offlineDialogShown=true}Ext.define("Genesis.profile.MobileClient",{extend:Ext.app.Profile,config:{},isActive:function(){return true}});Ext.define("Genesis.view.Viewport",{extend:Ext.Container,xtype:"viewportview",config:{autoDestroy:false,cls:"viewport",layout:{type:"card",animation:{type:"cover",reverse:false,direction:"left"}},fullscreen:true},initialize:function(){this.callParent(arguments);if(Ext.os.is("Android")&&merchantMode){handleNfcFromIntentFilter();nfc.isEnabled(function(){Genesis.constants.isNfcEnabled=true;console.debug("NFC is enabled on this device")})}},animateActiveItem:function(c,b){var j=this.getActiveItem();var e=this.getLayout(),i=(e.getAnimation)?e.getAnimation():null;var h=(c.disableAnimation||((j)?j.disableAnimation:false));var g,f=_application.getController(((merchantMode)?"server":"client")+".Viewport");if(this.activeItemAnimation){this.activeItemAnimation.destroy()}this.activeItemAnimation=b=new Ext.fx.layout.Card(b);if(b&&e.isCard&&!h){b.setLayout(e);if(i){var d=f.getEventDispatcher().controller;i.disable();d.pause();c.createView();b.on("animationend",function(){console.debug("Animation Complete");i.enable();b.destroy();delete this.activeItemAnimation;if(j){if(j!=c){j.cleanView(c)}g=j.query("titlebar")[0];if(g){g.setMasked(Genesis.view.ViewBase.invisibleMask)}}c.showView();g=c.query("titlebar")[0];if(g){g.setMasked(null)}d.resume();f.popViewInProgress=false},this)}else{}}if(i&&h){i.disable()}var a=this.setActiveItem(c);if(!e.isCard||h){if(i){i.enable()}b.destroy();if(j){j.cleanView(c);var g=j.query("titlebar")[0];if(g){g.setMasked(Genesis.view.ViewBase.invisibleMask)}}c.createView();Ext.defer(function(){c.showView();g=c.query("titlebar")[0];if(g){g.setMasked(null)}f.popViewInProgress=false},0.1*1000,this)}return a}});Ext.define("Genesis.dom.Element",{override:"Ext.dom.Element",setMargin:function(b,a){if(b||b===0){b=this.self.unitizeBox((b===true)?5:b,a)}else{b=null}this.dom.style.margin=b},setPadding:function(b,a){if(b||b===0){b=this.self.unitizeBox((b===true)?5:b,a)}else{b=null}this.dom.style.padding=b},replaceCls:function(b,a,c,d){if(Ext.isArray(b)&&Ext.isArray(a)&&b.join()===a.join()){return}return this.removeCls(b,c,d).addCls(a,c,d)}});Ext.define("Genesis.Component",{override:"Ext.Component",updatePadding:function(a){this.innerElement.setPadding(a,this.getInitialConfig().defaultUnit)},updateMargin:function(a){this.element.setMargin(a,this.getInitialConfig().defaultUnit)}});Ext.define("Genesis.util.Collection",{override:"Ext.util.Collection",clear:function(){this.callParent(arguments);this.indices={}}});Ext.define("Genesis.Mask",{override:"Ext.Mask",onEvent:function(b){var a=arguments[arguments.length-1];if(a.info.eventName==="tap"){this.fireEvent("tap",this,b);return false}return false}});Ext.define("Genesis.data.reader.Json",{override:"Ext.data.reader.Json",getResponseData:function(a){var b;if(a&&a.responseText){}b=this.callParent(arguments);if(!b.metaData){delete this.metaData}return b}});Ext.define("Genesis.data.writer.Writer",{override:"Ext.data.writer.Writer",writeDate:function(b,a){if(a){return this.callParent(arguments)}return null}});Ext.define("Genesis.data.proxy.Server",{override:"Ext.data.proxy.Server",errorResponseHandlerFn:function(a,f,k,d,g,e,j,l){var i=this,c=d.getAction(),b=_application;var h=b.getController(((!merchantMode)?"client":"server")+".Viewport");switch(a.rescode){case"unregistered_account":break;case"server_error":Ext.device.Notification.show({title:"Server Error(s)",message:f,buttons:["Dismiss"],callback:function(m){if(a.session_timeout){h.resetView();h.redirectTo("login");return}else{}}});break;case"login_invalid_facebook_info":Ext.device.Notification.show({title:"Create Account",message:Genesis.constants.createAccountMsg,buttons:["OK"],callback:function(m){h.setLoggedIn(false);h.redirectTo("createAccount")}});return;case"update_account_invalid_info":case"signup_invalid_info":case"update_account_invalid_facebook_info":case"login_invalid_info":Ext.device.Notification.show({title:"Login Error",message:f,buttons:["Dismiss"],callback:function(m){h.resetView();h.redirectTo("login")}});return;default:if(f&&(f!="Error Connecting to Server")){Ext.device.Notification.show({title:"Error",message:f,buttons:["Dismiss"],callback:function(){if(i._errorCallback){i._errorCallback();delete i._errorCallback}}})}else{if(d.initialConfig.doNotRetryAttempt){Ext.device.Notification.show({title:"Network Error",message:"Error Contacting Server",buttons:["Dismiss"],callback:function(){if(i._errorCallback){i._errorCallback();delete i._errorCallback}}})}}break}console.debug("Ajax ErrorHandler called. Operation("+d.wasSuccessful()+")"+((f)?"\n"+f:""));i.fireEvent("exception",i,e,d)},processResponse:function(n,c,g,d,m,o){var k=this,b=c.getAction(),i=k.getReader(),l,f,a;if(d.timedout||((d.status==0)&&(!g.aborted)&&(!c.initialConfig.doNotRetryAttempt))){if(!k.quiet){Ext.device.Notification.show({title:"Server Timeout",message:"Error Contacting Server",buttons:["Try Again","Cancel"],callback:function(e){if(e.toLowerCase()=="try again"){k.afterRequest(g,n);Ext.Ajax.request(d.request.options)}else{d.timedout=false;g.aborted=true;n=false;c.success=false;k.processResponse(n,c,g,d,m,o)}}})}else{k.quiet=false;d.timedout=false;g.aborted=true;n=false;c.success=false;k.processResponse(n,c,g,d,m,o)}return}var h=function(){f=((l&&Ext.isDefined(l.getMessage))?(Ext.isArray(l.getMessage())?l.getMessage().join(Genesis.constants.addCRLF()):l.getMessage()):"Error Connecting to Server");a=i.metaData||{};if(!k.quiet){Ext.Viewport.setMasked(null)}if(typeof m=="function"){m.call(o||k,c)}if(k.supressErrorsPopup){if(!k.quiet){k.supressErrorsCallbackFn=function(){k.supressErrorsPopup=false;k.errorResponseHandlerFn(a,f,n,c,g,d,m,o);delete k.supressErrorsCallbackFn}}else{k.supressErrorsPopup=false}}else{k.errorResponseHandlerFn(a,f,n,c,g,d,m,o)}k.quiet=false};if(!d.aborted){try{l=i.process(d)}catch(j){console.debug("Ajax call failed with message=["+j.message+"] url=["+g.getUrl()+"]");c.setException(c,{status:null,statusText:j.message});h();return}if(n===true){if(c.process(b,l,g,d)===false){h()}else{if(typeof m=="function"){m.call(o||k,c)}}k.afterRequest(g,n);return}}console.debug("Ajax call failed with status=["+d.status+"] url=["+g.getUrl()+"]");if(f){c.setException(c,{status:null,statusText:f})}else{k.setException(c,d)}if(!d.aborted){h()}k.afterRequest(g,n)},buildRequest:function(b){var a=Genesis.db.getLocalDB();if(a.auth_code){this.setExtraParam("auth_token",a.auth_code)}else{delete this.getExtraParams()["auth_token"]}var c=this.callParent(arguments);if(b.initialConfig.jsonData){c.setJsonData(b.initialConfig.jsonData)}return c}});Ext.define("Genesis.data.Connection",{override:"Ext.data.Connection",setupHeaders:function(g,b,d,f){var c=this;b=b||{};var a=Genesis.db.getLocalDB();var h=(b.method||c.getMethod()||((f||d)?"POST":"GET")).toUpperCase();b.headers=Ext.apply(b.headers,{Accept:"*/*"});if(a.csrf_code&&(h=="POST")){b.headers=Ext.apply(b.headers,{"X-CSRF-Token":a.csrf_code})}var e=c.callParent(arguments);return e},parseStatus:function(a,d){a=a==1223?204:a;var c=(a>=200&&a<300)||a==304,b=false;if(!d.onreadystatechange){c=false}if(!c){switch(a){case 12002:case 12029:case 12030:case 12031:case 12152:case 13030:b=true;break}}return({success:c,isException:b})}});Ext.define("Genesis.field.Text",{override:"Ext.field.Text",updateReadOnly:function(a){this[(a)?"addCls":"removeCls"]("readOnly");this.callParent(arguments)}});Ext.define("Genesis.field.Select",{override:"Ext.field.Select",getListPanel:function(){if(!this.listPanel){this.listPanel=Ext.create("Ext.Panel",{top:0,left:0,height:"9em",modal:true,cls:Ext.baseCSSPrefix+"select-overlay",layout:"fit",hideOnMaskTap:true,items:{xtype:"list",store:this.getStore(),itemTpl:'<span class="x-list-label">{'+this.getDisplayField()+"}</span>",listeners:{select:this.onListSelect,itemtap:this.onListTap,scope:this}}})}return this.listPanel}});Ext.define("Genesis.dataview.element.List",{override:"Ext.dataview.element.List",updateListItem:function(d,k){var h=this,e=h.dataview,j=Ext.fly(k),g=j.down(h.labelClsCache,true),c=e.prepareData(d.getData(true),e.getStore().indexOf(d),d),b=e.getDisclosureProperty(),a,l=c&&c.hasOwnProperty("iconSrc"),f,i;g.innerHTML=e.getItemTpl().apply(c);a=c&&c.hasOwnProperty(b);if(a){f=j.down(h.disclosureClsCache);f[c[b]===false?"addCls":"removeCls"](h.hiddenDisplayCache)}if(e.getIcon()){i=j.down(h.iconClsCache,true);i.style.backgroundImage=l?'url("'+l+'")':""}}});Ext.define("Genesis.tab.Bar",{override:"Ext.tab.Bar",doSetActiveTab:function(b,a){this.callParent(arguments);this.fireAction("tabchange",[this,b,a])}});Ext.define("Genesis.MessageBox",{override:"Ext.MessageBox",updateButtons:function(a){var b=this;if(a){if(b.buttonsToolbar){b.buttonsToolbar.removeAll();b.buttonsToolbar.setItems(a)}else{b.buttonsToolbar=Ext.create("Ext.Toolbar",{docked:"bottom",height:"2.6em",defaultType:"button",layout:{type:"hbox",pack:"center"},ui:b.getUi(),cls:b.getBaseCls()+"-buttons",items:a});b.add(b.buttonsToolbar)}}},onClick:function(a){if(a&&this._hideCallbackFn){this.getModal().un("hide",this._hideCallbackFn,Ext.device.Notification);delete this._hideCallbackFn}this.callParent(arguments)}});Ext.define("Genesis.device.connection.PhoneGap",{override:"Ext.device.connection.PhoneGap",syncOnline:function(){var a=navigator.connection.type;this._type=a;this._online=a!=Connection.NONE}});Ext.define("Ext.device.notification.Abstract",{show:function(a){if(!a.message){throw ("[Ext.device.Notification#show] You passed no message")}if(a.buttons){if(!Ext.isArray(a.buttons)){a.buttons=[a.buttons]}}else{a.buttons=null}if(!a.scope){a.scope=this}return a},vibrate:Ext.emptyFn});Ext.define("Ext.device.notification.Simulator",{extend:"Ext.device.notification.Abstract",requires:["Ext.MessageBox"],msg:null,show:function(){var a=this.callSuper(arguments),e=[],d=a.buttons.length,c,b,g,f;for(b=0;b<d;b++){c=a.buttons[b];if(Ext.isString(c)){c={text:a.buttons[b],itemId:a.buttons[b].toLowerCase()}}e.push(c)}if(this.msg){this.msg.destroy()}if(a.disableAnimations){this.msg=Ext.create("Ext.MessageBox",{showAnimation:null,hideAnimation:null});this.msg.defaultAllowedConfig.showAnimation=false;this.msg.defaultAllowedConfig.hideAnimation=false}else{this.msg=Ext.create("Ext.MessageBox")}f=this.msg;f.setHideOnMaskTap((!a.ignoreOnHide)?true:false);g=function(h){if(a.callback){a.callback.apply(a.scope,[h])}};f._hideCallbackFn=Ext.bind(g,this,[e[e.length-1].itemId]);f.getModal().on("hide",f._hideCallbackFn,this);f.show({title:a.title,message:a.message,scope:f,buttons:e,fn:g})},beep:Ext.emptyFn,vibrate:Ext.emptyFn,dismiss:function(){var a=this.msg;if(a){if(a._hideCallbackFn){a._hideCallbackFn()}a.hide()}}});Ext.define("Ext.device.notification.PhoneGap",{extend:"Ext.device.notification.Simulator"});Ext.define("Ext.device.notification.Sencha",{extend:"Ext.device.notification.Simulator"});Ext.define("Ext.device.Notification",{singleton:true,requires:["Ext.device.notification.Sencha","Ext.device.notification.Simulator"],constructor:function(){var a=Ext.browser.is;if(a.WebView){if(a.PhoneGap){return Ext.create("Ext.device.notification.PhoneGap")}else{return Ext.create("Ext.device.notification.Sencha")}}else{return Ext.create("Ext.device.notification.Simulator")}}});Ext.define("Genesis.util.Geolocation",{override:"Ext.util.Geolocation",parseOptions:function(){var b=this.getTimeout(),a={maximumAge:this.getMaximumAge(),allowHighAccuracy:this.getAllowHighAccuracy(),enableHighAccuracy:this.getAllowHighAccuracy()};if(b!==Infinity){a.timeout=b}console.debug("Geolocation - "+Ext.encode(a));return a}});Ext.define("Genesis.data.proxy.PagingMemory",{extend:"Ext.data.proxy.Memory",alias:"proxy.pagingmemory",alternateClassName:"Genesis.data.PagingMemoryProxy",read:function(b,f,c){var d=this,a=d.getReader();var e={data:a.getRoot(d.getData()).slice(b.getStart(),b.getStart()+b.getLimit()),total:a.getTotal(d.getData())};if(b.process("read",a.process(e))===false){this.fireEvent("exception",this,null,b)}Ext.callback(f,c||d,[b])},});Ext.define("Genesis.plugin.ListPaging",{extend:"Ext.plugin.ListPaging",loadNextPage:function(){var a=this;if(!a.storeFullyLoaded()){a.callParent(arguments)}}});Ext.define("Genesis.plugin.PullRefresh",{override:"Ext.plugin.PullRefresh",resetRefreshState:function(){Ext.device.Notification.beep(1);this.callParent(arguments)}});var launched=0,pausedDisabled=true,backBtnCallbackListFn=[],offlineDialogShown=false;window.merchantMode=false;window.debugMode=true;window.serverHost;window._application=null;window._codec=null;window.appName="GetKickBak";window._hostPathPrefix="/javascripts/build/MobileClient/";window._hostPath=_hostPathPrefix+((debugMode)?"testing":"production")+"/";window.phoneGapAvailable=false;_totalAssetCount++;if(debugMode){serverHost="http://www.dev1getkickbak.com"}else{serverHost="http://www.getkickbak.com"}(function(){Genesis.db.getLocalDB();Genesis.db.getReferralDB();Genesis.db.getRedeemIndexDB();Genesis.db.getRedeemSortedDB();var a=17,d=false;var b=function(){if(launched==273){var e=_application.getController("client.Viewport");e.appName=appName;if(d){console.log("Error Loading system File.");Ext.device.Notification.show({title:"KickBak",message:"Error Connecting to Server.",buttons:["Retry"],disableAnimations:true,callback:function(f){window.location.reload()}})}else{Ext.create("Genesis.view.Viewport");console.debug("Launched App")}Ext.fly("appLoadingIndicator").destroy();_loadingPct=null;Ext.fly("loadingPct").destroy()}};var c=function(f,e){if(!f){d=f}_filesAssetCount++;if((a|=e)==273){Ext.application({viewport:{autoMaximize:true},name:"Genesis",profiles:["MobileClient"],views:["ViewBase","Document","client.UploadPhotosPage","client.ChallengePage","client.Rewards","client.Redemptions","client.AccountsTransfer","client.SettingsPage","client.CheckinExplore","LoginPage","SignInPage","client.MainPage","widgets.client.RedeemItemDetail","client.Badges","client.JackpotWinners","client.MerchantAccount","client.MerchantDetails","client.Accounts","client.Prizes","Viewport"],controllers:["mobileClient.Challenges","client.Rewards","client.Redemptions","client.Viewport","client.MainPage","client.Badges","client.Merchants","client.Accounts","client.Settings","client.Checkins","client.JackpotWinners","client.Prizes"],launch:function(){_application=this;if(launched>0){launched|=1}else{launched=1}console.debug("Ext App Launch");b()},isIconPrecomposed:true,icon:{36:"resources/icons/icon36.png",48:"resources/icons/icon48.png",57:"resources/icons/icon.png",72:"resources/icons/icon@72.png",114:"resources/icons/icon@2x.png",144:"resources/icons/icon@144.png"},onUpdated:function(){Ext.device.Notification.show({title:"Application Update",message:"This application has just successfully been updated to the latest version. Reload now?",buttons:["Yes","No"],disableAnimations:true,callback:function(g){if(g==="yes"){window.location.reload()}}})}})}};Ext.onReady(function(){console.debug=(!debugMode)?Ext.emptyFn:console.debug||console.log;console.warn=console.warn||console.debug;launched|=272;b()});_filesAssetCount++;Ext.defer(function(){var i="script",h="src";var k=document.getElementsByTagName(i);var f=_hostPath+"resources/themes/images/v1/",e=[new Image(400,400)],j;if(Ext.os.is("iOS")||Ext.os.is("Desktop")){j=f+"ios";if(Ext.os.is("iPhone5")){_totalAssetCount++;Genesis.fn.checkloadjscssfile(_hostPath+"resources/css/iphone5.css?v="+Genesis.constants.clientVersion,"css",Ext.bind(c,null,[16],true))}}else{j=f+"android/"+resolution}var g=(new Audio()).canPlayType("audio/wav; codecs=1");if(!g){if(typeof(Worker)=="undefined"){Genesis.fn.checkloadjscssfile(_hostPathPrefix+"lib/libmp3lame.min.js","js",function(l){console.log("Error Loading Application Resource File.");Ext.device.Notification.show({title:"KickBak",message:"Error Loading Application Resource File.",buttons:["Reload"],disableAnimations:true,callback:function(m){window.location.reload()}})});Genesis.fn.checkloadjscssfile(_hostPath+"worker/encoder.js","js",function(){_codec=new Worker("worker/encoder.js");c(true,256);console.debug("Enable MP3 Encoder")})}else{_codec=new Worker("worker/encoder.js");c(true,256);console.debug("Enable MP3 Encoder")}}else{c(true,256);console.debug("Enable WAV/WebAudio Encoder")}e[0].src=j+"/prizewon/transmit.png"},0.1*1000)})();