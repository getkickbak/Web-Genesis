var DSP={LEFT:0,RIGHT:1,MIX:2,SINE:1,TRIANGLE:2,SAW:3,SQUARE:4,LOWPASS:0,HIGHPASS:1,BANDPASS:2,NOTCH:3,BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10,OFF:0,FW:1,BW:2,FWBW:3,TWO_PI:2*Math.PI};function setupTypedArray(a,b){if(typeof this[a]!=="function"&&typeof this[a]!=="object"){if(typeof this[b]==="function"&&typeof this[b]!=="object"){this[a]=this[b];}else{this[a]=function(c){if(c instanceof Array){return c;}else{if(typeof c==="number"){return new Array(c);}}};}}}setupTypedArray("Float32Array","WebGLFloatArray");setupTypedArray("Int32Array","WebGLIntArray");setupTypedArray("Uint16Array","WebGLUnsignedShortArray");setupTypedArray("Uint8Array","WebGLUnsignedByteArray");DSP.invert=function(b){for(var c=0,a=b.length;c<a;c++){b[c]*=-1;}return b;};DSP.interleave=function(d,c){if(d.length!==c.length){throw"Can not interleave. Channel lengths differ.";}var e=new Float32Array(d.length*2);for(var b=0,a=d.length;b<a;b++){e[2*b]=d[b];e[2*b+1]=c[b];}return e;};DSP.deinterleave=(function(){var d,a,b,c=[];c[DSP.MIX]=function(f){for(var g=0,e=f.length/2;g<e;g++){b[g]=(f[2*g]+f[2*g+1])/2;}return b;};c[DSP.LEFT]=function(f){for(var g=0,e=f.length/2;g<e;g++){d[g]=f[2*g];}return d;};c[DSP.RIGHT]=function(f){for(var g=0,e=f.length/2;g<e;g++){a[g]=f[2*g+1];}return a;};return function(f,e){d=d||new Float32Array(e.length/2);a=a||new Float32Array(e.length/2);b=b||new Float32Array(e.length/2);if(e.length/2!==d.length){d=new Float32Array(e.length/2);a=new Float32Array(e.length/2);b=new Float32Array(e.length/2);}return c[f](e);};}());DSP.getChannel=DSP.deinterleave;DSP.mixSampleBuffers=function(c,b,d,e){var f=new Float32Array(c);for(var a=0;a<c.length;a++){f[a]+=(d?-b[a]:b[a])/e;}return f;};DSP.LPF=0;DSP.HPF=1;DSP.BPF_CONSTANT_SKIRT=2;DSP.BPF_CONSTANT_PEAK=3;DSP.NOTCH=4;DSP.APF=5;DSP.PEAKING_EQ=6;DSP.LOW_SHELF=7;DSP.HIGH_SHELF=8;DSP.Q=1;DSP.BW=2;DSP.S=3;DSP.RMS=function(a){var c=0;for(var b=0,d=a.length;b<d;b++){c+=a[b]*a[b];}return Math.sqrt(c/d);};DSP.Peak=function(a){var c=0;for(var b=0,d=a.length;b<d;b++){c=(Math.abs(a[b])>c)?Math.abs(a[b]):c;}return c;};function FourierTransform(b,a){this.bufferSize=b;this.sampleRate=a;this.bandwidth=2/b*a/2;this.spectrum=new Float32Array(b/2);this.real=new Float32Array(b);this.imag=new Float32Array(b);this.peakBand=0;this.peak=0;this.getBandFrequency=function(c){return this.bandwidth*c+this.bandwidth/2;};this.calculateSpectrum=function(){var h=this.spectrum,j=this.real,c=this.imag,l=2/this.bufferSize,m=Math.sqrt,e,k,f;for(var d=0,g=b/2;d<g;d++){e=j[d];k=c[d];f=l*m(e*e+k*k);if(f>this.peak){this.peakBand=d;this.peak=f;}h[d]=f;}};}function DFT(e,a){FourierTransform.call(this,e,a);var d=e/2*e;var c=2*Math.PI;this.sinTable=new Float32Array(d);this.cosTable=new Float32Array(d);for(var b=0;b<d;b++){this.sinTable[b]=Math.sin(b*c/e);this.cosTable[b]=Math.cos(b*c/e);}}DFT.prototype.forward=function(a){var g=this.real,f=this.imag,d,c;for(var b=0;b<this.bufferSize/2;b++){d=0;c=0;for(var e=0;e<a.length;e++){d+=this.cosTable[b*e]*a[e];c+=this.sinTable[b*e]*a[e];}g[b]=d;f[b]=c;}return this.calculateSpectrum();};function FFT(e,b){FourierTransform.call(this,e,b);this.reverseTable=new Uint32Array(e);var a=1;var d=e>>1;var c;while(a<e){for(c=0;c<a;c++){this.reverseTable[c+a]=this.reverseTable[c]+d;}a=a<<1;d=d>>1;}this.sinTable=new Float32Array(e);this.cosTable=new Float32Array(e);for(c=0;c<e;c++){this.sinTable[c]=Math.sin(-Math.PI/c);this.cosTable[c]=Math.cos(-Math.PI/c);}}FFT.prototype.forward=function(o){var f=this.bufferSize,a=this.cosTable,d=this.sinTable,j=this.reverseTable,m=this.real,r=this.imag,t=this.spectrum;var p=Math.floor(Math.log(f)/Math.LN2);if(Math.pow(2,p)!==f){throw"Invalid buffer size, must be a power of 2.";}if(f!==o.length){throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+f+" Buffer Size: "+o.length;}var n=1,h,l,b,e,u,c,g,s,q;for(q=0;q<f;q++){m[q]=o[j[q]];r[q]=0;}while(n<f){h=a[n];l=d[n];b=1;e=0;for(var v=0;v<n;v++){q=v;while(q<f){u=q+n;c=(b*m[u])-(e*r[u]);g=(b*r[u])+(e*m[u]);m[u]=m[q]-c;r[u]=r[q]-g;m[q]+=c;r[q]+=g;q+=n<<1;}s=b;b=(s*h)-(e*l);e=(s*l)+(e*h);}n=n<<1;}return this.calculateSpectrum();};FFT.prototype.inverse=function(n,r){var g=this.bufferSize,a=this.cosTable,e=this.sinTable,l=this.reverseTable,t=this.spectrum;n=n||this.real;r=r||this.imag;var o=1,k,m,b,f,u,c,h,s,q;for(q=0;q<g;q++){r[q]*=-1;}var d=new Float32Array(g);var j=new Float32Array(g);for(q=0;q<n.length;q++){d[q]=n[l[q]];j[q]=r[l[q]];}n=d;r=j;while(o<g){k=a[o];m=e[o];b=1;f=0;for(var v=0;v<o;v++){q=v;while(q<g){u=q+o;c=(b*n[u])-(f*r[u]);h=(b*r[u])+(f*n[u]);n[u]=n[q]-c;r[u]=r[q]-h;n[q]+=c;r[q]+=h;q+=o<<1;}s=b;b=(s*k)-(f*m);f=(s*m)+(f*k);}o=o<<1;}var p=new Float32Array(g);for(q=0;q<g;q++){p[q]=n[q]/g;}return p;};function RFFT(b,a){FourierTransform.call(this,b,a);this.trans=new Float32Array(b);this.reverseTable=new Uint32Array(b);this.reverseBinPermute=function(d,k){var l=this.bufferSize,f=l>>>1,c=l-1,e=1,j=0,g;d[0]=k[0];do{j+=f;d[e]=k[j];d[j]=k[e];e++;g=f<<1;while(g=g>>1,!((j^=g)&g)){}if(j>=e){d[e]=k[j];d[j]=k[e];d[c-e]=k[c-j];d[c-j]=k[c-e];}e++;}while(e<f);d[c]=k[c];};this.generateReverseTable=function(){var j=this.bufferSize,e=j>>>1,c=j-1,d=1,g=0,f;this.reverseTable[0]=0;do{g+=e;this.reverseTable[d]=g;this.reverseTable[g]=d;d++;f=e<<1;while(f=f>>1,!((g^=f)&f)){}if(g>=d){this.reverseTable[d]=g;this.reverseTable[g]=d;this.reverseTable[c-d]=c-g;this.reverseTable[c-g]=c-d;}d++;}while(d<e);this.reverseTable[c]=c;};this.generateReverseTable();}RFFT.prototype.forward=function(s){var M=this.bufferSize,r=this.spectrum,L=this.trans,b=2*Math.PI,J=Math.sqrt,O=M>>>1,t=2/M,y,w,v,Q,D,C,A,z,m,l,k,h,g,f,d,c,p,K,E,I,B,P,R,q,G,F;this.reverseBinPermute(L,s);for(var u=0,H=4;u<M;H*=4){for(var o=u;o<M;o+=H){p=L[o]-L[o+1];L[o]+=L[o+1];L[o+1]=p;}u=2*(H-1);}y=2;Q=M>>>1;while((Q=Q>>>1)){u=0;y=y<<1;H=y<<1;w=y>>>2;v=y>>>3;do{if(w!==1){for(o=u;o<M;o+=H){m=o;l=m+w;k=l+w;h=k+w;D=L[k]+L[h];L[h]-=L[k];L[k]=L[m]-D;L[m]+=D;m+=v;l+=v;k+=v;h+=v;D=L[k]+L[h];C=L[k]-L[h];D=-D*Math.SQRT1_2;C*=Math.SQRT1_2;p=L[l];L[h]=D+p;L[k]=D-p;L[l]=L[m]-C;L[m]+=C;}}else{for(o=u;o<M;o+=H){m=o;l=m+w;k=l+w;h=k+w;D=L[k]+L[h];L[h]-=L[k];L[k]=L[m]-D;L[m]+=D;}}u=(H<<1)-y;H=H<<2;}while(u<M);P=b/y;for(var N=1;N<v;N++){R=N*P;E=Math.sin(R);K=Math.cos(R);I=4*K*(K*K-0.75);B=4*E*(0.75-E*E);u=0;H=y<<1;do{for(o=u;o<M;o+=H){m=o+N;l=m+w;k=l+w;h=k+w;g=o+w-N;f=g+w;d=f+w;c=d+w;C=L[d]*K-L[k]*E;D=L[d]*E+L[k]*K;z=L[c]*I-L[h]*B;A=L[c]*B+L[h]*I;p=C-z;C+=z;z=p;L[c]=C+L[f];L[k]=C-L[f];p=A-D;D+=A;A=p;L[h]=A+L[l];L[d]=A-L[l];L[f]=L[m]-D;L[m]+=D;L[l]=z+L[g];L[g]-=z;}u=(H<<1)-y;H=H<<2;}while(u<M);}}while(--O){q=L[O];G=L[M-O-1];F=t*J(q*q+G*G);if(F>this.peak){this.peakBand=O;this.peak=F;}r[O]=F;}r[0]=t*L[0];return r;};function Sampler(f,b,h,i,c,e,d,a){this.file=f;this.bufferSize=b;this.sampleRate=h;this.playStart=i||0;this.playEnd=c||1;this.loopStart=e||0;this.loopEnd=d||1;this.loopMode=a||DSP.OFF;this.loaded=false;this.samples=[];this.signal=new Float32Array(b);this.frameCount=0;this.envelope=null;this.amplitude=1;this.rootFrequency=110;this.frequency=550;this.step=this.frequency/this.rootFrequency;this.duration=0;this.samplesProcessed=0;this.playhead=0;var g=document.createElement("AUDIO");var j=this;this.loadSamples=function(m){var k=DSP.getChannel(DSP.MIX,m.frameBuffer);for(var l=0;l<k.length;l++){j.samples.push(k[l]);}};this.loadComplete=function(){j.samples=new Float32Array(j.samples);j.loaded=true;};this.loadMetaData=function(){j.duration=g.duration;};g.addEventListener("MozAudioAvailable",this.loadSamples,false);g.addEventListener("loadedmetadata",this.loadMetaData,false);g.addEventListener("ended",this.loadComplete,false);g.muted=true;g.src=f;g.play();}Sampler.prototype.applyEnvelope=function(){this.envelope.process(this.signal);return this.signal;};Sampler.prototype.generate=function(){var b=this.frameCount*this.bufferSize;var a=this.playEnd*this.samples.length-this.playStart*this.samples.length;var f=this.playStart*this.samples.length;var c=this.playEnd*this.samples.length;var e;for(var d=0;d<this.bufferSize;d++){switch(this.loopMode){case DSP.OFF:this.playhead=Math.round(this.samplesProcessed*this.step+f);if(this.playhead<(this.playEnd*this.samples.length)){this.signal[d]=this.samples[this.playhead]*this.amplitude;}else{this.signal[d]=0;}break;case DSP.FW:this.playhead=Math.round((this.samplesProcessed*this.step)%a+f);if(this.playhead<(this.playEnd*this.samples.length)){this.signal[d]=this.samples[this.playhead]*this.amplitude;}break;case DSP.BW:this.playhead=c-Math.round((this.samplesProcessed*this.step)%a);if(this.playhead<(this.playEnd*this.samples.length)){this.signal[d]=this.samples[this.playhead]*this.amplitude;}break;case DSP.FWBW:if(Math.floor(this.samplesProcessed*this.step/a)%2===0){this.playhead=Math.round((this.samplesProcessed*this.step)%a+f);}else{this.playhead=c-Math.round((this.samplesProcessed*this.step)%a);}if(this.playhead<(this.playEnd*this.samples.length)){this.signal[d]=this.samples[this.playhead]*this.amplitude;}break;}this.samplesProcessed++;}this.frameCount++;return this.signal;};Sampler.prototype.setFreq=function(b){var a=this.samplesProcessed*this.step;this.frequency=b;this.step=this.frequency/this.rootFrequency;this.samplesProcessed=Math.round(a/this.step);};Sampler.prototype.reset=function(){this.samplesProcessed=0;this.playhead=0;};function Oscillator(c,d,b,e,a){this.frequency=d;this.amplitude=b;this.bufferSize=e;this.sampleRate=a;this.frameCount=0;this.waveTableLength=2048;this.cyclesPerSample=d/a;this.signal=new Float32Array(e);this.envelope=null;switch(parseInt(c,10)){case DSP.TRIANGLE:this.func=Oscillator.Triangle;break;case DSP.SAW:this.func=Oscillator.Saw;break;case DSP.SQUARE:this.func=Oscillator.Square;break;default:case DSP.SINE:this.func=Oscillator.Sine;break;}this.generateWaveTable=function(){Oscillator.waveTable[this.func]=new Float32Array(2048);var h=this.waveTableLength/this.sampleRate;var g=1/h;for(var f=0;f<this.waveTableLength;f++){Oscillator.waveTable[this.func][f]=this.func(f*g/this.sampleRate);}};if(typeof Oscillator.waveTable==="undefined"){Oscillator.waveTable={};}if(typeof Oscillator.waveTable[this.func]==="undefined"){this.generateWaveTable();}this.waveTable=Oscillator.waveTable[this.func];}Oscillator.prototype.setAmp=function(a){if(a>=0&&a<=1){this.amplitude=a;}else{throw"Amplitude out of range (0..1).";}};Oscillator.prototype.setFreq=function(a){this.frequency=a;this.cyclesPerSample=a/this.sampleRate;};Oscillator.prototype.add=function(a){for(var b=0;b<this.bufferSize;b++){this.signal[b]+=a.signal[b];}return this.signal;};Oscillator.prototype.addSignal=function(b){for(var a=0;a<b.length;a++){if(a>=this.bufferSize){break;}this.signal[a]+=b[a];}return this.signal;};Oscillator.prototype.addEnvelope=function(a){this.envelope=a;};Oscillator.prototype.applyEnvelope=function(){this.envelope.process(this.signal);};Oscillator.prototype.valueAt=function(a){return this.waveTable[a%this.waveTableLength];};Oscillator.prototype.generate=function(){var a=this.frameCount*this.bufferSize;var c=this.waveTableLength*this.frequency/this.sampleRate;var d;for(var b=0;b<this.bufferSize;b++){d=Math.round((a+b)*c);this.signal[b]=this.waveTable[d%this.waveTableLength]*this.amplitude;}this.frameCount++;return this.signal;};Oscillator.Sine=function(a){return Math.sin(DSP.TWO_PI*a);};Oscillator.Square=function(a){return a<0.5?1:-1;};Oscillator.Saw=function(a){return 2*(a-Math.round(a));};Oscillator.Triangle=function(a){return 1-4*Math.abs(Math.round(a)-a);};Oscillator.Pulse=function(a){};function ADSR(e,f,b,d,a,c){this.sampleRate=c;this.attackLength=e;this.decayLength=f;this.sustainLevel=b;this.sustainLength=d;this.releaseLength=a;this.sampleRate=c;this.attackSamples=e*c;this.decaySamples=f*c;this.sustainSamples=d*c;this.releaseSamples=a*c;this.update=function(){this.attack=this.attackSamples;this.decay=this.attack+this.decaySamples;this.sustain=this.decay+this.sustainSamples;this.release=this.sustain+this.releaseSamples;};this.update();this.samplesProcessed=0;}ADSR.prototype.noteOn=function(){this.samplesProcessed=0;this.sustainSamples=this.sustainLength*this.sampleRate;this.update();};ADSR.prototype.noteOff=function(){this.sustainSamples=this.samplesProcessed-this.decaySamples;this.update();};ADSR.prototype.processSample=function(b){var a=0;if(this.samplesProcessed<=this.attack){a=0+(1-0)*((this.samplesProcessed-0)/(this.attack-0));}else{if(this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay){a=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack));}else{if(this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain){a=this.sustainLevel;}else{if(this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release){a=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-this.sustain)/(this.release-this.sustain));}}}}return b*a;};ADSR.prototype.value=function(){var a=0;if(this.samplesProcessed<=this.attack){a=0+(1-0)*((this.samplesProcessed-0)/(this.attack-0));}else{if(this.samplesProcessed>this.attack&&this.samplesProcessed<=this.decay){a=1+(this.sustainLevel-1)*((this.samplesProcessed-this.attack)/(this.decay-this.attack));}else{if(this.samplesProcessed>this.decay&&this.samplesProcessed<=this.sustain){a=this.sustainLevel;}else{if(this.samplesProcessed>this.sustain&&this.samplesProcessed<=this.release){a=this.sustainLevel+(0-this.sustainLevel)*((this.samplesProcessed-this.sustain)/(this.release-this.sustain));}}}}return a;};ADSR.prototype.process=function(a){for(var b=0;b<a.length;b++){a[b]*=this.value();this.samplesProcessed++;}return a;};ADSR.prototype.isActive=function(){if(this.samplesProcessed>this.release||this.samplesProcessed===-1){return false;}else{return true;}};ADSR.prototype.disable=function(){this.samplesProcessed=-1;};function IIRFilter(d,a,c,b){this.sampleRate=b;switch(d){case DSP.LOWPASS:case DSP.LP12:this.func=new IIRFilter.LP12(a,c,b);break;}}IIRFilter.prototype.__defineGetter__("cutoff",function(){return this.func.cutoff;});IIRFilter.prototype.__defineGetter__("resonance",function(){return this.func.resonance;});IIRFilter.prototype.set=function(a,b){this.func.calcCoeff(a,b);};IIRFilter.prototype.process=function(a){this.func.process(a);};IIRFilter.prototype.addEnvelope=function(a){if(a instanceof ADSR){this.func.addEnvelope(a);}else{throw"Not an envelope.";}};IIRFilter.LP12=function(a,c,b){this.sampleRate=b;this.vibraPos=0;this.vibraSpeed=0;this.envelope=false;this.calcCoeff=function(d,e){this.w=2*Math.PI*d/this.sampleRate;this.q=1-this.w/(2*(e+0.5/(1+this.w))+this.w-2);this.r=this.q*this.q;this.c=this.r+1-2*Math.cos(this.w)*this.q;this.cutoff=d;this.resonance=e;};this.calcCoeff(a,c);this.process=function(d){for(var e=0;e<d.length;e++){this.vibraSpeed+=(d[e]-this.vibraPos)*this.c;this.vibraPos+=this.vibraSpeed;this.vibraSpeed*=this.r;if(this.envelope){d[e]=(d[e]*(1-this.envelope.value()))+(this.vibraPos*this.envelope.value());this.envelope.samplesProcessed++;}else{d[e]=this.vibraPos;}}};};IIRFilter.LP12.prototype.addEnvelope=function(a){this.envelope=a;};function IIRFilter2(d,a,c,b){this.type=d;this.cutoff=a;this.resonance=c;this.sampleRate=b;this.f=Float32Array(4);this.f[0]=0;this.f[1]=0;this.f[2]=0;this.f[3]=0;this.calcCoeff=function(e,f){this.freq=2*Math.sin(Math.PI*Math.min(0.25,e/(this.sampleRate*2)));this.damp=Math.min(2*(1-Math.pow(f,0.25)),Math.min(2,2/this.freq-this.freq*0.5));};this.calcCoeff(a,c);}IIRFilter2.prototype.process=function(a){var c,b;var e=this.f;for(var d=0;d<a.length;d++){c=a[d];e[3]=c-this.damp*e[2];e[0]=e[0]+this.freq*e[2];e[1]=e[3]-e[0];e[2]=this.freq*e[1]+e[2];b=0.5*e[this.type];e[3]=c-this.damp*e[2];e[0]=e[0]+this.freq*e[2];e[1]=e[3]-e[0];e[2]=this.freq*e[1]+e[2];b+=0.5*e[this.type];if(this.envelope){a[d]=(a[d]*(1-this.envelope.value()))+(b*this.envelope.value());this.envelope.samplesProcessed++;}else{a[d]=b;}}};IIRFilter2.prototype.addEnvelope=function(a){if(a instanceof ADSR){this.envelope=a;}else{throw"This is not an envelope.";}};IIRFilter2.prototype.set=function(a,b){this.calcCoeff(a,b);};function WindowFunction(a,b){this.alpha=b;switch(a){case DSP.BARTLETT:this.func=WindowFunction.Bartlett;break;case DSP.BARTLETTHANN:this.func=WindowFunction.BartlettHann;break;case DSP.BLACKMAN:this.func=WindowFunction.Blackman;this.alpha=this.alpha||0.16;break;case DSP.COSINE:this.func=WindowFunction.Cosine;break;case DSP.GAUSS:this.func=WindowFunction.Gauss;this.alpha=this.alpha||0.25;break;case DSP.HAMMING:this.func=WindowFunction.Hamming;break;case DSP.HANN:this.func=WindowFunction.Hann;break;case DSP.LANCZOS:this.func=WindowFunction.Lanczoz;break;case DSP.RECTANGULAR:this.func=WindowFunction.Rectangular;break;case DSP.TRIANGULAR:this.func=WindowFunction.Triangular;break;}}WindowFunction.prototype.process=function(a){var c=a.length;for(var b=0;b<c;b++){a[b]*=this.func(c,b,this.alpha);}return a;};WindowFunction.Bartlett=function(b,a){return 2/(b-1)*((b-1)/2-Math.abs(a-(b-1)/2));};WindowFunction.BartlettHann=function(b,a){return 0.62-0.48*Math.abs(a/(b-1)-0.5)-0.38*Math.cos(DSP.TWO_PI*a/(b-1));};WindowFunction.Blackman=function(e,d,f){var c=(1-f)/2;var b=0.5;var a=f/2;return c-b*Math.cos(DSP.TWO_PI*d/(e-1))+a*Math.cos(4*Math.PI*d/(e-1));};WindowFunction.Cosine=function(b,a){return Math.cos(Math.PI*a/(b-1)-Math.PI/2);};WindowFunction.Gauss=function(b,a,c){return Math.pow(Math.E,-0.5*Math.pow((a-(b-1)/2)/(c*(b-1)/2),2));};WindowFunction.Hamming=function(b,a){return 0.54-0.46*Math.cos(DSP.TWO_PI*a/(b-1));};WindowFunction.Hann=function(b,a){return 0.5*(1-Math.cos(DSP.TWO_PI*a/(b-1)));};WindowFunction.Lanczos=function(c,b){var a=2*b/(c-1)-1;return Math.sin(Math.PI*a)/(Math.PI*a);};WindowFunction.Rectangular=function(b,a){return 1;};WindowFunction.Triangular=function(b,a){return 2/b*(b/2-Math.abs(a-(b-1)/2));};function sinh(a){return(Math.exp(a)-Math.exp(-a))/2;}function Biquad(b,a){this.Fs=a;this.type=b;this.parameterType=DSP.Q;this.x_1_l=0;this.x_2_l=0;this.y_1_l=0;this.y_2_l=0;this.x_1_r=0;this.x_2_r=0;this.y_1_r=0;this.y_2_r=0;this.b0=1;this.a0=1;this.b1=0;this.a1=0;this.b2=0;this.a2=0;this.b0a0=this.b0/this.a0;this.b1a0=this.b1/this.a0;this.b2a0=this.b2/this.a0;this.a1a0=this.a1/this.a0;this.a2a0=this.a2/this.a0;this.f0=3000;this.dBgain=12;this.Q=1;this.BW=-3;this.S=1;this.coefficients=function(){var c=[this.b0,this.b1,this.b2];var d=[this.a0,this.a1,this.a2];return{b:c,a:d};};this.setFilterType=function(c){this.type=c;this.recalculateCoefficients();};this.setSampleRate=function(c){this.Fs=c;this.recalculateCoefficients();};this.setQ=function(c){this.parameterType=DSP.Q;this.Q=Math.max(Math.min(c,115),0.001);this.recalculateCoefficients();};this.setBW=function(c){this.parameterType=DSP.BW;this.BW=c;this.recalculateCoefficients();};this.setS=function(c){this.parameterType=DSP.S;this.S=Math.max(Math.min(c,5),0.0001);this.recalculateCoefficients();};this.setF0=function(c){this.f0=c;this.recalculateCoefficients();};this.setDbGain=function(c){this.dBgain=c;this.recalculateCoefficients();};this.recalculateCoefficients=function(){var c;if(b===DSP.PEAKING_EQ||b===DSP.LOW_SHELF||b===DSP.HIGH_SHELF){c=Math.pow(10,(this.dBgain/40));}else{c=Math.sqrt(Math.pow(10,(this.dBgain/20)));}var f=DSP.TWO_PI*this.f0/this.Fs;var d=Math.cos(f);var g=Math.sin(f);var h=0;switch(this.parameterType){case DSP.Q:h=g/(2*this.Q);break;case DSP.BW:h=g*sinh(Math.LN2/2*this.BW*f/g);break;case DSP.S:h=g/2*Math.sqrt((c+1/c)*(1/this.S-1)+2);break;}var e;switch(this.type){case DSP.LPF:this.b0=(1-d)/2;this.b1=1-d;this.b2=(1-d)/2;this.a0=1+h;this.a1=-2*d;this.a2=1-h;break;case DSP.HPF:this.b0=(1+d)/2;this.b1=-(1+d);this.b2=(1+d)/2;this.a0=1+h;this.a1=-2*d;this.a2=1-h;break;case DSP.BPF_CONSTANT_SKIRT:this.b0=g/2;this.b1=0;this.b2=-g/2;this.a0=1+h;this.a1=-2*d;this.a2=1-h;break;case DSP.BPF_CONSTANT_PEAK:this.b0=h;this.b1=0;this.b2=-h;this.a0=1+h;this.a1=-2*d;this.a2=1-h;break;case DSP.NOTCH:this.b0=1;this.b1=-2*d;this.b2=1;this.a0=1+h;this.a1=-2*d;this.a2=1-h;break;case DSP.APF:this.b0=1-h;this.b1=-2*d;this.b2=1+h;this.a0=1+h;this.a1=-2*d;this.a2=1-h;break;case DSP.PEAKING_EQ:this.b0=1+h*c;this.b1=-2*d;this.b2=1-h*c;this.a0=1+h/c;this.a1=-2*d;this.a2=1-h/c;break;case DSP.LOW_SHELF:e=g*Math.sqrt((c^2+1)*(1/this.S-1)+2*c);this.b0=c*((c+1)-(c-1)*d+e);this.b1=2*c*((c-1)-(c+1)*d);this.b2=c*((c+1)-(c-1)*d-e);this.a0=(c+1)+(c-1)*d+e;this.a1=-2*((c-1)+(c+1)*d);this.a2=(c+1)+(c-1)*d-e;break;case DSP.HIGH_SHELF:e=g*Math.sqrt((c^2+1)*(1/this.S-1)+2*c);this.b0=c*((c+1)+(c-1)*d+e);this.b1=-2*c*((c-1)+(c+1)*d);this.b2=c*((c+1)+(c-1)*d-e);this.a0=(c+1)-(c-1)*d+e;this.a1=2*((c-1)-(c+1)*d);this.a2=(c+1)-(c-1)*d-e;break;}this.b0a0=this.b0/this.a0;this.b1a0=this.b1/this.a0;this.b2a0=this.b2/this.a0;this.a1a0=this.a1/this.a0;this.a2a0=this.a2/this.a0;};this.process=function(d){var c=d.length;var e=new Float32Array(c);for(var f=0;f<d.length;f++){e[f]=this.b0a0*d[f]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l;this.y_2_l=this.y_1_l;this.y_1_l=e[f];this.x_2_l=this.x_1_l;this.x_1_l=d[f];}return e;};this.processStereo=function(d){var c=d.length;var e=new Float32Array(c);for(var f=0;f<c/2;f++){e[2*f]=this.b0a0*d[2*f]+this.b1a0*this.x_1_l+this.b2a0*this.x_2_l-this.a1a0*this.y_1_l-this.a2a0*this.y_2_l;this.y_2_l=this.y_1_l;this.y_1_l=e[2*f];this.x_2_l=this.x_1_l;this.x_1_l=d[2*f];e[2*f+1]=this.b0a0*d[2*f+1]+this.b1a0*this.x_1_r+this.b2a0*this.x_2_r-this.a1a0*this.y_1_r-this.a2a0*this.y_2_r;this.y_2_r=this.y_1_r;this.y_1_r=e[2*f+1];this.x_2_r=this.x_1_r;this.x_1_r=d[2*f+1];}return e;};}DSP.mag2db=function(c){var d=-120;var g=Math.pow(10,d/20);var f=Math.log;var b=Math.max;var a=Float32Array(c.length);for(var e=0;e<c.length;e++){a[e]=20*f(b(c[e],g));}return a;};DSP.freqz=function(h,k,l){var f,e;if(!l){l=Float32Array(200);for(f=0;f<l.length;f++){l[f]=DSP.TWO_PI/l.length*f-Math.PI;}}var o=Float32Array(l.length);var m=Math.sqrt;var n=Math.cos;var g=Math.sin;for(f=0;f<l.length;f++){var c={real:0,imag:0};for(e=0;e<h.length;e++){c.real+=h[e]*n(-e*l[f]);c.imag+=h[e]*g(-e*l[f]);}var d={real:0,imag:0};for(e=0;e<k.length;e++){d.real+=k[e]*n(-e*l[f]);d.imag+=k[e]*g(-e*l[f]);}o[f]=m(c.real*c.real+c.imag*c.imag)/m(d.real*d.real+d.imag*d.imag);}return o;};function GraphicalEq(a){this.FS=a;this.minFreq=40;this.maxFreq=16000;this.bandsPerOctave=1;this.filters=[];this.freqzs=[];this.calculateFreqzs=true;this.recalculateFilters=function(){var b=Math.round(Math.log(this.maxFreq/this.minFreq)*this.bandsPerOctave/Math.LN2);this.filters=[];for(var c=0;c<b;c++){var e=this.minFreq*(Math.pow(2,c/this.bandsPerOctave));var d=new Biquad(DSP.PEAKING_EQ,this.FS);d.setDbGain(0);d.setBW(1/this.bandsPerOctave);d.setF0(e);this.filters[c]=d;this.recalculateFreqz(c);}};this.setMinimumFrequency=function(b){this.minFreq=b;this.recalculateFilters();};this.setMaximumFrequency=function(b){this.maxFreq=b;this.recalculateFilters();};this.setBandsPerOctave=function(b){this.bandsPerOctave=b;this.recalculateFilters();};this.setBandGain=function(c,b){if(c<0||c>(this.filters.length-1)){throw"The band index of the graphical equalizer is out of bounds.";}if(!b){throw"A gain must be passed.";}this.filters[c].setDbGain(b);this.recalculateFreqz(c);};this.recalculateFreqz=function(f){if(!this.calculateFreqzs){return;}if(f<0||f>(this.filters.length-1)){throw"The band index of the graphical equalizer is out of bounds. "+f+" is out of ["+0+", "+this.filters.length-1+"]";}if(!this.w){this.w=Float32Array(400);for(var e=0;e<this.w.length;e++){this.w[e]=Math.PI/this.w.length*e;}}var c=[this.filters[f].b0,this.filters[f].b1,this.filters[f].b2];var d=[this.filters[f].a0,this.filters[f].a1,this.filters[f].a2];this.freqzs[f]=DSP.mag2db(DSP.freqz(c,d,this.w));};this.process=function(b){var c=b;for(var d=0;d<this.filters.length;d++){c=this.filters[d].process(c);}return c;};this.processStereo=function(b){var c=b;for(var d=0;d<this.filters.length;d++){c=this.filters[d].processStereo(c);}return c;};}function MultiDelay(c,a,d,b){this.delayBufferSamples=new Float32Array(c);this.delayInputPointer=a;this.delayOutputPointer=0;this.delayInSamples=a;this.masterVolume=d;this.delayVolume=b;}MultiDelay.prototype.setDelayInSamples=function(a){this.delayInSamples=a;this.delayInputPointer=this.delayOutputPointer+a;if(this.delayInputPointer>=this.delayBufferSamples.length-1){this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length;}};MultiDelay.prototype.setMasterVolume=function(a){this.masterVolume=a;};MultiDelay.prototype.setDelayVolume=function(a){this.delayVolume=a;};MultiDelay.prototype.process=function(b){var e=new Float32Array(b.length);for(var c=0;c<b.length;c++){var a=(this.delayBufferSamples[this.delayOutputPointer]===null?0:this.delayBufferSamples[this.delayOutputPointer]);var d=(a*this.delayVolume)+b[c];this.delayBufferSamples[this.delayInputPointer]=d;e[c]=d*this.masterVolume;this.delayInputPointer++;if(this.delayInputPointer>=this.delayBufferSamples.length-1){this.delayInputPointer=0;}this.delayOutputPointer++;if(this.delayOutputPointer>=this.delayBufferSamples.length-1){this.delayOutputPointer=0;}}return e;};function SingleDelay(c,a,b){this.delayBufferSamples=new Float32Array(c);this.delayInputPointer=a;this.delayOutputPointer=0;this.delayInSamples=a;this.delayVolume=b;}SingleDelay.prototype.setDelayInSamples=function(a){this.delayInSamples=a;this.delayInputPointer=this.delayOutputPointer+a;if(this.delayInputPointer>=this.delayBufferSamples.length-1){this.delayInputPointer=this.delayInputPointer-this.delayBufferSamples.length;}};SingleDelay.prototype.setDelayVolume=function(a){this.delayVolume=a;};SingleDelay.prototype.process=function(b){var d=new Float32Array(b.length);for(var c=0;c<b.length;c++){this.delayBufferSamples[this.delayInputPointer]=b[c];var a=this.delayBufferSamples[this.delayOutputPointer];d[c]=a*this.delayVolume;this.delayInputPointer++;if(this.delayInputPointer>=this.delayBufferSamples.length-1){this.delayInputPointer=0;}this.delayOutputPointer++;if(this.delayOutputPointer>=this.delayBufferSamples.length-1){this.delayOutputPointer=0;}}return d;};function Reverb(d,a,g,h,b,f){this.delayInSamples=a;this.masterVolume=g;this.mixVolume=h;this.delayVolume=b;this.dampFrequency=f;this.NR_OF_MULTIDELAYS=6;this.NR_OF_SINGLEDELAYS=6;this.LOWPASSL=new IIRFilter2(DSP.LOWPASS,f,0,44100);this.LOWPASSR=new IIRFilter2(DSP.LOWPASS,f,0,44100);this.singleDelays=[];var c,e;for(c=0;c<this.NR_OF_SINGLEDELAYS;c++){e=1+(c/7);this.singleDelays[c]=new SingleDelay(d,Math.round(this.delayInSamples*e),this.delayVolume);}this.multiDelays=[];for(c=0;c<this.NR_OF_MULTIDELAYS;c++){e=1+(c/10);this.multiDelays[c]=new MultiDelay(d,Math.round(this.delayInSamples*e),this.masterVolume,this.delayVolume);}}Reverb.prototype.setDelayInSamples=function(a){this.delayInSamples=a;var b,c;for(b=0;b<this.NR_OF_SINGLEDELAYS;b++){c=1+(b/7);this.singleDelays[b].setDelayInSamples(Math.round(this.delayInSamples*c));}for(b=0;b<this.NR_OF_MULTIDELAYS;b++){c=1+(b/10);this.multiDelays[b].setDelayInSamples(Math.round(this.delayInSamples*c));}};Reverb.prototype.setMasterVolume=function(a){this.masterVolume=a;};Reverb.prototype.setMixVolume=function(a){this.mixVolume=a;};Reverb.prototype.setDelayVolume=function(a){this.delayVolume=a;var b;for(b=0;b<this.NR_OF_SINGLEDELAYS;b++){this.singleDelays[b].setDelayVolume(this.delayVolume);}for(b=0;b<this.NR_OF_MULTIDELAYS;b++){this.multiDelays[b].setDelayVolume(this.delayVolume);}};Reverb.prototype.setDampFrequency=function(a){this.dampFrequency=a;this.LOWPASSL.set(a,0);this.LOWPASSR.set(a,0);};Reverb.prototype.process=function(e){var f=new Float32Array(e.length);var d=DSP.deinterleave(e);this.LOWPASSL.process(d[DSP.LEFT]);this.LOWPASSR.process(d[DSP.RIGHT]);var a=DSP.interleave(d[DSP.LEFT],d[DSP.RIGHT]);var c;for(c=0;c<this.NR_OF_MULTIDELAYS;c++){f=DSP.mixSampleBuffers(f,this.multiDelays[c].process(a),2%c===0,this.NR_OF_MULTIDELAYS);}var b=new Float32Array(f.length);for(c=0;c<this.NR_OF_SINGLEDELAYS;c++){b=DSP.mixSampleBuffers(b,this.singleDelays[c].process(f),2%c===0,1);}for(c=0;c<b.length;c++){b[c]*=this.mixVolume;}f=DSP.mixSampleBuffers(b,e,0,1);for(c=0;c<f.length;c++){f[c]*=this.masterVolume;}return f;};